<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>proto</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="page">
      <aside class="nav-sidebar" aria-label="Navigazione">
        <nav>
          <a href="#dashboard" data-view="dashboard">dashboard</a>
          <a
            href="#filtra"
            data-view="filtra"
            class="is-active"
            aria-current="page"
            ><span>filtra</span><span>banca dati</span></a
          >
          <a href="#"><span>nuovo</span><span>comunicato</span></a>
          <a href="#"><span>nuova</span><span>spedizione</span></a>
          <a href="#"><span>nuovo</span><span>progetto</span></a>
          <a href="#"><span>nuovo</span><span>todo</span></a>
          <a href="#">notifiche</a>
          <a href="#">account</a>
        </nav>
      </aside>
      <div class="views" id="views">
        <div class="app-view is-active" data-view="filtra" id="viewFiltra">
          <aside class="sidebar">
            <div class="sidebar-mode" role="radiogroup" aria-label="Modalità">
              <input
                type="radio"
                name="sidebarMode"
                id="sidebarModeJournalists"
                value="giornalisti"
                checked
              />
              <label class="sidebar-mode-option" for="sidebarModeJournalists"
                >giornalisti</label
              >
              <span class="sidebar-mode-separator">|</span>
              <input
                type="radio"
                name="sidebarMode"
                id="sidebarModeTestate"
                value="testate"
              />
              <label class="sidebar-mode-option" for="sidebarModeTestate"
                >testate</label
              >
            </div>

            <div class="dropdown-container" style="margin-bottom: 18px">
              <label class="field-label" for="textFilterInput"
                >Nome, Testata, Note</label
              >
              <div class="dropdown-input" id="textFilterInputWrapper">
                <input
                  type="text"
                  class="chip-text-input"
                  id="textFilterInput"
                  autocomplete="off"
                />
                <div class="dropdown-clear" id="textFilterClear">×</div>
              </div>
            </div>

            <hr class="sidebar-separator" />
            <div class="sidebar-section-title">Filtri giornalista</div>

            <div class="dropdown-container">
              <label class="field-label" for="dropdownInput"
                >Servizio giornalistico</label
              >
              <div class="dropdown-input" id="dropdownInputWrapper">
                <div id="chipContainer"></div>
                <input
                  type="text"
                  class="chip-text-input"
                  id="dropdownInput"
                  autocomplete="off"
                />
                <div
                  class="autocomplete-inline"
                  id="autocompleteInline"
                  aria-hidden="true"
                >
                  <span
                    class="autocomplete-suffix"
                    id="autocompleteSuffix"
                  ></span>
                  <span class="autocomplete-tip" id="autocompleteTip"></span>
                </div>
                <div class="dropdown-arrow" id="dropdownArrow"></div>
                <div class="dropdown-clear" id="dropdownClear">×</div>
              </div>
              <div class="dropdown-list" id="dropdownList">
                <div
                  class="dropdown-suggestions"
                  id="dropdownSuggestions"
                ></div>
                <div class="dropdown-results" id="dropdownResults"></div>
                <div class="dropdown-footer">
                  <a href="#" class="close-dropdown-link" id="closeDropdownLink"
                    >chiudi tendina</a
                  >
                  <button
                    type="button"
                    class="keycap"
                    aria-hidden="true"
                    tabindex="-1"
                  >
                    ESC
                  </button>
                </div>
              </div>
            </div>

            <div class="dropdown-container" style="margin-top: 18px">
              <label class="field-label" for="roleDropdownInput"
                >Ruolo in redazione</label
              >
              <div class="dropdown-input" id="roleDropdownInputWrapper">
                <div id="roleChipContainer"></div>
                <input
                  type="text"
                  class="chip-text-input"
                  id="roleDropdownInput"
                  autocomplete="off"
                />
                <div
                  class="autocomplete-inline"
                  id="roleAutocompleteInline"
                  aria-hidden="true"
                >
                  <span
                    class="autocomplete-suffix"
                    id="roleAutocompleteSuffix"
                  ></span>
                  <span
                    class="autocomplete-tip"
                    id="roleAutocompleteTip"
                  ></span>
                </div>
                <div class="dropdown-arrow" id="roleDropdownArrow"></div>
                <div class="dropdown-clear" id="roleDropdownClear">×</div>
              </div>
              <div class="dropdown-list" id="roleDropdownList">
                <div
                  class="dropdown-suggestions"
                  id="roleDropdownSuggestions"
                ></div>
                <div class="dropdown-results" id="roleDropdownResults"></div>
                <div class="dropdown-footer">
                  <a
                    href="#"
                    class="close-dropdown-link"
                    id="roleCloseDropdownLink"
                    >chiudi tendina</a
                  >
                  <button
                    type="button"
                    class="keycap"
                    aria-hidden="true"
                    tabindex="-1"
                  >
                    ESC
                  </button>
                </div>
              </div>
            </div>

            <hr class="sidebar-separator" />
            <div class="sidebar-section-title">Filtri testata</div>
          </aside>

          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title" id="mainTitle">Filtra Banca Dati</h1>
                <a
                  href="#"
                  class="close-dropdown-link main-clear-filters"
                  id="clearFiltersLink"
                >
                  rimuovi filtri
                </a>
                <div class="main-subtitle" id="cardsSubtitle"></div>
              </div>
              <span class="pill" id="cardsCount"></span>
            </div>
            <div class="cards-grid" id="cardsGrid"></div>
          </main>

          <aside class="selected-panel" id="selectedPanel" aria-hidden="true">
            <div class="selected-panel-header">
              <div class="selected-panel-header-left">
                <p class="selected-panel-title">Selezionati</p>
                <a href="#" class="close-dropdown-link" id="selectedClearAll">
                  rimuovi selezionati
                </a>
                <a
                  href="#"
                  class="close-dropdown-link"
                  id="saveMailingListLink"
                >
                  salva lista
                </a>
              </div>
            </div>
            <div class="selected-panel-body" id="selectedPanelBody"></div>
          </aside>
        </div>

        <div class="app-view" data-view="dashboard" id="viewDashboard">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Mailing lists</h1>
              </div>
            </div>
            <div class="dashboard-layout">
              <div class="dashboard-mailing-lists-col">
                <div id="dashboardMailingLists"></div>
              </div>
            </div>
          </main>
        </div>

        <div class="app-view" data-view="mailing-list" id="viewMailingList">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Mailing list</h1>
                <div class="main-subtitle">in preparazione</div>
              </div>
            </div>
            <div class="muted">work in progress</div>
          </main>
        </div>
      </div>
    </div>

    <div class="testata-overlay" id="testataOverlay" aria-hidden="true"></div>
    <aside class="testata-panel" id="testataPanel" aria-hidden="true">
      <div class="testata-panel-header">
        <p class="testata-panel-title" id="testataPanelTitle">Testata</p>
        <button
          type="button"
          class="testata-panel-close"
          id="testataPanelClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="testata-panel-body" id="testataPanelBody"></div>
    </aside>

    <div
      class="notes-modal-overlay"
      id="notesModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="notesModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="notesModalTitle">Note</p>
        <button
          type="button"
          class="notes-modal-close"
          id="notesModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body" id="notesModalBody"></div>
    </div>

    <div
      class="notes-modal-overlay"
      id="saveListModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="saveListModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title">Salva lista</p>
        <button
          type="button"
          class="notes-modal-close"
          id="saveListModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <label class="field-label" for="saveListNameInput">nome lista</label>
        <div class="dropdown-input">
          <input
            type="text"
            class="chip-text-input"
            id="saveListNameInput"
            autocomplete="off"
          />
        </div>
        <div class="form-error" id="saveListError" style="display: none">
          dai nome alla lista
        </div>
        <a href="#" class="close-dropdown-link" id="saveListConfirm">
          salva lista
        </a>
      </div>
    </div>

    <script>
      const APP_STORAGE_KEY = "proto-servizio-app-state-v1";

      function loadAppState() {
        try {
          const raw = localStorage.getItem(APP_STORAGE_KEY);
          if (!raw) {
            return {
              view: "filtra",
              mailingLists: [],
              comunicati: [],
              spedizioni: [],
            };
          }
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") {
            return {
              view: "filtra",
              mailingLists: [],
              comunicati: [],
              spedizioni: [],
            };
          }
          return {
            view: typeof parsed.view === "string" ? parsed.view : "filtra",
            mailingLists: Array.isArray(parsed.mailingLists)
              ? parsed.mailingLists
              : [],
            comunicati: Array.isArray(parsed.comunicati)
              ? parsed.comunicati
              : [],
            spedizioni: Array.isArray(parsed.spedizioni)
              ? parsed.spedizioni
              : [],
          };
        } catch (e) {
          return {
            view: "filtra",
            mailingLists: [],
            comunicati: [],
            spedizioni: [],
          };
        }
      }

      function saveAppState(state) {
        try {
          localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(state || {}));
        } catch (e) {
          return;
        }
      }

      const appState = loadAppState();

      if (typeof appState.activeMailingListId !== "string") {
        appState.activeMailingListId = "";
      }

      const ENABLED_VIEWS = new Set(["filtra", "mailing-list", "dashboard"]);

      function normalizeViewId(value) {
        const v = String(value || "")
          .trim()
          .toLowerCase();
        if (!v) return "";
        if (!/^[a-z0-9-]+$/.test(v)) return "";
        return v;
      }

      function setActiveView(viewId, options = {}) {
        const { save = true } = options;
        let v = normalizeViewId(viewId);
        if (!v || !ENABLED_VIEWS.has(v)) {
          v = "filtra";
        }

        document.querySelectorAll(".app-view").forEach((el) => {
          const viewKey = el.getAttribute("data-view");
          const shouldShow =
            v === "mailing-list" ? viewKey === "filtra" : viewKey === v;
          el.classList.toggle("is-active", shouldShow);
        });

        const sp = document.getElementById("selectedPanel");
        if (sp && v !== "filtra" && v !== "mailing-list") {
          sp.classList.remove("show");
          sp.setAttribute("aria-hidden", "true");
          document.body.classList.remove("selection-panel-open");
        }

        document.querySelectorAll(".nav-sidebar a[data-view]").forEach((a) => {
          const isActive = a.getAttribute("data-view") === v;
          a.classList.toggle("is-active", isActive);
          if (isActive) {
            a.setAttribute("aria-current", "page");
          } else {
            a.removeAttribute("aria-current");
          }
        });

        if (save) {
          appState.view = v;
          saveAppState(appState);
        }

        if (v === "filtra" || v === "mailing-list") {
          scheduleRender();
        } else if (v === "dashboard") {
          renderDashboardMailingLists();
        }
      }

      function getViewFromHash() {
        const raw = window.location.hash || "";
        if (!raw.startsWith("#")) return "";
        return normalizeViewId(raw.slice(1));
      }

      class FilterableDropdown {
        constructor(inputId, options = [], config = {}) {
          const {
            inputWrapperId = "dropdownInputWrapper",
            chipContainerId = "chipContainer",
            autocompleteInlineId = "autocompleteInline",
            autocompleteSuffixId = "autocompleteSuffix",
            autocompleteTipId = "autocompleteTip",
            arrowId = "dropdownArrow",
            clearId = "dropdownClear",
            listId = "dropdownList",
            closeLinkId = "closeDropdownLink",
            suggestionsId = "dropdownSuggestions",
            resultsId = "dropdownResults",
          } = config;

          this.renderChipsInInput = config.renderChipsInInput !== false;
          this.preserveParentOrder = config.preserveParentOrder === true;

          this.input = document.getElementById(inputId);
          this.inputWrapper = document.getElementById(inputWrapperId);
          this.container = this.input?.closest(".dropdown-container");
          this.label = this.container?.querySelector(
            `label.field-label[for="${inputId}"]`
          );

          this.baseContainerMarginBottom = 0;
          if (this.container) {
            const mb = window.getComputedStyle(this.container).marginBottom;
            this.baseContainerMarginBottom = parseFloat(mb || "0") || 0;
          }
          this.chipContainer = document.getElementById(chipContainerId);
          this.autocompleteInline =
            document.getElementById(autocompleteInlineId);
          this.autocompleteSuffix =
            document.getElementById(autocompleteSuffixId);
          this.autocompleteTip = document.getElementById(autocompleteTipId);
          this.arrow = document.getElementById(arrowId);
          this.clear = document.getElementById(clearId);
          this.list = document.getElementById(listId);
          this.closeLink = document.getElementById(closeLinkId);
          this.suggestions = document.getElementById(suggestionsId);
          this.results = document.getElementById(resultsId);

          this.originalOptions = options;
          this.filteredOptions = [...options];
          this.selectedValues = new Set();
          this.strongMatchOptions = new Set();
          this.matchRank = new Map();
          this.visibleOptions = [...options];
          this.isOpen = false;
          this.selectedIndex = -1;

          this.suppressedAutocompleteQuery = null;
          this.suppressedAutocompleteTerms = new Set();

          if (!FilterableDropdown._instances) {
            FilterableDropdown._instances = new Set();
          }
          FilterableDropdown._instances.add(this);

          this.baseInputWrapperHeight = null;

          this.ignoreWrapperClick = false;
          this.expandedParents = new Set();

          this.parents = config.parents || [];
          this.childrenByParent = config.childrenByParent || {};

          this.optionToParent = {};
          for (const p of this.parents) {
            for (const child of this.childrenByParent[p] || []) {
              this.optionToParent[child] = p;
            }
          }

          this.relatedMap = {};
          this.autocompleteMap = {};
          this.keywordToFiltersMap = {};

          const defaultSynonymsByFilter = {
            "Disegno grafico": [
              "Grafica pubblicitaria",
              "Design grafico",
              "Progettazione grafica",
            ],
            "Infusi e caffetteria": [
              "Bevande calde",
              "Infusi e caffetteria",
              "Bevande stimolanti",
            ],
            Dolciumi: [
              "Dolci",
              "Caramelle",
              "Confetteria",
              "Prodotti zuccherini",
            ],
            "Igiene alimentare": [
              "Sicurezza alimentare",
              "Sanità degli alimenti",
              "Controllo igienico-sanitario",
            ],
            "Industria alimentare": [
              "Settore alimentare",
              "Industria agroalimentare",
              "Comparto alimentare",
            ],
            "Latte e latticini": [
              "Prodotti caseari",
              "Derivati del latte",
              "Lattiero-caseario",
            ],
            "Alimenti biologici": [
              "Cibi biologici",
              "Prodotti bio",
              "Alimenti da agricoltura biologica",
            ],
            Bevande: ["Drink", "Bibite", "Bevande analcoliche"],
            Liquori: ["Distillati", "Alcolici", "Bevande spiritose"],
            Vegetarianesimo: [
              "Alimentazione vegetariana",
              "Dieta vegetariana",
              "Scelta vegetariana",
            ],
            "Distribuzione automatica": [
              "Vending",
              "Vendita automatizzata",
              "Distributori automatici",
            ],
            "Cucina e gastronomia": [
              "Arte culinaria",
              "Gastronomia",
              "Tradizione culinaria",
            ],
            Alimentazione: ["Nutrizione", "Dieta", "Regime alimentare"],
            "Vini ed Enologia": [
              "Vitivinicoltura",
              "Cultura del vino",
              "Settore enologico",
            ],
            Agroalimentare: [
              "Settore agroalimentare",
              "Filiera agroalimentare",
            ],
            "Politica agraria": ["Politiche agricole", "Governance agricola"],
            "Zootecnica e Allevamento": [
              "Allevamento animale",
              "Produzione zootecnica",
              "Scienze zootecniche",
            ],
            "Agricoltura biologica": [
              "Coltivazione biologica",
              "Agricoltura eco-sostenibile",
              "Agricoltura organica",
            ],
            Viticoltura: ["Coltivazione della vite", "Produzione vitivinicola"],
            Agricoltura: [
              "Coltivazione",
              "Attività agricola",
              "Produzione agricola",
            ],
            Foreste: ["Bosco", "Aree forestali", "Patrimonio forestale"],
            Veterinaria: ["Medicina veterinaria", "Scienze veterinarie"],

            "Ingegneria informatica": [
              "Informatica ingegneristica",
              "Ingegneria del software e dei sistemi",
            ],
            "Giochi e videogame": ["Videogiochi", "Gaming"],
            "Computer grafica 3D": ["Grafica tridimensionale", "CG 3D"],
            "Hardware informatico": [
              "Componenti hardware",
              "Dispositivi informatici",
            ],
            "Home entertainment per PC": [
              "Intrattenimento digitale per PC",
              "Multimedia per computer",
            ],
            "Editoria elettronica": [
              "Editoria digitale",
              "Pubblicazione digitale",
            ],
            "App, smartphone, Android, iOS": [
              "Applicazioni mobili",
              "Mobile app",
              "Ecosistema mobile",
            ],
            Software: ["Programmi", "Applicativi"],
            "Sicurezza dei sistemi": [
              "Sicurezza informatica",
              "Protezione dei sistemi",
            ],
            "Reti informatiche": [
              "Network informatici",
              "Infrastrutture di rete",
            ],
            "Sicurezza delle informazioni": [
              "Protezione dei dati",
              "Information security",
            ],
            "Web design": ["Design web", "Progettazione grafica web"],
            "Progettazione siti web": [
              "Sviluppo web",
              "Realizzazione siti web",
            ],
            Multimedialità: ["Contenuti multimediali", "Media digitali"],
            "Web e Social Network": [
              "Web e social media",
              "Piattaforme online",
            ],
            "Information Technology": [
              "Tecnologia dell’informazione",
              "IT",
              "Tecnologie informatiche",
            ],

            "Arte Contemporanea": [
              "Arte moderna (uso comune, non accademico)",
              "Produzione artistica contemporanea",
            ],
            "Libri per bambini": [
              "Letteratura per l’infanzia",
              "Libri per ragazzi",
            ],
            Narrativa: ["Prosa", "Narrativa di finzione"],
            Letteratura: ["Produzione letteraria", "Opere letterarie"],
            "Arti Grafiche": ["Grafica", "Arti visive applicate"],
            Poesia: ["Produzione poetica", "Versi"],
            Filosofia: ["Pensiero filosofico", "Speculazione filosofica"],
            Arte: ["Espressione artistica", "Arti visive"],
            "Libri e editoria": ["Editoria", "Pubblicazioni"],
            Mostre: ["Esposizioni", "Rassegne"],
            "Mercato d'arte e aste": ["Compravendita d’arte", "Aste d’arte"],
            Storia: ["Scienze storiche", "Ricerca storica"],
            Geografia: ["Scienze geografiche", "Studio del territorio"],
            Cultura: ["Patrimonio culturale", "Attività culturali"],
            Antiquariato: ["Mercato antiquario", "Beni antichi"],
            Archeologia: ["Ricerca archeologica", "Scavi archeologici"],
            Disegno: ["Arte del disegno", "Disegno artistico"],
            Pittura: ["Arte pittorica", "Pittura artistica"],
            Scultura: ["Arte scultorea", "Scultura artistica"],
            Restauro: ["Conservazione", "Recupero artistico"],
            "Musei e beni culturali": [
              "Patrimonio museale",
              "Beni storico-culturali",
            ],
          };

          const synonymsByFilter =
            config.synonymsByFilter || defaultSynonymsByFilter;

          this.autocompleteTerms = new Set();

          for (const [filter, syns] of Object.entries(synonymsByFilter)) {
            for (const syn of syns) {
              const key = (syn || "").trim().toLowerCase();
              if (!key) continue;
              if (!this.keywordToFiltersMap[key]) {
                this.keywordToFiltersMap[key] = [filter];
              } else if (!this.keywordToFiltersMap[key].includes(filter)) {
                this.keywordToFiltersMap[key].push(filter);
              }
              this.autocompleteTerms.add(key);
            }
          }
          this.init();
        }

        updateReservedSpace() {
          if (!this.container) return;

          this.container.style.marginBottom = this.baseContainerMarginBottom
            ? `${this.baseContainerMarginBottom}px`
            : "";
        }

        updateReservedSpaceSoon() {
          if (this._reserveRaf) {
            cancelAnimationFrame(this._reserveRaf);
          }
          this._reserveRaf = requestAnimationFrame(() => {
            this._reserveRaf = null;
            this.updateReservedSpace();
          });
        }

        init() {
          this.renderList();
          this.bindEvents();
          this.updateClearVisibility();

          if (this.baseInputWrapperHeight == null) {
            this.baseInputWrapperHeight = this.inputWrapper?.offsetHeight || 0;
          }
        }

        bindEvents() {
          this.inputWrapper.addEventListener("click", () => {
            if (this.ignoreWrapperClick) {
              this.ignoreWrapperClick = false;
              return;
            }
            this.input.focus();
            this.toggle();
          });

          if (this.label) {
            this.label.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              this.ignoreWrapperClick = true;
              setTimeout(() => {
                this.ignoreWrapperClick = false;
              }, 0);

              if (this.isOpen) {
                this.close();
              } else {
                this.open();
                this.input.focus();
              }
            });
          }

          this.input.addEventListener("input", (e) => {
            this.filterOptions(e.target.value);
            this.updateAutocompleteHint(e.target.value);
            if (!this.isOpen) {
              this.open();
            }
            this.selectedIndex = -1;
          });

          this.input.addEventListener("keydown", (e) => {
            this.handleKeyboard(e);
          });

          this.clear.addEventListener("click", (e) => {
            e.stopPropagation();
            this.resetSelection();
          });

          this.onDocumentKeyDown = (e) => {
            if (e.key === "Escape" && this.isOpen) {
              e.preventDefault();
              e.stopPropagation();
              this.close();
            }
          };

          document.addEventListener("keydown", this.onDocumentKeyDown, true);

          if (this.closeLink) {
            this.closeLink.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              this.close();
            });
          }
        }

        filterOptions(query) {
          const q = (query || "").trim().toLowerCase();
          const includeSet = new Set();
          const strongSet = new Set();
          const rank = new Map();

          if (
            this.suppressedAutocompleteQuery &&
            this.suppressedAutocompleteQuery !== q
          ) {
            this.suppressedAutocompleteQuery = null;
            this.suppressedAutocompleteTerms.clear();
          }

          if (q.length < 3) {
            this.filteredOptions = [...this.originalOptions];
            this.strongMatchOptions = new Set();
            this.matchRank = new Map();
            this.renderList();
            return;
          }

          if (!q) {
            this.filteredOptions = [...this.originalOptions];
            this.strongMatchOptions = new Set();
            this.matchRank = new Map();
            this.renderList();
            return;
          }

          for (const option of this.originalOptions) {
            const optionLower = option.toLowerCase();
            const tokens = optionLower.split(/\s+/).filter(Boolean);
            const strongMatch = tokens.some((t) => t.startsWith(q));

            if (strongMatch) {
              includeSet.add(option);
              strongSet.add(option);
              rank.set(option, 0);
            }
          }

          if (q.length >= 3) {
            for (const term of this.autocompleteTerms || []) {
              if (
                this.suppressedAutocompleteQuery === q &&
                this.suppressedAutocompleteTerms.has(term)
              ) {
                continue;
              }
              const words = String(term).split(/\s+/).filter(Boolean);
              if (words.some((w) => w.startsWith(q))) {
                const mapped = this.keywordToFiltersMap[term] || [];
                for (const filter of mapped) {
                  includeSet.add(filter);
                  strongSet.add(filter);
                  if (!rank.has(filter)) {
                    rank.set(filter, 1);
                  }
                }
              }
            }
          }

          this.filteredOptions = this.originalOptions.filter((opt) =>
            includeSet.has(opt)
          );
          this.strongMatchOptions = strongSet;
          this.matchRank = rank;
          this.renderList();
        }

        getAutocompleteSuggestion(query) {
          const q = (query || "").trim().toLowerCase();
          if (!q) return null;

          // 1) mapping esplicito
          const mapped = this.autocompleteMap[q];
          if (mapped) {
            const suffix = mapped.slice(q.length);
            if (!suffix) return null;
            return { full: mapped, suffix };
          }

          // 2) completamento a prefisso sui termini (sinonimi)
          if (q.length < 3) return null;

          const candidates = [];
          for (const term of this.autocompleteTerms || []) {
            if (term.startsWith(q) && term.length > q.length) {
              candidates.push(term);
            }
          }
          if (candidates.length === 0) return null;

          candidates.sort(
            (a, b) => a.length - b.length || a.localeCompare(b, "it")
          );
          const full = candidates[0];
          const suffix = full.slice(q.length);
          if (!suffix) return null;
          return { full, suffix };
        }

        measureTextWidth(text, element) {
          const canvas =
            this._measureCanvas ||
            (this._measureCanvas = document.createElement("canvas"));
          const ctx = canvas.getContext("2d");
          if (!ctx) return 0;

          const cs = window.getComputedStyle(element);
          ctx.font = `${cs.fontStyle} ${cs.fontVariant} ${cs.fontWeight} ${cs.fontSize} ${cs.fontFamily}`;
          const metrics = ctx.measureText(text);
          let width = metrics.width || 0;

          const letterSpacing = parseFloat(cs.letterSpacing || "0");
          if (
            !Number.isNaN(letterSpacing) &&
            letterSpacing != 0 &&
            text.length > 1
          ) {
            width += (text.length - 1) * letterSpacing;
          }
          return width;
        }

        updateAutocompleteHint(query) {
          const suggestion = this.getAutocompleteSuggestion(query);
          const caretAtEnd =
            this.input.selectionStart === this.input.value.length &&
            this.input.selectionEnd === this.input.value.length;

          const q = (query || "").trim().toLowerCase();
          if (
            suggestion &&
            this.suppressedAutocompleteQuery === q &&
            this.suppressedAutocompleteTerms.has(suggestion.full)
          ) {
            this.autocompleteSuffix.textContent = "";
            this.autocompleteTip.textContent = "";
            this.autocompleteInline.classList.remove("show");
            return;
          }

          if (!this.isOpen || !suggestion || !caretAtEnd) {
            this.autocompleteSuffix.textContent = "";
            this.autocompleteTip.textContent = "";
            this.autocompleteInline.classList.remove("show");
            return;
          }

          this.autocompleteSuffix.textContent = suggestion.suffix;
          this.autocompleteTip.textContent = "";

          const left =
            this.input.offsetLeft +
            this.measureTextWidth(this.input.value, this.input);
          const cs = window.getComputedStyle(this.input);
          const paddingTop = parseFloat(cs.paddingTop || "0") || 0;
          const fontSize = parseFloat(cs.fontSize || "16") || 16;
          const lineHeight =
            cs.lineHeight === "normal"
              ? fontSize * 1.2
              : parseFloat(cs.lineHeight || `${fontSize * 1.2}`) ||
                fontSize * 1.2;
          const lineOffset = Math.max(0, (lineHeight - fontSize) / 2);
          const top = this.input.offsetTop + paddingTop + lineOffset - 2.75;
          this.autocompleteInline.style.left = `${left}px`;
          this.autocompleteInline.style.top = `${top}px`;
          this.autocompleteInline.classList.add("show");
        }

        renderList() {
          this.results.innerHTML = "";
          this.suggestions.innerHTML = "";

          const query = this.input.value.trim();
          const q = query.toLowerCase();
          const isFiltered = q.length >= 3;

          if (!isFiltered) {
            this.expandedParents?.clear();
          }

          const suggestionsSet = new Set();
          const filteredSet = new Set(this.filteredOptions);
          const showSuggestions = q.length >= 3;

          if (showSuggestions) {
            const kwSuggestions = this.keywordToFiltersMap[q] || [];
            for (const opt of kwSuggestions) {
              if (opt && !filteredSet.has(opt)) {
                suggestionsSet.add(opt);
              }
            }

            const strongOrSelected = new Set([
              ...Array.from(this.selectedValues),
              ...Array.from(this.strongMatchOptions || []),
            ]);

            for (const opt of strongOrSelected) {
              const related = this.relatedMap[opt];
              if (related && !filteredSet.has(related)) {
                suggestionsSet.add(related);
              }
            }
          }

          const suggestions = Array.from(suggestionsSet)
            .filter(
              (opt) =>
                this.originalOptions.includes(opt) && !filteredSet.has(opt)
            )
            .sort((a, b) => a.localeCompare(b, "it", { sensitivity: "base" }));

          const matched = [...this.filteredOptions].sort((a, b) => {
            const ra = this.matchRank?.get(a) ?? 99;
            const rb = this.matchRank?.get(b) ?? 99;
            return ra - rb || a.localeCompare(b, "it", { sensitivity: "base" });
          });

          const visible = [...matched, ...suggestions];
          const childrenByParentVisible = new Map();
          for (const opt of visible) {
            const parent = this.optionToParent[opt];
            if (!parent) continue;
            if (!childrenByParentVisible.has(parent)) {
              childrenByParentVisible.set(parent, []);
            }
            childrenByParentVisible.get(parent).push(opt);
          }

          const parentsWithChildren = Array.from(childrenByParentVisible.keys())
            .filter((p) => (childrenByParentVisible.get(p) || []).length > 0)
            .sort((p1, p2) => {
              if (this.preserveParentOrder) {
                const idx1 = (this.parents || []).indexOf(p1);
                const idx2 = (this.parents || []).indexOf(p2);
                const a = idx1 === -1 ? Number.POSITIVE_INFINITY : idx1;
                const b = idx2 === -1 ? Number.POSITIVE_INFINITY : idx2;
                return a - b;
              }

              const c1 = childrenByParentVisible.get(p1) || [];
              const c2 = childrenByParentVisible.get(p2) || [];
              const best1 = c1.reduce(
                (acc, x) => Math.min(acc, this.matchRank?.get(x) ?? 99),
                99
              );
              const best2 = c2.reduce(
                (acc, x) => Math.min(acc, this.matchRank?.get(x) ?? 99),
                99
              );
              return (
                best1 - best2 ||
                p1.localeCompare(p2, "it", { sensitivity: "base" })
              );
            });

          this.visibleOptions = [];

          if (parentsWithChildren.length === 0) {
            const empty = document.createElement("div");
            empty.className = "no-results";
            empty.textContent = "Nessun risultato";
            this.results.appendChild(empty);
            if (this.isOpen) {
              this.updateReservedSpace();
            }
            return;
          }

          for (const p of parentsWithChildren) {
            const group = document.createElement("div");
            group.className = "dropdown-group";

            const groupLabel = document.createElement("span");
            groupLabel.textContent = p;
            group.appendChild(groupLabel);

            if (isFiltered) {
              const showAllLink = document.createElement("a");
              showAllLink.href = "#";
              showAllLink.className = "close-dropdown-link";
              showAllLink.textContent = this.expandedParents.has(p)
                ? "mostra meno"
                : "mostra tutti";
              showAllLink.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (this.expandedParents.has(p)) {
                  this.expandedParents.delete(p);
                } else {
                  this.expandedParents.add(p);
                }
                this.renderList();
                this.input.focus();
              });
              group.appendChild(showAllLink);
            }

            this.results.appendChild(group);

            const visibleChildren = (childrenByParentVisible.get(p) || []).sort(
              (a, b) => a.localeCompare(b, "it", { sensitivity: "base" })
            );

            let childrenToRender = visibleChildren;
            if (isFiltered && this.expandedParents.has(p)) {
              const allChildren = [...(this.childrenByParent?.[p] || [])].sort(
                (a, b) => a.localeCompare(b, "it", { sensitivity: "base" })
              );
              const inVisible = new Set(visibleChildren);
              const extra = allChildren.filter((c) => !inVisible.has(c));
              childrenToRender = [...visibleChildren, ...extra];
            }

            childrenToRender.forEach((option) => {
              const index = this.visibleOptions.length;
              this.visibleOptions.push(option);

              const item = document.createElement("div");
              item.className = "dropdown-item child-item";
              item.dataset.index = String(index);

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.className = "dropdown-checkbox";
              checkbox.checked = this.selectedValues.has(option);

              const label = document.createElement("span");
              label.textContent = option;

              if (this.selectedValues.has(option)) {
                item.classList.add("selected");
              }

              checkbox.addEventListener("click", (e) => {
                e.stopPropagation();
              });
              checkbox.addEventListener("change", (e) => {
                e.stopPropagation();
                this.toggleOption(option);
              });
              item.addEventListener("click", (e) => {
                e.stopPropagation();
                this.toggleOption(option);
              });

              item.appendChild(checkbox);
              item.appendChild(label);
              this.results.appendChild(item);
            });
          }
          if (this.isOpen) {
            this.updateReservedSpace();
          }
        }

        handleKeyboard(e) {
          if (e.key === "Tab") {
            const suggestion = this.getAutocompleteSuggestion(this.input.value);
            if (suggestion) {
              e.preventDefault();
              this.input.value = suggestion.full;
              this.filterOptions(this.input.value);
              this.updateAutocompleteHint(this.input.value);
              if (!this.isOpen) {
                this.open();
              }
              this.selectedIndex = -1;
              return;
            }
          }

          if (
            e.key === "Backspace" &&
            this.input.value === "" &&
            this.selectedValues.size > 0
          ) {
            e.preventDefault();
            const last = Array.from(this.selectedValues).pop();
            if (last) {
              this.selectedValues.delete(last);
              this.renderChips();
              this.renderList();
              this.updateClearVisibility();
              if (typeof this.onSelectionChange === "function") {
                this.onSelectionChange(Array.from(this.selectedValues));
              }
            }
            return;
          }

          if (!this.isOpen && (e.key === "ArrowDown" || e.key === "ArrowUp")) {
            e.preventDefault();
            this.open();
            return;
          }

          if (!this.isOpen) return;
          const totalItems = (this.visibleOptions || []).length;

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              this.selectedIndex = Math.min(
                this.selectedIndex + 1,
                totalItems - 1
              );
              break;
            case "ArrowUp":
              e.preventDefault();
              this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
              break;
            case "Enter":
              e.preventDefault();

              // Se l'utente preme Enter senza aver selezionato un item,
              // non accettare l'autocomplete (ghost) e sopprimi i suggerimenti derivati.
              if (this.selectedIndex < 0) {
                const typed = (this.input.value || "").trim();
                const suggestion = this.getAutocompleteSuggestion(typed);

                if (suggestion) {
                  this.suppressedAutocompleteQuery = typed.toLowerCase();
                  this.suppressedAutocompleteTerms = new Set([suggestion.full]);

                  const mapped =
                    this.keywordToFiltersMap?.[suggestion.full] || [];
                  let changed = false;
                  for (const opt of mapped) {
                    if (this.selectedValues.has(opt)) {
                      this.selectedValues.delete(opt);
                      changed = true;
                    }
                  }

                  if (changed) {
                    this.renderChips();
                    this.updateClearVisibility();
                    if (typeof this.onSelectionChange === "function") {
                      this.onSelectionChange(Array.from(this.selectedValues));
                    }
                  }
                }

                // Nascondi il ghost text senza cambiare il valore digitato.
                this.autocompleteSuffix.textContent = "";
                this.autocompleteTip.textContent = "";
                this.autocompleteInline.classList.remove("show");

                // Ricalcola la lista tenendo conto della soppressione.
                this.filterOptions(this.input.value);
                this.updateAutocompleteHint(this.input.value);
                this.selectedIndex = -1;
                return;
              }

              if (this.selectedIndex >= 0) {
                const option = (this.visibleOptions || [])[this.selectedIndex];
                if (option) {
                  this.toggleOption(option);
                }
              }
              break;
            case "Escape":
              e.preventDefault();
              this.close();
              break;
          }
        }

        toggleOption(option) {
          if (this.selectedValues.has(option)) {
            this.selectedValues.delete(option);
          } else {
            this.selectedValues.add(option);
          }
          this.renderChips();
          this.renderList();
          this.updateClearVisibility();
          if (typeof this.onSelectionChange === "function") {
            this.onSelectionChange(Array.from(this.selectedValues));
          }
        }

        removeOption(option) {
          if (!this.selectedValues.has(option)) return;
          this.selectedValues.delete(option);
          this.renderChips();
          this.renderList();
          this.updateClearVisibility();
          if (typeof this.onSelectionChange === "function") {
            this.onSelectionChange(Array.from(this.selectedValues));
          }
        }

        renderChips() {
          if (!this.chipContainer) return;
          if (!this.renderChipsInInput) {
            this.chipContainer.innerHTML = "";
            return;
          }

          this.chipContainer.innerHTML = "";
          for (const value of Array.from(this.selectedValues)) {
            const chip = document.createElement("span");
            chip.className = "chip";

            const text = document.createElement("span");
            text.textContent = value;

            const remove = document.createElement("button");
            remove.type = "button";
            remove.className = "chip-remove";
            remove.textContent = "×";
            remove.addEventListener("click", (e) => {
              e.stopPropagation();
              this.selectedValues.delete(value);
              this.renderChips();
              this.renderList();
              this.updateClearVisibility();
              if (typeof this.onSelectionChange === "function") {
                this.onSelectionChange(Array.from(this.selectedValues));
              }
            });

            chip.appendChild(text);
            chip.appendChild(remove);
            this.chipContainer.appendChild(chip);
          }
        }

        resetSelection() {
          this.selectedValues.clear();
          this.input.value = "";
          this.filterOptions("");
          this.updateAutocompleteHint("");
          this.renderChips();
          this.updateClearVisibility();
          if (typeof this.onSelectionChange === "function") {
            this.onSelectionChange(Array.from(this.selectedValues));
          }
        }

        updateClearVisibility() {
          const base = this.baseInputWrapperHeight || 0;
          const current = this.inputWrapper?.offsetHeight || 0;
          const isMultiLine = base > 0 && current > base + 6;

          if (this.selectedValues.size > 0) {
            this.clear.classList.add("show");

            // Se l'input va su più righe, mantieni la X centrata e mostra anche la chevron
            // (spostata a sinistra) per non perdere l'indicatore di tendina.
            if (isMultiLine) {
              this.arrow.style.display = "block";
              this.arrow.style.right = "12px";
            } else {
              this.arrow.style.display = "none";
              this.arrow.style.right = "12px";
            }
          } else {
            this.clear.classList.remove("show");
            this.arrow.style.display = "block";
            this.arrow.style.right = "12px";
          }
        }

        open() {
          for (const inst of FilterableDropdown._instances || []) {
            if (inst !== this && inst?.isOpen) {
              inst.close();
            }
          }

          this.isOpen = true;
          this.updateAutocompleteHint(this.input.value);
          this.selectedIndex = -1;

          this.list.classList.add("show");
          this.arrow.classList.add("rotated");
          this.inputWrapper.style.borderRadius = "8px 8px 0 0";
          // Force style/layout flush so the margin-bottom transition starts in sync
          // with the dropdown-list transition.
          this.list.getBoundingClientRect();
          this.updateReservedSpace();
        }

        close() {
          this.isOpen = false;
          this.list.classList.remove("show");
          this.arrow.classList.remove("rotated");
          this.inputWrapper.style.borderRadius = "8px";
          this.selectedIndex = -1;
          this.updateAutocompleteHint("");
          this.updateReservedSpace();
        }

        toggle() {
          if (this.isOpen) {
            this.close();
          } else {
            this.open();
          }
        }
      }

      const SERVICES_BY_PARENT = {
        "ALIMENTARI E BEVANDE": [
          "Birra",
          "Tè e Caffè",
          "Dolciumi",
          "Igiene alimentare",
          "Industria alimentare",
          "Latte e latticini",
          "Alimenti biologici",
          "Bevande",
          "Liquori",
          "Vegetarianesimo",
          "Distribuzione automatica",
          "Cucina e gastronomia",
          "Alimentazione",
          "Vini ed Enologia",
        ],
        AGRICOLTURA: [
          "Agroalimentare",
          "Politica agraria",
          "Zootecnica e Allevamento",
          "Agricoltura biologica",
          "Viticoltura",
          "Agricoltura",
          "Foreste",
          "Veterinaria",
        ],
        "INFORMATICA E WEB": [
          "Ingegneria informatica",
          "Giochi e videogame",
          "Computer grafica 3D",
          "Hardware informatico",
          "Home entertainment per PC",
          "Editoria elettronica",
          "App, smartphone, Android, iOS",
          "Software",
          "Sicurezza dei sistemi",
          "Reti informatiche",
          "Sicurezza delle informazioni",
          "Web design",
          "Progettazione siti web",
          "Multimedialità",
          "Web e Social Network",
          "Information Technology",
        ],
        "ARTE E CULTURA": [
          "Arte Contemporanea",
          "Libri per bambini",
          "Narrativa",
          "Letteratura",
          "Arti Grafiche",
          "Poesia",
          "Filosofia",
          "Arte",
          "Libri e editoria",
          "Mostre",
          "Mercato d'arte e aste",
          "Storia",
          "Geografia",
          "Cultura",
          "Antiquariato",
          "Archeologia",
          "Disegno",
          "Pittura",
          "Scultura",
          "Restauro",
          "Musei e beni culturali",
        ],
      };

      const sampleOptions = Object.values(SERVICES_BY_PARENT)
        .flat()
        .sort((a, b) => a.localeCompare(b, "it", { sensitivity: "base" }));

      const dropdown = new FilterableDropdown("dropdownInput", sampleOptions, {
        parents: [
          "ALIMENTARI E BEVANDE",
          "AGRICOLTURA",
          "INFORMATICA E WEB",
          "ARTE E CULTURA",
        ],
        childrenByParent: SERVICES_BY_PARENT,
        renderChipsInInput: false,
      });
      dropdown.updateAutocompleteHint("");

      const ROLES_BY_PARENT = {
        DIREZIONE: [
          "Direttore responsabile",
          "Direttore editoriale",
          "Condirettore",
          "Vicedirettore",
        ],
        "COORDINAMENTO REDAZIONALE": [
          "Responsabile redazione",
          "Vice responsabile di redazione",
          "Capo redattore centrale",
          "Vice capo redattore centrale",
          "Capo redattore",
          "Vice capo redattore",
          "Capo servizio",
          "Vice capo servizio",
          "Responsabile servizi speciali",
          "Capo area",
          "Capocronista",
        ],
        REDAZIONE: [
          "Redattore",
          "Inviato",
          "Corrispondente",
          "Editorialista",
          "Web Editor",
        ],
        "CONTRIBUTORI / AUTORI ESTERNI": [
          "Collaboratore",
          "Autore",
          "Blogger",
          "Curatore",
        ],
        "PRODUZIONE & SUPPORTO": [
          "Produttore esecutivo",
          "Art director",
          "Consulente editoriale",
          "Responsabile segreteria redazione",
          "Segreteria redazione",
          "Segreteria direzione",
          "Assistente",
          "Praticante",
        ],
      };

      const roleOptions = Object.values(ROLES_BY_PARENT)
        .flat()
        .sort((a, b) => a.localeCompare(b, "it", { sensitivity: "base" }));

      const roleDropdown = new FilterableDropdown(
        "roleDropdownInput",
        roleOptions,
        {
          inputWrapperId: "roleDropdownInputWrapper",
          chipContainerId: "roleChipContainer",
          autocompleteInlineId: "roleAutocompleteInline",
          autocompleteSuffixId: "roleAutocompleteSuffix",
          autocompleteTipId: "roleAutocompleteTip",
          arrowId: "roleDropdownArrow",
          clearId: "roleDropdownClear",
          listId: "roleDropdownList",
          closeLinkId: "roleCloseDropdownLink",
          suggestionsId: "roleDropdownSuggestions",
          resultsId: "roleDropdownResults",
          parents: [
            "DIREZIONE",
            "COORDINAMENTO REDAZIONALE",
            "REDAZIONE",
            "CONTRIBUTORI / AUTORI ESTERNI",
            "PRODUZIONE & SUPPORTO",
          ],
          childrenByParent: ROLES_BY_PARENT,
          synonymsByFilter: {},
          renderChipsInInput: false,
          preserveParentOrder: true,
        }
      );
      roleDropdown.updateAutocompleteHint("");

      const journalists = [
        {
          nome: "Luca",
          cognome: "Rinaldi",
          ruolo: "Caporedattore",
          servizio: "Politica agraria",
          telefono: "+39 333 120 4451",
          email: "l.rinaldi@ilgiorno.it",
          testata: "Il Giorno",
          note: "Segue ministeri e politiche del territorio. Tiene i contatti con associazioni e consorzi, copre dossier su PAC, fondi e misure di sostegno; monitora anche crisi di settore e tavoli tecnici con aggiornamenti frequenti.",
        },
        {
          nome: "Sara",
          cognome: "Ferri",
          ruolo: "Redattrice",
          servizio: "Web e Social Network",
          telefono: "+39 347 558 1092",
          email: "s.ferri@lastampa.it",
          testata: "La Stampa",
          note: "Focus su piattaforme e community online.",
        },
        {
          nome: "Marco",
          cognome: "De Santis",
          ruolo: "Inviato",
          servizio: "Agricoltura",
          telefono: "+39 329 440 7710",
          email: "m.desantis@repubblica.it",
          testata: "la Repubblica",
          note: "Reportage da fiere e aziende agricole.",
        },
        {
          nome: "Giulia",
          cognome: "Conti",
          ruolo: "Redattrice",
          servizio: "Libri e editoria",
          telefono: "+39 335 210 9033",
          email: "g.conti@corriere.it",
          testata: "Corriere della Sera",
          note: "Recensioni e interviste ad autori.",
        },
        {
          nome: "Paolo",
          cognome: "Marini",
          ruolo: "Redattore",
          servizio: "Software",
          telefono: "+39 338 770 1198",
          email: "p.marini@ilsole24ore.com",
          testata: "Il Sole 24 Ore",
          note: "Prodotti, aziende e trend del software.",
        },
        {
          nome: "Elena",
          cognome: "Bianchi",
          ruolo: "Collaboratrice",
          servizio: "Mostre",
          telefono: "+39 331 905 4472",
          email: "e.bianchi@ilfattoquotidiano.it",
          testata: "Il Fatto Quotidiano",
          note: "Agenda eventi e rassegne nazionali.",
        },
        {
          nome: "Davide",
          cognome: "Gallo",
          ruolo: "Redattore",
          servizio: "Hardware informatico",
          telefono: "+39 334 602 7715",
          email: "d.gallo@wired.it",
          testata: "Wired Italia",
          note: "Componenti, device e benchmark.",
        },
        {
          nome: "Francesca",
          cognome: "Romano",
          ruolo: "Redattrice",
          servizio: "Pittura",
          telefono: "+39 320 778 0451",
          email: "f.romano@artnews.it",
          testata: "Art News",
          note: "Artisti emergenti e critica.",
        },
        {
          nome: "Andrea",
          cognome: "Lombardi",
          ruolo: "Inviato",
          servizio: "Zootecnica e Allevamento",
          telefono: "+39 349 660 1308",
          email: "a.lombardi@avvenire.it",
          testata: "Avvenire",
          note: "Filiera animale e sostenibilità.",
        },
        {
          nome: "Chiara",
          cognome: "Greco",
          ruolo: "Redattrice",
          servizio: "Archeologia",
          telefono: "+39 339 114 2290",
          email: "c.greco@ansa.it",
          testata: "ANSA",
          note: "",
        },
        {
          nome: "Matteo",
          cognome: "Esposito",
          ruolo: "Redattore",
          servizio: "Information Technology",
          telefono: "+39 333 990 8172",
          email: "m.esposito@ilsole24ore.com",
          testata: "Il Sole 24 Ore",
          note: "Digitalizzazione e infrastrutture.",
        },
        {
          nome: "Valentina",
          cognome: "Costa",
          ruolo: "Collaboratrice",
          servizio: "Cultura",
          telefono: "+39 346 550 2011",
          email: "v.costa@ilgiornale.it",
          testata: "Il Giornale",
          note: "Rubrica settimanale.",
        },
        {
          nome: "Stefano",
          cognome: "Moretti",
          ruolo: "Redattore",
          servizio: "Reti informatiche",
          telefono: "+39 334 880 1120",
          email: "s.moretti@tomshw.it",
          testata: "Tom's Hardware",
          note: "Connettività e infrastrutture.",
        },
        {
          nome: "Marta",
          cognome: "Rizzo",
          ruolo: "Redattrice",
          servizio: "Letteratura",
          telefono: "+39 333 470 9981",
          email: "m.rizzo@ilmanifesto.it",
          testata: "il manifesto",
          note: "Interviste e approfondimenti.",
        },
        {
          nome: "Riccardo",
          cognome: "Villa",
          ruolo: "Redattore",
          servizio: "Web design",
          telefono: "+39 339 771 6401",
          email: "r.villa@corriere.it",
          testata: "Corriere della Sera",
          note: "UX e tendenze.",
        },
        {
          nome: "Federica",
          cognome: "Serra",
          ruolo: "Inviata",
          servizio: "Vini ed Enologia",
          telefono: "+39 345 203 7788",
          email: "f.serra@gamberorosso.it",
          testata: "Gambero Rosso",
          note: "Degustazioni e cantine.",
        },
        {
          nome: "Alessio",
          cognome: "Orlando",
          ruolo: "Redattore",
          servizio: "Progettazione siti web",
          telefono: "+39 331 420 9090",
          email: "a.orlando@wired.it",
          testata: "Wired Italia",
          note: "Prodotti web e piattaforme.",
        },
        {
          nome: "Irene",
          cognome: "Pellegrini",
          ruolo: "Redattrice",
          servizio: "Musei e beni culturali",
          telefono: "+39 333 881 3002",
          email: "i.pellegrini@arte.it",
          testata: "Arte.it",
          note: "Patrimonio e governance museale.",
        },
        {
          nome: "Giorgio",
          cognome: "Fontana",
          ruolo: "Redattore",
          servizio: "Giochi e videogame",
          telefono: "+39 347 118 5512",
          email: "g.fontana@ilpost.it",
          testata: "Il Post",
          note: "Recensioni e anteprime.",
        },
        {
          nome: "Silvia",
          cognome: "Giordano",
          ruolo: "Collaboratrice",
          servizio: "Arte Contemporanea",
          telefono: "+39 320 100 7783",
          email: "s.giordano@exibart.com",
          testata: "Exibart",
          note: "Mostre e artisti contemporanei.",
        },
        {
          nome: "Pietro",
          cognome: "Neri",
          ruolo: "Redattore",
          servizio: "Computer grafica 3D",
          telefono: "+39 333 242 9901",
          email: "p.neri@everyeye.it",
          testata: "Everyeye",
          note: "Tool e pipeline 3D.",
        },
        {
          nome: "Laura",
          cognome: "Sanna",
          ruolo: "Redattrice",
          servizio: "Libri per bambini",
          telefono: "+39 346 222 1507",
          email: "l.sanna@sololibri.net",
          testata: "SoloLibri",
          note: "Sezione ragazzi.",
        },
        {
          nome: "Enrico",
          cognome: "Gatti",
          ruolo: "Redattore",
          servizio: "Sicurezza dei sistemi",
          telefono: "+39 339 605 1122",
          email: "e.gatti@dday.it",
          testata: "DDay",
          note: "Protezione di sistemi e endpoint.",
        },
        {
          nome: "Claudia",
          cognome: "Mancini",
          ruolo: "Redattrice",
          servizio: "Restauro",
          telefono: "+39 334 110 0099",
          email: "c.mancini@ilsole24ore.com",
          testata: "Il Sole 24 Ore",
          note: "Interventi e cantieri.",
        },
        {
          nome: "Nicola",
          cognome: "Leone",
          ruolo: "Inviato",
          servizio: "Veterinaria",
          telefono: "+39 331 700 4410",
          email: "n.leone@ansa.it",
          testata: "ANSA",
          note: "Sanità animale e ricerca.",
        },
        {
          nome: "Beatrice",
          cognome: "Martini",
          ruolo: "Redattrice",
          servizio: "Sicurezza delle informazioni",
          telefono: "+39 347 309 4401",
          email: "b.martini@repubblica.it",
          testata: "la Repubblica",
          note: "Privacy e data protection.",
        },
        {
          nome: "Tommaso",
          cognome: "Colombo",
          ruolo: "Redattore",
          servizio: "Editoria elettronica",
          telefono: "+39 333 640 7781",
          email: "t.colombo@ilpost.it",
          testata: "Il Post",
          note: [
            "Ebook e publishing digitale.",
            "Segue anche l’evoluzione delle piattaforme editoriali: standard, DRM, formati, accessibilità e distribuzione, con focus su come cambiano i modelli di lettura e abbonamento.",
            "Contatti con startup e operatori del settore.",
          ],
        },
        {
          nome: "Elisa",
          cognome: "Barbieri",
          ruolo: "Redattrice",
          servizio: "Arti Grafiche",
          telefono: "+39 345 901 2381",
          email: "e.barbieri@interni.it",
          testata: "Interni",
          note: "Grafica e visivi.",
        },
        {
          nome: "Simone",
          cognome: "Ruggieri",
          ruolo: "Redattore",
          servizio: "App, smartphone, Android, iOS",
          telefono: "+39 334 772 1812",
          email: "s.ruggieri@dday.it",
          testata: "DDay",
          note: "Mobile e app economy.",
        },
        {
          nome: "Arianna",
          cognome: "Ricci",
          ruolo: "Collaboratrice",
          servizio: "Antiquariato",
          telefono: "+39 320 667 1100",
          email: "a.ricci@artribune.com",
          testata: "Artribune",
          note: "Mercati e fiere.",
        },
        {
          nome: "Fabio",
          cognome: "Gentile",
          ruolo: "Redattore",
          servizio: "Cucina e gastronomia",
          telefono: "+39 333 222 4001",
          email: "f.gentile@cibotoday.it",
          testata: "CiboToday",
          note: null,
        },
        {
          nome: "Noemi",
          cognome: "Palumbo",
          ruolo: "Redattrice",
          servizio: "Dolciumi",
          telefono: "+39 347 100 2288",
          email: "n.palumbo@gamberorosso.it",
          testata: "Gambero Rosso",
          note: "Rubrica pasticceria.",
        },
        {
          nome: "Serena",
          cognome: "Fabbri",
          ruolo: "Redattrice",
          servizio: "Geografia",
          telefono: "+39 333 888 4021",
          email: "s.fabbri@nationalgeographic.it",
          testata: "National Geographic Italia",
          note: "Territori e mappe.",
        },
        {
          nome: "Alberto",
          cognome: "Pace",
          ruolo: "Redattore",
          servizio: "Alimentazione",
          telefono: "+39 345 711 1190",
          email: "a.pace@cibotoday.it",
          testata: "CiboToday",
          note: "Educazione alimentare.",
        },
        {
          nome: "Martina",
          cognome: "Fumagalli",
          ruolo: "Collaboratrice",
          servizio: "Scultura",
          telefono: "+39 331 992 7701",
          email: "m.fumagalli@exibart.com",
          testata: "Exibart",
          note: "Atelier e installazioni.",
        },
        {
          nome: "Giuseppe",
          cognome: "Bruno",
          ruolo: "Redattore",
          servizio: "Igiene alimentare",
          telefono: "+39 333 100 7702",
          email: "g.bruno@ansa.it",
          testata: "ANSA",
          note: "Normative e controlli.",
        },
        {
          nome: "Veronica",
          cognome: "Caruso",
          ruolo: "Redattrice",
          servizio: "Filosofia",
          telefono: "+39 347 661 8080",
          email: "v.caruso@ilmanifesto.it",
          testata: "il manifesto",
          note: "Saggi e dibattiti.",
        },
        {
          nome: "Edoardo",
          cognome: "Sala",
          ruolo: "Redattore",
          servizio: "Home entertainment per PC",
          telefono: "+39 334 410 9900",
          email: "e.sala@tomshw.it",
          testata: "Tom's Hardware",
          note: "Multimedia e streaming.",
        },
        {
          nome: "Camilla",
          cognome: "Rossi",
          ruolo: "Redattrice",
          servizio: "Mercato d'arte e aste",
          telefono: "+39 335 702 1101",
          email: "c.rossi@artribune.com",
          testata: "Artribune",
          note: "Aste e trend di mercato.",
        },
        {
          nome: "Lorenzo",
          cognome: "Marchetti",
          ruolo: "Inviato",
          servizio: "Viticoltura",
          telefono: "+39 333 410 2030",
          email: "l.marchetti@gamberorosso.it",
          testata: "Gambero Rosso",
          note: "Vendemmia e territorio.",
        },
      ];

      function normalizeRole(value) {
        const v = (value || "").trim();
        const map = {
          Redattrice: "Redattore",
          Collaboratrice: "Collaboratore",
          Inviata: "Inviato",
          Caporedattore: "Capo redattore",
        };
        return map[v] || v;
      }

      for (const j of journalists) {
        j.ruolo = normalizeRole(j.ruolo);
      }

      const selectedJournalistIds = new Set();
      const selectedJournalistOrder = [];

      const selectedPanelBody = document.getElementById("selectedPanelBody");
      const selectedClearAll = document.getElementById("selectedClearAll");
      const saveMailingListLink = document.getElementById(
        "saveMailingListLink"
      );

      const saveListModalOverlay = document.getElementById(
        "saveListModalOverlay"
      );
      const saveListModal = document.getElementById("saveListModal");
      const saveListModalClose = document.getElementById("saveListModalClose");
      const saveListNameInput = document.getElementById("saveListNameInput");
      const saveListConfirm = document.getElementById("saveListConfirm");
      const saveListError = document.getElementById("saveListError");
      const mainTitleEl = document.getElementById("mainTitle");
      const dashboardMailingListsEl = document.getElementById(
        "dashboardMailingLists"
      );

      const textFilterInput = document.getElementById("textFilterInput");
      const textFilterClear = document.getElementById("textFilterClear");

      const committedTextTerms = [];

      function getJournalistId(j) {
        return j.email;
      }

      function getJournalistNameById(jid) {
        const j = (journalists || []).find((x) => getJournalistId(x) === jid);
        if (!j) return jid;
        return `${j.nome} ${j.cognome}`;
      }

      function ensureSelectedOrder(jid) {
        const idx = selectedJournalistOrder.indexOf(jid);
        if (idx !== -1) selectedJournalistOrder.splice(idx, 1);
        selectedJournalistOrder.unshift(jid);
      }

      function removeFromSelectedOrder(jid) {
        const idx = selectedJournalistOrder.indexOf(jid);
        if (idx !== -1) selectedJournalistOrder.splice(idx, 1);
      }

      function openSaveListModal() {
        if (!saveListModal || !saveListModalOverlay) return;
        if (selectedJournalistOrder.length === 0) return;

        if (saveListNameInput) {
          saveListNameInput.value = "";
          saveListNameInput.focus();
        }
        if (saveListError) {
          saveListError.style.display = "none";
        }

        saveListModalOverlay.classList.add("show");
        saveListModal.classList.add("show");
        saveListModalOverlay.setAttribute("aria-hidden", "false");
        saveListModal.setAttribute("aria-hidden", "false");
      }

      function closeSaveListModal() {
        if (!saveListModal || !saveListModalOverlay) return;
        saveListModalOverlay.classList.remove("show");
        saveListModal.classList.remove("show");
        saveListModalOverlay.setAttribute("aria-hidden", "true");
        saveListModal.setAttribute("aria-hidden", "true");
      }

      function getMailingListById(id) {
        const k = String(id || "").trim();
        if (!k) return null;
        return (
          (appState.mailingLists || []).find((x) => x && x.id === k) || null
        );
      }

      function computeUniqueMailingListName(baseName) {
        const base = String(baseName || "").trim();
        if (!base) return "";

        const existing = new Set(
          (appState.mailingLists || [])
            .map((x) =>
              String(x?.name || "")
                .trim()
                .toLowerCase()
            )
            .filter(Boolean)
        );

        const baseKey = base.toLowerCase();
        if (!existing.has(baseKey)) return base;

        let i = 1;
        while (i < 1000) {
          const candidate = `${base} (${i})`;
          if (!existing.has(candidate.toLowerCase())) {
            return candidate;
          }
          i++;
        }
        return `${base} (${Date.now()})`;
      }

      function createMailingList(name, journalistIds) {
        const id = `ml_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const list = {
          id,
          name,
          journalistIds: Array.from(journalistIds || []),
          createdAt: Date.now(),
        };

        if (!Array.isArray(appState.mailingLists)) {
          appState.mailingLists = [];
        }
        appState.mailingLists.unshift(list);
        appState.activeMailingListId = id;
        saveAppState(appState);
        return list;
      }

      function openMailingListById(id) {
        const list = getMailingListById(id);
        if (!list) return;
        appState.activeMailingListId = list.id;
        saveAppState(appState);
        window.location.hash = "#mailing-list";
        setActiveView("mailing-list", { save: true });
        scheduleRender();
      }

      function renderDashboardMailingLists() {
        if (!dashboardMailingListsEl) return;
        dashboardMailingListsEl.innerHTML = "";

        const lists = Array.isArray(appState.mailingLists)
          ? appState.mailingLists
          : [];

        if (lists.length === 0) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "Nessuna mailing list salvata";
          dashboardMailingListsEl.appendChild(empty);
          return;
        }

        const container = document.createElement("div");
        container.className = "dashboard-mailing-lists";

        for (const ml of lists) {
          if (!ml || typeof ml !== "object") continue;
          const id = String(ml.id || "").trim();
          const name = String(ml.name || "").trim();
          const count = Array.isArray(ml.journalistIds)
            ? ml.journalistIds.length
            : 0;
          const createdAt = Number(ml.createdAt || 0);
          if (!id || !name) continue;

          const row = document.createElement("div");
          row.className = "dashboard-mailing-list-item";

          const left = document.createElement("div");
          left.className = "dashboard-mailing-list-left";

          const title = document.createElement("a");
          title.href = "#";
          title.className = "dashboard-mailing-list-link";
          title.textContent = name;
          title.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            openMailingListById(id);
          });

          const meta = document.createElement("div");
          meta.className = "dashboard-mailing-list-meta";
          if (Number.isFinite(createdAt) && createdAt > 0) {
            const stamp = new Date(createdAt).toLocaleString("it-IT");
            meta.textContent = `creata il ${stamp}`;
          } else {
            meta.textContent = "";
          }

          left.appendChild(title);
          if (meta.textContent) left.appendChild(meta);

          const pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = String(count);

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "dashboard-mailing-list-delete";
          deleteBtn.setAttribute("aria-label", `Elimina ${name}`);
          deleteBtn.textContent = "×";
          deleteBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();

            const ok = window.confirm(`Eliminare la mailing list "${name}"?`);
            if (!ok) return;

            appState.mailingLists = (appState.mailingLists || []).filter(
              (x) => String(x?.id || "") !== id
            );
            if (String(appState.activeMailingListId || "") === id) {
              appState.activeMailingListId = "";
            }
            saveAppState(appState);
            renderDashboardMailingLists();
          });

          const actions = document.createElement("div");
          actions.className = "dashboard-mailing-list-actions";
          actions.appendChild(pill);
          actions.appendChild(deleteBtn);

          row.appendChild(left);
          row.appendChild(actions);
          container.appendChild(row);
        }

        dashboardMailingListsEl.appendChild(container);
      }

      function escapeRegExp(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      const NOTE_MAX_CHARS = 120;
      const NOTE_MATCH_MAX_CHARS = 80;

      function normalizeNotes(note) {
        if (Array.isArray(note)) {
          return note
            .map((x) => String(x ?? "").trim())
            .filter((x) => x.length > 0);
        }
        const s = String(note ?? "").trim();
        return s ? [s] : [];
      }

      function combineNotes(notesArr) {
        return (notesArr || []).join(" • ");
      }

      function makeSnippet(text, query, maxChars) {
        const raw = String(text ?? "");
        const q = String(query ?? "")
          .trim()
          .toLowerCase();
        if (!raw) return "";
        if (raw.length <= maxChars) return raw;

        const rawLower = raw.toLowerCase();
        const idx = q ? rawLower.indexOf(q) : -1;

        let start = 0;
        const anchoredToMatch = idx >= 0;
        if (idx >= 0) {
          start = Math.max(0, idx);

          const back = raw.lastIndexOf(" ", idx);
          if (back >= 0 && back < idx) {
            start = Math.max(0, back + 1);
          }
        }
        let end = start + maxChars;
        if (end > raw.length) {
          end = raw.length;
          if (!anchoredToMatch) {
            start = Math.max(0, end - maxChars);
          }
        }

        const prefix = start > 0 ? "..." : "";
        const suffix = end < raw.length ? "..." : "";
        return `${prefix}${raw.slice(start, end)}${suffix}`;
      }

      function highlightHtml(text, query) {
        const raw = String(text ?? "");
        const q = String(query ?? "").trim();
        if (!q) return escapeHtml(raw);

        const re = new RegExp(escapeRegExp(q), "gi");
        let out = "";
        let lastIndex = 0;
        let match;
        while ((match = re.exec(raw)) !== null) {
          const start = match.index;
          const end = start + match[0].length;
          out += escapeHtml(raw.slice(lastIndex, start));
          out += `<span class="highlight">${escapeHtml(
            raw.slice(start, end)
          )}</span>`;
          lastIndex = end;
          if (match[0].length === 0) break;
        }
        out += escapeHtml(raw.slice(lastIndex));
        return out;
      }

      function highlightHtmlMulti(text, queries) {
        const raw = String(text ?? "");
        const terms = (queries || [])
          .map((x) => String(x ?? "").trim())
          .filter(Boolean);
        if (!terms.length) return escapeHtml(raw);

        const uniq = [];
        const seen = new Set();
        for (const t of terms) {
          const k = t.toLowerCase();
          if (seen.has(k)) continue;
          seen.add(k);
          uniq.push(t);
        }

        uniq.sort((a, b) => b.length - a.length);
        const re = new RegExp(uniq.map((t) => escapeRegExp(t)).join("|"), "gi");

        let out = "";
        let lastIndex = 0;
        let match;
        while ((match = re.exec(raw)) !== null) {
          const start = match.index;
          const end = start + match[0].length;
          out += escapeHtml(raw.slice(lastIndex, start));
          out += `<span class="highlight">${escapeHtml(
            raw.slice(start, end)
          )}</span>`;
          lastIndex = end;
          if (match[0].length === 0) break;
        }
        out += escapeHtml(raw.slice(lastIndex));
        return out;
      }

      function getActiveTextTerms() {
        const current = String(textFilterInput?.value || "").trim();
        const terms = [...committedTextTerms];
        if (current) terms.push(current);
        return terms;
      }

      function findBestMatchTerm(haystack, terms) {
        const h = String(haystack || "").toLowerCase();
        let best = null;
        let bestIdx = Infinity;
        for (const t of terms || []) {
          const q = String(t || "")
            .trim()
            .toLowerCase();
          if (!q) continue;
          const idx = h.indexOf(q);
          if (idx >= 0 && idx < bestIdx) {
            bestIdx = idx;
            best = t;
          }
        }
        return best;
      }

      function updateCardSelectionUI(jid) {
        const card = document.querySelector(
          `.card[data-jid="${CSS.escape(jid)}"]`
        );
        if (!card) return;
        if (selectedJournalistIds.has(jid)) {
          card.classList.add("is-selected");
        } else {
          card.classList.remove("is-selected");
        }
      }

      function updateCheckboxUI(jid) {
        const checkbox = document.querySelector(
          `.card-select[data-jid="${CSS.escape(jid)}"]`
        );
        if (!checkbox) return;
        checkbox.checked = selectedJournalistIds.has(jid);
      }

      function renderSelectedPanelList() {
        if (!selectedPanelBody) return;
        selectedPanelBody.innerHTML = "";

        if (selectedJournalistOrder.length === 0) {
          return;
        }

        const list = document.createElement("div");
        list.className = "selected-list";

        for (const jid of selectedJournalistOrder) {
          if (!selectedJournalistIds.has(jid)) continue;

          const item = document.createElement("div");
          item.className = "selected-item";

          const left = document.createElement("div");
          left.className = "selected-item-left";

          const name = document.createElement("div");
          name.className = "selected-item-name";
          name.textContent = getJournalistNameById(jid);

          const scheda = document.createElement("a");
          scheda.href = "#";
          scheda.className = "testata-link journalist-link";
          scheda.textContent = "scheda";
          scheda.setAttribute("data-journalist", getJournalistNameById(jid));

          const remove = document.createElement("button");
          remove.type = "button";
          remove.className = "selected-item-remove";
          remove.textContent = "×";
          remove.setAttribute("data-jid", jid);

          left.appendChild(name);
          left.appendChild(scheda);
          item.appendChild(left);
          item.appendChild(remove);
          list.appendChild(item);
        }

        selectedPanelBody.appendChild(list);
      }

      function createCard(j) {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.servizio = j.servizio;
        card.dataset.ruolo = j.ruolo;

        const jid = getJournalistId(j);
        card.dataset.jid = jid;
        const isSelected = selectedJournalistIds.has(jid);
        if (isSelected) {
          card.classList.add("is-selected");
        }

        const checkboxId = `card-select-${jid.replace(/[^a-zA-Z0-9_-]/g, "_")}`;

        const activeTerms = getActiveTextTerms();
        const highlightedName = highlightHtmlMulti(
          `${j.nome} ${j.cognome}`,
          activeTerms
        );
        const highlightedTestata = highlightHtmlMulti(j.testata, activeTerms);
        const notesArr = normalizeNotes(j.note);

        const notesCombined = combineNotes(notesArr);
        const notePreviewBaseRaw = (() => {
          if (!notesArr.length) return "nessuna nota";

          const best = findBestMatchTerm(notesCombined, activeTerms);
          if (best)
            return makeSnippet(notesCombined, best, NOTE_MATCH_MAX_CHARS);

          if (notesArr.length === 1) {
            if (notesCombined.length > NOTE_MAX_CHARS) {
              return makeSnippet(notesCombined, "", NOTE_MAX_CHARS);
            }
            return notesCombined;
          }

          return String(notesArr[0] || "");
        })();

        const hasHiddenNotesContent =
          notesArr.length > 1 ||
          (notesCombined &&
            notePreviewBaseRaw &&
            notesCombined.length > notePreviewBaseRaw.length);

        const noteDisplayRaw =
          notesArr.length &&
          hasHiddenNotesContent &&
          !notePreviewBaseRaw.endsWith("...")
            ? `${notePreviewBaseRaw}...`
            : notePreviewBaseRaw;

        const noteShowsEllipsis =
          notesArr.length &&
          typeof noteDisplayRaw === "string" &&
          noteDisplayRaw.includes("...");

        const highlightedNote = notesArr.length
          ? highlightHtmlMulti(noteDisplayRaw, activeTerms)
          : escapeHtml(noteDisplayRaw);

        card.innerHTML = `
          <div class="card-top">
            <div class="card-name-row">
              <input
                class="card-select"
                type="checkbox"
                id="${checkboxId}"
                data-jid="${jid}"
                ${isSelected ? "checked" : ""}
              />
              <label class="card-name-label" for="${checkboxId}">
                <h3 class="card-name">${highlightedName}</h3>
              </label>
              <a
                href="#"
                class="testata-link journalist-link"
                data-journalist="${j.nome} ${j.cognome}"
              >
                scheda
              </a>
            </div>
            <p class="card-role">${j.ruolo}</p>
          </div>
          <div class="card-row"><div class="card-label">Servizio giornalistico</div><div class="card-value">${
            j.servizio
          }</div></div>
          <div class="card-row"><div class="card-label">Telefono</div><div class="card-value">${
            j.telefono
          }</div></div>
          <div class="card-row"><div class="card-label">E-mail</div><div class="card-value">${
            j.email
          }</div></div>
          <div class="card-row"><div class="card-label">Testata</div><div class="card-value"><a href="#" class="testata-link" data-testata="${
            j.testata
          }">${highlightedTestata}</a></div></div>
          <div class="card-row"><div class="card-label">${
            noteShowsEllipsis
              ? `<a href="#" class="card-label-link card-notes-open" data-jid="${jid}">Note</a>`
              : "Note"
          }</div><div class="card-value muted card-note">${highlightedNote}</div></div>
        `;
        return card;
      }

      const testataOverlay = document.getElementById("testataOverlay");
      const testataPanel = document.getElementById("testataPanel");
      const testataPanelTitle = document.getElementById("testataPanelTitle");
      const testataPanelBody = document.getElementById("testataPanelBody");
      const testataPanelClose = document.getElementById("testataPanelClose");

      const notesModalOverlay = document.getElementById("notesModalOverlay");
      const notesModal = document.getElementById("notesModal");
      const notesModalTitle = document.getElementById("notesModalTitle");
      const notesModalBody = document.getElementById("notesModalBody");
      const notesModalClose = document.getElementById("notesModalClose");

      const selectedPanel = document.getElementById("selectedPanel");

      function openSelectedPanel() {
        selectedPanel.classList.add("show");
        selectedPanel.setAttribute("aria-hidden", "false");
        document.body.classList.add("selection-panel-open");
        renderSelectedPanelList();
      }

      function closeSelectedPanel() {
        selectedPanel.classList.remove("show");
        selectedPanel.setAttribute("aria-hidden", "true");
        document.body.classList.remove("selection-panel-open");
      }

      if (selectedClearAll) {
        selectedClearAll.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          selectedJournalistIds.clear();
          selectedJournalistOrder.length = 0;

          document.querySelectorAll(".card-select").forEach((el) => {
            el.checked = false;
          });
          document.querySelectorAll(".card.is-selected").forEach((el) => {
            el.classList.remove("is-selected");
          });

          renderSelectedPanelList();
          closeSelectedPanel();
        });
      }

      if (saveMailingListLink) {
        saveMailingListLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (selectedJournalistOrder.length === 0) return;
          openSaveListModal();
        });
      }

      if (saveListModalClose) {
        saveListModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeSaveListModal();
        });
      }

      if (saveListModalOverlay) {
        saveListModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeSaveListModal();
        });
      }

      function confirmSaveList() {
        const selectionSnapshot = selectedJournalistOrder.filter((jid) =>
          selectedJournalistIds.has(jid)
        );

        const rawName = String(saveListNameInput?.value || "").trim();
        if (!rawName) {
          if (saveListError) saveListError.style.display = "block";
          if (saveListNameInput) saveListNameInput.focus();
          return;
        }
        if (saveListError) saveListError.style.display = "none";

        const uniqueName = computeUniqueMailingListName(rawName);
        createMailingList(uniqueName, selectionSnapshot);

        selectedJournalistIds.clear();
        selectedJournalistOrder.splice(0, selectedJournalistOrder.length);
        renderSelectedPanelList();
        closeSelectedPanel();

        closeSaveListModal();

        window.location.hash = "#mailing-list";
        setActiveView("mailing-list", { save: true });
        scheduleRender();
      }

      if (saveListConfirm) {
        saveListConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          confirmSaveList();
        });
      }

      if (saveListNameInput) {
        saveListNameInput.addEventListener("input", () => {
          if (!saveListError) return;
          if (String(saveListNameInput.value || "").trim()) {
            saveListError.style.display = "none";
          }
        });

        saveListNameInput.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          e.preventDefault();
          e.stopPropagation();
          confirmSaveList();
        });
      }

      function updateTextFilterClearVisibility() {
        if (!textFilterClear || !textFilterInput) return;
        if (
          (textFilterInput.value || "").trim().length > 0 ||
          committedTextTerms.length > 0
        ) {
          textFilterClear.classList.add("show");
        } else {
          textFilterClear.classList.remove("show");
        }
      }

      if (textFilterInput) {
        textFilterInput.addEventListener("input", () => {
          updateTextFilterClearVisibility();
          scheduleRender();
        });

        textFilterInput.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          const term = String(textFilterInput.value || "").trim();
          if (!term) return;

          e.preventDefault();
          e.stopPropagation();

          const k = term.toLowerCase();
          const exists = committedTextTerms.some(
            (t) =>
              String(t || "")
                .trim()
                .toLowerCase() === k
          );
          if (!exists) {
            committedTextTerms.unshift(term);
          }

          textFilterInput.value = "";
          updateTextFilterClearVisibility();
          scheduleRender();
        });
      }

      if (textFilterClear) {
        textFilterClear.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!textFilterInput) return;
          textFilterInput.value = "";
          committedTextTerms.splice(0, committedTextTerms.length);
          updateTextFilterClearVisibility();
          scheduleRender();
        });
      }

      function openTestataPanel(testata) {
        testataPanelTitle.textContent = "Testata";
        testataPanelBody.textContent = `testata: ${testata}`;
        testataOverlay.classList.add("show");
        testataPanel.classList.add("show");
        testataOverlay.setAttribute("aria-hidden", "false");
        testataPanel.setAttribute("aria-hidden", "false");
      }

      function openJournalistPanel(journalistName) {
        testataPanelTitle.textContent = "Giornalista";
        testataPanelBody.innerHTML = "";

        const fullNameKey = String(journalistName || "")
          .trim()
          .toLowerCase();

        const j = (journalists || []).find((x) => {
          const k = `${String(x?.nome || "").trim()} ${String(
            x?.cognome || ""
          ).trim()}`
            .trim()
            .toLowerCase();
          return k === fullNameKey;
        });

        if (!j) {
          testataPanelBody.textContent = `giornalista: ${journalistName}`;
        } else {
          const jid = getJournalistId(j);
          const checkboxId = `journalist-panel-select-${jid.replace(
            /[^a-zA-Z0-9_-]/g,
            "_"
          )}`;

          const titleRow = document.createElement("div");
          titleRow.style.display = "flex";
          titleRow.style.alignItems = "center";
          titleRow.style.gap = "10px";
          titleRow.style.marginBottom = "12px";

          const select = document.createElement("input");
          select.type = "checkbox";
          select.className = "card-select";
          select.id = checkboxId;
          select.checked = selectedJournalistIds.has(jid);
          select.addEventListener("change", (e) => {
            e.stopPropagation();

            if (select.checked) {
              selectedJournalistIds.add(jid);
              ensureSelectedOrder(jid);
              openSelectedPanel();
            } else {
              selectedJournalistIds.delete(jid);
              removeFromSelectedOrder(jid);
              if (selectedJournalistIds.size === 0) {
                closeSelectedPanel();
              } else {
                renderSelectedPanelList();
              }
            }

            updateCheckboxUI(jid);
            updateCardSelectionUI(jid);
          });

          const title = document.createElement("label");
          title.setAttribute("for", checkboxId);
          title.style.fontWeight = "800";
          title.style.cursor = "pointer";
          title.textContent = `${j.nome} ${j.cognome}`;

          titleRow.appendChild(select);
          titleRow.appendChild(title);
          testataPanelBody.appendChild(titleRow);

          const addRow = (labelText, valueNode) => {
            const row = document.createElement("div");
            row.className = "card-row";

            const label = document.createElement("div");
            label.className = "card-label";
            label.textContent = labelText;

            const value = document.createElement("div");
            value.className = "card-value";
            if (valueNode) {
              value.appendChild(valueNode);
            }

            row.appendChild(label);
            row.appendChild(value);
            testataPanelBody.appendChild(row);
          };

          const ruolo = document.createElement("span");
          ruolo.textContent = String(j.ruolo || "");
          addRow("Ruolo", ruolo);

          const servizio = document.createElement("span");
          servizio.textContent = String(j.servizio || "");
          addRow("Servizio giornalistico", servizio);

          const telefono = document.createElement("span");
          telefono.textContent = String(j.telefono || "");
          addRow("Telefono", telefono);

          const email = document.createElement("span");
          email.textContent = String(j.email || "");
          addRow("E-mail", email);

          const testata = document.createElement("span");
          testata.textContent = String(j.testata || "");
          addRow("Testata", testata);

          const notesArr = normalizeNotes(j.note);
          const notesWrap = document.createElement("div");
          if (!notesArr.length) {
            const empty = document.createElement("div");
            empty.className = "muted";
            empty.textContent = "nessuna nota";
            notesWrap.appendChild(empty);
          } else {
            const ul = document.createElement("ul");
            ul.className = "notes-modal-list";
            for (const n of notesArr) {
              const li = document.createElement("li");
              li.textContent = String(n || "");
              ul.appendChild(li);
            }
            notesWrap.appendChild(ul);
          }
          addRow("Note", notesWrap);
        }

        testataOverlay.classList.add("show");
        testataPanel.classList.add("show");
        testataOverlay.setAttribute("aria-hidden", "false");
        testataPanel.setAttribute("aria-hidden", "false");
      }

      function closeTestataPanel() {
        testataOverlay.classList.remove("show");
        testataPanel.classList.remove("show");
        testataOverlay.setAttribute("aria-hidden", "true");
        testataPanel.setAttribute("aria-hidden", "true");
      }

      function openNotesModal(jid) {
        if (
          !notesModal ||
          !notesModalOverlay ||
          !notesModalTitle ||
          !notesModalBody
        )
          return;

        const j = (journalists || []).find((x) => getJournalistId(x) === jid);
        const titleName = j ? `${j.nome} ${j.cognome}` : jid;

        notesModalTitle.textContent = `Note — ${titleName}`;
        notesModalBody.innerHTML = "";

        const notesArr = normalizeNotes(j?.note);
        const list = document.createElement("ul");
        list.className = "notes-modal-list";

        if (!notesArr.length) {
          const li = document.createElement("li");
          li.textContent = "nessuna nota";
          list.appendChild(li);
        } else {
          for (const n of notesArr) {
            const li = document.createElement("li");
            li.textContent = n;
            list.appendChild(li);
          }
        }

        notesModalBody.appendChild(list);

        notesModalOverlay.classList.add("show");
        notesModal.classList.add("show");
        notesModalOverlay.setAttribute("aria-hidden", "false");
        notesModal.setAttribute("aria-hidden", "false");
      }

      function closeNotesModal() {
        if (!notesModal || !notesModalOverlay) return;
        notesModalOverlay.classList.remove("show");
        notesModal.classList.remove("show");
        notesModalOverlay.setAttribute("aria-hidden", "true");
        notesModal.setAttribute("aria-hidden", "true");
      }

      if (notesModalClose) {
        notesModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeNotesModal();
        });
      }

      if (notesModalOverlay) {
        notesModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeNotesModal();
        });
      }

      if (testataPanelClose) {
        testataPanelClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeTestataPanel();
        });
      }

      if (testataOverlay) {
        testataOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeTestataPanel();
        });
      }

      document.addEventListener(
        "keydown",
        (e) => {
          if (e.key !== "Escape") return;
          if (saveListModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeSaveListModal();
            return;
          }
          if (notesModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeNotesModal();
            return;
          }

          if (!testataPanel?.classList?.contains("show")) return;
          e.preventDefault();
          e.stopPropagation();
          closeTestataPanel();
        },
        true
      );

      let _renderRaf = null;
      function scheduleRender() {
        if (_renderRaf) return;
        _renderRaf = requestAnimationFrame(() => {
          _renderRaf = null;
          renderCards();
        });
      }

      function getFilterState() {
        const selectedServices = Array.from(dropdown.selectedValues || []);
        const selectedRoles = Array.from(roleDropdown.selectedValues || []);
        const activeTextTerms = getActiveTextTerms();
        const currentTextQuery = (textFilterInput?.value || "").trim();

        const servicesActive = selectedServices.length > 0;
        const rolesActive = selectedRoles.length > 0;
        const textActive = activeTextTerms.length > 0;
        const active = servicesActive || rolesActive || textActive;

        return {
          selectedServices,
          selectedRoles,
          activeTextTerms,
          currentTextQuery,
          servicesActive,
          rolesActive,
          textActive,
          active,
        };
      }

      function renderCards() {
        const grid = document.getElementById("cardsGrid");
        const countEl = document.getElementById("cardsCount");
        const subtitleEl = document.getElementById("cardsSubtitle");
        const clearFiltersLink = document.getElementById("clearFiltersLink");

        const {
          selectedServices,
          selectedRoles,
          activeTextTerms,
          currentTextQuery,
          servicesActive,
          rolesActive,
          textActive,
          active,
        } = getFilterState();

        const isMailingListView = appState.view === "mailing-list";
        const activeList = isMailingListView
          ? getMailingListById(appState.activeMailingListId)
          : null;

        if (mainTitleEl) {
          if (isMailingListView && activeList) {
            mainTitleEl.textContent = activeList.name;
          } else {
            mainTitleEl.textContent = "Filtra Banca Dati";
          }
        }

        const baseJournalists = (() => {
          if (!isMailingListView) return journalists;
          if (!activeList) return [];
          const allowed = new Set(activeList.journalistIds || []);
          return journalists.filter((j) => allowed.has(getJournalistId(j)));
        })();

        if (clearFiltersLink) {
          clearFiltersLink.style.display = active ? "inline-block" : "none";
        }

        const filtered = baseJournalists.filter((j) => {
          const serviceOk =
            !servicesActive || selectedServices.includes(j.servizio);
          const roleOk = !rolesActive || selectedRoles.includes(j.ruolo);

          const fullName = `${j.nome} ${j.cognome}`.toLowerCase();
          const testata = String(j.testata || "").toLowerCase();
          const noteCombined = combineNotes(
            normalizeNotes(j.note)
          ).toLowerCase();

          const textOk =
            !textActive ||
            activeTextTerms.every((term) => {
              const t = String(term || "")
                .trim()
                .toLowerCase();
              if (!t) return true;
              return (
                fullName.includes(t) ||
                testata.includes(t) ||
                noteCombined.includes(t)
              );
            });

          return serviceOk && roleOk && textOk;
        });

        grid.innerHTML = "";
        for (const j of filtered) {
          grid.appendChild(createCard(j));
        }

        countEl.textContent = `${filtered.length} / ${baseJournalists.length}`;

        if (!active) {
          subtitleEl.textContent = "";
        } else {
          subtitleEl.innerHTML = "";

          const filtersBar = document.createElement("div");
          filtersBar.className = "filters-bar";

          const createChip = (value, onRemove) => {
            const chip = document.createElement("span");
            chip.className = "chip";

            const text = document.createElement("span");
            text.textContent = value;

            const remove = document.createElement("button");
            remove.type = "button";
            remove.className = "chip-remove";
            remove.textContent = "×";
            remove.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              onRemove();
            });

            chip.appendChild(text);
            chip.appendChild(remove);
            return chip;
          };

          const makeRow = (labelText) => {
            const row = document.createElement("div");
            row.className = "filters-row";

            const label = document.createElement("span");
            label.className = "filters-section-label";
            label.textContent = labelText;
            row.appendChild(label);
            return row;
          };

          if (textActive) {
            const row = makeRow("Termine:");

            for (const t of committedTextTerms) {
              row.appendChild(
                createChip(t, () => {
                  const idx = committedTextTerms.indexOf(t);
                  if (idx !== -1) committedTextTerms.splice(idx, 1);
                  updateTextFilterClearVisibility();
                  scheduleRender();
                })
              );
            }

            if (currentTextQuery) {
              row.appendChild(
                createChip(currentTextQuery, () => {
                  if (!textFilterInput) return;
                  textFilterInput.value = "";
                  updateTextFilterClearVisibility();
                  scheduleRender();
                })
              );
            }
            bar.appendChild(row);
          }

          if (servicesActive) {
            const row = makeRow("Servizio:");
            for (const s of selectedServices) {
              row.appendChild(
                createChip(s, () => {
                  dropdown.removeOption(s);
                })
              );
            }
            bar.appendChild(row);
          }

          if (rolesActive) {
            const row = makeRow("Ruolo:");
            for (const r of selectedRoles) {
              row.appendChild(
                createChip(r, () => {
                  roleDropdown.removeOption(r);
                })
              );
            }

            if (servicesActive) {
              bar.appendChild(row);
            } else {
              bar.insertBefore(row, bar.firstChild);
            }
          }

          subtitleEl.appendChild(bar);
        }
      }

      let isBulkFilterReset = false;

      const clearAllFilters = () => {
        isBulkFilterReset = true;
        dropdown.resetSelection();
        roleDropdown.resetSelection();
        committedTextTerms.splice(0, committedTextTerms.length);
        if (textFilterInput) {
          textFilterInput.value = "";
          updateTextFilterClearVisibility();
        }
        isBulkFilterReset = false;
        scheduleRender();
      };

      dropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      roleDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      const clearFiltersLink = document.getElementById("clearFiltersLink");
      if (clearFiltersLink) {
        clearFiltersLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          clearAllFilters();
        });
      }

      const cardsGrid = document.getElementById("cardsGrid");
      if (cardsGrid) {
        cardsGrid.addEventListener("click", (e) => {
          const notesLink = e.target?.closest?.(".card-notes-open");
          const testataLink = e.target?.closest?.(".testata-link");
          const journalistLink = e.target?.closest?.(".journalist-link");
          if (!notesLink && !testataLink && !journalistLink) return;

          e.preventDefault();
          e.stopPropagation();

          if (notesLink) {
            const jid = notesLink.getAttribute("data-jid");
            if (!jid) return;
            openNotesModal(jid);
            return;
          }

          if (journalistLink) {
            const name =
              journalistLink.getAttribute("data-journalist") ||
              journalistLink.textContent;
            openJournalistPanel(name);
            return;
          }

          const testata =
            testataLink.getAttribute("data-testata") || testataLink.textContent;
          openTestataPanel(testata);
        });

        cardsGrid.addEventListener("change", (e) => {
          const checkbox = e.target?.closest?.(".card-select");
          if (!checkbox) return;
          const jid = checkbox.getAttribute("data-jid");
          if (!jid) return;

          const card = checkbox.closest(".card");
          if (checkbox.checked) {
            selectedJournalistIds.add(jid);
            ensureSelectedOrder(jid);
            card?.classList?.add("is-selected");
            openSelectedPanel();
          } else {
            selectedJournalistIds.delete(jid);
            removeFromSelectedOrder(jid);
            card?.classList?.remove("is-selected");
            if (selectedJournalistIds.size === 0) {
              closeSelectedPanel();
            } else {
              renderSelectedPanelList();
            }
          }
        });
      }

      if (selectedPanelBody) {
        selectedPanelBody.addEventListener("click", (e) => {
          const journalistLink = e.target?.closest?.(".journalist-link");
          if (journalistLink) {
            e.preventDefault();
            e.stopPropagation();
            const name =
              journalistLink.getAttribute("data-journalist") ||
              journalistLink.textContent;
            openJournalistPanel(name);
            return;
          }

          const btn = e.target?.closest?.(".selected-item-remove");
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();

          const jid = btn.getAttribute("data-jid");
          if (!jid) return;

          selectedJournalistIds.delete(jid);
          removeFromSelectedOrder(jid);

          updateCheckboxUI(jid);
          updateCardSelectionUI(jid);

          if (selectedJournalistIds.size === 0) {
            closeSelectedPanel();
          } else {
            renderSelectedPanelList();
          }
        });
      }

      const navSidebar = document.querySelector(".nav-sidebar");
      if (navSidebar) {
        navSidebar.addEventListener("click", (e) => {
          const link = e.target?.closest?.("a[data-view]");
          if (!link) return;

          e.preventDefault();
          e.stopPropagation();

          const viewId = link.getAttribute("data-view");
          const v = normalizeViewId(viewId);
          if (!v) return;

          window.location.hash = `#${v}`;
        });
      }

      window.addEventListener("hashchange", () => {
        const requested = getViewFromHash();
        if (requested && !ENABLED_VIEWS.has(requested)) {
          window.location.hash = "#filtra";
          return;
        }

        setActiveView(requested, { save: true });
      });

      const initialFromHash = getViewFromHash();
      if (initialFromHash && !ENABLED_VIEWS.has(initialFromHash)) {
        window.location.hash = "#filtra";
      }
      const initialView = initialFromHash || appState.view || "filtra";
      setActiveView(initialView, { save: true });

      scheduleRender();
    </script>
  </body>
</html>
