<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>M__</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Next:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Schibsted+Grotesk:ital,wght@0,400..900;1,400..900&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="page">
      <aside class="nav-sidebar" aria-label="Navigazione">
        <nav>
          <a href="#dashboard" data-view="dashboard">
            <span class="nav-icon" data-icon="M__" aria-hidden="true"></span>
            <span>dashboard</span>
          </a>
          <a
            href="#filtra"
            data-view="filtra"
            class="is-active"
            aria-current="page"
          >
            <span class="nav-icon" data-icon="filter" aria-hidden="true"></span>
            <span>banca dati</span></a
          >

          <div class="nav-separator" aria-hidden="true"></div>

          <a href="#mailing-lists" data-view="mailing-lists">
            <span class="nav-icon" data-icon="list" aria-hidden="true"></span>
            <span>liste</span>
          </a>

          <a href="#comunicati" data-view="comunicati">
            <span
              class="nav-icon"
              data-icon="campaign"
              aria-hidden="true"
            ></span>
            <span>comunicati</span>
          </a>

          <a href="#spedizioni" data-view="spedizioni">
            <span class="nav-icon" data-icon="send" aria-hidden="true"></span>
            <span>spedizioni</span>
          </a>

          <a href="#progetti" data-view="progetti">
            <span class="nav-icon" data-icon="folder" aria-hidden="true"></span>
            <span>progetti</span>
          </a>
          <a href="#todos" data-view="todos">
            <span class="nav-icon" data-icon="task" aria-hidden="true"></span>
            <span>todos</span>
          </a>

          <div
            class="nav-separator nav-separator-bottom"
            aria-hidden="true"
          ></div>
          <a href="#">
            <span
              class="nav-icon"
              data-icon="notification"
              aria-hidden="true"
            ></span>
            <span>notifiche</span>
          </a>
          <a href="#">
            <span
              class="nav-icon"
              data-icon="account"
              aria-hidden="true"
            ></span>
            <span>account</span>
          </a>

          <div class="nav-separator" aria-hidden="true"></div>

          <a href="#" id="navThemeToggle" aria-label="tema scuro">
            <span
              class="nav-icon"
              data-icon="dark_mode"
              aria-hidden="true"
            ></span>
          </a>
        </nav>
      </aside>
      <div class="views" id="views">
        <div class="app-view is-active" data-view="filtra" id="viewFiltra">
          <aside class="sidebar">
            <div class="sidebar-mode" role="radiogroup" aria-label="Modalità">
              <input
                type="radio"
                name="sidebarMode"
                id="sidebarModeJournalists"
                value="giornalisti"
                checked
              />
              <label class="sidebar-mode-option" for="sidebarModeJournalists"
                >giornalisti</label
              >
              <span
                class="pill"
                id="sidebarCountJournalists"
                style="display: inline-block"
              ></span>
              <span class="sidebar-mode-separator">|</span>
              <input
                type="radio"
                name="sidebarMode"
                id="sidebarModeTestate"
                value="testate"
              />
              <label class="sidebar-mode-option" for="sidebarModeTestate"
                >testate</label
              >
              <span
                class="pill"
                id="sidebarCountTestate"
                style="display: inline-block"
              ></span>
            </div>

            <div class="sidebar-filters-scroll">
              <div class="dropdown-container" style="margin-bottom: 18px">
                <div class="filter-label-row">
                  <label class="field-label" for="textFilterInput"
                    >Giornalista, Testata, Note</label
                  >
                  <a href="#" class="filter-clear-link" id="textFilterClearLink"
                    >rimuovi</a
                  >
                </div>
                <div class="dropdown-input" id="textFilterInputWrapper">
                  <input
                    type="text"
                    class="chip-text-input"
                    id="textFilterInput"
                    autocomplete="off"
                  />
                </div>
              </div>

              <hr class="sidebar-separator" />
              <div class="sidebar-section-title">Filtri giornalista</div>

              <div class="journalist-filters-slot" id="journalistFiltersSlot">
                <div
                  class="journalist-filters-content"
                  id="journalistFiltersContent"
                >
                  <div class="dropdown-container">
                    <div class="filter-label-row">
                      <label class="field-label" for="dropdownInput"
                        >Servizio giornalistico</label
                      >
                      <a
                        href="#"
                        class="filter-clear-link"
                        id="dropdownClearLink"
                        >rimuovi</a
                      >
                    </div>
                    <div class="dropdown-input" id="dropdownInputWrapper">
                      <div id="chipContainer"></div>
                      <input
                        type="text"
                        class="chip-text-input"
                        id="dropdownInput"
                        autocomplete="off"
                      />
                      <div
                        class="autocomplete-inline"
                        id="autocompleteInline"
                        aria-hidden="true"
                      >
                        <span
                          class="autocomplete-suffix"
                          id="autocompleteSuffix"
                        ></span>
                        <span
                          class="autocomplete-tip"
                          id="autocompleteTip"
                        ></span>
                      </div>
                      <div class="dropdown-arrow" id="dropdownArrow"></div>
                    </div>
                    <div class="dropdown-list" id="dropdownList">
                      <div
                        class="dropdown-suggestions"
                        id="dropdownSuggestions"
                      ></div>
                      <div class="dropdown-results" id="dropdownResults"></div>
                      <div class="dropdown-footer">
                        <a
                          href="#"
                          class="close-dropdown-link"
                          id="closeDropdownLink"
                          >chiudi tendina</a
                        >
                        <button
                          type="button"
                          class="keycap"
                          aria-hidden="true"
                          tabindex="-1"
                        >
                          ESC
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="dropdown-container" style="margin-top: 18px">
                    <div class="filter-label-row">
                      <label class="field-label" for="roleDropdownInput"
                        >Ruolo in redazione</label
                      >
                      <a
                        href="#"
                        class="filter-clear-link"
                        id="roleDropdownClearLink"
                        >rimuovi</a
                      >
                    </div>
                    <div class="dropdown-input" id="roleDropdownInputWrapper">
                      <div id="roleChipContainer"></div>
                      <input
                        type="text"
                        class="chip-text-input"
                        id="roleDropdownInput"
                        autocomplete="off"
                      />
                      <div
                        class="autocomplete-inline"
                        id="roleAutocompleteInline"
                        aria-hidden="true"
                      >
                        <span
                          class="autocomplete-suffix"
                          id="roleAutocompleteSuffix"
                        ></span>
                        <span
                          class="autocomplete-tip"
                          id="roleAutocompleteTip"
                        ></span>
                      </div>
                      <div class="dropdown-arrow" id="roleDropdownArrow"></div>
                    </div>
                    <div class="dropdown-list" id="roleDropdownList">
                      <div
                        class="dropdown-suggestions"
                        id="roleDropdownSuggestions"
                      ></div>
                      <div
                        class="dropdown-results"
                        id="roleDropdownResults"
                      ></div>
                      <div class="dropdown-footer">
                        <a
                          href="#"
                          class="close-dropdown-link"
                          id="roleCloseDropdownLink"
                          >chiudi tendina</a
                        >
                        <button
                          type="button"
                          class="keycap"
                          aria-hidden="true"
                          tabindex="-1"
                        >
                          ESC
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  class="journalist-filters-placeholder"
                  id="journalistFiltersPlaceholder"
                >
                  <em>Non si applicano alle testate.</em>
                </div>
              </div>

              <hr class="sidebar-separator" />
              <div class="sidebar-section-title">Filtri testata</div>

              <div class="dropdown-container">
                <div class="filter-label-row">
                  <label class="field-label" for="testataArgomentoDropdownInput"
                    >Argomento testata</label
                  >
                  <a
                    href="#"
                    class="filter-clear-link"
                    id="testataArgomentoDropdownClearLink"
                    >rimuovi</a
                  >
                </div>
                <div
                  class="dropdown-input"
                  id="testataArgomentoDropdownInputWrapper"
                >
                  <div id="testataArgomentoChipContainer"></div>
                  <input
                    type="text"
                    class="chip-text-input"
                    id="testataArgomentoDropdownInput"
                    autocomplete="off"
                  />
                  <div
                    class="autocomplete-inline"
                    id="testataArgomentoAutocompleteInline"
                    aria-hidden="true"
                  >
                    <span
                      class="autocomplete-suffix"
                      id="testataArgomentoAutocompleteSuffix"
                    ></span>
                    <span
                      class="autocomplete-tip"
                      id="testataArgomentoAutocompleteTip"
                    ></span>
                  </div>
                  <div
                    class="dropdown-arrow"
                    id="testataArgomentoDropdownArrow"
                  ></div>
                </div>
                <div class="dropdown-list" id="testataArgomentoDropdownList">
                  <div
                    class="dropdown-suggestions"
                    id="testataArgomentoDropdownSuggestions"
                  ></div>
                  <div
                    class="dropdown-results"
                    id="testataArgomentoDropdownResults"
                  ></div>
                  <div class="dropdown-footer">
                    <a
                      href="#"
                      class="close-dropdown-link"
                      id="testataArgomentoCloseDropdownLink"
                      >chiudi tendina</a
                    >
                    <button
                      type="button"
                      class="keycap"
                      aria-hidden="true"
                      tabindex="-1"
                    >
                      ESC
                    </button>
                  </div>
                </div>
              </div>

              <div class="dropdown-container" style="margin-top: 18px">
                <div class="filter-label-row">
                  <label class="field-label" for="testataTipoMediaDropdownInput"
                    >Tipo di media</label
                  >
                  <a
                    href="#"
                    class="filter-clear-link"
                    id="testataTipoMediaDropdownClearLink"
                    >rimuovi</a
                  >
                </div>
                <div
                  class="dropdown-input"
                  id="testataTipoMediaDropdownInputWrapper"
                >
                  <div id="testataTipoMediaChipContainer"></div>
                  <input
                    type="text"
                    class="chip-text-input"
                    id="testataTipoMediaDropdownInput"
                    autocomplete="off"
                  />
                  <div
                    class="autocomplete-inline"
                    id="testataTipoMediaAutocompleteInline"
                    aria-hidden="true"
                  >
                    <span
                      class="autocomplete-suffix"
                      id="testataTipoMediaAutocompleteSuffix"
                    ></span>
                    <span
                      class="autocomplete-tip"
                      id="testataTipoMediaAutocompleteTip"
                    ></span>
                  </div>
                  <div
                    class="dropdown-arrow"
                    id="testataTipoMediaDropdownArrow"
                  ></div>
                </div>
                <div class="dropdown-list" id="testataTipoMediaDropdownList">
                  <div
                    class="dropdown-suggestions"
                    id="testataTipoMediaDropdownSuggestions"
                  ></div>
                  <div
                    class="dropdown-results"
                    id="testataTipoMediaDropdownResults"
                  ></div>
                  <div class="dropdown-footer">
                    <a
                      href="#"
                      class="close-dropdown-link"
                      id="testataTipoMediaCloseDropdownLink"
                      >chiudi tendina</a
                    >
                    <button
                      type="button"
                      class="keycap"
                      aria-hidden="true"
                      tabindex="-1"
                    >
                      ESC
                    </button>
                  </div>
                </div>
              </div>

              <div class="dropdown-container" style="margin-top: 18px">
                <div class="filter-label-row">
                  <label class="field-label" for="testataFrequenzaDropdownInput"
                    >Frequenza di pubblicazione</label
                  >
                  <a
                    href="#"
                    class="filter-clear-link"
                    id="testataFrequenzaDropdownClearLink"
                    >rimuovi</a
                  >
                </div>
                <div
                  class="dropdown-input"
                  id="testataFrequenzaDropdownInputWrapper"
                >
                  <div id="testataFrequenzaChipContainer"></div>
                  <input
                    type="text"
                    class="chip-text-input"
                    id="testataFrequenzaDropdownInput"
                    autocomplete="off"
                  />
                  <div
                    class="autocomplete-inline"
                    id="testataFrequenzaAutocompleteInline"
                    aria-hidden="true"
                  >
                    <span
                      class="autocomplete-suffix"
                      id="testataFrequenzaAutocompleteSuffix"
                    ></span>
                    <span
                      class="autocomplete-tip"
                      id="testataFrequenzaAutocompleteTip"
                    ></span>
                  </div>
                  <div
                    class="dropdown-arrow"
                    id="testataFrequenzaDropdownArrow"
                  ></div>
                </div>
                <div class="dropdown-list" id="testataFrequenzaDropdownList">
                  <div
                    class="dropdown-suggestions"
                    id="testataFrequenzaDropdownSuggestions"
                  ></div>
                  <div
                    class="dropdown-results"
                    id="testataFrequenzaDropdownResults"
                  ></div>
                  <div class="dropdown-footer">
                    <a
                      href="#"
                      class="close-dropdown-link"
                      id="testataFrequenzaCloseDropdownLink"
                      >chiudi tendina</a
                    >
                    <button
                      type="button"
                      class="keycap"
                      aria-hidden="true"
                      tabindex="-1"
                    >
                      ESC
                    </button>
                  </div>
                </div>
              </div>

              <div class="dropdown-container" style="margin-top: 18px">
                <div class="filter-label-row">
                  <label
                    class="field-label"
                    for="testataDiffusioneDropdownInput"
                    >Diffusione</label
                  >
                  <a
                    href="#"
                    class="filter-clear-link"
                    id="testataDiffusioneDropdownClearLink"
                    >rimuovi</a
                  >
                </div>
                <div
                  class="dropdown-input"
                  id="testataDiffusioneDropdownInputWrapper"
                >
                  <div id="testataDiffusioneChipContainer"></div>
                  <input
                    type="text"
                    class="chip-text-input"
                    id="testataDiffusioneDropdownInput"
                    autocomplete="off"
                  />
                  <div
                    class="autocomplete-inline"
                    id="testataDiffusioneAutocompleteInline"
                    aria-hidden="true"
                  >
                    <span
                      class="autocomplete-suffix"
                      id="testataDiffusioneAutocompleteSuffix"
                    ></span>
                    <span
                      class="autocomplete-tip"
                      id="testataDiffusioneAutocompleteTip"
                    ></span>
                  </div>
                  <div
                    class="dropdown-arrow"
                    id="testataDiffusioneDropdownArrow"
                  ></div>
                </div>
                <div class="dropdown-list" id="testataDiffusioneDropdownList">
                  <div
                    class="dropdown-suggestions"
                    id="testataDiffusioneDropdownSuggestions"
                  ></div>
                  <div
                    class="dropdown-results"
                    id="testataDiffusioneDropdownResults"
                  ></div>
                  <div class="dropdown-footer">
                    <a
                      href="#"
                      class="close-dropdown-link"
                      id="testataDiffusioneCloseDropdownLink"
                      >chiudi tendina</a
                    >
                    <button
                      type="button"
                      class="keycap"
                      aria-hidden="true"
                      tabindex="-1"
                    >
                      ESC
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </aside>

          <main class="main">
            <div class="main-header">
              <div>
                <div class="main-header-row">
                  <div class="main-header-left">
                    <h1 class="main-title" id="mainTitle">Banca Dati</h1>
                    <span
                      class="pill"
                      id="mailingListCountPill"
                      style="display: none"
                    ></span>
                    <a href="#" class="testata-link" id="chooseDatabaseLink"
                      >configura</a
                    >
                    <div
                      class="mailing-list-actions"
                      id="mailingListActions"
                      style="display: none"
                    >
                      <a
                        href="#"
                        class="c-link c-link--nav"
                        id="mailingListRenameLink"
                        >rinomina</a
                      >
                      <a
                        href="#"
                        class="c-link c-link--nav"
                        id="mailingListExportLink"
                        >esporta</a
                      >
                      <span class="sidebar-mode-separator" aria-hidden="true"
                        >•</span
                      >
                      <a
                        href="#"
                        class="c-link c-link--action"
                        id="mailingListDuplicateLink"
                        >duplica</a
                      >
                      <a
                        href="#"
                        class="c-link c-link--action"
                        id="mailingListDeleteLink"
                        >elimina</a
                      >
                    </div>
                  </div>
                </div>
                <div
                  class="main-subtitle"
                  id="mailingListCreatedAtSubtitle"
                  style="display: none"
                ></div>
                <a
                  href="#"
                  class="close-dropdown-link main-clear-filters"
                  id="clearFiltersLink"
                  >rimuovi filtri</a
                >
                <div class="main-subtitle" id="cardsSubtitle"></div>
                <div class="bulk-sort-controls-row">
                  <span class="bulk-select-controls" id="bulkSelectControls">
                    <a href="#" class="bulk-select-link" id="selectAllLink"
                      >seleziona tutti</a
                    >
                  </span>
                  <span class="c-sort-controls c-sort-controls--v2">
                    <span class="main-subtitle">ordina:</span>

                    <span
                      class="c-sort-controls__group c-sort-controls__group--legacy"
                    >
                      <span class="main-subtitle">nome</span>
                      <a href="#" class="sort-link" id="sortByNameAscLink"
                        >a-z</a
                      >
                      <span class="sidebar-mode-separator" aria-hidden="true"
                        >/</span
                      >
                      <a href="#" class="sort-link" id="sortByNameDescLink"
                        >z-a</a
                      >
                    </span>

                    <span
                      class="c-sort-controls__group c-sort-controls__group--dropdown"
                    >
                      <span class="c-sort-select" id="sortByNameSelect">
                        <button
                          type="button"
                          class="c-sort-select__trigger"
                          id="sortByNameSelectTrigger"
                          aria-haspopup="listbox"
                          aria-expanded="false"
                        >
                          <span
                            class="sort-link is-active"
                            id="sortByNameSelectValue"
                            >nome a-z</span
                          >
                        </button>
                        <span
                          class="c-sort-select__arrow"
                          aria-hidden="true"
                        ></span>
                        <div
                          class="dropdown-list c-sort-select__menu"
                          id="sortByNameSelectMenu"
                          role="listbox"
                          aria-hidden="true"
                        >
                          <div class="dropdown-results">
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="true"
                              data-sort="name-asc"
                              id="sortByNameOptionAsc"
                            >
                              <a href="#" class="sort-link is-active"
                                >nome a-z</a
                              >
                            </div>
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="false"
                              data-sort="name-desc"
                              id="sortByNameOptionDesc"
                            >
                              <a href="#" class="sort-link">nome z-a</a>
                            </div>
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="false"
                              data-sort="role"
                              id="sortByNameOptionRole"
                            >
                              <a href="#" class="sort-link">ruolo</a>
                            </div>
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="false"
                              data-sort="media-type"
                              id="sortByNameOptionMediaType"
                            >
                              <a href="#" class="sort-link">tipo di media</a>
                            </div>
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="false"
                              data-sort="frequency"
                              id="sortByNameOptionFrequency"
                            >
                              <a href="#" class="sort-link">frequenza</a>
                            </div>
                          </div>
                        </div>
                      </span>
                    </span>

                    <span
                      class="c-sort-controls__group c-sort-controls__group--links"
                    >
                      <span
                        class="sidebar-mode-separator"
                        aria-hidden="true"
                        id="sortSepAfterName"
                        >|</span
                      >
                      <a href="#" class="sort-link" id="sortByRoleLink"
                        >ruolo</a
                      >
                      <span
                        class="sidebar-mode-separator"
                        aria-hidden="true"
                        id="sortSepAfterRole"
                        >|</span
                      >
                      <a href="#" class="sort-link" id="sortByMediaTypeLink"
                        >tipo di media</a
                      >
                      <span
                        class="sidebar-mode-separator"
                        aria-hidden="true"
                        id="sortSepAfterMediaType"
                        >|</span
                      >
                      <a href="#" class="sort-link" id="sortByFrequencyLink"
                        >frequenza</a
                      >
                    </span>
                  </span>
                </div>
              </div>
            </div>
            <div class="cards-grid" id="cardsGrid"></div>
          </main>

          <aside class="selected-panel" id="selectedPanel" aria-hidden="true">
            <div class="selected-panel-header">
              <div class="selected-panel-header-left">
                <div class="selected-panel-title-row">
                  <span class="selected-panel-title-row-left">
                    <p class="selected-panel-title">Selezionati</p>
                    <span class="pill" id="selectedCountPill"></span>
                  </span>
                  <span
                    class="c-split-button"
                    id="selectedActionsSplit"
                    data-split-button
                  >
                    <button
                      type="button"
                      class="c-split-button__main c-link c-link--nav"
                      data-split-main
                      data-split-action="save-list"
                    >
                      salva lista
                    </button>
                    <button
                      type="button"
                      class="c-split-button__toggle"
                      data-split-toggle
                      aria-haspopup="listbox"
                      aria-expanded="false"
                    >
                      <span
                        class="c-split-button__arrow"
                        aria-hidden="true"
                      ></span>
                    </button>
                    <div
                      class="dropdown-list c-split-button__menu"
                      data-split-menu
                      role="listbox"
                      aria-hidden="true"
                    >
                      <div class="dropdown-results">
                        <div class="dropdown-item" role="option">
                          <a
                            href="#"
                            class="c-link c-link--nav"
                            data-split-action="add-to-list"
                            >aggiungi a lista</a
                          >
                        </div>
                        <div class="dropdown-item" role="option">
                          <a
                            href="#"
                            class="c-link c-link--nav"
                            data-split-action="add-to-new-shipment"
                            >salva spedizione</a
                          >
                        </div>
                        <div class="dropdown-item" role="option">
                          <a
                            href="#"
                            class="c-link c-link--nav"
                            data-split-action="add-to-shipment"
                            >aggiungi a spedizione</a
                          >
                        </div>
                      </div>
                    </div>
                  </span>
                </div>
                <div
                  class="selected-panel-actions-row selected-panel-actions-row--secondary"
                  id="selectedInListRow"
                  style="display: none"
                >
                  <span class="selected-panel-actions-text">
                    in lista
                    <span class="c-pill" id="selectedInListCount"></span>
                  </span>
                  <span class="sidebar-mode-separator" aria-hidden="true"
                    >•</span
                  >
                  <a
                    href="#"
                    class="c-link c-link--action"
                    id="selectedRemoveFromListLink"
                  >
                    rimuovi da lista
                  </a>
                </div>
                <a href="#" class="close-dropdown-link" id="selectedClearAll">
                  svuota selezione
                </a>
              </div>
            </div>
            <div class="selected-panel-body" id="selectedPanelBody"></div>
          </aside>
        </div>

        <div class="app-view" data-view="dashboard" id="viewDashboard">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Liste</h1>
              </div>
            </div>
            <div class="dashboard-layout">
              <div class="dashboard-mailing-lists-col">
                <div id="dashboardMailingLists"></div>
              </div>
            </div>
          </main>
        </div>

        <div class="app-view" data-view="mailing-lists" id="viewMailingLists">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Liste</h1>
              </div>
            </div>
            <div class="muted">placeholder</div>
          </main>
        </div>

        <div class="app-view" data-view="comunicati" id="viewComunicati">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Comunicati</h1>
              </div>
            </div>
            <div class="muted">placeholder</div>
          </main>
        </div>

        <div class="app-view" data-view="spedizioni" id="viewSpedizioni">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Spedizioni</h1>
              </div>
            </div>
            <div class="muted">placeholder</div>
          </main>
        </div>

        <div class="app-view" data-view="progetti" id="viewProgetti">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Progetti</h1>
              </div>
            </div>
            <div class="muted">placeholder</div>
          </main>
        </div>

        <div class="app-view" data-view="todos" id="viewTodos">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Todos</h1>
              </div>
            </div>
            <div class="muted">placeholder</div>
          </main>
        </div>

        <div class="app-view" data-view="mailing-list" id="viewMailingList">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Mailing list</h1>
                <div class="main-subtitle">in preparazione</div>
              </div>
            </div>
            <div class="muted">work in progress</div>
          </main>
        </div>
      </div>
    </div>

    <div class="testata-overlay" id="testataOverlay" aria-hidden="true"></div>
    <aside class="testata-panel" id="testataPanel" aria-hidden="true">
      <div class="testata-panel-header">
        <div
          class="testata-panel-header-content"
          id="testataPanelHeaderContent"
        >
          <p class="testata-panel-title" id="testataPanelTitle">Testata</p>
        </div>
        <button
          type="button"
          class="testata-panel-close"
          id="testataPanelClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="testata-panel-body" id="testataPanelBody"></div>
    </aside>

    <div
      class="notes-modal-overlay"
      id="notesModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="notesModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="notesModalTitle">Note</p>
        <button
          type="button"
          class="notes-modal-close"
          id="notesModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body" id="notesModalBody"></div>
    </div>

    <div
      class="notes-modal-overlay"
      id="saveListModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="saveListModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="saveListModalTitle">Salva lista</p>
        <button
          type="button"
          class="notes-modal-close"
          id="saveListModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <label class="field-label" for="saveListNameInput">Nome lista</label>
        <div class="dropdown-input">
          <input
            type="text"
            class="chip-text-input"
            id="saveListNameInput"
            autocomplete="off"
          />
        </div>
        <div class="form-error" id="saveListError" style="display: none">
          dai nome alla lista
        </div>
        <a href="#" class="close-dropdown-link" id="saveListConfirm">
          salva lista
        </a>
      </div>
    </div>

    <div
      class="notes-modal-overlay"
      id="shareListModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="shareListModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="shareListModalTitle">
          condividi lista
        </p>
        <button
          type="button"
          class="notes-modal-close"
          id="shareListModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <div class="share-list-users" id="shareListUsers"></div>
        <a href="#" class="c-link c-link--action" id="shareListConfirm">
          condividi
        </a>
      </div>
    </div>

    <div
      class="notes-modal-overlay"
      id="addToListModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="addToListModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="addToListModalTitle">
          Aggiungi a lista
        </p>
        <button
          type="button"
          class="notes-modal-close"
          id="addToListModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <div class="dropdown-container" style="margin-bottom: 0">
          <div class="filter-label-row">
            <label class="field-label" for="addToListDropdownInput"
              >Liste</label
            >
          </div>
          <div class="dropdown-input" id="addToListDropdownInputWrapper">
            <div id="addToListChipContainer"></div>
            <input
              type="text"
              class="chip-text-input"
              id="addToListDropdownInput"
              autocomplete="off"
            />
            <div
              class="autocomplete-inline"
              id="addToListAutocompleteInline"
              aria-hidden="true"
            >
              <span
                class="autocomplete-suffix"
                id="addToListAutocompleteSuffix"
              ></span>
              <span
                class="autocomplete-tip"
                id="addToListAutocompleteTip"
              ></span>
            </div>
            <div class="dropdown-arrow" id="addToListDropdownArrow"></div>
          </div>
          <div class="dropdown-list" id="addToListDropdownList">
            <div
              class="dropdown-suggestions"
              id="addToListDropdownSuggestions"
            ></div>
            <div class="dropdown-results" id="addToListDropdownResults"></div>
          </div>
        </div>

        <div class="form-error" id="addToListError" style="display: none">
          seleziona una lista
        </div>

        <a href="#" class="close-dropdown-link" id="addToListConfirm">
          aggiungi
        </a>
      </div>
    </div>

    <div
      class="notes-modal-overlay"
      id="addToShipmentModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="addToShipmentModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="addToShipmentModalTitle">
          aggiungi a spedizione
        </p>
        <button
          type="button"
          class="notes-modal-close"
          id="addToShipmentModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <div class="dropdown-container" style="margin-bottom: 0">
          <div class="filter-label-row">
            <label class="field-label" for="addToShipmentDropdownInput"
              >Spedizioni</label
            >
            <a
              href="#"
              class="filter-clear-link"
              id="addToShipmentDropdownClearLink"
              >rimuovi</a
            >
          </div>
          <div class="dropdown-input" id="addToShipmentDropdownInputWrapper">
            <div id="addToShipmentChipContainer"></div>
            <input
              type="text"
              class="chip-text-input"
              id="addToShipmentDropdownInput"
              autocomplete="off"
            />
            <div
              class="autocomplete-inline"
              id="addToShipmentAutocompleteInline"
              aria-hidden="true"
            >
              <span
                class="autocomplete-suffix"
                id="addToShipmentAutocompleteSuffix"
              ></span>
              <span
                class="autocomplete-tip"
                id="addToShipmentAutocompleteTip"
              ></span>
            </div>
            <div class="dropdown-arrow" id="addToShipmentDropdownArrow"></div>
          </div>
          <div class="dropdown-list" id="addToShipmentDropdownList">
            <div
              class="dropdown-suggestions"
              id="addToShipmentDropdownSuggestions"
            ></div>
            <div
              class="dropdown-results"
              id="addToShipmentDropdownResults"
            ></div>
          </div>
        </div>

        <div class="form-error" id="addToShipmentError" style="display: none">
          seleziona una spedizione
        </div>

        <a href="#" class="close-dropdown-link" id="addToShipmentConfirm">
          aggiungi
        </a>
      </div>
    </div>

    <div
      class="notes-modal-overlay"
      id="addToNewShipmentModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="addToNewShipmentModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="addToNewShipmentModalTitle">
          aggiungi a nuova spedizione
        </p>
        <button
          type="button"
          class="notes-modal-close"
          id="addToNewShipmentModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <label class="field-label" for="addToNewShipmentNameInput"
          >Oggetto spedizione</label
        >
        <div class="dropdown-input">
          <input
            type="text"
            class="chip-text-input"
            id="addToNewShipmentNameInput"
            autocomplete="off"
          />
        </div>

        <div
          class="form-error"
          id="addToNewShipmentError"
          style="display: none"
        >
          inserisci oggetto spedizione
        </div>

        <a href="#" class="close-dropdown-link" id="addToNewShipmentConfirm">
          crea nuova spedizione
        </a>
      </div>
    </div>

    <script>
      const APP_STORAGE_KEY = "proto-servizio-app-state-v1";

      function loadAppState() {
        try {
          const raw = localStorage.getItem(APP_STORAGE_KEY);
          if (!raw) {
            return {
              view: "filtra",
              mailingLists: [],
              comunicati: [],
              spedizioni: [],
            };
          }
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") {
            return {
              view: "filtra",
              mailingLists: [],
              comunicati: [],
              spedizioni: [],
            };
          }
          return {
            view: typeof parsed.view === "string" ? parsed.view : "filtra",
            mailingLists: Array.isArray(parsed.mailingLists)
              ? parsed.mailingLists
              : [],
            comunicati: Array.isArray(parsed.comunicati)
              ? parsed.comunicati
              : [],
            spedizioni: Array.isArray(parsed.spedizioni)
              ? parsed.spedizioni
              : [],
          };
        } catch (e) {
          return {
            view: "filtra",
            mailingLists: [],
            comunicati: [],
            spedizioni: [],
          };
        }
      }

      function saveAppState(state) {
        try {
          localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(state || {}));
        } catch (e) {
          return;
        }
      }

      const appState = loadAppState();

      if (typeof appState.activeMailingListId !== "string") {
        appState.activeMailingListId = "";
      }

      if (!appState.ui || typeof appState.ui !== "object") {
        appState.ui = {};
      }

      function normalizeTheme(value) {
        const v = String(value || "")
          .trim()
          .toLowerCase();
        if (v === "dark") return "dark";
        return "light";
      }

      if (typeof appState.ui.theme !== "string") {
        appState.ui.theme = "light";
      }

      function applyTheme(theme) {
        const next = normalizeTheme(theme);
        document.body.dataset.theme = next;
        const a = document.getElementById("navThemeToggle");
        if (!a) return;
        const icon = a.querySelector(".nav-icon");
        if (icon) {
          icon.setAttribute(
            "data-icon",
            next === "dark" ? "light_mode" : "dark_mode",
          );
        }
        a.setAttribute(
          "aria-label",
          next === "dark" ? "tema chiaro" : "tema scuro",
        );
        a.setAttribute("aria-pressed", next === "dark" ? "true" : "false");
      }

      function setTheme(theme) {
        const next = normalizeTheme(theme);
        appState.ui.theme = next;
        applyTheme(next);
        saveAppState(appState);
      }

      if (
        !appState.ui.sectionOpen ||
        typeof appState.ui.sectionOpen !== "object"
      ) {
        appState.ui.sectionOpen = {};
      }

      if (
        typeof appState.ui.sectionOpen.notes !== "boolean" &&
        typeof appState.ui.notesOpen === "boolean"
      ) {
        appState.ui.sectionOpen.notes = appState.ui.notesOpen;
      }

      if (typeof appState.ui.sectionOpen.notes !== "boolean") {
        appState.ui.sectionOpen.notes = false;
      }

      for (const k of [
        "topics",
        "contacts",
        "redazioni",
        "articles",
        "mailing",
        "shipments",
      ]) {
        if (typeof appState.ui.sectionOpen[k] !== "boolean") {
          appState.ui.sectionOpen[k] = true;
        }
      }

      function getSectionOpen(key, defaultOpen) {
        const v = appState?.ui?.sectionOpen?.[key];
        return typeof v === "boolean" ? v : !!defaultOpen;
      }

      function setSectionOpen(key, open) {
        if (!appState.ui || typeof appState.ui !== "object") {
          appState.ui = {};
        }
        if (
          !appState.ui.sectionOpen ||
          typeof appState.ui.sectionOpen !== "object"
        ) {
          appState.ui.sectionOpen = {};
        }
        appState.ui.sectionOpen[key] = !!open;
        saveAppState(appState);
      }

      if (typeof appState.sortMode !== "string") {
        appState.sortMode = "name-asc";
      }

      applyTheme(appState.ui.theme);

      const navThemeToggle = document.getElementById("navThemeToggle");
      if (navThemeToggle) {
        navThemeToggle.addEventListener("click", (e) => {
          e.preventDefault();
          const current = normalizeTheme(appState.ui.theme);
          setTheme(current === "dark" ? "light" : "dark");
        });
      }

      function getSortMode() {
        const v = String(appState.sortMode || "")
          .trim()
          .toLowerCase();
        if (v === "role") return "role";
        if (v === "media-type") return "media-type";
        if (v === "frequency") return "frequency";
        if (v === "name-desc") return "name-desc";
        return "name-asc";
      }

      function setSortMode(mode) {
        const raw = String(mode || "")
          .trim()
          .toLowerCase();
        const next =
          raw === "role"
            ? "role"
            : raw === "media-type" || raw === "tipo-media"
              ? "media-type"
              : raw === "frequency" || raw === "frequenza"
                ? "frequency"
                : raw === "name-desc" || raw === "name-z-a" || raw === "z-a"
                  ? "name-desc"
                  : "name-asc";
        appState.sortMode = next;
        saveAppState(appState);
        scheduleRender();
      }

      const ENABLED_VIEWS = new Set([
        "filtra",
        "mailing-list",
        "dashboard",
        "mailing-lists",
        "comunicati",
        "spedizioni",
        "progetti",
        "todos",
      ]);

      function normalizeViewId(value) {
        const v = String(value || "")
          .trim()
          .toLowerCase();
        if (!v) return "";
        if (!/^[a-z0-9-]+$/.test(v)) return "";
        return v;
      }

      function setActiveView(viewId, options = {}) {
        const { save = true } = options;
        const prevView = normalizeViewId(appState.view);
        let v = normalizeViewId(viewId);
        if (!v || !ENABLED_VIEWS.has(v)) {
          v = "filtra";
        }

        appState.view = v;
        document.body.dataset.activeView = v;

        document.querySelectorAll(".app-view").forEach((el) => {
          const viewKey = el.getAttribute("data-view");
          const shouldShow =
            v === "mailing-list" ? viewKey === "filtra" : viewKey === v;
          el.classList.toggle("is-active", shouldShow);
        });

        const sp = document.getElementById("selectedPanel");
        if (sp && v !== "filtra" && v !== "mailing-list") {
          sp.classList.remove("show");
          sp.setAttribute("aria-hidden", "true");
          document.body.classList.remove("selection-panel-open");
        }

        if (
          v === "filtra" &&
          prevView !== "filtra" &&
          selectedJournalistIds.size > 0
        ) {
          openSelectedPanel();
        }

        if (v === "mailing-list" && selectedJournalistIds.size > 0) {
          openSelectedPanel();
        }

        document.querySelectorAll(".nav-sidebar a[data-view]").forEach((a) => {
          const isActive = a.getAttribute("data-view") === v;
          a.classList.toggle("is-active", isActive);
          if (isActive) {
            a.setAttribute("aria-current", "page");
          } else {
            a.removeAttribute("aria-current");
          }
        });

        if (save) {
          saveAppState(appState);
        }

        if (v === "filtra" || v === "mailing-list") {
          scheduleRender();
        } else if (v === "dashboard") {
          renderDashboardMailingLists();
        }
      }

      function getViewFromHash() {
        const raw = window.location.hash || "";
        if (!raw.startsWith("#")) return "";
        return normalizeViewId(raw.slice(1));
      }

      class FilterableDropdown {
        constructor(inputId, options = [], config = {}) {
          const {
            inputWrapperId = "dropdownInputWrapper",
            chipContainerId = "chipContainer",
            autocompleteInlineId = "autocompleteInline",
            autocompleteSuffixId = "autocompleteSuffix",
            autocompleteTipId = "autocompleteTip",
            arrowId = "dropdownArrow",
            clearId = "dropdownClearLink",
            listId = "dropdownList",
            closeLinkId = "closeDropdownLink",
            suggestionsId = "dropdownSuggestions",
            resultsId = "dropdownResults",
          } = config;

          this.renderChipsInInput = config.renderChipsInInput !== false;
          this.renderCheckboxes = config.renderCheckboxes !== false;
          this.singleSelect = config.singleSelect === true;
          this.closeOnSelect = config.closeOnSelect === true;
          this.writeSelectedToInput = config.writeSelectedToInput === true;
          this.enableHighlight = config.enableHighlight === true;
          this.minFilterChars =
            typeof config.minFilterChars === "number"
              ? config.minFilterChars
              : 3;
          this.preserveParentOrder = config.preserveParentOrder === true;
          this.sortComparator =
            typeof config.sortComparator === "function"
              ? config.sortComparator
              : (a, b) => a.localeCompare(b, "it", { sensitivity: "base" });

          this.input = document.getElementById(inputId);
          this.inputWrapper = document.getElementById(inputWrapperId);
          this.container = this.input?.closest(".dropdown-container");
          this.label = this.container?.querySelector(
            `label.field-label[for="${inputId}"]`,
          );

          this.baseContainerMarginBottom = 0;
          if (this.container) {
            const mb = window.getComputedStyle(this.container).marginBottom;
            this.baseContainerMarginBottom = parseFloat(mb || "0") || 0;
          }
          this.chipContainer = document.getElementById(chipContainerId);
          this.autocompleteInline =
            document.getElementById(autocompleteInlineId);
          this.autocompleteSuffix =
            document.getElementById(autocompleteSuffixId);
          this.autocompleteTip = document.getElementById(autocompleteTipId);
          this.arrow = document.getElementById(arrowId);
          this.clear = clearId ? document.getElementById(clearId) : null;
          this.list = document.getElementById(listId);
          this.closeLink = closeLinkId
            ? document.getElementById(closeLinkId)
            : null;
          this.suggestions = document.getElementById(suggestionsId);
          this.results = document.getElementById(resultsId);

          this.originalOptions = options;
          this.filteredOptions = [...options];
          this.selectedValues = new Set();
          this.strongMatchOptions = new Set();
          this.matchRank = new Map();
          this.visibleOptions = [...options];
          this.isOpen = false;
          this.selectedIndex = -1;

          this.suppressedAutocompleteQuery = null;
          this.suppressedAutocompleteTerms = new Set();

          if (!FilterableDropdown._instances) {
            FilterableDropdown._instances = new Set();
          }
          FilterableDropdown._instances.add(this);

          this.baseInputWrapperHeight = null;

          this.ignoreWrapperClick = false;
          this.expandedParents = new Set();

          this.parents = config.parents || [];
          this.childrenByParent = config.childrenByParent || {};

          this.optionToParent = {};
          for (const p of this.parents) {
            for (const child of this.childrenByParent[p] || []) {
              this.optionToParent[child] = p;
            }
          }

          this.relatedMap = {};
          this.autocompleteMap = {};
          this.keywordToFiltersMap = {};

          const defaultSynonymsByFilter = {
            "Disegno grafico": [
              "Grafica pubblicitaria",
              "Design grafico",
              "Progettazione grafica",
            ],
            "Infusi e caffetteria": [
              "Bevande calde",
              "Infusi e caffetteria",
              "Bevande stimolanti",
            ],
            Dolciumi: [
              "Dolci",
              "Caramelle",
              "Confetteria",
              "Prodotti zuccherini",
            ],
            "Igiene alimentare": [
              "Sicurezza alimentare",
              "Sanità degli alimenti",
              "Controllo igienico-sanitario",
            ],
            "Industria alimentare": [
              "Settore alimentare",
              "Industria agroalimentare",
              "Comparto alimentare",
            ],
            "Latte e latticini": [
              "Prodotti caseari",
              "Derivati del latte",
              "Lattiero-caseario",
            ],
            "Alimenti biologici": [
              "Cibi biologici",
              "Prodotti bio",
              "Alimenti da agricoltura biologica",
            ],
            Bevande: ["Drink", "Bibite", "Bevande analcoliche"],
            Liquori: ["Distillati", "Alcolici", "Bevande spiritose"],
            Vegetarianesimo: [
              "Alimentazione vegetariana",
              "Dieta vegetariana",
              "Scelta vegetariana",
            ],
            "Distribuzione automatica": [
              "Vending",
              "Vendita automatizzata",
              "Distributori automatici",
            ],
            "Cucina e gastronomia": [
              "Arte culinaria",
              "Gastronomia",
              "Tradizione culinaria",
            ],
            Alimentazione: ["Nutrizione", "Dieta", "Regime alimentare"],
            "Vini ed Enologia": [
              "Vitivinicoltura",
              "Cultura del vino",
              "Settore enologico",
            ],
            Agroalimentare: [
              "Settore agroalimentare",
              "Filiera agroalimentare",
            ],
            "Politica agraria": ["Politiche agricole", "Governance agricola"],
            "Zootecnica e Allevamento": [
              "Allevamento animale",
              "Produzione zootecnica",
              "Scienze zootecniche",
            ],
            "Agricoltura biologica": [
              "Coltivazione biologica",
              "Agricoltura eco-sostenibile",
              "Agricoltura organica",
            ],
            Viticoltura: ["Coltivazione della vite", "Produzione vitivinicola"],
            Agricoltura: [
              "Coltivazione",
              "Attività agricola",
              "Produzione agricola",
            ],
            Foreste: ["Bosco", "Aree forestali", "Patrimonio forestale"],
            Veterinaria: ["Medicina veterinaria", "Scienze veterinarie"],

            "Ingegneria informatica": [
              "Informatica ingegneristica",
              "Ingegneria del software e dei sistemi",
            ],
            "Giochi e videogame": ["Videogiochi", "Gaming"],
            "Computer grafica 3D": ["Grafica tridimensionale", "CG 3D"],
            "Hardware informatico": [
              "Componenti hardware",
              "Dispositivi informatici",
            ],
            "Home entertainment per PC": [
              "Intrattenimento digitale per PC",
              "Multimedia per computer",
            ],
            "Editoria elettronica": [
              "Editoria digitale",
              "Pubblicazione digitale",
            ],
            "App, smartphone, Android, iOS": [
              "Applicazioni mobili",
              "Mobile app",
              "Ecosistema mobile",
            ],
            Software: ["Programmi", "Applicativi"],
            "Sicurezza dei sistemi": [
              "Sicurezza informatica",
              "Protezione dei sistemi",
            ],
            "Reti informatiche": [
              "Network informatici",
              "Infrastrutture di rete",
            ],
            "Sicurezza delle informazioni": [
              "Protezione dei dati",
              "Information security",
            ],
            "Web design": ["Design web", "Progettazione grafica web"],
            "Progettazione siti web": [
              "Sviluppo web",
              "Realizzazione siti web",
            ],
            Multimedialità: ["Contenuti multimediali", "Media digitali"],
            "Web e Social Network": [
              "Web e social media",
              "Piattaforme online",
            ],
            "Information Technology": [
              "Tecnologia dell’informazione",
              "IT",
              "Tecnologie informatiche",
            ],

            "Arte Contemporanea": [
              "Arte moderna (uso comune, non accademico)",
              "Produzione artistica contemporanea",
            ],
            "Libri per bambini": [
              "Letteratura per l’infanzia",
              "Libri per ragazzi",
            ],
            Narrativa: ["Prosa", "Narrativa di finzione"],
            Letteratura: ["Produzione letteraria", "Opere letterarie"],
            "Arti Grafiche": ["Grafica", "Arti visive applicate"],
            Poesia: ["Produzione poetica", "Versi"],
            Filosofia: ["Pensiero filosofico", "Speculazione filosofica"],
            Arte: ["Espressione artistica", "Arti visive"],
            "Libri e editoria": ["Editoria", "Pubblicazioni"],
            Mostre: ["Esposizioni", "Rassegne"],
            "Mercato d'arte e aste": ["Compravendita d’arte", "Aste d’arte"],
            Storia: ["Scienze storiche", "Ricerca storica"],
            Geografia: ["Scienze geografiche", "Studio del territorio"],
            Cultura: ["Patrimonio culturale", "Attività culturali"],
            Antiquariato: ["Mercato antiquario", "Beni antichi"],
            Archeologia: ["Ricerca archeologica", "Scavi archeologici"],
            Disegno: ["Arte del disegno", "Disegno artistico"],
            Pittura: ["Arte pittorica", "Pittura artistica"],
            Scultura: ["Arte scultorea", "Scultura artistica"],
            Restauro: ["Conservazione", "Recupero artistico"],
            "Musei e beni culturali": [
              "Patrimonio museale",
              "Beni storico-culturali",
            ],
          };

          const synonymsByFilter =
            config.synonymsByFilter || defaultSynonymsByFilter;

          this.autocompleteTerms = new Set();

          for (const [filter, syns] of Object.entries(synonymsByFilter)) {
            for (const syn of syns) {
              const key = (syn || "").trim().toLowerCase();
              if (!key) continue;
              if (!this.keywordToFiltersMap[key]) {
                this.keywordToFiltersMap[key] = [filter];
              } else if (!this.keywordToFiltersMap[key].includes(filter)) {
                this.keywordToFiltersMap[key].push(filter);
              }
              this.autocompleteTerms.add(key);
            }
          }
          this.init();
        }

        updateReservedSpace() {
          if (!this.container) return;

          this.container.style.marginBottom = this.baseContainerMarginBottom
            ? `${this.baseContainerMarginBottom}px`
            : "";
        }

        updateReservedSpaceSoon() {
          if (this._reserveRaf) {
            cancelAnimationFrame(this._reserveRaf);
          }
          this._reserveRaf = requestAnimationFrame(() => {
            this._reserveRaf = null;
            this.updateReservedSpace();
          });
        }

        init() {
          this.renderList();
          this.bindEvents();
          this.updateClearVisibility();

          if (this.baseInputWrapperHeight == null) {
            this.baseInputWrapperHeight = this.inputWrapper?.offsetHeight || 0;
          }
        }

        bindEvents() {
          this.inputWrapper.addEventListener("click", () => {
            if (this.input?.disabled) return;
            if (this.ignoreWrapperClick) {
              this.ignoreWrapperClick = false;
              return;
            }
            this.input.focus();
            this.toggle();
          });

          if (this.label) {
            this.label.addEventListener("click", (e) => {
              if (this.input?.disabled) return;
              e.preventDefault();
              e.stopPropagation();
              this.ignoreWrapperClick = true;
              setTimeout(() => {
                this.ignoreWrapperClick = false;
              }, 0);

              if (this.isOpen) {
                this.close();
              } else {
                this.open();
                this.input.focus();
              }
            });
          }

          this.input.addEventListener("input", (e) => {
            this.filterOptions(e.target.value);
            this.updateAutocompleteHint(e.target.value);
            if (!this.isOpen) {
              this.open();
            }
            this.selectedIndex = -1;
          });

          this.input.addEventListener("keydown", (e) => {
            this.handleKeyboard(e);
          });

          if (this.clear) {
            this.clear.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              this.resetSelection();
            });
          }

          this.onDocumentKeyDown = (e) => {
            if (e.key === "Escape" && this.isOpen) {
              e.preventDefault();
              e.stopPropagation();
              this.close();
            }
          };

          document.addEventListener("keydown", this.onDocumentKeyDown, true);

          if (this.closeLink) {
            this.closeLink.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              this.close();
            });
          }
        }

        filterOptions(query) {
          const q = (query || "").trim().toLowerCase();
          const includeSet = new Set();
          const strongSet = new Set();
          const rank = new Map();

          if (
            this.suppressedAutocompleteQuery &&
            this.suppressedAutocompleteQuery !== q
          ) {
            this.suppressedAutocompleteQuery = null;
            this.suppressedAutocompleteTerms.clear();
          }

          if (q.length < this.minFilterChars) {
            this.filteredOptions = [...this.originalOptions];
            this.strongMatchOptions = new Set();
            this.matchRank = new Map();
            this.renderList();
            return;
          }

          if (!q) {
            this.filteredOptions = [...this.originalOptions];
            this.strongMatchOptions = new Set();
            this.matchRank = new Map();
            this.renderList();
            return;
          }

          for (const option of this.originalOptions) {
            const optionLower = option.toLowerCase();
            const tokens = optionLower.split(/\s+/).filter(Boolean);
            const strongMatch = tokens.some((t) => t.startsWith(q));

            if (strongMatch) {
              includeSet.add(option);
              strongSet.add(option);
              rank.set(option, 0);
            }
          }

          if (q.length >= 3) {
            for (const term of this.autocompleteTerms || []) {
              if (
                this.suppressedAutocompleteQuery === q &&
                this.suppressedAutocompleteTerms.has(term)
              ) {
                continue;
              }
              const words = String(term).split(/\s+/).filter(Boolean);
              if (words.some((w) => w.startsWith(q))) {
                const mapped = this.keywordToFiltersMap[term] || [];
                for (const filter of mapped) {
                  includeSet.add(filter);
                  strongSet.add(filter);
                  if (!rank.has(filter)) {
                    rank.set(filter, 1);
                  }
                }
              }
            }
          }

          this.filteredOptions = this.originalOptions.filter((opt) =>
            includeSet.has(opt),
          );
          this.strongMatchOptions = strongSet;
          this.matchRank = rank;
          this.renderList();
        }

        getAutocompleteSuggestion(query) {
          const q = (query || "").trim().toLowerCase();
          if (!q) return null;

          // 1) mapping esplicito
          const mapped = this.autocompleteMap[q];
          if (mapped) {
            const suffix = mapped.slice(q.length);
            if (!suffix) return null;
            return { full: mapped, suffix };
          }

          // 2) completamento a prefisso sui termini (sinonimi)
          if (q.length < 3) return null;

          const candidates = [];
          for (const term of this.autocompleteTerms || []) {
            if (term.startsWith(q) && term.length > q.length) {
              candidates.push(term);
            }
          }
          if (candidates.length === 0) return null;

          candidates.sort(
            (a, b) => a.length - b.length || a.localeCompare(b, "it"),
          );
          const full = candidates[0];
          const suffix = full.slice(q.length);
          if (!suffix) return null;
          return { full, suffix };
        }

        measureTextWidth(text, element) {
          const canvas =
            this._measureCanvas ||
            (this._measureCanvas = document.createElement("canvas"));
          const ctx = canvas.getContext("2d");
          if (!ctx) return 0;

          const cs = window.getComputedStyle(element);
          ctx.font = `${cs.fontStyle} ${cs.fontVariant} ${cs.fontWeight} ${cs.fontSize} ${cs.fontFamily}`;
          const metrics = ctx.measureText(text);
          let width = metrics.width || 0;

          const letterSpacing = parseFloat(cs.letterSpacing || "0");
          if (
            !Number.isNaN(letterSpacing) &&
            letterSpacing != 0 &&
            text.length > 1
          ) {
            width += (text.length - 1) * letterSpacing;
          }
          return width;
        }

        updateAutocompleteHint(query) {
          const suggestion = this.getAutocompleteSuggestion(query);
          const caretAtEnd =
            this.input.selectionStart === this.input.value.length &&
            this.input.selectionEnd === this.input.value.length;

          const q = (query || "").trim().toLowerCase();
          if (
            suggestion &&
            this.suppressedAutocompleteQuery === q &&
            this.suppressedAutocompleteTerms.has(suggestion.full)
          ) {
            this.autocompleteSuffix.textContent = "";
            this.autocompleteTip.textContent = "";
            this.autocompleteInline.classList.remove("show");
            return;
          }

          if (!this.isOpen || !suggestion || !caretAtEnd) {
            this.autocompleteSuffix.textContent = "";
            this.autocompleteTip.textContent = "";
            this.autocompleteInline.classList.remove("show");
            return;
          }

          this.autocompleteSuffix.textContent = suggestion.suffix;
          this.autocompleteTip.textContent = "";

          const left =
            this.input.offsetLeft +
            this.measureTextWidth(this.input.value, this.input);
          const cs = window.getComputedStyle(this.input);
          const paddingTop = parseFloat(cs.paddingTop || "0") || 0;
          const fontSize = parseFloat(cs.fontSize || "16") || 16;
          const lineHeight =
            cs.lineHeight === "normal"
              ? fontSize * 1.2
              : parseFloat(cs.lineHeight || `${fontSize * 1.2}`) ||
                fontSize * 1.2;
          const lineOffset = Math.max(0, (lineHeight - fontSize) / 2);
          const top = this.input.offsetTop + paddingTop + lineOffset - 2.75;
          this.autocompleteInline.style.left = `${left}px`;
          this.autocompleteInline.style.top = `${top}px`;
          this.autocompleteInline.classList.add("show");
        }

        renderList() {
          this.results.innerHTML = "";
          this.suggestions.innerHTML = "";

          const query = this.input.value.trim();
          const q = query.toLowerCase();
          const isFiltered = q.length >= this.minFilterChars;

          if (!isFiltered) {
            this.expandedParents?.clear();
          }

          const suggestionsSet = new Set();
          const filteredSet = new Set(this.filteredOptions);
          const showSuggestions = q.length >= this.minFilterChars;

          if (showSuggestions) {
            const kwSuggestions = this.keywordToFiltersMap[q] || [];
            for (const opt of kwSuggestions) {
              if (opt && !filteredSet.has(opt)) {
                suggestionsSet.add(opt);
              }
            }

            const strongOrSelected = new Set([
              ...Array.from(this.selectedValues),
              ...Array.from(this.strongMatchOptions || []),
            ]);

            for (const opt of strongOrSelected) {
              const related = this.relatedMap[opt];
              if (related && !filteredSet.has(related)) {
                suggestionsSet.add(related);
              }
            }
          }

          const suggestions = Array.from(suggestionsSet)
            .filter(
              (opt) =>
                this.originalOptions.includes(opt) && !filteredSet.has(opt),
            )
            .sort((a, b) => this.sortComparator(a, b));

          const matched = [...this.filteredOptions].sort((a, b) => {
            const ra = this.matchRank?.get(a) ?? 99;
            const rb = this.matchRank?.get(b) ?? 99;
            return ra - rb || this.sortComparator(a, b);
          });

          const visible = [...matched, ...suggestions];
          const childrenByParentVisible = new Map();
          for (const opt of visible) {
            const parent = this.optionToParent[opt];
            if (!parent) continue;
            if (!childrenByParentVisible.has(parent)) {
              childrenByParentVisible.set(parent, []);
            }
            childrenByParentVisible.get(parent).push(opt);
          }

          const parentsWithChildren = Array.from(childrenByParentVisible.keys())
            .filter((p) => (childrenByParentVisible.get(p) || []).length > 0)
            .sort((p1, p2) => {
              if (this.preserveParentOrder) {
                const idx1 = (this.parents || []).indexOf(p1);
                const idx2 = (this.parents || []).indexOf(p2);
                const a = idx1 === -1 ? Number.POSITIVE_INFINITY : idx1;
                const b = idx2 === -1 ? Number.POSITIVE_INFINITY : idx2;
                return a - b;
              }

              const c1 = childrenByParentVisible.get(p1) || [];
              const c2 = childrenByParentVisible.get(p2) || [];
              const best1 = c1.reduce(
                (acc, x) => Math.min(acc, this.matchRank?.get(x) ?? 99),
                99,
              );
              const best2 = c2.reduce(
                (acc, x) => Math.min(acc, this.matchRank?.get(x) ?? 99),
                99,
              );
              return (
                best1 - best2 ||
                p1.localeCompare(p2, "it", { sensitivity: "base" })
              );
            });

          this.visibleOptions = [];

          if ((this.parents || []).length === 0) {
            if (visible.length === 0) {
              const empty = document.createElement("div");
              empty.className = "no-results";
              empty.textContent = "Nessun risultato";
              this.results.appendChild(empty);
              if (this.isOpen) {
                this.updateReservedSpace();
              }
              return;
            }

            this.visibleOptions = visible;
            this.visibleOptions.forEach((option, index) => {
              const item = document.createElement("div");
              item.className = "dropdown-item child-item";
              item.dataset.index = String(index);

              const checkbox = document.createElement("input");
              const label = document.createElement("span");
              if (this.enableHighlight && query) {
                label.innerHTML = highlightHtml(option, query);
              } else {
                label.textContent = option;
              }

              if (this.selectedValues.has(option)) {
                item.classList.add("selected");
              }

              if (this.renderCheckboxes) {
                checkbox.type = "checkbox";
                checkbox.className = "dropdown-checkbox";
                checkbox.checked = this.selectedValues.has(option);
                checkbox.addEventListener("click", (e) => {
                  e.stopPropagation();
                });
                checkbox.addEventListener("change", (e) => {
                  e.stopPropagation();
                  this.toggleOption(option);
                });
                item.appendChild(checkbox);
              }
              item.addEventListener("click", (e) => {
                e.stopPropagation();
                this.toggleOption(option);
              });
              item.appendChild(label);
              this.results.appendChild(item);
            });

            if (this.isOpen) {
              this.updateReservedSpace();
            }
            return;
          }

          if (parentsWithChildren.length === 0) {
            const empty = document.createElement("div");
            empty.className = "no-results";
            empty.textContent = "Nessun risultato";
            this.results.appendChild(empty);
            if (this.isOpen) {
              this.updateReservedSpace();
            }
            return;
          }

          for (const p of parentsWithChildren) {
            const group = document.createElement("div");
            group.className = "dropdown-group";

            const groupLabel = document.createElement("span");
            groupLabel.textContent = p;
            group.appendChild(groupLabel);

            const visibleChildrenForParent =
              childrenByParentVisible.get(p) || [];
            const allChildrenForParent = this.childrenByParent?.[p] || [];
            const canExpand =
              isFiltered &&
              allChildrenForParent.length > visibleChildrenForParent.length;
            const shouldShowExpandToggle =
              isFiltered && (canExpand || this.expandedParents.has(p));

            if (shouldShowExpandToggle) {
              const showAllLink = document.createElement("a");
              showAllLink.href = "#";
              showAllLink.className = "close-dropdown-link";
              showAllLink.textContent = this.expandedParents.has(p)
                ? "mostra meno"
                : "mostra tutti";
              showAllLink.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (this.expandedParents.has(p)) {
                  this.expandedParents.delete(p);
                } else {
                  this.expandedParents.add(p);
                }
                this.renderList();
                this.input.focus();
              });
              group.appendChild(showAllLink);
            }

            this.results.appendChild(group);

            const visibleChildren = (childrenByParentVisible.get(p) || []).sort(
              (a, b) => this.sortComparator(a, b),
            );

            let childrenToRender = visibleChildren;
            if (isFiltered && this.expandedParents.has(p)) {
              const allChildren = [...(this.childrenByParent?.[p] || [])].sort(
                (a, b) => this.sortComparator(a, b),
              );
              const inVisible = new Set(visibleChildren);
              const extra = allChildren.filter((c) => !inVisible.has(c));
              childrenToRender = [...visibleChildren, ...extra];
            }

            childrenToRender.forEach((option) => {
              const index = this.visibleOptions.length;
              this.visibleOptions.push(option);

              const item = document.createElement("div");
              item.className = "dropdown-item child-item";
              item.dataset.index = String(index);

              const checkbox = document.createElement("input");
              const label = document.createElement("span");
              if (this.enableHighlight && query) {
                label.innerHTML = highlightHtml(option, query);
              } else {
                label.textContent = option;
              }

              if (this.selectedValues.has(option)) {
                item.classList.add("selected");
              }

              if (this.renderCheckboxes) {
                checkbox.type = "checkbox";
                checkbox.className = "dropdown-checkbox";
                checkbox.checked = this.selectedValues.has(option);
                checkbox.addEventListener("click", (e) => {
                  e.stopPropagation();
                });
                checkbox.addEventListener("change", (e) => {
                  e.stopPropagation();
                  this.toggleOption(option);
                });
                item.appendChild(checkbox);
              }
              item.addEventListener("click", (e) => {
                e.stopPropagation();
                this.toggleOption(option);
              });
              item.appendChild(label);
              this.results.appendChild(item);
            });
          }
          if (this.isOpen) {
            this.updateReservedSpace();
          }
        }

        handleKeyboard(e) {
          if (e.key === "Tab") {
            const suggestion = this.getAutocompleteSuggestion(this.input.value);
            if (suggestion) {
              e.preventDefault();
              this.input.value = suggestion.full;
              this.filterOptions(this.input.value);
              this.updateAutocompleteHint(this.input.value);
              if (!this.isOpen) {
                this.open();
              }
              this.selectedIndex = -1;
              return;
            }
          }

          if (
            e.key === "Backspace" &&
            this.input.value === "" &&
            this.selectedValues.size > 0
          ) {
            e.preventDefault();
            const last = Array.from(this.selectedValues).pop();
            if (last) {
              this.selectedValues.delete(last);
              this.renderChips();
              this.renderList();
              this.updateClearVisibility();
              if (typeof this.onSelectionChange === "function") {
                this.onSelectionChange(Array.from(this.selectedValues));
              }
            }
            return;
          }

          if (!this.isOpen && (e.key === "ArrowDown" || e.key === "ArrowUp")) {
            e.preventDefault();
            this.open();
            return;
          }

          if (!this.isOpen) return;
          const totalItems = (this.visibleOptions || []).length;

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              this.selectedIndex = Math.min(
                this.selectedIndex + 1,
                totalItems - 1,
              );
              break;
            case "ArrowUp":
              e.preventDefault();
              this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
              break;
            case "Enter":
              e.preventDefault();

              // Se l'utente preme Enter senza aver selezionato un item,
              // non accettare l'autocomplete (ghost) e sopprimi i suggerimenti derivati.
              if (this.selectedIndex < 0) {
                const typed = (this.input.value || "").trim();
                const suggestion = this.getAutocompleteSuggestion(typed);

                if (suggestion) {
                  this.suppressedAutocompleteQuery = typed.toLowerCase();
                  this.suppressedAutocompleteTerms = new Set([suggestion.full]);

                  const mapped =
                    this.keywordToFiltersMap?.[suggestion.full] || [];
                  let changed = false;
                  for (const opt of mapped) {
                    if (this.selectedValues.has(opt)) {
                      this.selectedValues.delete(opt);
                      changed = true;
                    }
                  }

                  if (changed) {
                    this.renderChips();
                    this.updateClearVisibility();
                    if (typeof this.onSelectionChange === "function") {
                      this.onSelectionChange(Array.from(this.selectedValues));
                    }
                  }
                }

                // Nascondi il ghost text senza cambiare il valore digitato.
                this.autocompleteSuffix.textContent = "";
                this.autocompleteTip.textContent = "";
                this.autocompleteInline.classList.remove("show");

                // Ricalcola la lista tenendo conto della soppressione.
                this.filterOptions(this.input.value);
                this.updateAutocompleteHint(this.input.value);
                this.selectedIndex = -1;
                return;
              }

              if (this.selectedIndex >= 0) {
                const option = (this.visibleOptions || [])[this.selectedIndex];
                if (option) {
                  this.toggleOption(option);
                }
              }
              break;
            case "Escape":
              e.preventDefault();
              this.close();
              break;
          }
        }

        toggleOption(option) {
          const alreadySelected = this.selectedValues.has(option);

          if (this.singleSelect) {
            this.selectedValues.clear();
            if (!alreadySelected) {
              this.selectedValues.add(option);
            }
          } else {
            if (alreadySelected) {
              this.selectedValues.delete(option);
            } else {
              this.selectedValues.add(option);
            }
          }

          if (this.writeSelectedToInput && this.input) {
            if (this.selectedValues.size === 1) {
              this.input.value = Array.from(this.selectedValues)[0] || "";
            } else {
              this.input.value = "";
            }
          }

          this.renderChips();
          this.renderList();
          this.updateClearVisibility();
          if (typeof this.onSelectionChange === "function") {
            this.onSelectionChange(Array.from(this.selectedValues));
          }

          if (this.closeOnSelect && this.singleSelect) {
            this.close();
          }
        }

        setOptions(options = []) {
          this.originalOptions = Array.isArray(options) ? options : [];
          this.filteredOptions = [...this.originalOptions];
          this.visibleOptions = [...this.originalOptions];
          this.matchRank = new Map();
          this.strongMatchOptions = new Set();
          this.expandedParents?.clear();
          this.resetSelection();
          this.renderList();
        }

        removeOption(option) {
          if (!this.selectedValues.has(option)) return;
          this.selectedValues.delete(option);
          this.renderChips();
          this.renderList();
          this.updateClearVisibility();
          if (typeof this.onSelectionChange === "function") {
            this.onSelectionChange(Array.from(this.selectedValues));
          }
        }

        renderChips() {
          if (!this.chipContainer) return;
          if (!this.renderChipsInInput) {
            this.chipContainer.innerHTML = "";
            return;
          }

          this.chipContainer.innerHTML = "";
          for (const value of Array.from(this.selectedValues)) {
            const chip = document.createElement("span");
            chip.className = "chip";

            const text = document.createElement("span");
            text.textContent = value;

            const remove = document.createElement("button");
            remove.type = "button";
            remove.className = "chip-remove";
            remove.textContent = "×";
            remove.addEventListener("click", (e) => {
              e.stopPropagation();
              this.selectedValues.delete(value);
              this.renderChips();
              this.renderList();
              this.updateClearVisibility();
              if (typeof this.onSelectionChange === "function") {
                this.onSelectionChange(Array.from(this.selectedValues));
              }
            });

            chip.appendChild(text);
            chip.appendChild(remove);
            this.chipContainer.appendChild(chip);
          }
        }

        resetSelection() {
          this.selectedValues.clear();
          this.input.value = "";
          this.filterOptions("");
          this.updateAutocompleteHint("");
          this.renderChips();
          this.updateClearVisibility();
          if (typeof this.onSelectionChange === "function") {
            this.onSelectionChange(Array.from(this.selectedValues));
          }
        }

        updateClearVisibility() {
          if (this.selectedValues.size > 0) {
            if (this.clear) this.clear.classList.add("show");
          } else {
            if (this.clear) this.clear.classList.remove("show");
          }
          if (this.arrow) {
            this.arrow.style.display = "block";
            this.arrow.style.right = "12px";
          }
        }

        open() {
          for (const inst of FilterableDropdown._instances || []) {
            if (inst !== this && inst?.isOpen) {
              inst.close();
            }
          }

          this.isOpen = true;
          this.updateAutocompleteHint(this.input.value);
          this.selectedIndex = -1;

          this.list.classList.add("show");
          this.arrow.classList.add("rotated");
          this.inputWrapper.style.borderRadius =
            "var(--border-radius-xs) var(--border-radius-xs) 0 0";
          // Force style/layout flush so the margin-bottom transition starts in sync
          // with the dropdown-list transition.
          this.list.getBoundingClientRect();
          this.updateReservedSpace();
        }

        close() {
          this.isOpen = false;
          this.list.classList.remove("show");
          this.arrow.classList.remove("rotated");
          this.inputWrapper.style.borderRadius = "var(--border-radius-xs)";
          this.selectedIndex = -1;
          this.updateAutocompleteHint("");
          this.updateReservedSpace();
        }

        toggle() {
          if (this.isOpen) {
            this.close();
          } else {
            this.open();
          }
        }
      }

      const SERVICES_BY_PARENT = {
        "ALIMENTARI E BEVANDE": [
          "Birra",
          "Tè e Caffè",
          "Dolciumi",
          "Igiene alimentare",
          "Industria alimentare",
          "Latte e latticini",
          "Alimenti biologici",
          "Bevande",
          "Liquori",
          "Vegetarianesimo",
          "Distribuzione automatica",
          "Cucina e gastronomia",
          "Alimentazione",
          "Vini ed Enologia",
        ],
        AGRICOLTURA: [
          "Agroalimentare",
          "Politica agraria",
          "Zootecnica e Allevamento",
          "Agricoltura biologica",
          "Viticoltura",
          "Agricoltura",
          "Foreste",
          "Veterinaria",
        ],
        "INFORMATICA E WEB": [
          "Ingegneria informatica",
          "Giochi e videogame",
          "Computer grafica 3D",
          "Hardware informatico",
          "Home entertainment per PC",
          "Editoria elettronica",
          "App, smartphone, Android, iOS",
          "Software",
          "Sicurezza dei sistemi",
          "Reti informatiche",
          "Sicurezza delle informazioni",
          "Web design",
          "Progettazione siti web",
          "Multimedialità",
          "Web e Social Network",
          "Information Technology",
        ],
        "ARTE E CULTURA": [
          "Arte Contemporanea",
          "Libri per bambini",
          "Narrativa",
          "Letteratura",
          "Arti Grafiche",
          "Poesia",
          "Filosofia",
          "Arte",
          "Libri e editoria",
          "Mostre",
          "Mercato d'arte e aste",
          "Storia",
          "Geografia",
          "Cultura",
          "Antiquariato",
          "Archeologia",
          "Disegno",
          "Pittura",
          "Scultura",
          "Restauro",
          "Musei e beni culturali",
        ],
      };

      const sampleOptions = Object.values(SERVICES_BY_PARENT)
        .flat()
        .sort((a, b) => a.localeCompare(b, "it", { sensitivity: "base" }));

      const dropdown = new FilterableDropdown("dropdownInput", sampleOptions, {
        inputWrapperId: "dropdownInputWrapper",
        chipContainerId: "chipContainer",
        autocompleteInlineId: "autocompleteInline",
        autocompleteSuffixId: "autocompleteSuffix",
        autocompleteTipId: "autocompleteTip",
        arrowId: "dropdownArrow",
        clearId: "dropdownClearLink",
        listId: "dropdownList",
        closeLinkId: "closeDropdownLink",
        suggestionsId: "dropdownSuggestions",
        resultsId: "dropdownResults",
        parents: [
          "ALIMENTARI E BEVANDE",
          "AGRICOLTURA",
          "INFORMATICA E WEB",
          "ARTE E CULTURA",
        ],
        childrenByParent: SERVICES_BY_PARENT,
        renderChipsInInput: false,
      });
      dropdown.updateAutocompleteHint("");

      const ROLES_BY_PARENT = {
        DIREZIONE: [
          "Direttore responsabile",
          "Direttore editoriale",
          "Condirettore",
          "Vicedirettore",
        ],
        "COORDINAMENTO REDAZIONALE": [
          "Responsabile redazione",
          "Vice responsabile di redazione",
          "Capo redattore centrale",
          "Vice capo redattore centrale",
          "Capo redattore",
          "Vice capo redattore",
          "Capo servizio",
          "Vice capo servizio",
          "Responsabile servizi speciali",
          "Capo area",
          "Capocronista",
        ],
        REDAZIONE: [
          "Redattore",
          "Inviato",
          "Corrispondente",
          "Editorialista",
          "Web Editor",
        ],
        "CONTRIBUTORI / AUTORI ESTERNI": [
          "Collaboratore",
          "Autore",
          "Blogger",
          "Curatore",
        ],
        "PRODUZIONE & SUPPORTO": [
          "Produttore esecutivo",
          "Art director",
          "Consulente editoriale",
          "Responsabile segreteria redazione",
          "Segreteria redazione",
          "Segreteria direzione",
          "Assistente",
          "Praticante",
        ],
      };

      const ROLE_RANK = (() => {
        const rank = new Map();
        let i = 0;
        for (const parent of Object.keys(ROLES_BY_PARENT || {})) {
          for (const role of ROLES_BY_PARENT[parent] || []) {
            const k = String(role || "")
              .trim()
              .toLowerCase();
            if (!k) continue;
            if (!rank.has(k)) {
              rank.set(k, i);
              i++;
            }
          }
        }
        return rank;
      })();

      function getRoleRank(role) {
        const k = String(role || "")
          .trim()
          .toLowerCase();
        if (!k) return Number.POSITIVE_INFINITY;
        return ROLE_RANK.has(k) ? ROLE_RANK.get(k) : Number.POSITIVE_INFINITY;
      }

      function compareJournalistsByName(a, b) {
        const ca = String(a?.cognome || "").trim();
        const cb = String(b?.cognome || "").trim();
        const na = String(a?.nome || "").trim();
        const nb = String(b?.nome || "").trim();
        return (
          ca.localeCompare(cb, "it", { sensitivity: "base" }) ||
          na.localeCompare(nb, "it", { sensitivity: "base" })
        );
      }

      function compareTestateByName(a, b) {
        const na = String(a?.nome || "").trim();
        const nb = String(b?.nome || "").trim();
        return na.localeCompare(nb, "it", { sensitivity: "base" });
      }

      const roleOptions = Object.values(ROLES_BY_PARENT)
        .flat()
        .sort((a, b) => a.localeCompare(b, "it", { sensitivity: "base" }));

      const roleDropdown = new FilterableDropdown(
        "roleDropdownInput",
        roleOptions,
        {
          inputWrapperId: "roleDropdownInputWrapper",
          chipContainerId: "roleChipContainer",
          autocompleteInlineId: "roleAutocompleteInline",
          autocompleteSuffixId: "roleAutocompleteSuffix",
          autocompleteTipId: "roleAutocompleteTip",
          arrowId: "roleDropdownArrow",
          clearId: "roleDropdownClearLink",
          listId: "roleDropdownList",
          closeLinkId: "roleCloseDropdownLink",
          suggestionsId: "roleDropdownSuggestions",
          resultsId: "roleDropdownResults",
          parents: [
            "DIREZIONE",
            "COORDINAMENTO REDAZIONALE",
            "REDAZIONE",
            "CONTRIBUTORI / AUTORI ESTERNI",
            "PRODUZIONE & SUPPORTO",
          ],
          childrenByParent: ROLES_BY_PARENT,
          synonymsByFilter: {},
          renderChipsInInput: false,
          preserveParentOrder: true,
        },
      );
      roleDropdown.updateAutocompleteHint("");

      const journalists = [
        {
          nome: "Luca",
          cognome: "Rinaldi",
          ruolo: "Capo redattore",
          servizio: "Politica agraria",
          telefono: "+39 333 120 4451",
          email: "l.rinaldi@ilgiorno.it",
          testate: ["Il Giorno", "ANSA"],
          testata: "Il Giorno",
          note: "Segue ministeri e politiche del territorio. Tiene i contatti con associazioni e consorzi, copre dossier su PAC, fondi e misure di sostegno; monitora anche crisi di settore e tavoli tecnici con aggiornamenti frequenti.",
        },
        {
          nome: "Sara",
          cognome: "Ferri",
          ruolo: "Redattrice",
          servizio: "Web e Social Network",
          telefono: "+39 347 558 1092",
          email: "s.ferri@lastampa.it",
          testata: "La Stampa",
          note: "Focus su piattaforme e community online.",
        },
        {
          nome: "Marco",
          cognome: "De Santis",
          ruolo: "Inviato",
          servizio: "Agricoltura",
          telefono: "+39 329 440 7710",
          email: "m.desantis@repubblica.it",
          testata: "la Repubblica",
          note: "Reportage da fiere e aziende agricole.",
        },
        {
          nome: "Giulia",
          cognome: "Conti",
          ruolo: "Redattrice",
          servizio: "Libri e editoria",
          telefono: "+39 335 210 9033",
          email: "g.conti@corriere.it",
          testata: "Corriere della Sera",
          note: "Recensioni e interviste ad autori.",
        },
        {
          nome: "Paolo",
          cognome: "Marini",
          ruolo: "Redattore",
          servizio: "Software",
          telefono: "+39 338 770 1198",
          email: "p.marini@ilsole24ore.com",
          testata: "Il Sole 24 Ore",
          note: "Prodotti, aziende e trend del software.",
        },
        {
          nome: "Elena",
          cognome: "Bianchi",
          ruolo: "Collaboratrice",
          servizio: "Mostre",
          telefono: "+39 331 905 4472",
          email: "e.bianchi@ilfattoquotidiano.it",
          testata: "Il Fatto Quotidiano",
          note: "Agenda eventi e rassegne nazionali.",
        },
        {
          nome: "Davide",
          cognome: "Gallo",
          ruolo: "Redattore",
          servizio: "Hardware informatico",
          telefono: "+39 334 602 7715",
          email: "d.gallo@wired.it",
          testata: "Wired Italia",
          note: "Componenti, device e benchmark.",
        },
        {
          nome: "Francesca",
          cognome: "Romano",
          ruolo: "Redattrice",
          servizio: "Pittura",
          telefono: "+39 320 778 0451",
          email: "f.romano@artnews.it",
          testata: "Art News",
          note: "Artisti emergenti e critica.",
        },
        {
          nome: "Andrea",
          cognome: "Lombardi",
          ruolo: "Inviato",
          servizio: "Zootecnica e Allevamento",
          telefono: "+39 349 660 1308",
          email: "a.lombardi@avvenire.it",
          testata: "Avvenire",
          note: "Filiera animale e sostenibilità.",
        },
        {
          nome: "Chiara",
          cognome: "Greco",
          ruolo: "Redattrice",
          servizio: "Archeologia",
          telefono: "+39 339 114 2290",
          email: "c.greco@ansa.it",
          testata: "ANSA",
          note: "",
        },
        {
          nome: "Matteo",
          cognome: "Esposito",
          ruolo: "Redattore",
          servizio: "Information Technology",
          telefono: "+39 333 990 8172",
          email: "m.esposito@ilsole24ore.com",
          testata: "Il Sole 24 Ore",
          note: "Digitalizzazione e infrastrutture.",
        },
        {
          nome: "Valentina",
          cognome: "Costamagnadelgado",
          ruolo: "Collaboratrice",
          servizio: "Cultura",
          telefono: "+39 346 550 2011",
          email: "v.costa@ilgiornale.it",
          testata: "Il Giornale",
          note: "Rubrica settimanale.",
        },
        {
          nome: "Stefano",
          cognome: "Moretti",
          ruolo: "Redattore",
          servizio: "Reti informatiche",
          telefono: "+39 334 880 1120",
          email: "s.moretti@tomshw.it",
          testata: "Tom's Hardware",
          note: "Connettività e infrastrutture.",
        },
        {
          nome: "Marta María",
          cognome: "Romero Rodríguez de Mondelo",
          ruolo: "Redattrice",
          servizio: "Letteratura",
          telefono: "+39 333 470 9981",
          email: "a.demonelo@ilmanifesto.it",
          testata: "il manifesto",
          note: "Interviste e approfondimenti.",
        },
        {
          nome: "Riccardo",
          cognome: "Villa",
          ruolo: "Redattore",
          servizio: "Web design",
          telefono: "+39 339 771 6401",
          email: "r.villa@corriere.it",
          testata: "Corriere della Sera",
          note: "UX e tendenze.",
        },
        {
          nome: "Federica",
          cognome: "Serra",
          ruolo: "Inviata",
          servizio: "Vini ed Enologia",
          telefono: "+39 345 203 7788",
          email: "f.serra@gamberorosso.it",
          testata: "Gambero Rosso",
          note: "Degustazioni e cantine.",
        },
        {
          nome: "Alessio",
          cognome: "Orlando",
          ruolo: "Redattore",
          servizio: "Progettazione siti web",
          telefono: "+39 331 420 9090",
          email: "a.orlando@wired.it",
          testata: "Wired Italia",
          note: "Prodotti web e piattaforme.",
        },
        {
          nome: "Irene",
          cognome: "Pellegrini",
          ruolo: "Redattrice",
          servizio: "Musei e beni culturali",
          telefono: "+39 333 881 3002",
          email: "i.pellegrini@arte.it",
          testata: "Arte.it",
          note: "Patrimonio e governance museale.",
        },
        {
          nome: "Giorgio",
          cognome: "Fontana",
          ruolo: "Redattore",
          servizio: "Giochi e videogame",
          telefono: "+39 347 118 5512",
          email: "g.fontana@ilpost.it",
          testata: "Il Post",
          note: "Recensioni e anteprime.",
        },
        {
          nome: "Silvia",
          cognome: "Giordano",
          ruolo: "Collaboratrice",
          servizio: "Arte Contemporanea",
          telefono: "+39 320 100 7783",
          email: "s.giordano@exibart.com",
          testata: "Exibart",
          note: "Mostre e artisti contemporanei.",
        },
        {
          nome: "Pietro",
          cognome: "Neri",
          ruolo: "Redattore",
          servizio: "Computer grafica 3D",
          telefono: "+39 333 242 9901",
          email: "p.neri@everyeye.it",
          testata: "Everyeye",
          note: "Tool e pipeline 3D.",
        },
        {
          nome: "Laura",
          cognome: "Sanna",
          ruolo: "Redattrice",
          servizio: "Libri per bambini",
          telefono: "+39 346 222 1507",
          email: "l.sanna@sololibri.net",
          testata: "SoloLibri",
          note: "Sezione ragazzi.",
        },
        {
          nome: "Enrico",
          cognome: "Gatti",
          ruolo: "Redattore",
          servizio: "Sicurezza dei sistemi",
          telefono: "+39 339 605 1122",
          email: "e.gatti@dday.it",
          testata: "DDay",
          note: "Protezione di sistemi e endpoint.",
        },
        {
          nome: "Claudia",
          cognome: "Mancini",
          ruolo: "Redattrice",
          servizio: "Restauro",
          telefono: "+39 334 110 0099",
          email: "c.mancini@ilsole24ore.com",
          testata: "Il Sole 24 Ore",
          note: "Interventi e cantieri.",
        },
        {
          nome: "Nicola",
          cognome: "Leone",
          ruolo: "Inviato",
          servizio: "Veterinaria",
          telefono: "+39 331 700 4410",
          email: "n.leone@ansa.it",
          testata: "ANSA",
          note: "Sanità animale e ricerca.",
        },
        {
          nome: "Beatrice",
          cognome: "Martini",
          ruolo: "Redattrice",
          servizio: "Sicurezza delle informazioni",
          telefono: "+39 333 221 9876",
          email: "b.martini@wired.it",
          testata: "Wired Italia",
          note: "Threat intel e sicurezza per il pubblico generalista.",
        },
        {
          nome: "Edoardo",
          cognome: "Sala",
          ruolo: "Redattore",
          servizio: "Home entertainment per PC",
          telefono: "+39 334 410 9900",
          email: "e.sala@tomshw.it",
          testata: "Tom's Hardware",
          testate: [
            "Tom's Hardware",
            "Il Sole 24 Ore — Tecnologia, Imprese e Innovazione",
            "Corriere della Sera — Scienza, Tecnologia e Digitale",
            "La Repubblica — Economia, Startup e Innovazione Digitale",
            "Wired Italia — Cultura Digitale e Tecnologia",
            "DDay — Audio, Video, Hi‑Fi e Home Theater",
          ],
          note: "Multimedia e streaming.",
        },
        {
          nome: "Camilla",
          cognome: "Rossi",
          ruolo: "Redattrice",
          servizio: "Mercato d'arte e aste",
          telefono: "+39 335 702 1101",
          email: "c.rossi@artribune.com",
          testata: "Artribune",
          note: "Aste e trend di mercato.",
        },
        {
          nome: "Lorenzo",
          cognome: "Marchetti",
          ruolo: "Inviato",
          servizio: "Viticoltura",
          telefono: "+39 333 410 2030",
          email: "l.marchetti@gamberorosso.it",
          testata: "Gambero Rosso",
          note: "Vendemmia e territorio.",
        },
      ];

      function normalizeRole(value) {
        const v = (value || "").trim();
        const map = {
          Redattrice: "Redattore",
          Collaboratrice: "Collaboratore",
          Inviata: "Inviato",
          Caporedattore: "Capo redattore",
        };
        return map[v] || v;
      }

      for (const j of journalists) {
        j.ruolo = normalizeRole(j.ruolo);
      }

      const normalizeText = (v) => String(v ?? "").trim();

      const makeSecondPhone = (primary) => {
        const s = normalizeText(primary);
        if (!s) return "";
        const m = s.match(/^(.*?)(\d)(\D*)$/);
        if (!m) return `${s} 2`;
        const head = m[1] ?? "";
        const digit = m[2] ?? "0";
        const tail = m[3] ?? "";
        const next = (Number(digit) + 1) % 10;
        return `${head}${next}${tail}`;
      };

      const makeSecondEmail = (primary) => {
        const s = normalizeText(primary);
        if (!s || !s.includes("@")) return "";
        const [local, domain] = s.split("@");
        const baseLocal = String(local || "").trim();
        const baseDomain = String(domain || "").trim();
        if (!baseLocal || !baseDomain) return "";
        const suffix = baseLocal.includes("+") ? "ufficio" : "redazione";
        return `${baseLocal}+${suffix}@${baseDomain}`;
      };

      const ensureProgramContacts = (j) => {
        const legacyPhone = normalizeText(j?.telefono);
        const legacyEmail = normalizeText(j?.email);

        if (!Array.isArray(j.programPhones) || j.programPhones.length < 2) {
          const first = legacyPhone;
          let second = makeSecondPhone(first);
          if (!second || second === first) second = `${first} 2`;
          j.programPhones = [
            { number: first, type: "cellulare", isPrimary: true },
            { number: second, type: "cellulare ufficio", isPrimary: false },
          ].filter((x) => normalizeText(x?.number).length > 0);
        }

        if (!Array.isArray(j.programEmails) || j.programEmails.length < 2) {
          const first = legacyEmail;
          let second = makeSecondEmail(first);
          if (!second || second === first) second = `${first}`;
          j.programEmails = [
            { email: first, type: "mail diretta", isDefault: true },
            { email: second, type: "mail redazione", isDefault: false },
          ].filter((x) => normalizeText(x?.email).length > 0);
        }

        const isValidPreferred = (kind, pref) => {
          if (!pref || typeof pref !== "object") return false;
          const origin = String(pref.origin || "")
            .trim()
            .toLowerCase();
          const index = Number(pref.index);
          if (!Number.isFinite(index) || index < 0) return false;

          if (origin === "program") {
            const items = kind === "phone" ? j.programPhones : j.programEmails;
            return Array.isArray(items) && index < items.length;
          }

          if (origin === "custom") {
            const items = kind === "phone" ? j.customPhones : j.customEmails;
            return Array.isArray(items) && index < items.length;
          }

          return false;
        };

        if (!isValidPreferred("phone", j.preferredPhone)) {
          j.preferredPhone = { origin: "program", index: 0 };
        }
        if (!isValidPreferred("email", j.preferredEmail)) {
          j.preferredEmail = { origin: "program", index: 0 };
        }
      };

      for (const j of journalists) {
        ensureProgramContacts(j);
      }

      function normalizeTestataKey(value) {
        return String(value || "")
          .trim()
          .toLowerCase()
          .replace(/\s+/g, " ");
      }

      function inferTestataArgomento(nome) {
        const n = String(nome || "")
          .trim()
          .toLowerCase();

        if (n.includes("wired"))
          return "specializzata — tecnologia e cultura digitale";
        if (n.includes("sole 24")) return "specializzata — economia e diritto";
        if (n.includes("domus")) return "specializzata — architettura e design";
        if (n.includes("gambero")) return "specializzata — enogastronomia";
        if (n.includes("tom")) return "specializzata — tecnologia";
        if (n.includes("dday")) return "specializzata — tecnologia";
        if (n.includes("national geographic"))
          return "specializzata — scienza, natura e viaggi";
        if (
          n.includes("art ") ||
          n.startsWith("art") ||
          n.includes("arte") ||
          n.includes("artribune") ||
          n.includes("exibart") ||
          n.includes("interni")
        )
          return "specializzata — arte, cultura e design";
        if (n.includes("everyeye"))
          return "specializzata — videogame e intrattenimento";
        if (n.includes("cibo")) return "specializzata — food";
        if (n.includes("sololibri")) return "specializzata — libri";

        return "generalista";
      }

      function inferTestataArgomentoFromServiceCounts(counts) {
        if (!counts || typeof counts !== "object") {
          return { argomento: "Generalista", specializzata: false };
        }

        const entries = Object.entries(counts)
          .map(([k, v]) => [String(k || "").trim(), Number(v || 0)])
          .filter(([k, v]) => k && Number.isFinite(v) && v > 0);

        if (entries.length === 0) {
          return { argomento: "Generalista", specializzata: false };
        }

        entries.sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0], "it"));

        const total = entries.reduce((acc, x) => acc + x[1], 0);
        const top = entries[0];
        const topService = top[0];
        const topCount = top[1];
        const share = total > 0 ? topCount / total : 0;

        const specializzata =
          entries.length === 1 || (topCount >= 2 && share >= 0.6);

        return {
          argomento: specializzata ? topService : "Generalista",
          specializzata,
        };
      }

      function inferMediaType(nome) {
        const n = String(nome || "")
          .trim()
          .toLowerCase();

        const isRadio =
          n.includes("radio") ||
          n.includes("rds") ||
          n.includes("rtl") ||
          n.includes("radio 24") ||
          n.includes("deejay") ||
          n.includes("kiss kiss");

        if (isRadio) {
          return { parent: "Radio", child: "Trasmissioni Radio" };
        }

        const isTv =
          n.includes("tv") ||
          n.includes("rai") ||
          n.includes("mediaset") ||
          n.includes("sky") ||
          n.includes("tg") ||
          n.includes("canale");

        if (isTv) {
          return { parent: "TV", child: "Programmi TV" };
        }

        const isNewspaper =
          n.includes("corriere") ||
          n.includes("repubblica") ||
          n.includes("stampa") ||
          n.includes("giornale") ||
          n.includes("avvenire") ||
          n.includes("manifesto") ||
          n.includes("fatto") ||
          n.includes("il giorno");

        if (isNewspaper) {
          return { parent: "Carta Stampata", child: "Quotidiani" };
        }

        const isMagazine =
          n.includes("wired") ||
          n.includes("gambero") ||
          n.includes("national geographic") ||
          n.includes("interni") ||
          n.includes("domus") ||
          n.includes("art news");

        if (isMagazine) {
          return { parent: "Carta Stampata", child: "Periodici al Pubblico" };
        }

        const isBlog = n.includes("blog");
        if (isBlog) {
          return { parent: "Web", child: "Blog" };
        }

        return { parent: "Web", child: "On-Line / News" };
      }

      function inferPublicationFrequency(mediaType) {
        const parent = mediaType?.parent;
        const child = mediaType?.child;
        if (parent === "Carta Stampata" && child === "Quotidiani") {
          return "Quotidiano";
        }
        if (
          parent === "Carta Stampata" &&
          (child === "Periodici al Pubblico" ||
            child === "Periodici di Categoria" ||
            child === "Supplementi")
        ) {
          return "Mensile";
        }
        if (parent === "Radio") {
          return "Quotidiano";
        }
        if (parent === "TV") {
          return "Quotidiano";
        }
        if (parent === "Web") {
          return "Quotidiano";
        }
        return "Aperiodico";
      }

      function inferDiffusione(nome, mediaType) {
        const n = String(nome || "")
          .trim()
          .toLowerCase();
        if (n.includes("national geographic") || n.includes("wired")) {
          return "Internazionale";
        }
        if (mediaType?.parent === "Web") return "Nazionale";
        return "Locale";
      }

      function inferTiratura(mediaType) {
        if (
          mediaType?.parent === "Carta Stampata" &&
          mediaType?.child === "Quotidiani"
        ) {
          return "100k+";
        }

        if (mediaType?.parent === "Carta Stampata") {
          const child = String(mediaType?.child || "");
          if (
            child === "Periodici al Pubblico" ||
            child === "Periodici di Categoria" ||
            child === "Supplementi"
          ) {
            return "20k+";
          }
        }
        return "n/d";
      }

      function inferCircolazione(mediaType) {
        if (mediaType?.parent === "Web") return "online";
        if (mediaType?.parent === "Carta Stampata")
          return "edicola + abbonamenti";
        if (mediaType?.parent === "Radio") return "FM/DAB + streaming";
        if (mediaType?.parent === "TV") return "digitale terrestre/satellite";
        return "n/d";
      }

      function inferRedazioneIndirizzo(nome) {
        const n = String(nome || "")
          .trim()
          .toLowerCase();
        if (n.includes("milano")) return "Milano";
        if (n.includes("roma")) return "Roma";
        if (n.includes("torino")) return "Torino";
        return "Milano";
      }

      function inferRedazioneTel(nome) {
        const city = inferRedazioneIndirizzo(nome);
        if (city === "Roma") return "06 3423123";
        if (city === "Torino") return "011 3423123";
        return "02 3423123";
      }

      function buildTestateFromJournalists(list) {
        const byKey = new Map();

        for (const j of list || []) {
          const testateList = getJournalistTestate(j);
          if (!testateList.length) continue;

          for (const raw of testateList) {
            const key = normalizeTestataKey(raw);
            if (!key) continue;

            if (!byKey.has(key)) {
              const nome = raw || key;
              const mediaType = inferMediaType(nome);
              const city = inferRedazioneIndirizzo(nome);
              const journalistEmail = String(j?.email || "").trim();
              const domain = journalistEmail.includes("@")
                ? journalistEmail.split("@")[1]
                : "example.it";

              byKey.set(key, {
                id: key,
                nome,
                argomento: "Generalista",
                direttore: "Direttore responsabile",
                tipoMedia: mediaType,
                frequenzaPubblicazione: inferPublicationFrequency(mediaType),
                diffusione: inferDiffusione(nome, mediaType),
                tiratura: inferTiratura(mediaType),
                _serviceCounts: {},
                redazione: {
                  giornalisti: [],
                  indirizzo: `${city} — sede redazione`,
                  telRedazione: inferRedazioneTel(nome),
                },
                email: `redazione@${domain}`,
                telefono:
                  String(j?.telefono || "").trim() || "+39 02 0000 0000",
                note: "",
              });
            }

            const t = byKey.get(key);
            const jid = String(j?.email || "").trim();
            if (jid && !t.redazione.giornalisti.includes(jid)) {
              t.redazione.giornalisti.push(jid);
            }

            const servizio = String(j?.servizio || "").trim();
            if (servizio) {
              const sc = t._serviceCounts || (t._serviceCounts = {});
              sc[servizio] = (Number(sc[servizio] || 0) || 0) + 1;
            }
          }
        }

        const NOTES_BY_TESTATA_KEY = {
          "il sole 24 ore": [
            "Redazione con focus su economia, imprese e innovazione.",
            "Disponibile per interviste su dossier PA, infrastrutture e transizione digitale.",
          ],
          "corriere della sera":
            "Contatti preferiti via e-mail; segue speciali e inserti tematici su cultura e società.",
          ansa: [
            "Preferenza per comunicati sintetici e dati verificabili.",
            "Copertura nazionale con desk dedicati (cronaca, politica, economia, esteri).",
          ],
          "wired italia":
            "Taglio digitale: tecnologia, cultura, startup e impatto sociale.",
          "gambero rosso": [
            "Specializzata food & wine: degustazioni, guide e inchieste di filiera.",
            "Per eventi: inviare invito con almeno 10 giorni di anticipo.",
          ],
          "il post":
            "Predilige pitch brevi con contesto e link a fonti primarie.",
          "la repubblica":
            "Valuta proposte di approfondimento; attenzione a temi di attualità e territorio.",
        };

        for (const t of byKey.values()) {
          const inferred = inferTestataArgomentoFromServiceCounts(
            t._serviceCounts,
          );
          t.argomento = inferred.argomento;
          t.note = NOTES_BY_TESTATA_KEY[String(t?.id || "")] || "";
          delete t._serviceCounts;
        }

        return Array.from(byKey.values()).sort((a, b) =>
          String(a.nome || "").localeCompare(String(b.nome || ""), "it", {
            sensitivity: "base",
          }),
        );
      }

      function hashStringToUint(str) {
        let h = 2166136261;
        const s = String(str || "");
        for (let i = 0; i < s.length; i++) {
          h ^= s.charCodeAt(i);
          h = Math.imul(h, 16777619) >>> 0;
        }
        return h >>> 0;
      }

      function pickSomeUnique(items, count, seedStr) {
        const arr = Array.isArray(items) ? [...items] : [];
        if (count <= 0 || arr.length === 0) return [];
        let seed = hashStringToUint(seedStr);
        for (let i = arr.length - 1; i > 0; i--) {
          seed = (Math.imul(seed, 1103515245) + 12345) >>> 0;
          const j = seed % (i + 1);
          const tmp = arr[i];
          arr[i] = arr[j];
          arr[j] = tmp;
        }
        return arr.slice(0, Math.min(count, arr.length));
      }

      function buildRedazioniCentraliFromTestate(testate) {
        const CITY_META = {
          Milano: {
            address: "Via Dante, 12 - 20121 Milano",
            phone: "02 123456",
          },
          Roma: {
            address: "Via Roma, 1 - 00100 Roma",
            phone: "06 123456",
          },
          Torino: {
            address: "Corso Francia, 10 - 10138 Torino",
            phone: "011 123456",
          },
        };

        const TOPICS = [
          "sport",
          "economia",
          "cronaca",
          "politica",
          "cultura",
          "tecnologia",
        ];

        const LOCALI = [
          "bologna",
          "napoli",
          "firenze",
          "genova",
          "palermo",
          "bari",
        ];

        const ESTERE = [
          "londra",
          "new york",
          "mosca",
          "pechino",
          "tokyo",
          "parigi",
        ];

        const CITY_ADDRESSES = {
          londra: "10 Downing Street, London",
          "new york": "350 5th Ave, New York",
          mosca: "ul. Tverskaya, Mosca",
          pechino: "Chang'an Ave, Pechino",
          tokyo: "Chiyoda, Tokyo",
          parigi: "10 Rue de Rivoli, Paris",
          bologna: "Via Indipendenza, 1 - Bologna",
          napoli: "Via Toledo, 10 - Napoli",
          firenze: "Via dei Calzaiuoli, 5 - Firenze",
          genova: "Via XX Settembre, 20 - Genova",
          palermo: "Via Maqueda, 12 - Palermo",
          bari: "Corso Vittorio Emanuele, 9 - Bari",
        };

        const byId = new Map();

        for (const t of testate || []) {
          const city = inferRedazioneIndirizzo(t?.nome);
          const id = `rc-${normalizeTestataKey(city)}`;
          const email = String(t?.email || "").trim();
          const domain = email.includes("@")
            ? email.split("@")[1]
            : "email.com";
          const meta = CITY_META[city] || {
            address: `${city} — sede redazione centrale`,
            phone: inferRedazioneTel(city),
          };

          if (!byId.has(id)) {
            const topicCount = 3 + (hashStringToUint(id) % 3);
            const topics = pickSomeUnique(
              TOPICS,
              topicCount,
              `${id}:topics`,
            ).map((name) => {
              const topicPhone =
                city === "Roma"
                  ? "06 123457"
                  : city === "Torino"
                    ? "011 123457"
                    : "02 123457";
              return {
                id: `${id}:topic:${normalizeTestataKey(name)}`,
                nome: name,
                email: `${normalizeTestataKey(name)}@${domain}`,
                telefono: topicPhone,
              };
            });

            const localCount = hashStringToUint(`${id}:locali`) % 4;
            const locali = pickSomeUnique(
              LOCALI,
              localCount,
              `${id}:locali`,
            ).map((citta) => ({
              id: `${id}:local:${normalizeTestataKey(citta)}`,
              citta,
              indirizzo:
                CITY_ADDRESSES[normalizeTestataKey(citta)] ||
                `${citta} — sede locale`,
              email: `${normalizeTestataKey(citta)}@${domain}`,
              telefono: meta.phone,
            }));

            const estereCount = 2 + (hashStringToUint(`${id}:estere`) % 4);
            const estere = pickSomeUnique(
              ESTERE,
              estereCount,
              `${id}:estere`,
            ).map((citta) => ({
              id: `${id}:estera:${normalizeTestataKey(citta)}`,
              citta,
              indirizzo:
                CITY_ADDRESSES[normalizeTestataKey(citta)] ||
                `${citta} — sede estera`,
              email: `${normalizeTestataKey(citta)}@${domain}`,
              telefono:
                citta === "londra" ? "+44 20 7946 0958" : "+1 212 555 0100",
            }));

            byId.set(id, {
              id,
              nome: "redazione centrale",
              sede: city,
              indirizzo: meta.address,
              email: `redazione.centrale@${domain}`,
              telefono: meta.phone,
              argomenti: topics,
              locali,
              estere,
            });
          }

          if (t) {
            t.redazioneCentraleId = id;
          }
        }

        return Array.from(byId.values()).sort((a, b) =>
          String(a.sede || "").localeCompare(String(b.sede || ""), "it", {
            sensitivity: "base",
          }),
        );
      }

      const testate = buildTestateFromJournalists(journalists);

      const redazioniCentrali = buildRedazioniCentraliFromTestate(testate);
      const redazioniCentraliById = new Map();
      for (const r of redazioniCentrali || []) {
        const id = String(r?.id || "").trim();
        if (!id) continue;
        redazioniCentraliById.set(id, r);
      }

      const testateByKey = new Map();
      for (const t of testate || []) {
        const key = String(t?.id || "").trim();
        if (!key) continue;
        testateByKey.set(key, t);
      }

      const testataArgomentoDropdown = new FilterableDropdown(
        "testataArgomentoDropdownInput",
        sampleOptions,
        {
          inputWrapperId: "testataArgomentoDropdownInputWrapper",
          chipContainerId: "testataArgomentoChipContainer",
          autocompleteInlineId: "testataArgomentoAutocompleteInline",
          autocompleteSuffixId: "testataArgomentoAutocompleteSuffix",
          autocompleteTipId: "testataArgomentoAutocompleteTip",
          arrowId: "testataArgomentoDropdownArrow",
          clearId: "testataArgomentoDropdownClearLink",
          listId: "testataArgomentoDropdownList",
          closeLinkId: "testataArgomentoCloseDropdownLink",
          suggestionsId: "testataArgomentoDropdownSuggestions",
          resultsId: "testataArgomentoDropdownResults",
          parents: [
            "ALIMENTARI E BEVANDE",
            "AGRICOLTURA",
            "INFORMATICA E WEB",
            "ARTE E CULTURA",
          ],
          childrenByParent: SERVICES_BY_PARENT,
          renderChipsInInput: false,
          preserveParentOrder: false,
        },
      );
      testataArgomentoDropdown.updateAutocompleteHint("");

      const TESTATA_MEDIA_BY_PARENT = {
        Radio: ["News / GR", "Trasmissioni Radio"],
        TV: ["Canali Tematici", "News / TG", "Programmi TV"],
        "Carta Stampata": [
          "Quotidiani",
          "Periodici al Pubblico",
          "Periodici di Categoria",
          "Supplementi",
        ],
        Web: ["On-Line / News", "Blog"],
      };

      const testataTipoMediaOptions = Object.values(TESTATA_MEDIA_BY_PARENT)
        .flat()
        .sort((a, b) => a.localeCompare(b, "it", { sensitivity: "base" }));

      const testataTipoMediaDropdown = new FilterableDropdown(
        "testataTipoMediaDropdownInput",
        testataTipoMediaOptions,
        {
          inputWrapperId: "testataTipoMediaDropdownInputWrapper",
          chipContainerId: "testataTipoMediaChipContainer",
          autocompleteInlineId: "testataTipoMediaAutocompleteInline",
          autocompleteSuffixId: "testataTipoMediaAutocompleteSuffix",
          autocompleteTipId: "testataTipoMediaAutocompleteTip",
          arrowId: "testataTipoMediaDropdownArrow",
          clearId: "testataTipoMediaDropdownClearLink",
          listId: "testataTipoMediaDropdownList",
          closeLinkId: "testataTipoMediaCloseDropdownLink",
          suggestionsId: "testataTipoMediaDropdownSuggestions",
          resultsId: "testataTipoMediaDropdownResults",
          parents: ["Radio", "TV", "Carta Stampata", "Web"],
          childrenByParent: TESTATA_MEDIA_BY_PARENT,
          synonymsByFilter: {},
          renderChipsInInput: false,
          preserveParentOrder: true,
        },
      );
      testataTipoMediaDropdown.updateAutocompleteHint("");

      const FREQUENZA_PUBBLICAZIONE_OPTIONS = [
        "Annuale",
        "Aperiodico",
        "Bimestrale",
        "Bisettimanale",
        "Mensile",
        "Quadrimestrale",
        "Quattordicinale",
        "Quindicinale",
        "Quotidiano",
        "Semestrale",
        "Settimanale",
        "Trimestrale",
        "Trisettimanale",
        "Quadriennale",
        "Plurisettimanale",
      ];

      const testataFrequenzaDropdown = new FilterableDropdown(
        "testataFrequenzaDropdownInput",
        FREQUENZA_PUBBLICAZIONE_OPTIONS,
        {
          inputWrapperId: "testataFrequenzaDropdownInputWrapper",
          chipContainerId: "testataFrequenzaChipContainer",
          autocompleteInlineId: "testataFrequenzaAutocompleteInline",
          autocompleteSuffixId: "testataFrequenzaAutocompleteSuffix",
          autocompleteTipId: "testataFrequenzaAutocompleteTip",
          arrowId: "testataFrequenzaDropdownArrow",
          clearId: "testataFrequenzaDropdownClearLink",
          listId: "testataFrequenzaDropdownList",
          closeLinkId: "testataFrequenzaCloseDropdownLink",
          suggestionsId: "testataFrequenzaDropdownSuggestions",
          resultsId: "testataFrequenzaDropdownResults",
          synonymsByFilter: {},
          renderChipsInInput: false,
          sortComparator: (a, b) => {
            const key = (x) =>
              String(x || "")
                .trim()
                .toLowerCase();
            const ra = (() => {
              const k = key(a);
              if (k === "aperiodico" || k === "plurisettimanale") {
                return { indefinite: true, days: Number.POSITIVE_INFINITY };
              }
              const days =
                k === "quotidiano"
                  ? 1
                  : k === "trisettimanale"
                    ? 7 / 3
                    : k === "bisettimanale"
                      ? 7 / 2
                      : k === "settimanale"
                        ? 7
                        : k === "quattordicinale"
                          ? 14
                          : k === "quindicinale"
                            ? 15
                            : k === "mensile"
                              ? 30
                              : k === "bimestrale"
                                ? 60
                                : k === "trimestrale"
                                  ? 90
                                  : k === "quadrimestrale"
                                    ? 120
                                    : k === "semestrale"
                                      ? 182
                                      : k === "annuale"
                                        ? 365
                                        : k === "quadriennale"
                                          ? 365 * 4
                                          : Number.POSITIVE_INFINITY;
              return { indefinite: false, days };
            })();

            const rb = (() => {
              const k = key(b);
              if (k === "aperiodico" || k === "plurisettimanale") {
                return { indefinite: true, days: Number.POSITIVE_INFINITY };
              }
              const days =
                k === "quotidiano"
                  ? 1
                  : k === "trisettimanale"
                    ? 7 / 3
                    : k === "bisettimanale"
                      ? 7 / 2
                      : k === "settimanale"
                        ? 7
                        : k === "quattordicinale"
                          ? 14
                          : k === "quindicinale"
                            ? 15
                            : k === "mensile"
                              ? 30
                              : k === "bimestrale"
                                ? 60
                                : k === "trimestrale"
                                  ? 90
                                  : k === "quadrimestrale"
                                    ? 120
                                    : k === "semestrale"
                                      ? 182
                                      : k === "annuale"
                                        ? 365
                                        : k === "quadriennale"
                                          ? 365 * 4
                                          : Number.POSITIVE_INFINITY;
              return { indefinite: false, days };
            })();

            if (ra.indefinite !== rb.indefinite) {
              return ra.indefinite ? 1 : -1;
            }
            if (ra.days !== rb.days) {
              return ra.days - rb.days;
            }
            return String(a || "").localeCompare(String(b || ""), "it", {
              sensitivity: "base",
            });
          },
        },
      );
      testataFrequenzaDropdown.updateAutocompleteHint("");

      const DIFFUSIONE_OPTIONS = [
        "Internazionale",
        "Nazionale",
        "Regionale",
        "Locale",
      ];

      const testataDiffusioneDropdown = new FilterableDropdown(
        "testataDiffusioneDropdownInput",
        DIFFUSIONE_OPTIONS,
        {
          inputWrapperId: "testataDiffusioneDropdownInputWrapper",
          chipContainerId: "testataDiffusioneChipContainer",
          autocompleteInlineId: "testataDiffusioneAutocompleteInline",
          autocompleteSuffixId: "testataDiffusioneAutocompleteSuffix",
          autocompleteTipId: "testataDiffusioneAutocompleteTip",
          arrowId: "testataDiffusioneDropdownArrow",
          clearId: "testataDiffusioneDropdownClearLink",
          listId: "testataDiffusioneDropdownList",
          closeLinkId: "testataDiffusioneCloseDropdownLink",
          suggestionsId: "testataDiffusioneDropdownSuggestions",
          resultsId: "testataDiffusioneDropdownResults",
          synonymsByFilter: {},
          renderChipsInInput: false,
        },
      );
      testataDiffusioneDropdown.updateAutocompleteHint("");

      const selectedJournalistIds = new Set();
      const selectedJournalistOrder = [];
      let lastRenderedVisibleJournalistIds = [];

      const selectedPanelBody = document.getElementById("selectedPanelBody");
      const selectedClearAll = document.getElementById("selectedClearAll");
      const selectedActionsSplit = document.getElementById(
        "selectedActionsSplit",
      );
      const selectedInListRow = document.getElementById("selectedInListRow");
      const selectedInListCount = document.getElementById(
        "selectedInListCount",
      );
      const selectedRemoveFromListLink = document.getElementById(
        "selectedRemoveFromListLink",
      );

      const saveListModalOverlay = document.getElementById(
        "saveListModalOverlay",
      );
      const saveListModal = document.getElementById("saveListModal");
      const saveListModalTitle = document.getElementById("saveListModalTitle");
      const saveListModalClose = document.getElementById("saveListModalClose");
      const saveListNameInput = document.getElementById("saveListNameInput");
      const saveListConfirm = document.getElementById("saveListConfirm");
      const saveListError = document.getElementById("saveListError");

      const shareListModalOverlay = document.getElementById(
        "shareListModalOverlay",
      );
      const shareListModal = document.getElementById("shareListModal");
      const shareListModalClose = document.getElementById(
        "shareListModalClose",
      );
      const shareListUsers = document.getElementById("shareListUsers");
      const shareListConfirm = document.getElementById("shareListConfirm");

      const addToListModalOverlay = document.getElementById(
        "addToListModalOverlay",
      );
      const addToListModal = document.getElementById("addToListModal");
      const addToListModalClose = document.getElementById(
        "addToListModalClose",
      );
      const addToListDropdownInput = document.getElementById(
        "addToListDropdownInput",
      );
      const addToListConfirm = document.getElementById("addToListConfirm");
      const addToListError = document.getElementById("addToListError");

      let addToListTargetJids = null;
      let addToShipmentTargetJids = null;

      const addToShipmentModalOverlay = document.getElementById(
        "addToShipmentModalOverlay",
      );
      const addToShipmentModal = document.getElementById("addToShipmentModal");
      const addToShipmentModalClose = document.getElementById(
        "addToShipmentModalClose",
      );
      const addToShipmentDropdownInput = document.getElementById(
        "addToShipmentDropdownInput",
      );
      const addToShipmentConfirm = document.getElementById(
        "addToShipmentConfirm",
      );
      const addToShipmentError = document.getElementById("addToShipmentError");

      const addToNewShipmentModalOverlay = document.getElementById(
        "addToNewShipmentModalOverlay",
      );
      const addToNewShipmentModal = document.getElementById(
        "addToNewShipmentModal",
      );
      const addToNewShipmentModalClose = document.getElementById(
        "addToNewShipmentModalClose",
      );
      const addToNewShipmentNameInput = document.getElementById(
        "addToNewShipmentNameInput",
      );
      const addToNewShipmentConfirm = document.getElementById(
        "addToNewShipmentConfirm",
      );
      const addToNewShipmentError = document.getElementById(
        "addToNewShipmentError",
      );
      const mainTitleEl = document.getElementById("mainTitle");
      const mailingListCountPill = document.getElementById(
        "mailingListCountPill",
      );
      const mailingListActions = document.getElementById("mailingListActions");
      const mailingListRenameLink = document.getElementById(
        "mailingListRenameLink",
      );
      const mailingListDuplicateLink = document.getElementById(
        "mailingListDuplicateLink",
      );
      const mailingListExportLink = document.getElementById(
        "mailingListExportLink",
      );
      const mailingListDeleteLink = document.getElementById(
        "mailingListDeleteLink",
      );
      const mailingListCreatedAtSubtitle = document.getElementById(
        "mailingListCreatedAtSubtitle",
      );
      const dashboardMailingListsEl = document.getElementById(
        "dashboardMailingLists",
      );

      let saveListModalMode = "create";
      let saveListModalTargetId = "";

      const textFilterInput = document.getElementById("textFilterInput");
      const textFilterClear = document.getElementById("textFilterClearLink");

      const committedTextTerms = [];

      function getJournalistId(j) {
        return String(j?.email || "").trim();
      }

      function getJournalistTestate(j) {
        if (!j) return [];
        if (Array.isArray(j.testate)) {
          return j.testate.map((x) => String(x ?? "").trim()).filter(Boolean);
        }
        const s = String(j.testata ?? "").trim();
        return s ? [s] : [];
      }

      function getJournalistNameById(jid) {
        const j = (journalists || []).find((x) => getJournalistId(x) === jid);
        if (!j) return jid;
        return `${j.nome} ${j.cognome}`;
      }

      function ensureSelectedOrder(jid) {
        const idx = selectedJournalistOrder.indexOf(jid);
        if (idx !== -1) selectedJournalistOrder.splice(idx, 1);
        selectedJournalistOrder.unshift(jid);
      }

      function removeFromSelectedOrder(jid) {
        const idx = selectedJournalistOrder.indexOf(jid);
        if (idx !== -1) selectedJournalistOrder.splice(idx, 1);
      }

      function openSaveListModal() {
        if (!saveListModal || !saveListModalOverlay) return;
        if (selectedJournalistOrder.length === 0) return;

        saveListModalMode = "create";
        saveListModalTargetId = "";
        if (saveListModalTitle) saveListModalTitle.textContent = "Salva lista";
        if (saveListConfirm) saveListConfirm.textContent = "salva lista";

        if (saveListNameInput) {
          saveListNameInput.value = "";
          saveListNameInput.focus();
        }
        if (saveListError) {
          saveListError.style.display = "none";
        }

        saveListModalOverlay.classList.add("show");
        saveListModal.classList.add("show");
        saveListModalOverlay.setAttribute("aria-hidden", "false");
        saveListModal.setAttribute("aria-hidden", "false");
      }

      function openRenameListModal() {
        if (!saveListModal || !saveListModalOverlay) return;
        const activeList = getMailingListById(appState.activeMailingListId);
        if (!activeList) return;

        saveListModalMode = "rename";
        saveListModalTargetId = String(activeList.id || "");
        if (saveListModalTitle) {
          saveListModalTitle.textContent = "Rinomina lista";
        }
        if (saveListConfirm) saveListConfirm.textContent = "rinomina lista";

        if (saveListNameInput) {
          saveListNameInput.value = String(activeList.name || "");
          saveListNameInput.focus();
          try {
            saveListNameInput.setSelectionRange(
              0,
              String(saveListNameInput.value || "").length,
            );
          } catch (_) {}
        }
        if (saveListError) {
          saveListError.style.display = "none";
        }

        saveListModalOverlay.classList.add("show");
        saveListModal.classList.add("show");
        saveListModalOverlay.setAttribute("aria-hidden", "false");
        saveListModal.setAttribute("aria-hidden", "false");
      }

      function closeSaveListModal() {
        if (!saveListModal || !saveListModalOverlay) return;
        saveListModalOverlay.classList.remove("show");
        saveListModal.classList.remove("show");
        saveListModalOverlay.setAttribute("aria-hidden", "true");
        saveListModal.setAttribute("aria-hidden", "true");

        saveListModalMode = "create";
        saveListModalTargetId = "";
        if (saveListModalTitle) saveListModalTitle.textContent = "Salva lista";
        if (saveListConfirm) saveListConfirm.textContent = "salva lista";
      }

      const COLLEAGUES = [
        { id: "oleandro", name: "oleandro" },
        { id: "rosa", name: "rosa" },
        { id: "margherita", name: "margherita" },
      ];

      function openShareListModal() {
        if (!shareListModal || !shareListModalOverlay || !shareListUsers)
          return;
        const activeList = getMailingListById(appState.activeMailingListId);
        if (!activeList) return;

        const selected = new Set(
          Array.isArray(activeList.sharedWith) ? activeList.sharedWith : [],
        );
        shareListUsers.innerHTML = "";

        for (const c of COLLEAGUES) {
          const row = document.createElement("label");
          row.className = "share-list-user";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = selected.has(c.id);
          cb.setAttribute("data-colleague-id", c.id);

          const text = document.createElement("span");
          text.textContent = c.name;

          row.appendChild(cb);
          row.appendChild(text);
          shareListUsers.appendChild(row);
        }

        shareListModalOverlay.classList.add("show");
        shareListModal.classList.add("show");
        shareListModalOverlay.setAttribute("aria-hidden", "false");
        shareListModal.setAttribute("aria-hidden", "false");
      }

      function closeShareListModal() {
        if (!shareListModal || !shareListModalOverlay) return;
        shareListModalOverlay.classList.remove("show");
        shareListModal.classList.remove("show");
        shareListModalOverlay.setAttribute("aria-hidden", "true");
        shareListModal.setAttribute("aria-hidden", "true");
      }

      function getMailingListById(id) {
        const k = String(id || "").trim();
        if (!k) return null;
        return (
          (appState.mailingLists || []).find((x) => x && x.id === k) || null
        );
      }

      function getMailingListByName(name) {
        const k = String(name || "").trim();
        if (!k) return null;
        return (
          (appState.mailingLists || []).find(
            (x) => String(x?.name || "") === k,
          ) || null
        );
      }

      function getSpedizioneByName(name) {
        const k = String(name || "").trim();
        if (!k) return null;
        return (
          (appState.spedizioni || []).find(
            (x) => String(x?.name || "") === k,
          ) || null
        );
      }

      const addToListDropdown = new FilterableDropdown(
        "addToListDropdownInput",
        [],
        {
          inputWrapperId: "addToListDropdownInputWrapper",
          chipContainerId: "addToListChipContainer",
          autocompleteInlineId: "addToListAutocompleteInline",
          autocompleteSuffixId: "addToListAutocompleteSuffix",
          autocompleteTipId: "addToListAutocompleteTip",
          arrowId: "addToListDropdownArrow",
          clearId: null,
          listId: "addToListDropdownList",
          closeLinkId: null,
          suggestionsId: "addToListDropdownSuggestions",
          resultsId: "addToListDropdownResults",
          synonymsByFilter: {},
          renderChipsInInput: false,
          renderCheckboxes: false,
          singleSelect: true,
          closeOnSelect: true,
          writeSelectedToInput: true,
          enableHighlight: true,
          minFilterChars: 1,
        },
      );
      addToListDropdown.updateAutocompleteHint("");

      addToListDropdown.onSelectionChange = () => {
        if (addToListError) addToListError.style.display = "none";
      };

      const addToShipmentDropdown = new FilterableDropdown(
        "addToShipmentDropdownInput",
        [],
        {
          inputWrapperId: "addToShipmentDropdownInputWrapper",
          chipContainerId: "addToShipmentChipContainer",
          autocompleteInlineId: "addToShipmentAutocompleteInline",
          autocompleteSuffixId: "addToShipmentAutocompleteSuffix",
          autocompleteTipId: "addToShipmentAutocompleteTip",
          arrowId: "addToShipmentDropdownArrow",
          clearId: "addToShipmentDropdownClearLink",
          listId: "addToShipmentDropdownList",
          closeLinkId: null,
          suggestionsId: "addToShipmentDropdownSuggestions",
          resultsId: "addToShipmentDropdownResults",
          synonymsByFilter: {},
          renderChipsInInput: false,
          renderCheckboxes: false,
          singleSelect: true,
          closeOnSelect: true,
          writeSelectedToInput: true,
          enableHighlight: true,
          minFilterChars: 1,
        },
      );
      addToShipmentDropdown.updateAutocompleteHint("");

      addToShipmentDropdown.onSelectionChange = () => {
        if (addToShipmentError) addToShipmentError.style.display = "none";
      };

      const clearAddToShipmentForm = () => {
        if (addToShipmentDropdown?.isOpen) {
          addToShipmentDropdown.close();
        }
        if (addToShipmentError) addToShipmentError.style.display = "none";
      };

      const centerModalToAnchor = (modalEl, anchorEl) => {
        if (!modalEl || !anchorEl) return;
        const r = anchorEl.getBoundingClientRect();
        const modalW = modalEl.getBoundingClientRect()?.width || 0;
        const pad = 20;
        const minX = modalW ? modalW / 2 + pad : pad;
        const maxX = modalW
          ? window.innerWidth - modalW / 2 - pad
          : window.innerWidth - pad;
        const x0 = r.left + r.width / 2;
        const x = Math.max(minX, Math.min(maxX, x0));
        modalEl.style.left = `${x}px`;
        modalEl.style.transform = "translateX(-50%)";
      };

      function openAddToListModal(opts) {
        if (!addToListModal || !addToListModalOverlay) return;
        const targetJids = Array.isArray(opts?.journalistIds)
          ? opts.journalistIds
              .map((x) => String(x || "").trim())
              .filter(Boolean)
          : null;
        if (
          selectedJournalistOrder.length === 0 &&
          (!targetJids || !targetJids.length)
        ) {
          return;
        }
        addToListTargetJids = targetJids;

        closeAllFilterableDropdowns();

        const listNames = (appState.mailingLists || [])
          .map((x) => String(x?.name || "").trim())
          .filter(Boolean);
        addToListDropdown.setOptions(listNames);

        if (addToListError) {
          addToListError.style.display = "none";
        }

        addToListModal.style.left = "";
        addToListModal.style.transform = "";
        if (opts?.anchorEl) {
          centerModalToAnchor(addToListModal, opts.anchorEl);
        }

        addToListModalOverlay.classList.add("show");
        addToListModal.classList.add("show");
        addToListModalOverlay.setAttribute("aria-hidden", "false");
        addToListModal.setAttribute("aria-hidden", "false");

        if (addToListDropdownInput) {
          addToListDropdownInput.focus();
        }
      }

      function closeAddToListModal() {
        if (!addToListModal || !addToListModalOverlay) return;
        if (addToListDropdown?.isOpen) {
          addToListDropdown.close();
        }
        addToListTargetJids = null;
        addToListModalOverlay.classList.remove("show");
        addToListModal.classList.remove("show");
        addToListModalOverlay.setAttribute("aria-hidden", "true");
        addToListModal.setAttribute("aria-hidden", "true");

        if (addToListError) {
          addToListError.style.display = "none";
        }
      }

      function openAddToShipmentModal(opts) {
        if (!addToShipmentModal || !addToShipmentModalOverlay) return;
        const targetJids = Array.isArray(opts?.journalistIds)
          ? opts.journalistIds
              .map((x) => String(x || "").trim())
              .filter(Boolean)
          : null;
        if (
          selectedJournalistOrder.length === 0 &&
          (!targetJids || !targetJids.length)
        ) {
          return;
        }
        addToShipmentTargetJids = targetJids;

        closeAllFilterableDropdowns();

        const shipmentNames = (appState.spedizioni || [])
          .map((x) => String(x?.name || "").trim())
          .filter(Boolean);
        addToShipmentDropdown.setOptions(shipmentNames);

        if (addToShipmentError) {
          addToShipmentError.style.display = "none";
        }

        addToShipmentModal.style.left = "";
        addToShipmentModal.style.transform = "";
        if (opts?.anchorEl) {
          centerModalToAnchor(addToShipmentModal, opts.anchorEl);
        }

        addToShipmentModalOverlay.classList.add("show");
        addToShipmentModal.classList.add("show");
        addToShipmentModalOverlay.setAttribute("aria-hidden", "false");
        addToShipmentModal.setAttribute("aria-hidden", "false");

        if (addToShipmentDropdownInput) {
          addToShipmentDropdownInput.focus();
        }
      }

      function openAddToNewShipmentModal() {
        if (!addToNewShipmentModal || !addToNewShipmentModalOverlay) return;
        if (selectedJournalistOrder.length === 0) return;

        closeAllFilterableDropdowns();

        {
          const titleEl = document.getElementById("addToNewShipmentModalTitle");
          const n = Number(selectedJournalistIds?.size || 0);
          const label =
            n === 1
              ? "Aggiungi 1 giornalista a nuova spedizione"
              : `Aggiungi ${n} giornalisti a nuova spedizione`;
          if (titleEl) titleEl.textContent = label;
        }

        if (addToNewShipmentError) {
          addToNewShipmentError.style.display = "none";
        }

        addToNewShipmentModalOverlay.classList.add("show");
        addToNewShipmentModal.classList.add("show");
        addToNewShipmentModalOverlay.setAttribute("aria-hidden", "false");
        addToNewShipmentModal.setAttribute("aria-hidden", "false");

        if (addToNewShipmentNameInput) {
          addToNewShipmentNameInput.value = "";
          addToNewShipmentNameInput.focus();
        }
      }

      function closeAddToShipmentModal() {
        if (!addToShipmentModal || !addToShipmentModalOverlay) return;
        if (addToShipmentDropdown?.isOpen) {
          addToShipmentDropdown.close();
        }
        addToShipmentTargetJids = null;
        addToShipmentModalOverlay.classList.remove("show");
        addToShipmentModal.classList.remove("show");
        addToShipmentModalOverlay.setAttribute("aria-hidden", "true");
        addToShipmentModal.setAttribute("aria-hidden", "true");

        if (addToShipmentError) {
          addToShipmentError.style.display = "none";
        }
      }

      function closeAddToNewShipmentModal() {
        if (!addToNewShipmentModal || !addToNewShipmentModalOverlay) return;
        addToNewShipmentModalOverlay.classList.remove("show");
        addToNewShipmentModal.classList.remove("show");
        addToNewShipmentModalOverlay.setAttribute("aria-hidden", "true");
        addToNewShipmentModal.setAttribute("aria-hidden", "true");

        if (addToNewShipmentError) {
          addToNewShipmentError.style.display = "none";
        }
      }

      function computeUniqueSpedizioneName(baseName) {
        const base = String(baseName || "").trim();
        if (!base) return "";

        const existing = new Set(
          (appState.spedizioni || [])
            .map((x) =>
              String(x?.name || "")
                .trim()
                .toLowerCase(),
            )
            .filter(Boolean),
        );
        const baseKey = base.toLowerCase();
        if (!existing.has(baseKey)) return base;

        let i = 1;
        while (i < 1000) {
          const candidate = `${base} (${i})`;
          if (!existing.has(candidate.toLowerCase())) return candidate;
          i++;
        }
        return `${base} (${Date.now()})`;
      }

      function computeUniqueMailingListName(baseName) {
        const base = String(baseName || "").trim();
        if (!base) return "";

        const existing = new Set(
          (appState.mailingLists || [])
            .map((x) =>
              String(x?.name || "")
                .trim()
                .toLowerCase(),
            )
            .filter(Boolean),
        );

        const baseKey = base.toLowerCase();
        if (!existing.has(baseKey)) return base;

        let i = 1;
        while (i < 1000) {
          const candidate = `${base} (${i})`;
          if (!existing.has(candidate.toLowerCase())) {
            return candidate;
          }
          i++;
        }
        return `${base} (${Date.now()})`;
      }

      function computeDuplicatedMailingListName(originalName) {
        const base = String(originalName || "").trim();
        if (!base) return "";

        const existing = new Set(
          (appState.mailingLists || [])
            .map((x) =>
              String(x?.name || "")
                .trim()
                .toLowerCase(),
            )
            .filter(Boolean),
        );

        let i = 1;
        while (i < 1000) {
          const candidate = `${base} (${i})`;
          if (!existing.has(candidate.toLowerCase())) {
            return candidate;
          }
          i++;
        }
        return `${base} (${Date.now()})`;
      }

      function createMailingList(name, journalistIds) {
        const id = `ml_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const list = {
          id,
          name,
          journalistIds: Array.from(journalistIds || []),
          createdAt: Date.now(),
        };

        if (!Array.isArray(appState.mailingLists)) {
          appState.mailingLists = [];
        }
        appState.mailingLists.unshift(list);
        appState.activeMailingListId = id;
        saveAppState(appState);
        return list;
      }

      function duplicateActiveMailingList() {
        const active = getMailingListById(appState.activeMailingListId);
        if (!active) return null;

        const newName = computeDuplicatedMailingListName(active.name);
        if (!newName) return null;

        const id = `ml_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const list = {
          id,
          name: newName,
          journalistIds: Array.from(active.journalistIds || []),
          createdAt: Date.now(),
        };

        if (!Array.isArray(appState.mailingLists)) {
          appState.mailingLists = [];
        }
        appState.mailingLists.unshift(list);
        appState.activeMailingListId = id;
        saveAppState(appState);

        renderDashboardMailingLists();
        openMailingListById(id);
        return list;
      }

      function openMailingListById(id) {
        const list = getMailingListById(id);
        if (!list) return;
        appState.activeMailingListId = list.id;
        saveAppState(appState);
        window.location.hash = "#mailing-list";
        setActiveView("mailing-list", { save: true });
        scheduleRender();
      }

      function renderDashboardMailingLists() {
        if (!dashboardMailingListsEl) return;
        dashboardMailingListsEl.innerHTML = "";

        const lists = Array.isArray(appState.mailingLists)
          ? appState.mailingLists
          : [];

        if (lists.length === 0) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "Nessuna mailing list salvata";
          dashboardMailingListsEl.appendChild(empty);
          return;
        }

        const container = document.createElement("div");
        container.className = "dashboard-mailing-lists";

        for (const ml of lists) {
          if (!ml || typeof ml !== "object") continue;
          const id = String(ml.id || "").trim();
          const name = String(ml.name || "").trim();
          const count = Array.isArray(ml.journalistIds)
            ? ml.journalistIds.length
            : 0;
          const createdAt = Number(ml.createdAt || 0);
          if (!id || !name) continue;

          const row = document.createElement("div");
          row.className = "dashboard-mailing-list-item";

          const left = document.createElement("div");
          left.className = "dashboard-mailing-list-left";

          const title = document.createElement("a");
          title.href = "#";
          title.className = "dashboard-mailing-list-link";
          title.textContent = name;
          title.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (typeof clearAllFilters === "function") {
              clearAllFilters();
            }
            openMailingListById(id);
          });

          const meta = document.createElement("div");
          meta.className = "dashboard-mailing-list-meta";
          if (Number.isFinite(createdAt) && createdAt > 0) {
            const stamp = new Date(createdAt).toLocaleDateString("it-IT");
            meta.textContent = `creata il ${stamp}`;
          } else {
            meta.textContent = "";
          }

          left.appendChild(title);
          if (meta.textContent) left.appendChild(meta);

          const pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = String(count);

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "dashboard-mailing-list-delete";
          deleteBtn.setAttribute("aria-label", `Elimina ${name}`);
          deleteBtn.textContent = "×";
          deleteBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();

            const ok = window.confirm(`Eliminare la mailing list "${name}"?`);
            if (!ok) return;

            appState.mailingLists = (appState.mailingLists || []).filter(
              (x) => String(x?.id || "") !== id,
            );
            if (String(appState.activeMailingListId || "") === id) {
              appState.activeMailingListId = "";
            }
            saveAppState(appState);
            renderDashboardMailingLists();
          });

          const actions = document.createElement("div");
          actions.className = "dashboard-mailing-list-actions";
          actions.appendChild(pill);
          actions.appendChild(deleteBtn);

          row.appendChild(left);
          row.appendChild(actions);
          container.appendChild(row);
        }

        dashboardMailingListsEl.appendChild(container);
      }

      function escapeRegExp(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      const NOTE_MAX_CHARS = 120;
      const NOTE_MATCH_MAX_CHARS = 80;

      function normalizeNotes(note) {
        if (Array.isArray(note)) {
          return note
            .map((x) =>
              typeof x === "object" && x && "text" in x
                ? String(x.text ?? "").trim()
                : String(x ?? "").trim(),
            )
            .filter((x) => x.length > 0);
        }
        const s = String(note ?? "").trim();
        return s ? [s] : [];
      }

      function normalizeNoteItems(note) {
        if (Array.isArray(note)) {
          return note
            .map((x) => {
              if (typeof x === "object" && x) {
                return {
                  text: String(x.text ?? "").trim(),
                  updatedAt: x.updatedAt ? String(x.updatedAt) : "",
                };
              }
              return { text: String(x ?? "").trim(), updatedAt: "" };
            })
            .filter((x) => x.text.length > 0);
        }

        const s = String(note ?? "").trim();
        return s ? [{ text: s, updatedAt: "" }] : [];
      }

      function formatNoteDate(value) {
        const raw = String(value || "").trim();
        if (!raw) return "n/d";
        const d = new Date(raw);
        if (Number.isNaN(d.getTime())) return "n/d";
        return d.toLocaleDateString("it-IT");
      }

      function combineNotes(notesArr) {
        return (notesArr || []).join(" • ");
      }

      function makeSnippet(text, query, maxChars) {
        const raw = String(text ?? "");
        const q = String(query ?? "")
          .trim()
          .toLowerCase();
        if (!raw) return "";
        if (raw.length <= maxChars) return raw;

        const rawLower = raw.toLowerCase();
        const idx = q ? rawLower.indexOf(q) : -1;

        let start = 0;
        const anchoredToMatch = idx >= 0;
        if (idx >= 0) {
          start = Math.max(0, idx);

          const back = raw.lastIndexOf(" ", idx);
          if (back >= 0 && back < idx) {
            start = Math.max(0, back + 1);
          }
        }
        let end = start + maxChars;
        if (end > raw.length) {
          end = raw.length;
          if (!anchoredToMatch) {
            start = Math.max(0, end - maxChars);
          }
        }

        const prefix = start > 0 ? "..." : "";
        const suffix = end < raw.length ? "..." : "";
        return `${prefix}${raw.slice(start, end)}${suffix}`;
      }

      function highlightHtml(text, query) {
        const raw = String(text ?? "");
        const q = String(query ?? "").trim();
        if (!q) return escapeHtml(raw);

        const re = new RegExp(escapeRegExp(q), "gi");
        let out = "";
        let lastIndex = 0;
        let match;
        while ((match = re.exec(raw)) !== null) {
          const start = match.index;
          const end = start + match[0].length;
          out += escapeHtml(raw.slice(lastIndex, start));
          out += `<span class="highlight">${escapeHtml(
            raw.slice(start, end),
          )}</span>`;
          lastIndex = end;
          if (match[0].length === 0) break;
        }
        out += escapeHtml(raw.slice(lastIndex));
        return out;
      }

      function highlightHtmlMulti(text, queries) {
        const raw = String(text ?? "");
        const terms = (queries || [])
          .map((x) => String(x ?? "").trim())
          .filter(Boolean);
        if (!terms.length) return escapeHtml(raw);

        const uniq = [];
        const seen = new Set();
        for (const t of terms) {
          const k = t.toLowerCase();
          if (seen.has(k)) continue;
          seen.add(k);
          uniq.push(t);
        }

        uniq.sort((a, b) => b.length - a.length);
        const re = new RegExp(uniq.map((t) => escapeRegExp(t)).join("|"), "gi");

        let out = "";
        let lastIndex = 0;
        let match;
        while ((match = re.exec(raw)) !== null) {
          const start = match.index;
          const end = start + match[0].length;
          out += escapeHtml(raw.slice(lastIndex, start));
          out += `<span class="highlight">${escapeHtml(
            raw.slice(start, end),
          )}</span>`;
          lastIndex = end;
          if (match[0].length === 0) break;
        }
        out += escapeHtml(raw.slice(lastIndex));
        return out;
      }

      function getActiveTextTerms() {
        const current = String(textFilterInput?.value || "").trim();
        const terms = [...committedTextTerms];
        if (current) terms.push(current);
        return terms;
      }

      function findBestMatchTerm(haystack, terms) {
        const h = String(haystack || "").toLowerCase();
        let best = null;
        let bestIdx = Infinity;
        for (const t of terms || []) {
          const q = String(t || "")
            .trim()
            .toLowerCase();
          if (!q) continue;
          const idx = h.indexOf(q);
          if (idx >= 0 && idx < bestIdx) {
            bestIdx = idx;
            best = t;
          }
        }
        return best;
      }

      function updateCardSelectionUI(jid) {
        const card = document.querySelector(
          `.card[data-jid="${CSS.escape(jid)}"]`,
        );
        if (!card) return;
        if (selectedJournalistIds.has(jid)) {
          card.classList.add("is-selected");
        } else {
          card.classList.remove("is-selected");
        }
      }

      function updateCheckboxUI(jid) {
        const checkboxes = document.querySelectorAll(
          `.card-select[data-jid="${CSS.escape(
            jid,
          )}"], .testata-panel-select[data-jid="${CSS.escape(jid)}"]`,
        );
        if (!checkboxes.length) return;
        for (const checkbox of checkboxes) {
          checkbox.checked = selectedJournalistIds.has(jid);
        }
      }

      function renderSelectedPanelList() {
        if (!selectedPanelBody) return;
        const selectedCountEl = document.getElementById("selectedCountPill");
        if (selectedCountEl) {
          selectedCountEl.textContent = String(selectedJournalistIds.size || 0);
        }

        if (selectedInListRow) {
          selectedInListRow.style.display = "none";
        }

        if (appState.view === "mailing-list") {
          const activeList = getMailingListById(appState.activeMailingListId);
          if (activeList && Array.isArray(activeList.journalistIds)) {
            const allowed = new Set(activeList.journalistIds);
            let inListCount = 0;
            for (const jid of selectedJournalistIds) {
              if (allowed.has(jid)) inListCount++;
            }
            if (inListCount > 0 && selectedInListRow) {
              if (selectedInListCount) {
                selectedInListCount.textContent = String(inListCount);
              }
              selectedInListRow.style.display = "flex";
            }
          }
        }

        selectedPanelBody.innerHTML = "";

        if (selectedJournalistOrder.length === 0) {
          return;
        }

        const list = document.createElement("div");
        list.className = "selected-list";

        for (const jid of selectedJournalistOrder) {
          if (!selectedJournalistIds.has(jid)) continue;

          const item = document.createElement("div");
          item.className = "selected-item";

          const left = document.createElement("div");
          left.className = "selected-item-left";

          const name = document.createElement("div");
          name.className = "selected-item-name";
          name.textContent = getJournalistNameById(jid);

          const scheda = document.createElement("a");
          scheda.href = "#";
          scheda.className = "testata-link journalist-link";
          scheda.textContent = "scheda";
          scheda.setAttribute("data-journalist", getJournalistNameById(jid));

          const remove = document.createElement("button");
          remove.type = "button";
          remove.className = "selected-item-remove";
          remove.textContent = "×";
          remove.setAttribute("data-jid", jid);

          left.appendChild(name);
          left.appendChild(scheda);
          item.appendChild(left);
          item.appendChild(remove);
          list.appendChild(item);
        }

        selectedPanelBody.appendChild(list);
      }

      if (selectedRemoveFromListLink) {
        selectedRemoveFromListLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          if (appState.view !== "mailing-list") return;
          const activeList = getMailingListById(appState.activeMailingListId);
          if (!activeList || !Array.isArray(activeList.journalistIds)) return;

          const allowed = new Set(activeList.journalistIds);
          const toRemove = [];
          for (const jid of selectedJournalistIds) {
            if (allowed.has(jid)) toRemove.push(jid);
          }
          if (!toRemove.length) return;

          const toRemoveSet = new Set(toRemove);
          activeList.journalistIds = (activeList.journalistIds || []).filter(
            (jid) => !toRemoveSet.has(jid),
          );
          saveAppState(appState);

          for (const jid of toRemove) {
            selectedJournalistIds.delete(jid);
            removeFromSelectedOrder(jid);
            updateCheckboxUI(jid);
            updateCardSelectionUI(jid);
          }

          if (selectedJournalistIds.size === 0) {
            closeSelectedPanel();
          } else {
            renderSelectedPanelList();
          }
          scheduleRender();
        });
      }

      function createCard(j) {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.servizio = j.servizio;
        card.dataset.ruolo = j.ruolo;

        const rawFirstName = String(j?.nome || "").trim();
        const rawLastName = String(j?.cognome || "").trim();
        const fullName = `${rawFirstName} ${rawLastName}`.trim();
        card.dataset.fullName = fullName;

        const normalizeText = (v) => String(v ?? "").trim();

        const pickProgramPhone = () => {
          const items = Array.isArray(j?.programPhones) ? j.programPhones : [];
          for (const it of items) {
            if (it && typeof it === "object" && it.isPrimary) {
              const v = normalizeText(it.number ?? it.tel ?? it.value);
              if (v) return v;
            }
          }
          const first = items.length
            ? normalizeText(
                items[0]?.number ??
                  items[0]?.tel ??
                  items[0]?.value ??
                  items[0],
              )
            : "";
          return first || normalizeText(j?.telefono);
        };

        const pickProgramEmail = () => {
          const items = Array.isArray(j?.programEmails) ? j.programEmails : [];
          for (const it of items) {
            if (it && typeof it === "object" && it.isDefault) {
              const v = normalizeText(it.email ?? it.value);
              if (v) return v;
            }
          }
          const first = items.length
            ? normalizeText(items[0]?.email ?? items[0]?.value ?? items[0])
            : "";
          return first || normalizeText(j?.email);
        };

        const cardPhone = (() => {
          const custom = Array.isArray(j?.customPhones) ? j.customPhones : [];
          const at = (idx) =>
            normalizeText(
              custom?.[idx]?.number ??
                custom?.[idx]?.tel ??
                custom?.[idx]?.value ??
                custom?.[idx],
            );
          const pref = j?.preferredPhone;
          if (pref && pref.origin === "custom" && Number.isFinite(pref.index)) {
            const v = at(pref.index);
            if (v) return v;
          }
          if (
            pref &&
            pref.origin === "program" &&
            Number.isFinite(pref.index)
          ) {
            const items = Array.isArray(j?.programPhones)
              ? j.programPhones
              : [];
            const v = normalizeText(
              items?.[pref.index]?.number ??
                items?.[pref.index]?.tel ??
                items?.[pref.index]?.value ??
                items?.[pref.index],
            );
            if (v) return v;
          }
          for (const it of custom) {
            if (it && typeof it === "object" && it.isPrimary) {
              const v = normalizeText(it.number ?? it.tel ?? it.value);
              if (v) return v;
            }
          }
          const program = pickProgramPhone();
          if (program) return program;
          return at(0);
        })();

        const cardEmail = (() => {
          const custom = Array.isArray(j?.customEmails) ? j.customEmails : [];
          const at = (idx) =>
            normalizeText(
              custom?.[idx]?.email ?? custom?.[idx]?.value ?? custom?.[idx],
            );
          const pref = j?.preferredEmail;
          if (pref && pref.origin === "custom" && Number.isFinite(pref.index)) {
            const v = at(pref.index);
            if (v) return v;
          }
          if (
            pref &&
            pref.origin === "program" &&
            Number.isFinite(pref.index)
          ) {
            const items = Array.isArray(j?.programEmails)
              ? j.programEmails
              : [];
            const v = normalizeText(
              items?.[pref.index]?.email ??
                items?.[pref.index]?.value ??
                items?.[pref.index],
            );
            if (v) return v;
          }
          for (const it of custom) {
            if (it && typeof it === "object" && it.isDefault) {
              const v = normalizeText(it.email ?? it.value);
              if (v) return v;
            }
          }
          const program = pickProgramEmail();
          if (program) return program;
          return at(0);
        })();

        const jid = getJournalistId(j);
        card.dataset.jid = jid;
        const isSelected = selectedJournalistIds.has(jid);
        if (isSelected) {
          card.classList.add("is-selected");
        }

        const checkboxId = `card-select-${jid.replace(/[^a-zA-Z0-9_-]/g, "_")}`;

        const activeTerms = getActiveTextTerms();
        const highlightedFirstName = highlightHtmlMulti(
          rawFirstName,
          activeTerms,
        );
        const highlightedLastName = highlightHtmlMulti(
          rawLastName,
          activeTerms,
        );
        const testate = getJournalistTestate(j);
        const testatePreviewHtml = testate.length
          ? testate
              .map((tname) => {
                const label = highlightHtmlMulti(tname, activeTerms);
                return `<a href="#" class="testata-link" data-testata="${escapeHtml(
                  tname,
                )}">${label}</a>`;
              })
              .join(" • ")
          : '<span class="muted">n/d</span>';
        const notesArr = normalizeNotes(j.note);

        const notesCombined = combineNotes(notesArr);
        const notePreviewBaseRaw = (() => {
          if (!notesArr.length) return "nessuna nota";

          const best = findBestMatchTerm(notesCombined, activeTerms);
          if (best)
            return makeSnippet(notesCombined, best, NOTE_MATCH_MAX_CHARS);

          if (notesArr.length === 1) {
            if (notesCombined.length > NOTE_MAX_CHARS) {
              return makeSnippet(notesCombined, "", NOTE_MAX_CHARS);
            }
            return notesCombined;
          }

          return String(notesArr[0] || "");
        })();

        const hasHiddenNotesContent =
          notesArr.length > 1 ||
          (notesCombined &&
            notePreviewBaseRaw &&
            notesCombined.length > notePreviewBaseRaw.length);

        const noteDisplayRaw =
          notesArr.length &&
          hasHiddenNotesContent &&
          !notePreviewBaseRaw.endsWith("...")
            ? `${notePreviewBaseRaw}...`
            : notePreviewBaseRaw;

        const noteShowsEllipsis =
          notesArr.length &&
          typeof noteDisplayRaw === "string" &&
          noteDisplayRaw.includes("...");

        const highlightedNote = notesArr.length
          ? highlightHtmlMulti(noteDisplayRaw, activeTerms)
          : '<em class="muted">nessuna nota</em>';

        const removeFromListHtml =
          appState.view === "mailing-list"
            ? `<button type="button" class="c-pill card-remove-from-list" data-remove-from-list-jid="${jid}" aria-label="rimuovi da lista">×</button>`
            : "";

        card.innerHTML = `
          ${removeFromListHtml}
          <div class="card-top">
            <div class="card-name-row">
              <input
                class="card-select"
                type="checkbox"
                id="${checkboxId}"
                data-jid="${jid}"
                ${isSelected ? "checked" : ""}
              />
              <label class="card-name-label" for="${checkboxId}">
                <h3 class="card-name card-name--person"><span class="card-first-name">${highlightedFirstName}</span><span class="card-last-name" title="${escapeHtml(fullName)}">${highlightedLastName}</span></h3>
              </label>
              <a
                href="#"
                class="testata-link journalist-link card-open-link"
                data-journalist="${j.nome} ${j.cognome}"
                aria-label="apri scheda"
                title="apri scheda"
              >
                <span class="card-open-icon" aria-hidden="true"></span>
              </a>
              <p class="card-role">${j.ruolo}</p>
            </div>
          </div>
          <div class="card-row"><div class="card-label">Servizio</div><div class="card-value">${
            j.servizio
          }</div></div>
          <div class="card-row"><div class="card-label">Telefono</div><div class="card-value">${
            cardPhone
          }</div></div>
          <div class="card-row"><div class="card-label">E-mail</div><div class="card-value">${
            cardEmail
          }</div></div>
          <div class="card-row"><div class="card-label"><span class="card-journalist-testate-label" data-jid="${jid}">Testate</span></div><div class="card-value card-testate">${testatePreviewHtml}</div></div>
          <div class="card-row"><div class="card-label">${
            noteShowsEllipsis
              ? `<a href="#" class="card-label-link card-notes-open" data-jid="${jid}">Note</a>`
              : "Note"
          }</div><div class="card-value muted card-note">${highlightedNote}</div></div>
        `;
        return card;
      }

      const CARD_TOP_MIN_GAP_PX = 8;
      let cardNameLayoutRaf = 0;
      let cardsGridResizeObserver = null;

      function updateCardNameLayout(card) {
        if (!card) return;
        const nameRow = card.querySelector(".card-top .card-name-row");
        const schedaLink = card.querySelector(
          ".card-top .card-name-row .journalist-link",
        );
        const lastNameEl = card.querySelector(
          ".card-name.card-name--person .card-last-name",
        );
        const fullName = String(card.dataset.fullName || "").trim();

        if (lastNameEl && fullName) {
          lastNameEl.setAttribute("title", fullName);
        }

        if (!nameRow || !schedaLink || !lastNameEl) return;

        card.classList.remove("card--hide-first-name");

        const lastNameIsTruncated =
          lastNameEl.scrollWidth - lastNameEl.clientWidth > 0;

        const shouldHideFirstName = lastNameIsTruncated;

        if (shouldHideFirstName) {
          card.classList.add("card--hide-first-name");
        }
      }

      function scheduleUpdateCardNameLayouts() {
        if (cardNameLayoutRaf) return;
        cardNameLayoutRaf = requestAnimationFrame(() => {
          cardNameLayoutRaf = 0;
          const grid = document.getElementById("cardsGrid");
          if (!grid) return;
          for (const card of grid.querySelectorAll(".card")) {
            updateCardNameLayout(card);
          }
        });
      }

      function createTestataCard(t, activeTerms) {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.testataKey = String(t?.id || "");

        const notesArr = normalizeNotes(t?.note);
        const notesCombined = combineNotes(notesArr);
        const notePreviewBaseRaw = (() => {
          if (!notesArr.length) return "nessuna nota";

          const best = findBestMatchTerm(notesCombined, activeTerms);
          if (best)
            return makeSnippet(notesCombined, best, NOTE_MATCH_MAX_CHARS);

          if (notesArr.length === 1) {
            if (notesCombined.length > NOTE_MAX_CHARS) {
              return makeSnippet(notesCombined, "", NOTE_MAX_CHARS);
            }
            return notesCombined;
          }

          return String(notesArr[0] || "");
        })();

        const hasHiddenNotesContent =
          notesArr.length > 1 ||
          (notesCombined &&
            notePreviewBaseRaw &&
            notesCombined.length > notePreviewBaseRaw.length);

        const noteDisplayRaw =
          notesArr.length &&
          hasHiddenNotesContent &&
          !notePreviewBaseRaw.endsWith("...")
            ? `${notePreviewBaseRaw}...`
            : notePreviewBaseRaw;

        const noteShowsEllipsis =
          notesArr.length &&
          typeof noteDisplayRaw === "string" &&
          noteDisplayRaw.includes("...");

        const highlightedNote = notesArr.length
          ? highlightHtmlMulti(noteDisplayRaw, activeTerms)
          : '<em class="muted">nessuna nota</em>';

        const mediaLabel = (() => {
          const p = String(t?.tipoMedia?.parent || "").trim();
          const c = String(t?.tipoMedia?.child || "").trim();
          return c || p || "";
        })();

        const journalistNamesRaw = (t?.redazione?.giornalisti || [])
          .map((jid) => getJournalistNameById(jid))
          .join(" • ");
        const testataJournalistsLabelHtml = `<a href="#" class="card-label-link card-testata-journalists-open" data-testata-key="${escapeHtml(
          String(t?.id || ""),
        )}">Giornalisti</a>`;

        const highlightedName = highlightHtmlMulti(
          String(t?.nome || ""),
          activeTerms,
        );
        const highlightedTelefono = highlightHtmlMulti(
          String(t?.telefono || ""),
          activeTerms,
        );
        const highlightedEmail = highlightHtmlMulti(
          String(t?.email || ""),
          activeTerms,
        );
        const highlightedJournalists = journalistNamesRaw
          ? highlightHtmlMulti(journalistNamesRaw, activeTerms)
          : '<span class="muted">n/d</span>';

        card.innerHTML = `
          <div class="card-top">
            <div class="card-name-row">
              <h3 class="card-name">${highlightedName}</h3>
              <a
                href="#"
                class="testata-link"
                data-testata-key="${escapeHtml(String(t?.id || ""))}"
                data-testata="${escapeHtml(String(t?.nome || ""))}"
              >
                scheda
              </a>
            </div>
            <p class="card-role">${escapeHtml(mediaLabel)}</p>
          </div>
          <div class="card-row"><div class="card-label">Telefono</div><div class="card-value">${highlightedTelefono}</div></div>
          <div class="card-row"><div class="card-label">E-mail</div><div class="card-value">${highlightedEmail}</div></div>
          <div class="card-row"><div class="card-label">${testataJournalistsLabelHtml}</div><div class="card-value muted card-journalists">${highlightedJournalists}</div></div>
        `;

        return card;
      }

      const testataOverlay = document.getElementById("testataOverlay");
      const testataPanel = document.getElementById("testataPanel");
      const testataPanelTitle = document.getElementById("testataPanelTitle");
      const testataPanelHeaderContent = document.getElementById(
        "testataPanelHeaderContent",
      );
      const testataPanelBody = document.getElementById("testataPanelBody");
      const testataPanelClose = document.getElementById("testataPanelClose");

      const chooseDatabaseLink = document.getElementById("chooseDatabaseLink");

      const selectAllLink = document.getElementById("selectAllLink");
      const bulkSelectControls = document.getElementById("bulkSelectControls");

      const sortByNameAscLink = document.getElementById("sortByNameAscLink");
      const sortByNameDescLink = document.getElementById("sortByNameDescLink");
      const sortByRoleLink = document.getElementById("sortByRoleLink");
      const sortByMediaTypeLink = document.getElementById(
        "sortByMediaTypeLink",
      );
      const sortByFrequencyLink = document.getElementById(
        "sortByFrequencyLink",
      );

      const sortByNameSelect = document.getElementById("sortByNameSelect");
      const sortByNameSelectTrigger = document.getElementById(
        "sortByNameSelectTrigger",
      );
      const sortByNameSelectMenu = document.getElementById(
        "sortByNameSelectMenu",
      );
      const sortByNameSelectValue = document.getElementById(
        "sortByNameSelectValue",
      );
      const sortByNameOptionAsc = document.getElementById(
        "sortByNameOptionAsc",
      );
      const sortByNameOptionDesc = document.getElementById(
        "sortByNameOptionDesc",
      );
      const sortByNameOptionRole = document.getElementById(
        "sortByNameOptionRole",
      );
      const sortByNameOptionMediaType = document.getElementById(
        "sortByNameOptionMediaType",
      );
      const sortByNameOptionFrequency = document.getElementById(
        "sortByNameOptionFrequency",
      );

      const notesModalOverlay = document.getElementById("notesModalOverlay");
      const notesModal = document.getElementById("notesModal");
      const notesModalTitle = document.getElementById("notesModalTitle");
      const notesModalBody = document.getElementById("notesModalBody");
      const notesModalClose = document.getElementById("notesModalClose");

      const selectedPanel = document.getElementById("selectedPanel");

      function openSelectedPanel() {
        selectedPanel.classList.add("show");
        selectedPanel.setAttribute("aria-hidden", "false");
        document.body.classList.add("selection-panel-open");
        renderSelectedPanelList();
      }

      function closeSelectedPanel() {
        selectedPanel.classList.remove("show");
        selectedPanel.setAttribute("aria-hidden", "true");
        document.body.classList.remove("selection-panel-open");
      }

      if (selectedClearAll) {
        selectedClearAll.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          selectedJournalistIds.clear();
          selectedJournalistOrder.length = 0;

          document.querySelectorAll(".card-select").forEach((el) => {
            el.checked = false;
          });
          document.querySelectorAll(".card.is-selected").forEach((el) => {
            el.classList.remove("is-selected");
          });

          renderSelectedPanelList();
          closeSelectedPanel();
        });
      }

      function initSplitButtons() {
        const splitButtons = document.querySelectorAll("[data-split-button]");
        for (const split of splitButtons) {
          if (split.hasAttribute("data-split-initialized")) continue;
          split.setAttribute("data-split-initialized", "");
          const toggle = split.querySelector("[data-split-toggle]");
          const menu = split.querySelector("[data-split-menu]");
          if (!toggle || !menu) continue;

          function closeMenu() {
            if (!menu.classList.contains("show")) return;
            menu.classList.remove("show");
            menu.setAttribute("aria-hidden", "true");
            toggle.setAttribute("aria-expanded", "false");
          }

          function toggleMenu() {
            const isOpen = menu.classList.contains("show");
            if (isOpen) {
              closeMenu();
            } else {
              menu.classList.add("show");
              menu.setAttribute("aria-hidden", "false");
              toggle.setAttribute("aria-expanded", "true");
            }
          }

          toggle.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleMenu();
          });

          document.addEventListener(
            "click",
            (e) => {
              if (!menu.classList.contains("show")) return;
              const t = e.target;
              if (split.contains(t)) return;
              closeMenu();
            },
            true,
          );

          document.addEventListener(
            "keydown",
            (e) => {
              if (e.key !== "Escape") return;
              if (!menu.classList.contains("show")) return;
              e.preventDefault();
              e.stopPropagation();
              closeMenu();
            },
            true,
          );

          split.addEventListener("click", (e) => {
            const actionEl = e.target.closest("[data-split-action]");
            if (!actionEl) return;
            if (!split.contains(actionEl)) return;

            const action = actionEl.getAttribute("data-split-action");
            if (!action) return;

            e.preventDefault();
            e.stopPropagation();
            closeMenu();

            split.dispatchEvent(
              new CustomEvent("split-button-action", {
                detail: { action },
                bubbles: true,
              }),
            );
          });
        }
      }

      initSplitButtons();

      if (selectedActionsSplit) {
        selectedActionsSplit.addEventListener(
          "split-button-action",
          (e) => {
            const action = e?.detail?.action;
            if (!action) return;

            if (action === "save-list") {
              openSaveListModal();
              return;
            }
            if (action === "add-to-list") {
              openAddToListModal();
              return;
            }
            if (action === "add-to-shipment") {
              openAddToShipmentModal();
              return;
            }
            if (action === "add-to-new-shipment") {
              openAddToNewShipmentModal();
              return;
            }
          },
          true,
        );
      }

      if (saveListModalClose) {
        saveListModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeSaveListModal();
        });
      }

      if (saveListModalOverlay) {
        saveListModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeSaveListModal();
        });
      }

      if (shareListModalClose) {
        shareListModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeShareListModal();
        });
      }

      if (shareListModalOverlay) {
        shareListModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeShareListModal();
        });
      }

      if (shareListConfirm) {
        shareListConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const activeList = getMailingListById(appState.activeMailingListId);
          if (!activeList || !shareListUsers) return;

          const checked = Array.from(
            shareListUsers.querySelectorAll(
              'input[type="checkbox"][data-colleague-id]',
            ),
          )
            .filter((cb) => cb.checked)
            .map((cb) => cb.getAttribute("data-colleague-id"))
            .map((x) => String(x || "").trim())
            .filter(Boolean);

          activeList.sharedWith = checked;
          saveAppState(appState);
          closeShareListModal();
          scheduleRender();
        });
      }

      if (addToListModalClose) {
        addToListModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeAddToListModal();
        });
      }

      if (addToListModalOverlay) {
        addToListModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeAddToListModal();
        });
      }

      if (addToShipmentModalClose) {
        addToShipmentModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeAddToShipmentModal();
        });
      }

      if (addToShipmentModalOverlay) {
        addToShipmentModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeAddToShipmentModal();
        });
      }

      if (addToNewShipmentModalClose) {
        addToNewShipmentModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeAddToNewShipmentModal();
        });
      }

      if (addToNewShipmentModalOverlay) {
        addToNewShipmentModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeAddToNewShipmentModal();
        });
      }

      if (addToListConfirm) {
        addToListConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const selectedName = Array.from(
            addToListDropdown.selectedValues || [],
          )
            .map((x) => String(x || "").trim())
            .filter(Boolean)[0];
          if (!selectedName) {
            if (addToListError) addToListError.style.display = "block";
            return;
          }

          const list = getMailingListByName(selectedName);
          if (!list) {
            if (addToListError) addToListError.style.display = "block";
            return;
          }

          const current = new Set(
            Array.isArray(list.journalistIds)
              ? list.journalistIds.map((x) => String(x || "").trim())
              : [],
          );
          const targets =
            Array.isArray(addToListTargetJids) && addToListTargetJids.length
              ? addToListTargetJids
              : selectedJournalistOrder;
          for (const jid of targets) {
            current.add(String(jid || "").trim());
          }
          list.journalistIds = Array.from(current).filter(Boolean);

          saveAppState(appState);
          closeAddToListModal();

          const usedSnapshot =
            Array.isArray(targets) && targets !== selectedJournalistOrder;
          if (!usedSnapshot) {
            selectedJournalistIds.clear();
            selectedJournalistOrder.length = 0;
            renderSelectedPanelList();
            closeSelectedPanel();
          }
          scheduleRender();

          openMailingListById(list.id);
        });
      }

      if (addToShipmentConfirm) {
        addToShipmentConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const selectedName = Array.from(
            addToShipmentDropdown.selectedValues || [],
          )
            .map((x) => String(x || "").trim())
            .filter(Boolean)[0];
          if (!selectedName) {
            if (addToShipmentError) addToShipmentError.style.display = "block";
            return;
          }

          const shipment = getSpedizioneByName(selectedName);
          if (!shipment) {
            if (addToShipmentError) addToShipmentError.style.display = "block";
            return;
          }

          const current = new Set(
            Array.isArray(shipment.journalistIds)
              ? shipment.journalistIds.map((x) => String(x || "").trim())
              : [],
          );
          const targets =
            Array.isArray(addToShipmentTargetJids) &&
            addToShipmentTargetJids.length
              ? addToShipmentTargetJids
              : selectedJournalistOrder;
          for (const jid of targets) {
            current.add(String(jid || "").trim());
          }
          shipment.journalistIds = Array.from(current).filter(Boolean);

          saveAppState(appState);
          closeAddToShipmentModal();

          const usedSnapshot =
            Array.isArray(targets) && targets !== selectedJournalistOrder;
          if (!usedSnapshot) {
            selectedJournalistIds.clear();
            selectedJournalistOrder.length = 0;
            renderSelectedPanelList();
            closeSelectedPanel();
          }
          scheduleRender();
        });
      }

      if (addToNewShipmentConfirm) {
        addToNewShipmentConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const rawName = String(addToNewShipmentNameInput?.value || "").trim();
          if (!rawName) {
            if (addToNewShipmentError)
              addToNewShipmentError.style.display = "block";
            if (addToNewShipmentNameInput) addToNewShipmentNameInput.focus();
            return;
          }
          if (addToNewShipmentError)
            addToNewShipmentError.style.display = "none";

          const selectionSnapshot = selectedJournalistOrder.filter((jid) =>
            selectedJournalistIds.has(jid),
          );
          const uniqueName = computeUniqueSpedizioneName(rawName);

          const shipment = {
            name: uniqueName,
            journalistIds: Array.from(selectionSnapshot || []),
            createdAt: Date.now(),
          };
          if (!Array.isArray(appState.spedizioni)) {
            appState.spedizioni = [];
          }
          appState.spedizioni.unshift(shipment);
          saveAppState(appState);
          closeAddToNewShipmentModal();

          selectedJournalistIds.clear();
          selectedJournalistOrder.length = 0;
          renderSelectedPanelList();
          closeSelectedPanel();
          scheduleRender();
        });
      }

      function confirmSaveList() {
        const rawName = String(saveListNameInput?.value || "").trim();
        if (!rawName) {
          if (saveListError) saveListError.style.display = "block";
          if (saveListNameInput) saveListNameInput.focus();
          return;
        }
        if (saveListError) saveListError.style.display = "none";

        if (saveListModalMode === "rename") {
          const targetId = String(saveListModalTargetId || "").trim();
          if (!targetId) return;
          if (!Array.isArray(appState.mailingLists)) return;

          const idx = appState.mailingLists.findIndex(
            (ml) => String(ml?.id || "") === targetId,
          );
          if (idx === -1) return;

          appState.mailingLists[idx] = {
            ...appState.mailingLists[idx],
            name: rawName,
          };
          saveAppState(appState);

          closeSaveListModal();
          scheduleRender();
          return;
        }

        const selectionSnapshot = selectedJournalistOrder.filter((jid) =>
          selectedJournalistIds.has(jid),
        );

        const uniqueName = computeUniqueMailingListName(rawName);
        createMailingList(uniqueName, selectionSnapshot);

        selectedJournalistIds.clear();
        selectedJournalistOrder.splice(0, selectedJournalistOrder.length);
        renderSelectedPanelList();
        closeSelectedPanel();

        closeSaveListModal();

        window.location.hash = "#mailing-list";
        setActiveView("mailing-list", { save: true });
        scheduleRender();
      }

      if (saveListConfirm) {
        saveListConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          confirmSaveList();
        });
      }

      if (saveListNameInput) {
        saveListNameInput.addEventListener("input", () => {
          if (!saveListError) return;
          if (String(saveListNameInput.value || "").trim()) {
            saveListError.style.display = "none";
          }
        });

        saveListNameInput.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          e.preventDefault();
          e.stopPropagation();
          confirmSaveList();
        });
      }

      function updateTextFilterClearVisibility() {
        if (!textFilterClear || !textFilterInput) return;
        if (
          (textFilterInput.value || "").trim().length > 0 ||
          committedTextTerms.length > 0
        ) {
          textFilterClear.classList.add("show");
        } else {
          textFilterClear.classList.remove("show");
        }
      }

      function closeAllFilterableDropdowns() {
        for (const inst of FilterableDropdown._instances || []) {
          if (inst?.isOpen) {
            inst.close();
          }
        }
      }

      if (textFilterInput) {
        textFilterInput.addEventListener("focus", () => {
          closeAllFilterableDropdowns();
        });

        textFilterInput.addEventListener("click", () => {
          closeAllFilterableDropdowns();
        });

        textFilterInput.addEventListener("input", () => {
          updateTextFilterClearVisibility();
          scheduleRender();
        });

        textFilterInput.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          const term = String(textFilterInput.value || "").trim();
          if (!term) return;

          e.preventDefault();
          e.stopPropagation();

          const k = term.toLowerCase();
          const exists = committedTextTerms.some(
            (t) =>
              String(t || "")
                .trim()
                .toLowerCase() === k,
          );
          if (!exists) {
            committedTextTerms.unshift(term);
          }

          textFilterInput.value = "";
          updateTextFilterClearVisibility();
          scheduleRender();
        });
      }

      if (textFilterClear) {
        textFilterClear.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!textFilterInput) return;
          textFilterInput.value = "";
          committedTextTerms.splice(0, committedTextTerms.length);
          updateTextFilterClearVisibility();
          scheduleRender();
        });
      }

      function openTestataPanel(testata) {
        if (testataPanelTitle) testataPanelTitle.textContent = "Testata";
        {
          const panelHeaderEl = testataPanelHeaderContent?.closest?.(
            ".testata-panel-header",
          );
          if (panelHeaderEl) {
            const existing = panelHeaderEl.querySelector(
              "[data-journalist-header-contacts]",
            );
            if (existing) existing.remove();
          }
        }

        if (testataPanelHeaderContent) {
          testataPanelHeaderContent.innerHTML = "";
          if (testataPanelTitle)
            testataPanelHeaderContent.appendChild(testataPanelTitle);
        }
        testataPanelBody.innerHTML = "";

        const raw = String(testata || "").trim();
        const key = normalizeTestataKey(raw);

        const t = (testate || []).find((x) => {
          if (!x) return false;
          const idOk =
            String(x?.id || "") === raw || String(x?.id || "") === key;
          if (idOk) return true;
          const nameOk =
            normalizeTestataKey(String(x?.nome || "")) === key ||
            String(x?.nome || "")
              .trim()
              .toLowerCase() === raw.toLowerCase();
          return nameOk;
        });

        if (!t) {
          testataPanelBody.textContent = `testata: ${testata}`;
        } else {
          if (testataPanelTitle)
            testataPanelTitle.textContent = String(t?.nome || "Testata");

          const normalizeTextHeader = (v) => String(v ?? "").trim();

          const header = document.createElement("div");
          header.className = "journalist-sheet__header";

          const titleRow = document.createElement("div");
          titleRow.className = "journalist-sheet__title-row";

          const title = document.createElement("div");
          title.className = "journalist-sheet__title";
          title.textContent = String(t?.nome || "Testata");

          titleRow.appendChild(title);
          header.appendChild(titleRow);

          const meta = document.createElement("div");
          meta.className = "journalist-sheet__meta";

          const metaDate = document.createElement("span");
          metaDate.className = "t-value";
          metaDate.textContent = "25/7/2025";

          const metaText = document.createElement("span");
          metaText.className = "t-label";
          metaText.textContent = "aggiornamento M_";

          meta.appendChild(metaDate);
          meta.appendChild(metaText);

          if (testataPanelHeaderContent) {
            testataPanelHeaderContent.innerHTML = "";
            testataPanelHeaderContent.appendChild(header);
            testataPanelHeaderContent.appendChild(meta);
          }

          const contactsSummary = document.createElement("table");
          contactsSummary.className = "journalist-contact-table";
          contactsSummary.setAttribute("data-journalist-header-contacts", "");
          {
            const colgroup = document.createElement("colgroup");
            const col1 = document.createElement("col");
            col1.style.width = "24ch";
            const col2 = document.createElement("col");
            col2.style.width = "16ch";
            colgroup.appendChild(col1);
            colgroup.appendChild(col2);
            contactsSummary.appendChild(colgroup);

            const tbody = document.createElement("tbody");
            contactsSummary.appendChild(tbody);

            const makeRow = (key, value, label) => {
              const tr = document.createElement("tr");

              const tdValue = document.createElement("td");
              const sValue = document.createElement("span");
              sValue.className = "journalist-contact-cell t-value";
              sValue.setAttribute("data-header-contact", `${key}-value`);
              sValue.textContent = normalizeTextHeader(value) || "n/d";
              tdValue.appendChild(sValue);

              const tdLabel = document.createElement("td");
              const sLabel = document.createElement("span");
              sLabel.className = "journalist-contact-cell t-label";
              sLabel.setAttribute("data-header-contact", `${key}-label`);
              sLabel.textContent = normalizeTextHeader(label) || "";
              tdLabel.appendChild(sLabel);

              tr.appendChild(tdValue);
              tr.appendChild(tdLabel);
              return tr;
            };

            tbody.appendChild(makeRow("phone", t?.telefono, "telefono"));
            tbody.appendChild(makeRow("email", t?.email, "mail"));
          }

          {
            const panelHeaderEl = testataPanelHeaderContent?.closest?.(
              ".testata-panel-header",
            );
            if (panelHeaderEl && testataPanelClose) {
              const existing = panelHeaderEl.querySelector(
                "[data-journalist-header-contacts]",
              );
              if (existing) existing.remove();
              panelHeaderEl.insertBefore(contactsSummary, testataPanelClose);
            }
          }

          const addRow = (labelText, valueNode) => {
            const row = document.createElement("div");
            row.className = "card-row";

            const label = document.createElement("div");
            label.className = "card-label";
            label.textContent = labelText;

            const value = document.createElement("div");
            value.className = "card-value";
            if (valueNode) {
              value.appendChild(valueNode);
            }

            row.appendChild(label);
            row.appendChild(value);
            testataPanelBody.appendChild(row);
          };

          {
            const notesSection = document.createElement("section");
            notesSection.className = "journalist-section";
            notesSection.setAttribute("data-testata-notes", "");
            notesSection.setAttribute(
              "data-testata-key",
              String(t?.id || key || raw).trim(),
            );

            const notesHeader = document.createElement("div");
            notesHeader.className =
              "journalist-section__header journalist-section__header--collapsible";
            notesHeader.setAttribute("data-section-toggle", "testata-notes");
            notesHeader.setAttribute("role", "button");
            notesHeader.setAttribute("tabindex", "0");

            const notesTitle = document.createElement("div");
            notesTitle.className = "journalist-section__title";

            const notesHeading = document.createElement("h3");
            notesHeading.className = "journalist-section__heading";
            notesHeading.textContent = "NOTE";
            notesTitle.appendChild(notesHeading);

            const addNote = document.createElement("a");
            addNote.href = "#";
            addNote.className = "c-link c-link--action";
            addNote.textContent = "aggiungi nota";
            addNote.setAttribute("data-note-action", "add");
            notesTitle.appendChild(addNote);

            notesHeader.appendChild(notesTitle);

            const notesOpen = getSectionOpen("testata-notes", false);
            notesHeader.setAttribute(
              "aria-expanded",
              notesOpen ? "true" : "false",
            );

            const notesToggle = document.createElement("span");
            notesToggle.className = "journalist-section__toggle";
            notesToggle.textContent = notesOpen ? "-" : "+";
            notesToggle.setAttribute("aria-hidden", "true");
            notesHeader.appendChild(notesToggle);

            const notesList = document.createElement("div");
            notesList.className = "journalist-notes";
            notesList.setAttribute("data-note-list", "");

            const notesEditor = document.createElement("div");
            notesEditor.className = "journalist-note-editor";
            notesEditor.setAttribute("data-note-editor", "");
            notesEditor.hidden = true;

            const notesTextarea = document.createElement("textarea");
            notesTextarea.className = "journalist-note-textarea";
            notesTextarea.setAttribute("data-note-textarea", "");

            const notesEditorActions = document.createElement("div");
            notesEditorActions.className = "journalist-note-editor-actions";

            const notesOk = document.createElement("a");
            notesOk.href = "#";
            notesOk.className = "c-link c-link--action";
            notesOk.textContent = "ok";
            notesOk.setAttribute("data-note-action", "ok");

            const notesCancel = document.createElement("a");
            notesCancel.href = "#";
            notesCancel.className = "c-link c-link--action";
            notesCancel.textContent = "annulla";
            notesCancel.setAttribute("data-note-action", "cancel");

            notesEditorActions.appendChild(notesOk);
            notesEditorActions.appendChild(notesCancel);
            notesEditor.appendChild(notesTextarea);
            notesEditor.appendChild(notesEditorActions);

            const renderNotesList = (arr) => {
              notesList.innerHTML = "";
              const items = normalizeNoteItems(arr);
              if (!items.length) {
                const empty = document.createElement("div");
                empty.className = "muted";
                empty.textContent = "nessuna nota";
                notesList.appendChild(empty);
                return;
              }

              for (let i = 0; i < items.length; i++) {
                const itemText = items[i]?.text;
                const itemDate = items[i]?.updatedAt;
                const item = document.createElement("div");
                item.className = "journalist-note-item";
                item.setAttribute("data-note-index", String(i));

                const text = document.createElement("div");
                text.className = "journalist-note-text t-value";
                text.textContent = itemText;

                const footer = document.createElement("div");
                footer.className = "journalist-note-footer";

                const date = document.createElement("span");
                date.className = "t-value";
                date.textContent = formatNoteDate(itemDate);

                const edit = document.createElement("a");
                edit.href = "#";
                edit.className = "c-link c-link--action";
                edit.textContent = "modifica";
                edit.setAttribute("data-note-action", "edit");

                const remove = document.createElement("a");
                remove.href = "#";
                remove.className = "c-link c-link--action";
                remove.textContent = "rimuovi";
                remove.setAttribute("data-note-action", "remove");

                footer.appendChild(date);
                footer.appendChild(edit);
                footer.appendChild(remove);

                item.appendChild(text);
                item.appendChild(footer);
                notesList.appendChild(item);
              }
            };

            renderNotesList(t?.note);

            const notesBody = document.createElement("div");
            notesBody.className = "journalist-section__body";
            notesBody.setAttribute("data-section-body", "");
            notesBody.hidden = !notesOpen;
            notesBody.appendChild(notesEditor);
            notesBody.appendChild(notesList);

            notesSection.appendChild(notesHeader);
            notesSection.appendChild(notesBody);
            testataPanelBody.appendChild(notesSection);
          }

          {
            const section = document.createElement("section");
            section.className = "journalist-section";
            section.setAttribute("data-testata-dati", "");

            const sectionHeader = document.createElement("div");
            sectionHeader.className =
              "journalist-section__header journalist-section__header--collapsible";
            sectionHeader.setAttribute("data-section-toggle", "testata-dati");
            sectionHeader.setAttribute("role", "button");
            sectionHeader.setAttribute("tabindex", "0");

            const titleWrap = document.createElement("div");
            titleWrap.className = "journalist-section__title";

            const heading = document.createElement("h3");
            heading.className = "journalist-section__heading";
            heading.textContent = "DATI TESTATA";
            titleWrap.appendChild(heading);

            sectionHeader.appendChild(titleWrap);

            const sectionOpen = getSectionOpen("testata-dati", false);
            sectionHeader.setAttribute(
              "aria-expanded",
              sectionOpen ? "true" : "false",
            );

            const toggle = document.createElement("span");
            toggle.className = "journalist-section__toggle";
            toggle.textContent = sectionOpen ? "-" : "+";
            toggle.setAttribute("aria-hidden", "true");
            sectionHeader.appendChild(toggle);

            const body = document.createElement("div");
            body.className = "journalist-section__body";
            body.setAttribute("data-section-body", "");
            body.hidden = !sectionOpen;

            const table = document.createElement("table");
            table.className = "journalist-contact-table";
            {
              const colgroup = document.createElement("colgroup");
              const col1 = document.createElement("col");
              col1.style.width = "24ch";
              const col2 = document.createElement("col");
              col2.style.width = "48ch";
              colgroup.appendChild(col1);
              colgroup.appendChild(col2);
              table.appendChild(colgroup);

              const tbody = document.createElement("tbody");
              table.appendChild(tbody);

              const makeRow = (label, value) => {
                const tr = document.createElement("tr");

                const tdLabel = document.createElement("td");
                const sLabel = document.createElement("span");
                sLabel.className = "journalist-contact-cell t-label";
                sLabel.textContent = normalizeTextHeader(label) || "";
                tdLabel.appendChild(sLabel);

                const tdValue = document.createElement("td");
                const sValue = document.createElement("span");
                sValue.className = "journalist-contact-cell t-value";
                sValue.textContent = normalizeTextHeader(value) || "n/d";
                tdValue.appendChild(sValue);

                tr.appendChild(tdLabel);
                tr.appendChild(tdValue);
                return tr;
              };

              const p = String(t?.tipoMedia?.parent || "").trim();
              const c = String(t?.tipoMedia?.child || "").trim();
              const mediaText = p && c ? `${p} / ${c}` : p || c;

              tbody.appendChild(makeRow("Editore", t?.editore));
              tbody.appendChild(makeRow("Tipo di media", mediaText));
              tbody.appendChild(
                makeRow("frequenza", t?.frequenzaPubblicazione),
              );
              tbody.appendChild(makeRow("Argomento", t?.argomento));
              tbody.appendChild(makeRow("Tiratura", t?.tiratura));
              tbody.appendChild(makeRow("Diffusione", t?.diffusione));
              tbody.appendChild(
                makeRow("Dati pubblicitari", t?.datiPubblicitari),
              );
            }

            body.appendChild(table);
            section.appendChild(sectionHeader);
            section.appendChild(body);
            testataPanelBody.appendChild(section);
          }

          {
            const redazioniSection = document.createElement("section");
            redazioniSection.className = "journalist-section";
            redazioniSection.setAttribute("data-testata-redazioni", "");

            const redazioniHeader = document.createElement("div");
            redazioniHeader.className =
              "journalist-section__header journalist-section__header--collapsible";
            redazioniHeader.setAttribute(
              "data-section-toggle",
              "testata-redazioni",
            );
            redazioniHeader.setAttribute("role", "button");
            redazioniHeader.setAttribute("tabindex", "0");

            const titleWrap = document.createElement("div");
            titleWrap.className = "journalist-section__title";
            {
              const heading = document.createElement("h3");
              heading.className = "journalist-section__heading";
              heading.textContent = "REDAZIONI";
              titleWrap.appendChild(heading);
            }
            redazioniHeader.appendChild(titleWrap);

            const sectionOpen = getSectionOpen("testata-redazioni", false);
            redazioniHeader.setAttribute(
              "aria-expanded",
              sectionOpen ? "true" : "false",
            );

            const toggle = document.createElement("span");
            toggle.className = "journalist-section__toggle";
            toggle.textContent = sectionOpen ? "-" : "+";
            toggle.setAttribute("aria-hidden", "true");
            redazioniHeader.appendChild(toggle);

            const redazioniBody = document.createElement("div");
            redazioniBody.className = "journalist-section__body";
            redazioniBody.setAttribute("data-section-body", "");
            redazioniBody.hidden = !sectionOpen;

            const tree = document.createElement("div");
            tree.className = "redazioni-tree";

            const makePropsList = (rows) => {
              const wrap = document.createElement("div");
              wrap.className = "redazioni-props";

              for (const [labelText, valueText] of rows || []) {
                const row = document.createElement("div");
                row.className = "card-row";

                const label = document.createElement("div");
                label.className = "card-label";
                label.textContent = normalizeTextHeader(labelText) || "";

                const value = document.createElement("div");
                value.className = "card-value";
                value.textContent = normalizeTextHeader(valueText) || "n/d";

                row.appendChild(label);
                row.appendChild(value);
                wrap.appendChild(row);
              }

              return wrap;
            };

            const makeNode = (titleText, toggleKey, defaultOpen, contentEl) => {
              const node = document.createElement("div");
              node.className = "redazioni-node";
              node.setAttribute("data-redazioni-node", "");

              const btn = document.createElement("button");
              btn.type = "button";
              btn.className = "redazioni-node__toggle";
              btn.setAttribute("data-redazioni-toggle", toggleKey);
              const open = getSectionOpen(toggleKey, !!defaultOpen);
              btn.setAttribute("aria-expanded", open ? "true" : "false");

              const title = document.createElement("span");
              title.className = "redazioni-node__title";
              title.textContent = titleText;

              const caret = document.createElement("span");
              caret.className = "redazioni-caret";
              caret.setAttribute("aria-hidden", "true");

              btn.appendChild(title);
              btn.appendChild(caret);

              const body = document.createElement("div");
              body.className = "redazioni-node__body";
              body.setAttribute("data-redazioni-body", "");
              body.hidden = !open;
              if (contentEl) body.appendChild(contentEl);

              node.appendChild(btn);
              node.appendChild(body);
              return node;
            };

            const rcId = String(t?.redazioneCentraleId || "").trim();
            const rc = rcId ? redazioniCentraliById.get(rcId) : null;

            if (!rc) {
              const empty = document.createElement("div");
              empty.className = "muted";
              empty.textContent = "n/d";
              tree.appendChild(empty);
            } else {
              {
                const wrap = document.createElement("div");
                wrap.className = "redazioni-node__content";
                wrap.appendChild(
                  makePropsList([
                    ["indirizzo", rc.indirizzo],
                    ["email", rc.email],
                    ["telefono", rc.telefono],
                  ]),
                );

                const topicsWrap = document.createElement("div");
                topicsWrap.className = "redazioni-children";

                for (const a of rc.argomenti || []) {
                  const childWrap = document.createElement("div");
                  childWrap.className = "redazioni-node__content";
                  childWrap.appendChild(
                    makePropsList([
                      ["email", a?.email],
                      ["telefono", a?.telefono],
                    ]),
                  );
                  topicsWrap.appendChild(
                    makeNode(
                      String(a?.nome || "").trim(),
                      `redazioni:${rc.id}:argomento:${String(a?.id || "").trim()}`,
                      false,
                      childWrap,
                    ),
                  );
                }

                wrap.appendChild(topicsWrap);
                tree.appendChild(
                  makeNode(
                    "redazione centrale",
                    `redazioni:${rc.id}:centrale`,
                    true,
                    wrap,
                  ),
                );
              }

              {
                const groupWrap = document.createElement("div");
                groupWrap.className = "redazioni-children";
                for (const l of rc.locali || []) {
                  const childWrap = document.createElement("div");
                  childWrap.className = "redazioni-node__content";
                  childWrap.appendChild(
                    makePropsList([
                      ["indirizzo", l?.indirizzo],
                      ["email", l?.email],
                      ["telefono", l?.telefono],
                    ]),
                  );
                  groupWrap.appendChild(
                    makeNode(
                      String(l?.citta || "").trim(),
                      `redazioni:${rc.id}:locale:${String(l?.id || "").trim()}`,
                      false,
                      childWrap,
                    ),
                  );
                }
                tree.appendChild(
                  makeNode(
                    "redazioni locali",
                    `redazioni:${rc.id}:locali`,
                    false,
                    groupWrap,
                  ),
                );
              }

              {
                const groupWrap = document.createElement("div");
                groupWrap.className = "redazioni-children";
                for (const x of rc.estere || []) {
                  const childWrap = document.createElement("div");
                  childWrap.className = "redazioni-node__content";
                  childWrap.appendChild(
                    makePropsList([
                      ["indirizzo", x?.indirizzo],
                      ["email", x?.email],
                      ["telefono", x?.telefono],
                    ]),
                  );
                  groupWrap.appendChild(
                    makeNode(
                      String(x?.citta || "").trim(),
                      `redazioni:${rc.id}:estera:${String(x?.id || "").trim()}`,
                      false,
                      childWrap,
                    ),
                  );
                }
                tree.appendChild(
                  makeNode(
                    "redazioni estere",
                    `redazioni:${rc.id}:estere`,
                    false,
                    groupWrap,
                  ),
                );
              }
            }

            redazioniBody.appendChild(tree);
            redazioniSection.appendChild(redazioniHeader);
            redazioniSection.appendChild(redazioniBody);
            testataPanelBody.appendChild(redazioniSection);
          }

          const email = document.createElement("span");
          email.textContent = String(t?.email || "");
          addRow("E-mail", email);

          const telefono = document.createElement("span");
          telefono.textContent = String(t?.telefono || "");
          addRow("Telefono", telefono);

          const listWrap = document.createElement("div");
          const jids = [...(t?.redazione?.giornalisti || [])].filter(Boolean);
          if (!jids.length) {
            const empty = document.createElement("div");
            empty.className = "muted";
            empty.textContent = "nessun giornalista";
            listWrap.appendChild(empty);
          } else {
            const table = document.createElement("table");
            table.className = "testata-panel-journalists-table";

            const thead = document.createElement("thead");
            const headRow = document.createElement("tr");
            const headers = ["", "Nome", "Servizio", "Ruolo", "Tel", "Email"];
            for (const h of headers) {
              const th = document.createElement("th");
              th.textContent = h;
              headRow.appendChild(th);
            }
            thead.appendChild(headRow);

            const tbody = document.createElement("tbody");

            const rows = jids
              .map((jid) => {
                const j = (journalists || []).find(
                  (x) => getJournalistId(x) === jid,
                );
                const name = j
                  ? `${String(j?.nome || "").trim()} ${String(
                      j?.cognome || "",
                    ).trim()}`.trim()
                  : getJournalistNameById(jid);
                return {
                  jid,
                  name,
                  servizio: j ? String(j?.servizio || "") : "",
                  ruolo: j ? String(j?.ruolo || "") : "",
                  tel: j ? String(j?.telefono || "") : "",
                  email: j ? String(j?.email || "") : "",
                };
              })
              .sort((a, b) =>
                String(a.name || "").localeCompare(String(b.name || ""), "it", {
                  sensitivity: "base",
                }),
              );

            for (const item of rows) {
              const jid = item.jid;

              const tr = document.createElement("tr");

              const checkboxId = `testata-panel-select-${jid.replace(
                /[^a-zA-Z0-9_-]/g,
                "_",
              )}`;

              const tdCb = document.createElement("td");
              const cb = document.createElement("input");
              cb.type = "checkbox";
              cb.className = "testata-panel-select";
              cb.id = checkboxId;
              cb.setAttribute("data-jid", jid);
              cb.checked = selectedJournalistIds.has(jid);
              cb.addEventListener("change", (e) => {
                e.stopPropagation();
                if (cb.checked) {
                  selectedJournalistIds.add(jid);
                  ensureSelectedOrder(jid);
                  openSelectedPanel();
                } else {
                  selectedJournalistIds.delete(jid);
                  removeFromSelectedOrder(jid);
                  if (selectedJournalistIds.size === 0) {
                    closeSelectedPanel();
                  } else {
                    renderSelectedPanelList();
                  }
                }
                updateCheckboxUI(jid);
                updateCardSelectionUI(jid);
              });
              tdCb.appendChild(cb);

              const tdName = document.createElement("td");
              const nameLink = document.createElement("a");
              nameLink.href = "#";
              nameLink.className = "testata-link journalist-link";
              nameLink.textContent = item.name;
              nameLink.setAttribute("data-journalist", item.name);
              tdName.appendChild(nameLink);

              const tdServizio = document.createElement("td");
              tdServizio.textContent = item.servizio;

              const tdRuolo = document.createElement("td");
              tdRuolo.textContent = item.ruolo;

              const tdTel = document.createElement("td");
              tdTel.textContent = item.tel;

              const tdEmail = document.createElement("td");
              tdEmail.textContent = item.email;

              tr.appendChild(tdCb);
              tr.appendChild(tdName);
              tr.appendChild(tdServizio);
              tr.appendChild(tdRuolo);
              tr.appendChild(tdTel);
              tr.appendChild(tdEmail);
              tbody.appendChild(tr);
            }

            table.appendChild(thead);
            table.appendChild(tbody);
            listWrap.appendChild(table);
          }

          addRow("Giornalisti", listWrap);
        }

        testataOverlay.classList.add("show");
        testataPanel.classList.add("show");
        testataOverlay.setAttribute("aria-hidden", "false");
        testataPanel.setAttribute("aria-hidden", "false");
      }

      function openBancaDatiPanel() {
        if (testataPanelTitle) testataPanelTitle.textContent = "Banca dati";
        {
          const panelHeaderEl = testataPanelHeaderContent?.closest?.(
            ".testata-panel-header",
          );
          if (panelHeaderEl) {
            const existing = panelHeaderEl.querySelector(
              "[data-journalist-header-contacts]",
            );
            if (existing) existing.remove();
          }
        }
        if (testataPanelHeaderContent) {
          testataPanelHeaderContent.innerHTML = "";
          if (testataPanelTitle)
            testataPanelHeaderContent.appendChild(testataPanelTitle);
        }
        testataPanelBody.innerHTML = "";

        const empty = document.createElement("em");
        empty.className = "muted";
        empty.textContent = "elenco banche dati";
        testataPanelBody.appendChild(empty);

        testataOverlay.classList.add("show");
        testataPanel.classList.add("show");
        testataOverlay.setAttribute("aria-hidden", "false");
        testataPanel.setAttribute("aria-hidden", "false");
      }

      function openJournalistPanel(journalistName) {
        if (testataPanelTitle) testataPanelTitle.textContent = "Giornalista";
        testataPanelBody.innerHTML = "";

        const fullNameKey = String(journalistName || "")
          .trim()
          .toLowerCase();

        const j = (journalists || []).find((x) => {
          const k = `${String(x?.nome || "").trim()} ${String(
            x?.cognome || "",
          ).trim()}`
            .trim()
            .toLowerCase();
          return k === fullNameKey;
        });

        if (!j) {
          testataPanelBody.textContent = `giornalista: ${journalistName}`;
        } else {
          const jid = getJournalistId(j);
          const checkboxId = `journalist-panel-select-${jid.replace(
            /[^a-zA-Z0-9_-]/g,
            "_",
          )}`;

          const sheet = document.createElement("div");
          sheet.className = "journalist-sheet";

          const header = document.createElement("div");
          header.className = "journalist-sheet__header";

          const titleRow = document.createElement("div");
          titleRow.className = "journalist-sheet__title-row";

          const select = document.createElement("input");
          select.type = "checkbox";
          select.className = "card-select";
          select.id = checkboxId;
          select.checked = selectedJournalistIds.has(jid);
          select.addEventListener("change", (e) => {
            e.stopPropagation();

            if (select.checked) {
              selectedJournalistIds.add(jid);
              ensureSelectedOrder(jid);
              openSelectedPanel();
            } else {
              selectedJournalistIds.delete(jid);
              removeFromSelectedOrder(jid);
              if (selectedJournalistIds.size === 0) {
                closeSelectedPanel();
              } else {
                renderSelectedPanelList();
              }
            }

            updateCheckboxUI(jid);
            updateCardSelectionUI(jid);
          });

          const title = document.createElement("label");
          title.className = "journalist-sheet__title";
          title.setAttribute("for", checkboxId);
          title.textContent = `${j.nome} ${j.cognome}`;

          titleRow.appendChild(select);
          titleRow.appendChild(title);

          const titleActions = document.createElement("span");
          titleActions.className = "journalist-sheet__title-actions";

          const split = document.createElement("span");
          split.className = "c-split-button c-split-button--menu-left";
          split.setAttribute("data-split-button", "");

          const splitMain = document.createElement("button");
          splitMain.type = "button";
          splitMain.className = "c-split-button__main c-link c-link--nav";
          splitMain.textContent = "aggiungi a lista";
          splitMain.setAttribute("data-split-action", "add-to-list");

          const splitToggle = document.createElement("button");
          splitToggle.type = "button";
          splitToggle.className = "c-split-button__toggle";
          splitToggle.setAttribute("data-split-toggle", "");
          splitToggle.setAttribute("aria-haspopup", "listbox");
          splitToggle.setAttribute("aria-expanded", "false");
          splitToggle.innerHTML =
            '<span class="c-split-button__arrow" aria-hidden="true"></span>';

          const splitMenu = document.createElement("div");
          splitMenu.className = "dropdown-list c-split-button__menu";
          splitMenu.setAttribute("data-split-menu", "");
          splitMenu.setAttribute("role", "listbox");
          splitMenu.setAttribute("aria-hidden", "true");

          const results = document.createElement("div");
          results.className = "dropdown-results";

          const item = document.createElement("div");
          item.className = "dropdown-item";
          item.setAttribute("role", "option");

          const opt = document.createElement("a");
          opt.href = "#";
          opt.className = "c-link c-link--nav";
          opt.textContent = "aggiungi a spedizione";
          opt.setAttribute("data-split-action", "add-to-shipment");

          item.appendChild(opt);
          results.appendChild(item);
          splitMenu.appendChild(results);

          split.appendChild(splitMain);
          split.appendChild(splitToggle);
          split.appendChild(splitMenu);

          titleActions.appendChild(split);

          const normalizeArrHeader = (v) => (Array.isArray(v) ? v : []);
          const normalizeTextHeader = (v) => String(v ?? "").trim();

          const getJournalistRoleForTestata = (j, testataName) => {
            return String(j?.ruolo || "").trim();
          };

          const getJournalistServiceForTestata = (j, testataName) => {
            return String(j?.servizio || "").trim();
          };

          const getWordCloudTermsForService = (service) => {
            const s = String(service || "")
              .trim()
              .toLowerCase();

            if (s.includes("agric")) {
              return [
                { text: "PAC", size: 24 },
                { text: "filiera", size: 22 },
                { text: "sostenibilità", size: 20 },
                { text: "zootecnia", size: 18 },
                { text: "irrigazione", size: 18 },
                { text: "prezzi", size: 16 },
                { text: "consorzi", size: 16 },
                { text: "produzione", size: 15 },
                { text: "fitofarmaci", size: 14 },
                { text: "export", size: 14 },
                { text: "raccolto", size: 13 },
                { text: "dati", size: 12 },
              ];
            }

            if (
              s.includes("software") ||
              s.includes("it") ||
              s.includes("digit")
            ) {
              return [
                { text: "cloud", size: 24 },
                { text: "cybersecurity", size: 22 },
                { text: "AI", size: 20 },
                { text: "startup", size: 18 },
                { text: "open source", size: 18 },
                { text: "infrastrutture", size: 16 },
                { text: "privacy", size: 16 },
                { text: "API", size: 15 },
                { text: "SaaS", size: 14 },
                { text: "performance", size: 14 },
                { text: "prodotti", size: 13 },
                { text: "trend", size: 12 },
              ];
            }

            if (
              s.includes("cultura") ||
              s.includes("libri") ||
              s.includes("editoria")
            ) {
              return [
                { text: "recensioni", size: 24 },
                { text: "interviste", size: 22 },
                { text: "autori", size: 20 },
                { text: "festival", size: 18 },
                { text: "novità", size: 18 },
                { text: "librerie", size: 16 },
                { text: "premi", size: 16 },
                { text: "saggi", size: 15 },
                { text: "narrativa", size: 14 },
                { text: "rubriche", size: 14 },
                { text: "agenda", size: 13 },
                { text: "lettori", size: 12 },
              ];
            }

            return [
              { text: "attualità", size: 24 },
              { text: "approfondimento", size: 22 },
              { text: "intervista", size: 20 },
              { text: "analisi", size: 18 },
              { text: "mercato", size: 18 },
              { text: "report", size: 16 },
              { text: "dati", size: 16 },
              { text: "trend", size: 14 },
              { text: "aziende", size: 14 },
              { text: "eventi", size: 13 },
              { text: "territorio", size: 13 },
              { text: "inchiesta", size: 12 },
            ];
          };

          const getMockArticlesForService = (service) => {
            const s = String(service || "")
              .trim()
              .toLowerCase();

            if (s.includes("agric")) {
              return [
                {
                  title:
                    "PAC 2025: nuove misure e impatto su aziende agricole italiane",
                  date: "12/01/2025",
                },
                {
                  title:
                    "Filiera corta e prezzi: cosa cambia tra GDO e mercati locali",
                  date: "28/11/2024",
                },
                {
                  title:
                    "Siccità e irrigazione: strategie e investimenti nelle regioni del Centro",
                  date: "04/10/2024",
                },
              ];
            }

            if (
              s.includes("software") ||
              s.includes("it") ||
              s.includes("digit")
            ) {
              return [
                {
                  title: "Cloud sovrano: opportunità e rischi per le PMI",
                  date: "19/12/2024",
                },
                {
                  title:
                    "Cybersecurity: attacchi in crescita e nuove best practice",
                  date: "03/11/2024",
                },
                {
                  title: "AI generativa in azienda: casi d'uso e governance",
                  date: "22/09/2024",
                },
              ];
            }

            if (
              s.includes("cultura") ||
              s.includes("libri") ||
              s.includes("editoria")
            ) {
              return [
                {
                  title: "Editoria 2025: trend di lettura e nuove collane",
                  date: "07/01/2025",
                },
                {
                  title:
                    "Intervista all'autore: scrittura, ricerca e immaginario",
                  date: "16/11/2024",
                },
                {
                  title: "Festival letterari: calendario, temi e pubblico",
                  date: "01/10/2024",
                },
              ];
            }

            return [
              {
                title: "Attualità: i temi che stanno ridisegnando il mercato",
                date: "14/01/2025",
              },
              {
                title: "Dati e trend: come leggere numeri e segnali deboli",
                date: "20/11/2024",
              },
              {
                title: "Intervista: voci dal territorio e casi emblematici",
                date: "08/10/2024",
              },
            ];
          };

          const getPreferredContact = ({
            customItems,
            programItems,
            preferred,
            fallbackItem,
          }) => {
            const custom = customItems.filter(
              (x) => normalizeTextHeader(x.value).length > 0,
            );
            const program = programItems.filter(
              (x) => normalizeTextHeader(x.value).length > 0,
            );

            if (program.length === 0 && fallbackItem) {
              const v = normalizeTextHeader(fallbackItem.value);
              if (v) program.push({ value: v, label: fallbackItem.label });
            }

            if (preferred && typeof preferred === "object") {
              const origin = normalizeTextHeader(
                preferred.origin,
              ).toLowerCase();
              const idx = preferred.index;
              if (origin === "custom" && Number.isFinite(idx) && custom[idx]) {
                return { ...custom[idx] };
              }
              if (
                origin === "program" &&
                Number.isFinite(idx) &&
                program[idx]
              ) {
                return { ...program[idx] };
              }
            }

            if (custom[0]) return { ...custom[0] };
            if (program[0]) return { ...program[0] };
            return null;
          };

          const preferredPhone = getPreferredContact({
            customItems: normalizeArrHeader(j.customPhones).map((x) => ({
              value: normalizeTextHeader(x?.number ?? x?.tel ?? x?.value ?? x),
              label:
                normalizeTextHeader(x?.type ?? x?.kind ?? "") || "cellulare",
            })),
            programItems: normalizeArrHeader(j?.programPhones).map((x) => ({
              value: normalizeTextHeader(x?.number ?? x?.tel ?? x?.value ?? x),
              label:
                normalizeTextHeader(x?.type ?? x?.kind ?? "") || "cellulare",
            })),
            preferred: j?.preferredPhone,
            fallbackItem: { value: j?.tel, label: "cellulare" },
          });

          const preferredEmail = getPreferredContact({
            customItems: normalizeArrHeader(j.customEmails).map((x) => ({
              value: normalizeTextHeader(x?.email ?? x?.value ?? x),
              label: normalizeTextHeader(x?.type ?? "") || "mail diretta",
            })),
            programItems: normalizeArrHeader(j?.programEmails).map((x) => ({
              value: normalizeTextHeader(x?.email ?? x?.value ?? x),
              label: normalizeTextHeader(x?.type ?? "") || "mail diretta",
            })),
            preferred: j?.preferredEmail,
            fallbackItem: { value: j?.email, label: "mail diretta" },
          });

          const contactsSummary = document.createElement("table");
          contactsSummary.className = "journalist-contact-table";
          contactsSummary.setAttribute("data-journalist-header-contacts", "");
          {
            const colgroup = document.createElement("colgroup");
            const col1 = document.createElement("col");
            col1.style.width = "24ch";
            const col2 = document.createElement("col");
            col2.style.width = "16ch";
            colgroup.appendChild(col1);
            colgroup.appendChild(col2);
            contactsSummary.appendChild(colgroup);

            const tbody = document.createElement("tbody");
            contactsSummary.appendChild(tbody);

            const makeRow = (key, value, label) => {
              const tr = document.createElement("tr");

              const tdValue = document.createElement("td");
              const sValue = document.createElement("span");
              sValue.className = "journalist-contact-cell t-value";
              sValue.setAttribute("data-header-contact", `${key}-value`);
              sValue.textContent = normalizeTextHeader(value) || "n/d";
              tdValue.appendChild(sValue);

              const tdLabel = document.createElement("td");
              const sLabel = document.createElement("span");
              sLabel.className = "journalist-contact-cell t-label";
              sLabel.setAttribute("data-header-contact", `${key}-label`);
              sLabel.textContent = normalizeTextHeader(label) || "";
              tdLabel.appendChild(sLabel);

              tr.appendChild(tdValue);
              tr.appendChild(tdLabel);
              return tr;
            };

            tbody.appendChild(
              makeRow("phone", preferredPhone?.value, preferredPhone?.label),
            );
            tbody.appendChild(
              makeRow("email", preferredEmail?.value, preferredEmail?.label),
            );
          }
          titleRow.appendChild(titleActions);

          header.appendChild(titleRow);

          const meta = document.createElement("div");
          meta.className = "journalist-sheet__meta";

          const metaDate = document.createElement("span");
          metaDate.className = "t-value";
          metaDate.textContent = "25/7/2025";

          const metaText = document.createElement("span");
          metaText.className = "t-label";
          metaText.textContent = "aggiornamento M_";

          meta.appendChild(metaDate);
          meta.appendChild(metaText);

          if (testataPanelHeaderContent) {
            testataPanelHeaderContent.innerHTML = "";
            testataPanelHeaderContent.appendChild(header);
            testataPanelHeaderContent.appendChild(meta);
          }

          {
            const panelHeaderEl = testataPanelHeaderContent?.closest?.(
              ".testata-panel-header",
            );
            if (panelHeaderEl && testataPanelClose) {
              const existing = panelHeaderEl.querySelector(
                "[data-journalist-header-contacts]",
              );
              if (existing) existing.remove();
              panelHeaderEl.insertBefore(contactsSummary, testataPanelClose);
            }
          }

          const grid = document.createElement("div");
          grid.className = "journalist-sheet__grid";

          const mainCol = document.createElement("div");
          mainCol.className = "journalist-section";

          const getSectionOpen = (key, defaultOpen) => {
            const v = appState?.ui?.sectionOpen?.[key];
            return typeof v === "boolean" ? v : !!defaultOpen;
          };

          const setSectionOpen = (key, open) => {
            if (!appState.ui || typeof appState.ui !== "object") {
              appState.ui = {};
            }
            if (
              !appState.ui.sectionOpen ||
              typeof appState.ui.sectionOpen !== "object"
            ) {
              appState.ui.sectionOpen = {};
            }
            appState.ui.sectionOpen[key] = !!open;
            saveAppState(appState);
          };

          const topicsSection = document.createElement("section");
          topicsSection.className = "journalist-section";

          topicsSection.setAttribute("data-journalist-topics", "");
          topicsSection.setAttribute("data-jid", jid);

          const topicsHeader = document.createElement("div");
          topicsHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          topicsHeader.setAttribute("data-section-toggle", "topics");
          topicsHeader.setAttribute("role", "button");
          topicsHeader.setAttribute("tabindex", "0");

          const topicsTitle = document.createElement("div");
          topicsTitle.className = "journalist-section__title";

          const topicsHeading = document.createElement("h3");
          topicsHeading.className = "journalist-section__heading";
          topicsHeading.textContent = "SERVIZI";

          topicsTitle.appendChild(topicsHeading);

          const addTopic = document.createElement("a");
          addTopic.href = "#";
          addTopic.className = "c-link c-link--action";
          addTopic.textContent = "aggiungi servizio";
          addTopic.setAttribute("data-topic-action", "add");

          topicsTitle.appendChild(addTopic);
          topicsHeader.appendChild(topicsTitle);

          const topicsOpen = getSectionOpen("topics", true);
          topicsHeader.setAttribute(
            "aria-expanded",
            topicsOpen ? "true" : "false",
          );

          const topicsToggle = document.createElement("span");
          topicsToggle.className = "journalist-section__toggle";
          topicsToggle.textContent = topicsOpen ? "-" : "+";
          topicsToggle.setAttribute("aria-hidden", "true");
          topicsHeader.appendChild(topicsToggle);

          const topicsEditor = document.createElement("div");
          topicsEditor.className = "journalist-topic-editor";
          topicsEditor.setAttribute("data-topic-editor", "");
          topicsEditor.hidden = true;

          const topicsInput = document.createElement("input");
          topicsInput.type = "text";
          topicsInput.className = "journalist-topic-input";
          topicsInput.placeholder = "servizio";
          topicsInput.setAttribute("data-topic-input", "");
          topicsInput.autocomplete = "off";

          const topicsEditorActions = document.createElement("div");
          topicsEditorActions.className = "journalist-topic-editor-actions";

          const topicsOk = document.createElement("a");
          topicsOk.href = "#";
          topicsOk.className = "c-link c-link--action";
          topicsOk.textContent = "ok";
          topicsOk.setAttribute("data-topic-action", "ok");

          const topicsCancel = document.createElement("a");
          topicsCancel.href = "#";
          topicsCancel.className = "c-link c-link--action";
          topicsCancel.textContent = "annulla";
          topicsCancel.setAttribute("data-topic-action", "cancel");

          topicsEditorActions.appendChild(topicsOk);
          topicsEditorActions.appendChild(topicsCancel);

          topicsEditor.appendChild(topicsInput);
          topicsEditor.appendChild(topicsEditorActions);

          const topicsList = document.createElement("ul");
          topicsList.className = "journalist-topic-list";
          topicsList.setAttribute("data-topic-list", "");

          const normalizeCustomServices = (v) => {
            if (Array.isArray(v)) {
              return v
                .map((x) => {
                  if (typeof x === "object" && x) {
                    return {
                      name: String(
                        x.name ?? x.servizio ?? x.value ?? "",
                      ).trim(),
                    };
                  }
                  return { name: String(x ?? "").trim() };
                })
                .filter((x) => x.name.length > 0);
            }
            return [];
          };

          const renderTopics = () => {
            topicsList.innerHTML = "";

            const baseService = String(j?.servizio || "").trim();
            const custom = normalizeCustomServices(j?.customServices);
            for (let i = 0; i < custom.length; i++) {
              const item = custom[i];
              const li = document.createElement("li");
              li.className = "journalist-topic-item";
              li.setAttribute("data-topic-index", String(i));

              const row = document.createElement("div");
              row.className = "journalist-topic-row";

              const name = document.createElement("span");
              name.textContent = item.name;

              const actions = document.createElement("span");
              actions.className = "journalist-topic-actions";

              const edit = document.createElement("a");
              edit.href = "#";
              edit.className = "c-link c-link--action";
              edit.textContent = "modifica";
              edit.setAttribute("data-topic-action", "edit");

              const remove = document.createElement("a");
              remove.href = "#";
              remove.className = "c-link c-link--action";
              remove.textContent = "rimuovi";
              remove.setAttribute("data-topic-action", "remove");

              actions.appendChild(edit);
              actions.appendChild(remove);

              row.appendChild(name);
              row.appendChild(actions);

              li.appendChild(row);
              topicsList.appendChild(li);
            }

            if (baseService) {
              const li = document.createElement("li");
              li.className = "journalist-topic-item";

              const row = document.createElement("div");
              row.className = "journalist-topic-row";

              const name = document.createElement("span");
              name.textContent = baseService;

              const inText = document.createElement("span");
              inText.textContent = "in";

              const testataName = String(j?.testata || "").trim();
              if (testataName) {
                const link = document.createElement("a");
                link.href = "#";
                link.className = "c-link c-link--nav testata-link";
                link.textContent = testataName;
                link.setAttribute("data-testata", testataName);

                row.appendChild(name);
                row.appendChild(inText);
                row.appendChild(link);
              } else {
                row.appendChild(name);
              }

              li.appendChild(row);
              topicsList.appendChild(li);
            }

            if (!baseService && custom.length === 0) {
              const li = document.createElement("li");
              li.className = "journalist-topic-item";
              li.innerHTML = '<span class="muted">n/d</span>';
              topicsList.appendChild(li);
            }
          };

          renderTopics();

          const topicsBody = document.createElement("div");
          topicsBody.className = "journalist-section__body";
          topicsBody.setAttribute("data-section-body", "");
          topicsBody.hidden = !topicsOpen;
          topicsBody.appendChild(topicsEditor);
          topicsBody.appendChild(topicsList);

          topicsSection.appendChild(topicsHeader);
          topicsSection.appendChild(topicsBody);

          const contactsSection = document.createElement("section");
          contactsSection.className = "journalist-section";

          contactsSection.setAttribute("data-journalist-contacts", "");
          contactsSection.setAttribute("data-jid", jid);

          const contactsHeader = document.createElement("div");
          contactsHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          contactsHeader.setAttribute("data-section-toggle", "contacts");
          contactsHeader.setAttribute("role", "button");
          contactsHeader.setAttribute("tabindex", "0");

          const contactsHeading = document.createElement("h3");
          contactsHeading.className = "journalist-section__heading";
          contactsHeading.textContent = "CONTATTI DIRETTI";

          contactsHeader.appendChild(contactsHeading);

          const contactsOpen = getSectionOpen("contacts", true);
          contactsHeader.setAttribute(
            "aria-expanded",
            contactsOpen ? "true" : "false",
          );

          const contactsToggle = document.createElement("span");
          contactsToggle.className = "journalist-section__toggle";
          contactsToggle.textContent = contactsOpen ? "-" : "+";
          contactsToggle.setAttribute("aria-hidden", "true");
          contactsHeader.appendChild(contactsToggle);

          const contactsGroups = document.createElement("div");
          contactsGroups.className = "journalist-contacts";

          const makeGroupHeader = (labelText, actionText, kind) => {
            const h = document.createElement("div");
            h.className = "journalist-contact-group__header";

            const label = document.createElement("span");
            label.className = "journalist-contact-group__label";
            label.textContent = labelText;

            const add = document.createElement("a");
            add.href = "#";
            add.className = "c-link c-link--action";
            add.textContent = actionText;
            add.setAttribute("data-contact-action", "add");
            add.setAttribute("data-contact-kind", kind);

            h.appendChild(label);
            h.appendChild(add);
            return h;
          };

          const makeEditorActions = (kind) => {
            const actions = document.createElement("div");
            actions.className = "journalist-contact-editor-actions";

            const ok = document.createElement("a");
            ok.href = "#";
            ok.className = "c-link c-link--action";
            ok.textContent = "ok";
            ok.setAttribute("data-contact-action", "ok");
            ok.setAttribute("data-contact-kind", kind);

            const cancel = document.createElement("a");
            cancel.href = "#";
            cancel.className = "c-link c-link--action";
            cancel.textContent = "annulla";
            cancel.setAttribute("data-contact-action", "cancel");
            cancel.setAttribute("data-contact-kind", kind);

            actions.appendChild(ok);
            actions.appendChild(cancel);
            return actions;
          };

          const normalizeArr = (v) => (Array.isArray(v) ? v : []);
          const normalizeText = (v) => String(v ?? "").trim();

          const isPreferred = (kind, origin, index) => {
            const pref =
              kind === "phone" ? j?.preferredPhone : j?.preferredEmail;
            return (
              pref &&
              pref.origin === origin &&
              Number.isFinite(pref.index) &&
              pref.index === index
            );
          };

          const makeTestataLink = () => {
            const testataName = normalizeText(j?.testata);
            if (!testataName) return null;
            const link = document.createElement("a");
            link.href = "#";
            link.className = "c-link c-link--nav testata-link";
            link.textContent = testataName;
            link.setAttribute("data-testata", testataName);
            return link;
          };

          const telGroup = document.createElement("div");
          telGroup.className = "journalist-contact-group";
          telGroup.setAttribute("data-contact-group-kind", "phone");

          const telEditor = document.createElement("div");
          telEditor.className = "journalist-contact-editor";
          telEditor.hidden = true;
          telEditor.setAttribute("data-contact-editor", "");
          telEditor.setAttribute("data-contact-kind", "phone");

          const telType = document.createElement("select");
          telType.className = "journalist-contact-select";
          telType.setAttribute("data-contact-select", "");
          telType.setAttribute("data-contact-kind", "phone");
          for (const opt of [
            "cellulare",
            "cellulare ufficio",
            "fisso",
            "fisso ufficio",
          ]) {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            telType.appendChild(o);
          }

          const telInput = document.createElement("input");
          telInput.type = "text";
          telInput.className = "journalist-contact-input";
          telInput.placeholder = "telefono";
          telInput.autocomplete = "off";
          telInput.setAttribute("data-contact-input", "");
          telInput.setAttribute("data-contact-kind", "phone");

          telEditor.appendChild(telType);
          telEditor.appendChild(telInput);
          telEditor.appendChild(makeEditorActions("phone"));

          const telList = document.createElement("table");
          telList.className = "journalist-contact-table";
          telList.setAttribute("data-contact-list", "");
          telList.setAttribute("data-contact-kind", "phone");

          const renderTel = () => {
            telList.innerHTML = "";
            const colgroup = document.createElement("colgroup");
            const col1 = document.createElement("col");
            col1.style.width = "16ch";
            const col2 = document.createElement("col");
            col2.style.width = "16ch";
            const col3 = document.createElement("col");
            col3.style.width = "16ch";
            const col4 = document.createElement("col");
            col4.style.width = "12ch";
            colgroup.appendChild(col1);
            colgroup.appendChild(col2);
            colgroup.appendChild(col3);
            colgroup.appendChild(col4);
            telList.appendChild(colgroup);
            const tbody = document.createElement("tbody");
            telList.appendChild(tbody);
            const custom = normalizeArr(j.customPhones)
              .map((x) => ({
                number: normalizeText(x?.number ?? x?.tel ?? x?.value ?? x),
                type: normalizeText(x?.type ?? x?.kind ?? ""),
                isPrimary: Boolean(x?.isPrimary),
              }))
              .filter((x) => x.number.length > 0);

            for (let i = 0; i < custom.length; i++) {
              const it = custom[i];
              const tr = document.createElement("tr");
              tr.setAttribute("data-contact-kind", "phone");
              tr.setAttribute("data-contact-index", String(i));

              const tdNumber = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = it.number;
                tdNumber.appendChild(s);
              }

              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = it.type || "cellulare";
                tdType.appendChild(s);
              }

              const tdTestata = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.textContent = "";
                tdTestata.appendChild(s);
              }

              const preferred = document.createElement("a");
              preferred.href = "#";
              preferred.className = `journalist-contact-preferred c-link c-link--action${
                isPreferred("phone", "custom", i) ? " is-active" : ""
              }`;
              preferred.textContent = "predefinito";
              preferred.setAttribute("data-contact-action", "set-primary");
              preferred.setAttribute("data-contact-kind", "phone");
              preferred.setAttribute("data-contact-origin", "custom");

              const edit = document.createElement("a");
              edit.href = "#";
              edit.className = "c-link c-link--action";
              edit.textContent = "modifica";
              edit.setAttribute("data-contact-action", "edit");
              edit.setAttribute("data-contact-kind", "phone");

              const remove = document.createElement("a");
              remove.href = "#";
              remove.className = "c-link c-link--action";
              remove.textContent = "rimuovi";
              remove.setAttribute("data-contact-action", "remove");
              remove.setAttribute("data-contact-kind", "phone");

              const tdPreferred = document.createElement("td");
              tdPreferred.appendChild(preferred);

              const actions = document.createElement("span");
              actions.className = "journalist-contact-row-actions";
              actions.appendChild(edit);
              actions.appendChild(remove);
              tdPreferred.appendChild(actions);

              tr.appendChild(tdNumber);
              tr.appendChild(tdType);
              tr.appendChild(tdTestata);
              tr.appendChild(tdPreferred);
              tbody.appendChild(tr);
            }

            const programItemsRaw = normalizeArr(j?.programPhones);
            const programItems = programItemsRaw
              .map((x) => ({
                number: normalizeText(x?.number ?? x?.tel ?? x?.value ?? x),
                type: normalizeText(x?.type ?? x?.kind ?? ""),
              }))
              .filter((x) => x.number.length > 0);
            if (programItems.length === 0) {
              const v = normalizeText(j?.telefono);
              if (v) programItems.push({ number: v, type: "cellulare" });
            }
            for (let pi = 0; pi < programItems.length; pi++) {
              const it = programItems[pi];
              const tr = document.createElement("tr");

              const tdNumber = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = it.number;
                tdNumber.appendChild(s);
              }

              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = it.type || "cellulare";
                tdType.appendChild(s);
              }

              const preferred = document.createElement("a");
              preferred.href = "#";
              preferred.className = `journalist-contact-preferred c-link c-link--action${
                isPreferred("phone", "program", pi) ? " is-active" : ""
              }`;
              preferred.textContent = "predefinito";
              preferred.setAttribute("data-contact-action", "set-primary");
              preferred.setAttribute("data-contact-kind", "phone");
              preferred.setAttribute("data-contact-origin", "program");
              preferred.setAttribute("data-contact-program-index", String(pi));

              const tdTestata = document.createElement("td");
              const link = makeTestataLink();
              if (link) {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.appendChild(link);
                tdTestata.appendChild(s);
              } else {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.textContent = "";
                tdTestata.appendChild(s);
              }
              const tdPreferred = document.createElement("td");
              tdPreferred.appendChild(preferred);

              tr.appendChild(tdNumber);
              tr.appendChild(tdType);
              tr.appendChild(tdTestata);
              tr.appendChild(tdPreferred);
              tbody.appendChild(tr);
            }

            if (programItems.length === 0 && custom.length === 0) {
              const tr = document.createElement("tr");
              const td = document.createElement("td");
              td.colSpan = 4;
              td.innerHTML = '<span class="muted">n/d</span>';
              tr.appendChild(td);
              tbody.appendChild(tr);
            }

            j.customPhones = custom;
          };

          renderTel();

          telGroup.appendChild(makeGroupHeader("Tel", "aggiungi tel", "phone"));
          telGroup.appendChild(telEditor);
          telGroup.appendChild(telList);

          const emailGroup = document.createElement("div");
          emailGroup.className = "journalist-contact-group";
          emailGroup.setAttribute("data-contact-group-kind", "email");

          const emailEditor = document.createElement("div");
          emailEditor.className = "journalist-contact-editor";
          emailEditor.hidden = true;
          emailEditor.setAttribute("data-contact-editor", "");
          emailEditor.setAttribute("data-contact-kind", "email");

          const emailInput = document.createElement("input");
          emailInput.type = "text";
          emailInput.className = "journalist-contact-input";
          emailInput.placeholder = "email";
          emailInput.autocomplete = "off";
          emailInput.setAttribute("data-contact-input", "");
          emailInput.setAttribute("data-contact-kind", "email");

          emailEditor.appendChild(emailInput);
          emailEditor.appendChild(makeEditorActions("email"));

          const emailList = document.createElement("table");
          emailList.className = "journalist-contact-table";
          emailList.setAttribute("data-contact-list", "");
          emailList.setAttribute("data-contact-kind", "email");

          const renderEmail = () => {
            emailList.innerHTML = "";
            const colgroup = document.createElement("colgroup");
            const col1 = document.createElement("col");
            col1.style.width = "18ch";
            const col2 = document.createElement("col");
            col2.style.width = "16ch";
            const col3 = document.createElement("col");
            col3.style.width = "16ch";
            const col4 = document.createElement("col");
            col4.style.width = "12ch";
            colgroup.appendChild(col1);
            colgroup.appendChild(col2);
            colgroup.appendChild(col3);
            colgroup.appendChild(col4);
            emailList.appendChild(colgroup);
            const tbody = document.createElement("tbody");
            emailList.appendChild(tbody);
            const custom = normalizeArr(j.customEmails)
              .map((x) => ({
                email: normalizeText(x?.email ?? x?.value ?? x),
                type: normalizeText(x?.type ?? ""),
                isDefault: Boolean(x?.isDefault),
              }))
              .filter((x) => x.email.length > 0);

            for (let i = 0; i < custom.length; i++) {
              const it = custom[i];
              const tr = document.createElement("tr");
              tr.setAttribute("data-contact-kind", "email");
              tr.setAttribute("data-contact-index", String(i));

              const tdEmail = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = it.email;
                tdEmail.appendChild(s);
              }

              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = it.type || "mail diretta";
                tdType.appendChild(s);
              }

              const tdTestata = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.textContent = "";
                tdTestata.appendChild(s);
              }

              const preferred = document.createElement("a");
              preferred.href = "#";
              preferred.className = `journalist-contact-preferred c-link c-link--action${
                isPreferred("email", "custom", i) ? " is-active" : ""
              }`;
              preferred.textContent = "predefinito";
              preferred.setAttribute("data-contact-action", "set-default");
              preferred.setAttribute("data-contact-kind", "email");
              preferred.setAttribute("data-contact-origin", "custom");

              const edit = document.createElement("a");
              edit.href = "#";
              edit.className = "c-link c-link--action";
              edit.textContent = "modifica";
              edit.setAttribute("data-contact-action", "edit");
              edit.setAttribute("data-contact-kind", "email");

              const remove = document.createElement("a");
              remove.href = "#";
              remove.className = "c-link c-link--action";
              remove.textContent = "rimuovi";
              remove.setAttribute("data-contact-action", "remove");
              remove.setAttribute("data-contact-kind", "email");

              const tdPreferred = document.createElement("td");
              tdPreferred.appendChild(preferred);

              const actions = document.createElement("span");
              actions.className = "journalist-contact-row-actions";
              actions.appendChild(edit);
              actions.appendChild(remove);
              tdPreferred.appendChild(actions);

              tr.appendChild(tdEmail);
              tr.appendChild(tdType);
              tr.appendChild(tdTestata);
              tr.appendChild(tdPreferred);
              tbody.appendChild(tr);
            }

            const programItemsRaw = normalizeArr(j?.programEmails);
            const programItems = programItemsRaw
              .map((x) => ({
                email: normalizeText(x?.email ?? x?.value ?? x),
                type: normalizeText(x?.type ?? ""),
              }))
              .filter((x) => x.email.length > 0);
            if (programItems.length === 0) {
              const v = normalizeText(j?.email);
              if (v) programItems.push({ email: v, type: "mail diretta" });
            }
            for (let pi = 0; pi < programItems.length; pi++) {
              const it = programItems[pi];
              const tr = document.createElement("tr");

              const tdEmail = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = it.email;
                tdEmail.appendChild(s);
              }

              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = it.type || "mail diretta";
                tdType.appendChild(s);
              }

              const preferred = document.createElement("a");
              preferred.href = "#";
              preferred.className = `journalist-contact-preferred c-link c-link--action${
                isPreferred("email", "program", pi) ? " is-active" : ""
              }`;
              preferred.textContent = "predefinito";
              preferred.setAttribute("data-contact-action", "set-default");
              preferred.setAttribute("data-contact-kind", "email");
              preferred.setAttribute("data-contact-origin", "program");
              preferred.setAttribute("data-contact-program-index", String(pi));

              const tdTestata = document.createElement("td");
              const link = makeTestataLink();
              if (link) {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.appendChild(link);
                tdTestata.appendChild(s);
              } else {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.textContent = "";
                tdTestata.appendChild(s);
              }
              const tdPreferred = document.createElement("td");
              tdPreferred.appendChild(preferred);

              tr.appendChild(tdEmail);
              tr.appendChild(tdType);
              tr.appendChild(tdTestata);
              tr.appendChild(tdPreferred);
              tbody.appendChild(tr);
            }

            if (programItems.length === 0 && custom.length === 0) {
              const tr = document.createElement("tr");
              const td = document.createElement("td");
              td.colSpan = 4;
              td.innerHTML = '<span class="muted">n/d</span>';
              tr.appendChild(td);
              tbody.appendChild(tr);
            }

            j.customEmails = custom;
          };

          renderEmail();

          emailGroup.appendChild(
            makeGroupHeader("Email", "aggiungi email", "email"),
          );
          emailGroup.appendChild(emailEditor);
          emailGroup.appendChild(emailList);

          const socialGroup = document.createElement("div");
          socialGroup.className = "journalist-contact-group";
          socialGroup.setAttribute("data-contact-group-kind", "social");

          const socialEditor = document.createElement("div");
          socialEditor.className = "journalist-contact-editor";
          socialEditor.hidden = true;
          socialEditor.setAttribute("data-contact-editor", "");
          socialEditor.setAttribute("data-contact-kind", "social");

          const socialType = document.createElement("select");
          socialType.className = "journalist-contact-select";
          socialType.setAttribute("data-contact-select", "");
          socialType.setAttribute("data-contact-kind", "social");
          for (const opt of ["facebook", "x", "instagram"]) {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            socialType.appendChild(o);
          }

          const socialInput = document.createElement("input");
          socialInput.type = "text";
          socialInput.className = "journalist-contact-input";
          socialInput.placeholder = "social";
          socialInput.autocomplete = "off";
          socialInput.setAttribute("data-contact-input", "");
          socialInput.setAttribute("data-contact-kind", "social");

          socialEditor.appendChild(socialType);
          socialEditor.appendChild(socialInput);
          socialEditor.appendChild(makeEditorActions("social"));

          const socialList = document.createElement("table");
          socialList.className = "journalist-contact-table";
          socialList.setAttribute("data-contact-list", "");
          socialList.setAttribute("data-contact-kind", "social");

          const renderSocial = () => {
            socialList.innerHTML = "";
            const tbody = document.createElement("tbody");
            socialList.appendChild(tbody);
            const custom = normalizeArr(j.customSocials)
              .map((x) => ({
                url: normalizeText(x?.url ?? x?.value ?? x),
                type: normalizeText(x?.type ?? ""),
              }))
              .filter((x) => x.url.length > 0);

            for (let i = 0; i < custom.length; i++) {
              const it = custom[i];
              const tr = document.createElement("tr");
              tr.setAttribute("data-contact-kind", "social");
              tr.setAttribute("data-contact-index", String(i));

              const tdUrl = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = it.url;
                tdUrl.appendChild(s);
              }
              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = it.type || "x";
                tdType.appendChild(s);
              }

              const edit = document.createElement("a");
              edit.href = "#";
              edit.className = "c-link c-link--action";
              edit.textContent = "modifica";
              edit.setAttribute("data-contact-action", "edit");
              edit.setAttribute("data-contact-kind", "social");

              const remove = document.createElement("a");
              remove.href = "#";
              remove.className = "c-link c-link--action";
              remove.textContent = "rimuovi";
              remove.setAttribute("data-contact-action", "remove");
              remove.setAttribute("data-contact-kind", "social");

              const actions = document.createElement("span");
              actions.className = "journalist-contact-row-actions";
              actions.appendChild(edit);
              actions.appendChild(remove);
              tdUrl.appendChild(actions);

              tr.appendChild(tdUrl);
              tr.appendChild(tdType);
              tbody.appendChild(tr);
            }

            const program = normalizeText(j?.social);
            if (program) {
              const tr = document.createElement("tr");
              const tdUrl = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = program;
                tdUrl.appendChild(s);
              }
              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = "x";
                tdType.appendChild(s);
              }
              tr.appendChild(tdUrl);
              tr.appendChild(tdType);
              tbody.appendChild(tr);
            }

            if (!program && custom.length === 0) {
              const tr = document.createElement("tr");
              const td = document.createElement("td");
              td.colSpan = 2;
              td.innerHTML = '<span class="muted">n/d</span>';
              tr.appendChild(td);
              tbody.appendChild(tr);
            }

            j.customSocials = custom;
          };

          renderSocial();

          socialGroup.appendChild(
            makeGroupHeader("Social", "aggiungi social", "social"),
          );
          socialGroup.appendChild(socialEditor);
          socialGroup.appendChild(socialList);

          contactsGroups.appendChild(telGroup);
          contactsGroups.appendChild(emailGroup);
          contactsGroups.appendChild(socialGroup);

          const contactsBody = document.createElement("div");
          contactsBody.className = "journalist-section__body";
          contactsBody.setAttribute("data-section-body", "");
          contactsBody.hidden = !contactsOpen;
          contactsBody.appendChild(contactsGroups);

          contactsSection.appendChild(contactsHeader);
          contactsSection.appendChild(contactsBody);

          const redazioniSection = document.createElement("section");
          redazioniSection.className = "journalist-section";

          const redazioniOpen = getSectionOpen("redazioni", true);

          const redazioniHeader = document.createElement("div");
          redazioniHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          redazioniHeader.setAttribute("data-section-toggle", "redazioni");
          redazioniHeader.setAttribute("role", "button");
          redazioniHeader.setAttribute("tabindex", "0");
          redazioniHeader.setAttribute(
            "aria-expanded",
            redazioniOpen ? "true" : "false",
          );

          const redazioniTitle = document.createElement("div");
          redazioniTitle.className = "journalist-section__title";

          const redazioniHeading = document.createElement("h3");
          redazioniHeading.className = "journalist-section__heading";
          redazioniHeading.textContent = "REDAZIONI";

          const redazioniMeta = document.createElement("span");
          redazioniMeta.className = "muted";
          redazioniMeta.textContent = "con cui collabora";

          const redazioniAdd = document.createElement("a");
          redazioniAdd.href = "#";
          redazioniAdd.className = "c-link c-link--action";
          redazioniAdd.textContent = "aggiungi redazione";

          redazioniTitle.appendChild(redazioniHeading);
          redazioniTitle.appendChild(redazioniMeta);
          redazioniTitle.appendChild(redazioniAdd);
          redazioniHeader.appendChild(redazioniTitle);

          const redazioniToggle = document.createElement("span");
          redazioniToggle.className = "journalist-section__toggle";
          redazioniToggle.textContent = redazioniOpen ? "-" : "+";
          redazioniToggle.setAttribute("aria-hidden", "true");
          redazioniHeader.appendChild(redazioniToggle);

          const redazioniList = document.createElement("ul");
          redazioniList.className = "journalist-list";

          const makeRedazioneTable = (servizio, ruolo, telRedazione) => {
            const wrap = document.createElement("div");
            wrap.className = "journalist-list__table";

            const table = document.createElement("table");
            table.className = "journalist-contact-table";

            const colgroup = document.createElement("colgroup");
            const col1 = document.createElement("col");
            col1.style.width = "24ch";
            const col2 = document.createElement("col");
            col2.style.width = "16ch";
            colgroup.appendChild(col1);
            colgroup.appendChild(col2);
            table.appendChild(colgroup);

            const tbody = document.createElement("tbody");
            table.appendChild(tbody);

            const makeRow = (value, label) => {
              const tr = document.createElement("tr");

              const tdValue = document.createElement("td");
              const sValue = document.createElement("span");
              sValue.className = "journalist-contact-cell t-value";
              sValue.textContent = String(value || "").trim() || "n/d";
              tdValue.appendChild(sValue);

              const tdLabel = document.createElement("td");
              const sLabel = document.createElement("span");
              sLabel.className = "journalist-contact-cell t-label";
              sLabel.textContent = String(label || "").trim();
              tdLabel.appendChild(sLabel);

              tr.appendChild(tdValue);
              tr.appendChild(tdLabel);
              return tr;
            };

            tbody.appendChild(makeRow(servizio, "servizio"));
            tbody.appendChild(makeRow(ruolo, "ruolo"));
            tbody.appendChild(makeRow(telRedazione, "tel redazione"));

            wrap.appendChild(table);
            return wrap;
          };

          {
            const journalistTestate = getJournalistTestate(j);
            if (!journalistTestate.length) {
              const li = document.createElement("li");
              li.innerHTML = '<span class="muted">n/d</span>';
              redazioniList.appendChild(li);
            } else {
              for (const tname of journalistTestate) {
                const li = document.createElement("li");

                const link = document.createElement("a");
                link.href = "#";
                link.className = "testata-link journalist-list__title";
                link.textContent = tname;
                link.setAttribute("data-testata", tname);
                li.appendChild(link);

                const role = getJournalistRoleForTestata(j, tname);
                const servizio = getJournalistServiceForTestata(j, tname);
                const tKey = normalizeTestataKey(tname);
                const t = testateByKey.get(tKey);
                const telRedazione = String(
                  t?.redazione?.telRedazione || "",
                ).trim();

                li.appendChild(
                  makeRedazioneTable(servizio, role, telRedazione),
                );
                redazioniList.appendChild(li);
              }
            }
          }

          const redazioniBody = document.createElement("div");
          redazioniBody.className = "journalist-section__body";
          redazioniBody.setAttribute("data-section-body", "");
          redazioniBody.hidden = !redazioniOpen;
          redazioniBody.appendChild(redazioniList);

          redazioniSection.appendChild(redazioniHeader);
          redazioniSection.appendChild(redazioniBody);

          const articlesSection = document.createElement("section");
          articlesSection.className = "journalist-section";

          const articlesOpen = getSectionOpen("articles", true);

          const articlesHeader = document.createElement("div");
          articlesHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          articlesHeader.setAttribute("data-section-toggle", "articles");
          articlesHeader.setAttribute("role", "button");
          articlesHeader.setAttribute("tabindex", "0");
          articlesHeader.setAttribute(
            "aria-expanded",
            articlesOpen ? "true" : "false",
          );

          const articlesHeading = document.createElement("h3");
          articlesHeading.className = "journalist-section__heading";
          articlesHeading.textContent = "ARTICOLI";

          const articlesTitle = document.createElement("div");
          articlesTitle.className = "journalist-section__title";

          const articlesMeta = document.createElement("span");
          articlesMeta.className = "c-text";
          articlesMeta.textContent = "che ha scritto";

          const articlesLink = document.createElement("a");
          articlesLink.href = "#";
          articlesLink.className = "c-link c-link--action";
          articlesLink.textContent = "termini ricorrenti";

          articlesTitle.appendChild(articlesHeading);
          articlesTitle.appendChild(articlesMeta);
          articlesHeader.appendChild(articlesTitle);

          const articlesToggle = document.createElement("span");
          articlesToggle.className = "journalist-section__toggle";
          articlesToggle.textContent = articlesOpen ? "-" : "+";
          articlesToggle.setAttribute("aria-hidden", "true");
          articlesHeader.appendChild(articlesToggle);

          const articlesList = document.createElement("ul");
          articlesList.className = "journalist-list";
          {
            const items = getMockArticlesForService(j?.servizio);
            for (const it of items) {
              const li = document.createElement("li");

              const a = document.createElement("a");
              a.href = "#";
              a.className = "c-link c-link--nav journalist-list__title";
              a.textContent = String(it?.title || "");

              const date = document.createElement("div");
              date.className = "muted";
              date.textContent = String(it?.date || "");

              li.appendChild(a);
              li.appendChild(date);
              articlesList.appendChild(li);
            }
          }

          const wordCloud = document.createElement("div");
          wordCloud.className = "journalist-wordcloud";
          wordCloud.setAttribute("data-wordcloud", "");
          {
            const terms = getWordCloudTermsForService(j?.servizio);
            for (const t of terms) {
              const w = document.createElement("span");
              w.className = "journalist-wordcloud__word";
              w.textContent = String(t?.text || "");
              const fs = Number(t?.size || 0);
              if (Number.isFinite(fs) && fs > 0) {
                w.style.fontSize = `${fs}px`;
              }
              wordCloud.appendChild(w);
            }
          }

          const articlesBody = document.createElement("div");
          articlesBody.className = "journalist-section__body";
          articlesBody.setAttribute("data-section-body", "");
          articlesBody.hidden = !articlesOpen;
          articlesBody.appendChild(wordCloud);
          articlesBody.appendChild(articlesList);

          articlesSection.appendChild(articlesHeader);
          articlesSection.appendChild(articlesBody);

          const mailingSection = document.createElement("section");
          mailingSection.className = "journalist-section";

          const mailingOpen = getSectionOpen("mailing", true);

          const mailingHeader = document.createElement("div");
          mailingHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          mailingHeader.setAttribute("data-section-toggle", "mailing");
          mailingHeader.setAttribute("role", "button");
          mailingHeader.setAttribute("tabindex", "0");
          mailingHeader.setAttribute(
            "aria-expanded",
            mailingOpen ? "true" : "false",
          );

          const mailingTitle = document.createElement("div");
          mailingTitle.className = "journalist-section__title";

          const mailingHeading = document.createElement("h3");
          mailingHeading.className = "journalist-section__heading";
          mailingHeading.textContent = "MAILING LISTS";

          const mailingMeta = document.createElement("span");
          mailingMeta.className = "muted";
          mailingMeta.textContent = "a cui appartiene";

          mailingTitle.appendChild(mailingHeading);
          mailingTitle.appendChild(mailingMeta);
          mailingHeader.appendChild(mailingTitle);

          const mailingToggle = document.createElement("span");
          mailingToggle.className = "journalist-section__toggle";
          mailingToggle.textContent = mailingOpen ? "-" : "+";
          mailingToggle.setAttribute("aria-hidden", "true");
          mailingHeader.appendChild(mailingToggle);

          const mailingList = document.createElement("ul");
          mailingList.className = "journalist-list";
          mailingList.classList.add("journalist-mailing-list");

          const getTestateCountForJournalistIds = (journalistIds) => {
            const ids = Array.isArray(journalistIds) ? journalistIds : [];
            const keys = new Set();
            for (const jid of ids) {
              const id = String(jid || "").trim();
              if (!id) continue;
              const jx = (journalists || []).find(
                (x) => getJournalistId(x) === id,
              );
              if (!jx) continue;
              const testate = getJournalistTestate(jx);
              for (const tname of testate) {
                const k = normalizeTestataKey(tname);
                if (k) keys.add(k);
              }
            }
            return keys.size;
          };

          {
            const jid = getJournalistId(j);
            const allLists = Array.isArray(appState.mailingLists)
              ? appState.mailingLists
              : [];
            const lists = allLists.filter((ml) => {
              if (!ml || typeof ml !== "object") return false;
              const ids = Array.isArray(ml.journalistIds)
                ? ml.journalistIds
                : [];
              return ids.includes(jid);
            });

            if (!lists.length) {
              const li = document.createElement("li");
              li.innerHTML = '<span class="muted">n/d</span>';
              mailingList.appendChild(li);
            } else {
              for (const ml of lists) {
                const li = document.createElement("li");

                const titleRow = document.createElement("div");
                titleRow.className = "journalist-list__title-row";

                const link = document.createElement("a");
                link.href = "#";
                link.className = "testata-link journalist-list__title";
                link.textContent = String(ml?.name || "");
                link.addEventListener("click", (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  openMailingListById(String(ml?.id || ""));
                });

                const nJournalists = Array.isArray(ml?.journalistIds)
                  ? ml.journalistIds.length
                  : 0;
                const nTestate = getTestateCountForJournalistIds(
                  ml?.journalistIds,
                );
                const pill = document.createElement("span");
                pill.className = "pill";
                pill.textContent = `${nJournalists} giornalisti / ${nTestate} testate`;

                titleRow.appendChild(link);
                titleRow.appendChild(pill);

                const metaRow = document.createElement("div");
                metaRow.className = "journalist-list__meta-row";
                const metaLeft = document.createElement("span");
                metaLeft.className = "muted";
                const createdAt = Number(ml?.createdAt || 0);
                if (Number.isFinite(createdAt) && createdAt > 0) {
                  metaLeft.textContent = `modificata il ${new Date(createdAt).toLocaleDateString("it-IT")}`;
                } else {
                  metaLeft.textContent = "";
                }
                metaRow.appendChild(metaLeft);

                li.appendChild(titleRow);
                if (metaLeft.textContent) li.appendChild(metaRow);
                mailingList.appendChild(li);
              }
            }
          }

          const mailingBody = document.createElement("div");
          mailingBody.className = "journalist-section__body";
          mailingBody.setAttribute("data-section-body", "");
          mailingBody.hidden = !mailingOpen;
          mailingBody.appendChild(mailingList);

          mailingSection.appendChild(mailingHeader);
          mailingSection.appendChild(mailingBody);

          const shipmentsSection = document.createElement("section");
          shipmentsSection.className = "journalist-section";

          const shipmentsOpen = getSectionOpen("shipments", true);

          const shipmentsHeader = document.createElement("div");
          shipmentsHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          shipmentsHeader.setAttribute("data-section-toggle", "shipments");
          shipmentsHeader.setAttribute("role", "button");
          shipmentsHeader.setAttribute("tabindex", "0");
          shipmentsHeader.setAttribute(
            "aria-expanded",
            shipmentsOpen ? "true" : "false",
          );

          const shipmentsHeading = document.createElement("h3");
          shipmentsHeading.className = "journalist-section__heading";

          const shipmentsTitle = document.createElement("div");
          shipmentsTitle.className = "journalist-section__title";

          const shipmentsMeta = document.createElement("span");
          shipmentsMeta.className = "c-text";
          shipmentsMeta.textContent = "ricevute";

          shipmentsHeading.textContent = "SPEDIZIONI";

          shipmentsTitle.appendChild(shipmentsHeading);
          shipmentsTitle.appendChild(shipmentsMeta);
          shipmentsHeader.appendChild(shipmentsTitle);

          const shipmentsToggle = document.createElement("span");
          shipmentsToggle.className = "journalist-section__toggle";
          shipmentsToggle.textContent = shipmentsOpen ? "-" : "+";
          shipmentsToggle.setAttribute("aria-hidden", "true");
          shipmentsHeader.appendChild(shipmentsToggle);

          const shipmentsList = document.createElement("ul");
          shipmentsList.className = "journalist-list";
          shipmentsList.innerHTML = `
              <li>
                <div class="journalist-list__title-row">
                  <a href="#" class="c-link c-link--nav journalist-list__title">CS - Lancio nuova gamma SUV elettrici premium</a>
                  <span class="c-pill">aperta</span>
                </div>
                <div class="journalist-list__meta-row">
                  <span class="muted">Spedita il 8-5-2025</span>
                </div>
              </li>
              <li>
                <div class="journalist-list__title-row">
                  <a href="#" class="c-link c-link--nav journalist-list__title">CS - Record vendite auto ibride nel primo trimestre 2025</a>
                  <span class="c-pill">chiusa</span>
                </div>
                <div class="journalist-list__meta-row">
                  <span class="muted">Spedita il 15-3-2025</span>
                </div>
              </li>
          `;

          const shipmentsBody = document.createElement("div");
          shipmentsBody.className = "journalist-section__body";
          shipmentsBody.setAttribute("data-section-body", "");
          shipmentsBody.hidden = !shipmentsOpen;
          shipmentsBody.appendChild(shipmentsList);

          shipmentsSection.appendChild(shipmentsHeader);
          shipmentsSection.appendChild(shipmentsBody);

          const notesSection = document.createElement("section");
          notesSection.className = "journalist-section";

          notesSection.setAttribute("data-journalist-notes", "");
          notesSection.setAttribute("data-jid", jid);

          const notesHeader = document.createElement("div");
          notesHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          notesHeader.setAttribute("data-section-toggle", "notes");
          notesHeader.setAttribute("role", "button");
          notesHeader.setAttribute("tabindex", "0");

          const notesTitle = document.createElement("div");
          notesTitle.className = "journalist-section__title";

          const notesHeading = document.createElement("h3");
          notesHeading.className = "journalist-section__heading";
          notesHeading.textContent = "NOTE";

          notesTitle.appendChild(notesHeading);

          const addNote = document.createElement("a");
          addNote.href = "#";
          addNote.className = "c-link c-link--action";
          addNote.textContent = "aggiungi nota";
          addNote.setAttribute("data-note-action", "add");

          notesTitle.appendChild(addNote);
          notesHeader.appendChild(notesTitle);

          const notesOpen = getSectionOpen("notes", false);

          notesHeader.setAttribute(
            "aria-expanded",
            notesOpen ? "true" : "false",
          );

          const notesToggle = document.createElement("span");
          notesToggle.className = "journalist-section__toggle";
          notesToggle.textContent = notesOpen ? "-" : "+";
          notesToggle.setAttribute("aria-hidden", "true");
          notesHeader.appendChild(notesToggle);

          const notesList = document.createElement("div");
          notesList.className = "journalist-notes";
          notesList.setAttribute("data-note-list", "");

          const notesEditor = document.createElement("div");
          notesEditor.className = "journalist-note-editor";
          notesEditor.setAttribute("data-note-editor", "");
          notesEditor.hidden = true;

          const notesTextarea = document.createElement("textarea");
          notesTextarea.className = "journalist-note-textarea";
          notesTextarea.setAttribute("data-note-textarea", "");

          const notesEditorActions = document.createElement("div");
          notesEditorActions.className = "journalist-note-editor-actions";

          const notesOk = document.createElement("a");
          notesOk.href = "#";
          notesOk.className = "c-link c-link--action";
          notesOk.textContent = "ok";
          notesOk.setAttribute("data-note-action", "ok");

          const notesCancel = document.createElement("a");
          notesCancel.href = "#";
          notesCancel.className = "c-link c-link--action";
          notesCancel.textContent = "annulla";
          notesCancel.setAttribute("data-note-action", "cancel");

          notesEditorActions.appendChild(notesOk);
          notesEditorActions.appendChild(notesCancel);

          notesEditor.appendChild(notesTextarea);
          notesEditor.appendChild(notesEditorActions);

          const renderNotesList = (arr) => {
            notesList.innerHTML = "";
            const items = normalizeNoteItems(arr);
            if (!items.length) {
              const empty = document.createElement("div");
              empty.className = "muted";
              empty.textContent = "nessuna nota";
              notesList.appendChild(empty);
              return;
            }

            for (let i = 0; i < items.length; i++) {
              const itemText = items[i]?.text;
              const itemDate = items[i]?.updatedAt;
              const item = document.createElement("div");
              item.className = "journalist-note-item";
              item.setAttribute("data-note-index", String(i));

              const text = document.createElement("div");
              text.className = "journalist-note-text t-value";
              text.textContent = itemText;

              const footer = document.createElement("div");
              footer.className = "journalist-note-footer";

              const date = document.createElement("span");
              date.className = "t-value";
              date.textContent = formatNoteDate(itemDate);

              const edit = document.createElement("a");
              edit.href = "#";
              edit.className = "c-link c-link--action";
              edit.textContent = "modifica";
              edit.setAttribute("data-note-action", "edit");

              const remove = document.createElement("a");
              remove.href = "#";
              remove.className = "c-link c-link--action";
              remove.textContent = "rimuovi";
              remove.setAttribute("data-note-action", "remove");

              footer.appendChild(date);
              footer.appendChild(edit);
              footer.appendChild(remove);

              item.appendChild(text);
              item.appendChild(footer);

              notesList.appendChild(item);
            }
          };

          renderNotesList(j?.note);

          const notesBody = document.createElement("div");
          notesBody.className = "journalist-section__body";
          notesBody.setAttribute("data-section-body", "");
          notesBody.hidden = !notesOpen;
          notesBody.appendChild(notesEditor);
          notesBody.appendChild(notesList);

          notesSection.appendChild(notesHeader);
          notesSection.appendChild(notesBody);

          mainCol.appendChild(notesSection);
          mainCol.appendChild(topicsSection);
          mainCol.appendChild(contactsSection);
          mainCol.appendChild(redazioniSection);
          mainCol.appendChild(articlesSection);
          mainCol.appendChild(mailingSection);
          mainCol.appendChild(shipmentsSection);

          grid.appendChild(mainCol);

          sheet.appendChild(grid);

          testataPanelBody.appendChild(sheet);

          initSplitButtons();
          split.addEventListener(
            "split-button-action",
            (e) => {
              const action = e?.detail?.action;
              if (!action) return;
              if (action === "add-to-list") {
                openAddToListModal({
                  anchorEl: testataPanel,
                  journalistIds: [jid],
                });
                return;
              }
              if (action === "add-to-shipment") {
                openAddToShipmentModal({
                  anchorEl: testataPanel,
                  journalistIds: [jid],
                });
                return;
              }
            },
            true,
          );
        }

        testataOverlay.classList.add("show");
        testataPanel.classList.add("show");
        testataOverlay.setAttribute("aria-hidden", "false");
        testataPanel.setAttribute("aria-hidden", "false");
      }

      function closeTestataPanel() {
        testataOverlay.classList.remove("show");
        testataPanel.classList.remove("show");
        testataOverlay.setAttribute("aria-hidden", "true");
        testataPanel.setAttribute("aria-hidden", "true");
      }

      function openNotesModal(jid) {
        if (
          !notesModal ||
          !notesModalOverlay ||
          !notesModalTitle ||
          !notesModalBody
        )
          return;

        const j = (journalists || []).find((x) => getJournalistId(x) === jid);
        const titleName = j ? `${j.nome} ${j.cognome}` : jid;

        notesModalTitle.textContent = `Note — ${titleName}`;
        notesModalBody.innerHTML = "";

        const notesArr = normalizeNoteItems(j?.note);
        const list = document.createElement("ul");
        list.className = "notes-modal-list";

        if (!notesArr.length) {
          const li = document.createElement("li");
          li.textContent = "nessuna nota";
          list.appendChild(li);
        } else {
          for (const n of notesArr) {
            const li = document.createElement("li");
            li.textContent = n.text;
            list.appendChild(li);
          }
        }

        notesModalBody.appendChild(list);

        notesModalOverlay.classList.add("show");
        notesModal.classList.add("show");
        notesModalOverlay.setAttribute("aria-hidden", "false");
        notesModal.setAttribute("aria-hidden", "false");
      }

      function openTestataJournalistsModal(testataKey) {
        if (
          !notesModal ||
          !notesModalOverlay ||
          !notesModalTitle ||
          !notesModalBody
        )
          return;

        const k = String(testataKey || "").trim();
        const t = testateByKey.get(k);
        const titleName = t ? String(t?.nome || "") : k;

        notesModalTitle.textContent = `Giornalisti — ${titleName}`;
        notesModalBody.innerHTML = "";

        const jids = Array.isArray(t?.redazione?.giornalisti)
          ? t.redazione.giornalisti
          : [];
        const cleanJids = [...jids].filter(Boolean);
        if (!cleanJids.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "nessun giornalista";
          notesModalBody.appendChild(empty);
        } else {
          const table = document.createElement("table");
          table.className = "testata-panel-journalists-table";

          const thead = document.createElement("thead");
          const headRow = document.createElement("tr");
          const headers = ["", "Nome", "Servizio", "Ruolo", "Tel", "Email"];
          for (const h of headers) {
            const th = document.createElement("th");
            th.textContent = h;
            headRow.appendChild(th);
          }
          thead.appendChild(headRow);

          const tbody = document.createElement("tbody");
          const rows = cleanJids
            .map((jid) => {
              const j = (journalists || []).find(
                (x) => getJournalistId(x) === jid,
              );
              const name = j
                ? `${String(j?.nome || "").trim()} ${String(
                    j?.cognome || "",
                  ).trim()}`.trim()
                : getJournalistNameById(jid);
              return {
                jid,
                name,
                servizio: j ? String(j?.servizio || "") : "",
                ruolo: j ? String(j?.ruolo || "") : "",
                tel: j ? String(j?.telefono || "") : "",
                email: j ? String(j?.email || "") : "",
              };
            })
            .sort((a, b) =>
              String(a.name || "").localeCompare(String(b.name || ""), "it", {
                sensitivity: "base",
              }),
            );

          for (const item of rows) {
            const jid = item.jid;
            const tr = document.createElement("tr");

            const checkboxId = `testata-modal-select-${jid.replace(
              /[^a-zA-Z0-9_-]/g,
              "_",
            )}`;

            const tdCb = document.createElement("td");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.className = "testata-panel-select";
            cb.id = checkboxId;
            cb.setAttribute("data-jid", jid);
            cb.checked = selectedJournalistIds.has(jid);
            cb.addEventListener("change", (e) => {
              e.stopPropagation();
              if (cb.checked) {
                selectedJournalistIds.add(jid);
                ensureSelectedOrder(jid);
                openSelectedPanel();
              } else {
                selectedJournalistIds.delete(jid);
                removeFromSelectedOrder(jid);
                if (selectedJournalistIds.size === 0) {
                  closeSelectedPanel();
                } else {
                  renderSelectedPanelList();
                }
              }
              updateCheckboxUI(jid);
              updateCardSelectionUI(jid);
            });
            tdCb.appendChild(cb);

            const tdName = document.createElement("td");
            const nameLink = document.createElement("a");
            nameLink.href = "#";
            nameLink.className = "testata-link journalist-link";
            nameLink.textContent = item.name;
            nameLink.setAttribute("data-journalist", item.name);
            tdName.appendChild(nameLink);

            const tdServizio = document.createElement("td");
            tdServizio.textContent = item.servizio;

            const tdRuolo = document.createElement("td");
            tdRuolo.textContent = item.ruolo;

            const tdTel = document.createElement("td");
            tdTel.textContent = item.tel;

            const tdEmail = document.createElement("td");
            tdEmail.textContent = item.email;

            tr.appendChild(tdCb);
            tr.appendChild(tdName);
            tr.appendChild(tdServizio);
            tr.appendChild(tdRuolo);
            tr.appendChild(tdTel);
            tr.appendChild(tdEmail);
            tbody.appendChild(tr);
          }

          table.appendChild(thead);
          table.appendChild(tbody);
          notesModalBody.appendChild(table);
        }

        notesModalOverlay.classList.add("show");
        notesModal.classList.add("show");
        notesModalOverlay.setAttribute("aria-hidden", "false");
        notesModal.setAttribute("aria-hidden", "false");
      }

      function openTestataNotesModal(testataKey) {
        if (
          !notesModal ||
          !notesModalOverlay ||
          !notesModalTitle ||
          !notesModalBody
        )
          return;

        const k = String(testataKey || "").trim();
        const t = testateByKey.get(k);
        const titleName = t ? String(t?.nome || "") : k;

        notesModalTitle.textContent = `Note — ${titleName}`;
        notesModalBody.innerHTML = "";

        const notesArr = normalizeNoteItems(t?.note);
        const list = document.createElement("ul");
        list.className = "notes-modal-list";

        if (!notesArr.length) {
          const li = document.createElement("li");
          li.textContent = "nessuna nota";
          list.appendChild(li);
        } else {
          for (const n of notesArr) {
            const li = document.createElement("li");
            li.textContent = n.text;
            list.appendChild(li);
          }
        }

        notesModalBody.appendChild(list);

        notesModalOverlay.classList.add("show");
        notesModal.classList.add("show");
        notesModalOverlay.setAttribute("aria-hidden", "false");
        notesModal.setAttribute("aria-hidden", "false");
      }

      function closeNotesModal() {
        if (!notesModal || !notesModalOverlay) return;
        notesModalOverlay.classList.remove("show");
        notesModal.classList.remove("show");
        notesModalOverlay.setAttribute("aria-hidden", "true");
        notesModal.setAttribute("aria-hidden", "true");
      }

      function openJournalistTestateModal(jid) {
        if (
          !notesModal ||
          !notesModalOverlay ||
          !notesModalTitle ||
          !notesModalBody
        )
          return;

        const j = (journalists || []).find((x) => getJournalistId(x) === jid);
        const titleName = j ? `${j.nome} ${j.cognome}` : jid;

        notesModalTitle.textContent = `Testate — ${titleName}`;
        notesModalBody.innerHTML = "";

        const testate = j ? getJournalistTestate(j) : [];
        const list = document.createElement("ul");
        list.className = "notes-modal-list";

        if (!testate.length) {
          const li = document.createElement("li");
          li.textContent = "n/d";
          list.appendChild(li);
        } else {
          for (const tname of testate) {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.href = "#";
            a.className = "testata-link";
            a.textContent = tname;
            a.setAttribute("data-testata", tname);
            li.appendChild(a);
            list.appendChild(li);
          }
        }

        notesModalBody.appendChild(list);

        notesModalOverlay.classList.add("show");
        notesModal.classList.add("show");
        notesModalOverlay.setAttribute("aria-hidden", "false");
        notesModal.setAttribute("aria-hidden", "false");
      }

      function updateJournalistTestateLabelLinks(root) {
        const container = root || document;
        const cards = container.querySelectorAll(".card[data-jid]");
        for (const card of cards) {
          const valueEl = card.querySelector(".card-testate");
          const labelHost = card.querySelector(
            ".card-journalist-testate-open, .card-journalist-testate-label",
          );
          if (!valueEl || !labelHost) continue;

          const jid = String(labelHost.getAttribute("data-jid") || "").trim();
          if (!jid) continue;

          const j = (journalists || []).find((x) => getJournalistId(x) === jid);
          const hasData = (j ? getJournalistTestate(j) : []).length > 0;
          if (!hasData) {
            const span = document.createElement("span");
            span.className = "card-journalist-testate-label";
            span.setAttribute("data-jid", jid);
            span.textContent = "Testate";
            labelHost.replaceWith(span);
            continue;
          }

          const isTruncated = (() => {
            const clampedRect = valueEl.getBoundingClientRect();
            if (!clampedRect.width || !clampedRect.height) return false;

            const measureHost =
              valueEl.closest(".card-row") || valueEl.parentElement || card;

            const clone = valueEl.cloneNode(true);
            clone.style.position = "absolute";
            clone.style.visibility = "hidden";
            clone.style.pointerEvents = "none";
            clone.style.left = "-99999px";
            clone.style.top = "-99999px";
            clone.style.width = `${clampedRect.width}px`;
            clone.style.maxHeight = "none";
            clone.style.minHeight = "0";
            clone.style.height = "auto";
            clone.style.overflow = "visible";
            clone.style.textOverflow = "clip";

            clone.style.display = "block";
            clone.style.webkitBoxOrient = "unset";
            clone.style.webkitLineClamp = "unset";
            clone.style.lineClamp = "unset";

            measureHost.appendChild(clone);
            const fullH = clone.getBoundingClientRect().height;
            clone.remove();

            return fullH > clampedRect.height + 2;
          })();

          if (isTruncated) {
            const a = document.createElement("a");
            a.href = "#";
            a.className = "card-label-link card-journalist-testate-open";
            a.setAttribute("data-jid", jid);
            a.textContent = "Testate";
            labelHost.replaceWith(a);
          } else {
            const span = document.createElement("span");
            span.className = "card-journalist-testate-label";
            span.setAttribute("data-jid", jid);
            span.textContent = "Testate";
            labelHost.replaceWith(span);
          }
        }
      }

      if (notesModalBody) {
        notesModalBody.addEventListener("click", (e) => {
          const journalistLink = e.target?.closest?.(".journalist-link");
          if (journalistLink) {
            e.preventDefault();
            e.stopPropagation();
            const name =
              journalistLink.getAttribute("data-journalist") ||
              journalistLink.textContent;
            closeNotesModal();
            openJournalistPanel(name);
            return;
          }

          const testataLink = e.target?.closest?.(".testata-link");
          if (testataLink) {
            e.preventDefault();
            e.stopPropagation();
            const key = testataLink.getAttribute("data-testata-key");
            const testata =
              testataLink.getAttribute("data-testata") ||
              testataLink.textContent;
            closeNotesModal();
            openTestataPanel(key || testata);
          }
        });
      }

      if (notesModalClose) {
        notesModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeNotesModal();
        });
      }

      if (notesModalOverlay) {
        notesModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeNotesModal();
        });
      }

      if (testataPanelClose) {
        testataPanelClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeTestataPanel();
        });
      }

      if (testataOverlay) {
        testataOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeTestataPanel();
        });
      }

      if (chooseDatabaseLink) {
        chooseDatabaseLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openBancaDatiPanel();
        });
      }

      if (mailingListRenameLink) {
        mailingListRenameLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openRenameListModal();
        });
      }

      if (mailingListDuplicateLink) {
        mailingListDuplicateLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          duplicateActiveMailingList();
        });
      }

      if (mailingListExportLink) {
        mailingListExportLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      }

      if (mailingListDeleteLink) {
        mailingListDeleteLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const activeList = getMailingListById(appState.activeMailingListId);
          if (!activeList) return;

          const id = String(activeList.id || "").trim();
          const name = String(activeList.name || "").trim();
          if (!id) return;

          const ok = window.confirm(`Eliminare la mailing list "${name}"?`);
          if (!ok) return;

          appState.mailingLists = (appState.mailingLists || []).filter(
            (x) => String(x?.id || "") !== id,
          );
          if (String(appState.activeMailingListId || "") === id) {
            appState.activeMailingListId = "";
          }
          saveAppState(appState);
          renderDashboardMailingLists();

          window.location.hash = "#dashboard";
        });
      }

      if (sortByNameAscLink) {
        sortByNameAscLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setSortMode("name-asc");
        });
      }

      if (sortByNameDescLink) {
        sortByNameDescLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setSortMode("name-desc");
        });
      }

      if (sortByRoleLink) {
        sortByRoleLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setSortMode("role");
        });
      }

      if (sortByMediaTypeLink) {
        sortByMediaTypeLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setSortMode("media-type");
        });
      }

      if (sortByFrequencyLink) {
        sortByFrequencyLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setSortMode("frequency");
        });
      }

      function closeSortByNameMenu() {
        if (!sortByNameSelectMenu || !sortByNameSelectTrigger) return;
        sortByNameSelectMenu.classList.remove("show");
        sortByNameSelectMenu.setAttribute("aria-hidden", "true");
        sortByNameSelectTrigger.setAttribute("aria-expanded", "false");
      }

      function toggleSortByNameMenu() {
        if (!sortByNameSelectMenu || !sortByNameSelectTrigger) return;
        const isOpen = sortByNameSelectMenu.classList.contains("show");
        if (isOpen) {
          closeSortByNameMenu();
        } else {
          sortByNameSelectMenu.classList.add("show");
          sortByNameSelectMenu.setAttribute("aria-hidden", "false");
          sortByNameSelectTrigger.setAttribute("aria-expanded", "true");
        }
      }

      if (sortByNameSelectTrigger) {
        sortByNameSelectTrigger.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleSortByNameMenu();
        });
      }

      if (sortByNameSelectMenu) {
        sortByNameSelectMenu.addEventListener("click", (e) => {
          const item = e.target?.closest?.(".dropdown-item[data-sort]");
          if (!item) return;
          e.preventDefault();
          e.stopPropagation();
          let mode = String(item.getAttribute("data-sort") || "")
            .trim()
            .toLowerCase();
          if (!mode) return;
          const sidebarMode = getSidebarMode();
          const isTestateMode = sidebarMode === "testate";
          if (isTestateMode && mode === "role") mode = "frequency";
          setSortMode(mode);
          closeSortByNameMenu();
        });
      }

      document.addEventListener(
        "click",
        (e) => {
          if (!sortByNameSelectMenu || !sortByNameSelectTrigger) return;
          if (!sortByNameSelectMenu.classList.contains("show")) return;
          const t = e.target;
          if (sortByNameSelect && sortByNameSelect.contains(t)) return;
          closeSortByNameMenu();
        },
        true,
      );

      document.addEventListener(
        "keydown",
        (e) => {
          if (e.key !== "Escape") return;
          if (!sortByNameSelectMenu || !sortByNameSelectTrigger) return;
          if (!sortByNameSelectMenu.classList.contains("show")) return;
          e.preventDefault();
          e.stopPropagation();
          closeSortByNameMenu();
        },
        true,
      );

      function selectAllFilteredCards() {
        const grid = document.getElementById("cardsGrid");
        const idsSet = new Set();
        if (grid) {
          for (const el of grid.querySelectorAll(".card-select[data-jid]")) {
            const jid = String(el.getAttribute("data-jid") || "").trim();
            if (jid) idsSet.add(jid);
          }
          for (const el of grid.querySelectorAll(".card[data-jid]")) {
            const jid = String(el.getAttribute("data-jid") || "").trim();
            if (jid) idsSet.add(jid);
          }
        }

        if (
          idsSet.size === 0 &&
          Array.isArray(lastRenderedVisibleJournalistIds)
        ) {
          for (const raw of lastRenderedVisibleJournalistIds) {
            const jid = String(raw || "").trim();
            if (jid) idsSet.add(jid);
          }
        }

        const ids = Array.from(idsSet);
        if (!ids.length) return;

        for (let i = ids.length - 1; i >= 0; i--) {
          const jid = String(ids[i] || "").trim();
          if (!jid) continue;
          selectedJournalistIds.add(jid);
          ensureSelectedOrder(jid);
        }

        openSelectedPanel();
        scheduleRender();
      }

      function deselectAllCards() {
        selectedJournalistIds.clear();
        selectedJournalistOrder.length = 0;

        document
          .querySelectorAll(".card-select, .testata-panel-select")
          .forEach((el) => {
            el.checked = false;
          });
        document.querySelectorAll(".card.is-selected").forEach((el) => {
          el.classList.remove("is-selected");
        });

        renderSelectedPanelList();
        closeSelectedPanel();
      }

      if (selectAllLink) {
        selectAllLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          selectAllFilteredCards();
        });
      }

      if (testataPanelBody) {
        testataPanelBody.addEventListener("click", (e) => {
          const sectionToggleEl = e.target?.closest?.("[data-section-toggle]");
          if (sectionToggleEl) {
            const key = String(
              sectionToggleEl.getAttribute("data-section-toggle") || "",
            )
              .trim()
              .toLowerCase();
            if (!key) return;

            const section = sectionToggleEl.closest("section");
            if (!section) return;

            const body = section.querySelector("[data-section-body]");
            const indicator = section.querySelector(
              ".journalist-section__toggle",
            );
            if (!body || !indicator) return;

            if (e.target?.closest?.("a")) {
              if (body.hidden) {
                body.hidden = false;
                indicator.textContent = "-";
                sectionToggleEl.setAttribute("aria-expanded", "true");
                setSectionOpen(key, true);
              }
            } else {
              e.preventDefault();
              e.stopPropagation();

              const nextOpen = !!body.hidden;
              body.hidden = !nextOpen;
              indicator.textContent = nextOpen ? "-" : "+";
              sectionToggleEl.setAttribute(
                "aria-expanded",
                nextOpen ? "true" : "false",
              );
              setSectionOpen(key, nextOpen);
              return;
            }
          }

          const redazioniToggleEl = e.target?.closest?.(
            "[data-redazioni-toggle]",
          );
          if (redazioniToggleEl) {
            e.preventDefault();
            e.stopPropagation();

            const toggleKey = String(
              redazioniToggleEl.getAttribute("data-redazioni-toggle") || "",
            ).trim();
            if (!toggleKey) return;

            const node = redazioniToggleEl.closest("[data-redazioni-node]");
            const body = node?.querySelector?.("[data-redazioni-body]");
            if (!body) return;

            const nextOpen = !!body.hidden;
            body.hidden = !nextOpen;
            redazioniToggleEl.setAttribute(
              "aria-expanded",
              nextOpen ? "true" : "false",
            );
            setSectionOpen(toggleKey, nextOpen);
            return;
          }

          const noteActionEl = e.target?.closest?.("[data-note-action]");
          if (noteActionEl) {
            const notesSection = noteActionEl.closest(
              "[data-journalist-notes]",
            );
            if (notesSection) {
              e.preventDefault();
              e.stopPropagation();

              const notesBody = notesSection.querySelector(
                "[data-section-body]",
              );
              const notesHeader = notesSection.querySelector(
                '[data-section-toggle="notes"]',
              );
              const notesIndicator = notesSection.querySelector(
                ".journalist-section__toggle",
              );

              const setNotesOpen = (open) => {
                if (notesBody) notesBody.hidden = !open;
                if (notesHeader) {
                  notesHeader.setAttribute(
                    "aria-expanded",
                    open ? "true" : "false",
                  );
                }
                if (notesIndicator) {
                  notesIndicator.textContent = open ? "-" : "+";
                }
                setSectionOpen("notes", !!open);
              };

              const action = String(
                noteActionEl.getAttribute("data-note-action") || "",
              )
                .trim()
                .toLowerCase();

              if (notesBody && notesBody.hidden) {
                setNotesOpen(true);
              }
              const jid = String(
                notesSection.getAttribute("data-jid") || "",
              ).trim();
              if (!jid) return;

              const j = (journalists || []).find(
                (x) => getJournalistId(x) === jid,
              );
              if (!j) return;

              const editor = notesSection.querySelector("[data-note-editor]");
              const textarea = notesSection.querySelector(
                "[data-note-textarea]",
              );
              const list = notesSection.querySelector("[data-note-list]");
              if (!editor || !textarea || !list) return;

              const getNoteItems = () => normalizeNoteItems(j.note);
              const setNoteItems = (arr) => {
                const clean = (arr || [])
                  .map((x) => ({
                    text: String(x?.text ?? "").trim(),
                    updatedAt: x?.updatedAt ? String(x.updatedAt) : "",
                  }))
                  .filter((x) => x.text.length > 0);
                j.note = clean;
              };

              const renderList = () => {
                const items = getNoteItems();
                list.innerHTML = "";
                if (!items.length) {
                  const empty = document.createElement("div");
                  empty.className = "muted";
                  empty.textContent = "nessuna nota";
                  list.appendChild(empty);
                  return;
                }

                for (let i = 0; i < items.length; i++) {
                  const itemText = items[i]?.text;
                  const itemDate = items[i]?.updatedAt;
                  const item = document.createElement("div");
                  item.className = "journalist-note-item";
                  item.setAttribute("data-note-index", String(i));

                  const text = document.createElement("div");
                  text.className = "journalist-note-text t-value";
                  text.textContent = itemText;

                  const footer = document.createElement("div");
                  footer.className = "journalist-note-footer";

                  const date = document.createElement("span");
                  date.className = "t-value";
                  date.textContent = formatNoteDate(itemDate);

                  const edit = document.createElement("a");
                  edit.href = "#";
                  edit.className = "c-link c-link--action";
                  edit.textContent = "modifica";
                  edit.setAttribute("data-note-action", "edit");

                  const remove = document.createElement("a");
                  remove.href = "#";
                  remove.className = "c-link c-link--action";
                  remove.textContent = "rimuovi";
                  remove.setAttribute("data-note-action", "remove");

                  footer.appendChild(date);
                  footer.appendChild(edit);
                  footer.appendChild(remove);

                  item.appendChild(text);
                  item.appendChild(footer);

                  list.appendChild(item);
                }
              };

              const showEditor = (mode, index, value) => {
                editor.hidden = false;
                editor.setAttribute("data-note-mode", mode);
                if (typeof index === "number") {
                  editor.setAttribute("data-note-edit-index", String(index));
                } else {
                  editor.removeAttribute("data-note-edit-index");
                }
                textarea.value = String(value ?? "");
                textarea.focus();
              };

              const hideEditor = () => {
                editor.hidden = true;
                editor.removeAttribute("data-note-mode");
                editor.removeAttribute("data-note-edit-index");
                textarea.value = "";
              };

              if (action === "add") {
                showEditor("add", null, "");
                return;
              }

              const noteItem = noteActionEl.closest("[data-note-index]");
              const indexRaw = noteItem?.getAttribute?.("data-note-index");
              const index = indexRaw != null ? Number(indexRaw) : NaN;

              if (action === "edit") {
                if (!Number.isFinite(index)) return;
                const items = getNoteItems();
                showEditor("edit", index, items[index]?.text ?? "");
                return;
              }

              if (action === "remove") {
                if (!Number.isFinite(index)) return;
                const items = getNoteItems();
                items.splice(index, 1);
                setNoteItems(items);
                hideEditor();
                renderList();
                return;
              }

              if (action === "cancel") {
                hideEditor();
                return;
              }

              if (action === "ok") {
                const value = String(textarea.value ?? "").trim();
                if (!value) {
                  hideEditor();
                  return;
                }

                const mode = String(editor.getAttribute("data-note-mode") || "")
                  .trim()
                  .toLowerCase();
                const items = getNoteItems();
                const nowIso = new Date().toISOString();

                if (mode === "edit") {
                  const editIndex = Number(
                    editor.getAttribute("data-note-edit-index"),
                  );
                  if (Number.isFinite(editIndex) && editIndex >= 0) {
                    const prev = items[editIndex] || {
                      text: "",
                      updatedAt: "",
                    };
                    items[editIndex] = {
                      text: value,
                      updatedAt: nowIso || prev.updatedAt,
                    };
                  }
                } else {
                  items.unshift({ text: value, updatedAt: nowIso });
                }

                setNoteItems(items);
                hideEditor();
                renderList();
                return;
              }
            }

            const testataNotesSection = noteActionEl.closest(
              "[data-testata-notes]",
            );
            if (testataNotesSection) {
              e.preventDefault();
              e.stopPropagation();

              const notesBody = testataNotesSection.querySelector(
                "[data-section-body]",
              );
              const notesHeader = testataNotesSection.querySelector(
                '[data-section-toggle="testata-notes"]',
              );
              const notesIndicator = testataNotesSection.querySelector(
                ".journalist-section__toggle",
              );

              const setNotesOpen = (open) => {
                if (notesBody) notesBody.hidden = !open;
                if (notesHeader) {
                  notesHeader.setAttribute(
                    "aria-expanded",
                    open ? "true" : "false",
                  );
                }
                if (notesIndicator) {
                  notesIndicator.textContent = open ? "-" : "+";
                }
                setSectionOpen("testata-notes", !!open);
              };

              const action = String(
                noteActionEl.getAttribute("data-note-action") || "",
              )
                .trim()
                .toLowerCase();

              if (notesBody && notesBody.hidden) {
                setNotesOpen(true);
              }

              const testataKey = String(
                testataNotesSection.getAttribute("data-testata-key") || "",
              ).trim();
              if (!testataKey) return;

              const t = testateByKey.get(testataKey);
              if (!t) return;

              const editor =
                testataNotesSection.querySelector("[data-note-editor]");
              const textarea = testataNotesSection.querySelector(
                "[data-note-textarea]",
              );
              const list =
                testataNotesSection.querySelector("[data-note-list]");
              if (!editor || !textarea || !list) return;

              const getNoteItems = () => normalizeNoteItems(t.note);
              const setNoteItems = (arr) => {
                const clean = (arr || [])
                  .map((x) => ({
                    text: String(x?.text ?? "").trim(),
                    updatedAt: x?.updatedAt ? String(x.updatedAt) : "",
                  }))
                  .filter((x) => x.text.length > 0);
                t.note = clean;
              };

              const renderList = () => {
                const items = getNoteItems();
                list.innerHTML = "";
                if (!items.length) {
                  const empty = document.createElement("div");
                  empty.className = "muted";
                  empty.textContent = "nessuna nota";
                  list.appendChild(empty);
                  return;
                }

                for (let i = 0; i < items.length; i++) {
                  const itemText = items[i]?.text;
                  const itemDate = items[i]?.updatedAt;
                  const item = document.createElement("div");
                  item.className = "journalist-note-item";
                  item.setAttribute("data-note-index", String(i));

                  const text = document.createElement("div");
                  text.className = "journalist-note-text t-value";
                  text.textContent = itemText;

                  const footer = document.createElement("div");
                  footer.className = "journalist-note-footer";

                  const date = document.createElement("span");
                  date.className = "t-value";
                  date.textContent = formatNoteDate(itemDate);

                  const edit = document.createElement("a");
                  edit.href = "#";
                  edit.className = "c-link c-link--action";
                  edit.textContent = "modifica";
                  edit.setAttribute("data-note-action", "edit");

                  const remove = document.createElement("a");
                  remove.href = "#";
                  remove.className = "c-link c-link--action";
                  remove.textContent = "rimuovi";
                  remove.setAttribute("data-note-action", "remove");

                  footer.appendChild(date);
                  footer.appendChild(edit);
                  footer.appendChild(remove);

                  item.appendChild(text);
                  item.appendChild(footer);
                  list.appendChild(item);
                }
              };

              const showEditor = (mode, index, value) => {
                editor.hidden = false;
                editor.setAttribute("data-note-mode", mode);
                if (typeof index === "number") {
                  editor.setAttribute("data-note-edit-index", String(index));
                } else {
                  editor.removeAttribute("data-note-edit-index");
                }
                textarea.value = String(value ?? "");
                textarea.focus();
              };

              const hideEditor = () => {
                editor.hidden = true;
                editor.removeAttribute("data-note-mode");
                editor.removeAttribute("data-note-edit-index");
                textarea.value = "";
              };

              if (action === "add") {
                showEditor("add", null, "");
                return;
              }

              const noteItem = noteActionEl.closest("[data-note-index]");
              const indexRaw = noteItem?.getAttribute?.("data-note-index");
              const index = indexRaw != null ? Number(indexRaw) : NaN;

              if (action === "edit") {
                if (!Number.isFinite(index)) return;
                const items = getNoteItems();
                showEditor("edit", index, items[index]?.text ?? "");
                return;
              }

              if (action === "remove") {
                if (!Number.isFinite(index)) return;
                const items = getNoteItems();
                items.splice(index, 1);
                setNoteItems(items);
                hideEditor();
                renderList();
                return;
              }

              if (action === "cancel") {
                hideEditor();
                return;
              }

              if (action === "ok") {
                const value = String(textarea.value ?? "").trim();
                if (!value) {
                  hideEditor();
                  return;
                }

                const mode = String(editor.getAttribute("data-note-mode") || "")
                  .trim()
                  .toLowerCase();
                const items = getNoteItems();
                const nowIso = new Date().toISOString();

                if (mode === "edit") {
                  const editIndex = Number(
                    editor.getAttribute("data-note-edit-index"),
                  );
                  if (Number.isFinite(editIndex) && editIndex >= 0) {
                    const prev = items[editIndex] || {
                      text: "",
                      updatedAt: "",
                    };
                    items[editIndex] = {
                      text: value,
                      updatedAt: nowIso || prev.updatedAt,
                    };
                  }
                } else {
                  items.unshift({ text: value, updatedAt: nowIso });
                }

                setNoteItems(items);
                hideEditor();
                renderList();
                return;
              }
            }
          }

          const topicActionEl = e.target?.closest?.("[data-topic-action]");
          if (topicActionEl) {
            const topicsSection = topicActionEl.closest(
              "[data-journalist-topics]",
            );
            if (topicsSection) {
              e.preventDefault();
              e.stopPropagation();

              const topicsBody = topicsSection.querySelector(
                "[data-section-body]",
              );
              const topicsHeader = topicsSection.querySelector(
                '[data-section-toggle="topics"]',
              );
              const topicsIndicator = topicsSection.querySelector(
                ".journalist-section__toggle",
              );

              const setTopicsOpen = (open) => {
                if (topicsBody) topicsBody.hidden = !open;
                if (topicsHeader) {
                  topicsHeader.setAttribute(
                    "aria-expanded",
                    open ? "true" : "false",
                  );
                }
                if (topicsIndicator) {
                  topicsIndicator.textContent = open ? "-" : "+";
                }
                setSectionOpen("topics", !!open);
              };

              if (topicsBody && topicsBody.hidden) {
                setTopicsOpen(true);
              }

              const action = String(
                topicActionEl.getAttribute("data-topic-action") || "",
              )
                .trim()
                .toLowerCase();
              const jid = String(
                topicsSection.getAttribute("data-jid") || "",
              ).trim();
              if (!jid) return;

              const j = (journalists || []).find(
                (x) => getJournalistId(x) === jid,
              );
              if (!j) return;

              const editor = topicsSection.querySelector("[data-topic-editor]");
              const input = topicsSection.querySelector("[data-topic-input]");
              const list = topicsSection.querySelector("[data-topic-list]");
              if (!editor || !input || !list) return;

              const normalizeCustom = (v) => {
                if (!Array.isArray(v)) return [];
                return v
                  .map((x) => {
                    if (typeof x === "object" && x) {
                      return {
                        name: String(
                          x.name ?? x.servizio ?? x.value ?? "",
                        ).trim(),
                      };
                    }
                    return { name: String(x ?? "").trim() };
                  })
                  .filter((x) => x.name.length > 0);
              };

              const setCustom = (arr) => {
                const clean = (arr || [])
                  .map((x) => ({ name: String(x?.name ?? "").trim() }))
                  .filter((x) => x.name.length > 0);
                j.customServices = clean;
              };

              const renderList = () => {
                const baseService = String(j?.servizio || "").trim();
                const custom = normalizeCustom(j?.customServices);
                list.innerHTML = "";

                for (let i = 0; i < custom.length; i++) {
                  const item = custom[i];
                  const li = document.createElement("li");
                  li.className = "journalist-topic-item";
                  li.setAttribute("data-topic-index", String(i));

                  const row = document.createElement("div");
                  row.className = "journalist-topic-row";

                  const name = document.createElement("span");
                  name.textContent = item.name;

                  const actions = document.createElement("span");
                  actions.className = "journalist-topic-actions";

                  const edit = document.createElement("a");
                  edit.href = "#";
                  edit.className = "c-link c-link--action";
                  edit.textContent = "modifica";
                  edit.setAttribute("data-topic-action", "edit");

                  const remove = document.createElement("a");
                  remove.href = "#";
                  remove.className = "c-link c-link--action";
                  remove.textContent = "rimuovi";
                  remove.setAttribute("data-topic-action", "remove");

                  actions.appendChild(edit);
                  actions.appendChild(remove);

                  row.appendChild(name);
                  row.appendChild(actions);

                  li.appendChild(row);
                  list.appendChild(li);
                }

                if (baseService) {
                  const li = document.createElement("li");
                  li.className = "journalist-topic-item";

                  const row = document.createElement("div");
                  row.className = "journalist-topic-row";

                  const name = document.createElement("span");
                  name.textContent = baseService;

                  const inText = document.createElement("span");
                  inText.textContent = "in";

                  const testataName = String(j?.testata || "").trim();
                  if (testataName) {
                    const link = document.createElement("a");
                    link.href = "#";
                    link.className = "c-link c-link--nav testata-link";
                    link.textContent = testataName;
                    link.setAttribute("data-testata", testataName);

                    row.appendChild(name);
                    row.appendChild(inText);
                    row.appendChild(link);
                  } else {
                    row.appendChild(name);
                  }

                  li.appendChild(row);
                  list.appendChild(li);
                }

                if (!baseService && custom.length === 0) {
                  const li = document.createElement("li");
                  li.className = "journalist-topic-item";
                  li.innerHTML = '<span class="muted">n/d</span>';
                  list.appendChild(li);
                }
              };

              const showEditor = (mode, index, value) => {
                editor.hidden = false;
                editor.setAttribute("data-topic-mode", mode);
                if (typeof index === "number") {
                  editor.setAttribute("data-topic-edit-index", String(index));
                } else {
                  editor.removeAttribute("data-topic-edit-index");
                }
                input.value = String(value ?? "");
                input.focus();
              };

              const hideEditor = () => {
                editor.hidden = true;
                editor.removeAttribute("data-topic-mode");
                editor.removeAttribute("data-topic-edit-index");
                input.value = "";
              };

              if (action === "add") {
                showEditor("add", null, "");
                return;
              }

              const topicItem = topicActionEl.closest("[data-topic-index]");
              const indexRaw = topicItem?.getAttribute?.("data-topic-index");
              const index = indexRaw != null ? Number(indexRaw) : NaN;

              if (action === "edit") {
                if (!Number.isFinite(index)) return;
                const custom = normalizeCustom(j?.customServices);
                showEditor("edit", index, custom[index]?.name ?? "");
                return;
              }

              if (action === "remove") {
                if (!Number.isFinite(index)) return;
                const custom = normalizeCustom(j?.customServices);
                custom.splice(index, 1);
                setCustom(custom);
                hideEditor();
                renderList();
                return;
              }

              if (action === "cancel") {
                hideEditor();
                return;
              }

              if (action === "ok") {
                const value = String(input.value ?? "").trim();
                if (!value) {
                  hideEditor();
                  return;
                }

                const mode = String(
                  editor.getAttribute("data-topic-mode") || "",
                )
                  .trim()
                  .toLowerCase();
                const custom = normalizeCustom(j?.customServices);

                if (mode === "edit") {
                  const editIndex = Number(
                    editor.getAttribute("data-topic-edit-index"),
                  );
                  if (Number.isFinite(editIndex) && editIndex >= 0) {
                    custom[editIndex] = { name: value };
                  }
                } else {
                  custom.unshift({ name: value });
                }

                setCustom(custom);
                hideEditor();
                renderList();
                return;
              }
            }
          }

          const contactActionEl = e.target?.closest?.("[data-contact-action]");
          if (contactActionEl) {
            const contactsSection = contactActionEl.closest(
              "[data-journalist-contacts]",
            );
            if (contactsSection) {
              e.preventDefault();
              e.stopPropagation();

              const action = String(
                contactActionEl.getAttribute("data-contact-action") || "",
              )
                .trim()
                .toLowerCase();
              const kind = String(
                contactActionEl.getAttribute("data-contact-kind") || "",
              )
                .trim()
                .toLowerCase();
              const jid = String(
                contactsSection.getAttribute("data-jid") || "",
              ).trim();
              if (!jid || !kind) return;

              const j = (journalists || []).find(
                (x) => getJournalistId(x) === jid,
              );
              if (!j) return;

              const group = contactsSection.querySelector(
                `[data-contact-group-kind="${kind}"]`,
              );
              if (!group) return;

              const editor = group.querySelector(
                `[data-contact-editor][data-contact-kind="${kind}"]`,
              );
              const list = group.querySelector(
                `[data-contact-list][data-contact-kind="${kind}"]`,
              );
              if (!editor || !list) return;

              const input = editor.querySelector(
                `[data-contact-input][data-contact-kind="${kind}"]`,
              );
              const select = editor.querySelector(
                `[data-contact-select][data-contact-kind="${kind}"]`,
              );
              const testataName = String(j?.testata || "").trim();

              const normalizeText = (v) => String(v ?? "").trim();

              const updateJournalistHeaderContacts = () => {
                const table = document.querySelector(
                  "[data-journalist-header-contacts]",
                );
                if (!table) return;

                const getPreferredContact = ({
                  customItems,
                  programItems,
                  preferred,
                  fallbackItem,
                }) => {
                  const custom = customItems.filter(
                    (x) => normalizeText(x.value).length > 0,
                  );
                  const program = programItems.filter(
                    (x) => normalizeText(x.value).length > 0,
                  );

                  if (program.length === 0 && fallbackItem) {
                    const v = normalizeText(fallbackItem.value);
                    if (v)
                      program.push({ value: v, label: fallbackItem.label });
                  }

                  if (preferred && typeof preferred === "object") {
                    const origin = normalizeText(
                      preferred.origin,
                    ).toLowerCase();
                    const idx = preferred.index;
                    if (
                      origin === "custom" &&
                      Number.isFinite(idx) &&
                      custom[idx]
                    ) {
                      return { ...custom[idx] };
                    }
                    if (
                      origin === "program" &&
                      Number.isFinite(idx) &&
                      program[idx]
                    ) {
                      return { ...program[idx] };
                    }
                  }

                  if (custom[0]) return { ...custom[0] };
                  if (program[0]) return { ...program[0] };
                  return null;
                };

                const phone = getPreferredContact({
                  customItems: (Array.isArray(j.customPhones)
                    ? j.customPhones
                    : []
                  ).map((x) => ({
                    value: normalizeText(x?.number ?? x?.tel ?? x?.value ?? x),
                    label:
                      normalizeText(x?.type ?? x?.kind ?? "") || "cellulare",
                  })),
                  programItems: (Array.isArray(j?.programPhones)
                    ? j.programPhones
                    : []
                  ).map((x) => ({
                    value: normalizeText(x?.number ?? x?.tel ?? x?.value ?? x),
                    label:
                      normalizeText(x?.type ?? x?.kind ?? "") || "cellulare",
                  })),
                  preferred: j?.preferredPhone,
                  fallbackItem: { value: j?.tel, label: "cellulare" },
                });

                const email = getPreferredContact({
                  customItems: (Array.isArray(j.customEmails)
                    ? j.customEmails
                    : []
                  ).map((x) => ({
                    value: normalizeText(x?.email ?? x?.value ?? x),
                    label: normalizeText(x?.type ?? "") || "mail diretta",
                  })),
                  programItems: (Array.isArray(j?.programEmails)
                    ? j.programEmails
                    : []
                  ).map((x) => ({
                    value: normalizeText(x?.email ?? x?.value ?? x),
                    label: normalizeText(x?.type ?? "") || "mail diretta",
                  })),
                  preferred: j?.preferredEmail,
                  fallbackItem: { value: j?.email, label: "mail diretta" },
                });

                const setCell = (key, text) => {
                  const el = table.querySelector(
                    `[data-header-contact="${key}"]`,
                  );
                  if (el) el.textContent = text;
                };

                setCell("phone-value", normalizeText(phone?.value) || "n/d");
                setCell("phone-label", normalizeText(phone?.label) || "");
                setCell("email-value", normalizeText(email?.value) || "n/d");
                setCell("email-label", normalizeText(email?.label) || "");
              };

              const setPreferred = (origin, index) => {
                if (kind === "phone") {
                  const items = Array.isArray(j.customPhones)
                    ? j.customPhones
                    : [];
                  for (let i = 0; i < items.length; i++) {
                    const it = items[i];
                    if (it && typeof it === "object") it.isPrimary = false;
                  }
                  if (origin === "custom" && Number.isFinite(index)) {
                    if (items[index] && typeof items[index] === "object") {
                      items[index].isPrimary = true;
                    }
                  }
                  j.customPhones = items;
                  j.preferredPhone = { origin, index };
                  return;
                }
                if (kind === "email") {
                  const items = Array.isArray(j.customEmails)
                    ? j.customEmails
                    : [];
                  for (let i = 0; i < items.length; i++) {
                    const it = items[i];
                    if (it && typeof it === "object") it.isDefault = false;
                  }
                  if (origin === "custom" && Number.isFinite(index)) {
                    if (items[index] && typeof items[index] === "object") {
                      items[index].isDefault = true;
                    }
                  }
                  j.customEmails = items;
                  j.preferredEmail = { origin, index };
                }
              };

              const render = () => {
                list.innerHTML = "";

                const makeColGroup = () => {
                  const colgroup = document.createElement("colgroup");
                  const c1 = document.createElement("col");
                  const c2 = document.createElement("col");
                  const c3 = document.createElement("col");
                  const c4 = document.createElement("col");
                  if (kind === "phone") {
                    c1.style.width = "16ch";
                    c2.style.width = "16ch";
                    c3.style.width = "16ch";
                    c4.style.width = "12ch";
                  } else if (kind === "email") {
                    c1.style.width = "18ch";
                    c2.style.width = "16ch";
                    c3.style.width = "16ch";
                    c4.style.width = "12ch";
                  }
                  colgroup.appendChild(c1);
                  colgroup.appendChild(c2);
                  colgroup.appendChild(c3);
                  colgroup.appendChild(c4);
                  return colgroup;
                };

                if (kind === "phone" || kind === "email") {
                  list.appendChild(makeColGroup());
                }

                const makeTestataLink = () => {
                  if (!testataName) return null;
                  const link = document.createElement("a");
                  link.href = "#";
                  link.className = "c-link c-link--nav testata-link";
                  link.textContent = testataName;
                  link.setAttribute("data-testata", testataName);
                  return link;
                };

                if (kind === "phone") {
                  const custom = (
                    Array.isArray(j.customPhones) ? j.customPhones : []
                  )
                    .map((x) => ({
                      number: normalizeText(
                        x?.number ?? x?.tel ?? x?.value ?? x,
                      ),
                      type: normalizeText(x?.type ?? x?.kind ?? ""),
                      isPrimary: Boolean(x?.isPrimary),
                    }))
                    .filter((x) => x.number.length > 0);
                  j.customPhones = custom;

                  const tbody = document.createElement("tbody");
                  list.appendChild(tbody);

                  for (let i = 0; i < custom.length; i++) {
                    const it = custom[i];
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-contact-kind", "phone");
                    tr.setAttribute("data-contact-index", String(i));

                    const tdNumber = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = it.number;
                      tdNumber.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = it.type || "cellulare";
                      tdType.appendChild(s);
                    }
                    const tdTestata = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.textContent = "";
                      tdTestata.appendChild(s);
                    }

                    const preferred = document.createElement("a");
                    preferred.href = "#";
                    preferred.className = `journalist-contact-preferred c-link c-link--action${
                      j?.preferredPhone?.origin === "custom" &&
                      j?.preferredPhone?.index === i
                        ? " is-active"
                        : ""
                    }`;
                    preferred.textContent = "predefinito";
                    preferred.setAttribute(
                      "data-contact-action",
                      "set-primary",
                    );
                    preferred.setAttribute("data-contact-kind", "phone");
                    preferred.setAttribute("data-contact-origin", "custom");

                    const edit = document.createElement("a");
                    edit.href = "#";
                    edit.className = "c-link c-link--action";
                    edit.textContent = "modifica";
                    edit.setAttribute("data-contact-action", "edit");
                    edit.setAttribute("data-contact-kind", "phone");

                    const remove = document.createElement("a");
                    remove.href = "#";
                    remove.className = "c-link c-link--action";
                    remove.textContent = "rimuovi";
                    remove.setAttribute("data-contact-action", "remove");
                    remove.setAttribute("data-contact-kind", "phone");

                    const tdPreferred = document.createElement("td");
                    tdPreferred.appendChild(preferred);

                    const actions = document.createElement("span");
                    actions.className = "journalist-contact-row-actions";
                    actions.appendChild(edit);
                    actions.appendChild(remove);
                    tdPreferred.appendChild(actions);

                    tr.appendChild(tdNumber);
                    tr.appendChild(tdType);
                    tr.appendChild(tdTestata);
                    tr.appendChild(tdPreferred);
                    tbody.appendChild(tr);
                  }

                  const programItemsRaw = Array.isArray(j?.programPhones)
                    ? j.programPhones
                    : [];
                  const programItems = programItemsRaw
                    .map((x) => ({
                      number: normalizeText(
                        x?.number ?? x?.tel ?? x?.value ?? x,
                      ),
                      type: normalizeText(x?.type ?? x?.kind ?? ""),
                    }))
                    .filter((x) => x.number.length > 0);
                  if (programItems.length === 0) {
                    const v = normalizeText(j?.telefono);
                    if (v) programItems.push({ number: v, type: "cellulare" });
                  }
                  for (let pi = 0; pi < programItems.length; pi++) {
                    const it = programItems[pi];
                    const tr = document.createElement("tr");

                    const tdNumber = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = it.number;
                      tdNumber.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = it.type || "cellulare";
                      tdType.appendChild(s);
                    }
                    const tdTestata = document.createElement("td");

                    const preferred = document.createElement("a");
                    preferred.href = "#";
                    preferred.className = `journalist-contact-preferred c-link c-link--action${
                      j?.preferredPhone?.origin === "program" &&
                      j?.preferredPhone?.index === pi
                        ? " is-active"
                        : ""
                    }`;
                    preferred.textContent = "predefinito";
                    preferred.setAttribute(
                      "data-contact-action",
                      "set-primary",
                    );
                    preferred.setAttribute("data-contact-kind", "phone");
                    preferred.setAttribute("data-contact-origin", "program");
                    preferred.setAttribute(
                      "data-contact-program-index",
                      String(pi),
                    );
                    const link = makeTestataLink();
                    if (link) {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.appendChild(link);
                      tdTestata.appendChild(s);
                    } else {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.textContent = "";
                      tdTestata.appendChild(s);
                    }
                    const tdPreferred = document.createElement("td");
                    tdPreferred.appendChild(preferred);

                    tr.appendChild(tdNumber);
                    tr.appendChild(tdType);
                    tr.appendChild(tdTestata);
                    tr.appendChild(tdPreferred);
                    tbody.appendChild(tr);
                  }

                  if (programItems.length === 0 && custom.length === 0) {
                    const tr = document.createElement("tr");
                    const td = document.createElement("td");
                    td.colSpan = 4;
                    td.innerHTML = '<span class="muted">n/d</span>';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                  }
                  return;
                }

                if (kind === "email") {
                  const custom = (
                    Array.isArray(j.customEmails) ? j.customEmails : []
                  )
                    .map((x) => ({
                      email: normalizeText(x?.email ?? x?.value ?? x),
                      type: normalizeText(x?.type ?? ""),
                      isDefault: Boolean(x?.isDefault),
                    }))
                    .filter((x) => x.email.length > 0);
                  j.customEmails = custom;

                  const tbody = document.createElement("tbody");
                  list.appendChild(tbody);

                  for (let i = 0; i < custom.length; i++) {
                    const it = custom[i];
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-contact-kind", "email");
                    tr.setAttribute("data-contact-index", String(i));

                    const tdEmail = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = it.email;
                      tdEmail.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = it.type || "mail diretta";
                      tdType.appendChild(s);
                    }
                    const tdTestata = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.textContent = "";
                      tdTestata.appendChild(s);
                    }

                    const preferred = document.createElement("a");
                    preferred.href = "#";
                    preferred.className = `journalist-contact-preferred c-link c-link--action${
                      j?.preferredEmail?.origin === "custom" &&
                      j?.preferredEmail?.index === i
                        ? " is-active"
                        : ""
                    }`;
                    preferred.textContent = "predefinito";
                    preferred.setAttribute(
                      "data-contact-action",
                      "set-default",
                    );
                    preferred.setAttribute("data-contact-kind", "email");
                    preferred.setAttribute("data-contact-origin", "custom");

                    const edit = document.createElement("a");
                    edit.href = "#";
                    edit.className = "c-link c-link--action";
                    edit.textContent = "modifica";
                    edit.setAttribute("data-contact-action", "edit");
                    edit.setAttribute("data-contact-kind", "email");

                    const remove = document.createElement("a");
                    remove.href = "#";
                    remove.className = "c-link c-link--action";
                    remove.textContent = "rimuovi";
                    remove.setAttribute("data-contact-action", "remove");
                    remove.setAttribute("data-contact-kind", "email");

                    const tdPreferred = document.createElement("td");
                    tdPreferred.appendChild(preferred);

                    const actions = document.createElement("span");
                    actions.className = "journalist-contact-row-actions";
                    actions.appendChild(edit);
                    actions.appendChild(remove);
                    tdPreferred.appendChild(actions);

                    tr.appendChild(tdEmail);
                    tr.appendChild(tdType);
                    tr.appendChild(tdTestata);
                    tr.appendChild(tdPreferred);
                    tbody.appendChild(tr);
                  }

                  const programItemsRaw = Array.isArray(j?.programEmails)
                    ? j.programEmails
                    : [];
                  const programItems = programItemsRaw
                    .map((x) => ({
                      email: normalizeText(x?.email ?? x?.value ?? x),
                      type: normalizeText(x?.type ?? ""),
                    }))
                    .filter((x) => x.email.length > 0);
                  if (programItems.length === 0) {
                    const v = normalizeText(j?.email);
                    if (v)
                      programItems.push({ email: v, type: "mail diretta" });
                  }
                  for (let pi = 0; pi < programItems.length; pi++) {
                    const it = programItems[pi];
                    const tr = document.createElement("tr");

                    const tdEmail = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = it.email;
                      tdEmail.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = it.type || "mail diretta";
                      tdType.appendChild(s);
                    }
                    const tdTestata = document.createElement("td");

                    const preferred = document.createElement("a");
                    preferred.href = "#";
                    preferred.className = `journalist-contact-preferred c-link c-link--action${
                      j?.preferredEmail?.origin === "program" &&
                      j?.preferredEmail?.index === pi
                        ? " is-active"
                        : ""
                    }`;
                    preferred.textContent = "predefinito";
                    preferred.setAttribute(
                      "data-contact-action",
                      "set-default",
                    );
                    preferred.setAttribute("data-contact-kind", "email");
                    preferred.setAttribute("data-contact-origin", "program");
                    preferred.setAttribute(
                      "data-contact-program-index",
                      String(pi),
                    );
                    const link = makeTestataLink();
                    if (link) {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.appendChild(link);
                      tdTestata.appendChild(s);
                    } else {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.textContent = "";
                      tdTestata.appendChild(s);
                    }
                    const tdPreferred = document.createElement("td");
                    tdPreferred.appendChild(preferred);

                    tr.appendChild(tdEmail);
                    tr.appendChild(tdType);
                    tr.appendChild(tdTestata);
                    tr.appendChild(tdPreferred);
                    tbody.appendChild(tr);
                  }

                  if (programItems.length === 0 && custom.length === 0) {
                    const tr = document.createElement("tr");
                    const td = document.createElement("td");
                    td.colSpan = 4;
                    td.innerHTML = '<span class="muted">n/d</span>';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                  }
                  return;
                }

                if (kind === "social") {
                  const custom = (
                    Array.isArray(j.customSocials) ? j.customSocials : []
                  )
                    .map((x) => ({
                      url: normalizeText(x?.url ?? x?.value ?? x),
                      type: normalizeText(x?.type ?? ""),
                    }))
                    .filter((x) => x.url.length > 0);
                  j.customSocials = custom;

                  list.innerHTML = "";
                  const tbody = document.createElement("tbody");
                  list.appendChild(tbody);

                  for (let i = 0; i < custom.length; i++) {
                    const it = custom[i];
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-contact-kind", "social");
                    tr.setAttribute("data-contact-index", String(i));

                    const tdUrl = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = it.url;
                      tdUrl.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = it.type || "x";
                      tdType.appendChild(s);
                    }

                    const edit = document.createElement("a");
                    edit.href = "#";
                    edit.className = "c-link c-link--action";
                    edit.textContent = "modifica";
                    edit.setAttribute("data-contact-action", "edit");
                    edit.setAttribute("data-contact-kind", "social");

                    const remove = document.createElement("a");
                    remove.href = "#";
                    remove.className = "c-link c-link--action";
                    remove.textContent = "rimuovi";
                    remove.setAttribute("data-contact-action", "remove");
                    remove.setAttribute("data-contact-kind", "social");

                    const actions = document.createElement("span");
                    actions.className = "journalist-contact-row-actions";
                    actions.appendChild(edit);
                    actions.appendChild(remove);
                    tdUrl.appendChild(actions);

                    tr.appendChild(tdUrl);
                    tr.appendChild(tdType);
                    tbody.appendChild(tr);
                  }

                  const program = normalizeText(j?.social);
                  if (program) {
                    const tr = document.createElement("tr");
                    const tdUrl = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = program;
                      tdUrl.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = "x";
                      tdType.appendChild(s);
                    }
                    tr.appendChild(tdUrl);
                    tr.appendChild(tdType);
                    tbody.appendChild(tr);
                  }

                  if (!program && custom.length === 0) {
                    const tr = document.createElement("tr");
                    const td = document.createElement("td");
                    td.colSpan = 2;
                    td.innerHTML = '<span class="muted">n/d</span>';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                  }
                }
              };

              const showEditor = (mode, index, value, type) => {
                editor.hidden = false;
                editor.setAttribute("data-contact-mode", mode);
                if (typeof index === "number") {
                  editor.setAttribute("data-contact-edit-index", String(index));
                } else {
                  editor.removeAttribute("data-contact-edit-index");
                }
                if (input) input.value = String(value ?? "");
                if (select) select.value = String(type ?? select.value ?? "");
                input?.focus?.();
              };

              const hideEditor = () => {
                editor.hidden = true;
                editor.removeAttribute("data-contact-mode");
                editor.removeAttribute("data-contact-edit-index");
                if (input) input.value = "";
              };

              if (action === "add") {
                showEditor(
                  "add",
                  null,
                  "",
                  kind === "social" ? "x" : "cellulare",
                );
                return;
              }

              if (action === "set-primary" || action === "set-default") {
                const origin = String(
                  contactActionEl.getAttribute("data-contact-origin") ||
                    "custom",
                )
                  .trim()
                  .toLowerCase();
                const programIndex = Number(
                  contactActionEl.getAttribute("data-contact-program-index"),
                );
                const itemEl = contactActionEl.closest("[data-contact-index]");
                const idxRaw = itemEl?.getAttribute?.("data-contact-index");
                const idx = idxRaw != null ? Number(idxRaw) : NaN;
                if (origin === "program") {
                  setPreferred("program", programIndex);
                } else {
                  setPreferred("custom", idx);
                }
                updateJournalistHeaderContacts();
                render();
                scheduleRender();
                return;
              }

              const itemEl = contactActionEl.closest("[data-contact-index]");
              const idxRaw = itemEl?.getAttribute?.("data-contact-index");
              const idx = idxRaw != null ? Number(idxRaw) : NaN;

              if (action === "edit") {
                if (!Number.isFinite(idx)) return;
                if (kind === "phone") {
                  const items = Array.isArray(j.customPhones)
                    ? j.customPhones
                    : [];
                  showEditor(
                    "edit",
                    idx,
                    items[idx]?.number ??
                      items[idx]?.tel ??
                      items[idx]?.value ??
                      "",
                    items[idx]?.type ?? items[idx]?.kind ?? "cellulare",
                  );
                  return;
                }
                if (kind === "email") {
                  const items = Array.isArray(j.customEmails)
                    ? j.customEmails
                    : [];
                  showEditor(
                    "edit",
                    idx,
                    items[idx]?.email ?? items[idx]?.value ?? "",
                    null,
                  );
                  return;
                }
                if (kind === "social") {
                  const items = Array.isArray(j.customSocials)
                    ? j.customSocials
                    : [];
                  showEditor(
                    "edit",
                    idx,
                    items[idx]?.url ?? items[idx]?.value ?? "",
                    items[idx]?.type ?? "x",
                  );
                  return;
                }
              }

              if (action === "remove") {
                if (!Number.isFinite(idx)) return;
                if (kind === "phone") {
                  const items = Array.isArray(j.customPhones)
                    ? j.customPhones
                    : [];
                  if (
                    j?.preferredPhone?.origin === "custom" &&
                    Number.isFinite(j?.preferredPhone?.index)
                  ) {
                    if (j.preferredPhone.index === idx) {
                      j.preferredPhone = { origin: "program", index: 0 };
                    } else if (j.preferredPhone.index > idx) {
                      j.preferredPhone.index -= 1;
                    }
                  }
                  items.splice(idx, 1);
                  j.customPhones = items;
                  hideEditor();
                  render();
                  scheduleRender();
                  return;
                }
                if (kind === "email") {
                  const items = Array.isArray(j.customEmails)
                    ? j.customEmails
                    : [];
                  if (
                    j?.preferredEmail?.origin === "custom" &&
                    Number.isFinite(j?.preferredEmail?.index)
                  ) {
                    if (j.preferredEmail.index === idx) {
                      j.preferredEmail = { origin: "program", index: 0 };
                    } else if (j.preferredEmail.index > idx) {
                      j.preferredEmail.index -= 1;
                    }
                  }
                  items.splice(idx, 1);
                  j.customEmails = items;
                  hideEditor();
                  render();
                  scheduleRender();
                  return;
                }
                if (kind === "social") {
                  const items = Array.isArray(j.customSocials)
                    ? j.customSocials
                    : [];
                  items.splice(idx, 1);
                  j.customSocials = items;
                  hideEditor();
                  render();
                  return;
                }
              }

              if (action === "cancel") {
                hideEditor();
                return;
              }

              if (action === "ok") {
                const value = String(input?.value ?? "").trim();
                if (!value) {
                  hideEditor();
                  return;
                }

                const mode = String(
                  editor.getAttribute("data-contact-mode") || "",
                )
                  .trim()
                  .toLowerCase();
                const editIndex = Number(
                  editor.getAttribute("data-contact-edit-index"),
                );

                if (kind === "phone") {
                  const items = Array.isArray(j.customPhones)
                    ? [...j.customPhones]
                    : [];
                  const obj = {
                    number: value,
                    type: String(select?.value ?? "cellulare").trim(),
                    isPrimary:
                      mode === "edit" &&
                      Number.isFinite(editIndex) &&
                      items[editIndex] &&
                      typeof items[editIndex] === "object"
                        ? Boolean(items[editIndex]?.isPrimary)
                        : false,
                  };
                  if (mode === "edit" && Number.isFinite(editIndex)) {
                    items[editIndex] = obj;
                  } else {
                    items.unshift(obj);
                  }
                  j.customPhones = items;
                  hideEditor();
                  render();
                  scheduleRender();
                  return;
                }

                if (kind === "email") {
                  const items = Array.isArray(j.customEmails)
                    ? [...j.customEmails]
                    : [];
                  const obj = {
                    email: value,
                    isDefault:
                      mode === "edit" &&
                      Number.isFinite(editIndex) &&
                      items[editIndex] &&
                      typeof items[editIndex] === "object"
                        ? Boolean(items[editIndex]?.isDefault)
                        : false,
                  };
                  if (mode === "edit" && Number.isFinite(editIndex)) {
                    items[editIndex] = obj;
                  } else {
                    items.unshift(obj);
                  }
                  j.customEmails = items;
                  hideEditor();
                  render();
                  scheduleRender();
                  return;
                }

                if (kind === "social") {
                  const items = Array.isArray(j.customSocials)
                    ? [...j.customSocials]
                    : [];
                  const obj = {
                    url: value,
                    type: String(select?.value ?? "x").trim(),
                  };
                  if (mode === "edit" && Number.isFinite(editIndex)) {
                    items[editIndex] = obj;
                  } else {
                    items.unshift(obj);
                  }
                  j.customSocials = items;
                  hideEditor();
                  render();
                  return;
                }
              }
            }
          }

          const journalistLink = e.target?.closest?.(".journalist-link");
          if (journalistLink) {
            e.preventDefault();
            e.stopPropagation();
            const name =
              journalistLink.getAttribute("data-journalist") ||
              journalistLink.textContent;
            openJournalistPanel(name);
            return;
          }

          const testataLink = e.target?.closest?.(".testata-link");
          if (!testataLink) return;
          e.preventDefault();
          e.stopPropagation();
          const key = testataLink.getAttribute("data-testata-key");
          const testata =
            testataLink.getAttribute("data-testata") || testataLink.textContent;
          openTestataPanel(key || testata);
        });
      }

      document.addEventListener(
        "keydown",
        (e) => {
          const testataOpen = testataPanel?.classList?.contains("show");

          if (testataOpen && e.key === "Escape") {
            const cancel = testataPanelBody?.querySelector(
              '[data-note-editor]:not([hidden]) [data-note-action="cancel"]',
            );
            if (cancel) {
              e.preventDefault();
              e.stopPropagation();
              cancel.click();
              return;
            }

            const topicCancel = testataPanelBody?.querySelector(
              '[data-topic-editor]:not([hidden]) [data-topic-action="cancel"]',
            );
            if (topicCancel) {
              e.preventDefault();
              e.stopPropagation();
              topicCancel.click();
              return;
            }

            const contactCancel = testataPanelBody?.querySelector(
              '[data-contact-editor]:not([hidden]) [data-contact-action="cancel"]',
            );
            if (contactCancel) {
              e.preventDefault();
              e.stopPropagation();
              contactCancel.click();
              return;
            }
          }

          if (testataOpen && e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
            const active = document.activeElement;
            if (active?.matches?.("[data-note-textarea]")) {
              const ok = testataPanelBody?.querySelector(
                '[data-note-editor]:not([hidden]) [data-note-action="ok"]',
              );
              if (ok) {
                e.preventDefault();
                e.stopPropagation();
                ok.click();
                return;
              }
            }

            if (active?.matches?.("[data-topic-input]")) {
              const ok = testataPanelBody?.querySelector(
                '[data-topic-editor]:not([hidden]) [data-topic-action="ok"]',
              );
              if (ok) {
                e.preventDefault();
                e.stopPropagation();
                ok.click();
                return;
              }
            }

            if (
              active?.matches?.("[data-contact-input]") ||
              active?.matches?.("[data-contact-select]")
            ) {
              const editor = active?.closest?.("[data-contact-editor]");
              const ok = editor?.querySelector?.('[data-contact-action="ok"]');
              if (ok) {
                e.preventDefault();
                e.stopPropagation();
                ok.click();
                return;
              }
            }
          }

          if (e.key !== "Escape") return;
          if (addToShipmentModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeAddToShipmentModal();
            return;
          }
          if (addToNewShipmentModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeAddToNewShipmentModal();
            return;
          }
          if (addToListModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeAddToListModal();
            return;
          }
          if (saveListModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeSaveListModal();
            return;
          }
          if (notesModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeNotesModal();
            return;
          }

          if (!testataPanel?.classList?.contains("show")) return;
          e.preventDefault();
          e.stopPropagation();
          closeTestataPanel();
        },
        true,
      );

      let _renderRaf = null;
      function scheduleRender() {
        if (_renderRaf) return;
        _renderRaf = requestAnimationFrame(() => {
          _renderRaf = null;
          renderCards();
        });
      }

      function getSidebarMode() {
        const el = document.querySelector('input[name="sidebarMode"]:checked');
        const v = String(el?.value || "giornalisti")
          .trim()
          .toLowerCase();
        return v === "testate" ? "testate" : "giornalisti";
      }

      function setFilterDropdownEnabled(inst, enabled) {
        if (!inst) return;
        if (inst?.isOpen && !enabled) {
          inst.close();
        }
        if (inst?.input) {
          inst.input.disabled = !enabled;
        }
        const container = inst?.container;
        if (container) {
          container.classList.toggle("is-disabled", !enabled);
          container.setAttribute("aria-disabled", enabled ? "false" : "true");
        }
      }

      function applySidebarModeUI() {
        const effectiveMode = getSidebarMode();
        const enableJournalistFilters = true;

        const journalistFiltersSlot = document.getElementById(
          "journalistFiltersSlot",
        );
        const journalistFiltersContent = document.getElementById(
          "journalistFiltersContent",
        );
        const journalistFiltersPlaceholder = document.getElementById(
          "journalistFiltersPlaceholder",
        );

        if (journalistFiltersSlot && journalistFiltersContent) {
          if (!journalistFiltersSlot.dataset.baseHeight) {
            const h = journalistFiltersContent.offsetHeight || 0;
            journalistFiltersSlot.dataset.baseHeight = String(h);
            if (h) {
              journalistFiltersSlot.style.minHeight = `${h}px`;
            }
          }
        }

        if (journalistFiltersContent) {
          journalistFiltersContent.style.display = enableJournalistFilters
            ? ""
            : "none";
        }
        if (journalistFiltersPlaceholder) {
          journalistFiltersPlaceholder.style.display = enableJournalistFilters
            ? "none"
            : "flex";
        }

        setFilterDropdownEnabled(dropdown, enableJournalistFilters);
        setFilterDropdownEnabled(roleDropdown, enableJournalistFilters);
      }

      function getFilterState() {
        const selectedServices = Array.from(dropdown.selectedValues || []);
        const selectedRoles = Array.from(roleDropdown.selectedValues || []);
        const selectedTestataArgomenti = Array.from(
          testataArgomentoDropdown.selectedValues || [],
        );
        const selectedTestataTipoMedia = Array.from(
          testataTipoMediaDropdown.selectedValues || [],
        );
        const selectedTestataFrequenze = Array.from(
          testataFrequenzaDropdown.selectedValues || [],
        );
        const selectedTestataDiffusioni = Array.from(
          testataDiffusioneDropdown.selectedValues || [],
        );
        const activeTextTerms = getActiveTextTerms();
        const currentTextQuery = (textFilterInput?.value || "").trim();

        const servicesActive = selectedServices.length > 0;
        const rolesActive = selectedRoles.length > 0;
        const testataArgomentoActive = selectedTestataArgomenti.length > 0;
        const testataTipoMediaActive = selectedTestataTipoMedia.length > 0;
        const testataFrequenzaActive = selectedTestataFrequenze.length > 0;
        const testataDiffusioneActive = selectedTestataDiffusioni.length > 0;
        const textActive = activeTextTerms.length > 0;
        const active =
          servicesActive ||
          rolesActive ||
          testataArgomentoActive ||
          testataTipoMediaActive ||
          testataFrequenzaActive ||
          testataDiffusioneActive ||
          textActive;

        return {
          selectedServices,
          selectedRoles,
          selectedTestataArgomenti,
          selectedTestataTipoMedia,
          selectedTestataFrequenze,
          selectedTestataDiffusioni,
          activeTextTerms,
          currentTextQuery,
          servicesActive,
          rolesActive,
          testataArgomentoActive,
          testataTipoMediaActive,
          testataFrequenzaActive,
          testataDiffusioneActive,
          textActive,
          active,
        };
      }

      function renderCards() {
        const grid = document.getElementById("cardsGrid");
        const countJournalistsEl = document.getElementById(
          "sidebarCountJournalists",
        );
        const countTestateEl = document.getElementById("sidebarCountTestate");
        const subtitleEl = document.getElementById("cardsSubtitle");
        const clearFiltersLink = document.getElementById("clearFiltersLink");

        const sortByNameAscLink = document.getElementById("sortByNameAscLink");
        const sortByNameDescLink =
          document.getElementById("sortByNameDescLink");
        const sortByRoleLink = document.getElementById("sortByRoleLink");
        const sortByMediaTypeLink = document.getElementById(
          "sortByMediaTypeLink",
        );
        const sortByFrequencyLink = document.getElementById(
          "sortByFrequencyLink",
        );
        const sortSepAfterName = document.getElementById("sortSepAfterName");
        const sortSepAfterRole = document.getElementById("sortSepAfterRole");
        const sortSepAfterMediaType = document.getElementById(
          "sortSepAfterMediaType",
        );

        const journalistById = new Map(
          (journalists || []).map((j) => [getJournalistId(j), j]),
        );

        const {
          selectedServices,
          selectedRoles,
          selectedTestataArgomenti,
          selectedTestataTipoMedia,
          selectedTestataFrequenze,
          selectedTestataDiffusioni,
          activeTextTerms,
          currentTextQuery,
          servicesActive,
          rolesActive,
          testataArgomentoActive,
          testataTipoMediaActive,
          testataFrequenzaActive,
          testataDiffusioneActive,
          textActive,
          active,
        } = getFilterState();

        const isMailingListView = appState.view === "mailing-list";
        const activeList = isMailingListView
          ? getMailingListById(appState.activeMailingListId)
          : null;

        applySidebarModeUI();

        const mode = getSidebarMode();
        const isTestateMode = mode === "testate";

        if (bulkSelectControls) {
          bulkSelectControls.style.display = isTestateMode ? "none" : "";
        }

        const sortMode = getSortMode();
        const effectiveSortMode =
          isTestateMode && sortMode === "role" ? "frequency" : sortMode;

        const keyLower = (x) =>
          String(x || "")
            .trim()
            .toLowerCase();
        const getFreqSort = (freqLabel) => {
          const k = keyLower(freqLabel);
          if (k === "aperiodico" || k === "plurisettimanale") {
            return { indefinite: true, days: Number.POSITIVE_INFINITY };
          }
          const days =
            k === "quotidiano"
              ? 1
              : k === "trisettimanale"
                ? 7 / 3
                : k === "bisettimanale"
                  ? 7 / 2
                  : k === "settimanale"
                    ? 7
                    : k === "quattordicinale"
                      ? 14
                      : k === "quindicinale"
                        ? 15
                        : k === "mensile"
                          ? 30
                          : k === "bimestrale"
                            ? 60
                            : k === "trimestrale"
                              ? 90
                              : k === "quadrimestrale"
                                ? 120
                                : k === "semestrale"
                                  ? 182
                                  : k === "annuale"
                                    ? 365
                                    : k === "quadriennale"
                                      ? 365 * 4
                                      : Number.POSITIVE_INFINITY;
          return { indefinite: false, days };
        };

        const mediaParentOrder = ["Radio", "TV", "Carta Stampata", "Web"];
        const mediaParentRank = new Map(
          mediaParentOrder.map((p, idx) => [p, idx]),
        );
        const mediaChildRankByParent = new Map();
        for (const p of mediaParentOrder) {
          const list = (TESTATA_MEDIA_BY_PARENT || {})[p] || [];
          const map = new Map();
          list.forEach((c, idx) => map.set(String(c || ""), idx));
          mediaChildRankByParent.set(p, map);
        }
        const getTestataMediaRank = (t) => {
          const p = String(t?.tipoMedia?.parent || "").trim();
          const c = String(t?.tipoMedia?.child || "").trim();
          const pr = mediaParentRank.has(p) ? mediaParentRank.get(p) : 999;
          const cr = mediaChildRankByParent.get(p)?.has(c)
            ? mediaChildRankByParent.get(p).get(c)
            : 999;
          return pr * 1000 + cr;
        };
        if (sortByNameAscLink) {
          sortByNameAscLink.classList.toggle(
            "is-active",
            effectiveSortMode === "name-asc",
          );
          sortByNameAscLink.setAttribute(
            "aria-current",
            effectiveSortMode === "name-asc" ? "true" : "false",
          );
        }
        if (sortByNameDescLink) {
          sortByNameDescLink.classList.toggle(
            "is-active",
            effectiveSortMode === "name-desc",
          );
          sortByNameDescLink.setAttribute(
            "aria-current",
            effectiveSortMode === "name-desc" ? "true" : "false",
          );
        }

        {
          const labelBySortMode = {
            "name-asc": "nome a-z",
            "name-desc": "nome z-a",
            role: "ruolo",
            "media-type": "tipo di media",
            frequency: "frequenza",
          };

          const label = labelBySortMode[effectiveSortMode] || "nome a-z";
          if (sortByNameSelectValue) sortByNameSelectValue.textContent = label;

          const isAsc = effectiveSortMode === "name-asc";
          const isDesc = effectiveSortMode === "name-desc";
          const isRole = effectiveSortMode === "role";
          const isMediaType = effectiveSortMode === "media-type";
          const isFrequency = effectiveSortMode === "frequency";

          const setOptionState = (el, active) => {
            if (!el) return;
            el.setAttribute("aria-selected", active ? "true" : "false");
            const a = el.querySelector(".sort-link");
            if (a) a.classList.toggle("is-active", active);
          };

          setOptionState(sortByNameOptionAsc, isAsc);
          setOptionState(sortByNameOptionDesc, isDesc);
          setOptionState(sortByNameOptionRole, isRole);
          setOptionState(sortByNameOptionMediaType, isMediaType);
          setOptionState(sortByNameOptionFrequency, isFrequency);

          if (sortByNameOptionRole) {
            sortByNameOptionRole.style.display = isTestateMode ? "none" : "";
          }
        }
        if (sortByRoleLink) {
          sortByRoleLink.style.display = isTestateMode ? "none" : "";
          sortByRoleLink.classList.toggle(
            "is-active",
            effectiveSortMode === "role",
          );
          sortByRoleLink.setAttribute(
            "aria-current",
            effectiveSortMode === "role" ? "true" : "false",
          );
        }

        if (sortByMediaTypeLink) {
          sortByMediaTypeLink.classList.toggle(
            "is-active",
            effectiveSortMode === "media-type",
          );
          sortByMediaTypeLink.setAttribute(
            "aria-current",
            effectiveSortMode === "media-type" ? "true" : "false",
          );
        }

        if (sortByFrequencyLink) {
          sortByFrequencyLink.classList.toggle(
            "is-active",
            effectiveSortMode === "frequency",
          );
          sortByFrequencyLink.setAttribute(
            "aria-current",
            effectiveSortMode === "frequency" ? "true" : "false",
          );
        }

        if (sortSepAfterRole) {
          sortSepAfterRole.style.display = isTestateMode ? "none" : "";
        }

        if (mainTitleEl) {
          if (isMailingListView && activeList) {
            mainTitleEl.textContent = activeList.name;
          } else {
            mainTitleEl.textContent = "Banca Dati";
          }
        }

        if (isMailingListView && activeList) {
          if (chooseDatabaseLink) chooseDatabaseLink.style.display = "none";
          if (mailingListActions) mailingListActions.style.display = "flex";

          const count = Array.isArray(activeList.journalistIds)
            ? activeList.journalistIds.length
            : 0;
          if (mailingListCountPill) {
            mailingListCountPill.textContent = String(count);
            mailingListCountPill.style.display = "inline-block";
          }

          if (mailingListCreatedAtSubtitle) {
            const createdAt = Number(activeList.createdAt || 0);
            if (Number.isFinite(createdAt) && createdAt > 0) {
              const stamp = new Date(createdAt).toLocaleDateString("it-IT");
              const sharedWith = Array.isArray(activeList.sharedWith)
                ? activeList.sharedWith
                : [];
              const n = sharedWith.filter(Boolean).length;
              const status = n > 0 ? `lista condivisa (${n})` : "lista privata";
              mailingListCreatedAtSubtitle.innerHTML = `creata il ${stamp} da @ugo <span class="sidebar-mode-separator" aria-hidden="true">&nbsp;•&nbsp;</span> ${status} &nbsp;<a href="#" class="c-link c-link--nav" id="mailingListShareLink">condividi</a>`;
              mailingListCreatedAtSubtitle.style.display = "block";
            } else {
              mailingListCreatedAtSubtitle.textContent = "";
              mailingListCreatedAtSubtitle.style.display = "none";
            }
          }
        } else {
          if (chooseDatabaseLink) chooseDatabaseLink.style.display = "";
          if (mailingListActions) mailingListActions.style.display = "none";
          if (mailingListCountPill) {
            mailingListCountPill.textContent = "";
            mailingListCountPill.style.display = "none";
          }
          if (mailingListCreatedAtSubtitle) {
            mailingListCreatedAtSubtitle.textContent = "";
            mailingListCreatedAtSubtitle.style.display = "none";
          }
        }

        if (mailingListCreatedAtSubtitle) {
          const shareLink = mailingListCreatedAtSubtitle.querySelector(
            "#mailingListShareLink",
          );
          if (shareLink) {
            shareLink.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              openShareListModal();
            });
          }
        }

        const baseJournalists = (() => {
          if (!isMailingListView || !activeList) return journalists;
          const allowed = new Set(activeList.journalistIds || []);
          return journalists.filter((j) => allowed.has(getJournalistId(j)));
        })();

        const mailingAllowedJids =
          isMailingListView && activeList
            ? new Set(activeList.journalistIds || [])
            : null;

        const matchesJournalist = (j) => {
          const serviceOk =
            !servicesActive || selectedServices.includes(j.servizio);
          const roleOk = !rolesActive || selectedRoles.includes(j.ruolo);

          const tKeys = getJournalistTestate(j)
            .map((x) => normalizeTestataKey(x))
            .filter(Boolean);
          const testateObjs = tKeys
            .map((k) => testateByKey.get(k))
            .filter(Boolean);
          const testataArgomentoOk =
            !testataArgomentoActive ||
            testateObjs.some((t) =>
              selectedTestataArgomenti.includes(String(t?.argomento || "")),
            );
          const testataTipoMediaOk =
            !testataTipoMediaActive ||
            testateObjs.some((t) =>
              selectedTestataTipoMedia.includes(
                String(t?.tipoMedia?.child || ""),
              ),
            );
          const testataFrequenzaOk =
            !testataFrequenzaActive ||
            testateObjs.some((t) =>
              selectedTestataFrequenze.includes(
                String(t?.frequenzaPubblicazione || ""),
              ),
            );
          const testataDiffusioneOk =
            !testataDiffusioneActive ||
            testateObjs.some((t) =>
              selectedTestataDiffusioni.includes(String(t?.diffusione || "")),
            );

          const fullName = `${j.nome} ${j.cognome}`.toLowerCase();
          const testata = getJournalistTestate(j).join(" ").toLowerCase();
          const noteCombined = combineNotes(
            normalizeNotes(j.note),
          ).toLowerCase();

          const textOk =
            !textActive ||
            activeTextTerms.every((term) => {
              const q = String(term || "")
                .trim()
                .toLowerCase();
              if (!q) return true;
              return (
                fullName.includes(q) ||
                testata.includes(q) ||
                noteCombined.includes(q)
              );
            });

          return (
            serviceOk &&
            roleOk &&
            testataArgomentoOk &&
            testataTipoMediaOk &&
            testataFrequenzaOk &&
            testataDiffusioneOk &&
            textOk
          );
        };

        const matchesTestata = (t) => {
          const jids = Array.isArray(t?.redazione?.giornalisti)
            ? t.redazione.giornalisti
            : [];

          const relevantJids = mailingAllowedJids
            ? jids.filter((jid) => mailingAllowedJids.has(jid))
            : jids;

          if (mailingAllowedJids && relevantJids.length === 0) {
            return false;
          }

          const servizioOk =
            !servicesActive ||
            relevantJids.some((jid) => {
              const j = journalistById.get(jid);
              if (!j) return false;
              return selectedServices.includes(String(j?.servizio || ""));
            });

          const ruoloOk =
            !rolesActive ||
            relevantJids.some((jid) => {
              const j = journalistById.get(jid);
              if (!j) return false;
              return selectedRoles.includes(String(j?.ruolo || ""));
            });

          const argomentoOk =
            !testataArgomentoActive ||
            selectedTestataArgomenti.includes(String(t?.argomento || ""));

          const tipoMediaOk =
            !testataTipoMediaActive ||
            selectedTestataTipoMedia.includes(
              String(t?.tipoMedia?.child || ""),
            );

          const frequenzaOk =
            !testataFrequenzaActive ||
            selectedTestataFrequenze.includes(
              String(t?.frequenzaPubblicazione || ""),
            );

          const diffusioneOk =
            !testataDiffusioneActive ||
            selectedTestataDiffusioni.includes(String(t?.diffusione || ""));

          const textOk =
            !textActive ||
            (() => {
              const nome = String(t?.nome || "").toLowerCase();
              const argomento = String(t?.argomento || "").toLowerCase();
              const note = combineNotes(normalizeNotes(t?.note)).toLowerCase();
              const giornalisti = relevantJids
                .map((jid) => getJournalistNameById(jid))
                .join(" ")
                .toLowerCase();

              return activeTextTerms.every((term) => {
                const q = String(term || "")
                  .trim()
                  .toLowerCase();
                if (!q) return true;
                return (
                  nome.includes(q) ||
                  argomento.includes(q) ||
                  note.includes(q) ||
                  giornalisti.includes(q)
                );
              });
            })();

          return (
            servizioOk &&
            ruoloOk &&
            argomentoOk &&
            tipoMediaOk &&
            frequenzaOk &&
            diffusioneOk &&
            textOk
          );
        };

        if (countJournalistsEl) {
          const filteredCount = (baseJournalists || []).filter(
            matchesJournalist,
          ).length;
          countJournalistsEl.textContent = String(filteredCount);
        }
        if (countTestateEl) {
          const filteredCount = (testate || []).filter(matchesTestata).length;
          countTestateEl.textContent = String(filteredCount);
        }

        const effectiveActive = isTestateMode
          ? textActive ||
            testataArgomentoActive ||
            testataTipoMediaActive ||
            testataFrequenzaActive ||
            testataDiffusioneActive ||
            servicesActive ||
            rolesActive
          : active;
        if (clearFiltersLink) {
          clearFiltersLink.style.display = effectiveActive
            ? "inline-block"
            : "none";
        }

        if (isTestateMode) {
          const filteredTestate = (testate || []).filter(matchesTestata);
          const sortedTestate = [...filteredTestate].sort((a, b) => {
            if (effectiveSortMode === "frequency") {
              const fa = getFreqSort(a?.frequenzaPubblicazione);
              const fb = getFreqSort(b?.frequenzaPubblicazione);
              if (fa.indefinite !== fb.indefinite) {
                return fa.indefinite ? 1 : -1;
              }
              if (fa.days !== fb.days) {
                return fa.days - fb.days;
              }
              return compareTestateByName(a, b);
            }
            if (effectiveSortMode === "media-type") {
              const ra = getTestataMediaRank(a);
              const rb = getTestataMediaRank(b);
              return ra - rb || compareTestateByName(a, b);
            }
            if (sortMode === "name-desc") {
              return compareTestateByName(b, a);
            }
            return compareTestateByName(a, b);
          });

          grid.innerHTML = "";
          for (const t of sortedTestate) {
            grid.appendChild(createTestataCard(t, activeTextTerms));
          }

          {
            const set = new Set();
            for (const t of sortedTestate) {
              const jids = Array.isArray(t?.redazione?.giornalisti)
                ? t.redazione.giornalisti
                : [];
              for (const jid of jids) {
                const id = String(jid || "").trim();
                if (!id) continue;
                if (mailingAllowedJids && !mailingAllowedJids.has(id)) continue;
                set.add(id);
              }
            }
            lastRenderedVisibleJournalistIds = Array.from(set);
          }

          if (!effectiveActive) {
            subtitleEl.textContent = "";
          } else {
            subtitleEl.innerHTML = "";
            const bar = document.createElement("div");
            bar.className = "filters-bar";

            const createChip = (value, onRemove) => {
              const chip = document.createElement("span");
              chip.className = "chip";

              const text = document.createElement("span");
              text.textContent = value;

              const remove = document.createElement("button");
              remove.type = "button";
              remove.className = "chip-remove";
              remove.textContent = "×";
              remove.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                onRemove();
              });

              chip.appendChild(text);
              chip.appendChild(remove);
              return chip;
            };

            const makeRow = (labelText) => {
              const row = document.createElement("div");
              row.className = "filters-row";

              const label = document.createElement("span");
              label.className = "filters-section-label";
              label.textContent = labelText;
              row.appendChild(label);
              return row;
            };

            if (textActive) {
              const row = makeRow("Termine:");
              for (const term of committedTextTerms) {
                row.appendChild(
                  createChip(term, () => {
                    const idx = committedTextTerms.indexOf(term);
                    if (idx !== -1) committedTextTerms.splice(idx, 1);
                    updateTextFilterClearVisibility();
                    scheduleRender();
                  }),
                );
              }

              if (currentTextQuery) {
                row.appendChild(
                  createChip(currentTextQuery, () => {
                    if (!textFilterInput) return;
                    textFilterInput.value = "";
                    updateTextFilterClearVisibility();
                    scheduleRender();
                  }),
                );
              }

              bar.appendChild(row);
            }

            if (servicesActive) {
              const row = makeRow("Servizio:");
              for (const s of selectedServices) {
                row.appendChild(
                  createChip(s, () => {
                    dropdown.removeOption(s);
                  }),
                );
              }
              bar.appendChild(row);
            }

            if (rolesActive) {
              const row = makeRow("Ruolo:");
              for (const r of selectedRoles) {
                row.appendChild(
                  createChip(r, () => {
                    roleDropdown.removeOption(r);
                  }),
                );
              }
              bar.appendChild(row);
            }

            if (testataArgomentoActive) {
              const row = makeRow("Argomento testata:");
              for (const a of selectedTestataArgomenti) {
                row.appendChild(
                  createChip(a, () => {
                    testataArgomentoDropdown.removeOption(a);
                  }),
                );
              }
              bar.appendChild(row);
            }

            if (testataTipoMediaActive) {
              const row = makeRow("Tipo media:");
              for (const tm of selectedTestataTipoMedia) {
                row.appendChild(
                  createChip(tm, () => {
                    testataTipoMediaDropdown.removeOption(tm);
                  }),
                );
              }
              bar.appendChild(row);
            }

            if (testataFrequenzaActive) {
              const row = makeRow("Frequenza di pubblicazione:");
              for (const f of selectedTestataFrequenze) {
                row.appendChild(
                  createChip(f, () => {
                    testataFrequenzaDropdown.removeOption(f);
                  }),
                );
              }
              bar.appendChild(row);
            }

            if (testataDiffusioneActive) {
              const row = makeRow("Diffusione:");
              for (const d of selectedTestataDiffusioni) {
                row.appendChild(
                  createChip(d, () => {
                    testataDiffusioneDropdown.removeOption(d);
                  }),
                );
              }
              bar.appendChild(row);
            }

            subtitleEl.appendChild(bar);
          }
          return;
        }

        const filtered = (baseJournalists || []).filter(matchesJournalist);
        const sorted = [...filtered].sort((a, b) => {
          if (effectiveSortMode === "role") {
            const ra = getRoleRank(a?.ruolo);
            const rb = getRoleRank(b?.ruolo);
            return ra - rb || compareJournalistsByName(a, b);
          }
          if (effectiveSortMode === "media-type") {
            const getMediaKey = (j) => {
              const t = getJournalistTestate(j);
              const first = String(t?.[0] || "").trim();
              if (!first) return "";
              const key = normalizeTestataKey(first);
              const testata = testateByKey.get(key);
              const p = String(testata?.tipoMedia?.parent || "").trim();
              const c = String(testata?.tipoMedia?.child || "").trim();
              return p && c ? `${p} / ${c}` : p || c;
            };
            const ka = getMediaKey(a);
            const kb = getMediaKey(b);
            if (!!ka !== !!kb) return ka ? -1 : 1;
            const cmp = String(ka || "").localeCompare(String(kb || ""), "it", {
              sensitivity: "base",
            });
            return cmp || compareJournalistsByName(a, b);
          }
          if (effectiveSortMode === "frequency") {
            const getJournalistFreq = (j) => {
              const t = getJournalistTestate(j);
              const first = String(t?.[0] || "").trim();
              if (!first) return "";
              const k = normalizeTestataKey(first);
              const testata = testateByKey.get(k);
              return String(testata?.frequenzaPubblicazione || "").trim();
            };

            const fa = getFreqSort(getJournalistFreq(a));
            const fb = getFreqSort(getJournalistFreq(b));
            if (fa.indefinite !== fb.indefinite) {
              return fa.indefinite ? 1 : -1;
            }
            if (fa.days !== fb.days) {
              return fa.days - fb.days;
            }
            return compareJournalistsByName(a, b);
          }
          if (effectiveSortMode === "name-desc") {
            return compareJournalistsByName(b, a);
          }
          return compareJournalistsByName(a, b);
        });

        grid.innerHTML = "";
        for (const j of sorted) {
          grid.appendChild(createCard(j));
        }

        lastRenderedVisibleJournalistIds = sorted
          .map((j) => String(getJournalistId(j) || "").trim())
          .filter(Boolean);

        requestAnimationFrame(() => {
          updateJournalistTestateLabelLinks(grid);
          scheduleUpdateCardNameLayouts();
        });

        if (!active) {
          subtitleEl.textContent = "";
        } else {
          subtitleEl.innerHTML = "";

          const bar = document.createElement("div");
          bar.className = "filters-bar";

          const createChip = (value, onRemove) => {
            const chip = document.createElement("span");
            chip.className = "chip";

            const text = document.createElement("span");
            text.textContent = value;

            const remove = document.createElement("button");
            remove.type = "button";
            remove.className = "chip-remove";
            remove.textContent = "×";
            remove.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              onRemove();
            });

            chip.appendChild(text);
            chip.appendChild(remove);
            return chip;
          };

          const makeRow = (labelText) => {
            const row = document.createElement("div");
            row.className = "filters-row";

            const label = document.createElement("span");
            label.className = "filters-section-label";
            label.textContent = labelText;
            row.appendChild(label);
            return row;
          };

          if (textActive) {
            const row = makeRow("Termine:");

            for (const t of committedTextTerms) {
              row.appendChild(
                createChip(t, () => {
                  const idx = committedTextTerms.indexOf(t);
                  if (idx !== -1) committedTextTerms.splice(idx, 1);
                  updateTextFilterClearVisibility();
                  scheduleRender();
                }),
              );
            }

            if (currentTextQuery) {
              row.appendChild(
                createChip(currentTextQuery, () => {
                  if (!textFilterInput) return;
                  textFilterInput.value = "";
                  updateTextFilterClearVisibility();
                  scheduleRender();
                }),
              );
            }
            bar.appendChild(row);
          }

          if (servicesActive) {
            const row = makeRow("Servizio:");
            for (const s of selectedServices) {
              row.appendChild(
                createChip(s, () => {
                  dropdown.removeOption(s);
                }),
              );
            }
            bar.appendChild(row);
          }

          if (rolesActive) {
            const row = makeRow("Ruolo:");
            for (const r of selectedRoles) {
              row.appendChild(
                createChip(r, () => {
                  roleDropdown.removeOption(r);
                }),
              );
            }
            bar.appendChild(row);
          }

          if (testataArgomentoActive) {
            const row = makeRow("Argomento testata:");
            for (const a of selectedTestataArgomenti) {
              row.appendChild(
                createChip(a, () => {
                  testataArgomentoDropdown.removeOption(a);
                }),
              );
            }
            bar.appendChild(row);
          }

          if (testataTipoMediaActive) {
            const row = makeRow("Tipo media:");
            for (const tm of selectedTestataTipoMedia) {
              row.appendChild(
                createChip(tm, () => {
                  testataTipoMediaDropdown.removeOption(tm);
                }),
              );
            }
            bar.appendChild(row);
          }

          if (testataFrequenzaActive) {
            const row = makeRow("Frequenza di pubblicazione:");
            for (const f of selectedTestataFrequenze) {
              row.appendChild(
                createChip(f, () => {
                  testataFrequenzaDropdown.removeOption(f);
                }),
              );
            }
            bar.appendChild(row);
          }

          if (testataDiffusioneActive) {
            const row = makeRow("Diffusione:");
            for (const d of selectedTestataDiffusioni) {
              row.appendChild(
                createChip(d, () => {
                  testataDiffusioneDropdown.removeOption(d);
                }),
              );
            }
            bar.appendChild(row);
          }

          subtitleEl.appendChild(bar);
        }
      }

      let isBulkFilterReset = false;

      const clearAllFilters = () => {
        isBulkFilterReset = true;
        dropdown.resetSelection();
        roleDropdown.resetSelection();
        testataArgomentoDropdown.resetSelection();
        testataTipoMediaDropdown.resetSelection();
        testataFrequenzaDropdown.resetSelection();
        testataDiffusioneDropdown.resetSelection();
        committedTextTerms.splice(0, committedTextTerms.length);
        if (textFilterInput) {
          textFilterInput.value = "";
          updateTextFilterClearVisibility();
        }
        isBulkFilterReset = false;
        scheduleRender();
      };

      dropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      roleDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      testataArgomentoDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      testataTipoMediaDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      testataFrequenzaDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      testataDiffusioneDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      const clearFiltersLink = document.getElementById("clearFiltersLink");
      if (clearFiltersLink) {
        clearFiltersLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          clearAllFilters();
        });
      }

      document.querySelectorAll('input[name="sidebarMode"]').forEach((el) => {
        el.addEventListener("change", () => {
          applySidebarModeUI();
          scheduleRender();
        });
      });

      const cardsGrid = document.getElementById("cardsGrid");
      if (cardsGrid) {
        scheduleUpdateCardNameLayouts();

        cardsGridResizeObserver = new ResizeObserver(() => {
          scheduleUpdateCardNameLayouts();
        });
        cardsGridResizeObserver.observe(cardsGrid);

        window.addEventListener("resize", () => {
          scheduleUpdateCardNameLayouts();
        });

        window.addEventListener("load", () => {
          scheduleUpdateCardNameLayouts();
        });

        if (document.fonts && document.fonts.ready) {
          document.fonts.ready.then(() => {
            scheduleUpdateCardNameLayouts();
          });
        }

        cardsGrid.addEventListener("click", (e) => {
          const removeFromListBtn = e.target?.closest?.(
            ".card-remove-from-list[data-remove-from-list-jid]",
          );
          const notesLink = e.target?.closest?.(".card-notes-open");
          const journalistsLink = e.target?.closest?.(
            ".card-testata-journalists-open",
          );
          const testateLabelLink = e.target?.closest?.(
            ".card-journalist-testate-open",
          );
          const testataLink = e.target?.closest?.(".testata-link");
          const journalistLink = e.target?.closest?.(".journalist-link");
          if (
            !removeFromListBtn &&
            !notesLink &&
            !journalistsLink &&
            !testateLabelLink &&
            !testataLink &&
            !journalistLink
          )
            return;

          e.preventDefault();
          e.stopPropagation();

          if (removeFromListBtn) {
            if (appState.view !== "mailing-list") return;

            const jid = removeFromListBtn.getAttribute(
              "data-remove-from-list-jid",
            );
            if (!jid) return;

            const activeList = getMailingListById(appState.activeMailingListId);
            if (!activeList || !Array.isArray(activeList.journalistIds)) return;

            activeList.journalistIds = (activeList.journalistIds || []).filter(
              (x) => String(x || "").trim() !== String(jid || "").trim(),
            );
            saveAppState(appState);

            if (selectedJournalistIds.has(jid)) {
              selectedJournalistIds.delete(jid);
              removeFromSelectedOrder(jid);
              updateCheckboxUI(jid);
              updateCardSelectionUI(jid);

              if (selectedJournalistIds.size === 0) {
                closeSelectedPanel();
              } else {
                renderSelectedPanelList();
              }
            }

            scheduleRender();
            return;
          }

          if (notesLink) {
            const jid = notesLink.getAttribute("data-jid");
            const testataKey = notesLink.getAttribute("data-testata-key");
            if (jid) {
              openNotesModal(jid);
              return;
            }
            if (testataKey) {
              openTestataNotesModal(testataKey);
              return;
            }
            return;
          }

          if (journalistsLink) {
            const testataKey = journalistsLink.getAttribute("data-testata-key");
            if (!testataKey) return;
            openTestataJournalistsModal(testataKey);
            return;
          }

          if (testateLabelLink) {
            const jid = testateLabelLink.getAttribute("data-jid");
            if (!jid) return;
            openJournalistTestateModal(jid);
            return;
          }

          if (journalistLink) {
            const name =
              journalistLink.getAttribute("data-journalist") ||
              journalistLink.textContent;
            openJournalistPanel(name);
            return;
          }

          const key = testataLink.getAttribute("data-testata-key");
          const testata =
            testataLink.getAttribute("data-testata") || testataLink.textContent;
          openTestataPanel(key || testata);
        });

        cardsGrid.addEventListener("change", (e) => {
          const checkbox = e.target?.closest?.(".card-select");
          if (!checkbox) return;
          const jid = checkbox.getAttribute("data-jid");
          if (!jid) return;

          const card = checkbox.closest(".card");
          if (checkbox.checked) {
            selectedJournalistIds.add(jid);
            ensureSelectedOrder(jid);
            card?.classList?.add("is-selected");
            openSelectedPanel();
          } else {
            selectedJournalistIds.delete(jid);
            removeFromSelectedOrder(jid);
            card?.classList?.remove("is-selected");
            if (selectedJournalistIds.size === 0) {
              closeSelectedPanel();
            } else {
              renderSelectedPanelList();
            }
          }
        });

        testataPanelBody.addEventListener("keydown", (e) => {
          if (e.key !== "Enter" && e.key !== " ") return;
          const toggleEl = e.target?.closest?.("[data-section-toggle]");
          if (!toggleEl) return;
          e.preventDefault();
          toggleEl.click();
        });
      }

      if (selectedPanelBody) {
        selectedPanelBody.addEventListener("click", (e) => {
          const journalistLink = e.target?.closest?.(".journalist-link");
          if (journalistLink) {
            e.preventDefault();
            e.stopPropagation();
            const name =
              journalistLink.getAttribute("data-journalist") ||
              journalistLink.textContent;
            openJournalistPanel(name);
            return;
          }

          const btn = e.target?.closest?.(".selected-item-remove");
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();

          const jid = btn.getAttribute("data-jid");
          if (!jid) return;

          selectedJournalistIds.delete(jid);
          removeFromSelectedOrder(jid);

          updateCheckboxUI(jid);
          updateCardSelectionUI(jid);

          if (selectedJournalistIds.size === 0) {
            closeSelectedPanel();
          } else {
            renderSelectedPanelList();
          }
        });
      }

      const navSidebar = document.querySelector(".nav-sidebar");
      if (navSidebar) {
        navSidebar.addEventListener("click", (e) => {
          const link = e.target?.closest?.("a[data-view]");
          if (!link) return;

          e.preventDefault();
          e.stopPropagation();

          const viewId = link.getAttribute("data-view");
          const v = normalizeViewId(viewId);
          if (!v) return;

          window.location.hash = `#${v}`;
        });
      }

      window.addEventListener("hashchange", () => {
        const requested = getViewFromHash();
        if (requested && !ENABLED_VIEWS.has(requested)) {
          window.location.hash = "#filtra";
          return;
        }

        setActiveView(requested, { save: true });
      });

      const initialFromHash = getViewFromHash();
      if (initialFromHash && !ENABLED_VIEWS.has(initialFromHash)) {
        window.location.hash = "#filtra";
      }
      const initialView = initialFromHash || appState.view || "filtra";
      setActiveView(initialView, { save: true });

      scheduleRender();
    </script>
  </body>
</html>
