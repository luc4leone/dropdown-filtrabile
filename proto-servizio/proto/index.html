<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>M__</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Next:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Schibsted+Grotesk:ital,wght@0,400..900;1,400..900&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="tokens.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="page">
      <aside class="nav-sidebar" aria-label="Navigazione">
        <nav>
          <a href="#dashboard" data-view="dashboard">
            <span class="nav-icon" data-icon="M__" aria-hidden="true"></span>
            <span>dashboard</span>
          </a>
          <a href="#filtra" data-view="filtra">
            <span class="nav-icon" data-icon="filter" aria-hidden="true"></span>
            <span>banca dati</span></a
          >

          <div class="nav-separator" aria-hidden="true"></div>

          <a href="#mailing-lists" data-view="mailing-lists">
            <span class="nav-icon" data-icon="list" aria-hidden="true"></span>
            <span>liste</span>
          </a>

          <a href="#comunicati" data-view="comunicati">
            <span
              class="nav-icon"
              data-icon="campaign"
              aria-hidden="true"
            ></span>
            <span>comunicati</span>
          </a>

          <a href="#spedizioni" data-view="spedizioni">
            <span class="nav-icon" data-icon="send" aria-hidden="true"></span>
            <span>spedizioni</span>
          </a>

          <a href="#progetti" data-view="progetti">
            <span class="nav-icon" data-icon="folder" aria-hidden="true"></span>
            <span>progetti</span>
          </a>
          <a href="#todos" data-view="todos">
            <span class="nav-icon" data-icon="task" aria-hidden="true"></span>
            <span>todos</span>
          </a>

          <div
            class="nav-separator nav-separator-bottom"
            aria-hidden="true"
          ></div>
          <a href="#">
            <span
              class="nav-icon"
              data-icon="notification"
              aria-hidden="true"
            ></span>
            <span>notifiche</span>
          </a>
          <a href="#account" data-view="account">
            <span
              class="nav-icon"
              data-icon="account"
              aria-hidden="true"
            ></span>
            <span>account</span>
          </a>

          <div class="nav-separator" aria-hidden="true"></div>

          <a href="#" id="navThemeToggle" aria-label="tema scuro">
            <span
              class="nav-icon"
              data-icon="dark_mode"
              aria-hidden="true"
            ></span>
          </a>
        </nav>
      </aside>
      <div class="views" id="views">
        <div class="app-view" data-view="filtra" id="viewFiltra">
          <aside class="sidebar">
            <div class="sidebar-mode" role="radiogroup" aria-label="Modalità">
              <span class="sidebar-mode-segment">
                <input
                  type="radio"
                  name="sidebarMode"
                  id="sidebarModeJournalists"
                  value="giornalisti"
                  checked
                />
                <label class="sidebar-mode-option" for="sidebarModeJournalists"
                  >giornalisti</label
                >
              </span>
              <span class="sidebar-mode-segment">
                <input
                  type="radio"
                  name="sidebarMode"
                  id="sidebarModeTestate"
                  value="testate"
                />
                <label class="sidebar-mode-option" for="sidebarModeTestate"
                  >testate</label
                >
              </span>
            </div>

            <div class="sidebar-filters-scroll">
              <div id="shipmentRecipientsSection" style="display: none">
                <div class="sidebar-section-title-row">
                  <div class="sidebar-section-title">Destinatari</div>
                  <span class="pill" id="shipmentRecipientsCountPill">0</span>
                </div>

                <div class="dropdown-container" style="margin-bottom: 18px">
                  <div class="filter-label-row">
                    <label
                      class="field-label"
                      for="shipmentRecipientsJournalistsInput"
                      >Giornalisti</label
                    >
                  </div>
                  <div
                    class="dropdown-input"
                    id="shipmentRecipientsJournalistsInputWrapper"
                  >
                    <input
                      type="text"
                      class="chip-text-input"
                      id="shipmentRecipientsJournalistsInput"
                      autocomplete="off"
                    />
                    <div
                      class="autocomplete-inline"
                      id="shipmentRecipientsJournalistsAutocompleteInline"
                      aria-hidden="true"
                    >
                      <span
                        class="autocomplete-suffix"
                        id="shipmentRecipientsJournalistsAutocompleteSuffix"
                      ></span>
                      <span
                        class="autocomplete-tip"
                        id="shipmentRecipientsJournalistsAutocompleteTip"
                      ></span>
                    </div>
                    <div
                      class="dropdown-arrow"
                      id="shipmentRecipientsJournalistsDropdownArrow"
                    ></div>
                  </div>
                  <div
                    class="dropdown-list"
                    id="shipmentRecipientsJournalistsDropdownList"
                  >
                    <div
                      id="shipmentRecipientsJournalistsDropdownChipSink"
                      style="display: none"
                    ></div>
                    <div
                      class="dropdown-suggestions"
                      id="shipmentRecipientsJournalistsDropdownSuggestions"
                    ></div>
                    <div
                      class="dropdown-results"
                      id="shipmentRecipientsJournalistsDropdownResults"
                    ></div>
                  </div>
                </div>

                <div class="dropdown-container" style="margin-bottom: 12px">
                  <div class="filter-label-row">
                    <label
                      class="field-label"
                      for="shipmentRecipientsListsInput"
                      >Liste</label
                    >
                  </div>
                  <div
                    class="dropdown-input"
                    id="shipmentRecipientsListsInputWrapper"
                  >
                    <input
                      type="text"
                      class="chip-text-input"
                      id="shipmentRecipientsListsInput"
                      autocomplete="off"
                    />
                    <div
                      class="autocomplete-inline"
                      id="shipmentRecipientsListsAutocompleteInline"
                      aria-hidden="true"
                    >
                      <span
                        class="autocomplete-suffix"
                        id="shipmentRecipientsListsAutocompleteSuffix"
                      ></span>
                      <span
                        class="autocomplete-tip"
                        id="shipmentRecipientsListsAutocompleteTip"
                      ></span>
                    </div>
                    <div
                      class="dropdown-arrow"
                      id="shipmentRecipientsListsDropdownArrow"
                    ></div>
                  </div>
                  <div
                    class="dropdown-list"
                    id="shipmentRecipientsListsDropdownList"
                  >
                    <div
                      id="shipmentRecipientsListsDropdownChipSink"
                      style="display: none"
                    ></div>
                    <div
                      class="dropdown-suggestions"
                      id="shipmentRecipientsListsDropdownSuggestions"
                    ></div>
                    <div
                      class="dropdown-results"
                      id="shipmentRecipientsListsDropdownResults"
                    ></div>
                  </div>
                </div>

                <a
                  href="#"
                  class="c-link c-link--action"
                  id="shipmentAiSuggestionsLink"
                  >suggerimenti</a
                >

                <hr class="sidebar-separator" />

                <div class="sidebar-section-title-row">
                  <div class="sidebar-section-title">Comunicato stampa</div>
                  <a
                    href="#"
                    class="c-link c-link--action"
                    id="shipmentPressNewLink"
                    >nuovo</a
                  >
                </div>

                <div class="shipment-press-option">
                  <input
                    type="radio"
                    id="shipmentPressModeSelect"
                    name="shipmentPressMode"
                    class="shipment-press-radio"
                    value="select"
                    checked
                  />
                  <label for="shipmentPressModeSelect"
                    >Seleziona un comunicato stampa</label
                  >
                </div>
                <div
                  class="shipment-press-indented"
                  id="shipmentPressSelectWrap"
                >
                  <select
                    id="shipmentPressSelect"
                    class="shipment-press-select"
                  >
                    <option value="">Nessun comunicato disponibile</option>
                  </select>
                  <a
                    href="#"
                    class="c-link c-link--action"
                    id="shipmentPressOpenLink"
                    >apri comunicato selezionato</a
                  >
                </div>

                <div class="shipment-press-option" style="margin-top: 16px">
                  <input
                    type="radio"
                    id="shipmentPressModeEmail"
                    name="shipmentPressMode"
                    class="shipment-press-radio"
                    value="email"
                  />
                  <label for="shipmentPressModeEmail"
                    >Inviaci un comunicato da spedire</label
                  >
                </div>
                <div
                  class="shipment-press-indented"
                  id="shipmentPressInstructionsWrap"
                >
                  <a
                    href="#"
                    class="c-link c-link--action"
                    id="shipmentPressInstructionsLink"
                    >istruzioni</a
                  >
                </div>
              </div>

              <div class="dropdown-container" style="margin-bottom: 18px">
                <div class="filter-label-row">
                  <label class="field-label" for="textFilterInput">Cerca</label>
                  <a href="#" class="filter-clear-link" id="textFilterClearLink"
                    >rimuovi</a
                  >
                </div>
                <div class="dropdown-input" id="textFilterInputWrapper">
                  <input
                    type="text"
                    class="chip-text-input"
                    id="textFilterInput"
                    autocomplete="off"
                  />
                </div>
                <div class="filter-help-text" id="textFilterHelpText">
                  in nome, email, note (giornalisti)
                </div>
              </div>

              <hr class="sidebar-separator" />
              <a
                href="#"
                class="c-link c-link--action smart-filters-link"
                id="smartFiltersOpenLink"
                >filtri intelligenti</a
              >
              <hr class="sidebar-separator" />
              <div class="sidebar-section-title">Filtri giornalista</div>

              <div class="journalist-filters-slot" id="journalistFiltersSlot">
                <div
                  class="journalist-filters-content"
                  id="journalistFiltersContent"
                >
                  <div class="dropdown-container">
                    <div class="filter-label-row">
                      <label class="field-label" for="dropdownInput"
                        >Servizio giornalistico</label
                      >
                      <a
                        href="#"
                        class="filter-clear-link"
                        id="dropdownClearLink"
                        >rimuovi</a
                      >
                    </div>
                    <div class="dropdown-input" id="dropdownInputWrapper">
                      <div id="chipContainer"></div>
                      <input
                        type="text"
                        class="chip-text-input"
                        id="dropdownInput"
                        autocomplete="off"
                      />
                      <div
                        class="autocomplete-inline"
                        id="autocompleteInline"
                        aria-hidden="true"
                      >
                        <span
                          class="autocomplete-suffix"
                          id="autocompleteSuffix"
                        ></span>
                        <span
                          class="autocomplete-tip"
                          id="autocompleteTip"
                        ></span>
                      </div>
                      <div class="dropdown-arrow" id="dropdownArrow"></div>
                    </div>
                    <div class="dropdown-list" id="dropdownList">
                      <div
                        class="dropdown-suggestions"
                        id="dropdownSuggestions"
                      ></div>
                      <div class="dropdown-results" id="dropdownResults"></div>
                      <div class="dropdown-footer">
                        <a
                          href="#"
                          class="close-dropdown-link"
                          id="closeDropdownLink"
                          >chiudi tendina</a
                        >
                        <button
                          type="button"
                          class="keycap"
                          aria-hidden="true"
                          tabindex="-1"
                        >
                          ESC
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="dropdown-container" style="margin-top: 18px">
                    <div class="filter-label-row">
                      <label class="field-label" for="roleDropdownInput"
                        >Ruolo in redazione</label
                      >
                      <a
                        href="#"
                        class="filter-clear-link"
                        id="roleDropdownClearLink"
                        >rimuovi</a
                      >
                    </div>
                    <div class="dropdown-input" id="roleDropdownInputWrapper">
                      <div id="roleChipContainer"></div>
                      <input
                        type="text"
                        class="chip-text-input"
                        id="roleDropdownInput"
                        autocomplete="off"
                      />
                      <div
                        class="autocomplete-inline"
                        id="roleAutocompleteInline"
                        aria-hidden="true"
                      >
                        <span
                          class="autocomplete-suffix"
                          id="roleAutocompleteSuffix"
                        ></span>
                        <span
                          class="autocomplete-tip"
                          id="roleAutocompleteTip"
                        ></span>
                      </div>
                      <div class="dropdown-arrow" id="roleDropdownArrow"></div>
                    </div>
                    <div class="dropdown-list" id="roleDropdownList">
                      <div
                        class="dropdown-suggestions"
                        id="roleDropdownSuggestions"
                      ></div>
                      <div
                        class="dropdown-results"
                        id="roleDropdownResults"
                      ></div>
                      <div class="dropdown-footer">
                        <a
                          href="#"
                          class="close-dropdown-link"
                          id="roleCloseDropdownLink"
                          >chiudi tendina</a
                        >
                        <button
                          type="button"
                          class="keycap"
                          aria-hidden="true"
                          tabindex="-1"
                        >
                          ESC
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  class="journalist-filters-placeholder"
                  id="journalistFiltersPlaceholder"
                >
                  <em>Non si applicano alle testate.</em>
                </div>
              </div>

              <hr class="sidebar-separator" />
              <div class="sidebar-section-title">Filtri testata</div>

              <div id="testataFiltersSection">
                <div class="dropdown-container">
                  <div class="filter-label-row">
                    <label
                      class="field-label"
                      for="testataArgomentoDropdownInput"
                      >Argomento testata</label
                    >
                    <a
                      href="#"
                      class="filter-clear-link"
                      id="testataArgomentoDropdownClearLink"
                      >rimuovi</a
                    >
                  </div>
                  <div
                    class="dropdown-input"
                    id="testataArgomentoDropdownInputWrapper"
                  >
                    <div id="testataArgomentoChipContainer"></div>
                    <input
                      type="text"
                      class="chip-text-input"
                      id="testataArgomentoDropdownInput"
                      autocomplete="off"
                    />
                    <div
                      class="autocomplete-inline"
                      id="testataArgomentoAutocompleteInline"
                      aria-hidden="true"
                    >
                      <span
                        class="autocomplete-suffix"
                        id="testataArgomentoAutocompleteSuffix"
                      ></span>
                      <span
                        class="autocomplete-tip"
                        id="testataArgomentoAutocompleteTip"
                      ></span>
                    </div>
                    <div
                      class="dropdown-arrow"
                      id="testataArgomentoDropdownArrow"
                    ></div>
                  </div>
                  <div class="dropdown-list" id="testataArgomentoDropdownList">
                    <div
                      class="dropdown-suggestions"
                      id="testataArgomentoDropdownSuggestions"
                    ></div>
                    <div
                      class="dropdown-results"
                      id="testataArgomentoDropdownResults"
                    ></div>
                    <div class="dropdown-footer">
                      <a
                        href="#"
                        class="close-dropdown-link"
                        id="testataArgomentoCloseDropdownLink"
                        >chiudi tendina</a
                      >
                      <button
                        type="button"
                        class="keycap"
                        aria-hidden="true"
                        tabindex="-1"
                      >
                        ESC
                      </button>
                    </div>
                  </div>
                </div>

                <div class="dropdown-container" style="margin-top: 18px">
                  <div class="filter-label-row">
                    <label
                      class="field-label"
                      for="testataTipoMediaDropdownInput"
                      >Tipo di media</label
                    >
                    <a
                      href="#"
                      class="filter-clear-link"
                      id="testataTipoMediaDropdownClearLink"
                      >rimuovi</a
                    >
                  </div>
                  <div
                    class="dropdown-input"
                    id="testataTipoMediaDropdownInputWrapper"
                  >
                    <div id="testataTipoMediaChipContainer"></div>
                    <input
                      type="text"
                      class="chip-text-input"
                      id="testataTipoMediaDropdownInput"
                      autocomplete="off"
                    />
                    <div
                      class="autocomplete-inline"
                      id="testataTipoMediaAutocompleteInline"
                      aria-hidden="true"
                    >
                      <span
                        class="autocomplete-suffix"
                        id="testataTipoMediaAutocompleteSuffix"
                      ></span>
                      <span
                        class="autocomplete-tip"
                        id="testataTipoMediaAutocompleteTip"
                      ></span>
                    </div>
                    <div
                      class="dropdown-arrow"
                      id="testataTipoMediaDropdownArrow"
                    ></div>
                  </div>
                  <div class="dropdown-list" id="testataTipoMediaDropdownList">
                    <div
                      class="dropdown-suggestions"
                      id="testataTipoMediaDropdownSuggestions"
                    ></div>
                    <div
                      class="dropdown-results"
                      id="testataTipoMediaDropdownResults"
                    ></div>
                    <div class="dropdown-footer">
                      <a
                        href="#"
                        class="close-dropdown-link"
                        id="testataTipoMediaCloseDropdownLink"
                        >chiudi tendina</a
                      >
                      <button
                        type="button"
                        class="keycap"
                        aria-hidden="true"
                        tabindex="-1"
                      >
                        ESC
                      </button>
                    </div>
                  </div>
                </div>

                <div class="dropdown-container" style="margin-top: 18px">
                  <div class="filter-label-row">
                    <label
                      class="field-label"
                      for="testataFrequenzaDropdownInput"
                      >Frequenza di pubblicazione</label
                    >
                    <a
                      href="#"
                      class="filter-clear-link"
                      id="testataFrequenzaDropdownClearLink"
                      >rimuovi</a
                    >
                  </div>
                  <div
                    class="dropdown-input"
                    id="testataFrequenzaDropdownInputWrapper"
                  >
                    <div id="testataFrequenzaChipContainer"></div>
                    <input
                      type="text"
                      class="chip-text-input"
                      id="testataFrequenzaDropdownInput"
                      autocomplete="off"
                    />
                    <div
                      class="autocomplete-inline"
                      id="testataFrequenzaAutocompleteInline"
                      aria-hidden="true"
                    >
                      <span
                        class="autocomplete-suffix"
                        id="testataFrequenzaAutocompleteSuffix"
                      ></span>
                      <span
                        class="autocomplete-tip"
                        id="testataFrequenzaAutocompleteTip"
                      ></span>
                    </div>
                    <div
                      class="dropdown-arrow"
                      id="testataFrequenzaDropdownArrow"
                    ></div>
                  </div>
                  <div class="dropdown-list" id="testataFrequenzaDropdownList">
                    <div
                      class="dropdown-suggestions"
                      id="testataFrequenzaDropdownSuggestions"
                    ></div>
                    <div
                      class="dropdown-results"
                      id="testataFrequenzaDropdownResults"
                    ></div>
                    <div class="dropdown-footer">
                      <a
                        href="#"
                        class="close-dropdown-link"
                        id="testataFrequenzaCloseDropdownLink"
                        >chiudi tendina</a
                      >
                      <button
                        type="button"
                        class="keycap"
                        aria-hidden="true"
                        tabindex="-1"
                      >
                        ESC
                      </button>
                    </div>
                  </div>
                </div>

                <div class="dropdown-container" style="margin-top: 18px">
                  <div class="filter-label-row">
                    <label
                      class="field-label"
                      for="testataDiffusioneDropdownInput"
                      >Diffusione</label
                    >
                    <a
                      href="#"
                      class="filter-clear-link"
                      id="testataDiffusioneDropdownClearLink"
                      >rimuovi</a
                    >
                  </div>
                  <div
                    class="dropdown-input"
                    id="testataDiffusioneDropdownInputWrapper"
                  >
                    <div id="testataDiffusioneChipContainer"></div>
                    <input
                      type="text"
                      class="chip-text-input"
                      id="testataDiffusioneDropdownInput"
                      autocomplete="off"
                    />
                    <div
                      class="autocomplete-inline"
                      id="testataDiffusioneAutocompleteInline"
                      aria-hidden="true"
                    >
                      <span
                        class="autocomplete-suffix"
                        id="testataDiffusioneAutocompleteSuffix"
                      ></span>
                      <span
                        class="autocomplete-tip"
                        id="testataDiffusioneAutocompleteTip"
                      ></span>
                    </div>
                    <div
                      class="dropdown-arrow"
                      id="testataDiffusioneDropdownArrow"
                    ></div>
                  </div>
                  <div class="dropdown-list" id="testataDiffusioneDropdownList">
                    <div
                      class="dropdown-suggestions"
                      id="testataDiffusioneDropdownSuggestions"
                    ></div>
                    <div
                      class="dropdown-results"
                      id="testataDiffusioneDropdownResults"
                    ></div>
                    <div class="dropdown-footer">
                      <a
                        href="#"
                        class="close-dropdown-link"
                        id="testataDiffusioneCloseDropdownLink"
                        >chiudi tendina</a
                      >
                      <button
                        type="button"
                        class="keycap"
                        aria-hidden="true"
                        tabindex="-1"
                      >
                        ESC
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </aside>

          <main class="main">
            <div class="main-header">
              <div>
                <div class="main-header-row">
                  <div class="main-header-left">
                    <div class="main-title-with-icon" id="mainTitleWithIcon">
                      <span
                        class="main-title-icon"
                        id="mainTitleIcon"
                        aria-hidden="true"
                      ></span>
                      <span class="sidebar-section-title shipment-title-prefix"
                        >oggetto</span
                      >
                      <h1
                        class="main-title shipment-title-display"
                        id="mainTitle"
                      >
                        Banca Dati
                      </h1>
                      <input
                        type="text"
                        class="shipment-title-input"
                        id="shipmentTitleInput"
                        aria-label="Nome spedizione"
                        style="display: none"
                      />
                    </div>
                    <span
                      class="pill"
                      id="mailingListCountPill"
                      style="display: none"
                    ></span>
                    <a href="#" class="testata-link" id="chooseDatabaseLink"
                      >configura</a
                    >
                    <div
                      class="mailing-list-actions"
                      id="mailingListActions"
                      style="display: none"
                    >
                      <a
                        href="#"
                        class="c-link c-link--nav"
                        id="mailingListRenameLink"
                        >rinomina</a
                      >
                      <a
                        href="#"
                        class="c-link c-link--nav"
                        id="mailingListExportLink"
                        >esporta</a
                      >
                      <span class="sidebar-mode-separator" aria-hidden="true"
                        >•</span
                      >
                      <a
                        href="#"
                        class="c-link c-link--action"
                        id="mailingListDuplicateLink"
                        >duplica</a
                      >
                      <a
                        href="#"
                        class="c-link c-link--action"
                        id="mailingListDeleteLink"
                        >elimina</a
                      >
                      <span class="sidebar-mode-separator" aria-hidden="true"
                        >•</span
                      >
                      <a
                        href="#"
                        class="c-link c-link--action"
                        id="mailingListSendLink"
                        >spedisci</a
                      >
                    </div>
                  </div>
                </div>
                <div
                  class="main-subtitle"
                  id="mailingListCreatedAtSubtitle"
                  style="display: none"
                ></div>
                <a
                  href="#"
                  class="close-dropdown-link main-clear-filters"
                  id="clearFiltersLink"
                  >rimuovi filtri</a
                >
                <div class="main-subtitle" id="cardsSubtitle"></div>
                <div class="bulk-sort-controls-row">
                  <span class="bulk-select-controls" id="bulkSelectControls">
                    <a href="#" class="bulk-select-link" id="selectAllLink"
                      >seleziona tutti</a
                    >
                  </span>
                  <div
                    class="sidebar-mode main-mode"
                    role="radiogroup"
                    aria-label="Modalità risultati"
                    id="mainMode"
                  >
                    <input
                      type="radio"
                      name="mainMode"
                      id="mainModeJournalists"
                      value="giornalisti"
                      checked
                    />
                    <label class="sidebar-mode-option" for="mainModeJournalists"
                      >giornalisti</label
                    >
                    <span
                      class="pill"
                      id="mainCountJournalists"
                      style="display: inline-block"
                    ></span>
                    <span class="sidebar-mode-separator">e relative</span>
                    <input
                      type="radio"
                      name="mainMode"
                      id="mainModeTestate"
                      value="testate"
                    />
                    <label class="sidebar-mode-option" for="mainModeTestate"
                      >testate</label
                    >
                    <span
                      class="pill"
                      id="mainCountTestate"
                      style="display: inline-block"
                    ></span>
                  </div>
                  <span class="c-sort-controls c-sort-controls--v2">
                    <span class="main-subtitle">ordina:</span>

                    <span
                      class="c-sort-controls__group c-sort-controls__group--legacy"
                    >
                      <span class="main-subtitle">nome</span>
                      <a href="#" class="sort-link" id="sortByNameAscLink"
                        >a-z</a
                      >
                      <span class="sidebar-mode-separator" aria-hidden="true"
                        >/</span
                      >
                      <a href="#" class="sort-link" id="sortByNameDescLink"
                        >z-a</a
                      >
                    </span>

                    <span
                      class="c-sort-controls__group c-sort-controls__group--dropdown"
                    >
                      <span class="c-sort-select" id="sortByNameSelect">
                        <button
                          type="button"
                          class="c-sort-select__trigger"
                          id="sortByNameSelectTrigger"
                          aria-haspopup="listbox"
                          aria-expanded="false"
                        >
                          <span
                            class="sort-link is-active"
                            id="sortByNameSelectValue"
                            >nome a-z</span
                          >
                        </button>
                        <span
                          class="c-sort-select__arrow"
                          aria-hidden="true"
                        ></span>
                        <div
                          class="dropdown-list c-sort-select__menu"
                          id="sortByNameSelectMenu"
                          role="listbox"
                          aria-hidden="true"
                        >
                          <div class="dropdown-results">
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="true"
                              data-sort="name-asc"
                              id="sortByNameOptionAsc"
                            >
                              <a href="#" class="sort-link is-active"
                                >nome a-z</a
                              >
                            </div>
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="false"
                              data-sort="name-desc"
                              id="sortByNameOptionDesc"
                            >
                              <a href="#" class="sort-link">nome z-a</a>
                            </div>
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="false"
                              data-sort="relevance"
                              id="sortByNameOptionRelevance"
                            >
                              <a href="#" class="sort-link">rilevanza</a>
                            </div>
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="false"
                              data-sort="role"
                              id="sortByNameOptionRole"
                            >
                              <a href="#" class="sort-link">ruolo</a>
                            </div>
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="false"
                              data-sort="media-type"
                              id="sortByNameOptionMediaType"
                            >
                              <a href="#" class="sort-link">tipo di media</a>
                            </div>
                            <div
                              class="dropdown-item"
                              role="option"
                              aria-selected="false"
                              data-sort="frequency"
                              id="sortByNameOptionFrequency"
                            >
                              <a href="#" class="sort-link">frequenza</a>
                            </div>
                          </div>
                        </div>
                      </span>
                    </span>

                    <span
                      class="c-sort-controls__group c-sort-controls__group--links"
                    >
                      <span
                        class="sidebar-mode-separator"
                        aria-hidden="true"
                        id="sortSepAfterName"
                        >|</span
                      >
                      <a href="#" class="sort-link" id="sortByRoleLink"
                        >ruolo</a
                      >
                      <span
                        class="sidebar-mode-separator"
                        aria-hidden="true"
                        id="sortSepAfterRole"
                        >|</span
                      >
                      <a href="#" class="sort-link" id="sortByMediaTypeLink"
                        >tipo di media</a
                      >
                      <span
                        class="sidebar-mode-separator"
                        aria-hidden="true"
                        id="sortSepAfterMediaType"
                        >|</span
                      >
                      <a href="#" class="sort-link" id="sortByFrequencyLink"
                        >frequenza</a
                      >
                    </span>
                  </span>
                </div>
              </div>
            </div>
            <div class="cards-grid" id="cardsGrid">
              <div class="shipment-cards-column" id="shipmentCardsColumn">
                <div
                  class="shipment-selected-lists-chips"
                  id="shipmentSelectedListsChips"
                ></div>
                <input
                  type="text"
                  id="shipmentCardsFilterInput"
                  class="shipment-cards-filter-input"
                  placeholder="filtra..."
                  aria-label="filtra giornalisti..."
                />
                <div
                  id="cardsLoader"
                  class="muted"
                  style="display: block; text-align: center; padding: 10px 0"
                >
                  <span class="c-blink-loader" aria-label="caricamento">
                    M<span class="c-blink-loader__cursor">_</span>
                  </span>
                </div>
                <div
                  id="cardsLoadMoreWrap"
                  style="
                    display: none;
                    margin: 16px 0;
                    grid-column: 1 / -1;
                    text-align: center;
                  "
                >
                  <a href="#" class="c-link c-link--action" id="cardsLoadMore"
                    >mostra altri</a
                  >
                </div>
              </div>
              <div
                class="shipment-email-header-column"
                id="shipmentEmailHeaderColumn"
              >
                <div class="shipment-comunicato-controls-row">
                  <label class="shipment-append-comunicato-toggle">
                    <input
                      type="checkbox"
                      id="shipmentAppendComunicatoCheckbox"
                    />
                    <span>aggiungi il comunicato in calce</span>
                  </label>
                  <span class="shipment-comunicato-share-links">
                    <a
                      href="#"
                      class="c-link c-link--action shipment-comunicato-link shipment-comunicato-link--public"
                      id="shipmentComunicatoPublicLink"
                      target="_blank"
                      rel="noopener noreferrer"
                      aria-disabled="true"
                      >link</a
                    >
                    <span class="shipment-comunicato-share-text"
                      >a comunicato</span
                    >
                    <a
                      href="#"
                      class="c-link c-link--action shipment-comunicato-link shipment-comunicato-link--copy"
                      id="shipmentComunicatoCopyLink"
                      aria-disabled="true"
                      >copia</a
                    >
                  </span>
                </div>
                <textarea
                  id="newPressPanelEmailHeaderTextarea"
                  class="new-press-panel-textarea new-press-panel-textarea--email-header"
                  placeholder="intestazione email"
                ></textarea>
                <section
                  class="shipment-selected-comunicato"
                  id="shipmentSelectedComunicatoWrap"
                  aria-live="polite"
                >
                  <p
                    class="shipment-selected-comunicato-title"
                    id="shipmentSelectedComunicatoTitle"
                  >
                    Comunicato selezionato
                  </p>
                  <div
                    class="shipment-selected-comunicato-body"
                    id="shipmentSelectedComunicatoText"
                  ></div>
                </section>
              </div>
            </div>
          </main>

          <aside class="selected-panel" id="selectedPanel" aria-hidden="true">
            <div class="selected-panel-header">
              <div class="selected-panel-header-left">
                <div class="selected-panel-title-row">
                  <span class="selected-panel-title-row-left">
                    <p class="selected-panel-title">Selezionati</p>
                    <span class="pill" id="selectedCountPill"></span>
                  </span>
                </div>
                <div
                  class="selected-panel-actions-row selected-panel-actions-row--secondary"
                  id="selectedInListRow"
                  style="display: none"
                >
                  <span class="selected-panel-actions-text">
                    in lista
                    <span class="c-pill" id="selectedInListCount"></span>
                  </span>
                  <span class="sidebar-mode-separator" aria-hidden="true"
                    >•</span
                  >
                  <a
                    href="#"
                    class="c-link c-link--action"
                    id="selectedRemoveFromListLink"
                  >
                    rimuovi da lista
                  </a>
                </div>
                <div
                  class="selected-panel-actions-row selected-panel-actions-row--primary"
                >
                  <a href="#" class="close-dropdown-link" id="selectedClearAll">
                    svuota selezione
                  </a>
                  <span
                    class="c-split-button"
                    id="selectedActionsSplit"
                    data-split-button
                  >
                    <button
                      type="button"
                      class="c-split-button__main c-link c-link--nav"
                      data-split-main
                      data-split-action="save-list"
                    >
                      crea lista
                    </button>
                    <button
                      type="button"
                      class="c-split-button__toggle"
                      data-split-toggle
                      aria-haspopup="listbox"
                      aria-expanded="false"
                    >
                      <span
                        class="c-split-button__arrow"
                        aria-hidden="true"
                      ></span>
                    </button>
                    <div
                      class="dropdown-list c-split-button__menu"
                      data-split-menu
                      role="listbox"
                      aria-hidden="true"
                    >
                      <div class="dropdown-results">
                        <div class="dropdown-item" role="option">
                          <a
                            href="#"
                            class="c-link c-link--nav"
                            data-split-action="add-to-list"
                            >aggiungi a lista</a
                          >
                        </div>
                        <div class="dropdown-item" role="option">
                          <a
                            href="#"
                            class="c-link c-link--nav"
                            data-split-action="add-to-new-shipment"
                            >crea spedizione</a
                          >
                        </div>
                        <div class="dropdown-item" role="option">
                          <a
                            href="#"
                            class="c-link c-link--nav"
                            data-split-action="add-to-shipment"
                            >aggiungi a spedizione</a
                          >
                        </div>
                      </div>
                    </div>
                  </span>
                </div>
              </div>
            </div>
            <div class="selected-panel-body" id="selectedPanelBody"></div>
          </aside>
        </div>

        <div class="app-view" data-view="dashboard" id="viewDashboard">
          <main class="main">
            <div class="dashboard-layout">
              <div class="dashboard-mailing-lists-col">
                <div class="dashboard-subtitle-row">
                  <div class="main-subtitle dashboard-main-subtitle">liste</div>
                  <a
                    href="#"
                    id="dashboardMailingListsNewLink"
                    class="dashboard-subtitle-link"
                    >nuova</a
                  >
                </div>
                <input
                  type="text"
                  class="shipment-cards-filter-input"
                  id="dashboardMailingListsFilterInput"
                  placeholder="filtra liste"
                  autocomplete="off"
                />
                <div
                  id="dashboardMailingLists"
                  class="dashboard-filter-results"
                ></div>
              </div>
              <div class="dashboard-mailing-lists-col">
                <div class="dashboard-subtitle-row">
                  <div class="main-subtitle dashboard-main-subtitle">
                    spedizioni
                  </div>
                  <a
                    href="#"
                    id="dashboardShipmentsNewLink"
                    class="dashboard-subtitle-link"
                    >nuova</a
                  >
                </div>
                <input
                  type="text"
                  class="shipment-cards-filter-input"
                  id="dashboardShipmentsFilterInput"
                  placeholder="filtra spedizioni"
                  autocomplete="off"
                />
                <div
                  id="dashboardShipments"
                  class="dashboard-filter-results"
                ></div>
              </div>
              <div class="dashboard-mailing-lists-col">
                <div class="dashboard-subtitle-row">
                  <div class="main-subtitle dashboard-main-subtitle">
                    comunicati
                  </div>
                  <a
                    href="#"
                    id="dashboardComunicatiNewLink"
                    class="dashboard-subtitle-link"
                    >nuovo</a
                  >
                </div>
                <input
                  type="text"
                  class="shipment-cards-filter-input"
                  id="dashboardComunicatiFilterInput"
                  placeholder="filtra comunicati"
                  autocomplete="off"
                />
                <div
                  id="dashboardComunicati"
                  class="dashboard-filter-results"
                ></div>
              </div>
            </div>
          </main>
        </div>

        <div class="app-view" data-view="mailing-lists" id="viewMailingLists">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Liste</h1>
              </div>
            </div>
            <div class="dashboard-layout">
              <div class="dashboard-mailing-lists-col">
                <div id="mailingListsMailingLists"></div>
              </div>
            </div>
          </main>
        </div>

        <div class="app-view" data-view="comunicati" id="viewComunicati">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Comunicati</h1>
              </div>
            </div>
            <div class="muted">placeholder</div>
          </main>
        </div>

        <div class="app-view" data-view="spedizioni" id="viewSpedizioni">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Spedizioni</h1>
              </div>
            </div>
            <div class="dashboard-layout">
              <div class="dashboard-mailing-lists-col">
                <div id="spedizioniShipments"></div>
              </div>
            </div>
          </main>
        </div>

        <div class="app-view" data-view="progetti" id="viewProgetti">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Progetti</h1>
              </div>
            </div>
            <div class="muted">placeholder</div>
          </main>
        </div>

        <div class="app-view" data-view="todos" id="viewTodos">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Todos</h1>
              </div>
            </div>
            <div class="muted">placeholder</div>
          </main>
        </div>

        <div class="app-view" data-view="account" id="viewAccount">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Account</h1>
              </div>
            </div>
            <div class="account-settings">
              <label class="account-setting" for="showHelpCheckbox">
                <input
                  type="checkbox"
                  class="dropdown-checkbox"
                  id="showHelpCheckbox"
                  checked
                />
                <span>mostra help</span>
              </label>
            </div>
          </main>
        </div>

        <div class="app-view" data-view="mailing-list" id="viewMailingList">
          <main class="main">
            <div class="main-header">
              <div>
                <h1 class="main-title">Mailing list</h1>
                <div class="main-subtitle">in preparazione</div>
              </div>
            </div>
            <div class="muted">work in progress</div>
          </main>
        </div>

        <div
          class="app-view"
          data-view="crea-lista-futuro"
          id="viewCreaListaFuturo"
        >
          <main class="main crea-lista-futuro-main">
            <div class="crea-lista-futuro-split">
              <section
                class="crea-lista-futuro-pane crea-lista-futuro-pane--left"
              >
                <h1 class="main-title">Crea lista (futuro)</h1>

                <label class="field-label" for="creaListaFuturoApiKey"
                  >OpenAI API key</label
                >
                <div class="dropdown-input">
                  <input
                    class="chip-text-input"
                    id="creaListaFuturoApiKey"
                    type="password"
                    autocomplete="off"
                    placeholder="sk-..."
                  />
                </div>

                <label class="field-label" for="creaListaFuturoComunicatoSelect"
                  >Comunicati Stampa</label
                >
                <div class="dropdown-input">
                  <select
                    class="chip-text-input"
                    id="creaListaFuturoComunicatoSelect"
                  >
                    <option value="">seleziona comunicato</option>
                  </select>
                </div>

                <label class="field-label" for="creaListaFuturoText"
                  >Testo</label
                >
                <div class="dropdown-input">
                  <textarea
                    class="chip-text-input smart-filters-textarea"
                    id="creaListaFuturoText"
                    autocomplete="off"
                  ></textarea>
                </div>

                <div class="smart-filters-actions">
                  <a
                    href="#"
                    class="c-link c-link--action"
                    id="creaListaFuturoCreateLink"
                    >crea lista</a
                  >
                </div>

                <div
                  class="smart-filters-results"
                  id="creaListaFuturoResults"
                ></div>
              </section>

              <div
                class="crea-lista-futuro-separator"
                role="separator"
                aria-orientation="vertical"
              ></div>

              <section
                class="crea-lista-futuro-pane crea-lista-futuro-pane--right"
              >
                <div class="crea-lista-futuro-right-header">
                  <h2 class="main-subtitle">giornalisti filtrati</h2>
                  <span class="pill" id="creaListaFuturoCountPill">0</span>
                </div>
                <div
                  class="cards-grid crea-lista-futuro-cards-grid"
                  id="creaListaFuturoCardsGrid"
                ></div>
              </section>
            </div>
          </main>
        </div>
      </div>
    </div>

    <div
      class="shipment-email-spotlight"
      id="shipmentEmailSpotlight"
      aria-hidden="true"
    >
      <div
        class="shipment-email-spotlight-shade"
        id="shipmentEmailSpotlightTop"
        data-shipment-email-spotlight-close="true"
      ></div>
      <div
        class="shipment-email-spotlight-shade"
        id="shipmentEmailSpotlightLeft"
        data-shipment-email-spotlight-close="true"
      ></div>
      <div
        class="shipment-email-spotlight-shade"
        id="shipmentEmailSpotlightRight"
        data-shipment-email-spotlight-close="true"
      ></div>
      <div
        class="shipment-email-spotlight-shade"
        id="shipmentEmailSpotlightBottom"
        data-shipment-email-spotlight-close="true"
      ></div>
    </div>

    <div
      class="notes-modal-overlay"
      id="shipmentPressEmailModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="shipmentPressEmailModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title">email a cui inviare</p>
        <button
          type="button"
          class="notes-modal-close"
          id="shipmentPressEmailModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <div class="shipment-press-email-row">
          <span id="shipmentPressEmailAddress"
            >8d18ab1d0d@msg62.mediaaddress.it</span
          >
          <a
            href="#"
            class="c-link c-link--action"
            id="shipmentPressEmailCopyLink"
            >copia</a
          >
        </div>
        <p class="shipment-press-email-text">
          Ricorda che spediremo una copia esatta della mail che ci invierai,
          pertanto ricorda di:
        </p>
        <ul class="shipment-press-email-list">
          <li>comporre una NUOVA mail (non inoltrare una mail ricevuta)</li>
          <li>scrivere OGGETTO e CORPO (il comunicato) della mail</li>
          <li>allegare eventuali file e/o immagini</li>
        </ul>
      </div>
    </div>

    <div
      class="notes-modal-overlay"
      id="smartFiltersModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="smartFiltersModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="smartFiltersModalTitle">
          filtri intelligenti
        </p>
        <button
          type="button"
          class="notes-modal-close"
          id="smartFiltersModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <label class="field-label" for="smartFiltersComunicatoSelect"
          >Comunicati Stampa</label
        >
        <div class="dropdown-input">
          <select class="chip-text-input" id="smartFiltersComunicatoSelect">
            <option value="">seleziona comunicato</option>
          </select>
        </div>

        <label class="field-label" for="smartFiltersText">Testo</label>
        <div class="dropdown-input">
          <textarea
            class="chip-text-input smart-filters-textarea"
            id="smartFiltersText"
            autocomplete="off"
          ></textarea>
        </div>

        <div class="smart-filters-actions">
          <a href="#" class="c-link c-link--action" id="smartFiltersSuggestBtn"
            >suggerisci filtri</a
          >
        </div>

        <div class="smart-filters-results" id="smartFiltersResults"></div>

        <div class="smart-filters-apply-row">
          <a
            href="#"
            class="c-link c-link--action is-disabled"
            id="smartFiltersApplyBtn"
            aria-disabled="true"
            >applica filtri suggeriti</a
          >
        </div>
      </div>
    </div>

    <a href="#" class="global-help-link" id="globalHelpLink">help</a>

    <aside class="help-panel" id="helpPanel" aria-hidden="true">
      <div class="selected-panel-header">
        <div class="selected-panel-header-left">
          <div class="selected-panel-title-row">
            <span class="selected-panel-title-row-left">
              <p class="selected-panel-title">Help</p>
            </span>
          </div>
        </div>
        <button
          type="button"
          class="selected-panel-close"
          id="helpPanelClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="selected-panel-body">
        <details class="help-panel-details">
          <summary>Cosa sono i filtri intelligenti?</summary>
          <div class="help-panel-video-wrap">
            <iframe
              width="560"
              height="315"
              src="https://www.youtube.com/embed/2Ib52G8o4SE?si=KCJxXcyFEjcFm1b2"
              title="YouTube video player"
              frameborder="0"
              allow="
                accelerometer;
                autoplay;
                clipboard-write;
                encrypted-media;
                gyroscope;
                picture-in-picture;
                web-share;
              "
              referrerpolicy="strict-origin-when-cross-origin"
              allowfullscreen
            ></iframe>
          </div>
        </details>
      </div>
    </aside>

    <div
      class="testata-overlay"
      id="newPressPanelOverlay"
      aria-hidden="true"
    ></div>
    <aside class="new-press-panel" id="newPressPanel" aria-hidden="true">
      <div class="selected-panel-header">
        <div class="selected-panel-header-left">
          <div class="selected-panel-title-row">
            <span class="selected-panel-title-row-left">
              <p
                class="selected-panel-title new-press-panel-title-display"
                id="newPressPanelTitle"
              >
                Nuovo comunicato
              </p>
              <input
                type="text"
                class="new-press-panel-title-input"
                id="newPressPanelTitleInput"
                aria-label="Nome comunicato"
                style="display: none"
              />
            </span>
            <span
              class="new-press-panel-journalist-tag"
              id="newPressPanelJournalistTag"
              style="display: none"
            ></span>
          </div>
        </div>
        <button
          type="button"
          class="selected-panel-close"
          id="newPressPanelClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="selected-panel-body">
        <textarea
          id="newPressPanelTextarea"
          class="new-press-panel-textarea"
          placeholder="testo comunicato"
        ></textarea>
        <div
          class="new-press-panel-dropzone"
          id="newPressPanelDropzone"
          aria-label="Drop media kit files"
        >
          drop media kit files
        </div>
        <ul
          class="new-press-panel-dropped-files"
          id="newPressPanelDroppedFilesList"
        ></ul>
      </div>
    </aside>

    <div class="testata-overlay" id="testataOverlay" aria-hidden="true"></div>
    <aside class="testata-panel" id="testataPanel" aria-hidden="true">
      <div class="testata-panel-header">
        <div
          class="testata-panel-header-content"
          id="testataPanelHeaderContent"
        >
          <p class="testata-panel-title" id="testataPanelTitle">Testata</p>
        </div>
        <button
          type="button"
          class="testata-panel-close"
          id="testataPanelClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="testata-panel-body" id="testataPanelBody"></div>
    </aside>

    <div
      class="notes-modal-overlay"
      id="notesModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="notesModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="notesModalTitle">Note</p>
        <button
          type="button"
          class="notes-modal-close"
          id="notesModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body" id="notesModalBody"></div>
    </div>

    <div
      class="notes-modal-overlay"
      id="saveListModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="saveListModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="saveListModalTitle">Salva lista</p>
        <button
          type="button"
          class="notes-modal-close"
          id="saveListModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <label
          class="field-label"
          for="saveListNameInput"
          id="saveListNameLabel"
          >Nome lista</label
        >
        <div class="dropdown-input">
          <input
            type="text"
            class="chip-text-input"
            id="saveListNameInput"
            placeholder=""
            autocomplete="off"
          />
        </div>
        <div class="form-error" id="saveListError" style="display: none">
          dai nome alla lista
        </div>
        <a href="#" class="close-dropdown-link" id="saveListConfirm">
          salva lista
        </a>
      </div>
    </div>

    <div
      class="notes-modal-overlay"
      id="shareListModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="shareListModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="shareListModalTitle">
          condividi lista
        </p>
        <button
          type="button"
          class="notes-modal-close"
          id="shareListModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <div class="share-list-users" id="shareListUsers"></div>
        <a href="#" class="c-link c-link--action" id="shareListConfirm">
          condividi
        </a>
      </div>
    </div>

    <div
      class="notes-modal-overlay"
      id="addToListModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="addToListModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="addToListModalTitle">
          Aggiungi a lista
        </p>
        <button
          type="button"
          class="notes-modal-close"
          id="addToListModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <div class="dropdown-container" style="margin-bottom: 0">
          <div class="filter-label-row">
            <label class="field-label" for="addToListDropdownInput"
              >Liste</label
            >
          </div>
          <div class="dropdown-input" id="addToListDropdownInputWrapper">
            <div id="addToListChipContainer"></div>
            <input
              type="text"
              class="chip-text-input"
              id="addToListDropdownInput"
              autocomplete="off"
            />
            <div
              class="autocomplete-inline"
              id="addToListAutocompleteInline"
              aria-hidden="true"
            >
              <span
                class="autocomplete-suffix"
                id="addToListAutocompleteSuffix"
              ></span>
              <span
                class="autocomplete-tip"
                id="addToListAutocompleteTip"
              ></span>
            </div>
            <div class="dropdown-arrow" id="addToListDropdownArrow"></div>
          </div>
          <div class="dropdown-list" id="addToListDropdownList">
            <div
              class="dropdown-suggestions"
              id="addToListDropdownSuggestions"
            ></div>
            <div class="dropdown-results" id="addToListDropdownResults"></div>
          </div>
        </div>

        <div class="form-error" id="addToListError" style="display: none">
          seleziona una lista
        </div>

        <a href="#" class="close-dropdown-link" id="addToListConfirm">
          aggiungi
        </a>
      </div>
    </div>

    <div
      class="notes-modal-overlay"
      id="addToShipmentModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="addToShipmentModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="addToShipmentModalTitle">
          aggiungi a spedizione
        </p>
        <button
          type="button"
          class="notes-modal-close"
          id="addToShipmentModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <div class="dropdown-container" style="margin-bottom: 0">
          <div class="filter-label-row">
            <label class="field-label" for="addToShipmentDropdownInput"
              >Spedizioni</label
            >
            <a
              href="#"
              class="filter-clear-link"
              id="addToShipmentDropdownClearLink"
              >rimuovi</a
            >
          </div>
          <div class="dropdown-input" id="addToShipmentDropdownInputWrapper">
            <div id="addToShipmentChipContainer"></div>
            <input
              type="text"
              class="chip-text-input"
              id="addToShipmentDropdownInput"
              autocomplete="off"
            />
            <div
              class="autocomplete-inline"
              id="addToShipmentAutocompleteInline"
              aria-hidden="true"
            >
              <span
                class="autocomplete-suffix"
                id="addToShipmentAutocompleteSuffix"
              ></span>
              <span
                class="autocomplete-tip"
                id="addToShipmentAutocompleteTip"
              ></span>
            </div>
            <div class="dropdown-arrow" id="addToShipmentDropdownArrow"></div>
          </div>
          <div class="dropdown-list" id="addToShipmentDropdownList">
            <div
              class="dropdown-suggestions"
              id="addToShipmentDropdownSuggestions"
            ></div>
            <div
              class="dropdown-results"
              id="addToShipmentDropdownResults"
            ></div>
          </div>
        </div>

        <div class="form-error" id="addToShipmentError" style="display: none">
          seleziona una spedizione
        </div>

        <a href="#" class="close-dropdown-link" id="addToShipmentConfirm">
          aggiungi
        </a>
      </div>
    </div>

    <div
      class="notes-modal-overlay"
      id="addToNewShipmentModalOverlay"
      aria-hidden="true"
    ></div>
    <div class="notes-modal" id="addToNewShipmentModal" aria-hidden="true">
      <div class="notes-modal-header">
        <p class="notes-modal-title" id="addToNewShipmentModalTitle">
          aggiungi a nuova spedizione
        </p>
        <button
          type="button"
          class="notes-modal-close"
          id="addToNewShipmentModalClose"
          aria-label="Chiudi"
        >
          ×
        </button>
      </div>
      <div class="notes-modal-body">
        <label class="field-label" for="addToNewShipmentNameInput"
          >Oggetto spedizione</label
        >
        <div class="dropdown-input">
          <input
            type="text"
            class="chip-text-input"
            id="addToNewShipmentNameInput"
            autocomplete="off"
          />
        </div>

        <div
          class="form-error"
          id="addToNewShipmentError"
          style="display: none"
        >
          inserisci oggetto spedizione
        </div>

        <a href="#" class="close-dropdown-link" id="addToNewShipmentConfirm">
          crea nuova spedizione
        </a>
      </div>
    </div>

    <script src="./generated/data.js"></script>
    <script>
      const APP_STORAGE_KEY = "proto-servizio-app-state-v1";

      function loadAppState() {
        try {
          const raw = localStorage.getItem(APP_STORAGE_KEY);
          if (!raw) {
            return {
              view: "filtra",
              mailingLists: [],
              comunicati: [],
              spedizioni: [],
              activeSpedizioneSourceListId: "",
              activeSpedizioneName: "",
            };
          }
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") {
            return {
              view: "filtra",
              mailingLists: [],
              comunicati: [],
              spedizioni: [],
              activeSpedizioneSourceListId: "",
              activeSpedizioneName: "",
            };
          }
          return {
            view: typeof parsed.view === "string" ? parsed.view : "filtra",
            ui: parsed.ui && typeof parsed.ui === "object" ? parsed.ui : {},
            sortMode:
              typeof parsed.sortMode === "string" ? parsed.sortMode : "",
            activeMailingListId:
              typeof parsed.activeMailingListId === "string"
                ? parsed.activeMailingListId
                : "",
            mailingLists: Array.isArray(parsed.mailingLists)
              ? parsed.mailingLists
              : [],
            comunicati: Array.isArray(parsed.comunicati)
              ? parsed.comunicati
              : [],
            spedizioni: Array.isArray(parsed.spedizioni)
              ? parsed.spedizioni
              : [],
            activeSpedizioneSourceListId:
              typeof parsed.activeSpedizioneSourceListId === "string"
                ? parsed.activeSpedizioneSourceListId
                : "",
            activeSpedizioneName:
              typeof parsed.activeSpedizioneName === "string"
                ? parsed.activeSpedizioneName
                : "",
          };
        } catch (e) {
          return {
            view: "filtra",
            ui: {},
            sortMode: "",
            activeMailingListId: "",
            mailingLists: [],
            comunicati: [],
            spedizioni: [],
            activeSpedizioneSourceListId: "",
            activeSpedizioneName: "",
          };
        }
      }

      function renderCreaListaFuturoComunicatoOptions() {
        if (!creaListaFuturoComunicatoSelect) return;
        const currentValue = String(
          creaListaFuturoComunicatoSelect.value || "",
        ).trim();
        const items = getComunicatiItems();

        creaListaFuturoComunicatoSelect.innerHTML =
          '<option value="">seleziona comunicato</option>';

        items.forEach((item) => {
          const id = String(item?.id || "").trim();
          const label = String(item?.label || "").trim();
          if (!id || !label) return;
          const option = document.createElement("option");
          option.value = id;
          option.textContent = label;
          creaListaFuturoComunicatoSelect.appendChild(option);
        });

        if (
          currentValue &&
          items.some((x) => String(x?.id || "").trim() === currentValue)
        ) {
          creaListaFuturoComunicatoSelect.value = currentValue;
        }
      }

      function saveAppState(state) {
        try {
          localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(state || {}));
        } catch (e) {
          return;
        }
      }

      const appState = loadAppState();

      if (typeof appState.activeMailingListId !== "string") {
        appState.activeMailingListId = "";
      }

      if (typeof appState.activeSpedizioneSourceListId !== "string") {
        appState.activeSpedizioneSourceListId = "";
      }

      if (typeof appState.activeSpedizioneName !== "string") {
        appState.activeSpedizioneName = "";
      }

      if (!appState.ui || typeof appState.ui !== "object") {
        appState.ui = {};
      }

      if (typeof appState.ui.showHelp !== "boolean") {
        appState.ui.showHelp = true;
      }

      function normalizeTheme(value) {
        const v = String(value || "")
          .trim()
          .toLowerCase();
        if (v === "dark") return "dark";
        return "light";
      }

      if (typeof appState.ui.theme !== "string") {
        appState.ui.theme = "light";
      }

      function applyTheme(theme) {
        const next = normalizeTheme(theme);
        document.body.dataset.theme = next;
        const a = document.getElementById("navThemeToggle");
        if (!a) return;
        const icon = a.querySelector(".nav-icon");
        if (icon) {
          icon.setAttribute(
            "data-icon",
            next === "dark" ? "light_mode" : "dark_mode",
          );
        }
        a.setAttribute(
          "aria-label",
          next === "dark" ? "tema chiaro" : "tema scuro",
        );
        a.setAttribute("aria-pressed", next === "dark" ? "true" : "false");
      }

      function setTheme(theme) {
        const next = normalizeTheme(theme);
        appState.ui.theme = next;
        applyTheme(next);
        saveAppState(appState);
      }

      if (
        !appState.ui.sectionOpen ||
        typeof appState.ui.sectionOpen !== "object"
      ) {
        appState.ui.sectionOpen = {};
      }

      if (
        typeof appState.ui.sectionOpen.notes !== "boolean" &&
        typeof appState.ui.notesOpen === "boolean"
      ) {
        appState.ui.sectionOpen.notes = appState.ui.notesOpen;
      }

      if (typeof appState.ui.sectionOpen.notes !== "boolean") {
        appState.ui.sectionOpen.notes = false;
      }

      for (const k of [
        "topics",
        "contacts",
        "redazioni",
        "articles",
        "mailing",
        "shipments",
      ]) {
        if (typeof appState.ui.sectionOpen[k] !== "boolean") {
          appState.ui.sectionOpen[k] = true;
        }
      }

      function getSectionOpen(key, defaultOpen) {
        const v = appState?.ui?.sectionOpen?.[key];
        return typeof v === "boolean" ? v : !!defaultOpen;
      }

      function setSectionOpen(key, open) {
        if (!appState.ui || typeof appState.ui !== "object") {
          appState.ui = {};
        }
        if (
          !appState.ui.sectionOpen ||
          typeof appState.ui.sectionOpen !== "object"
        ) {
          appState.ui.sectionOpen = {};
        }
        appState.ui.sectionOpen[key] = !!open;
        saveAppState(appState);
      }

      if (typeof appState.sortMode !== "string") {
        appState.sortMode = "name-asc";
      }

      applyTheme(appState.ui.theme);

      const navThemeToggle = document.getElementById("navThemeToggle");
      if (navThemeToggle) {
        navThemeToggle.addEventListener("click", (e) => {
          e.preventDefault();
          const current = normalizeTheme(appState.ui.theme);
          setTheme(current === "dark" ? "light" : "dark");
        });
      }

      const cardsLoadMore = document.getElementById("cardsLoadMore");
      if (cardsLoadMore) {
        cardsLoadMore.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const mode = getMainMode();
          if (mode === "testate") {
            visibleTestateLimit += CARD_PAGE_SIZE;
          } else {
            visibleJournalistLimit += CARD_PAGE_SIZE;
          }
          scheduleRender();
        });
      }

      {
        const wrap = document.getElementById("cardsLoadMoreWrap");
        const rootEl = document.getElementById("cardsGrid");
        if (wrap && typeof IntersectionObserver !== "undefined") {
          let inFlight = false;
          const obs = new IntersectionObserver(
            (entries) => {
              const entry = entries && entries[0];
              if (!entry || !entry.isIntersecting) return;
              if (wrap.style.display === "none") return;
              if (inFlight) return;
              inFlight = true;

              const mode = getMainMode();
              if (mode === "testate") {
                visibleTestateLimit += CARD_PAGE_SIZE;
              } else {
                visibleJournalistLimit += CARD_PAGE_SIZE;
              }
              scheduleRender();

              window.setTimeout(() => {
                inFlight = false;
              }, 500);
            },
            { root: rootEl || null, rootMargin: "600px 0px", threshold: 0.01 },
          );
          obs.observe(wrap);
        }
      }

      function getSortMode() {
        const v = String(appState.sortMode || "")
          .trim()
          .toLowerCase();
        if (v === "relevance" || v === "rilevanza") return "relevance";
        if (v === "role") return "role";
        if (v === "media-type") return "media-type";
        if (v === "frequency") return "frequency";
        if (v === "name-desc") return "name-desc";
        return "name-asc";
      }

      function setSortMode(mode) {
        const raw = String(mode || "")
          .trim()
          .toLowerCase();
        const next =
          raw === "relevance" || raw === "rilevanza"
            ? "relevance"
            : raw === "role"
              ? "role"
              : raw === "media-type" || raw === "tipo-media"
                ? "media-type"
                : raw === "frequency" || raw === "frequenza"
                  ? "frequency"
                  : raw === "name-desc" || raw === "name-z-a" || raw === "z-a"
                    ? "name-desc"
                    : "name-asc";
        appState.sortMode = next;
        if (getMainMode() === "testate") {
          const { textActive } = getFilterState();
          if (textActive) {
            appState.testateSortManuallyOverridden = next !== "relevance";
          }
        } else {
          const { textActive } = getFilterState();
          if (textActive) {
            appState.journalistsSortManuallyOverridden = next !== "relevance";
          }
        }
        saveAppState(appState);
        scheduleRender();
      }

      const ENABLED_VIEWS = new Set([
        "filtra",
        "mailing-list",
        "crea-lista-futuro",
        "dashboard",
        "mailing-lists",
        "spedisci-lista",
        "comunicati",
        "spedizioni",
        "progetti",
        "todos",
        "account",
      ]);

      function normalizeViewId(value) {
        const v = String(value || "")
          .trim()
          .toLowerCase();
        if (!v) return "";
        if (!/^[a-z0-9-]+$/.test(v)) return "";
        return v;
      }

      function setActiveView(viewId, options = {}) {
        const { save = true } = options;
        const prevView = normalizeViewId(appState.view);
        let v = normalizeViewId(viewId);
        if (!v || !ENABLED_VIEWS.has(v)) {
          v = "filtra";
        }

        appState.view = v;
        document.body.dataset.activeView = v;
        document.body.classList.toggle(
          "is-mailing-list-view",
          v === "mailing-list",
        );
        document.body.classList.toggle(
          "is-spedisci-lista-view",
          v === "spedisci-lista",
        );

        document.querySelectorAll(".app-view").forEach((el) => {
          const viewKey = el.getAttribute("data-view");
          const shouldShow =
            v === "mailing-list" || v === "spedisci-lista"
              ? viewKey === "filtra"
              : viewKey === v;
          el.classList.toggle("is-active", shouldShow);
        });

        const sp = document.getElementById("selectedPanel");
        if (
          sp &&
          v !== "filtra" &&
          v !== "mailing-list" &&
          v !== "spedisci-lista"
        ) {
          sp.classList.remove("show");
          sp.setAttribute("aria-hidden", "true");
          document.body.classList.remove("selection-panel-open");
        }

        if (
          v === "filtra" &&
          prevView !== "filtra" &&
          selectedJournalistIds.size > 0
        ) {
          openSelectedPanel();
        }

        if (v === "mailing-list" && selectedJournalistIds.size > 0) {
          openSelectedPanel();
        }

        document.querySelectorAll(".nav-sidebar a[data-view]").forEach((a) => {
          const isActive = a.getAttribute("data-view") === v;
          a.classList.toggle("is-active", isActive);
          if (isActive) {
            a.setAttribute("aria-current", "page");
          } else {
            a.removeAttribute("aria-current");
          }
        });

        if (save) {
          saveAppState(appState);
        }

        updateHelpLinkVisibility();

        if (v === "account") {
          closeHelpPanel();
        }

        if (v !== "spedisci-lista") {
          closeShipmentEmailHeaderSpotlight();
        }

        if (v !== "spedisci-lista") {
          closeNewPressPanel();
        }

        if (v === "filtra" || v === "mailing-list" || v === "spedisci-lista") {
          scheduleRender();
        } else if (v === "crea-lista-futuro") {
          openCreaListaFuturoView();
        } else if (
          v === "dashboard" ||
          v === "mailing-lists" ||
          v === "spedizioni"
        ) {
          renderDashboardMailingLists();
          renderDashboardSpedizioni();
          renderDashboardComunicati();
        }
      }

      function getViewFromHash() {
        const raw = window.location.hash || "";
        if (!raw.startsWith("#")) return "";
        return normalizeViewId(raw.slice(1));
      }

      class FilterableDropdown {
        constructor(inputId, options = [], config = {}) {
          const {
            inputWrapperId = "dropdownInputWrapper",
            chipContainerId = "chipContainer",
            autocompleteInlineId = "autocompleteInline",
            autocompleteSuffixId = "autocompleteSuffix",
            autocompleteTipId = "autocompleteTip",
            arrowId = "dropdownArrow",
            clearId = "dropdownClearLink",
            listId = "dropdownList",
            closeLinkId = "closeDropdownLink",
            suggestionsId = "dropdownSuggestions",
            resultsId = "dropdownResults",
          } = config;

          this.renderChipsInInput = config.renderChipsInInput !== false;
          this.renderCheckboxes = config.renderCheckboxes !== false;
          this.singleSelect = config.singleSelect === true;
          this.closeOnSelect = config.closeOnSelect === true;
          this.writeSelectedToInput = config.writeSelectedToInput === true;
          this.enableHighlight = config.enableHighlight === true;
          this.minFilterChars =
            typeof config.minFilterChars === "number"
              ? config.minFilterChars
              : 3;
          this.preserveParentOrder = config.preserveParentOrder === true;
          this.sortComparator =
            typeof config.sortComparator === "function"
              ? config.sortComparator
              : (a, b) => a.localeCompare(b, "it", { sensitivity: "base" });

          this.input = document.getElementById(inputId);
          this.inputWrapper = document.getElementById(inputWrapperId);
          this.container = this.input?.closest(".dropdown-container");
          this.label = this.container?.querySelector(
            `label.field-label[for="${inputId}"]`,
          );

          this.baseContainerMarginBottom = 0;
          if (this.container) {
            const mb = window.getComputedStyle(this.container).marginBottom;
            this.baseContainerMarginBottom = parseFloat(mb || "0") || 0;
          }
          this.chipContainer = document.getElementById(chipContainerId);
          this.autocompleteInline =
            document.getElementById(autocompleteInlineId);
          this.autocompleteSuffix =
            document.getElementById(autocompleteSuffixId);
          this.autocompleteTip = document.getElementById(autocompleteTipId);
          this.arrow = document.getElementById(arrowId);
          this.clear = clearId ? document.getElementById(clearId) : null;
          this.list = document.getElementById(listId);
          this.closeLink = closeLinkId
            ? document.getElementById(closeLinkId)
            : null;
          this.suggestions = document.getElementById(suggestionsId);
          this.results = document.getElementById(resultsId);

          this.originalOptions = options;
          this.filteredOptions = [...options];
          this.selectedValues = new Set();
          this.strongMatchOptions = new Set();
          this.matchRank = new Map();
          this.visibleOptions = [...options];
          this.isOpen = false;
          this.selectedIndex = -1;

          this.suppressedAutocompleteQuery = null;
          this.suppressedAutocompleteTerms = new Set();

          if (!FilterableDropdown._instances) {
            FilterableDropdown._instances = new Set();
          }
          FilterableDropdown._instances.add(this);

          this.baseInputWrapperHeight = null;

          this.ignoreWrapperClick = false;
          this.expandedParents = new Set();

          this.parents = config.parents || [];
          this.childrenByParent = config.childrenByParent || {};

          this.optionToParent = {};
          for (const p of this.parents) {
            for (const child of this.childrenByParent[p] || []) {
              this.optionToParent[child] = p;
            }
          }

          this.relatedMap = {};
          this.autocompleteMap = {};
          this.keywordToFiltersMap = {};

          const defaultSynonymsByFilter = {
            "Disegno grafico": [
              "Grafica pubblicitaria",
              "Design grafico",
              "Progettazione grafica",
            ],
            "Infusi e caffetteria": [
              "Bevande calde",
              "Infusi e caffetteria",
              "Bevande stimolanti",
            ],
            Dolciumi: [
              "Dolci",
              "Caramelle",
              "Confetteria",
              "Prodotti zuccherini",
            ],
            "Igiene alimentare": [
              "Sicurezza alimentare",
              "Sanità degli alimenti",
              "Controllo igienico-sanitario",
            ],
            "Industria alimentare": [
              "Settore alimentare",
              "Industria agroalimentare",
              "Comparto alimentare",
            ],
            "Latte e latticini": [
              "Prodotti caseari",
              "Derivati del latte",
              "Lattiero-caseario",
            ],
            "Alimenti biologici": [
              "Cibi biologici",
              "Prodotti bio",
              "Alimenti da agricoltura biologica",
            ],
            Bevande: ["Drink", "Bibite", "Bevande analcoliche"],
            Liquori: ["Distillati", "Alcolici", "Bevande spiritose"],
            Vegetarianesimo: [
              "Alimentazione vegetariana",
              "Dieta vegetariana",
              "Scelta vegetariana",
            ],
            "Distribuzione automatica": [
              "Vending",
              "Vendita automatizzata",
              "Distributori automatici",
            ],
            "Cucina e gastronomia": [
              "Arte culinaria",
              "Gastronomia",
              "Tradizione culinaria",
            ],
            Alimentazione: ["Nutrizione", "Dieta", "Regime alimentare"],
            "Vini ed Enologia": [
              "Vitivinicoltura",
              "Cultura del vino",
              "Settore enologico",
            ],
            Agroalimentare: [
              "Settore agroalimentare",
              "Filiera agroalimentare",
            ],
            "Politica agraria": ["Politiche agricole", "Governance agricola"],
            "Zootecnica e Allevamento": [
              "Allevamento animale",
              "Produzione zootecnica",
              "Scienze zootecniche",
            ],
            "Agricoltura biologica": [
              "Coltivazione biologica",
              "Agricoltura eco-sostenibile",
              "Agricoltura organica",
            ],
            Viticoltura: ["Coltivazione della vite", "Produzione vitivinicola"],
            Agricoltura: [
              "Coltivazione",
              "Attività agricola",
              "Produzione agricola",
            ],
            Foreste: ["Bosco", "Aree forestali", "Patrimonio forestale"],
            Veterinaria: ["Medicina veterinaria", "Scienze veterinarie"],

            "Ingegneria informatica": [
              "Informatica ingegneristica",
              "Ingegneria del software e dei sistemi",
            ],
            "Giochi e videogame": ["Videogiochi", "Gaming"],
            "Computer grafica 3D": ["Grafica tridimensionale", "CG 3D"],
            "Hardware informatico": [
              "Componenti hardware",
              "Dispositivi informatici",
            ],
            "Home entertainment per PC": [
              "Intrattenimento digitale per PC",
              "Multimedia per computer",
            ],
            "Editoria elettronica": [
              "Editoria digitale",
              "Pubblicazione digitale",
            ],
            "App, smartphone, Android, iOS": [
              "Applicazioni mobili",
              "Mobile app",
              "Ecosistema mobile",
            ],
            Software: ["Programmi", "Applicativi"],
            "Sicurezza dei sistemi": [
              "Sicurezza informatica",
              "Protezione dei sistemi",
            ],
            "Reti informatiche": [
              "Network informatici",
              "Infrastrutture di rete",
            ],
            "Sicurezza delle informazioni": [
              "Protezione dei dati",
              "Information security",
            ],
            "Web design": ["Design web", "Progettazione grafica web"],
            "Progettazione siti web": [
              "Sviluppo web",
              "Realizzazione siti web",
            ],
            Multimedialità: ["Contenuti multimediali", "Media digitali"],
            "Web e Social Network": [
              "Web e social media",
              "Piattaforme online",
            ],
            "Information Technology": [
              "Tecnologia dell’informazione",
              "IT",
              "Tecnologie informatiche",
            ],

            "Arte Contemporanea": [
              "Arte moderna (uso comune, non accademico)",
              "Produzione artistica contemporanea",
            ],
            "Libri per bambini": [
              "Letteratura per l’infanzia",
              "Libri per ragazzi",
            ],
            Narrativa: ["Prosa", "Narrativa di finzione"],
            Letteratura: ["Produzione letteraria", "Opere letterarie"],
            "Arti Grafiche": ["Grafica", "Arti visive applicate"],
            Poesia: ["Produzione poetica", "Versi"],
            Filosofia: ["Pensiero filosofico", "Speculazione filosofica"],
            Arte: ["Espressione artistica", "Arti visive"],
            "Libri e editoria": ["Editoria", "Pubblicazioni"],
            Mostre: ["Esposizioni", "Rassegne"],
            "Mercato d'arte e aste": ["Compravendita d’arte", "Aste d’arte"],
            Storia: ["Scienze storiche", "Ricerca storica"],
            Geografia: ["Scienze geografiche", "Studio del territorio"],
            Cultura: ["Patrimonio culturale", "Attività culturali"],
            Antiquariato: ["Mercato antiquario", "Beni antichi"],
            Archeologia: ["Ricerca archeologica", "Scavi archeologici"],
            Disegno: ["Arte del disegno", "Disegno artistico"],
            Pittura: ["Arte pittorica", "Pittura artistica"],
            Scultura: ["Arte scultorea", "Scultura artistica"],
            Restauro: ["Conservazione", "Recupero artistico"],
            "Musei e beni culturali": [
              "Patrimonio museale",
              "Beni storico-culturali",
            ],
          };

          const synonymsByFilter =
            config.synonymsByFilter || defaultSynonymsByFilter;

          this.autocompleteTerms = new Set();

          for (const [filter, syns] of Object.entries(synonymsByFilter)) {
            for (const syn of syns) {
              const key = (syn || "").trim().toLowerCase();
              if (!key) continue;
              if (!this.keywordToFiltersMap[key]) {
                this.keywordToFiltersMap[key] = [filter];
              } else if (!this.keywordToFiltersMap[key].includes(filter)) {
                this.keywordToFiltersMap[key].push(filter);
              }
              this.autocompleteTerms.add(key);
            }
          }
          this.init();
        }

        setSynonymsByFilter(synonymsByFilter = {}) {
          const syns =
            synonymsByFilter && typeof synonymsByFilter === "object"
              ? synonymsByFilter
              : {};

          this.keywordToFiltersMap = {};
          this.autocompleteTerms = new Set();

          for (const [filter, list] of Object.entries(syns)) {
            const f = String(filter || "").trim();
            if (!f) continue;
            for (const raw of Array.isArray(list) ? list : []) {
              const term = String(raw || "")
                .trim()
                .toLowerCase();
              if (!term) continue;
              if (!this.keywordToFiltersMap[term]) {
                this.keywordToFiltersMap[term] = [f];
              } else if (!this.keywordToFiltersMap[term].includes(f)) {
                this.keywordToFiltersMap[term].push(f);
              }
              this.autocompleteTerms.add(term);
            }
          }

          const current = this.input?.value || "";
          this.filterOptions(current);
          this.updateAutocompleteHint(current);
        }

        updateReservedSpace() {
          if (!this.container) return;

          this.container.style.marginBottom = this.baseContainerMarginBottom
            ? `${this.baseContainerMarginBottom}px`
            : "";
        }

        updateReservedSpaceSoon() {
          if (this._reserveRaf) {
            cancelAnimationFrame(this._reserveRaf);
          }
          this._reserveRaf = requestAnimationFrame(() => {
            this._reserveRaf = null;
            this.updateReservedSpace();
          });
        }

        init() {
          this.renderList();
          this.bindEvents();
          this.updateClearVisibility();

          if (this.baseInputWrapperHeight == null) {
            this.baseInputWrapperHeight = this.inputWrapper?.offsetHeight || 0;
          }
        }

        bindEvents() {
          this.inputWrapper.addEventListener("click", () => {
            if (this.input?.disabled) return;
            if (this.ignoreWrapperClick) {
              this.ignoreWrapperClick = false;
              return;
            }
            this.input.focus();
            this.toggle();
          });

          if (this.label) {
            this.label.addEventListener("click", (e) => {
              if (this.input?.disabled) return;
              e.preventDefault();
              e.stopPropagation();
              this.ignoreWrapperClick = true;
              setTimeout(() => {
                this.ignoreWrapperClick = false;
              }, 0);

              if (this.isOpen) {
                this.close();
              } else {
                this.open();
                this.input.focus();
              }
            });
          }

          this.input.addEventListener("input", (e) => {
            this.filterOptions(e.target.value);
            this.updateAutocompleteHint(e.target.value);
            if (!this.isOpen) {
              this.open();
            }
            this.selectedIndex = -1;
          });

          this.input.addEventListener("keydown", (e) => {
            this.handleKeyboard(e);
          });

          if (this.clear) {
            this.clear.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              this.resetSelection();
            });
          }

          this.onDocumentKeyDown = (e) => {
            if (e.key === "Escape" && this.isOpen) {
              e.preventDefault();
              e.stopPropagation();
              this.close();
            }
          };

          document.addEventListener("keydown", this.onDocumentKeyDown, true);

          if (this.closeLink) {
            this.closeLink.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              this.close();
            });
          }
        }

        filterOptions(query) {
          const q = (query || "").trim().toLowerCase();
          const includeSet = new Set();
          const strongSet = new Set();
          const rank = new Map();

          if (
            this.suppressedAutocompleteQuery &&
            this.suppressedAutocompleteQuery !== q
          ) {
            this.suppressedAutocompleteQuery = null;
            this.suppressedAutocompleteTerms.clear();
          }

          if (q.length < this.minFilterChars) {
            this.filteredOptions = [...this.originalOptions];
            this.strongMatchOptions = new Set();
            this.matchRank = new Map();
            this.renderList();
            return;
          }

          if (!q) {
            this.filteredOptions = [...this.originalOptions];
            this.strongMatchOptions = new Set();
            this.matchRank = new Map();
            this.renderList();
            return;
          }

          for (const option of this.originalOptions) {
            const optionLower = option.toLowerCase();
            const tokens = optionLower.split(/\s+/).filter(Boolean);
            const strongMatch = tokens.some((t) => t.startsWith(q));

            if (strongMatch) {
              includeSet.add(option);
              strongSet.add(option);
              rank.set(option, 0);
            }
          }

          if (q.length >= 3) {
            for (const term of this.autocompleteTerms || []) {
              if (
                this.suppressedAutocompleteQuery === q &&
                this.suppressedAutocompleteTerms.has(term)
              ) {
                continue;
              }
              const words = String(term).split(/\s+/).filter(Boolean);
              if (words.some((w) => w.startsWith(q))) {
                const mapped = this.keywordToFiltersMap[term] || [];
                for (const filter of mapped) {
                  includeSet.add(filter);
                  strongSet.add(filter);
                  if (!rank.has(filter)) {
                    rank.set(filter, 1);
                  }
                }
              }
            }
          }

          this.filteredOptions = this.originalOptions.filter((opt) =>
            includeSet.has(opt),
          );
          this.strongMatchOptions = strongSet;
          this.matchRank = rank;
          this.renderList();
        }

        getAutocompleteSuggestion(query) {
          const q = (query || "").trim().toLowerCase();
          if (!q) return null;

          // 1) mapping esplicito
          const mapped = this.autocompleteMap[q];
          if (mapped) {
            const suffix = mapped.slice(q.length);
            if (!suffix) return null;
            return { full: mapped, suffix };
          }

          // 2) completamento a prefisso sui termini (sinonimi)
          if (q.length < 3) return null;

          const candidates = [];
          for (const term of this.autocompleteTerms || []) {
            if (term.startsWith(q) && term.length > q.length) {
              candidates.push(term);
            }
          }
          if (candidates.length === 0) return null;

          candidates.sort(
            (a, b) => a.length - b.length || a.localeCompare(b, "it"),
          );
          const full = candidates[0];
          const suffix = full.slice(q.length);
          if (!suffix) return null;
          return { full, suffix };
        }

        measureTextWidth(text, element) {
          const canvas =
            this._measureCanvas ||
            (this._measureCanvas = document.createElement("canvas"));
          const ctx = canvas.getContext("2d");
          if (!ctx) return 0;

          const cs = window.getComputedStyle(element);
          ctx.font = `${cs.fontStyle} ${cs.fontVariant} ${cs.fontWeight} ${cs.fontSize} ${cs.fontFamily}`;
          const metrics = ctx.measureText(text);
          let width = metrics.width || 0;

          const letterSpacing = parseFloat(cs.letterSpacing || "0");
          if (
            !Number.isNaN(letterSpacing) &&
            letterSpacing != 0 &&
            text.length > 1
          ) {
            width += (text.length - 1) * letterSpacing;
          }
          return width;
        }

        updateAutocompleteHint(query) {
          const suggestion = this.getAutocompleteSuggestion(query);
          const caretAtEnd =
            this.input.selectionStart === this.input.value.length &&
            this.input.selectionEnd === this.input.value.length;

          const q = (query || "").trim().toLowerCase();
          if (
            suggestion &&
            this.suppressedAutocompleteQuery === q &&
            this.suppressedAutocompleteTerms.has(suggestion.full)
          ) {
            this.autocompleteSuffix.textContent = "";
            this.autocompleteTip.textContent = "";
            this.autocompleteInline.classList.remove("show");
            return;
          }

          if (!this.isOpen || !suggestion || !caretAtEnd) {
            this.autocompleteSuffix.textContent = "";
            this.autocompleteTip.textContent = "";
            this.autocompleteInline.classList.remove("show");
            return;
          }

          this.autocompleteSuffix.textContent = suggestion.suffix;
          this.autocompleteTip.textContent = "";

          const left =
            this.input.offsetLeft +
            this.measureTextWidth(this.input.value, this.input);
          const cs = window.getComputedStyle(this.input);
          const paddingTop = parseFloat(cs.paddingTop || "0") || 0;
          const fontSize = parseFloat(cs.fontSize || "16") || 16;
          const lineHeight =
            cs.lineHeight === "normal"
              ? fontSize * 1.2
              : parseFloat(cs.lineHeight || `${fontSize * 1.2}`) ||
                fontSize * 1.2;
          const lineOffset = Math.max(0, (lineHeight - fontSize) / 2);
          const top = this.input.offsetTop + paddingTop + lineOffset - 2.75;
          this.autocompleteInline.style.left = `${left}px`;
          this.autocompleteInline.style.top = `${top}px`;
          this.autocompleteInline.classList.add("show");
        }

        renderList() {
          this.results.innerHTML = "";
          this.suggestions.innerHTML = "";

          const query = this.input.value.trim();
          const q = query.toLowerCase();
          const isFiltered = q.length >= this.minFilterChars;

          if (!isFiltered) {
            this.expandedParents?.clear();
          }

          const suggestionsSet = new Set();
          const filteredSet = new Set(this.filteredOptions);
          const showSuggestions = q.length >= this.minFilterChars;

          if (showSuggestions) {
            const kwSuggestions = this.keywordToFiltersMap[q] || [];
            for (const opt of kwSuggestions) {
              if (opt && !filteredSet.has(opt)) {
                suggestionsSet.add(opt);
              }
            }

            const strongOrSelected = new Set([
              ...Array.from(this.selectedValues),
              ...Array.from(this.strongMatchOptions || []),
            ]);

            for (const opt of strongOrSelected) {
              const related = this.relatedMap[opt];
              if (related && !filteredSet.has(related)) {
                suggestionsSet.add(related);
              }
            }
          }

          const suggestions = Array.from(suggestionsSet)
            .filter(
              (opt) =>
                this.originalOptions.includes(opt) && !filteredSet.has(opt),
            )
            .sort((a, b) => this.sortComparator(a, b));

          const matched = [...this.filteredOptions].sort((a, b) => {
            const ra = this.matchRank?.get(a) ?? 99;
            const rb = this.matchRank?.get(b) ?? 99;
            return ra - rb || this.sortComparator(a, b);
          });

          const visible = [...matched, ...suggestions];
          const childrenByParentVisible = new Map();
          for (const opt of visible) {
            const parent = this.optionToParent[opt];
            if (!parent) continue;
            if (!childrenByParentVisible.has(parent)) {
              childrenByParentVisible.set(parent, []);
            }
            childrenByParentVisible.get(parent).push(opt);
          }

          const parentsWithChildren = Array.from(childrenByParentVisible.keys())
            .filter((p) => (childrenByParentVisible.get(p) || []).length > 0)
            .sort((p1, p2) => {
              if (this.preserveParentOrder) {
                const idx1 = (this.parents || []).indexOf(p1);
                const idx2 = (this.parents || []).indexOf(p2);
                const a = idx1 === -1 ? Number.POSITIVE_INFINITY : idx1;
                const b = idx2 === -1 ? Number.POSITIVE_INFINITY : idx2;
                return a - b;
              }

              const c1 = childrenByParentVisible.get(p1) || [];
              const c2 = childrenByParentVisible.get(p2) || [];
              const best1 = c1.reduce(
                (acc, x) => Math.min(acc, this.matchRank?.get(x) ?? 99),
                99,
              );
              const best2 = c2.reduce(
                (acc, x) => Math.min(acc, this.matchRank?.get(x) ?? 99),
                99,
              );
              return (
                best1 - best2 ||
                p1.localeCompare(p2, "it", { sensitivity: "base" })
              );
            });

          this.visibleOptions = [];

          if ((this.parents || []).length === 0) {
            if (visible.length === 0) {
              const empty = document.createElement("div");
              empty.className = "no-results";
              empty.textContent = "Nessun risultato";
              this.results.appendChild(empty);
              if (this.isOpen) {
                this.updateReservedSpace();
              }
              return;
            }

            this.visibleOptions = visible;
            this.visibleOptions.forEach((option, index) => {
              const item = document.createElement("div");
              item.className = "dropdown-item child-item";
              item.dataset.index = String(index);

              const checkbox = document.createElement("input");
              const label = document.createElement("span");
              if (this.enableHighlight && query) {
                label.innerHTML = highlightHtml(option, query);
              } else {
                label.textContent = option;
              }

              if (this.selectedValues.has(option)) {
                item.classList.add("selected");
              }

              if (this.renderCheckboxes) {
                checkbox.type = "checkbox";
                checkbox.className = "dropdown-checkbox";
                checkbox.checked = this.selectedValues.has(option);
                checkbox.addEventListener("click", (e) => {
                  e.stopPropagation();
                });
                checkbox.addEventListener("change", (e) => {
                  e.stopPropagation();
                  this.toggleOption(option);
                });
                item.appendChild(checkbox);
              }
              item.addEventListener("click", (e) => {
                e.stopPropagation();
                this.toggleOption(option);
              });
              item.appendChild(label);
              this.results.appendChild(item);
            });

            if (this.isOpen) {
              this.updateReservedSpace();
            }
            return;
          }

          if (parentsWithChildren.length === 0) {
            const empty = document.createElement("div");
            empty.className = "no-results";
            empty.textContent = "Nessun risultato";
            this.results.appendChild(empty);
            if (this.isOpen) {
              this.updateReservedSpace();
            }
            return;
          }

          for (const p of parentsWithChildren) {
            const group = document.createElement("div");
            group.className = "dropdown-group";

            const groupLabel = document.createElement("span");
            groupLabel.textContent = p;
            group.appendChild(groupLabel);

            const visibleChildrenForParent =
              childrenByParentVisible.get(p) || [];
            const allChildrenForParent = this.childrenByParent?.[p] || [];
            const canExpand =
              isFiltered &&
              allChildrenForParent.length > visibleChildrenForParent.length;
            const shouldShowExpandToggle =
              isFiltered && (canExpand || this.expandedParents.has(p));

            if (shouldShowExpandToggle) {
              const showAllLink = document.createElement("a");
              showAllLink.href = "#";
              showAllLink.className = "close-dropdown-link";
              showAllLink.textContent = this.expandedParents.has(p)
                ? "mostra meno"
                : "mostra tutti";
              showAllLink.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (this.expandedParents.has(p)) {
                  this.expandedParents.delete(p);
                } else {
                  this.expandedParents.add(p);
                }
                this.renderList();
                this.input.focus();
              });
              group.appendChild(showAllLink);
            }

            this.results.appendChild(group);

            const visibleChildren = (childrenByParentVisible.get(p) || []).sort(
              (a, b) => this.sortComparator(a, b),
            );

            let childrenToRender = visibleChildren;
            if (isFiltered && this.expandedParents.has(p)) {
              const allChildren = [...(this.childrenByParent?.[p] || [])].sort(
                (a, b) => this.sortComparator(a, b),
              );
              const inVisible = new Set(visibleChildren);
              const extra = allChildren.filter((c) => !inVisible.has(c));
              childrenToRender = [...visibleChildren, ...extra];
            }

            childrenToRender.forEach((option) => {
              const index = this.visibleOptions.length;
              this.visibleOptions.push(option);

              const item = document.createElement("div");
              item.className = "dropdown-item child-item";
              item.dataset.index = String(index);

              const checkbox = document.createElement("input");
              const label = document.createElement("span");
              if (this.enableHighlight && query) {
                label.innerHTML = highlightHtml(option, query);
              } else {
                label.textContent = option;
              }

              if (this.selectedValues.has(option)) {
                item.classList.add("selected");
              }

              if (this.renderCheckboxes) {
                checkbox.type = "checkbox";
                checkbox.className = "dropdown-checkbox";
                checkbox.checked = this.selectedValues.has(option);
                checkbox.addEventListener("click", (e) => {
                  e.stopPropagation();
                });
                checkbox.addEventListener("change", (e) => {
                  e.stopPropagation();
                  this.toggleOption(option);
                });
                item.appendChild(checkbox);
              }
              item.addEventListener("click", (e) => {
                e.stopPropagation();
                this.toggleOption(option);
              });
              item.appendChild(label);
              this.results.appendChild(item);
            });
          }
          if (this.isOpen) {
            this.updateReservedSpace();
          }
        }

        handleKeyboard(e) {
          if (e.key === "Tab") {
            const suggestion = this.getAutocompleteSuggestion(this.input.value);
            if (suggestion) {
              e.preventDefault();
              this.input.value = suggestion.full;
              this.filterOptions(this.input.value);
              this.updateAutocompleteHint(this.input.value);
              if (!this.isOpen) {
                this.open();
              }
              this.selectedIndex = -1;
              return;
            }
          }

          if (
            e.key === "Backspace" &&
            this.input.value === "" &&
            this.selectedValues.size > 0
          ) {
            e.preventDefault();
            const last = Array.from(this.selectedValues).pop();
            if (last) {
              this.selectedValues.delete(last);
              this.renderChips();
              this.renderList();
              this.updateClearVisibility();
              if (typeof this.onSelectionChange === "function") {
                this.onSelectionChange(Array.from(this.selectedValues));
              }
            }
            return;
          }

          if (!this.isOpen && (e.key === "ArrowDown" || e.key === "ArrowUp")) {
            e.preventDefault();
            this.open();
            return;
          }

          if (!this.isOpen) return;
          const totalItems = (this.visibleOptions || []).length;

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              this.selectedIndex = Math.min(
                this.selectedIndex + 1,
                totalItems - 1,
              );
              break;
            case "ArrowUp":
              e.preventDefault();
              this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
              break;
            case "Enter":
              e.preventDefault();

              // Se l'utente preme Enter senza aver selezionato un item,
              // non accettare l'autocomplete (ghost) e sopprimi i suggerimenti derivati.
              if (this.selectedIndex < 0) {
                const typed = (this.input.value || "").trim();
                const suggestion = this.getAutocompleteSuggestion(typed);

                if (suggestion) {
                  this.suppressedAutocompleteQuery = typed.toLowerCase();
                  this.suppressedAutocompleteTerms = new Set([suggestion.full]);

                  const mapped =
                    this.keywordToFiltersMap?.[suggestion.full] || [];
                  let changed = false;
                  for (const opt of mapped) {
                    if (this.selectedValues.has(opt)) {
                      this.selectedValues.delete(opt);
                      changed = true;
                    }
                  }

                  if (changed) {
                    this.renderChips();
                    this.updateClearVisibility();
                    if (typeof this.onSelectionChange === "function") {
                      this.onSelectionChange(Array.from(this.selectedValues));
                    }
                  }
                }

                // Nascondi il ghost text senza cambiare il valore digitato.
                this.autocompleteSuffix.textContent = "";
                this.autocompleteTip.textContent = "";
                this.autocompleteInline.classList.remove("show");

                // Ricalcola la lista tenendo conto della soppressione.
                this.filterOptions(this.input.value);
                this.updateAutocompleteHint(this.input.value);
                this.selectedIndex = -1;
                return;
              }

              if (this.selectedIndex >= 0) {
                const option = (this.visibleOptions || [])[this.selectedIndex];
                if (option) {
                  this.toggleOption(option);
                }
              }
              break;
            case "Escape":
              e.preventDefault();
              this.close();
              break;
          }
        }

        toggleOption(option) {
          const alreadySelected = this.selectedValues.has(option);

          if (this.singleSelect) {
            this.selectedValues.clear();
            if (!alreadySelected) {
              this.selectedValues.add(option);
            }
          } else {
            if (alreadySelected) {
              this.selectedValues.delete(option);
            } else {
              this.selectedValues.add(option);
            }
          }

          if (this.writeSelectedToInput && this.input) {
            if (this.selectedValues.size === 1) {
              this.input.value = Array.from(this.selectedValues)[0] || "";
            } else {
              this.input.value = "";
            }
          }

          this.renderChips();
          this.renderList();
          this.updateClearVisibility();
          if (typeof this.onSelectionChange === "function") {
            this.onSelectionChange(Array.from(this.selectedValues));
          }

          if (this.closeOnSelect && this.singleSelect) {
            this.close();
          }
        }

        setOptions(options = []) {
          this.originalOptions = Array.isArray(options) ? options : [];
          this.filteredOptions = [...this.originalOptions];
          this.visibleOptions = [...this.originalOptions];
          this.matchRank = new Map();
          this.strongMatchOptions = new Set();
          this.expandedParents?.clear();
          this.resetSelection();
          this.renderList();
        }

        removeOption(option) {
          if (!this.selectedValues.has(option)) return;
          this.selectedValues.delete(option);
          this.renderChips();
          this.renderList();
          this.updateClearVisibility();
          if (typeof this.onSelectionChange === "function") {
            this.onSelectionChange(Array.from(this.selectedValues));
          }
        }

        renderChips() {
          if (!this.chipContainer) return;
          if (!this.renderChipsInInput) {
            this.chipContainer.innerHTML = "";
            return;
          }

          this.chipContainer.innerHTML = "";
          for (const value of Array.from(this.selectedValues)) {
            const chip = document.createElement("span");
            chip.className = "chip";

            const text = document.createElement("span");
            text.textContent = value;

            const remove = document.createElement("button");
            remove.type = "button";
            remove.className = "chip-remove";
            remove.textContent = "×";
            remove.addEventListener("click", (e) => {
              e.stopPropagation();
              this.selectedValues.delete(value);
              this.renderChips();
              this.renderList();
              this.updateClearVisibility();
              if (typeof this.onSelectionChange === "function") {
                this.onSelectionChange(Array.from(this.selectedValues));
              }
            });

            chip.appendChild(text);
            chip.appendChild(remove);
            this.chipContainer.appendChild(chip);
          }
        }

        resetSelection() {
          this.selectedValues.clear();
          this.input.value = "";
          this.filterOptions("");
          this.updateAutocompleteHint("");
          this.renderChips();
          this.updateClearVisibility();
          if (typeof this.onSelectionChange === "function") {
            this.onSelectionChange(Array.from(this.selectedValues));
          }
        }

        updateClearVisibility() {
          const hasActive = this.selectedValues.size > 0;
          if (hasActive) {
            if (this.clear) this.clear.classList.add("show");
          } else {
            if (this.clear) this.clear.classList.remove("show");
          }

          if (this.container) {
            if (hasActive) this.container.classList.add("has-active-filter");
            else this.container.classList.remove("has-active-filter");
          }
          if (this.arrow) {
            this.arrow.style.display = "block";
            this.arrow.style.right = "12px";
          }
        }

        open() {
          for (const inst of FilterableDropdown._instances || []) {
            if (inst !== this && inst?.isOpen) {
              inst.close();
            }
          }

          this.isOpen = true;
          this.updateAutocompleteHint(this.input.value);
          this.selectedIndex = -1;

          if (this.container) {
            this.container.classList.add("is-open");
          }

          this.list.classList.add("show");
          this.arrow.classList.add("rotated");
          this.inputWrapper.style.borderRadius =
            "var(--border-radius-xs) var(--border-radius-xs) 0 0";
          // Force style/layout flush so the margin-bottom transition starts in sync
          // with the dropdown-list transition.
          this.list.getBoundingClientRect();
          this.updateReservedSpace();
        }

        close() {
          this.isOpen = false;

          if (this.container) {
            this.container.classList.remove("is-open");
          }

          this.list.classList.remove("show");
          this.arrow.classList.remove("rotated");
          this.inputWrapper.style.borderRadius = "var(--border-radius-xs)";
          this.selectedIndex = -1;
          this.updateAutocompleteHint("");
          this.updateReservedSpace();
        }

        toggle() {
          if (this.isOpen) {
            this.close();
          } else {
            this.open();
          }
        }
      }

      const SERVICES_BY_PARENT = {
        "ALIMENTARI E BEVANDE": [
          "Birra",
          "Tè e Caffè",
          "Dolciumi",
          "Igiene alimentare",
          "Industria alimentare",
          "Latte e latticini",
          "Alimenti biologici",
          "Bevande",
          "Liquori",
          "Vegetarianesimo",
          "Distribuzione automatica",
          "Cucina e gastronomia",
          "Alimentazione",
          "Vini ed Enologia",
        ],
        AGRICOLTURA: [
          "Agroalimentare",
          "Politica agraria",
          "Zootecnica e Allevamento",
          "Agricoltura biologica",
          "Viticoltura",
          "Agricoltura",
          "Foreste",
          "Veterinaria",
        ],
        "INFORMATICA E WEB": [
          "Ingegneria informatica",
          "Giochi e videogame",
          "Computer grafica 3D",
          "Hardware informatico",
          "Home entertainment per PC",
          "Editoria elettronica",
          "App, smartphone, Android, iOS",
          "Software",
          "Sicurezza dei sistemi",
          "Reti informatiche",
          "Sicurezza delle informazioni",
          "Web design",
          "Progettazione siti web",
          "Multimedialità",
          "Web e Social Network",
          "Information Technology",
        ],
        "ARTE E CULTURA": [
          "Arte Contemporanea",
          "Libri per bambini",
          "Narrativa",
          "Letteratura",
          "Arti Grafiche",
          "Poesia",
          "Filosofia",
          "Arte",
          "Libri e editoria",
          "Mostre",
          "Mercato d'arte e aste",
          "Storia",
          "Geografia",
          "Cultura",
          "Antiquariato",
          "Archeologia",
          "Disegno",
          "Pittura",
          "Scultura",
          "Restauro",
          "Musei e beni culturali",
        ],
      };

      const sampleOptions = Object.values(SERVICES_BY_PARENT)
        .flat()
        .sort((a, b) => a.localeCompare(b, "it", { sensitivity: "base" }));

      const dropdown = new FilterableDropdown("dropdownInput", sampleOptions, {
        inputWrapperId: "dropdownInputWrapper",
        chipContainerId: "chipContainer",
        autocompleteInlineId: "autocompleteInline",
        autocompleteSuffixId: "autocompleteSuffix",
        autocompleteTipId: "autocompleteTip",
        arrowId: "dropdownArrow",
        clearId: "dropdownClearLink",
        listId: "dropdownList",
        closeLinkId: "closeDropdownLink",
        suggestionsId: "dropdownSuggestions",
        resultsId: "dropdownResults",
        parents: [
          "ALIMENTARI E BEVANDE",
          "AGRICOLTURA",
          "INFORMATICA E WEB",
          "ARTE E CULTURA",
        ],
        childrenByParent: SERVICES_BY_PARENT,
        renderChipsInInput: false,
      });
      dropdown.updateAutocompleteHint("");

      const ROLES_BY_PARENT = {
        DIREZIONE: [
          "Direttore responsabile",
          "Direttore editoriale",
          "Condirettore",
          "Vicedirettore",
        ],
        "COORDINAMENTO REDAZIONALE": [
          "Responsabile redazione",
          "Vice responsabile di redazione",
          "Capo redattore centrale",
          "Vice capo redattore centrale",
          "Capo redattore",
          "Vice capo redattore",
          "Capo servizio",
          "Vice capo servizio",
          "Responsabile servizi speciali",
          "Capo area",
          "Capocronista",
        ],
        REDAZIONE: [
          "Redattore",
          "Inviato",
          "Corrispondente",
          "Editorialista",
          "Web Editor",
        ],
        "CONTRIBUTORI / AUTORI ESTERNI": [
          "Collaboratore",
          "Autore",
          "Blogger",
          "Curatore",
        ],
        "PRODUZIONE & SUPPORTO": [
          "Produttore esecutivo",
          "Art director",
          "Consulente editoriale",
          "Responsabile segreteria redazione",
          "Segreteria redazione",
          "Segreteria direzione",
          "Assistente",
          "Praticante",
        ],
      };

      const ROLE_RANK = (() => {
        const rank = new Map();
        let i = 0;
        for (const parent of Object.keys(ROLES_BY_PARENT || {})) {
          for (const role of ROLES_BY_PARENT[parent] || []) {
            const k = String(role || "")
              .trim()
              .toLowerCase();
            if (!k) continue;
            if (!rank.has(k)) {
              rank.set(k, i);
              i++;
            }
          }
        }
        return rank;
      })();

      function getRoleRank(role) {
        const k = String(role || "")
          .trim()
          .toLowerCase();
        if (!k) return Number.POSITIVE_INFINITY;
        return ROLE_RANK.has(k) ? ROLE_RANK.get(k) : Number.POSITIVE_INFINITY;
      }

      function compareJournalistsByName(a, b) {
        const ca = String(a?.cognome || "").trim();
        const cb = String(b?.cognome || "").trim();
        const na = String(a?.nome || "").trim();
        const nb = String(b?.nome || "").trim();
        return (
          ca.localeCompare(cb, "it", { sensitivity: "base" }) ||
          na.localeCompare(nb, "it", { sensitivity: "base" })
        );
      }

      function compareTestateByName(a, b) {
        const na = String(a?.nome || "").trim();
        const nb = String(b?.nome || "").trim();
        return na.localeCompare(nb, "it", { sensitivity: "base" });
      }

      const roleOptions = Object.values(ROLES_BY_PARENT)
        .flat()
        .sort((a, b) => a.localeCompare(b, "it", { sensitivity: "base" }));

      const roleDropdown = new FilterableDropdown(
        "roleDropdownInput",
        roleOptions,
        {
          inputWrapperId: "roleDropdownInputWrapper",
          chipContainerId: "roleChipContainer",
          autocompleteInlineId: "roleAutocompleteInline",
          autocompleteSuffixId: "roleAutocompleteSuffix",
          autocompleteTipId: "roleAutocompleteTip",
          arrowId: "roleDropdownArrow",
          clearId: "roleDropdownClearLink",
          listId: "roleDropdownList",
          closeLinkId: "roleCloseDropdownLink",
          suggestionsId: "roleDropdownSuggestions",
          resultsId: "roleDropdownResults",
          parents: [
            "DIREZIONE",
            "COORDINAMENTO REDAZIONALE",
            "REDAZIONE",
            "CONTRIBUTORI / AUTORI ESTERNI",
            "PRODUZIONE & SUPPORTO",
          ],
          childrenByParent: ROLES_BY_PARENT,
          synonymsByFilter: {},
          renderChipsInInput: false,
          preserveParentOrder: true,
        },
      );
      roleDropdown.updateAutocompleteHint("");

      const journalists = [
        {
          nome: "Luca",
          cognome: "Rinaldi",
          ruolo: "Capo redattore",
          servizio: "Politica agraria",
          telefono: "+39 333 120 4451",
          email: "l.rinaldi@ilgiorno.it",
          testate: ["Il Giorno", "ANSA"],
          testata: "Il Giorno",
          note: "Segue ministeri e politiche del territorio. Tiene i contatti con associazioni e consorzi, copre dossier su PAC, fondi e misure di sostegno; monitora anche crisi di settore e tavoli tecnici con aggiornamenti frequenti.",
        },
        {
          nome: "Sara",
          cognome: "Ferri",
          ruolo: "Redattrice",
          servizio: "Web e Social Network",
          telefono: "+39 347 558 1092",
          email: "s.ferri@lastampa.it",
          testata: "La Stampa",
          note: "Focus su piattaforme e community online.",
        },
        {
          nome: "Marco",
          cognome: "De Santis",
          ruolo: "Inviato",
          servizio: "Agricoltura",
          telefono: "+39 329 440 7710",
          email: "m.desantis@repubblica.it",
          testata: "la Repubblica",
          note: "Reportage da fiere e aziende agricole.",
        },
        {
          nome: "Giulia",
          cognome: "Conti",
          ruolo: "Redattrice",
          servizio: "Libri e editoria",
          telefono: "+39 335 210 9033",
          email: "g.conti@corriere.it",
          testata: "Corriere della Sera",
          note: "Recensioni e interviste ad autori.",
        },
        {
          nome: "Paolo",
          cognome: "Marini",
          ruolo: "Redattore",
          servizio: "Software",
          telefono: "+39 338 770 1198",
          email: "p.marini@ilsole24ore.com",
          testata: "Il Sole 24 Ore",
          note: "Prodotti, aziende e trend del software.",
        },
        {
          nome: "Elena",
          cognome: "Bianchi",
          ruolo: "Collaboratrice",
          servizio: "Mostre",
          telefono: "+39 331 905 4472",
          email: "e.bianchi@ilfattoquotidiano.it",
          testata: "Il Fatto Quotidiano",
          note: "Agenda eventi e rassegne nazionali.",
        },
        {
          nome: "Davide",
          cognome: "Gallo",
          ruolo: "Redattore",
          servizio: "Hardware informatico",
          telefono: "+39 334 602 7715",
          email: "d.gallo@wired.it",
          testata: "Wired Italia",
          note: "Componenti, device e benchmark.",
        },
        {
          nome: "Francesca",
          cognome: "Romano",
          ruolo: "Redattrice",
          servizio: "Pittura",
          telefono: "+39 320 778 0451",
          email: "f.romano@artnews.it",
          testata: "Art News",
          note: "Artisti emergenti e critica.",
        },
        {
          nome: "Andrea",
          cognome: "Lombardi",
          ruolo: "Inviato",
          servizio: "Zootecnica e Allevamento",
          telefono: "+39 349 660 1308",
          email: "a.lombardi@avvenire.it",
          testata: "Avvenire",
          note: "Filiera animale e sostenibilità.",
        },
        {
          nome: "Chiara",
          cognome: "Greco",
          ruolo: "Redattrice",
          servizio: "Archeologia",
          telefono: "+39 339 114 2290",
          email: "c.greco@ansa.it",
          testata: "ANSA",
          note: "",
        },
        {
          nome: "Matteo",
          cognome: "Esposito",
          ruolo: "Redattore",
          servizio: "Information Technology",
          telefono: "+39 333 990 8172",
          email: "m.esposito@ilsole24ore.com",
          testata: "Il Sole 24 Ore",
          note: "Digitalizzazione e infrastrutture.",
        },
        {
          nome: "Valentina",
          cognome: "Costamagnadelgado",
          ruolo: "Collaboratrice",
          servizio: "Cultura",
          telefono: "+39 346 550 2011",
          email: "v.costa@ilgiornale.it",
          testata: "Il Giornale",
          note: "Rubrica settimanale.",
        },
        {
          nome: "Stefano",
          cognome: "Moretti",
          ruolo: "Redattore",
          servizio: "Reti informatiche",
          telefono: "+39 334 880 1120",
          email: "s.moretti@tomshw.it",
          testata: "Tom's Hardware",
          note: "Connettività e infrastrutture.",
        },
        {
          nome: "Marta María",
          cognome: "Romero Rodríguez de Mondelo",
          ruolo: "Redattrice",
          servizio: "Letteratura",
          telefono: "+39 333 470 9981",
          email: "a.demonelo@ilmanifesto.it",
          testata: "il manifesto",
          note: "Interviste e approfondimenti.",
        },
        {
          nome: "Riccardo",
          cognome: "Villa",
          ruolo: "Redattore",
          servizio: "Web design",
          telefono: "+39 339 771 6401",
          email: "r.villa@corriere.it",
          testata: "Corriere della Sera",
          note: "UX e tendenze.",
        },
        {
          nome: "Federica",
          cognome: "Serra",
          ruolo: "Inviata",
          servizio: "Vini ed Enologia",
          telefono: "+39 345 203 7788",
          email: "f.serra@gamberorosso.it",
          testata: "Gambero Rosso",
          note: "Degustazioni e cantine.",
        },
        {
          nome: "Alessio",
          cognome: "Orlando",
          ruolo: "Redattore",
          servizio: "Progettazione siti web",
          telefono: "+39 331 420 9090",
          email: "a.orlando@wired.it",
          testata: "Wired Italia",
          note: "Prodotti web e piattaforme.",
        },
        {
          nome: "Irene",
          cognome: "Pellegrini",
          ruolo: "Redattrice",
          servizio: "Musei e beni culturali",
          telefono: "+39 333 881 3002",
          email: "i.pellegrini@arte.it",
          testata: "Arte.it",
          note: "Patrimonio e governance museale.",
        },
        {
          nome: "Giorgio",
          cognome: "Fontana",
          ruolo: "Redattore",
          servizio: "Giochi e videogame",
          telefono: "+39 347 118 5512",
          email: "g.fontana@ilpost.it",
          testata: "Il Post",
          note: "Recensioni e anteprime.",
        },
        {
          nome: "Silvia",
          cognome: "Giordano",
          ruolo: "Collaboratrice",
          servizio: "Arte Contemporanea",
          telefono: "+39 320 100 7783",
          email: "s.giordano@exibart.com",
          testata: "Exibart",
          note: "Mostre e artisti contemporanei.",
        },
        {
          nome: "Pietro",
          cognome: "Neri",
          ruolo: "Redattore",
          servizio: "Computer grafica 3D",
          telefono: "+39 333 242 9901",
          email: "p.neri@everyeye.it",
          testata: "Everyeye",
          note: "Tool e pipeline 3D.",
        },
        {
          nome: "Laura",
          cognome: "Sanna",
          ruolo: "Redattrice",
          servizio: "Libri per bambini",
          telefono: "+39 346 222 1507",
          email: "l.sanna@sololibri.net",
          testata: "SoloLibri",
          note: "Sezione ragazzi.",
        },
        {
          nome: "Enrico",
          cognome: "Gatti",
          ruolo: "Redattore",
          servizio: "Sicurezza dei sistemi",
          telefono: "+39 339 605 1122",
          email: "e.gatti@dday.it",
          testata: "DDay",
          note: "Protezione di sistemi e endpoint.",
        },
        {
          nome: "Claudia",
          cognome: "Mancini",
          ruolo: "Redattrice",
          servizio: "Restauro",
          telefono: "+39 334 110 0099",
          email: "c.mancini@ilsole24ore.com",
          testata: "Il Sole 24 Ore",
          note: "Interventi e cantieri.",
        },
        {
          nome: "Nicola",
          cognome: "Leone",
          ruolo: "Inviato",
          servizio: "Veterinaria",
          telefono: "+39 331 700 4410",
          email: "n.leone@ansa.it",
          testata: "ANSA",
          note: "Sanità animale e ricerca.",
        },
        {
          nome: "Beatrice",
          cognome: "Martini",
          ruolo: "Redattrice",
          servizio: "Sicurezza delle informazioni",
          telefono: "+39 333 221 9876",
          email: "b.martini@wired.it",
          testata: "Wired Italia",
          note: "Threat intel e sicurezza per il pubblico generalista.",
        },
        {
          nome: "Edoardo",
          cognome: "Sala",
          ruolo: "Redattore",
          servizio: "Home entertainment per PC",
          telefono: "+39 334 410 9900",
          email: "e.sala@tomshw.it",
          testata: "Tom's Hardware",
          testate: [
            "Tom's Hardware",
            "Il Sole 24 Ore — Tecnologia, Imprese e Innovazione",
            "Corriere della Sera — Scienza, Tecnologia e Digitale",
            "La Repubblica — Economia, Startup e Innovazione Digitale",
            "Wired Italia — Cultura Digitale e Tecnologia",
            "DDay — Audio, Video, Hi‑Fi e Home Theater",
          ],
          note: "Multimedia e streaming.",
        },
        {
          nome: "Camilla",
          cognome: "Rossi",
          ruolo: "Redattrice",
          servizio: "Mercato d'arte e aste",
          telefono: "+39 335 702 1101",
          email: "c.rossi@artribune.com",
          testata: "Artribune",
          note: "Aste e trend di mercato.",
        },
        {
          nome: "Lorenzo",
          cognome: "Marchetti",
          ruolo: "Inviato",
          servizio: "Viticoltura",
          telefono: "+39 333 410 2030",
          email: "l.marchetti@gamberorosso.it",
          testata: "Gambero Rosso",
          note: "Vendemmia e territorio.",
        },
      ];

      function normalizeRole(value) {
        const v = (value || "").trim();
        const map = {
          Redattrice: "Redattore",
          Collaboratrice: "Collaboratore",
          Inviata: "Inviato",
          Caporedattore: "Capo redattore",
        };
        return map[v] || v;
      }

      for (const j of journalists) {
        j.ruolo = normalizeRole(j.ruolo);
      }

      {
        const DEMO_TESTATA = "Il Sole 24 Ore";
        let n = 0;
        for (const j of journalists) {
          if (n >= 20) break;
          j.testata = DEMO_TESTATA;
          j.testate = [DEMO_TESTATA];
          n++;
        }
      }

      const normalizeText = (v) => String(v ?? "").trim();

      const makeSecondPhone = (primary) => {
        const s = normalizeText(primary);
        if (!s) return "";
        const m = s.match(/^(.*?)(\d)(\D*)$/);
        if (!m) return `${s} 2`;
        const head = m[1] ?? "";
        const digit = m[2] ?? "0";
        const tail = m[3] ?? "";
        const next = (Number(digit) + 1) % 10;
        return `${head}${next}${tail}`;
      };

      const makeSecondEmail = (primary) => {
        const s = normalizeText(primary);
        if (!s || !s.includes("@")) return "";
        const [local, domain] = s.split("@");
        const baseLocal = String(local || "").trim();
        const baseDomain = String(domain || "").trim();
        if (!baseLocal || !baseDomain) return "";
        const suffix = baseLocal.includes("+") ? "ufficio" : "redazione";
        return `${baseLocal}+${suffix}@${baseDomain}`;
      };

      const ensureProgramContacts = (j) => {
        const legacyPhone = normalizeText(j?.telefono);
        const legacyEmail = normalizeText(j?.email);

        if (!Array.isArray(j.programPhones) || j.programPhones.length < 2) {
          const first = legacyPhone;
          let second = makeSecondPhone(first);
          if (!second || second === first) second = `${first} 2`;
          j.programPhones = [
            { number: first, type: "cellulare", isPrimary: true },
            { number: second, type: "cellulare ufficio", isPrimary: false },
          ].filter((x) => normalizeText(x?.number).length > 0);
        }

        if (!Array.isArray(j.programEmails) || j.programEmails.length < 2) {
          const first = legacyEmail;
          let second = makeSecondEmail(first);
          if (!second || second === first) second = `${first}`;
          j.programEmails = [
            { email: first, type: "mail diretta", isDefault: true },
            { email: second, type: "mail redazione", isDefault: false },
          ].filter((x) => normalizeText(x?.email).length > 0);
        }

        const isValidPreferred = (kind, pref) => {
          if (!pref || typeof pref !== "object") return false;
          const origin = String(pref.origin || "")
            .trim()
            .toLowerCase();
          const index = Number(pref.index);
          if (!Number.isFinite(index) || index < 0) return false;

          if (origin === "program") {
            const items = kind === "phone" ? j.programPhones : j.programEmails;
            return Array.isArray(items) && index < items.length;
          }

          if (origin === "custom") {
            const items = kind === "phone" ? j.customPhones : j.customEmails;
            return Array.isArray(items) && index < items.length;
          }

          return false;
        };

        if (!isValidPreferred("phone", j.preferredPhone)) {
          j.preferredPhone = { origin: "program", index: 0 };
        }
        if (!isValidPreferred("email", j.preferredEmail)) {
          j.preferredEmail = { origin: "program", index: 0 };
        }
      };

      for (const j of journalists) {
        ensureProgramContacts(j);
      }

      function normalizeTestataKey(value) {
        return String(value || "")
          .trim()
          .toLowerCase()
          .replace(/\s+/g, " ");
      }

      function inferTestataArgomento(nome) {
        const n = String(nome || "")
          .trim()
          .toLowerCase();

        if (n.includes("wired"))
          return "specializzata — tecnologia e cultura digitale";
        if (n.includes("sole 24")) return "specializzata — economia e diritto";
        if (n.includes("domus")) return "specializzata — architettura e design";
        if (n.includes("gambero")) return "specializzata — enogastronomia";
        if (n.includes("tom")) return "specializzata — tecnologia";
        if (n.includes("dday")) return "specializzata — tecnologia";
        if (n.includes("national geographic"))
          return "specializzata — scienza, natura e viaggi";
        if (
          n.includes("art ") ||
          n.startsWith("art") ||
          n.includes("arte") ||
          n.includes("artribune") ||
          n.includes("exibart") ||
          n.includes("interni")
        )
          return "specializzata — arte, cultura e design";
        if (n.includes("everyeye"))
          return "specializzata — videogame e intrattenimento";
        if (n.includes("cibo")) return "specializzata — food";
        if (n.includes("sololibri")) return "specializzata — libri";

        return "generalista";
      }

      function inferTestataArgomentoFromServiceCounts(counts) {
        if (!counts || typeof counts !== "object") {
          return { argomento: "Generalista", specializzata: false };
        }

        const entries = Object.entries(counts)
          .map(([k, v]) => [String(k || "").trim(), Number(v || 0)])
          .filter(([k, v]) => k && Number.isFinite(v) && v > 0);

        if (entries.length === 0) {
          return { argomento: "Generalista", specializzata: false };
        }

        entries.sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0], "it"));

        const total = entries.reduce((acc, x) => acc + x[1], 0);
        const top = entries[0];
        const topService = top[0];
        const topCount = top[1];
        const share = total > 0 ? topCount / total : 0;

        const specializzata =
          entries.length === 1 || (topCount >= 2 && share >= 0.6);

        return {
          argomento: specializzata ? topService : "Generalista",
          specializzata,
        };
      }

      function inferMediaType(nome) {
        const n = String(nome || "")
          .trim()
          .toLowerCase();

        const isRadio =
          n.includes("radio") ||
          n.includes("rds") ||
          n.includes("rtl") ||
          n.includes("radio 24") ||
          n.includes("deejay") ||
          n.includes("kiss kiss");

        if (isRadio) {
          return { parent: "Radio", child: "Trasmissioni Radio" };
        }

        const isTv =
          n.includes("tv") ||
          n.includes("rai") ||
          n.includes("mediaset") ||
          n.includes("sky") ||
          n.includes("tg") ||
          n.includes("canale");

        if (isTv) {
          return { parent: "TV", child: "Programmi TV" };
        }

        const isNewspaper =
          n.includes("corriere") ||
          n.includes("repubblica") ||
          n.includes("stampa") ||
          n.includes("giornale") ||
          n.includes("avvenire") ||
          n.includes("manifesto") ||
          n.includes("fatto") ||
          n.includes("il giorno");

        if (isNewspaper) {
          return { parent: "Carta Stampata", child: "Quotidiani" };
        }

        const isMagazine =
          n.includes("wired") ||
          n.includes("gambero") ||
          n.includes("national geographic") ||
          n.includes("interni") ||
          n.includes("domus") ||
          n.includes("art news");

        if (isMagazine) {
          return { parent: "Carta Stampata", child: "Periodici al Pubblico" };
        }

        const isBlog = n.includes("blog");
        if (isBlog) {
          return { parent: "Web", child: "Blog" };
        }

        return { parent: "Web", child: "On-Line / News" };
      }

      function inferPublicationFrequency(mediaType) {
        const parent = mediaType?.parent;
        const child = mediaType?.child;
        if (parent === "Carta Stampata" && child === "Quotidiani") {
          return "Quotidiano";
        }
        if (
          parent === "Carta Stampata" &&
          (child === "Periodici al Pubblico" ||
            child === "Periodici di Categoria" ||
            child === "Supplementi")
        ) {
          return "Mensile";
        }
        if (parent === "Radio") {
          return "Quotidiano";
        }
        if (parent === "TV") {
          return "Quotidiano";
        }
        if (parent === "Web") {
          return "Quotidiano";
        }
        return "Aperiodico";
      }

      function inferDiffusione(nome, mediaType) {
        const n = String(nome || "")
          .trim()
          .toLowerCase();
        if (n.includes("national geographic") || n.includes("wired")) {
          return "Internazionale";
        }
        if (mediaType?.parent === "Web") return "Nazionale";
        return "Locale";
      }

      function inferTiratura(mediaType) {
        if (
          mediaType?.parent === "Carta Stampata" &&
          mediaType?.child === "Quotidiani"
        ) {
          return "100k+";
        }

        if (mediaType?.parent === "Carta Stampata") {
          const child = String(mediaType?.child || "");
          if (
            child === "Periodici al Pubblico" ||
            child === "Periodici di Categoria" ||
            child === "Supplementi"
          ) {
            return "20k+";
          }
        }
        return "n/d";
      }

      function inferCircolazione(mediaType) {
        if (mediaType?.parent === "Web") return "online";
        if (mediaType?.parent === "Carta Stampata")
          return "edicola + abbonamenti";
        if (mediaType?.parent === "Radio") return "FM/DAB + streaming";
        if (mediaType?.parent === "TV") return "digitale terrestre/satellite";
        return "n/d";
      }

      function inferEditore(nome) {
        const EDITORI = [
          "GEDI",
          "RCS MediaGroup",
          "Il Sole 24 Ore",
          "Mondadori",
          "Cairo Communication",
          "Gruppo Editoriale",
        ];
        const seed = hashStringToUint(`editore:${String(nome || "").trim()}`);
        return EDITORI[seed % EDITORI.length] || "n/d";
      }

      function inferDatiPubblicitari(nome, mediaType) {
        const parent = String(mediaType?.parent || "").trim();
        const seed = hashStringToUint(
          `dati-pub:${parent}:${String(nome || "").trim()}`,
        );
        const hasKit = seed % 3 !== 0;
        if (!hasKit) return "n/d";
        if (parent === "Web") return "media kit + form online";
        if (parent === "Carta Stampata") return "listino + formati + chiusure";
        if (parent === "TV") return "listino spot + planning";
        if (parent === "Radio") return "listino spot + contatti";
        return "media kit disponibile";
      }

      function inferRedazioneIndirizzo(nome) {
        const n = String(nome || "")
          .trim()
          .toLowerCase();
        if (n.includes("milano")) return "Milano";
        if (n.includes("roma")) return "Roma";
        if (n.includes("torino")) return "Torino";
        return "Milano";
      }

      function inferRedazioneTel(nome) {
        const city = inferRedazioneIndirizzo(nome);
        if (city === "Roma") return "06 3423123";
        if (city === "Torino") return "011 3423123";
        return "02 3423123";
      }

      function buildTestateFromJournalists(list) {
        const byKey = new Map();

        for (const j of list || []) {
          const testateList = getJournalistTestate(j);
          if (!testateList.length) continue;

          for (const raw of testateList) {
            const key = normalizeTestataKey(raw);
            if (!key) continue;

            if (!byKey.has(key)) {
              const nome = raw || key;
              const mediaType = inferMediaType(nome);
              const city = inferRedazioneIndirizzo(nome);
              const journalistEmail = String(j?.email || "").trim();
              const domain = journalistEmail.includes("@")
                ? journalistEmail.split("@")[1]
                : "example.it";

              byKey.set(key, {
                id: key,
                nome,
                argomento: "Generalista",
                direttore: "Direttore responsabile",
                editore: inferEditore(nome),
                tipoMedia: mediaType,
                frequenzaPubblicazione: inferPublicationFrequency(mediaType),
                diffusione: inferDiffusione(nome, mediaType),
                tiratura: inferTiratura(mediaType),
                datiPubblicitari: inferDatiPubblicitari(nome, mediaType),
                _serviceCounts: {},
                redazione: {
                  giornalisti: [],
                  indirizzo: `${city} — sede redazione`,
                  telRedazione: inferRedazioneTel(nome),
                },
                email: `redazione@${domain}`,
                telefono:
                  String(j?.telefono || "").trim() || "+39 02 0000 0000",
                note: "",
              });
            }

            const t = byKey.get(key);
            const jid = String(j?.email || "").trim();
            if (jid && !t.redazione.giornalisti.includes(jid)) {
              t.redazione.giornalisti.push(jid);
            }

            const servizio = String(j?.servizio || "").trim();
            if (servizio) {
              const sc = t._serviceCounts || (t._serviceCounts = {});
              sc[servizio] = (Number(sc[servizio] || 0) || 0) + 1;
            }
          }
        }

        const NOTES_BY_TESTATA_KEY = {
          "il sole 24 ore": [
            "Redazione con focus su economia, imprese e innovazione.",
            "Disponibile per interviste su dossier PA, infrastrutture e transizione digitale.",
          ],
          "corriere della sera":
            "Contatti preferiti via e-mail; segue speciali e inserti tematici su cultura e società.",
          ansa: [
            "Preferenza per comunicati sintetici e dati verificabili.",
            "Copertura nazionale con desk dedicati (cronaca, politica, economia, esteri).",
          ],
          "wired italia":
            "Taglio digitale: tecnologia, cultura, startup e impatto sociale.",
          "gambero rosso": [
            "Specializzata food & wine: degustazioni, guide e inchieste di filiera.",
            "Per eventi: inviare invito con almeno 10 giorni di anticipo.",
          ],
          "il post":
            "Predilige pitch brevi con contesto e link a fonti primarie.",
          "la repubblica":
            "Valuta proposte di approfondimento; attenzione a temi di attualità e territorio.",
        };

        for (const t of byKey.values()) {
          const inferred = inferTestataArgomentoFromServiceCounts(
            t._serviceCounts,
          );
          t.argomento = inferred.argomento;
          t.note = NOTES_BY_TESTATA_KEY[String(t?.id || "")] || "";
          delete t._serviceCounts;
        }

        return Array.from(byKey.values()).sort((a, b) =>
          String(a.nome || "").localeCompare(String(b.nome || ""), "it", {
            sensitivity: "base",
          }),
        );
      }

      function hashStringToUint(str) {
        let h = 2166136261;
        const s = String(str || "");
        for (let i = 0; i < s.length; i++) {
          h ^= s.charCodeAt(i);
          h = Math.imul(h, 16777619) >>> 0;
        }
        return h >>> 0;
      }

      function pickSomeUnique(items, count, seedStr) {
        const arr = Array.isArray(items) ? [...items] : [];
        if (count <= 0 || arr.length === 0) return [];
        let seed = hashStringToUint(seedStr);
        for (let i = arr.length - 1; i > 0; i--) {
          seed = (Math.imul(seed, 1103515245) + 12345) >>> 0;
          const j = seed % (i + 1);
          const tmp = arr[i];
          arr[i] = arr[j];
          arr[j] = tmp;
        }
        return arr.slice(0, Math.min(count, arr.length));
      }

      function buildRedazioniCentraliFromTestate(testate) {
        const CITY_META = {
          Milano: {
            address: "Via Dante, 12 - 20121 Milano",
            phone: "02 123456",
          },
          Roma: {
            address: "Via Roma, 1 - 00100 Roma",
            phone: "06 123456",
          },
          Torino: {
            address: "Corso Francia, 10 - 10138 Torino",
            phone: "011 123456",
          },
        };

        const TOPICS = [
          "sport",
          "economia",
          "cronaca",
          "politica",
          "cultura",
          "tecnologia",
        ];

        const LOCALI = [
          "bologna",
          "napoli",
          "firenze",
          "genova",
          "palermo",
          "bari",
        ];

        const ESTERE = [
          "londra",
          "new york",
          "mosca",
          "pechino",
          "tokyo",
          "parigi",
        ];

        const CITY_ADDRESSES = {
          londra: "10 Downing Street, London",
          "new york": "350 5th Ave, New York",
          mosca: "ul. Tverskaya, Mosca",
          pechino: "Chang'an Ave, Pechino",
          tokyo: "Chiyoda, Tokyo",
          parigi: "10 Rue de Rivoli, Paris",
          bologna: "Via Indipendenza, 1 - Bologna",
          napoli: "Via Toledo, 10 - Napoli",
          firenze: "Via dei Calzaiuoli, 5 - Firenze",
          genova: "Via XX Settembre, 20 - Genova",
          palermo: "Via Maqueda, 12 - Palermo",
          bari: "Corso Vittorio Emanuele, 9 - Bari",
        };

        const byId = new Map();

        for (const t of testate || []) {
          const city = inferRedazioneIndirizzo(t?.nome);
          const id = `rc-${normalizeTestataKey(city)}`;
          const email = String(t?.email || "").trim();
          const domain = email.includes("@")
            ? email.split("@")[1]
            : "email.com";
          const meta = CITY_META[city] || {
            address: `${city} — sede redazione centrale`,
            phone: inferRedazioneTel(city),
          };

          if (!byId.has(id)) {
            const topicCount = 3 + (hashStringToUint(id) % 3);
            const topics = pickSomeUnique(
              TOPICS,
              topicCount,
              `${id}:topics`,
            ).map((name) => {
              const topicPhone =
                city === "Roma"
                  ? "06 123457"
                  : city === "Torino"
                    ? "011 123457"
                    : "02 123457";
              return {
                id: `${id}:topic:${normalizeTestataKey(name)}`,
                nome: name,
                email: `${normalizeTestataKey(name)}@${domain}`,
                telefono: topicPhone,
              };
            });

            const localCount = hashStringToUint(`${id}:locali`) % 4;
            const locali = pickSomeUnique(
              LOCALI,
              localCount,
              `${id}:locali`,
            ).map((citta) => ({
              id: `${id}:local:${normalizeTestataKey(citta)}`,
              citta,
              indirizzo:
                CITY_ADDRESSES[normalizeTestataKey(citta)] ||
                `${citta} — sede locale`,
              email: `${normalizeTestataKey(citta)}@${domain}`,
              telefono: meta.phone,
            }));

            const estereCount = 2 + (hashStringToUint(`${id}:estere`) % 4);
            const estere = pickSomeUnique(
              ESTERE,
              estereCount,
              `${id}:estere`,
            ).map((citta) => ({
              id: `${id}:estera:${normalizeTestataKey(citta)}`,
              citta,
              indirizzo:
                CITY_ADDRESSES[normalizeTestataKey(citta)] ||
                `${citta} — sede estera`,
              email: `${normalizeTestataKey(citta)}@${domain}`,
              telefono:
                citta === "londra" ? "+44 20 7946 0958" : "+1 212 555 0100",
            }));

            byId.set(id, {
              id,
              nome: "redazione centrale",
              sede: city,
              indirizzo: meta.address,
              email: `redazione.centrale@${domain}`,
              telefono: meta.phone,
              argomenti: topics,
              locali,
              estere,
            });
          }

          if (t) {
            t.redazioneCentraleId = id;
          }
        }

        return Array.from(byId.values()).sort((a, b) =>
          String(a.sede || "").localeCompare(String(b.sede || ""), "it", {
            sensitivity: "base",
          }),
        );
      }

      const __generated =
        typeof window !== "undefined" &&
        window.__PROTO_DATA__ &&
        typeof window.__PROTO_DATA__ === "object"
          ? window.__PROTO_DATA__
          : null;

      let __subjectsIndex = null;
      let __staffPositionsIndex = null;
      let __mediaTypesIndex = null;
      let __frequenciesIndex = null;
      let __coveragesIndex = null;

      function __parseIdFromPrefixed(value, prefix) {
        const v = String(value || "").trim();
        if (!v.startsWith(prefix)) return null;
        const raw = v.slice(prefix.length);
        const n = Number(raw);
        if (!Number.isFinite(n)) return null;
        return n;
      }

      async function __loadJsonArray(url) {
        try {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) {
            console.warn("filters-data fetch not ok", {
              url,
              status: res.status,
            });
            return null;
          }
          const parsed = await res.json();
          if (!Array.isArray(parsed)) {
            console.warn("filters-data json not array", {
              url,
              type: typeof parsed,
            });
            return null;
          }
          return parsed;
        } catch (e) {
          console.warn("filters-data fetch failed", { url, error: String(e) });
          return null;
        }
      }

      function __normalizeDictKey(value) {
        return String(value || "")
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "");
      }

      function __canonicalizeFromIndex(raw, valueByNorm) {
        const v = String(raw || "").trim();
        if (!v) return v;
        const key = __normalizeDictKey(v);
        const direct = valueByNorm?.get(key);
        if (direct) return direct;

        // Fallback fuzzy match: pick the closest canonical value where keys are substring-related.
        let best = "";
        let bestScore = Number.POSITIVE_INFINITY;
        for (const [k, canon] of valueByNorm?.entries?.() || []) {
          if (!k || !canon) continue;
          if (!(k.includes(key) || key.includes(k))) continue;
          const score = Math.abs(k.length - key.length);
          if (score < bestScore) {
            best = canon;
            bestScore = score;
          }
        }
        return best || v;
      }

      function __buildSubjectsIndex(items) {
        const byId = new Map();
        const parents = [];
        const parentIdToLabel = new Map();
        const childrenByParent = {};
        const synonymsByValue = {};

        const normalizeSyn = (v) =>
          String(v || "")
            .trim()
            .replace(/\s+/g, " ");

        const generateVariants = (value) => {
          const v = normalizeSyn(value);
          if (!v) return [];

          const out = [];

          const noParens = v
            .replace(/\([^)]*\)/g, " ")
            .replace(/\s+/g, " ")
            .trim();
          if (noParens && noParens !== v) out.push(noParens);

          const delims = noParens
            .split(/[\/,;:+\-–—]+/g)
            .map((x) => normalizeSyn(x))
            .filter(Boolean);
          for (const p of delims) {
            if (p && p !== v && p !== noParens) out.push(p);
          }

          const spaced = noParens
            .replace(/[’']/g, " ")
            .replace(/[^\p{L}\p{N}]+/gu, " ")
            .replace(/\s+/g, " ")
            .trim();
          if (spaced && spaced !== v && spaced !== noParens) out.push(spaced);

          const uniq = [];
          const seen = new Set();
          for (const x of out) {
            const k = x.toLowerCase();
            if (!k) continue;
            if (seen.has(k)) continue;
            seen.add(k);
            uniq.push(x);
          }
          return uniq;
        };

        for (const it of items || []) {
          const id = Number(it?.id);
          if (!Number.isFinite(id)) continue;
          const value = String(it?.value || "").trim();
          if (!value) continue;
          const parentId =
            it?.parent_id === null || it?.parent_id === undefined
              ? null
              : Number(it.parent_id);
          const synonyms = Array.isArray(it?.synonyms)
            ? it.synonyms.map((x) => String(x || "").trim()).filter(Boolean)
            : [];
          byId.set(id, { id, parentId, value, synonyms });
        }

        for (const it of byId.values()) {
          if (it.parentId === null) {
            parents.push(it.value);
            parentIdToLabel.set(it.id, it.value);
            if (!childrenByParent[it.value]) childrenByParent[it.value] = [];
          }
        }

        for (const it of byId.values()) {
          if (it.parentId === null) continue;
          const pLabel = parentIdToLabel.get(it.parentId);
          if (!pLabel) continue;
          if (!childrenByParent[pLabel]) childrenByParent[pLabel] = [];
          childrenByParent[pLabel].push(it.value);

          const baseSyns = Array.isArray(it.synonyms)
            ? it.synonyms.map((x) => normalizeSyn(x)).filter(Boolean)
            : [];

          const syns = [];
          const seen = new Set();

          const pushSyn = (s) => {
            const v = normalizeSyn(s);
            if (!v) return;
            const k = v.toLowerCase();
            if (seen.has(k)) return;
            seen.add(k);
            syns.push(v);
          };

          if (baseSyns.length) {
            for (const s of baseSyns) pushSyn(s);
          }

          pushSyn(it.value);
          const vars = generateVariants(it.value);
          for (const v of vars.slice(0, 2)) pushSyn(v);

          if (syns.length) synonymsByValue[it.value] = syns;
        }

        parents.sort((a, b) =>
          a.localeCompare(b, "it", { sensitivity: "base" }),
        );
        for (const p of Object.keys(childrenByParent)) {
          childrenByParent[p].sort((a, b) =>
            a.localeCompare(b, "it", { sensitivity: "base" }),
          );
        }

        return { byId, parents, childrenByParent, synonymsByValue };
      }

      function __buildStaffPositionsIndex(items) {
        const byId = new Map();
        const priorityByValue = new Map();
        for (const it of items || []) {
          const id = Number(it?.id);
          if (!Number.isFinite(id)) continue;
          const value = String(it?.value || "").trim();
          if (!value) continue;
          const priority = Number(it?.priority);
          byId.set(id, {
            id,
            value,
            priority: Number.isFinite(priority) ? priority : 9999,
          });
          if (!priorityByValue.has(value)) {
            priorityByValue.set(
              value,
              Number.isFinite(priority) ? priority : 9999,
            );
          }
        }
        return { byId, priorityByValue };
      }

      function __buildMediaTypesIndex(items) {
        const byId = new Map();
        const parents = [];
        const parentIdToLabel = new Map();
        const childrenByParent = {};
        const valueByNorm = new Map();

        for (const it of items || []) {
          const id = Number(it?.id);
          if (!Number.isFinite(id)) continue;
          const value = String(it?.value || "").trim();
          if (!value) continue;
          const parentId =
            it?.parent_id === null || it?.parent_id === undefined
              ? null
              : Number(it.parent_id);
          byId.set(id, { id, value, parentId });
          valueByNorm.set(__normalizeDictKey(value), value);
        }

        for (const it of byId.values()) {
          if (it.parentId === null || it.parentId === it.id) {
            parents.push(it.value);
            parentIdToLabel.set(it.id, it.value);
            if (!childrenByParent[it.value]) childrenByParent[it.value] = [];
          }
        }

        for (const it of byId.values()) {
          if (it.parentId === null || it.parentId === it.id) continue;
          const pLabel = parentIdToLabel.get(it.parentId);
          if (!pLabel) continue;
          if (!childrenByParent[pLabel]) childrenByParent[pLabel] = [];
          childrenByParent[pLabel].push(it.value);
        }

        parents.sort((a, b) =>
          a.localeCompare(b, "it", { sensitivity: "base" }),
        );
        for (const p of Object.keys(childrenByParent)) {
          childrenByParent[p].sort((a, b) =>
            a.localeCompare(b, "it", { sensitivity: "base" }),
          );
        }

        return { parents, childrenByParent, valueByNorm };
      }

      function __buildSimpleValueIndex(items) {
        const values = [];
        const valueByNorm = new Map();
        for (const it of items || []) {
          const value = String(it?.value || "").trim();
          if (!value) continue;
          values.push(value);
          valueByNorm.set(__normalizeDictKey(value), value);
        }
        return { values, valueByNorm };
      }

      function __applyHumanLabelsToJournalists() {
        if (!__subjectsIndex && !__staffPositionsIndex) return false;
        let changed = false;
        for (const j of journalists || []) {
          const svcId = __parseIdFromPrefixed(j?.servizio, "subject:");
          if (svcId != null && __subjectsIndex?.byId?.has(svcId)) {
            j.servizioRaw = j.servizio;
            j.servizio = __subjectsIndex.byId.get(svcId).value;
            changed = true;
          }
          const spId = __parseIdFromPrefixed(j?.ruolo, "staff_position:");
          if (spId != null && __staffPositionsIndex?.byId?.has(spId)) {
            j.ruoloRaw = j.ruolo;
            j.ruolo = __staffPositionsIndex.byId.get(spId).value;
            changed = true;
          }
        }

        return changed;
      }

      function __applyArgomentoToTestate(testate) {
        if (!Array.isArray(testate) || !testate.length) return;
        const byId = new Map();
        for (const j of journalists || []) {
          const jid = String(getJournalistId(j) || "").trim();
          if (!jid) continue;
          byId.set(jid, j);
        }

        for (const t of testate || []) {
          const jids = Array.isArray(t?.redazione?.giornalisti)
            ? t.redazione.giornalisti
            : [];
          const c = new Map();
          for (const jid of jids) {
            const j = byId.get(String(jid || "").trim());
            if (!j) continue;
            const k = String(j?.servizio || "").trim();
            if (!k) continue;
            c.set(k, (Number(c.get(k) || 0) || 0) + 1);
          }
          let best = "";
          let bestN = 0;
          for (const [k, n] of c.entries()) {
            if (n > bestN) {
              best = k;
              bestN = n;
            }
          }
          if (best) {
            t.argomento = best;
          }
        }
      }

      function __buildOptionToParent(parents, childrenByParent) {
        const m = {};
        for (const p of parents || []) {
          for (const child of childrenByParent?.[p] || []) {
            m[child] = p;
          }
        }
        return m;
      }

      function __applySubjectsToDropdowns(testataDropdown) {
        if (!__subjectsIndex) return;
        const parents = [...(__subjectsIndex.parents || [])];
        const childrenByParent = {
          ...(__subjectsIndex.childrenByParent || {}),
        };

        const EXTRA_PARENT = "Altro";
        if (!parents.includes(EXTRA_PARENT)) parents.push(EXTRA_PARENT);
        if (!childrenByParent[EXTRA_PARENT])
          childrenByParent[EXTRA_PARENT] = [];
        if (!childrenByParent[EXTRA_PARENT].includes("Generalista")) {
          childrenByParent[EXTRA_PARENT].push("Generalista");
        }

        const options = Object.values(childrenByParent).flat();
        const optionToParent = __buildOptionToParent(parents, childrenByParent);

        if (dropdown && typeof dropdown.setOptions === "function") {
          dropdown.parents = parents;
          dropdown.childrenByParent = childrenByParent;
          dropdown.optionToParent = optionToParent;
          dropdown.preserveParentOrder = true;
          dropdown.setOptions(options);
          if (typeof dropdown.setSynonymsByFilter === "function") {
            dropdown.setSynonymsByFilter(__subjectsIndex.synonymsByValue || {});
          }
          dropdown.updateAutocompleteHint("");
        }

        if (
          testataDropdown &&
          typeof testataDropdown.setOptions === "function"
        ) {
          testataDropdown.parents = parents;
          testataDropdown.childrenByParent = childrenByParent;
          testataDropdown.optionToParent = optionToParent;
          testataDropdown.preserveParentOrder = true;
          testataDropdown.setOptions(options);
          if (typeof testataDropdown.setSynonymsByFilter === "function") {
            testataDropdown.setSynonymsByFilter(
              __subjectsIndex.synonymsByValue || {},
            );
          }
          testataDropdown.updateAutocompleteHint("");
        }
      }

      function __applyStaffPositionsToRoleDropdown() {
        if (!__staffPositionsIndex || !roleDropdown) return;
        if (typeof roleDropdown.setOptions !== "function") return;

        const items = Array.from(__staffPositionsIndex.byId.values());
        items.sort(
          (a, b) =>
            (a.priority || 9999) - (b.priority || 9999) ||
            a.value.localeCompare(b.value, "it"),
        );
        const options = items.map((x) => x.value);

        const EXTRA_PARENT = "Altro";
        roleDropdown.parents = [];
        roleDropdown.childrenByParent = {};
        roleDropdown.optionToParent = {};
        roleDropdown.preserveParentOrder = true;
        roleDropdown.setOptions(options);
        roleDropdown.updateAutocompleteHint("");
      }

      async function __initFiltersDataIfAvailable() {
        const needsSubjects = !__subjectsIndex;
        const needsStaff = !__staffPositionsIndex;
        const needsMedia = !__mediaTypesIndex;
        const needsFreq = !__frequenciesIndex;
        const needsCov = !__coveragesIndex;

        if (
          !needsSubjects &&
          !needsStaff &&
          !needsMedia &&
          !needsFreq &&
          !needsCov
        ) {
          __applySubjectsToDropdowns();
          __applyStaffPositionsToRoleDropdown();
          if (typeof __applyTestataMetaDropdownsIfReady === "function") {
            __applyTestataMetaDropdownsIfReady();
          }
          return;
        }

        const [subjectsArr, staffArr, mediaArr, freqArr, covArr] =
          await Promise.all([
            needsSubjects
              ? __loadJsonArray("./filters-data/subjects.json")
              : null,
            needsStaff
              ? __loadJsonArray("./filters-data/staff-positions.json")
              : null,
            needsMedia
              ? __loadJsonArray("./filters-data/media-types.json")
              : null,
            needsFreq
              ? __loadJsonArray("./filters-data/frequencies.json")
              : null,
            needsCov ? __loadJsonArray("./filters-data/coverages.json") : null,
          ]);

        if (needsSubjects && !subjectsArr) {
          console.warn("subjects json not loaded");
        }
        if (needsStaff && !staffArr) {
          console.warn("staff positions json not loaded");
        }

        if (needsSubjects && subjectsArr) {
          try {
            __subjectsIndex = __buildSubjectsIndex(subjectsArr);
          } catch (e) {
            console.warn("subjects index build failed", String(e));
          }
        }
        if (needsStaff && staffArr) {
          try {
            __staffPositionsIndex = __buildStaffPositionsIndex(staffArr);
          } catch (e) {
            console.warn("staff positions index build failed", String(e));
          }
        }

        if (needsMedia && mediaArr) {
          try {
            __mediaTypesIndex = __buildMediaTypesIndex(mediaArr);
          } catch (e) {
            console.warn("media types index build failed", String(e));
          }
        }
        if (needsFreq && freqArr) {
          try {
            __frequenciesIndex = __buildSimpleValueIndex(freqArr);
          } catch (e) {
            console.warn("frequencies index build failed", String(e));
          }
        }
        if (needsCov && covArr) {
          try {
            __coveragesIndex = __buildSimpleValueIndex(covArr);
          } catch (e) {
            console.warn("coverages index build failed", String(e));
          }
        }

        let didMapHumanLabels = false;
        try {
          didMapHumanLabels = __applyHumanLabelsToJournalists();
        } catch (e) {
          console.warn("apply human labels failed", String(e));
        }

        if (Array.isArray(window.__PROTO_DATA__?.testate)) {
          if (typeof __applyArgomentoToTestate === "function") {
            try {
              __applyArgomentoToTestate(window.__PROTO_DATA__.testate);
            } catch (e) {
              console.warn("apply argomento to testate failed", String(e));
            }
          }
          if (typeof __applyTestataMetaLabelsToTestate === "function") {
            try {
              __applyTestataMetaLabelsToTestate(window.__PROTO_DATA__.testate);
            } catch (e) {
              console.warn("apply testata meta labels failed", String(e));
            }
          }
        }

        try {
          __applySubjectsToDropdowns();
        } catch (e) {
          console.warn("apply subjects to dropdowns failed", String(e));
        }
        try {
          __applyStaffPositionsToRoleDropdown();
        } catch (e) {
          console.warn(
            "apply staff positions to role dropdown failed",
            String(e),
          );
        }
        if (typeof __applyTestataMetaDropdownsIfReady === "function") {
          try {
            __applyTestataMetaDropdownsIfReady();
          } catch (e) {
            console.warn("apply testata meta dropdowns failed", String(e));
          }
        }

        if (didMapHumanLabels) {
          lastCardsQueryKey = "";
          lastRenderedMode = "";
          lastRenderedJournalistCount = 0;
          lastRenderedTestateCount = 0;
          visibleJournalistLimit = CARD_PAGE_SIZE;
          visibleTestateLimit = CARD_PAGE_SIZE;
        }

        if (!__subjectsIndex) {
          console.warn("subjects index not available");
        }
        if (!__staffPositionsIndex) {
          console.warn("staff positions index not available");
        }

        let sampleSvc = "";
        let sampleRole = "";
        for (const j of journalists || []) {
          const s = String(j?.servizio || "").trim();
          const r = String(j?.ruolo || "").trim();
          if (!sampleSvc && s.startsWith("subject:")) sampleSvc = s;
          if (!sampleRole && r.startsWith("staff_position:")) sampleRole = r;
          if (sampleSvc && sampleRole) break;
        }
        if (sampleSvc || sampleRole) {
          console.warn("human labels not fully applied", {
            sampleServizio: sampleSvc,
            sampleRuolo: sampleRole,
          });
        }
      }

      if (Array.isArray(__generated?.journalists)) {
        journalists.length = 0;
        for (const j of __generated.journalists) {
          journalists.push(j);
        }

        __initFiltersDataIfAvailable()
          .then(() => {
            if (!__subjectsIndex && !__staffPositionsIndex) {
              const uniq = (arr) => {
                const out = [];
                const seen = new Set();
                for (const x of arr || []) {
                  const v = String(x ?? "").trim();
                  if (!v) continue;
                  const k = v.toLowerCase();
                  if (seen.has(k)) continue;
                  seen.add(k);
                  out.push(v);
                }
                return out;
              };

              const serviceValues = uniq(
                (journalists || []).map((j) =>
                  String(j?.servizio || "").trim(),
                ),
              ).sort((a, b) =>
                a.localeCompare(b, "it", { sensitivity: "base" }),
              );
              const roleValues = uniq(
                (journalists || []).map((j) => String(j?.ruolo || "").trim()),
              ).sort((a, b) =>
                a.localeCompare(b, "it", { sensitivity: "base" }),
              );

              const hasSubjectIds = serviceValues.some((s) =>
                s.startsWith("subject:"),
              );
              const hasStaffPositionIds = roleValues.some((r) =>
                r.startsWith("staff_position:"),
              );

              if (
                hasSubjectIds &&
                dropdown &&
                typeof dropdown.setOptions === "function"
              ) {
                dropdown.parents = [];
                dropdown.childrenByParent = {};
                dropdown.optionToParent = {};
                dropdown.setOptions(serviceValues);
                dropdown.updateAutocompleteHint("");
              }

              if (
                hasStaffPositionIds &&
                roleDropdown &&
                typeof roleDropdown.setOptions === "function"
              ) {
                roleDropdown.parents = [];
                roleDropdown.childrenByParent = {};
                roleDropdown.optionToParent = {};
                roleDropdown.setOptions(roleValues);
                roleDropdown.updateAutocompleteHint("");
              }
            }

            scheduleRender();
          })
          .catch((e) => {
            console.warn("filters-data init failed", String(e));
            scheduleRender();
          });
      }

      let testate = buildTestateFromJournalists(journalists);
      if (Array.isArray(__generated?.testate)) {
        testate = __generated.testate;
      }

      const redazioniCentrali = buildRedazioniCentraliFromTestate(testate);
      const redazioniCentraliById = new Map();
      for (const r of redazioniCentrali || []) {
        const id = String(r?.id || "").trim();
        if (!id) continue;
        redazioniCentraliById.set(id, r);
      }

      testateByKey = new Map();
      for (const t of testate || []) {
        const idKey = String(t?.id || "").trim();
        const nameKey = normalizeTestataKey(String(t?.nome || ""));
        if (idKey) {
          if (!testateByKey.has(idKey)) testateByKey.set(idKey, t);
        }
        if (nameKey) {
          if (!testateByKey.has(nameKey)) testateByKey.set(nameKey, t);
        }
      }

      const testataArgomentoDropdown = new FilterableDropdown(
        "testataArgomentoDropdownInput",
        sampleOptions,
        {
          inputWrapperId: "testataArgomentoDropdownInputWrapper",
          chipContainerId: "testataArgomentoChipContainer",
          autocompleteInlineId: "testataArgomentoAutocompleteInline",
          autocompleteSuffixId: "testataArgomentoAutocompleteSuffix",
          autocompleteTipId: "testataArgomentoAutocompleteTip",
          arrowId: "testataArgomentoDropdownArrow",
          clearId: "testataArgomentoDropdownClearLink",
          listId: "testataArgomentoDropdownList",
          closeLinkId: "testataArgomentoCloseDropdownLink",
          suggestionsId: "testataArgomentoDropdownSuggestions",
          resultsId: "testataArgomentoDropdownResults",
          parents: [
            "ALIMENTARI E BEVANDE",
            "AGRICOLTURA",
            "INFORMATICA E WEB",
            "ARTE E CULTURA",
          ],
          childrenByParent: SERVICES_BY_PARENT,
          renderChipsInInput: false,
          preserveParentOrder: false,
        },
      );
      testataArgomentoDropdown.updateAutocompleteHint("");

      __initFiltersDataIfAvailable()
        .then(() => {
          __applySubjectsToDropdowns(testataArgomentoDropdown);
        })
        .catch((e) => {
          console.warn("filters-data init failed", String(e));
        });

      const TESTATA_MEDIA_BY_PARENT = {
        Radio: ["News / GR", "Trasmissioni Radio"],
        TV: ["Canali Tematici", "News / TG", "Programmi TV"],
        "Carta Stampata": [
          "Quotidiani",
          "Periodici al Pubblico",
          "Periodici di Categoria",
          "Supplementi",
        ],
        Web: ["On-Line / News", "Blog"],
      };

      const testataTipoMediaOptions = Object.values(TESTATA_MEDIA_BY_PARENT)
        .flat()
        .sort((a, b) => a.localeCompare(b, "it", { sensitivity: "base" }));

      const testataTipoMediaDropdown = new FilterableDropdown(
        "testataTipoMediaDropdownInput",
        testataTipoMediaOptions,
        {
          inputWrapperId: "testataTipoMediaDropdownInputWrapper",
          chipContainerId: "testataTipoMediaChipContainer",
          autocompleteInlineId: "testataTipoMediaAutocompleteInline",
          autocompleteSuffixId: "testataTipoMediaAutocompleteSuffix",
          autocompleteTipId: "testataTipoMediaAutocompleteTip",
          arrowId: "testataTipoMediaDropdownArrow",
          clearId: "testataTipoMediaDropdownClearLink",
          listId: "testataTipoMediaDropdownList",
          closeLinkId: "testataTipoMediaCloseDropdownLink",
          suggestionsId: "testataTipoMediaDropdownSuggestions",
          resultsId: "testataTipoMediaDropdownResults",
          parents: ["Radio", "TV", "Carta Stampata", "Web"],
          childrenByParent: TESTATA_MEDIA_BY_PARENT,
          synonymsByFilter: {},
          renderChipsInInput: false,
          preserveParentOrder: true,
        },
      );
      testataTipoMediaDropdown.updateAutocompleteHint("");

      const FREQUENZA_PUBBLICAZIONE_OPTIONS = [
        "Annuale",
        "Aperiodico",
        "Bimestrale",
        "Bisettimanale",
        "Mensile",
        "Quadrimestrale",
        "Quattordicinale",
        "Quindicinale",
        "Quotidiano",
        "Semestrale",
        "Settimanale",
        "Trimestrale",
        "Trisettimanale",
        "Quadriennale",
        "Plurisettimanale",
      ];

      const testataFrequenzaDropdown = new FilterableDropdown(
        "testataFrequenzaDropdownInput",
        FREQUENZA_PUBBLICAZIONE_OPTIONS,
        {
          inputWrapperId: "testataFrequenzaDropdownInputWrapper",
          chipContainerId: "testataFrequenzaChipContainer",
          autocompleteInlineId: "testataFrequenzaAutocompleteInline",
          autocompleteSuffixId: "testataFrequenzaAutocompleteSuffix",
          autocompleteTipId: "testataFrequenzaAutocompleteTip",
          arrowId: "testataFrequenzaDropdownArrow",
          clearId: "testataFrequenzaDropdownClearLink",
          listId: "testataFrequenzaDropdownList",
          closeLinkId: "testataFrequenzaCloseDropdownLink",
          suggestionsId: "testataFrequenzaDropdownSuggestions",
          resultsId: "testataFrequenzaDropdownResults",
          synonymsByFilter: {},
          renderChipsInInput: false,
          sortComparator: (a, b) => {
            const key = (x) =>
              String(x || "")
                .trim()
                .toLowerCase();
            const ra = (() => {
              const k = key(a);
              if (k === "aperiodico" || k === "plurisettimanale") {
                return { indefinite: true, days: Number.POSITIVE_INFINITY };
              }
              const days =
                k === "quotidiano"
                  ? 1
                  : k === "trisettimanale"
                    ? 7 / 3
                    : k === "bisettimanale"
                      ? 7 / 2
                      : k === "settimanale"
                        ? 7
                        : k === "quattordicinale"
                          ? 14
                          : k === "quindicinale"
                            ? 15
                            : k === "mensile"
                              ? 30
                              : k === "bimestrale"
                                ? 60
                                : k === "trimestrale"
                                  ? 90
                                  : k === "quadrimestrale"
                                    ? 120
                                    : k === "semestrale"
                                      ? 182
                                      : k === "annuale"
                                        ? 365
                                        : k === "quadriennale"
                                          ? 365 * 4
                                          : Number.POSITIVE_INFINITY;
              return { indefinite: false, days };
            })();

            const rb = (() => {
              const k = key(b);
              if (k === "aperiodico" || k === "plurisettimanale") {
                return { indefinite: true, days: Number.POSITIVE_INFINITY };
              }
              const days =
                k === "quotidiano"
                  ? 1
                  : k === "trisettimanale"
                    ? 7 / 3
                    : k === "bisettimanale"
                      ? 7 / 2
                      : k === "settimanale"
                        ? 7
                        : k === "quattordicinale"
                          ? 14
                          : k === "quindicinale"
                            ? 15
                            : k === "mensile"
                              ? 30
                              : k === "bimestrale"
                                ? 60
                                : k === "trimestrale"
                                  ? 90
                                  : k === "quadrimestrale"
                                    ? 120
                                    : k === "semestrale"
                                      ? 182
                                      : k === "annuale"
                                        ? 365
                                        : k === "quadriennale"
                                          ? 365 * 4
                                          : Number.POSITIVE_INFINITY;
              return { indefinite: false, days };
            })();

            if (ra.indefinite !== rb.indefinite) {
              return ra.indefinite ? 1 : -1;
            }
            if (ra.days !== rb.days) {
              return ra.days - rb.days;
            }
            return String(a || "").localeCompare(String(b || ""), "it", {
              sensitivity: "base",
            });
          },
        },
      );
      testataFrequenzaDropdown.updateAutocompleteHint("");

      const DIFFUSIONE_OPTIONS = [
        "Internazionale",
        "Nazionale",
        "Regionale",
        "Locale",
      ];

      const testataDiffusioneDropdown = new FilterableDropdown(
        "testataDiffusioneDropdownInput",
        DIFFUSIONE_OPTIONS,
        {
          inputWrapperId: "testataDiffusioneDropdownInputWrapper",
          chipContainerId: "testataDiffusioneChipContainer",
          autocompleteInlineId: "testataDiffusioneAutocompleteInline",
          autocompleteSuffixId: "testataDiffusioneAutocompleteSuffix",
          autocompleteTipId: "testataDiffusioneAutocompleteTip",
          arrowId: "testataDiffusioneDropdownArrow",
          clearId: "testataDiffusioneDropdownClearLink",
          listId: "testataDiffusioneDropdownList",
          closeLinkId: "testataDiffusioneCloseDropdownLink",
          suggestionsId: "testataDiffusioneDropdownSuggestions",
          resultsId: "testataDiffusioneDropdownResults",
          synonymsByFilter: {},
          renderChipsInInput: false,
        },
      );
      testataDiffusioneDropdown.updateAutocompleteHint("");

      __initFiltersDataIfAvailable().catch(() => {});

      const selectedJournalistIds = new Set();
      const selectedJournalistOrder = [];
      let lastRenderedVisibleJournalistIds = [];

      const selectedPanelBody = document.getElementById("selectedPanelBody");
      const selectedClearAll = document.getElementById("selectedClearAll");
      const selectedActionsSplit = document.getElementById(
        "selectedActionsSplit",
      );
      const selectedInListRow = document.getElementById("selectedInListRow");
      const selectedInListCount = document.getElementById(
        "selectedInListCount",
      );
      const selectedRemoveFromListLink = document.getElementById(
        "selectedRemoveFromListLink",
      );

      const saveListModalOverlay = document.getElementById(
        "saveListModalOverlay",
      );
      const saveListModal = document.getElementById("saveListModal");
      const saveListModalTitle = document.getElementById("saveListModalTitle");
      const saveListModalClose = document.getElementById("saveListModalClose");
      const saveListNameLabel = document.getElementById("saveListNameLabel");
      const saveListNameInput = document.getElementById("saveListNameInput");
      const saveListConfirm = document.getElementById("saveListConfirm");
      const saveListError = document.getElementById("saveListError");

      const shareListModalOverlay = document.getElementById(
        "shareListModalOverlay",
      );
      const shareListModal = document.getElementById("shareListModal");
      const shareListModalClose = document.getElementById(
        "shareListModalClose",
      );
      const shareListUsers = document.getElementById("shareListUsers");
      const shareListConfirm = document.getElementById("shareListConfirm");

      const addToListModalOverlay = document.getElementById(
        "addToListModalOverlay",
      );
      const addToListModal = document.getElementById("addToListModal");
      const addToListModalClose = document.getElementById(
        "addToListModalClose",
      );
      const addToListDropdownInput = document.getElementById(
        "addToListDropdownInput",
      );
      const addToListConfirm = document.getElementById("addToListConfirm");
      const addToListError = document.getElementById("addToListError");

      let addToListTargetJids = null;
      let addToShipmentTargetJids = null;

      const addToShipmentModalOverlay = document.getElementById(
        "addToShipmentModalOverlay",
      );
      const addToShipmentModal = document.getElementById("addToShipmentModal");
      const addToShipmentModalClose = document.getElementById(
        "addToShipmentModalClose",
      );
      const addToShipmentDropdownInput = document.getElementById(
        "addToShipmentDropdownInput",
      );
      const addToShipmentConfirm = document.getElementById(
        "addToShipmentConfirm",
      );
      const addToShipmentError = document.getElementById("addToShipmentError");

      const addToNewShipmentModalOverlay = document.getElementById(
        "addToNewShipmentModalOverlay",
      );
      const addToNewShipmentModal = document.getElementById(
        "addToNewShipmentModal",
      );
      const addToNewShipmentModalClose = document.getElementById(
        "addToNewShipmentModalClose",
      );
      const addToNewShipmentNameInput = document.getElementById(
        "addToNewShipmentNameInput",
      );
      const addToNewShipmentConfirm = document.getElementById(
        "addToNewShipmentConfirm",
      );
      const addToNewShipmentError = document.getElementById(
        "addToNewShipmentError",
      );
      const mainTitleEl = document.getElementById("mainTitle");
      const shipmentTitleInput = document.getElementById("shipmentTitleInput");
      const mainTitleIconEl = document.getElementById("mainTitleIcon");
      const mailingListCountPill = document.getElementById(
        "mailingListCountPill",
      );
      const mailingListActions = document.getElementById("mailingListActions");
      const mailingListRenameLink = document.getElementById(
        "mailingListRenameLink",
      );
      const mailingListDuplicateLink = document.getElementById(
        "mailingListDuplicateLink",
      );
      const mailingListExportLink = document.getElementById(
        "mailingListExportLink",
      );
      const mailingListDeleteLink = document.getElementById(
        "mailingListDeleteLink",
      );
      const mailingListSendLink = document.getElementById(
        "mailingListSendLink",
      );
      const mailingListCreatedAtSubtitle = document.getElementById(
        "mailingListCreatedAtSubtitle",
      );
      const dashboardMailingListsEl = document.getElementById(
        "dashboardMailingLists",
      );
      const dashboardMailingListsFilterInput = document.getElementById(
        "dashboardMailingListsFilterInput",
      );
      const dashboardShipmentsEl =
        document.getElementById("dashboardShipments");
      const dashboardShipmentsFilterInput = document.getElementById(
        "dashboardShipmentsFilterInput",
      );
      const dashboardComunicatiEl = document.getElementById(
        "dashboardComunicati",
      );
      const dashboardComunicatiFilterInput = document.getElementById(
        "dashboardComunicatiFilterInput",
      );
      const dashboardMailingListsNewLink = document.getElementById(
        "dashboardMailingListsNewLink",
      );
      const dashboardShipmentsNewLink = document.getElementById(
        "dashboardShipmentsNewLink",
      );
      const dashboardComunicatiNewLink = document.getElementById(
        "dashboardComunicatiNewLink",
      );
      const spedizioniShipmentsEl = document.getElementById(
        "spedizioniShipments",
      );
      const mailingListsMailingListsEl = document.getElementById(
        "mailingListsMailingLists",
      );
      const shipmentRecipientsJournalistsInput = document.getElementById(
        "shipmentRecipientsJournalistsInput",
      );
      const shipmentRecipientsListsInput = document.getElementById(
        "shipmentRecipientsListsInput",
      );
      const shipmentSelectedListsChips = document.getElementById(
        "shipmentSelectedListsChips",
      );
      const shipmentCardsColumn = document.getElementById(
        "shipmentCardsColumn",
      );
      const shipmentRecipientsCountPill = document.getElementById(
        "shipmentRecipientsCountPill",
      );
      const shipmentCardsFilterInput = document.getElementById(
        "shipmentCardsFilterInput",
      );
      const shipmentEmailHeaderColumn = document.getElementById(
        "shipmentEmailHeaderColumn",
      );
      const shipmentAppendComunicatoCheckbox = document.getElementById(
        "shipmentAppendComunicatoCheckbox",
      );
      const shipmentComunicatoPublicLink = document.getElementById(
        "shipmentComunicatoPublicLink",
      );
      const shipmentComunicatoCopyLink = document.getElementById(
        "shipmentComunicatoCopyLink",
      );
      const shipmentEmailSpotlight = document.getElementById(
        "shipmentEmailSpotlight",
      );
      const shipmentEmailSpotlightTop = document.getElementById(
        "shipmentEmailSpotlightTop",
      );
      const shipmentEmailSpotlightLeft = document.getElementById(
        "shipmentEmailSpotlightLeft",
      );
      const shipmentEmailSpotlightRight = document.getElementById(
        "shipmentEmailSpotlightRight",
      );
      const shipmentEmailSpotlightBottom = document.getElementById(
        "shipmentEmailSpotlightBottom",
      );
      const shipmentSelectedComunicatoWrap = document.getElementById(
        "shipmentSelectedComunicatoWrap",
      );
      const shipmentSelectedComunicatoTitle = document.getElementById(
        "shipmentSelectedComunicatoTitle",
      );
      const shipmentSelectedComunicatoText = document.getElementById(
        "shipmentSelectedComunicatoText",
      );
      const shipmentAiSuggestionsLink = document.getElementById(
        "shipmentAiSuggestionsLink",
      );
      const shipmentPressModeSelectRadio = document.getElementById(
        "shipmentPressModeSelect",
      );
      const shipmentPressModeEmailRadio = document.getElementById(
        "shipmentPressModeEmail",
      );
      const shipmentPressSelectWrap = document.getElementById(
        "shipmentPressSelectWrap",
      );
      const shipmentPressSelect = document.getElementById(
        "shipmentPressSelect",
      );
      const shipmentPressOpenLink = document.getElementById(
        "shipmentPressOpenLink",
      );
      const shipmentPressInstructionsWrap = document.getElementById(
        "shipmentPressInstructionsWrap",
      );
      const shipmentPressInstructionsLink = document.getElementById(
        "shipmentPressInstructionsLink",
      );
      const shipmentPressNewLink = document.getElementById(
        "shipmentPressNewLink",
      );

      const shipmentPressEmailModalOverlay = document.getElementById(
        "shipmentPressEmailModalOverlay",
      );
      const shipmentPressEmailModal = document.getElementById(
        "shipmentPressEmailModal",
      );
      const shipmentPressEmailModalClose = document.getElementById(
        "shipmentPressEmailModalClose",
      );
      const shipmentPressEmailCopyLink = document.getElementById(
        "shipmentPressEmailCopyLink",
      );
      const shipmentPressEmailAddress = document.getElementById(
        "shipmentPressEmailAddress",
      );

      let saveListModalMode = "create";
      let saveListModalTargetId = "";
      let activeComunicatoId = "";
      let activeSpedizioneRef = null;
      let isShipmentTitleEditing = false;
      let shipmentTitleBeforeEdit = "";
      let newPressPanelOpenContext = "global";
      let newPressPanelJournalistId = "";
      let isNewPressPanelTitleEditing = false;
      let newPressPanelTitleBeforeEdit = "";
      let isShipmentEmailSpotlightOpen = false;
      let shipmentEmailSpotlightPreviousContext = "global";
      let shipmentEmailSpotlightPreviousJournalistId = "";
      let wasSpedisciListaView = false;
      let shipmentListsDropdownSyncing = false;
      let shipmentSelectedRecipientListIds = new Set();
      let shipmentActiveRecipientListIds = new Set();
      let shipmentJournalistsDropdownSyncing = false;
      let shipmentSelectedRecipientJournalistIds = new Set();
      const shipmentJournalistOptionToId = new Map();
      const shipmentJournalistIdToOption = new Map();
      const shipmentListOrder = new Map();
      let lastShipmentListOptionsKey = "";
      let lastShipmentJournalistOptionsKey = "";
      let lastShipmentJournalistsSourceRef = null;
      let lastShipmentJournalistsSourceLen = -1;

      const textFilterInput = document.getElementById("textFilterInput");
      const textFilterClear = document.getElementById("textFilterClearLink");

      const committedTextTerms = [];

      var testateByKey;

      function getJournalistId(j) {
        return String(j?.id || j?.email || "").trim();
      }

      function getJournalistTestate(j) {
        if (!j) return [];
        if (Array.isArray(j.testate)) {
          return j.testate.map((x) => String(x ?? "").trim()).filter(Boolean);
        }
        if (
          Array.isArray(j.outletIds) &&
          testateByKey &&
          typeof testateByKey.get === "function" &&
          testateByKey.size > 0
        ) {
          const ids = j.outletIds
            .map((x) => String(x ?? "").trim())
            .filter(Boolean);
          const names = ids
            .map((id) => testateByKey?.get?.(id))
            .map((t) => String(t?.nome || "").trim())
            .filter(Boolean);
          if (names.length) return names;
        }
        const s = String(j.testata ?? "").trim();
        return s ? [s] : [];
      }

      function getJournalistNameById(jid) {
        const j = (journalists || []).find((x) => getJournalistId(x) === jid);
        if (!j) return jid;
        return `${j.nome} ${j.cognome}`;
      }

      function getJournalistNamePartsById(jid) {
        const j = (journalists || []).find((x) => getJournalistId(x) === jid);
        if (!j) {
          const full = String(jid || "").trim();
          const parts = full.split(/\s+/).filter(Boolean);
          if (parts.length <= 1) {
            return { full, firstName: "", lastName: full };
          }
          const lastName = parts.pop();
          const firstName = parts.join(" ");
          return { full, firstName, lastName };
        }

        const firstName = String(j?.nome || "").trim();
        const lastName = String(j?.cognome || "").trim();
        const full = `${firstName} ${lastName}`.trim();
        return { full, firstName, lastName };
      }

      let selectedNameLayoutRaf = 0;
      let selectedPanelResizeObserver = null;

      function updateSelectedItemNameLayout(item) {
        if (!item) return;

        const link = item.querySelector(".selected-item-name.journalist-link");
        if (!link) return;

        if (link.clientWidth < 5) return;

        const firstNameEl = item.querySelector(".selected-item-first-name");
        const lastNameEl = item.querySelector(".selected-item-last-name");
        if (!lastNameEl) return;

        item.classList.remove("selected-item--hide-first-name");

        if (!firstNameEl || !String(firstNameEl.textContent || "").trim()) {
          return;
        }

        const lastNameIsTruncated =
          lastNameEl.scrollWidth - lastNameEl.clientWidth > 1;
        if (lastNameIsTruncated) {
          item.classList.add("selected-item--hide-first-name");
        }
      }

      function scheduleUpdateSelectedNameLayouts() {
        if (selectedNameLayoutRaf) return;
        selectedNameLayoutRaf = requestAnimationFrame(() => {
          selectedNameLayoutRaf = 0;
          if (!selectedPanelBody) return;
          for (const item of selectedPanelBody.querySelectorAll(
            ".selected-item",
          )) {
            updateSelectedItemNameLayout(item);
          }
        });
      }

      function ensureSelectedOrder(jid) {
        const idx = selectedJournalistOrder.indexOf(jid);
        if (idx !== -1) selectedJournalistOrder.splice(idx, 1);
        selectedJournalistOrder.unshift(jid);
      }

      function removeFromSelectedOrder(jid) {
        const idx = selectedJournalistOrder.indexOf(jid);
        if (idx !== -1) selectedJournalistOrder.splice(idx, 1);
      }

      function openSaveListModal() {
        if (!saveListModal || !saveListModalOverlay) return;
        if (selectedJournalistOrder.length === 0) return;

        saveListModalMode = "create";
        saveListModalTargetId = "";
        if (saveListModalTitle) saveListModalTitle.textContent = "Salva lista";
        if (saveListConfirm) saveListConfirm.textContent = "salva lista";

        if (saveListNameInput) {
          saveListNameInput.value = "";
          saveListNameInput.focus();
        }
        if (saveListError) {
          saveListError.style.display = "none";
        }

        saveListModalOverlay.classList.add("show");
        saveListModal.classList.add("show");
        saveListModalOverlay.setAttribute("aria-hidden", "false");
        saveListModal.setAttribute("aria-hidden", "false");
      }

      function getComunicatiItems() {
        const comunicati = Array.isArray(appState.comunicati)
          ? appState.comunicati
          : [];
        return comunicati
          .map((x, i) => {
            if (typeof x === "string") {
              const label = String(x || "").trim();
              return label ? { id: label, label } : null;
            }
            if (x && typeof x === "object") {
              const label = String(
                x.title || x.name || x.subject || x.oggetto || "",
              ).trim();
              const id = String(x.id || label || i).trim();
              return label ? { id, label } : null;
            }
            return null;
          })
          .filter(Boolean);
      }

      function getComunicatoLabelById(id) {
        const key = String(id || "").trim();
        if (!key) return "";
        const items = getComunicatiItems();
        const found = items.find((x) => String(x.id || "") === key);
        return String(found?.label || "").trim();
      }

      function getComunicatoIndexById(id) {
        const key = String(id || "").trim();
        if (!key) return -1;
        if (!Array.isArray(appState.comunicati)) return -1;
        for (let i = 0; i < appState.comunicati.length; i++) {
          const item = appState.comunicati[i];
          if (typeof item === "string") {
            if (String(item || "").trim() === key) return i;
            continue;
          }
          if (!item || typeof item !== "object") continue;
          const existingLabel = String(
            item.title || item.name || item.subject || item.oggetto || "",
          ).trim();
          const itemId = String(item.id || existingLabel || i).trim();
          if (itemId === key) return i;
        }
        return -1;
      }

      function ensureComunicatoRecord(id) {
        const key = String(id || "").trim();
        if (!key) return null;
        if (!Array.isArray(appState.comunicati)) {
          appState.comunicati = [];
        }

        const idx = getComunicatoIndexById(key);
        if (idx < 0) return null;

        const current = appState.comunicati[idx];
        if (current && typeof current === "object") {
          const title = String(
            current.title ||
              current.name ||
              current.subject ||
              current.oggetto ||
              "",
          ).trim();
          if (!current.id) {
            current.id = key;
          }
          if (!current.title) {
            current.title =
              title || getComunicatoLabelById(key) || "Nuovo comunicato";
          }
          if (!current.emailHeader || typeof current.emailHeader !== "string") {
            current.emailHeader = String(current.emailHeader || "");
          }
          if (!current.bodyText || typeof current.bodyText !== "string") {
            current.bodyText = String(current.bodyText || "");
          }
          if (
            !current.journalistEmailHeaders ||
            typeof current.journalistEmailHeaders !== "object"
          ) {
            current.journalistEmailHeaders = {};
          }
          return current;
        }

        const label = getComunicatoLabelById(key) || "Nuovo comunicato";
        const normalized = {
          id: key,
          title: label,
          createdAt: Date.now(),
          emailHeader: "",
          bodyText: "",
          journalistEmailHeaders: {},
        };
        appState.comunicati[idx] = normalized;
        return normalized;
      }

      function getComunicatoDisplayEmailHeader(record, journalistId) {
        if (!record || typeof record !== "object") return "";
        const jid = String(journalistId || "").trim();
        if (jid) {
          const byJournalist = record.journalistEmailHeaders;
          if (
            byJournalist &&
            typeof byJournalist === "object" &&
            Object.prototype.hasOwnProperty.call(byJournalist, jid)
          ) {
            return String(byJournalist[jid] || "");
          }
        }
        return String(record.emailHeader || "");
      }

      function renameComunicatoById(targetId, nextName) {
        const safeId = String(targetId || "").trim();
        const rawName = String(nextName || "").trim();
        if (!safeId || !rawName) return false;
        if (!Array.isArray(appState.comunicati)) return false;

        let didRename = false;
        appState.comunicati = appState.comunicati.map((item, i) => {
          if (typeof item === "string") {
            const id = String(item || "").trim();
            if (id !== safeId) return item;
            didRename = true;
            return {
              id: safeId,
              title: rawName,
              createdAt: Date.now(),
              emailHeader: "",
              bodyText: "",
              journalistEmailHeaders: {},
            };
          }
          if (!item || typeof item !== "object") return item;
          const existingLabel = String(
            item.title || item.name || item.subject || item.oggetto || "",
          ).trim();
          const itemId = String(item.id || existingLabel || i).trim();
          if (itemId !== safeId) return item;
          didRename = true;
          return {
            ...item,
            id: String(item.id || safeId),
            title: rawName,
          };
        });
        if (!didRename) return false;

        activeComunicatoId = safeId;
        saveAppState(appState);
        setNewPressPanelTitle(rawName);
        renderShipmentPressOptions();
        renderDashboardComunicati();
        if (shipmentPressSelect) {
          shipmentPressSelect.value = safeId;
        }
        updateShipmentSelectedComunicatoReadonly();
        return true;
      }

      function setNewPressPanelTitle(name) {
        const next = String(name || "").trim() || "Nuovo comunicato";
        if (newPressPanelTitle) {
          newPressPanelTitle.textContent = next;
        }
        if (newPressPanelTitleInput && !isNewPressPanelTitleEditing) {
          newPressPanelTitleInput.value = next;
        }
        if (newPressPanelBodyTitle) {
          newPressPanelBodyTitle.textContent = next;
        }
      }

      function getActiveComunicatoTargetId() {
        const byState = String(activeComunicatoId || "").trim();
        if (byState) return byState;
        const bySelect = String(shipmentPressSelect?.value || "").trim();
        return bySelect;
      }

      function openNewPressPanelTitleInlineEditor() {
        if (!newPressPanelTitle || !newPressPanelTitleInput) return;
        const targetId = getActiveComunicatoTargetId();
        if (!targetId) return;

        const currentName =
          getComunicatoLabelById(targetId) ||
          String(newPressPanelTitle.textContent || "").trim() ||
          "Nuovo comunicato";

        isNewPressPanelTitleEditing = true;
        newPressPanelTitleBeforeEdit = currentName;
        newPressPanelTitle.style.display = "none";
        newPressPanelTitleInput.style.display = "inline-block";
        newPressPanelTitleInput.value = currentName;
        newPressPanelTitleInput.focus();
        try {
          newPressPanelTitleInput.setSelectionRange(
            0,
            String(newPressPanelTitleInput.value || "").length,
          );
        } catch (_) {}
      }

      function closeNewPressPanelTitleInlineEditor({ commit = true } = {}) {
        if (!newPressPanelTitle || !newPressPanelTitleInput) return;
        if (!isNewPressPanelTitleEditing) return;

        const targetId = getActiveComunicatoTargetId();
        const draft = String(newPressPanelTitleInput.value || "").trim();
        const fallbackName =
          newPressPanelTitleBeforeEdit ||
          String(newPressPanelTitle.textContent || "").trim() ||
          "Nuovo comunicato";

        isNewPressPanelTitleEditing = false;
        newPressPanelTitleInput.style.display = "none";
        newPressPanelTitle.style.display = "";

        if (commit && targetId && draft) {
          if (renameComunicatoById(targetId, draft)) return;
        }

        setNewPressPanelTitle(fallbackName);
      }

      function createNewComunicato() {
        if (!Array.isArray(appState.comunicati)) {
          appState.comunicati = [];
        }
        const baseName = "Nuovo comunicato";
        const existingNames = new Set(
          getComunicatiItems().map((x) => String(x.label || "").toLowerCase()),
        );
        let candidate = baseName;
        let n = 2;
        while (existingNames.has(String(candidate || "").toLowerCase())) {
          candidate = `${baseName} ${n}`;
          n += 1;
        }

        const createdId = `comunicato-${Date.now()}-${Math.floor(
          Math.random() * 1_000_000,
        )}`;
        appState.comunicati.unshift({
          id: createdId,
          title: candidate,
          createdAt: Date.now(),
          emailHeader: "",
          bodyText: "",
          journalistEmailHeaders: {},
        });
        activeComunicatoId = createdId;
        saveAppState(appState);
        renderShipmentPressOptions();
        renderDashboardComunicati();
        if (shipmentPressSelect) {
          shipmentPressSelect.value = createdId;
        }
        setNewPressPanelTitle(candidate);
      }

      function openRenameListModal(options = {}) {
        if (!saveListModal || !saveListModalOverlay) return;
        const mode = String(options?.mode || "")
          .trim()
          .toLowerCase();
        if (mode === "comunicato") {
          let targetId = String(activeComunicatoId || "").trim();
          if (!targetId && shipmentPressSelect) {
            targetId = String(shipmentPressSelect.value || "").trim();
          }
          if (!targetId) return;

          const currentName =
            getComunicatoLabelById(targetId) || "Nuovo comunicato";
          saveListModalMode = "rename-comunicato";
          saveListModalTargetId = targetId;

          if (saveListModalTitle) {
            saveListModalTitle.textContent = "Rinomina comunicato";
          }
          if (saveListNameLabel) {
            saveListNameLabel.textContent = "Nome comunicato";
          }
          if (saveListNameInput) {
            saveListNameInput.placeholder = "Nuovo comunicato";
          }
          if (saveListConfirm) {
            saveListConfirm.textContent = "rinomina comunicato";
          }

          if (saveListNameInput) {
            saveListNameInput.value = String(currentName || "");
            saveListNameInput.focus();
            try {
              saveListNameInput.setSelectionRange(
                0,
                String(saveListNameInput.value || "").length,
              );
            } catch (_) {}
          }
          if (saveListError) {
            saveListError.style.display = "none";
          }

          saveListModalOverlay.classList.add("show");
          saveListModal.classList.add("show");
          saveListModalOverlay.setAttribute("aria-hidden", "false");
          saveListModal.setAttribute("aria-hidden", "false");
          return;
        }

        const activeList = getMailingListById(appState.activeMailingListId);
        if (!activeList) return;

        saveListModalMode = "rename";
        saveListModalTargetId = String(activeList.id || "");
        if (saveListModalTitle) {
          saveListModalTitle.textContent = "Rinomina lista";
        }
        if (saveListConfirm) saveListConfirm.textContent = "rinomina lista";

        if (saveListNameInput) {
          saveListNameInput.value = String(activeList.name || "");
          saveListNameInput.focus();
          try {
            saveListNameInput.setSelectionRange(
              0,
              String(saveListNameInput.value || "").length,
            );
          } catch (_) {}
        }
        if (saveListError) {
          saveListError.style.display = "none";
        }

        saveListModalOverlay.classList.add("show");
        saveListModal.classList.add("show");
        saveListModalOverlay.setAttribute("aria-hidden", "false");
        saveListModal.setAttribute("aria-hidden", "false");
      }

      function closeSaveListModal() {
        if (!saveListModal || !saveListModalOverlay) return;
        saveListModalOverlay.classList.remove("show");
        saveListModal.classList.remove("show");
        saveListModalOverlay.setAttribute("aria-hidden", "true");
        saveListModal.setAttribute("aria-hidden", "true");

        saveListModalMode = "create";
        saveListModalTargetId = "";
        if (saveListModalTitle) saveListModalTitle.textContent = "Salva lista";
        if (saveListNameLabel) saveListNameLabel.textContent = "Nome lista";
        if (saveListNameInput) saveListNameInput.placeholder = "";
        if (saveListConfirm) saveListConfirm.textContent = "salva lista";
      }

      const COLLEAGUES = [
        { id: "oleandro", name: "oleandro" },
        { id: "rosa", name: "rosa" },
        { id: "margherita", name: "margherita" },
      ];

      function openShareListModal() {
        if (!shareListModal || !shareListModalOverlay || !shareListUsers)
          return;
        const activeList = getMailingListById(appState.activeMailingListId);
        if (!activeList) return;

        const selected = new Set(
          Array.isArray(activeList.sharedWith) ? activeList.sharedWith : [],
        );
        shareListUsers.innerHTML = "";

        for (const c of COLLEAGUES) {
          const row = document.createElement("label");
          row.className = "share-list-user";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = selected.has(c.id);
          cb.setAttribute("data-colleague-id", c.id);

          const text = document.createElement("span");
          text.textContent = c.name;

          row.appendChild(cb);
          row.appendChild(text);
          shareListUsers.appendChild(row);
        }

        shareListModalOverlay.classList.add("show");
        shareListModal.classList.add("show");
        shareListModalOverlay.setAttribute("aria-hidden", "false");
        shareListModal.setAttribute("aria-hidden", "false");
      }

      function closeShareListModal() {
        if (!shareListModal || !shareListModalOverlay) return;
        shareListModalOverlay.classList.remove("show");
        shareListModal.classList.remove("show");
        shareListModalOverlay.setAttribute("aria-hidden", "true");
        shareListModal.setAttribute("aria-hidden", "true");
      }

      function getMailingListById(id) {
        const k = String(id || "").trim();
        if (!k) return null;
        return (
          (appState.mailingLists || []).find((x) => x && x.id === k) || null
        );
      }

      function getMailingListByName(name) {
        const k = String(name || "").trim();
        if (!k) return null;
        return (
          (appState.mailingLists || []).find(
            (x) => String(x?.name || "") === k,
          ) || null
        );
      }

      function getActiveSpedizioneIndex(preferredName = "") {
        if (
          !Array.isArray(appState.spedizioni) ||
          appState.spedizioni.length === 0
        )
          return -1;

        if (activeSpedizioneRef) {
          const byRefIdx = appState.spedizioni.indexOf(activeSpedizioneRef);
          if (byRefIdx !== -1) return byRefIdx;
        }

        const sourceListId = String(
          appState.activeSpedizioneSourceListId || "",
        ).trim();
        const preferred = String(
          preferredName || appState.activeSpedizioneName || "",
        ).trim();

        if (preferred && sourceListId) {
          const byNameAndSource = appState.spedizioni.findIndex(
            (s) =>
              String(s?.name || "").trim() === preferred &&
              String(s?.sourceMailingListId || "").trim() === sourceListId,
          );
          if (byNameAndSource !== -1) return byNameAndSource;
        }

        if (preferred) {
          const byName = appState.spedizioni.findIndex(
            (s) => String(s?.name || "").trim() === preferred,
          );
          if (byName !== -1) return byName;
        }

        return -1;
      }

      function getSpedizioneSourceList() {
        return getMailingListById(appState.activeSpedizioneSourceListId);
      }

      function getRecentMailingLists(limit = Infinity) {
        const all = Array.isArray(appState.mailingLists)
          ? [...appState.mailingLists]
          : [];
        const sorted = all.filter(Boolean).sort((a, b) => {
          const aTs = Number(a?.createdAt || 0);
          const bTs = Number(b?.createdAt || 0);
          return bTs - aTs;
        });
        if (!Number.isFinite(limit)) return sorted;
        return sorted.slice(0, Math.max(0, Number(limit) || 0));
      }

      function getShipmentSelectedRecipientLists() {
        return Array.from(shipmentSelectedRecipientListIds)
          .map((id) => getMailingListById(id))
          .filter(Boolean);
      }

      function getShipmentActiveRecipientLists() {
        return Array.from(shipmentActiveRecipientListIds)
          .map((id) => getMailingListById(id))
          .filter(Boolean);
      }

      function getShipmentJournalistDropdownLabel(j) {
        const fullName =
          `${String(j?.nome || "").trim()} ${String(j?.cognome || "").trim()}`.trim();
        const email = String(j?.email || "").trim();
        if (fullName && email) return `${fullName} · ${email}`;
        return fullName || email || getJournalistId(j);
      }

      function refreshShipmentRecipientsJournalistsDropdownOptions() {
        const source = Array.isArray(journalists) ? journalists : [];
        if (
          source === lastShipmentJournalistsSourceRef &&
          source.length === lastShipmentJournalistsSourceLen
        ) {
          return;
        }

        const journalistLabelCount = new Map();
        const journalistOptionEntries = source
          .map((j) => {
            const id = String(getJournalistId(j) || "").trim();
            if (!id) return null;
            const baseLabel = getShipmentJournalistDropdownLabel(j);
            const prevCount = journalistLabelCount.get(baseLabel) || 0;
            const nextCount = prevCount + 1;
            journalistLabelCount.set(baseLabel, nextCount);
            const uniqueLabel =
              nextCount > 1 ? `${baseLabel} (${nextCount})` : baseLabel;
            return {
              id,
              label: uniqueLabel,
            };
          })
          .filter(Boolean)
          .sort((a, b) =>
            String(a.label || "").localeCompare(String(b.label || ""), "it", {
              sensitivity: "base",
            }),
          );

        shipmentJournalistOptionToId.clear();
        shipmentJournalistIdToOption.clear();
        journalistOptionEntries.forEach((entry) => {
          shipmentJournalistOptionToId.set(entry.label, entry.id);
          shipmentJournalistIdToOption.set(entry.id, entry.label);
        });

        const journalistOptions = journalistOptionEntries.map(
          (entry) => entry.label,
        );
        const nextJournalistOptionsKey = journalistOptionEntries
          .map((entry) => `${entry.id}:${entry.label}`)
          .join("||");
        if (nextJournalistOptionsKey !== lastShipmentJournalistOptionsKey) {
          shipmentJournalistsDropdownSyncing = true;
          shipmentRecipientsJournalistsDropdown.setOptions(journalistOptions);
          shipmentJournalistsDropdownSyncing = false;
          lastShipmentJournalistOptionsKey = nextJournalistOptionsKey;
        }

        lastShipmentJournalistsSourceRef = source;
        lastShipmentJournalistsSourceLen = source.length;
      }

      function syncShipmentPrimaryListInState() {
        const nextPrimary =
          Array.from(shipmentSelectedRecipientListIds).find(Boolean) || "";
        appState.activeSpedizioneSourceListId = nextPrimary;
      }

      function applyShipmentSelectedRecipientListIds(ids = [], options = {}) {
        const { save = false, syncDropdown = true } = options;
        const prevSelected = new Set(shipmentSelectedRecipientListIds);
        const next = new Set(
          (Array.isArray(ids) ? ids : [])
            .map((id) => String(id || "").trim())
            .filter((id) => !!getMailingListById(id)),
        );
        shipmentSelectedRecipientListIds = next;

        const nextActive = new Set();
        Array.from(next).forEach((id) => {
          if (shipmentActiveRecipientListIds.has(id) || !prevSelected.has(id)) {
            nextActive.add(id);
          }
        });
        shipmentActiveRecipientListIds = nextActive;

        syncShipmentPrimaryListInState();

        if (syncDropdown && shipmentRecipientsListsDropdown) {
          shipmentListsDropdownSyncing = true;
          const selectedNames = getShipmentSelectedRecipientLists()
            .map((list) => String(list?.name || "").trim())
            .filter(Boolean);
          shipmentRecipientsListsDropdown.selectedValues = new Set(
            selectedNames,
          );
          shipmentRecipientsListsDropdown.renderChips();
          shipmentRecipientsListsDropdown.renderList();
          shipmentRecipientsListsDropdown.updateClearVisibility();
          shipmentListsDropdownSyncing = false;
        }

        if (save) {
          saveAppState(appState);
        }
      }

      function applyShipmentSelectedRecipientJournalistIds(
        ids = [],
        options = {},
      ) {
        const { syncDropdown = true } = options;
        const next = new Set(
          (Array.isArray(ids) ? ids : [])
            .map((id) => String(id || "").trim())
            .filter(Boolean),
        );
        shipmentSelectedRecipientJournalistIds = next;

        if (syncDropdown && shipmentRecipientsJournalistsDropdown) {
          shipmentJournalistsDropdownSyncing = true;
          const selectedOptions = Array.from(next)
            .map((id) => shipmentJournalistIdToOption.get(id))
            .filter(Boolean);
          shipmentRecipientsJournalistsDropdown.selectedValues = new Set(
            selectedOptions,
          );
          shipmentRecipientsJournalistsDropdown.renderChips();
          shipmentRecipientsJournalistsDropdown.renderList();
          shipmentRecipientsJournalistsDropdown.updateClearVisibility();
          shipmentJournalistsDropdownSyncing = false;
        }
      }

      function renderShipmentSelectedListsChips() {
        if (!shipmentSelectedListsChips) return;
        shipmentSelectedListsChips.innerHTML = "";

        const selectedLists = getShipmentSelectedRecipientLists();
        selectedLists.forEach((list) => {
          const listId = String(list?.id || "").trim();
          const isActive = shipmentActiveRecipientListIds.has(listId);
          const chip = document.createElement("span");
          chip.className = `chip shipment-list-chip${isActive ? "" : " is-off"}`;
          chip.setAttribute("role", "button");
          chip.setAttribute("tabindex", "0");
          chip.setAttribute("aria-pressed", isActive ? "true" : "false");

          const text = document.createElement("span");
          text.textContent = String(list?.name || "").trim();
          chip.appendChild(text);

          const toggleChip = () => {
            if (!listId) return;
            if (shipmentActiveRecipientListIds.has(listId)) {
              shipmentActiveRecipientListIds.delete(listId);
            } else {
              shipmentActiveRecipientListIds.add(listId);
            }
            renderShipmentSelectedListsChips();
            scheduleRender();
          };

          chip.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleChip();
          });
          chip.addEventListener("keydown", (e) => {
            if (e.key !== "Enter" && e.key !== " ") return;
            e.preventDefault();
            e.stopPropagation();
            toggleChip();
          });

          shipmentSelectedListsChips.appendChild(chip);
        });
      }

      function getSpedizioneByName(name) {
        const k = String(name || "").trim();
        if (!k) return null;
        return (
          (appState.spedizioni || []).find(
            (x) => String(x?.name || "") === k,
          ) || null
        );
      }

      const SHIPMENT_HEADER_MAX_CHARS = 40;

      function truncateWithEllipsis(value, maxChars) {
        const text = String(value || "");
        const limit = Math.max(1, Number(maxChars) || 1);
        if (text.length <= limit) return text;
        if (limit === 1) return "…";
        return `${text.slice(0, limit - 1)}…`;
      }

      function getShipmentNameRaw(spedizioneSourceList = null) {
        const fromState = String(appState.activeSpedizioneName || "").trim();
        if (fromState) return fromState;
        const sourceName = String(spedizioneSourceList?.name || "").trim();
        if (sourceName) return `spedizione a ${sourceName}`;
        return "spedizione";
      }

      function getShipmentHeaderTitle(spedizioneSourceList = null) {
        return truncateWithEllipsis(
          getShipmentNameRaw(spedizioneSourceList),
          SHIPMENT_HEADER_MAX_CHARS,
        );
      }

      function renameActiveShipmentName(rawName, currentNameHint = "") {
        const previousName = String(
          appState.activeSpedizioneName || currentNameHint || "",
        ).trim();
        const nextName = String(rawName || "").trim();
        if (!nextName) return false;
        const idx = getActiveSpedizioneIndex(previousName);
        if (idx === -1) {
          appState.activeSpedizioneName = nextName;
          saveAppState(appState);
          renderDashboardSpedizioni();
          return true;
        }
        appState.spedizioni[idx] = {
          ...appState.spedizioni[idx],
          name: nextName,
        };
        activeSpedizioneRef = appState.spedizioni[idx];
        appState.activeSpedizioneName = nextName;
        saveAppState(appState);
        renderDashboardSpedizioni();
        return true;
      }

      function openShipmentTitleInlineEditor() {
        if (!mainTitleEl || !shipmentTitleInput) return;
        if (appState.view !== "spedisci-lista") return;

        const currentName = getShipmentNameRaw(getSpedizioneSourceList());
        isShipmentTitleEditing = true;
        shipmentTitleBeforeEdit = currentName;

        mainTitleEl.style.display = "none";
        shipmentTitleInput.style.display = "inline-block";
        shipmentTitleInput.value = currentName;
        shipmentTitleInput.focus();
        try {
          shipmentTitleInput.setSelectionRange(
            0,
            String(shipmentTitleInput.value || "").length,
          );
        } catch (_) {}
      }

      function closeShipmentTitleInlineEditor({ commit = true } = {}) {
        if (!mainTitleEl || !shipmentTitleInput) return;
        if (!isShipmentTitleEditing) return;

        const draft = String(shipmentTitleInput.value || "").trim();
        const fallbackName =
          shipmentTitleBeforeEdit ||
          getShipmentNameRaw(getSpedizioneSourceList());

        isShipmentTitleEditing = false;
        shipmentTitleInput.style.display = "none";
        mainTitleEl.style.display = "";

        if (commit && draft) {
          if (renameActiveShipmentName(draft, fallbackName)) {
            mainTitleEl.textContent = getShipmentHeaderTitle(
              getSpedizioneSourceList(),
            );
            shipmentTitleInput.value = getShipmentNameRaw(
              getSpedizioneSourceList(),
            );
            return;
          }
          return;
        }

        mainTitleEl.textContent = truncateWithEllipsis(
          fallbackName,
          SHIPMENT_HEADER_MAX_CHARS,
        );
        shipmentTitleInput.value = fallbackName;
      }

      let toastHideTimer = 0;
      function showToast(message, options = {}) {
        const { durationMs = 2600 } = options;
        const msg = String(message || "").trim();
        if (!msg) return;

        let el = document.getElementById("appToast");
        if (!el) {
          el = document.createElement("div");
          el.id = "appToast";
          el.className = "app-toast";
          el.setAttribute("role", "status");
          el.setAttribute("aria-live", "polite");
          document.body.appendChild(el);
        }

        el.textContent = msg;
        el.classList.add("show");
        if (toastHideTimer) window.clearTimeout(toastHideTimer);
        toastHideTimer = window.setTimeout(
          () => {
            el.classList.remove("show");
          },
          Math.max(400, Number(durationMs) || 2600),
        );
      }

      function formatRemovedFromListToast(count) {
        const n = Math.max(0, Math.floor(Number(count) || 0));
        if (n === 1) {
          return "1 giornalista rimosso da lista (non da banca dati)";
        }
        return `${n} giornalisti rimossi da lista (non da banca dati)`;
      }

      const addToListDropdown = new FilterableDropdown(
        "addToListDropdownInput",
        [],
        {
          inputWrapperId: "addToListDropdownInputWrapper",
          chipContainerId: "addToListChipContainer",
          autocompleteInlineId: "addToListAutocompleteInline",
          autocompleteSuffixId: "addToListAutocompleteSuffix",
          autocompleteTipId: "addToListAutocompleteTip",
          arrowId: "addToListDropdownArrow",
          clearId: null,
          listId: "addToListDropdownList",
          closeLinkId: null,
          suggestionsId: "addToListDropdownSuggestions",
          resultsId: "addToListDropdownResults",
          synonymsByFilter: {},
          renderChipsInInput: false,
          renderCheckboxes: false,
          singleSelect: true,
          closeOnSelect: true,
          writeSelectedToInput: true,
          enableHighlight: true,
          minFilterChars: 1,
        },
      );
      addToListDropdown.updateAutocompleteHint("");

      addToListDropdown.onSelectionChange = () => {
        if (addToListError) addToListError.style.display = "none";
      };

      const addToShipmentDropdown = new FilterableDropdown(
        "addToShipmentDropdownInput",
        [],
        {
          inputWrapperId: "addToShipmentDropdownInputWrapper",
          chipContainerId: "addToShipmentChipContainer",
          autocompleteInlineId: "addToShipmentAutocompleteInline",
          autocompleteSuffixId: "addToShipmentAutocompleteSuffix",
          autocompleteTipId: "addToShipmentAutocompleteTip",
          arrowId: "addToShipmentDropdownArrow",
          clearId: "addToShipmentDropdownClearLink",
          listId: "addToShipmentDropdownList",
          closeLinkId: null,
          suggestionsId: "addToShipmentDropdownSuggestions",
          resultsId: "addToShipmentDropdownResults",
          synonymsByFilter: {},
          renderChipsInInput: false,
          renderCheckboxes: false,
          singleSelect: true,
          closeOnSelect: true,
          writeSelectedToInput: true,
          enableHighlight: true,
          minFilterChars: 1,
        },
      );
      addToShipmentDropdown.updateAutocompleteHint("");

      addToShipmentDropdown.onSelectionChange = () => {
        if (addToShipmentError) addToShipmentError.style.display = "none";
      };

      const shipmentRecipientsJournalistsDropdown = new FilterableDropdown(
        "shipmentRecipientsJournalistsInput",
        [],
        {
          inputWrapperId: "shipmentRecipientsJournalistsInputWrapper",
          chipContainerId: "shipmentRecipientsJournalistsDropdownChipSink",
          autocompleteInlineId:
            "shipmentRecipientsJournalistsAutocompleteInline",
          autocompleteSuffixId:
            "shipmentRecipientsJournalistsAutocompleteSuffix",
          autocompleteTipId: "shipmentRecipientsJournalistsAutocompleteTip",
          arrowId: "shipmentRecipientsJournalistsDropdownArrow",
          clearId: null,
          listId: "shipmentRecipientsJournalistsDropdownList",
          closeLinkId: null,
          suggestionsId: "shipmentRecipientsJournalistsDropdownSuggestions",
          resultsId: "shipmentRecipientsJournalistsDropdownResults",
          synonymsByFilter: {},
          renderChipsInInput: false,
          renderCheckboxes: true,
          singleSelect: false,
          closeOnSelect: false,
          writeSelectedToInput: false,
          enableHighlight: true,
          minFilterChars: 1,
        },
      );
      shipmentRecipientsJournalistsDropdown.updateAutocompleteHint("");
      shipmentRecipientsJournalistsDropdown.onSelectionChange = (
        selectedOptions,
      ) => {
        if (shipmentJournalistsDropdownSyncing) return;

        const ids = (Array.isArray(selectedOptions) ? selectedOptions : [])
          .map((option) =>
            shipmentJournalistOptionToId.get(String(option || "")),
          )
          .filter(Boolean);

        applyShipmentSelectedRecipientJournalistIds(ids, {
          syncDropdown: false,
        });
        scheduleRender();
      };

      const shipmentRecipientsListsDropdown = new FilterableDropdown(
        "shipmentRecipientsListsInput",
        [],
        {
          inputWrapperId: "shipmentRecipientsListsInputWrapper",
          chipContainerId: "shipmentRecipientsListsDropdownChipSink",
          autocompleteInlineId: "shipmentRecipientsListsAutocompleteInline",
          autocompleteSuffixId: "shipmentRecipientsListsAutocompleteSuffix",
          autocompleteTipId: "shipmentRecipientsListsAutocompleteTip",
          arrowId: "shipmentRecipientsListsDropdownArrow",
          clearId: null,
          listId: "shipmentRecipientsListsDropdownList",
          closeLinkId: null,
          suggestionsId: "shipmentRecipientsListsDropdownSuggestions",
          resultsId: "shipmentRecipientsListsDropdownResults",
          synonymsByFilter: {},
          renderChipsInInput: false,
          renderCheckboxes: true,
          singleSelect: false,
          closeOnSelect: false,
          writeSelectedToInput: false,
          enableHighlight: true,
          minFilterChars: 1,
          sortComparator: (a, b) => {
            const ra = shipmentListOrder.get(String(a || ""));
            const rb = shipmentListOrder.get(String(b || ""));
            const safeRa = Number.isFinite(ra) ? ra : Number.POSITIVE_INFINITY;
            const safeRb = Number.isFinite(rb) ? rb : Number.POSITIVE_INFINITY;
            return (
              safeRa - safeRb ||
              String(a || "").localeCompare(String(b || ""), "it", {
                sensitivity: "base",
              })
            );
          },
        },
      );
      shipmentRecipientsListsDropdown.updateAutocompleteHint("");
      shipmentRecipientsListsDropdown.onSelectionChange = (selectedNames) => {
        if (shipmentListsDropdownSyncing) return;

        const ids = (Array.isArray(selectedNames) ? selectedNames : [])
          .map((name) => getMailingListByName(name))
          .filter(Boolean)
          .map((list) => String(list.id || "").trim())
          .filter(Boolean);

        applyShipmentSelectedRecipientListIds(ids, {
          save: true,
          syncDropdown: false,
        });
        renderShipmentSelectedListsChips();
        scheduleRender();
      };

      const smartFiltersOpenLink = document.getElementById(
        "smartFiltersOpenLink",
      );
      const smartFiltersModalOverlay = document.getElementById(
        "smartFiltersModalOverlay",
      );
      const smartFiltersModal = document.getElementById("smartFiltersModal");
      const smartFiltersModalClose = document.getElementById(
        "smartFiltersModalClose",
      );
      const smartFiltersComunicatoSelect = document.getElementById(
        "smartFiltersComunicatoSelect",
      );
      const smartFiltersText = document.getElementById("smartFiltersText");
      const smartFiltersSuggestBtn = document.getElementById(
        "smartFiltersSuggestBtn",
      );
      const smartFiltersApplyBtn = document.getElementById(
        "smartFiltersApplyBtn",
      );
      const smartFiltersResults = document.getElementById(
        "smartFiltersResults",
      );
      const creaListaFuturoComunicatoSelect = document.getElementById(
        "creaListaFuturoComunicatoSelect",
      );
      const creaListaFuturoApiKeyInput = document.getElementById(
        "creaListaFuturoApiKey",
      );
      const creaListaFuturoText = document.getElementById(
        "creaListaFuturoText",
      );
      const creaListaFuturoCreateLink = document.getElementById(
        "creaListaFuturoCreateLink",
      );
      const creaListaFuturoResults = document.getElementById(
        "creaListaFuturoResults",
      );
      const creaListaFuturoCardsGrid = document.getElementById(
        "creaListaFuturoCardsGrid",
      );
      const creaListaFuturoCountPill = document.getElementById(
        "creaListaFuturoCountPill",
      );

      let smartFiltersLastSuggested = [];
      let creaListaFuturoLastSuggested = [];

      function getStoredOpenAiKey() {
        return String(
          window.localStorage.getItem("openai_api_key") ||
            window.localStorage.getItem("OPENAI_API_KEY") ||
            "",
        ).trim();
      }

      function setStoredOpenAiKey(nextKey) {
        const key = String(nextKey || "").trim();
        if (!key) return;
        window.localStorage.setItem("openai_api_key", key);
        window.localStorage.setItem("OPENAI_API_KEY", key);
      }

      function getComunicatoBodyTextById(id) {
        const key = String(id || "").trim();
        if (!key) return "";
        const idx = getComunicatoIndexById(key);
        if (idx < 0 || !Array.isArray(appState.comunicati)) return "";
        const item = appState.comunicati[idx];
        if (!item || typeof item !== "object") return "";
        return String(item.bodyText || "");
      }

      function renderSmartFiltersComunicatoOptions() {
        if (!smartFiltersComunicatoSelect) return;
        const currentValue = String(
          smartFiltersComunicatoSelect.value || "",
        ).trim();
        const items = getComunicatiItems();

        smartFiltersComunicatoSelect.innerHTML =
          '<option value="">seleziona comunicato</option>';

        items.forEach((item) => {
          const id = String(item?.id || "").trim();
          const label = String(item?.label || "").trim();
          if (!id || !label) return;
          const option = document.createElement("option");
          option.value = id;
          option.textContent = label;
          smartFiltersComunicatoSelect.appendChild(option);
        });

        if (
          currentValue &&
          items.some((x) => String(x?.id || "").trim() === currentValue)
        ) {
          smartFiltersComunicatoSelect.value = currentValue;
        }
      }

      function setLinkDisabled(link, disabled) {
        if (!link) return;
        link.classList.toggle("is-disabled", !!disabled);
        link.setAttribute("aria-disabled", disabled ? "true" : "false");
      }

      function openSmartFiltersModal() {
        if (!smartFiltersModal || !smartFiltersModalOverlay) return;
        smartFiltersModalOverlay.classList.add("show");
        smartFiltersModal.classList.add("show");
        smartFiltersModalOverlay.setAttribute("aria-hidden", "false");
        smartFiltersModal.setAttribute("aria-hidden", "false");

        renderSmartFiltersComunicatoOptions();
        updateSmartFiltersModeHint();
        if (smartFiltersText) smartFiltersText.focus();
      }

      function closeSmartFiltersModal() {
        if (!smartFiltersModal || !smartFiltersModalOverlay) return;
        smartFiltersModalOverlay.classList.remove("show");
        smartFiltersModal.classList.remove("show");
        smartFiltersModalOverlay.setAttribute("aria-hidden", "true");
        smartFiltersModal.setAttribute("aria-hidden", "true");
      }

      function updateSmartFiltersModeHint() {
        if (!smartFiltersResults) return;
        const mode = getSidebarMode();
        smartFiltersResults.setAttribute("data-mode", mode);

        if (
          smartFiltersModal?.classList.contains("show") &&
          Array.isArray(smartFiltersLastSuggested) &&
          smartFiltersLastSuggested.length > 0
        ) {
          renderSmartFiltersResults(smartFiltersLastSuggested, {
            loading: false,
          });
        }
      }

      function renderSmartFiltersResults(subjects = [], meta = {}) {
        if (!smartFiltersResults) return;
        const items = Array.isArray(subjects)
          ? subjects.map((x) => String(x || "").trim()).filter(Boolean)
          : [];

        setLinkDisabled(smartFiltersApplyBtn, true);

        smartFiltersResults.innerHTML = "";
        const title = document.createElement("div");
        title.className = "smart-filters-results-title";
        title.textContent = "Suggerimenti";
        smartFiltersResults.appendChild(title);

        if (!items.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = meta?.loading
            ? "Analisi in corso…"
            : "Nessun suggerimento";
          smartFiltersResults.appendChild(empty);
          return;
        }

        const list = document.createElement("div");
        list.className = "smart-filters-chip-list";
        for (const s of items) {
          const chip = document.createElement("span");
          chip.className = "chip";
          const text = document.createElement("span");
          text.textContent = s;
          chip.appendChild(text);
          list.appendChild(chip);
        }
        smartFiltersResults.appendChild(list);

        {
          const mode = getSidebarMode();
          const applyTitle = document.createElement("div");
          applyTitle.className = "smart-filters-apply-title";
          applyTitle.textContent =
            mode === "testate" ? "Argomento testata" : "Servizio giornalistico";
          smartFiltersResults.appendChild(applyTitle);

          const inst = mode === "testate" ? testataArgomentoDropdown : dropdown;
          const toApply = inst ? canonicalizeSubjects(items, inst) : [];

          setLinkDisabled(smartFiltersApplyBtn, toApply.length === 0);

          if (!toApply.length) {
            const empty = document.createElement("div");
            empty.className = "muted";
            empty.textContent = "Nessun filtro applicabile";
            smartFiltersResults.appendChild(empty);
          } else {
            const list2 = document.createElement("div");
            list2.className = "smart-filters-chip-list";
            for (const s of toApply) {
              const chip = document.createElement("span");
              chip.className = "chip";
              const text = document.createElement("span");
              text.textContent = s;
              chip.appendChild(text);
              list2.appendChild(chip);
            }
            smartFiltersResults.appendChild(list2);
          }
        }
      }

      function renderCreaListaFuturoResults(subjects = [], meta = {}) {
        if (!creaListaFuturoResults) return;
        const items = Array.isArray(subjects)
          ? subjects.map((x) => String(x || "").trim()).filter(Boolean)
          : [];
        const selectedServices = dropdown
          ? canonicalizeSubjects(items, dropdown)
          : [];

        creaListaFuturoResults.innerHTML = "";
        const title = document.createElement("div");
        title.className = "smart-filters-results-title";
        title.textContent = "Suggerimenti";
        creaListaFuturoResults.appendChild(title);

        if (!items.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = meta?.loading
            ? "Analisi in corso…"
            : "Nessun suggerimento";
          creaListaFuturoResults.appendChild(empty);
          return;
        }

        const list = document.createElement("div");
        list.className = "smart-filters-chip-list";
        for (const s of items) {
          const chip = document.createElement("span");
          chip.className = "chip";
          const text = document.createElement("span");
          text.textContent = s;
          chip.appendChild(text);
          list.appendChild(chip);
        }
        creaListaFuturoResults.appendChild(list);

        const servicesTitle = document.createElement("div");
        servicesTitle.className = "smart-filters-apply-title";
        servicesTitle.textContent = "Servizi giornalistici selezionati";
        creaListaFuturoResults.appendChild(servicesTitle);

        if (!selectedServices.length) {
          const emptyServices = document.createElement("div");
          emptyServices.className = "muted";
          emptyServices.textContent = "Nessun servizio applicabile";
          creaListaFuturoResults.appendChild(emptyServices);
          return;
        }

        const servicesList = document.createElement("div");
        servicesList.className = "smart-filters-chip-list";
        for (const service of selectedServices) {
          const chip = document.createElement("span");
          chip.className = "chip";
          const text = document.createElement("span");
          text.textContent = service;
          chip.appendChild(text);
          servicesList.appendChild(chip);
        }
        creaListaFuturoResults.appendChild(servicesList);
      }

      function renderCreaListaFuturoCards(items = [], highlightTerms = []) {
        if (!creaListaFuturoCardsGrid) return;
        const safeItems = Array.isArray(items) ? items : [];
        creaListaFuturoCardsGrid.innerHTML = "";

        if (!safeItems.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "Nessun giornalista trovato";
          creaListaFuturoCardsGrid.appendChild(empty);
        } else {
          safeItems.forEach((j) => {
            creaListaFuturoCardsGrid.appendChild(createCard(j, highlightTerms));
          });
        }

        if (creaListaFuturoCountPill) {
          creaListaFuturoCountPill.textContent = String(safeItems.length);
        }
      }

      function getCreaListaFuturoFilteredJournalists(subjects = []) {
        const source = Array.isArray(subjects) ? subjects : [];
        const serviceCanon = canonicalizeSubjects(source, dropdown);

        const serviceSet = new Set(
          serviceCanon.map((x) =>
            String(x || "")
              .trim()
              .toLowerCase(),
          ),
        );

        if (serviceSet.size === 0) {
          return [];
        }

        const out = (Array.isArray(journalists) ? journalists : []).filter(
          (j) => {
            const servizio = String(j?.servizio || "")
              .trim()
              .toLowerCase();
            return !!servizio && serviceSet.has(servizio);
          },
        );

        return out.sort((a, b) => compareJournalistsByName(a, b));
      }

      async function createCreaListaFuturo() {
        if (!creaListaFuturoCreateLink) return;
        try {
          setLinkDisabled(creaListaFuturoCreateLink, true);
          creaListaFuturoLastSuggested = [];
          renderCreaListaFuturoResults([], { loading: true });
          renderCreaListaFuturoCards([], []);

          const text = creaListaFuturoText?.value || "";
          const inputKey = String(
            creaListaFuturoApiKeyInput?.value || "",
          ).trim();
          if (inputKey) {
            setStoredOpenAiKey(inputKey);
          }

          const { subjects } = await fetchOpenAiSubjectsFromText(
            text,
            inputKey,
          );

          creaListaFuturoLastSuggested = subjects;
          renderCreaListaFuturoResults(subjects, { loading: false });

          const filtered = getCreaListaFuturoFilteredJournalists(subjects);
          renderCreaListaFuturoCards(filtered, subjects);
        } catch (err) {
          renderCreaListaFuturoResults([], { loading: false });
          showToast(String(err?.message || err || "Errore"));
        } finally {
          setLinkDisabled(creaListaFuturoCreateLink, false);
        }
      }

      function openCreaListaFuturoView() {
        renderCreaListaFuturoComunicatoOptions();
        if (creaListaFuturoApiKeyInput) {
          creaListaFuturoApiKeyInput.value = getStoredOpenAiKey();
        }

        if (
          Array.isArray(creaListaFuturoLastSuggested) &&
          creaListaFuturoLastSuggested.length > 0
        ) {
          renderCreaListaFuturoResults(creaListaFuturoLastSuggested, {
            loading: false,
          });
          const filtered = getCreaListaFuturoFilteredJournalists(
            creaListaFuturoLastSuggested,
          );
          renderCreaListaFuturoCards(filtered, creaListaFuturoLastSuggested);
          return;
        }

        renderCreaListaFuturoResults([], { loading: false });
        renderCreaListaFuturoCards([], []);
      }

      async function fetchOpenAiSubjectsFromText(text, apiKeyOverride = "") {
        const inputText = String(text || "").trim();
        const key = String(apiKeyOverride || "").trim() || getStoredOpenAiKey();
        if (!inputText) throw new Error("Testo mancante");
        if (!key) {
          throw new Error("API key mancante (localStorage: openai_api_key)");
        }

        const system =
          "Sei un assistente che suggerisce filtri per targeting giornalisti. Rispondi SOLO con JSON valido e nient'altro.";
        const user =
          `Dato il testo seguente, suggerisci una lista breve (max 5) di subjects/argomenti utili per raggiungere giornalisti interessati. ` +
          `Rispondi con JSON nel formato: {"subjects": ["..."], "notes": ""}. ` +
          `Non usare markdown, non usare backticks.\n\nTESTO:\n${inputText}`;

        const res = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${key}`,
          },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            temperature: 0.2,
            max_tokens: 220,
            messages: [
              { role: "system", content: system },
              { role: "user", content: user },
            ],
          }),
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(
            `OpenAI error ${res.status}: ${txt || res.statusText}`,
          );
        }

        const json = await res.json();
        const content =
          json?.choices?.[0]?.message?.content ||
          json?.choices?.[0]?.text ||
          "";
        const raw = String(content || "").trim();
        if (!raw) throw new Error("Risposta AI vuota");

        let parsed = null;
        try {
          parsed = JSON.parse(raw);
        } catch {
          const start = raw.indexOf("{");
          const end = raw.lastIndexOf("}");
          if (start >= 0 && end > start) {
            parsed = JSON.parse(raw.slice(start, end + 1));
          }
        }
        if (!parsed || typeof parsed !== "object") {
          throw new Error("Risposta AI non parseabile come JSON");
        }
        const subjects = Array.isArray(parsed.subjects)
          ? parsed.subjects.map((x) => String(x || "").trim()).filter(Boolean)
          : [];
        return { subjects, notes: String(parsed?.notes || "").trim() };
      }

      function canonicalizeSubjects(subjects, inst) {
        const out = [];
        const seen = new Set();

        const normalize =
          typeof __normalizeDictKey === "function"
            ? __normalizeDictKey
            : (v) =>
                String(v || "")
                  .trim()
                  .toLowerCase();

        const options = Array.isArray(inst?.originalOptions)
          ? inst.originalOptions
          : [];

        const byNorm = new Map();
        for (const opt of options) {
          const k = normalize(opt);
          if (k && !byNorm.has(k)) byNorm.set(k, opt);
        }

        const synsByValue = __subjectsIndex?.synonymsByValue;
        if (synsByValue && typeof synsByValue === "object") {
          for (const [value, syns] of Object.entries(synsByValue)) {
            if (!Array.isArray(syns)) continue;
            for (const s of syns) {
              const k = normalize(s);
              if (k && !byNorm.has(k)) byNorm.set(k, value);
            }
          }
        }

        const stop = new Set([
          "in",
          "di",
          "a",
          "da",
          "su",
          "per",
          "e",
          "o",
          "il",
          "lo",
          "la",
          "i",
          "gli",
          "le",
          "un",
          "uno",
          "una",
          "del",
          "della",
          "dei",
          "degli",
          "delle",
          "al",
          "allo",
          "alla",
          "ai",
          "agli",
          "alle",
          "nel",
          "nello",
          "nella",
          "nei",
          "negli",
          "nelle",
          "sul",
          "sullo",
          "sulla",
          "sui",
          "sugli",
          "sulle",
        ]);

        const tokenize = (raw) => {
          return String(raw || "")
            .toLowerCase()
            .replace(/[’']/g, " ")
            .replace(/[^\p{L}\p{N}]+/gu, " ")
            .trim()
            .split(/\s+/g)
            .map((x) => String(x || "").trim())
            .filter(Boolean);
        };

        const pushCanon = (canon) => {
          const ck = normalize(canon);
          if (!ck || seen.has(ck)) return;
          seen.add(ck);
          out.push(canon);
        };

        const tryFuzzy = (raw) => {
          const key = normalize(raw);
          if (!key) return "";
          let best = "";
          let bestScore = 0;
          for (const opt of options) {
            const ok = normalize(opt);
            if (!ok) continue;
            if (ok === key) return opt;
            if (key.includes(ok) && ok.length >= 7) return opt;
            let score = 0;
            if (ok.includes(key)) score = key.length / ok.length;
            else if (key.includes(ok)) score = ok.length / key.length;
            if (score > bestScore) {
              bestScore = score;
              best = opt;
            }
          }
          return bestScore >= 0.33 ? best : "";
        };

        for (const s of subjects || []) {
          const raw = String(s || "").trim();
          if (!raw) continue;
          const k = normalize(raw);

          const direct = byNorm.get(k);
          if (direct) {
            pushCanon(direct);
            continue;
          }

          const fuzzy = tryFuzzy(raw);
          if (fuzzy) {
            pushCanon(fuzzy);
            continue;
          }

          const tokens = tokenize(raw).filter(
            (t) => t.length >= 4 && !stop.has(t),
          );
          for (const t of tokens) {
            const tk = normalize(t);
            const canon = byNorm.get(tk) || tryFuzzy(t);
            if (canon) pushCanon(canon);
          }
        }
        return out;
      }

      function applySubjectsToDropdown(inst, subjects) {
        if (!inst) return;
        inst.selectedValues.clear();
        for (const s of subjects || []) {
          inst.selectedValues.add(s);
        }
        inst.renderChips();
        inst.renderList();
        inst.updateClearVisibility();
        if (typeof inst.onSelectionChange === "function") {
          inst.onSelectionChange(Array.from(inst.selectedValues));
        }
      }

      function applySmartFiltersSuggestedSubjects() {
        const mode = getSidebarMode();
        const inst = mode === "testate" ? testataArgomentoDropdown : dropdown;
        if (!inst) return;
        const canon = canonicalizeSubjects(smartFiltersLastSuggested, inst);
        applySubjectsToDropdown(inst, canon);
        scheduleRender();
        closeSmartFiltersModal();
      }

      if (smartFiltersOpenLink) {
        smartFiltersOpenLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openSmartFiltersModal();
        });
      }
      if (smartFiltersModalClose) {
        smartFiltersModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeSmartFiltersModal();
        });
      }
      if (smartFiltersModalOverlay) {
        smartFiltersModalOverlay.addEventListener("click", () => {
          closeSmartFiltersModal();
        });
      }

      if (smartFiltersSuggestBtn) {
        smartFiltersSuggestBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();

          try {
            setLinkDisabled(smartFiltersSuggestBtn, true);
            setLinkDisabled(smartFiltersApplyBtn, true);
            smartFiltersLastSuggested = [];
            renderSmartFiltersResults([], { loading: true });

            const text = smartFiltersText?.value || "";
            const { subjects } = await fetchOpenAiSubjectsFromText(text);

            smartFiltersLastSuggested = subjects;
            renderSmartFiltersResults(subjects, { loading: false });
          } catch (err) {
            renderSmartFiltersResults([], { loading: false });
            showToast(String(err?.message || err || "Errore"));
          } finally {
            setLinkDisabled(smartFiltersSuggestBtn, false);
          }
        });
      }

      if (smartFiltersApplyBtn) {
        smartFiltersApplyBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (smartFiltersApplyBtn.classList.contains("is-disabled")) return;
          applySmartFiltersSuggestedSubjects();
        });
      }

      if (smartFiltersComunicatoSelect) {
        smartFiltersComunicatoSelect.addEventListener("change", () => {
          const selectedId = String(
            smartFiltersComunicatoSelect.value || "",
          ).trim();
          if (!smartFiltersText) return;
          smartFiltersText.value = getComunicatoBodyTextById(selectedId);
        });
      }

      if (creaListaFuturoComunicatoSelect) {
        creaListaFuturoComunicatoSelect.addEventListener("change", () => {
          const selectedId = String(
            creaListaFuturoComunicatoSelect.value || "",
          ).trim();
          if (!creaListaFuturoText) return;
          creaListaFuturoText.value = getComunicatoBodyTextById(selectedId);
        });
      }

      if (creaListaFuturoCreateLink) {
        creaListaFuturoCreateLink.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          await createCreaListaFuturo();
        });
      }

      if (creaListaFuturoApiKeyInput) {
        creaListaFuturoApiKeyInput.addEventListener("blur", () => {
          const key = String(creaListaFuturoApiKeyInput.value || "").trim();
          if (!key) return;
          setStoredOpenAiKey(key);
        });
      }

      const clearAddToShipmentForm = () => {
        if (addToShipmentDropdown?.isOpen) {
          addToShipmentDropdown.close();
        }
        if (addToShipmentError) addToShipmentError.style.display = "none";
      };

      const centerModalToAnchor = (modalEl, anchorEl) => {
        if (!modalEl || !anchorEl) return;
        const r = anchorEl.getBoundingClientRect();
        const modalW = modalEl.getBoundingClientRect()?.width || 0;
        const pad = 20;
        const minX = modalW ? modalW / 2 + pad : pad;
        const maxX = modalW
          ? window.innerWidth - modalW / 2 - pad
          : window.innerWidth - pad;
        const x0 = r.left + r.width / 2;
        const x = Math.max(minX, Math.min(maxX, x0));
        modalEl.style.left = `${x}px`;
        modalEl.style.transform = "translateX(-50%)";
      };

      function openAddToListModal(opts) {
        if (!addToListModal || !addToListModalOverlay) return;
        const targetJids = Array.isArray(opts?.journalistIds)
          ? opts.journalistIds
              .map((x) => String(x || "").trim())
              .filter(Boolean)
          : null;
        if (
          selectedJournalistOrder.length === 0 &&
          (!targetJids || !targetJids.length)
        ) {
          return;
        }
        addToListTargetJids = targetJids;

        closeAllFilterableDropdowns();

        const listNames = (appState.mailingLists || [])
          .map((x) => String(x?.name || "").trim())
          .filter(Boolean);
        addToListDropdown.setOptions(listNames);

        if (addToListError) {
          addToListError.style.display = "none";
        }

        addToListModal.style.left = "";
        addToListModal.style.transform = "";
        if (opts?.anchorEl) {
          centerModalToAnchor(addToListModal, opts.anchorEl);
        }

        addToListModalOverlay.classList.add("show");
        addToListModal.classList.add("show");
        addToListModalOverlay.setAttribute("aria-hidden", "false");
        addToListModal.setAttribute("aria-hidden", "false");

        if (addToListDropdownInput) {
          addToListDropdownInput.focus();
        }
      }

      function closeAddToListModal() {
        if (!addToListModal || !addToListModalOverlay) return;
        if (addToListDropdown?.isOpen) {
          addToListDropdown.close();
        }
        addToListTargetJids = null;
        addToListModalOverlay.classList.remove("show");
        addToListModal.classList.remove("show");
        addToListModalOverlay.setAttribute("aria-hidden", "true");
        addToListModal.setAttribute("aria-hidden", "true");

        if (addToListError) {
          addToListError.style.display = "none";
        }
      }

      function openAddToShipmentModal(opts) {
        if (!addToShipmentModal || !addToShipmentModalOverlay) return;
        const targetJids = Array.isArray(opts?.journalistIds)
          ? opts.journalistIds
              .map((x) => String(x || "").trim())
              .filter(Boolean)
          : null;
        if (
          selectedJournalistOrder.length === 0 &&
          (!targetJids || !targetJids.length)
        ) {
          return;
        }
        addToShipmentTargetJids = targetJids;

        closeAllFilterableDropdowns();

        const shipmentNames = (appState.spedizioni || [])
          .map((x) => String(x?.name || "").trim())
          .filter(Boolean);
        addToShipmentDropdown.setOptions(shipmentNames);

        if (addToShipmentError) {
          addToShipmentError.style.display = "none";
        }

        addToShipmentModal.style.left = "";
        addToShipmentModal.style.transform = "";
        if (opts?.anchorEl) {
          centerModalToAnchor(addToShipmentModal, opts.anchorEl);
        }

        addToShipmentModalOverlay.classList.add("show");
        addToShipmentModal.classList.add("show");
        addToShipmentModalOverlay.setAttribute("aria-hidden", "false");
        addToShipmentModal.setAttribute("aria-hidden", "false");

        if (addToShipmentDropdownInput) {
          addToShipmentDropdownInput.focus();
        }
      }

      function openAddToNewShipmentModal() {
        if (!addToNewShipmentModal || !addToNewShipmentModalOverlay) return;
        if (selectedJournalistOrder.length === 0) return;

        closeAllFilterableDropdowns();

        {
          const titleEl = document.getElementById("addToNewShipmentModalTitle");
          const n = Number(selectedJournalistIds?.size || 0);
          const label =
            n === 1
              ? "Aggiungi 1 giornalista a nuova spedizione"
              : `Aggiungi ${n} giornalisti a nuova spedizione`;
          if (titleEl) titleEl.textContent = label;
        }

        if (addToNewShipmentError) {
          addToNewShipmentError.style.display = "none";
        }

        addToNewShipmentModalOverlay.classList.add("show");
        addToNewShipmentModal.classList.add("show");
        addToNewShipmentModalOverlay.setAttribute("aria-hidden", "false");
        addToNewShipmentModal.setAttribute("aria-hidden", "false");

        if (addToNewShipmentNameInput) {
          addToNewShipmentNameInput.value = "";
          addToNewShipmentNameInput.focus();
        }
      }

      function closeAddToShipmentModal() {
        if (!addToShipmentModal || !addToShipmentModalOverlay) return;
        if (addToShipmentDropdown?.isOpen) {
          addToShipmentDropdown.close();
        }
        addToShipmentTargetJids = null;
        addToShipmentModalOverlay.classList.remove("show");
        addToShipmentModal.classList.remove("show");
        addToShipmentModalOverlay.setAttribute("aria-hidden", "true");
        addToShipmentModal.setAttribute("aria-hidden", "true");

        if (addToShipmentError) {
          addToShipmentError.style.display = "none";
        }
      }

      function closeAddToNewShipmentModal() {
        if (!addToNewShipmentModal || !addToNewShipmentModalOverlay) return;
        addToNewShipmentModalOverlay.classList.remove("show");
        addToNewShipmentModal.classList.remove("show");
        addToNewShipmentModalOverlay.setAttribute("aria-hidden", "true");
        addToNewShipmentModal.setAttribute("aria-hidden", "true");

        if (addToNewShipmentError) {
          addToNewShipmentError.style.display = "none";
        }
      }

      function closeShipmentPressEmailModal() {
        if (!shipmentPressEmailModal || !shipmentPressEmailModalOverlay) return;
        shipmentPressEmailModalOverlay.classList.remove("show");
        shipmentPressEmailModal.classList.remove("show");
        shipmentPressEmailModalOverlay.setAttribute("aria-hidden", "true");
        shipmentPressEmailModal.setAttribute("aria-hidden", "true");
      }

      function openShipmentPressEmailModal() {
        if (!shipmentPressEmailModal || !shipmentPressEmailModalOverlay) return;
        shipmentPressEmailModalOverlay.classList.add("show");
        shipmentPressEmailModal.classList.add("show");
        shipmentPressEmailModalOverlay.setAttribute("aria-hidden", "false");
        shipmentPressEmailModal.setAttribute("aria-hidden", "false");
      }

      function renderShipmentPressOptions() {
        if (!shipmentPressSelect) return;
        const prevValue = String(shipmentPressSelect.value || "").trim();
        const items = getComunicatiItems();

        shipmentPressSelect.innerHTML = "";
        if (!items.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Nessun comunicato disponibile";
          shipmentPressSelect.appendChild(opt);
          updateShipmentPressLinksState();
          return;
        }

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Seleziona comunicato";
        shipmentPressSelect.appendChild(placeholder);

        for (const item of items) {
          const opt = document.createElement("option");
          opt.value = item.id;
          opt.textContent = item.label;
          shipmentPressSelect.appendChild(opt);
        }

        if (prevValue && items.some((x) => x.id === prevValue)) {
          shipmentPressSelect.value = prevValue;
        }

        updateShipmentPressLinksState();
      }

      function hasSelectedShipmentPressComunicato() {
        return !!String(shipmentPressSelect?.value || "").trim();
      }

      function updateShipmentSelectedComunicatoReadonly() {
        if (
          !shipmentSelectedComunicatoWrap ||
          !shipmentSelectedComunicatoText
        ) {
          return;
        }

        const shouldAppendComunicato =
          !!shipmentAppendComunicatoCheckbox?.checked;
        if (!shouldAppendComunicato) {
          shipmentSelectedComunicatoWrap.style.display = "none";
          shipmentSelectedComunicatoText.textContent = "";
          if (shipmentSelectedComunicatoTitle) {
            shipmentSelectedComunicatoTitle.textContent =
              "Comunicato selezionato";
          }
          return;
        }

        const selectedId = String(shipmentPressSelect?.value || "").trim();
        if (!selectedId) {
          shipmentSelectedComunicatoWrap.style.display = "none";
          shipmentSelectedComunicatoText.textContent = "";
          if (shipmentSelectedComunicatoTitle) {
            shipmentSelectedComunicatoTitle.textContent =
              "Comunicato selezionato";
          }
          return;
        }

        let bodyText = "";
        const idx = getComunicatoIndexById(selectedId);
        if (idx >= 0 && Array.isArray(appState.comunicati)) {
          const item = appState.comunicati[idx];
          if (item && typeof item === "object") {
            bodyText = String(item.bodyText || "");
          }
        }

        const selectedLabel = getComunicatoLabelById(selectedId);
        if (shipmentSelectedComunicatoTitle) {
          shipmentSelectedComunicatoTitle.textContent = selectedLabel
            ? `Comunicato selezionato · ${selectedLabel}`
            : "Comunicato selezionato";
        }
        shipmentSelectedComunicatoText.textContent = bodyText;
        shipmentSelectedComunicatoWrap.style.display = "flex";
      }

      function getShipmentSelectedComunicatoPublicUrl() {
        const selectedId = String(shipmentPressSelect?.value || "").trim();
        if (!selectedId) return "";

        const idx = getComunicatoIndexById(selectedId);
        if (idx < 0 || !Array.isArray(appState.comunicati)) return "";

        const item = appState.comunicati[idx];
        if (!item || typeof item !== "object") return "";

        const title = String(getComunicatoLabelById(selectedId) || "").trim();
        const body = String(item.bodyText || "");
        const url = new URL("public-comunicato.html", window.location.href);
        url.searchParams.set("id", selectedId);
        url.searchParams.set("title", title);
        url.searchParams.set("body", body);
        return url.toString();
      }

      function updateShipmentComunicatoPublicLinksState() {
        const hasSelectedComunicato = hasSelectedShipmentPressComunicato();
        const publicUrl = hasSelectedComunicato
          ? getShipmentSelectedComunicatoPublicUrl()
          : "";
        const hasPublicUrl = !!String(publicUrl || "").trim();

        if (shipmentComunicatoPublicLink) {
          shipmentComunicatoPublicLink.href = hasPublicUrl ? publicUrl : "#";
          shipmentComunicatoPublicLink.classList.toggle(
            "is-link-disabled",
            !hasPublicUrl,
          );
          shipmentComunicatoPublicLink.setAttribute(
            "aria-disabled",
            hasPublicUrl ? "false" : "true",
          );
        }

        if (shipmentComunicatoCopyLink) {
          shipmentComunicatoCopyLink.classList.toggle(
            "is-link-disabled",
            !hasPublicUrl,
          );
          shipmentComunicatoCopyLink.setAttribute(
            "aria-disabled",
            hasPublicUrl ? "false" : "true",
          );
        }
      }

      function updateShipmentPressLinksState() {
        const hasSelectedComunicato = hasSelectedShipmentPressComunicato();

        if (shipmentAppendComunicatoCheckbox) {
          shipmentAppendComunicatoCheckbox.disabled = !hasSelectedComunicato;
          if (!hasSelectedComunicato) {
            shipmentAppendComunicatoCheckbox.checked = false;
          }
        }

        updateShipmentSelectedComunicatoReadonly();
        updateShipmentComunicatoPublicLinksState();

        if (shipmentPressOpenLink) {
          shipmentPressOpenLink.classList.toggle(
            "is-link-disabled",
            !hasSelectedComunicato,
          );
          shipmentPressOpenLink.setAttribute(
            "aria-disabled",
            hasSelectedComunicato ? "false" : "true",
          );
        }

        const grid = document.getElementById("cardsGrid");
        if (!grid) return;
        grid.querySelectorAll(".card-customize-press-link").forEach((link) => {
          link.classList.toggle("is-link-disabled", !hasSelectedComunicato);
          link.setAttribute(
            "aria-disabled",
            hasSelectedComunicato ? "false" : "true",
          );
        });
      }

      function updateShipmentPressModeUI() {
        if (shipmentPressSelectWrap) {
          shipmentPressSelectWrap.style.display = "block";
        }
        if (shipmentPressInstructionsWrap) {
          shipmentPressInstructionsWrap.style.display = "block";
        }
        updateShipmentPressLinksState();
      }

      function computeUniqueSpedizioneName(baseName) {
        const base = String(baseName || "").trim();
        if (!base) return "";

        const existing = new Set(
          (appState.spedizioni || [])
            .map((x) =>
              String(x?.name || "")
                .trim()
                .toLowerCase(),
            )
            .filter(Boolean),
        );
        const baseKey = base.toLowerCase();
        if (!existing.has(baseKey)) return base;

        let i = 1;
        while (i < 1000) {
          const candidate = `${base} (${i})`;
          if (!existing.has(candidate.toLowerCase())) return candidate;
          i++;
        }
        return `${base} (${Date.now()})`;
      }

      function computeUniqueMailingListName(baseName) {
        const base = String(baseName || "").trim();
        if (!base) return "";

        const existing = new Set(
          (appState.mailingLists || [])
            .map((x) =>
              String(x?.name || "")
                .trim()
                .toLowerCase(),
            )
            .filter(Boolean),
        );

        const baseKey = base.toLowerCase();
        if (!existing.has(baseKey)) return base;

        let i = 1;
        while (i < 1000) {
          const candidate = `${base} (${i})`;
          if (!existing.has(candidate.toLowerCase())) {
            return candidate;
          }
          i++;
        }
        return `${base} (${Date.now()})`;
      }

      function computeDuplicatedMailingListName(originalName) {
        const base = String(originalName || "").trim();
        if (!base) return "";

        const existing = new Set(
          (appState.mailingLists || [])
            .map((x) =>
              String(x?.name || "")
                .trim()
                .toLowerCase(),
            )
            .filter(Boolean),
        );

        let i = 1;
        while (i < 1000) {
          const candidate = `${base} (${i})`;
          if (!existing.has(candidate.toLowerCase())) {
            return candidate;
          }
          i++;
        }
        return `${base} (${Date.now()})`;
      }

      function createMailingList(name, journalistIds) {
        const id = `ml_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const list = {
          id,
          name,
          journalistIds: Array.from(journalistIds || []),
          createdAt: Date.now(),
        };

        if (!Array.isArray(appState.mailingLists)) {
          appState.mailingLists = [];
        }
        appState.mailingLists.unshift(list);
        appState.activeMailingListId = id;
        saveAppState(appState);
        return list;
      }

      function duplicateActiveMailingList() {
        const active = getMailingListById(appState.activeMailingListId);
        if (!active) return null;

        const newName = computeDuplicatedMailingListName(active.name);
        if (!newName) return null;

        const id = `ml_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const list = {
          id,
          name: newName,
          journalistIds: Array.from(active.journalistIds || []),
          createdAt: Date.now(),
        };

        if (!Array.isArray(appState.mailingLists)) {
          appState.mailingLists = [];
        }
        appState.mailingLists.unshift(list);
        appState.activeMailingListId = id;
        saveAppState(appState);

        renderDashboardMailingLists();
        openMailingListById(id);
        return list;
      }

      function openMailingListById(id) {
        const list = getMailingListById(id);
        if (!list) return;
        appState.activeMailingListId = list.id;
        appState.activeSpedizioneSourceListId = "";
        appState.activeSpedizioneName = "";
        saveAppState(appState);
        window.location.hash = "#mailing-list";
        setActiveView("mailing-list", { save: true });
        scheduleRender();
      }

      function createSpedizioneFromMailingList(list) {
        if (!list) return null;
        const baseName = `Spedizione a ${String(list.name || "").trim()}`;
        const uniqueName = computeUniqueSpedizioneName(baseName);
        const shipment = {
          name: uniqueName,
          journalistIds: Array.isArray(list.journalistIds)
            ? Array.from(list.journalistIds)
            : [],
          createdAt: Date.now(),
          sourceMailingListId: String(list.id || "").trim(),
        };
        if (!Array.isArray(appState.spedizioni)) {
          appState.spedizioni = [];
        }
        appState.spedizioni.unshift(shipment);
        return shipment;
      }

      function createDashboardShipment() {
        const baseName = "nuova spedizione";
        const uniqueName = computeUniqueSpedizioneName(baseName);
        const shipment = {
          name: uniqueName,
          journalistIds: [],
          createdAt: Date.now(),
          sourceMailingListId: "",
        };

        if (!Array.isArray(appState.spedizioni)) {
          appState.spedizioni = [];
        }
        appState.spedizioni.unshift(shipment);

        activeSpedizioneRef = shipment;
        appState.activeSpedizioneName = uniqueName;
        appState.activeSpedizioneSourceListId = "";
        applyShipmentSelectedRecipientListIds([], {
          save: false,
          syncDropdown: true,
        });
        applyShipmentSelectedRecipientJournalistIds([], {
          syncDropdown: true,
        });

        saveAppState(appState);
        renderDashboardSpedizioni();
        window.location.hash = "#spedisci-lista";
        setActiveView("spedisci-lista", { save: true });
      }

      function createSpedizioneFromSelectedJournalists() {
        const selectionSnapshot = selectedJournalistOrder.filter((jid) =>
          selectedJournalistIds.has(jid),
        );
        if (!selectionSnapshot.length) return;

        const activeList = getMailingListById(appState.activeMailingListId);
        const baseName = activeList
          ? `Spedizione a ${String(activeList.name || "").trim()}`
          : "Spedizione";
        const uniqueName = computeUniqueSpedizioneName(baseName);

        const shipment = {
          name: uniqueName,
          journalistIds: Array.from(selectionSnapshot),
          createdAt: Date.now(),
          sourceMailingListId: "",
        };
        if (!Array.isArray(appState.spedizioni)) {
          appState.spedizioni = [];
        }
        appState.spedizioni.unshift(shipment);

        activeSpedizioneRef = shipment;
        appState.activeSpedizioneName = uniqueName;
        appState.activeSpedizioneSourceListId = "";
        applyShipmentSelectedRecipientListIds([], {
          save: false,
          syncDropdown: true,
        });
        applyShipmentSelectedRecipientJournalistIds(selectionSnapshot, {
          syncDropdown: true,
        });

        saveAppState(appState);
        renderDashboardSpedizioni();

        selectedJournalistIds.clear();
        selectedJournalistOrder.length = 0;
        renderSelectedPanelList();
        closeSelectedPanel();

        window.location.hash = "#spedisci-lista";
        setActiveView("spedisci-lista", { save: true });
      }

      function openSpedisciListaView() {
        const list = getMailingListById(appState.activeMailingListId);
        if (!list) return;

        const created = createSpedizioneFromMailingList(list);
        activeSpedizioneRef = created || null;
        appState.activeSpedizioneSourceListId = String(list.id || "");
        appState.activeSpedizioneName = String(created?.name || "");
        saveAppState(appState);
        renderDashboardSpedizioni();
        window.location.hash = "#spedisci-lista";
        setActiveView("spedisci-lista", { save: true });
      }

      function openSpedizioneByName(name) {
        const shipment = getSpedizioneByName(name);
        if (!shipment) return;
        activeSpedizioneRef = shipment;

        const shipmentJournalistIds = Array.isArray(shipment.journalistIds)
          ? shipment.journalistIds
          : [];
        applyShipmentSelectedRecipientListIds([], {
          save: false,
          syncDropdown: true,
        });
        applyShipmentSelectedRecipientJournalistIds(shipmentJournalistIds, {
          syncDropdown: true,
        });

        const sourceListId = String(shipment.sourceMailingListId || "").trim();
        appState.activeSpedizioneName = String(shipment.name || "").trim();
        appState.activeSpedizioneSourceListId = sourceListId;
        if (sourceListId) {
          appState.activeMailingListId = sourceListId;
        }
        saveAppState(appState);

        window.location.hash = "#spedisci-lista";
        setActiveView("spedisci-lista", { save: true });
      }

      function renderDashboardMailingLists() {
        const lists = Array.isArray(appState.mailingLists)
          ? appState.mailingLists
          : [];

        function renderMailingListsInto(targetEl) {
          if (!targetEl) return;
          targetEl.innerHTML = "";
          const isDashboardList = targetEl === dashboardMailingListsEl;
          const filterTerm = isDashboardList
            ? String(dashboardMailingListsFilterInput?.value || "")
                .trim()
                .toLowerCase()
            : "";
          const visibleLists = filterTerm
            ? lists.filter((ml) =>
                String(ml?.name || "")
                  .toLowerCase()
                  .includes(filterTerm),
              )
            : lists;

          if (visibleLists.length === 0) {
            const empty = document.createElement("div");
            const isSavedEmptyState = !filterTerm;
            empty.className = isSavedEmptyState
              ? "muted dashboard-empty-state"
              : "muted";
            empty.textContent = isSavedEmptyState
              ? "Nessuna mailing list salvata"
              : "Nessuna mailing list trovata";
            targetEl.appendChild(empty);
            return;
          }

          const container = document.createElement("div");
          container.className = "dashboard-mailing-lists";

          for (const ml of visibleLists) {
            if (!ml || typeof ml !== "object") continue;
            const id = String(ml.id || "").trim();
            const name = String(ml.name || "").trim();
            const count = Array.isArray(ml.journalistIds)
              ? ml.journalistIds.length
              : 0;
            const createdAt = Number(ml.createdAt || 0);
            if (!id || !name) continue;

            const row = document.createElement("div");
            row.className = "dashboard-mailing-list-item";

            const left = document.createElement("div");
            left.className = "dashboard-mailing-list-left";

            const title = document.createElement("a");
            title.href = "#";
            title.className = "dashboard-mailing-list-link";
            if (isDashboardList && filterTerm) {
              title.innerHTML = highlightHtml(name, filterTerm);
            } else {
              title.textContent = name;
            }
            title.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              if (typeof clearAllFilters === "function") {
                clearAllFilters();
              }
              openMailingListById(id);
            });

            const meta = document.createElement("div");
            meta.className = "dashboard-mailing-list-meta";
            if (Number.isFinite(createdAt) && createdAt > 0) {
              const stamp = new Date(createdAt).toLocaleDateString("it-IT");
              meta.textContent = `creata il ${stamp}`;
            } else {
              meta.textContent = "";
            }

            left.appendChild(title);
            if (meta.textContent) left.appendChild(meta);

            const pill = document.createElement("span");
            pill.className = "pill";
            pill.textContent = String(count);

            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.className = "dashboard-mailing-list-delete";
            deleteBtn.setAttribute("aria-label", `Elimina ${name}`);
            deleteBtn.textContent = "×";
            deleteBtn.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();

              const ok = window.confirm(`Eliminare la mailing list "${name}"?`);
              if (!ok) return;

              appState.mailingLists = (appState.mailingLists || []).filter(
                (x) => String(x?.id || "") !== id,
              );
              if (String(appState.activeMailingListId || "") === id) {
                appState.activeMailingListId = "";
              }
              saveAppState(appState);
              renderDashboardMailingLists();
            });

            const actions = document.createElement("div");
            actions.className = "dashboard-mailing-list-actions";
            actions.appendChild(pill);
            actions.appendChild(deleteBtn);

            row.appendChild(left);
            row.appendChild(actions);
            container.appendChild(row);
          }

          targetEl.appendChild(container);
        }

        renderMailingListsInto(dashboardMailingListsEl);
        renderMailingListsInto(mailingListsMailingListsEl);
      }

      function renderDashboardSpedizioni() {
        const shipments = Array.isArray(appState.spedizioni)
          ? appState.spedizioni
          : [];

        function renderSpedizioniInto(targetEl) {
          if (!targetEl) return;
          targetEl.innerHTML = "";
          const isDashboardList = targetEl === dashboardShipmentsEl;
          const filterTerm = isDashboardList
            ? String(dashboardShipmentsFilterInput?.value || "")
                .trim()
                .toLowerCase()
            : "";
          const visibleShipments = filterTerm
            ? shipments.filter((s) =>
                String(s?.name || "")
                  .toLowerCase()
                  .includes(filterTerm),
              )
            : shipments;

          if (!visibleShipments.length) {
            const empty = document.createElement("div");
            const isSavedEmptyState = !filterTerm;
            empty.className = isSavedEmptyState
              ? "muted dashboard-empty-state"
              : "muted";
            empty.textContent = isSavedEmptyState
              ? "Nessuna spedizione salvata"
              : "Nessuna spedizione trovata";
            targetEl.appendChild(empty);
            return;
          }

          const container = document.createElement("div");
          container.className = "dashboard-mailing-lists";

          for (const s of visibleShipments) {
            if (!s || typeof s !== "object") continue;
            const name = String(s.name || "").trim();
            if (!name) continue;
            const count = Array.isArray(s.journalistIds)
              ? s.journalistIds.length
              : 0;
            const createdAt = Number(s.createdAt || 0);

            const row = document.createElement("div");
            row.className = "dashboard-mailing-list-item";

            const left = document.createElement("div");
            left.className = "dashboard-mailing-list-left";

            const title = document.createElement("a");
            title.href = "#";
            title.className = "dashboard-mailing-list-link";
            if (isDashboardList && filterTerm) {
              title.innerHTML = highlightHtml(name, filterTerm);
            } else {
              title.textContent = name;
            }
            title.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              openSpedizioneByName(name);
            });

            const meta = document.createElement("div");
            meta.className = "dashboard-mailing-list-meta";
            if (Number.isFinite(createdAt) && createdAt > 0) {
              const stamp = new Date(createdAt).toLocaleDateString("it-IT");
              meta.textContent = `creata il ${stamp}`;
            }

            left.appendChild(title);
            if (meta.textContent) left.appendChild(meta);

            const actions = document.createElement("div");
            actions.className = "dashboard-mailing-list-actions";

            const pill = document.createElement("span");
            pill.className = "pill";
            pill.textContent = String(count);
            actions.appendChild(pill);

            if (isDashboardList) {
              const deleteBtn = document.createElement("button");
              deleteBtn.type = "button";
              deleteBtn.className = "dashboard-mailing-list-delete";
              deleteBtn.setAttribute("aria-label", `Elimina ${name}`);
              deleteBtn.textContent = "×";
              deleteBtn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();

                const ok = window.confirm(`Eliminare la spedizione "${name}"?`);
                if (!ok) return;

                appState.spedizioni = (appState.spedizioni || []).filter(
                  (x) => x !== s,
                );
                if (activeSpedizioneRef === s) {
                  activeSpedizioneRef = null;
                  appState.activeSpedizioneName = "";
                  appState.activeSpedizioneSourceListId = "";
                }
                saveAppState(appState);
                renderDashboardSpedizioni();
              });
              actions.appendChild(deleteBtn);
            }

            row.appendChild(left);
            row.appendChild(actions);
            container.appendChild(row);
          }

          targetEl.appendChild(container);
        }

        renderSpedizioniInto(dashboardShipmentsEl);
        renderSpedizioniInto(spedizioniShipmentsEl);
      }

      function renderDashboardComunicati() {
        if (!dashboardComunicatiEl) return;
        dashboardComunicatiEl.innerHTML = "";

        const filterTerm = String(dashboardComunicatiFilterInput?.value || "")
          .trim()
          .toLowerCase();
        const allItems = getComunicatiItems();
        const items = filterTerm
          ? allItems.filter((item) =>
              String(item?.label || "")
                .toLowerCase()
                .includes(filterTerm),
            )
          : allItems;
        if (!items.length) {
          const empty = document.createElement("div");
          const isSavedEmptyState = !filterTerm;
          empty.className = isSavedEmptyState
            ? "muted dashboard-empty-state"
            : "muted";
          empty.textContent = isSavedEmptyState
            ? "Nessun comunicato salvato"
            : "Nessun comunicato trovato";
          dashboardComunicatiEl.appendChild(empty);
          return;
        }

        const comunicatiById = new Map(
          (Array.isArray(appState.comunicati) ? appState.comunicati : [])
            .map((item, i) => {
              if (!item || typeof item !== "object") return null;
              const label = String(
                item.title || item.name || item.subject || item.oggetto || "",
              ).trim();
              const id = String(item.id || label || i).trim();
              if (!id) return null;
              return [id, item];
            })
            .filter(Boolean),
        );

        const container = document.createElement("div");
        container.className = "dashboard-mailing-lists";

        for (const item of items) {
          const id = String(item?.id || "").trim();
          const name = String(item?.label || "").trim();
          if (!id || !name) continue;
          const full = comunicatiById.get(id);
          const createdAt = Number(full?.createdAt || 0);

          const row = document.createElement("div");
          row.className = "dashboard-mailing-list-item";

          const left = document.createElement("div");
          left.className = "dashboard-mailing-list-left";

          const title = document.createElement("a");
          title.href = "#";
          title.className = "dashboard-mailing-list-link";
          if (filterTerm) {
            title.innerHTML = highlightHtml(name, filterTerm);
          } else {
            title.textContent = name;
          }
          title.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            activeComunicatoId = id;
            setNewPressPanelTitle(name);
            openNewPressPanel({ source: "dashboard" });
          });

          const meta = document.createElement("div");
          meta.className = "dashboard-mailing-list-meta";
          if (Number.isFinite(createdAt) && createdAt > 0) {
            const stamp = new Date(createdAt).toLocaleDateString("it-IT");
            meta.textContent = `creato il ${stamp}`;
          }

          left.appendChild(title);
          if (meta.textContent) left.appendChild(meta);

          const actions = document.createElement("div");
          actions.className = "dashboard-mailing-list-actions";

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "dashboard-mailing-list-delete";
          deleteBtn.setAttribute("aria-label", `Elimina ${name}`);
          deleteBtn.textContent = "×";
          deleteBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();

            const ok = window.confirm(`Eliminare il comunicato "${name}"?`);
            if (!ok) return;

            const before = Array.isArray(appState.comunicati)
              ? appState.comunicati
              : [];
            appState.comunicati = before.filter((entry, i) => {
              if (typeof entry === "string") {
                return String(entry || "").trim() !== id;
              }
              if (!entry || typeof entry !== "object") return true;
              const label = String(
                entry.title ||
                  entry.name ||
                  entry.subject ||
                  entry.oggetto ||
                  "",
              ).trim();
              const entryId = String(entry.id || label || i).trim();
              return entryId !== id;
            });

            if (String(activeComunicatoId || "").trim() === id) {
              activeComunicatoId = "";
            }
            saveAppState(appState);
            renderShipmentPressOptions();
            renderDashboardComunicati();
          });
          actions.appendChild(deleteBtn);

          row.appendChild(left);
          row.appendChild(actions);
          container.appendChild(row);
        }

        dashboardComunicatiEl.appendChild(container);
      }

      function escapeRegExp(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      const NOTE_MAX_CHARS = 120;
      const NOTE_MATCH_MAX_CHARS = 80;

      function normalizeNotes(note) {
        if (Array.isArray(note)) {
          return note
            .map((x) =>
              typeof x === "object" && x && "text" in x
                ? String(x.text ?? "").trim()
                : String(x ?? "").trim(),
            )
            .filter((x) => x.length > 0);
        }
        const s = String(note ?? "").trim();
        return s ? [s] : [];
      }

      function normalizeNoteItems(note) {
        if (Array.isArray(note)) {
          return note
            .map((x) => {
              if (typeof x === "object" && x) {
                return {
                  text: String(x.text ?? "").trim(),
                  updatedAt: x.updatedAt ? String(x.updatedAt) : "",
                };
              }
              return { text: String(x ?? "").trim(), updatedAt: "" };
            })
            .filter((x) => x.text.length > 0);
        }

        const s = String(note ?? "").trim();
        return s ? [{ text: s, updatedAt: "" }] : [];
      }

      function formatNoteDate(value) {
        const raw = String(value || "").trim();
        if (!raw) return "n/d";
        const d = new Date(raw);
        if (Number.isNaN(d.getTime())) return "n/d";
        return d.toLocaleDateString("it-IT");
      }

      function combineNotes(notesArr) {
        return (notesArr || []).join(" • ");
      }

      function makeSnippet(text, query, maxChars) {
        const raw = String(text ?? "");
        const q = String(query ?? "")
          .trim()
          .toLowerCase();
        if (!raw) return "";
        if (raw.length <= maxChars) return raw;

        const rawLower = raw.toLowerCase();
        const idx = q ? rawLower.indexOf(q) : -1;

        let start = 0;
        const anchoredToMatch = idx >= 0;
        if (idx >= 0) {
          start = Math.max(0, idx);

          const back = raw.lastIndexOf(" ", idx);
          if (back >= 0 && back < idx) {
            start = Math.max(0, back + 1);
          }
        }
        let end = start + maxChars;
        if (end > raw.length) {
          end = raw.length;
          if (!anchoredToMatch) {
            start = Math.max(0, end - maxChars);
          }
        }

        const prefix = start > 0 ? "..." : "";
        const suffix = end < raw.length ? "..." : "";
        return `${prefix}${raw.slice(start, end)}${suffix}`;
      }

      function highlightHtml(text, query) {
        const raw = String(text ?? "");
        const q = String(query ?? "").trim();
        if (!q) return escapeHtml(raw);

        const re = new RegExp(escapeRegExp(q), "gi");
        let out = "";
        let lastIndex = 0;
        let match;
        while ((match = re.exec(raw)) !== null) {
          const start = match.index;
          const end = start + match[0].length;
          out += escapeHtml(raw.slice(lastIndex, start));
          out += `<span class="highlight">${escapeHtml(
            raw.slice(start, end),
          )}</span>`;
          lastIndex = end;
          if (match[0].length === 0) break;
        }
        out += escapeHtml(raw.slice(lastIndex));
        return out;
      }

      function highlightHtmlMulti(text, queries) {
        const raw = String(text ?? "");
        const terms = (queries || [])
          .map((x) => String(x ?? "").trim())
          .filter(Boolean);
        if (!terms.length) return escapeHtml(raw);

        const uniq = [];
        const seen = new Set();
        for (const t of terms) {
          const k = t.toLowerCase();
          if (seen.has(k)) continue;
          seen.add(k);
          uniq.push(t);
        }

        uniq.sort((a, b) => b.length - a.length);
        const re = new RegExp(uniq.map((t) => escapeRegExp(t)).join("|"), "gi");

        let out = "";
        let lastIndex = 0;
        let match;
        while ((match = re.exec(raw)) !== null) {
          const start = match.index;
          const end = start + match[0].length;
          out += escapeHtml(raw.slice(lastIndex, start));
          out += `<span class="highlight">${escapeHtml(
            raw.slice(start, end),
          )}</span>`;
          lastIndex = end;
          if (match[0].length === 0) break;
        }
        out += escapeHtml(raw.slice(lastIndex));
        return out;
      }

      function getActiveTextTerms() {
        const current = String(textFilterInput?.value || "").trim();
        const terms = [...committedTextTerms];
        if (current) terms.push(current);
        return terms;
      }

      function getHighlightTextTerms() {
        const current = String(textFilterInput?.value || "").trim();
        return current ? [current] : [];
      }

      function findBestMatchTerm(haystack, terms) {
        const h = String(haystack || "").toLowerCase();
        let best = null;
        let bestIdx = Infinity;
        for (const t of terms || []) {
          const q = String(t || "")
            .trim()
            .toLowerCase();
          if (!q) continue;
          const idx = h.indexOf(q);
          if (idx >= 0 && idx < bestIdx) {
            bestIdx = idx;
            best = t;
          }
        }
        return best;
      }

      function updateCardSelectionUI(jid) {
        const cards = document.querySelectorAll(
          `.card[data-jid="${CSS.escape(jid)}"]`,
        );
        if (!cards.length) return;
        for (const card of cards) {
          if (selectedJournalistIds.has(jid)) {
            card.classList.add("is-selected");
          } else {
            card.classList.remove("is-selected");
          }
        }
      }

      function updateCheckboxUI(jid) {
        const checkboxes = document.querySelectorAll(
          `.card-select[data-jid="${CSS.escape(
            jid,
          )}"], .testata-panel-select[data-jid="${CSS.escape(jid)}"]`,
        );
        if (!checkboxes.length) return;
        for (const checkbox of checkboxes) {
          checkbox.checked = selectedJournalistIds.has(jid);
        }
      }

      function renderSelectedPanelList() {
        if (!selectedPanelBody) return;
        const selectedCountEl = document.getElementById("selectedCountPill");
        if (selectedCountEl) {
          selectedCountEl.textContent = String(selectedJournalistIds.size || 0);
        }

        if (selectedInListRow) {
          selectedInListRow.style.display = "none";
        }

        if (appState.view === "mailing-list") {
          const activeList = getMailingListById(appState.activeMailingListId);
          if (activeList && Array.isArray(activeList.journalistIds)) {
            const allowed = new Set(activeList.journalistIds);
            let inListCount = 0;
            for (const jid of selectedJournalistIds) {
              if (allowed.has(jid)) inListCount++;
            }
            if (inListCount > 0 && selectedInListRow) {
              if (selectedInListCount) {
                selectedInListCount.textContent = String(inListCount);
              }
              selectedInListRow.style.display = "flex";
            }
          }
        }

        selectedPanelBody.innerHTML = "";

        if (selectedJournalistOrder.length === 0) {
          return;
        }

        const list = document.createElement("div");
        list.className = "selected-list";

        for (const jid of selectedJournalistOrder) {
          if (!selectedJournalistIds.has(jid)) continue;

          const item = document.createElement("div");
          item.className = "selected-item";

          const left = document.createElement("div");
          left.className = "selected-item-left";

          const parts = getJournalistNamePartsById(jid);

          const nameLink = document.createElement("a");
          nameLink.href = "#";
          nameLink.className = "selected-item-name journalist-link";
          nameLink.setAttribute("data-journalist", parts.full);
          nameLink.setAttribute("aria-label", "apri scheda");
          nameLink.setAttribute("title", "apri scheda");

          const firstSpan = document.createElement("span");
          firstSpan.className = "selected-item-first-name";
          firstSpan.textContent = parts.firstName;

          const lastSpan = document.createElement("span");
          lastSpan.className = "selected-item-last-name";
          lastSpan.textContent = parts.lastName || parts.full;
          lastSpan.setAttribute("title", parts.full);

          nameLink.appendChild(firstSpan);
          nameLink.appendChild(lastSpan);

          const remove = document.createElement("button");
          remove.type = "button";
          remove.className = "selected-item-remove";
          remove.textContent = "×";
          remove.setAttribute("data-jid", jid);

          left.appendChild(nameLink);
          item.appendChild(left);
          item.appendChild(remove);
          list.appendChild(item);
        }

        selectedPanelBody.appendChild(list);
        scheduleUpdateSelectedNameLayouts();
      }

      if (selectedRemoveFromListLink) {
        selectedRemoveFromListLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          if (appState.view !== "mailing-list") return;
          const activeList = getMailingListById(appState.activeMailingListId);
          if (!activeList || !Array.isArray(activeList.journalistIds)) return;

          const allowed = new Set(activeList.journalistIds);
          const toRemove = [];
          for (const jid of selectedJournalistIds) {
            if (allowed.has(jid)) toRemove.push(jid);
          }
          if (!toRemove.length) return;

          const toRemoveSet = new Set(toRemove);
          activeList.journalistIds = (activeList.journalistIds || []).filter(
            (jid) => !toRemoveSet.has(jid),
          );
          saveAppState(appState);

          for (const jid of toRemove) {
            selectedJournalistIds.delete(jid);
            removeFromSelectedOrder(jid);
            updateCheckboxUI(jid);
            updateCardSelectionUI(jid);
          }

          if (selectedJournalistIds.size === 0) {
            closeSelectedPanel();
          } else {
            renderSelectedPanelList();
          }

          showToast(formatRemovedFromListToast(toRemove.length));
          scheduleRender();
        });
      }

      function createCard(j, externalHighlightTerms = []) {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.servizio = j.servizio;
        card.dataset.ruolo = j.ruolo;

        const rawFirstName = String(j?.nome || "").trim();
        const rawLastName = String(j?.cognome || "").trim();
        const fullName = `${rawFirstName} ${rawLastName}`.trim();
        card.dataset.fullName = fullName;

        const normalizeText = (v) => String(v ?? "").trim();

        const pickProgramPhone = () => {
          const items = Array.isArray(j?.programPhones) ? j.programPhones : [];
          for (const it of items) {
            if (it && typeof it === "object" && it.isPrimary) {
              const v = normalizeText(it.number ?? it.tel ?? it.value);
              if (v) return v;
            }
          }
          const first = items.length
            ? normalizeText(
                items[0]?.number ??
                  items[0]?.tel ??
                  items[0]?.value ??
                  items[0],
              )
            : "";
          return first || normalizeText(j?.telefono);
        };

        const pickProgramEmail = () => {
          const items = Array.isArray(j?.programEmails) ? j.programEmails : [];
          for (const it of items) {
            if (it && typeof it === "object" && it.isDefault) {
              const v = normalizeText(it.email ?? it.value);
              if (v) return v;
            }
          }
          const first = items.length
            ? normalizeText(items[0]?.email ?? items[0]?.value ?? items[0])
            : "";
          return first || normalizeText(j?.email);
        };

        const cardPhone = (() => {
          const custom = Array.isArray(j?.customPhones) ? j.customPhones : [];
          const at = (idx) =>
            normalizeText(
              custom?.[idx]?.number ??
                custom?.[idx]?.tel ??
                custom?.[idx]?.value ??
                custom?.[idx],
            );
          const pref = j?.preferredPhone;
          if (pref && pref.origin === "custom" && Number.isFinite(pref.index)) {
            const v = at(pref.index);
            if (v) return v;
          }
          if (
            pref &&
            pref.origin === "program" &&
            Number.isFinite(pref.index)
          ) {
            const items = Array.isArray(j?.programPhones)
              ? j.programPhones
              : [];
            const v = normalizeText(
              items?.[pref.index]?.number ??
                items?.[pref.index]?.tel ??
                items?.[pref.index]?.value ??
                items?.[pref.index],
            );
            if (v) return v;
          }
          for (const it of custom) {
            if (it && typeof it === "object" && it.isPrimary) {
              const v = normalizeText(it.number ?? it.tel ?? it.value);
              if (v) return v;
            }
          }
          const program = pickProgramPhone();
          if (program) return program;
          return at(0);
        })();

        const cardEmail = (() => {
          const custom = Array.isArray(j?.customEmails) ? j.customEmails : [];
          const at = (idx) =>
            normalizeText(
              custom?.[idx]?.email ?? custom?.[idx]?.value ?? custom?.[idx],
            );
          const pref = j?.preferredEmail;
          if (pref && pref.origin === "custom" && Number.isFinite(pref.index)) {
            const v = at(pref.index);
            if (v) return v;
          }
          if (
            pref &&
            pref.origin === "program" &&
            Number.isFinite(pref.index)
          ) {
            const items = Array.isArray(j?.programEmails)
              ? j.programEmails
              : [];
            const v = normalizeText(
              items?.[pref.index]?.email ??
                items?.[pref.index]?.value ??
                items?.[pref.index],
            );
            if (v) return v;
          }
          for (const it of custom) {
            if (it && typeof it === "object" && it.isDefault) {
              const v = normalizeText(it.email ?? it.value);
              if (v) return v;
            }
          }
          const program = pickProgramEmail();
          if (program) return program;
          return at(0);
        })();

        const cardEmailOptions = (() => {
          const out = [];
          const seen = new Set();
          const pushUnique = (value) => {
            const v = normalizeText(value);
            if (!v) return;
            const key = v.toLowerCase();
            if (seen.has(key)) return;
            seen.add(key);
            out.push(v);
          };

          const custom = Array.isArray(j?.customEmails) ? j.customEmails : [];
          for (const it of custom) {
            if (it && typeof it === "object") {
              pushUnique(it.email ?? it.value);
            } else {
              pushUnique(it);
            }
          }

          const program = Array.isArray(j?.programEmails)
            ? j.programEmails
            : [];
          for (const it of program) {
            if (it && typeof it === "object") {
              pushUnique(it.email ?? it.value);
            } else {
              pushUnique(it);
            }
          }

          pushUnique(j?.email);

          const preferred = normalizeText(cardEmail);
          if (preferred) {
            const idx = out.findIndex(
              (x) => x.toLowerCase() === preferred.toLowerCase(),
            );
            if (idx > 0) {
              const [item] = out.splice(idx, 1);
              out.unshift(item);
            } else if (idx < 0) {
              out.unshift(preferred);
            }
          }

          return out;
        })();

        const jid = getJournalistId(j);
        card.dataset.jid = jid;
        const isSelected = selectedJournalistIds.has(jid);
        if (isSelected) {
          card.classList.add("is-selected");
        }

        const checkboxId = `card-select-${jid.replace(/[^a-zA-Z0-9_-]/g, "_")}`;

        const activeTerms = (() => {
          const base = getHighlightTextTerms();
          const extra = Array.isArray(externalHighlightTerms)
            ? externalHighlightTerms
            : [];
          return [...base, ...extra].filter((x) => String(x || "").trim());
        })();
        const highlightedFirstName = highlightHtmlMulti(
          rawFirstName,
          activeTerms,
        );
        const highlightedLastName = highlightHtmlMulti(
          rawLastName,
          activeTerms,
        );
        const isSpedizioneCardView = appState.view === "spedisci-lista";
        const highlightedEmail = cardEmail
          ? highlightHtmlMulti(cardEmail, activeTerms)
          : '<span class="muted">n/d</span>';
        const emailFieldHtml = isSpedizioneCardView
          ? cardEmailOptions.length > 1
            ? `<select class="card-email-select" aria-label="email destinatario">${cardEmailOptions
                .map((email, idx) => {
                  const isSelected =
                    idx === 0 ||
                    normalizeText(email).toLowerCase() ===
                      normalizeText(cardEmail).toLowerCase();
                  return `<option value="${escapeHtml(email)}"${isSelected ? " selected" : ""}>${escapeHtml(email)}</option>`;
                })
                .join("")}</select>`
            : `<span class="t-value t-no-transform card-email-inline-text">${highlightedEmail}</span>`
          : highlightedEmail;
        const testate = getJournalistTestate(j);
        const testatePreviewHtml = testate.length
          ? testate
              .map((tname) => {
                const label = escapeHtml(tname);
                return `<a href="#" class="testata-link" data-testata="${escapeHtml(
                  tname,
                )}">${label}</a>`;
              })
              .join(" • ")
          : '<span class="muted">n/d</span>';
        const testateRowHtml = isSpedizioneCardView
          ? ""
          : `<div class="card-row"><div class="card-label"><span class="card-journalist-testate-label" data-jid="${jid}">Testate</span></div><div class="card-value card-testate">${testatePreviewHtml}</div></div>`;
        let noteRowHtml = "";
        if (!isSpedizioneCardView) {
          const notesArr = normalizeNotes(j.note);

          const notesCombined = combineNotes(notesArr);
          const notePreviewBaseRaw = (() => {
            if (!notesArr.length) return "nessuna nota";

            const best = findBestMatchTerm(notesCombined, activeTerms);
            if (best)
              return makeSnippet(notesCombined, best, NOTE_MATCH_MAX_CHARS);

            if (notesArr.length === 1) {
              if (notesCombined.length > NOTE_MAX_CHARS) {
                return makeSnippet(notesCombined, "", NOTE_MAX_CHARS);
              }
              return notesCombined;
            }

            return String(notesArr[0] || "");
          })();

          const hasHiddenNotesContent =
            notesArr.length > 1 ||
            (notesCombined &&
              notePreviewBaseRaw &&
              notesCombined.length > notePreviewBaseRaw.length);

          const noteDisplayRaw =
            notesArr.length &&
            hasHiddenNotesContent &&
            !notePreviewBaseRaw.endsWith("...")
              ? `${notePreviewBaseRaw}...`
              : notePreviewBaseRaw;

          const noteShowsEllipsis =
            notesArr.length &&
            typeof noteDisplayRaw === "string" &&
            noteDisplayRaw.includes("...");

          const highlightedNote = notesArr.length
            ? highlightHtmlMulti(noteDisplayRaw, activeTerms)
            : '<em class="muted">nessuna nota</em>';

          noteRowHtml = `<div class="card-row"><div class="card-label">${
            noteShowsEllipsis
              ? `<a href="#" class="card-label-link card-notes-open" data-jid="${jid}">Note</a>`
              : "Note"
          }</div><div class="card-value muted card-note">${highlightedNote}</div></div>`;
        }

        const removeFromListHtml =
          appState.view === "mailing-list"
            ? `<button type="button" class="c-pill card-remove-from-list" data-remove-from-list-jid="${jid}" aria-label="rimuovi da lista">×</button>`
            : "";

        const customizeComunicatoHtml = "";
        const servizioRowHtml = isSpedizioneCardView
          ? ""
          : `<div class="card-row"><div class="card-label">Servizio</div><div class="card-value">${j.servizio}</div></div>`;
        const telefonoRowHtml = isSpedizioneCardView
          ? ""
          : `<div class="card-row"><div class="card-label">Telefono</div><div class="card-value">${cardPhone}</div></div>`;
        const emailInlineHtml = isSpedizioneCardView
          ? `<div class="card-email-inline-wrap">${emailFieldHtml}</div>`
          : "";
        const emailRowHtml = isSpedizioneCardView
          ? ""
          : `<div class="card-row"><div class="card-label">E-mail</div><div class="card-value">${emailFieldHtml}</div></div>`;
        const ruoloHtml = isSpedizioneCardView
          ? ""
          : `<p class="card-role">${j.ruolo}</p>`;
        const cardSelectCheckboxHtml = isSpedizioneCardView
          ? ""
          : `<input
                class="card-select"
                type="checkbox"
                id="${checkboxId}"
                data-jid="${jid}"
                ${isSelected ? "checked" : ""}
              />`;

        card.innerHTML = `
          ${removeFromListHtml}
          <div class="card-top">
            <div class="card-name-row">
              ${cardSelectCheckboxHtml}
              <a
                href="#"
                class="journalist-link card-name-link"
                data-journalist="${escapeHtml(fullName)}"
                aria-label="apri scheda"
                title="apri scheda"
              >
                <h3 class="card-name card-name--person"><span class="card-first-name">${highlightedFirstName}</span><span class="card-last-name" title="${escapeHtml(fullName)}">${highlightedLastName}</span></h3>
              </a>
              ${ruoloHtml}
            </div>
            ${emailInlineHtml}
          </div>
          ${servizioRowHtml}
          ${telefonoRowHtml}
          ${emailRowHtml}
          ${testateRowHtml}
          ${noteRowHtml}
          ${customizeComunicatoHtml}
        `;
        return card;
      }

      const CARD_TOP_MIN_GAP_PX = 8;
      let cardNameLayoutRaf = 0;
      let cardsGridResizeObserver = null;

      function updateCardNameLayout(card) {
        if (!card) return;
        const nameRow = card.querySelector(".card-top .card-name-row");
        const schedaLink = card.querySelector(
          ".card-top .card-name-row .journalist-link",
        );
        const lastNameEl = card.querySelector(
          ".card-name.card-name--person .card-last-name",
        );
        const fullName = String(card.dataset.fullName || "").trim();

        if (lastNameEl && fullName) {
          lastNameEl.setAttribute("title", fullName);
        }

        if (!nameRow || !schedaLink || !lastNameEl) return;

        card.classList.remove("card--hide-first-name");

        const lastNameIsTruncated =
          lastNameEl.scrollWidth - lastNameEl.clientWidth > 0;

        const shouldHideFirstName = lastNameIsTruncated;

        if (shouldHideFirstName) {
          card.classList.add("card--hide-first-name");
        }
      }

      function scheduleUpdateCardNameLayouts() {
        if (cardNameLayoutRaf) return;
        cardNameLayoutRaf = requestAnimationFrame(() => {
          cardNameLayoutRaf = 0;
          const grid = document.getElementById("cardsGrid");
          if (!grid) return;
          for (const card of grid.querySelectorAll(".card")) {
            updateCardNameLayout(card);
          }
        });
      }

      function createTestataCard(t, activeTerms) {
        const card = document.createElement("div");
        card.className = "card card--testata";
        card.dataset.testataKey = String(t?.id || "");

        const notesArr = normalizeNotes(t?.note);
        const notesCombined = combineNotes(notesArr);
        const notePreviewBaseRaw = (() => {
          if (!notesArr.length) return "nessuna nota";

          const best = findBestMatchTerm(notesCombined, activeTerms);
          if (best)
            return makeSnippet(notesCombined, best, NOTE_MATCH_MAX_CHARS);

          if (notesArr.length === 1) {
            if (notesCombined.length > NOTE_MAX_CHARS) {
              return makeSnippet(notesCombined, "", NOTE_MAX_CHARS);
            }
            return notesCombined;
          }

          return String(notesArr[0] || "");
        })();

        const hasHiddenNotesContent =
          notesArr.length > 1 ||
          (notesCombined &&
            notePreviewBaseRaw &&
            notesCombined.length > notePreviewBaseRaw.length);

        const noteDisplayRaw =
          notesArr.length &&
          hasHiddenNotesContent &&
          !notePreviewBaseRaw.endsWith("...")
            ? `${notePreviewBaseRaw}...`
            : notePreviewBaseRaw;

        const noteShowsEllipsis =
          notesArr.length &&
          typeof noteDisplayRaw === "string" &&
          noteDisplayRaw.includes("...");

        const highlightedNote = notesArr.length
          ? highlightHtmlMulti(noteDisplayRaw, activeTerms)
          : '<em class="muted">nessuna nota</em>';

        const mediaLabel = (() => {
          const p = String(t?.tipoMedia?.parent || "").trim();
          const c = String(t?.tipoMedia?.child || "").trim();
          return c || p || "";
        })();

        const journalistNamesRaw = (t?.redazione?.giornalisti || [])
          .map((jid) => getJournalistNameById(jid))
          .join(" • ");
        const testataJournalistsLabelHtml = `<a href="#" class="card-label-link card-testata-journalists-open" data-testata-key="${escapeHtml(
          String(t?.id || ""),
        )}">Giornalisti</a>`;

        const highlightedName = highlightHtmlMulti(
          String(t?.nome || ""),
          activeTerms,
        );
        const highlightedTelefono = escapeHtml(String(t?.telefono || ""));
        const highlightedEmail = escapeHtml(String(t?.email || ""));
        const highlightedJournalists = journalistNamesRaw
          ? escapeHtml(journalistNamesRaw)
          : '<span class="muted">n/d</span>';

        card.innerHTML = `
          <div class="card-top">
            <div class="card-name-row">
              <a
                href="#"
                class="testata-link card-name-link"
                data-testata-key="${escapeHtml(String(t?.id || ""))}"
                data-testata="${escapeHtml(String(t?.nome || ""))}"
                aria-label="apri scheda"
                title="apri scheda"
              >
                <h3 class="card-name">${highlightedName}</h3>
              </a>
            </div>
            <p class="card-role">${escapeHtml(mediaLabel)}</p>
          </div>
          <div class="card-row"><div class="card-label">Telefono</div><div class="card-value">${highlightedTelefono}</div></div>
          <div class="card-row"><div class="card-label">E-mail</div><div class="card-value">${highlightedEmail}</div></div>
          <div class="card-row"><div class="card-label">${testataJournalistsLabelHtml}</div><div class="card-value card-journalists">${highlightedJournalists}</div></div>
          <div class="card-row"><div class="card-label">${
            noteShowsEllipsis
              ? `<a href="#" class="card-label-link card-notes-open" data-testata-key="${escapeHtml(
                  String(t?.id || ""),
                )}">Note</a>`
              : "Note"
          }</div><div class="card-value muted card-note">${highlightedNote}</div></div>
        `;

        return card;
      }

      const testataOverlay = document.getElementById("testataOverlay");
      const testataPanel = document.getElementById("testataPanel");
      const testataPanelTitle = document.getElementById("testataPanelTitle");
      const testataPanelHeaderContent = document.getElementById(
        "testataPanelHeaderContent",
      );
      const testataPanelBody = document.getElementById("testataPanelBody");
      const testataPanelClose = document.getElementById("testataPanelClose");

      const chooseDatabaseLink = document.getElementById("chooseDatabaseLink");

      const selectAllLink = document.getElementById("selectAllLink");
      const bulkSelectControls = document.getElementById("bulkSelectControls");

      const sortByNameAscLink = document.getElementById("sortByNameAscLink");
      const sortByNameDescLink = document.getElementById("sortByNameDescLink");
      const sortByRoleLink = document.getElementById("sortByRoleLink");
      const sortByMediaTypeLink = document.getElementById(
        "sortByMediaTypeLink",
      );
      const sortByFrequencyLink = document.getElementById(
        "sortByFrequencyLink",
      );

      const sortByNameSelect = document.getElementById("sortByNameSelect");
      const sortByNameSelectTrigger = document.getElementById(
        "sortByNameSelectTrigger",
      );
      const sortByNameSelectMenu = document.getElementById(
        "sortByNameSelectMenu",
      );
      const sortByNameSelectValue = document.getElementById(
        "sortByNameSelectValue",
      );
      const sortByNameOptionAsc = document.getElementById(
        "sortByNameOptionAsc",
      );
      const sortByNameOptionDesc = document.getElementById(
        "sortByNameOptionDesc",
      );
      const sortByNameOptionRelevance = document.getElementById(
        "sortByNameOptionRelevance",
      );
      const sortByNameOptionRole = document.getElementById(
        "sortByNameOptionRole",
      );
      const sortByNameOptionMediaType = document.getElementById(
        "sortByNameOptionMediaType",
      );
      const sortByNameOptionFrequency = document.getElementById(
        "sortByNameOptionFrequency",
      );

      const notesModalOverlay = document.getElementById("notesModalOverlay");
      const notesModal = document.getElementById("notesModal");
      const notesModalTitle = document.getElementById("notesModalTitle");
      const notesModalBody = document.getElementById("notesModalBody");
      const notesModalClose = document.getElementById("notesModalClose");

      const selectedPanel = document.getElementById("selectedPanel");

      const globalHelpLink = document.getElementById("globalHelpLink");
      const helpPanel = document.getElementById("helpPanel");
      const helpPanelClose = document.getElementById("helpPanelClose");
      const newPressPanelTitle = document.getElementById("newPressPanelTitle");
      const newPressPanelTitleInput = document.getElementById(
        "newPressPanelTitleInput",
      );
      const newPressPanelBodyTitle = document.getElementById(
        "newPressPanelBodyTitle",
      );
      const newPressPanelOverlay = document.getElementById(
        "newPressPanelOverlay",
      );
      const newPressPanel = document.getElementById("newPressPanel");
      const newPressPanelClose = document.getElementById("newPressPanelClose");
      const newPressPanelJournalistTag = document.getElementById(
        "newPressPanelJournalistTag",
      );
      const newPressPanelEmailHeaderTextarea = document.getElementById(
        "newPressPanelEmailHeaderTextarea",
      );
      const newPressPanelTextarea = document.getElementById(
        "newPressPanelTextarea",
      );
      const newPressPanelDropzone = document.getElementById(
        "newPressPanelDropzone",
      );
      const newPressPanelDroppedFilesList = document.getElementById(
        "newPressPanelDroppedFilesList",
      );
      const showHelpCheckbox = document.getElementById("showHelpCheckbox");

      function isShowHelpEnabled() {
        return !!appState?.ui?.showHelp;
      }

      function updateHelpLinkVisibility() {
        if (!globalHelpLink) return;
        const v = normalizeViewId(appState.view);
        const shouldShow = isShowHelpEnabled() && v && v !== "account";
        globalHelpLink.style.display = shouldShow ? "inline-block" : "none";
        if (!shouldShow) {
          closeHelpPanel();
        }
      }

      function openHelpPanel() {
        if (!helpPanel) return;
        helpPanel.classList.add("show");
        helpPanel.setAttribute("aria-hidden", "false");
        document.body.classList.add("help-panel-open");
      }

      function closeHelpPanel() {
        if (!helpPanel) return;
        helpPanel.classList.remove("show");
        helpPanel.setAttribute("aria-hidden", "true");
        document.body.classList.remove("help-panel-open");
      }

      function autoSizeShipmentEmailTextarea() {
        if (!newPressPanelEmailHeaderTextarea) return;
        const el = newPressPanelEmailHeaderTextarea;
        el.style.height = "auto";
        const cs = window.getComputedStyle(el);
        const lineHeight =
          parseFloat(cs.lineHeight) || parseFloat(cs.fontSize) || 16;
        const paddingTop = parseFloat(cs.paddingTop) || 0;
        const paddingBottom = parseFloat(cs.paddingBottom) || 0;
        const minHeight = lineHeight + paddingTop + paddingBottom;
        const nextHeight = Math.max(el.scrollHeight || 0, minHeight);
        el.style.height = `${nextHeight}px`;

        if (isShipmentEmailSpotlightOpen) {
          requestAnimationFrame(updateShipmentEmailSpotlightMask);
        }
      }

      function updateShipmentEmailSpotlightMask() {
        if (
          !isShipmentEmailSpotlightOpen ||
          !newPressPanelEmailHeaderTextarea ||
          !shipmentEmailSpotlightTop ||
          !shipmentEmailSpotlightLeft ||
          !shipmentEmailSpotlightRight ||
          !shipmentEmailSpotlightBottom
        ) {
          return;
        }

        const rect = newPressPanelEmailHeaderTextarea.getBoundingClientRect();
        const viewportWidth = Math.max(0, window.innerWidth || 0);
        const viewportHeight = Math.max(0, window.innerHeight || 0);

        const top = Math.max(0, Math.floor(rect.top));
        const left = Math.max(0, Math.floor(rect.left));
        const right = Math.max(
          left,
          Math.min(viewportWidth, Math.ceil(rect.right)),
        );
        const bottom = Math.max(
          top,
          Math.min(viewportHeight, Math.ceil(rect.bottom)),
        );
        const middleHeight = Math.max(0, bottom - top);

        shipmentEmailSpotlightTop.style.top = "0px";
        shipmentEmailSpotlightTop.style.left = "0px";
        shipmentEmailSpotlightTop.style.width = `${viewportWidth}px`;
        shipmentEmailSpotlightTop.style.height = `${top}px`;

        shipmentEmailSpotlightLeft.style.top = `${top}px`;
        shipmentEmailSpotlightLeft.style.left = "0px";
        shipmentEmailSpotlightLeft.style.width = `${left}px`;
        shipmentEmailSpotlightLeft.style.height = `${middleHeight}px`;

        shipmentEmailSpotlightRight.style.top = `${top}px`;
        shipmentEmailSpotlightRight.style.left = `${right}px`;
        shipmentEmailSpotlightRight.style.width = `${Math.max(0, viewportWidth - right)}px`;
        shipmentEmailSpotlightRight.style.height = `${middleHeight}px`;

        shipmentEmailSpotlightBottom.style.top = `${bottom}px`;
        shipmentEmailSpotlightBottom.style.left = "0px";
        shipmentEmailSpotlightBottom.style.width = `${viewportWidth}px`;
        shipmentEmailSpotlightBottom.style.height = `${Math.max(0, viewportHeight - bottom)}px`;
      }

      function openShipmentEmailHeaderSpotlight(journalistId) {
        const jid = String(journalistId || "").trim();
        if (!jid || !newPressPanelEmailHeaderTextarea) return;

        const selectedId = String(shipmentPressSelect?.value || "").trim();
        if (!selectedId) return;
        const selectedLabel = getComunicatoLabelById(selectedId);
        if (!selectedLabel) return;

        activeComunicatoId = selectedId;
        setNewPressPanelTitle(selectedLabel);

        const record = ensureComunicatoRecord(activeComunicatoId);
        if (!record) return;

        shipmentEmailSpotlightPreviousContext = newPressPanelOpenContext;
        shipmentEmailSpotlightPreviousJournalistId = newPressPanelJournalistId;

        newPressPanelOpenContext = "card";
        newPressPanelJournalistId = jid;

        const emailHeaderValue = getComunicatoDisplayEmailHeader(record, jid);
        newPressPanelEmailHeaderTextarea.value = emailHeaderValue;
        newPressPanelEmailHeaderTextarea.disabled = false;
        autoSizeShipmentEmailTextarea();

        isShipmentEmailSpotlightOpen = true;
        document.body.classList.add("is-shipment-email-spotlight");
        if (shipmentEmailSpotlight) {
          shipmentEmailSpotlight.classList.add("show");
          shipmentEmailSpotlight.setAttribute("aria-hidden", "false");
        }

        requestAnimationFrame(() => {
          updateShipmentEmailSpotlightMask();
          newPressPanelEmailHeaderTextarea.focus({ preventScroll: true });
          const valueLength = String(
            newPressPanelEmailHeaderTextarea.value || "",
          ).length;
          newPressPanelEmailHeaderTextarea.setSelectionRange(
            valueLength,
            valueLength,
          );
        });
      }

      function closeShipmentEmailHeaderSpotlight() {
        if (!isShipmentEmailSpotlightOpen) return;

        isShipmentEmailSpotlightOpen = false;
        document.body.classList.remove("is-shipment-email-spotlight");

        if (shipmentEmailSpotlight) {
          shipmentEmailSpotlight.classList.remove("show");
          shipmentEmailSpotlight.setAttribute("aria-hidden", "true");
        }

        const prevContext =
          shipmentEmailSpotlightPreviousContext === "card" ? "card" : "global";
        newPressPanelOpenContext = prevContext;
        newPressPanelJournalistId =
          prevContext === "card"
            ? String(shipmentEmailSpotlightPreviousJournalistId || "")
            : "";
        shipmentEmailSpotlightPreviousContext = "global";
        shipmentEmailSpotlightPreviousJournalistId = "";

        if (!newPressPanelEmailHeaderTextarea) return;
        const record = ensureComunicatoRecord(activeComunicatoId);
        if (!record) return;

        const jid =
          newPressPanelOpenContext === "card" ? newPressPanelJournalistId : "";
        newPressPanelEmailHeaderTextarea.value =
          getComunicatoDisplayEmailHeader(record, jid);
        autoSizeShipmentEmailTextarea();
      }

      function openNewPressPanel(options = {}) {
        if (!newPressPanel || !newPressPanelOverlay) return;
        const source = String(options?.source || "global")
          .trim()
          .toLowerCase();
        const journalistId = String(options?.journalistId || "").trim();
        const isCardContext = source === "card" && !!journalistId;
        newPressPanelOpenContext = isCardContext ? "card" : "global";
        newPressPanelJournalistId = isCardContext ? journalistId : "";

        const activeTitle = getComunicatoLabelById(activeComunicatoId);
        if (activeTitle) {
          setNewPressPanelTitle(activeTitle);
        }

        const record = ensureComunicatoRecord(activeComunicatoId);
        const emailHeaderValue = getComunicatoDisplayEmailHeader(
          record,
          newPressPanelJournalistId,
        );
        const bodyTextValue = String(record?.bodyText || "");

        if (newPressPanelEmailHeaderTextarea) {
          newPressPanelEmailHeaderTextarea.value = emailHeaderValue;
          newPressPanelEmailHeaderTextarea.disabled = false;
          autoSizeShipmentEmailTextarea();
        }

        if (newPressPanelTextarea) {
          newPressPanelTextarea.value = bodyTextValue;
          newPressPanelTextarea.disabled = isCardContext;
        }

        if (newPressPanelJournalistTag) {
          if (isCardContext) {
            const name = getJournalistNameById(journalistId);
            newPressPanelJournalistTag.textContent = `@${String(name || journalistId).trim()}`;
            newPressPanelJournalistTag.style.display = "inline-flex";
          } else {
            newPressPanelJournalistTag.textContent = "";
            newPressPanelJournalistTag.style.display = "none";
          }
        }

        if (record) {
          saveAppState(appState);
        }

        newPressPanelOverlay.classList.add("show");
        newPressPanel.classList.add("show");
        newPressPanelOverlay.setAttribute("aria-hidden", "false");
        newPressPanel.setAttribute("aria-hidden", "false");
      }

      function closeNewPressPanel() {
        if (!newPressPanel || !newPressPanelOverlay) return;
        newPressPanelOverlay.classList.remove("show");
        newPressPanel.classList.remove("show");
        newPressPanelOverlay.setAttribute("aria-hidden", "true");
        newPressPanel.setAttribute("aria-hidden", "true");
      }

      function appendDroppedMediaKitFiles(fileList) {
        if (!newPressPanelDroppedFilesList || !fileList) return;
        const files = Array.from(fileList).filter(Boolean);
        if (files.length === 0) return;

        files.forEach((file) => {
          const fileName = String(file?.name || "").trim() || "untitled-file";

          const li = document.createElement("li");
          const link = document.createElement("a");
          link.href = "#";
          link.className = "new-press-panel-dropped-file-link";
          link.textContent = fileName;
          link.addEventListener("click", (e) => {
            e.preventDefault();
          });

          li.appendChild(link);
          newPressPanelDroppedFilesList.appendChild(li);
        });
      }

      function setShowHelpEnabled(enabled) {
        appState.ui.showHelp = !!enabled;
        saveAppState(appState);
        updateHelpLinkVisibility();
      }

      function openSelectedPanel() {
        selectedPanel.classList.add("show");
        selectedPanel.setAttribute("aria-hidden", "false");
        document.body.classList.add("selection-panel-open");
        renderSelectedPanelList();
      }

      function closeSelectedPanel() {
        selectedPanel.classList.remove("show");
        selectedPanel.setAttribute("aria-hidden", "true");
        document.body.classList.remove("selection-panel-open");
      }

      if (globalHelpLink) {
        globalHelpLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!helpPanel) return;
          const isOpen = helpPanel.classList.contains("show");
          if (isOpen) {
            closeHelpPanel();
          } else {
            openHelpPanel();
          }
        });
      }

      if (helpPanelClose) {
        helpPanelClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeHelpPanel();
        });
      }

      if (newPressPanelClose) {
        newPressPanelClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeNewPressPanel();
        });
      }

      if (newPressPanelEmailHeaderTextarea) {
        newPressPanelEmailHeaderTextarea.addEventListener("input", () => {
          autoSizeShipmentEmailTextarea();
          const record = ensureComunicatoRecord(activeComunicatoId);
          if (!record) return;
          const value = String(newPressPanelEmailHeaderTextarea.value || "");
          if (newPressPanelOpenContext === "card") {
            const jid = String(newPressPanelJournalistId || "").trim();
            if (!jid) return;
            if (
              !record.journalistEmailHeaders ||
              typeof record.journalistEmailHeaders !== "object"
            ) {
              record.journalistEmailHeaders = {};
            }
            record.journalistEmailHeaders[jid] = value;
            saveAppState(appState);
            return;
          }

          record.emailHeader = value;
          saveAppState(appState);
        });

        autoSizeShipmentEmailTextarea();
      }

      if (newPressPanelTextarea) {
        newPressPanelTextarea.addEventListener("input", () => {
          if (newPressPanelOpenContext === "card") return;
          const record = ensureComunicatoRecord(activeComunicatoId);
          if (!record) return;
          record.bodyText = String(newPressPanelTextarea.value || "");
          saveAppState(appState);
          updateShipmentSelectedComunicatoReadonly();
        });
      }

      if (newPressPanelTitle) {
        newPressPanelTitle.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openNewPressPanelTitleInlineEditor();
        });
      }

      if (newPressPanelTitleInput) {
        newPressPanelTitleInput.addEventListener("blur", () => {
          closeNewPressPanelTitleInlineEditor({ commit: true });
        });
        newPressPanelTitleInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            closeNewPressPanelTitleInlineEditor({ commit: true });
            return;
          }
          if (e.key === "Escape") {
            e.preventDefault();
            closeNewPressPanelTitleInlineEditor({ commit: false });
          }
        });
      }

      if (mainTitleEl) {
        mainTitleEl.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openShipmentTitleInlineEditor();
        });
      }

      if (shipmentTitleInput) {
        shipmentTitleInput.addEventListener("blur", () => {
          closeShipmentTitleInlineEditor({ commit: true });
        });
        shipmentTitleInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            closeShipmentTitleInlineEditor({ commit: true });
            return;
          }
          if (e.key === "Escape") {
            e.preventDefault();
            closeShipmentTitleInlineEditor({ commit: false });
          }
        });
      }

      if (newPressPanelDropzone) {
        let dropzoneDragDepth = 0;

        const setDragOver = (isOver) => {
          newPressPanelDropzone.classList.toggle("is-drag-over", !!isOver);
        };

        ["dragenter", "dragover"].forEach((eventName) => {
          newPressPanelDropzone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropzoneDragDepth += 1;
            setDragOver(true);
          });
        });

        ["dragleave", "dragend"].forEach((eventName) => {
          newPressPanelDropzone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropzoneDragDepth = Math.max(0, dropzoneDragDepth - 1);
            if (dropzoneDragDepth === 0) {
              setDragOver(false);
            }
          });
        });

        newPressPanelDropzone.addEventListener("drop", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropzoneDragDepth = 0;
          setDragOver(false);
          appendDroppedMediaKitFiles(e.dataTransfer?.files);
        });
      }

      if (newPressPanelOverlay) {
        newPressPanelOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeNewPressPanel();
        });
      }

      document.addEventListener(
        "click",
        (e) => {
          if (!helpPanel || !helpPanel.classList.contains("show")) return;
          const t = e.target;
          if (helpPanel.contains(t)) return;
          if (globalHelpLink && globalHelpLink.contains(t)) return;
          closeHelpPanel();
        },
        true,
      );

      if (showHelpCheckbox) {
        showHelpCheckbox.checked = isShowHelpEnabled();
        showHelpCheckbox.addEventListener("change", () => {
          setShowHelpEnabled(!!showHelpCheckbox.checked);
        });
      }

      if (shipmentCardsFilterInput) {
        shipmentCardsFilterInput.addEventListener("focus", () => {
          closeAllFilterableDropdowns();
        });
        shipmentCardsFilterInput.addEventListener("input", () => {
          if (appState.view !== "spedisci-lista") return;
          scheduleRender();
        });
      }

      if (dashboardMailingListsFilterInput) {
        dashboardMailingListsFilterInput.addEventListener("input", () => {
          renderDashboardMailingLists();
        });
      }

      if (dashboardShipmentsFilterInput) {
        dashboardShipmentsFilterInput.addEventListener("input", () => {
          renderDashboardSpedizioni();
        });
      }

      if (dashboardComunicatiFilterInput) {
        dashboardComunicatiFilterInput.addEventListener("input", () => {
          renderDashboardComunicati();
        });
      }

      if (dashboardMailingListsNewLink) {
        dashboardMailingListsNewLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          window.location.hash = "#filtra";
          setActiveView("filtra", { save: true });
        });
      }

      if (dashboardShipmentsNewLink) {
        dashboardShipmentsNewLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          createDashboardShipment();
        });
      }

      if (dashboardComunicatiNewLink) {
        dashboardComunicatiNewLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          createNewComunicato();
          openNewPressPanel({ source: "dashboard" });
        });
      }

      if (selectedClearAll) {
        selectedClearAll.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          selectedJournalistIds.clear();
          selectedJournalistOrder.length = 0;

          document.querySelectorAll(".card-select").forEach((el) => {
            el.checked = false;
          });
          document.querySelectorAll(".card.is-selected").forEach((el) => {
            el.classList.remove("is-selected");
          });

          renderSelectedPanelList();
          closeSelectedPanel();
        });
      }

      function initSplitButtons() {
        const splitButtons = document.querySelectorAll("[data-split-button]");
        for (const split of splitButtons) {
          if (split.hasAttribute("data-split-initialized")) continue;
          split.setAttribute("data-split-initialized", "");
          const toggle = split.querySelector("[data-split-toggle]");
          const menu = split.querySelector("[data-split-menu]");
          if (!toggle || !menu) continue;

          function closeMenu() {
            if (!menu.classList.contains("show")) return;
            menu.classList.remove("show");
            menu.setAttribute("aria-hidden", "true");
            toggle.setAttribute("aria-expanded", "false");
          }

          function toggleMenu() {
            const isOpen = menu.classList.contains("show");
            if (isOpen) {
              closeMenu();
            } else {
              menu.classList.add("show");
              menu.setAttribute("aria-hidden", "false");
              toggle.setAttribute("aria-expanded", "true");
            }
          }

          toggle.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleMenu();
          });

          document.addEventListener(
            "click",
            (e) => {
              if (!menu.classList.contains("show")) return;
              const t = e.target;
              if (split.contains(t)) return;
              closeMenu();
            },
            true,
          );

          document.addEventListener(
            "keydown",
            (e) => {
              if (e.key !== "Escape") return;
              if (!menu.classList.contains("show")) return;
              e.preventDefault();
              e.stopPropagation();
              closeMenu();
            },
            true,
          );

          split.addEventListener("click", (e) => {
            const actionEl = e.target.closest("[data-split-action]");
            if (!actionEl) return;
            if (!split.contains(actionEl)) return;

            const action = actionEl.getAttribute("data-split-action");
            if (!action) return;

            e.preventDefault();
            e.stopPropagation();
            closeMenu();

            split.dispatchEvent(
              new CustomEvent("split-button-action", {
                detail: { action },
                bubbles: true,
              }),
            );
          });
        }
      }

      initSplitButtons();

      if (selectedActionsSplit) {
        selectedActionsSplit.addEventListener(
          "split-button-action",
          (e) => {
            const action = e?.detail?.action;
            if (!action) return;

            if (action === "save-list") {
              openSaveListModal();
              return;
            }
            if (action === "add-to-list") {
              openAddToListModal();
              return;
            }
            if (action === "add-to-shipment") {
              openAddToShipmentModal();
              return;
            }
            if (action === "add-to-new-shipment") {
              createSpedizioneFromSelectedJournalists();
              return;
            }
          },
          true,
        );
      }

      if (saveListModalClose) {
        saveListModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeSaveListModal();
        });
      }

      if (saveListModalOverlay) {
        saveListModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeSaveListModal();
        });
      }

      if (shareListModalClose) {
        shareListModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeShareListModal();
        });
      }

      if (shareListModalOverlay) {
        shareListModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeShareListModal();
        });
      }

      if (shareListConfirm) {
        shareListConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const activeList = getMailingListById(appState.activeMailingListId);
          if (!activeList || !shareListUsers) return;

          const checked = Array.from(
            shareListUsers.querySelectorAll(
              'input[type="checkbox"][data-colleague-id]',
            ),
          )
            .filter((cb) => cb.checked)
            .map((cb) => cb.getAttribute("data-colleague-id"))
            .map((x) => String(x || "").trim())
            .filter(Boolean);

          activeList.sharedWith = checked;
          saveAppState(appState);
          closeShareListModal();
          scheduleRender();
        });
      }

      if (addToListModalClose) {
        addToListModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeAddToListModal();
        });
      }

      if (addToListModalOverlay) {
        addToListModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeAddToListModal();
        });
      }

      if (addToShipmentModalClose) {
        addToShipmentModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeAddToShipmentModal();
        });
      }

      if (addToShipmentModalOverlay) {
        addToShipmentModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeAddToShipmentModal();
        });
      }

      if (addToNewShipmentModalClose) {
        addToNewShipmentModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeAddToNewShipmentModal();
        });
      }

      if (addToNewShipmentModalOverlay) {
        addToNewShipmentModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeAddToNewShipmentModal();
        });
      }

      if (shipmentPressEmailModalClose) {
        shipmentPressEmailModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeShipmentPressEmailModal();
        });
      }

      if (shipmentPressEmailModalOverlay) {
        shipmentPressEmailModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeShipmentPressEmailModal();
        });
      }

      if (shipmentPressInstructionsLink) {
        shipmentPressInstructionsLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openShipmentPressEmailModal();
        });
      }

      if (shipmentPressOpenLink) {
        shipmentPressOpenLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (shipmentPressOpenLink.classList.contains("is-link-disabled")) {
            return;
          }
          const selectedId = String(shipmentPressSelect?.value || "").trim();
          if (!selectedId) return;
          const selectedLabel = getComunicatoLabelById(selectedId);
          if (!selectedLabel) return;
          activeComunicatoId = selectedId;
          setNewPressPanelTitle(selectedLabel);
          openNewPressPanel({ source: "sidebar" });
        });
      }

      if (shipmentPressNewLink) {
        shipmentPressNewLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          createNewComunicato();
          openNewPressPanel({ source: "sidebar" });
        });
      }

      if (shipmentPressSelect) {
        shipmentPressSelect.addEventListener("change", () => {
          updateShipmentPressLinksState();
        });
      }

      if (shipmentAppendComunicatoCheckbox) {
        shipmentAppendComunicatoCheckbox.addEventListener("change", () => {
          updateShipmentSelectedComunicatoReadonly();
        });
      }

      if (shipmentComunicatoPublicLink) {
        shipmentComunicatoPublicLink.addEventListener("click", (e) => {
          if (
            shipmentComunicatoPublicLink.classList.contains("is-link-disabled")
          ) {
            e.preventDefault();
          }
        });
      }

      if (shipmentComunicatoCopyLink) {
        shipmentComunicatoCopyLink.addEventListener("click", async (e) => {
          e.preventDefault();
          if (
            shipmentComunicatoCopyLink.classList.contains("is-link-disabled")
          ) {
            return;
          }
          const url = getShipmentSelectedComunicatoPublicUrl();
          if (!url) return;
          try {
            await navigator.clipboard.writeText(url);
          } catch (_err) {}
        });
      }

      if (shipmentEmailSpotlight) {
        shipmentEmailSpotlight.addEventListener("click", (e) => {
          const closeTarget = e.target?.closest?.(
            '[data-shipment-email-spotlight-close="true"]',
          );
          if (closeTarget) {
            closeShipmentEmailHeaderSpotlight();
          }
        });
      }

      document.addEventListener(
        "keydown",
        (e) => {
          if (!isShipmentEmailSpotlightOpen) return;
          if (e.key !== "Escape") return;
          e.preventDefault();
          e.stopPropagation();
          closeShipmentEmailHeaderSpotlight();
        },
        true,
      );

      window.addEventListener("resize", () => {
        updateShipmentEmailSpotlightMask();
      });

      window.addEventListener(
        "scroll",
        () => {
          updateShipmentEmailSpotlightMask();
        },
        true,
      );

      if (shipmentPressEmailCopyLink) {
        shipmentPressEmailCopyLink.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          const email = String(
            shipmentPressEmailAddress?.textContent || "",
          ).trim();
          if (!email) return;
          try {
            await navigator.clipboard.writeText(email);
          } catch (_err) {}
        });
      }

      if (shipmentPressModeSelectRadio) {
        shipmentPressModeSelectRadio.addEventListener("change", () => {
          updateShipmentPressModeUI();
        });
      }

      if (shipmentPressModeEmailRadio) {
        shipmentPressModeEmailRadio.addEventListener("change", () => {
          updateShipmentPressModeUI();
        });
      }

      if (addToListConfirm) {
        addToListConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const selectedName = Array.from(
            addToListDropdown.selectedValues || [],
          )
            .map((x) => String(x || "").trim())
            .filter(Boolean)[0];
          if (!selectedName) {
            if (addToListError) addToListError.style.display = "block";
            return;
          }

          const list = getMailingListByName(selectedName);
          if (!list) {
            if (addToListError) addToListError.style.display = "block";
            return;
          }

          const current = new Set(
            Array.isArray(list.journalistIds)
              ? list.journalistIds.map((x) => String(x || "").trim())
              : [],
          );
          const targets =
            Array.isArray(addToListTargetJids) && addToListTargetJids.length
              ? addToListTargetJids
              : selectedJournalistOrder;
          for (const jid of targets) {
            current.add(String(jid || "").trim());
          }
          list.journalistIds = Array.from(current).filter(Boolean);

          saveAppState(appState);
          closeAddToListModal();

          const usedSnapshot =
            Array.isArray(targets) && targets !== selectedJournalistOrder;
          if (!usedSnapshot) {
            selectedJournalistIds.clear();
            selectedJournalistOrder.length = 0;
            renderSelectedPanelList();
            closeSelectedPanel();
          }
          scheduleRender();

          openMailingListById(list.id);
        });
      }

      if (addToShipmentConfirm) {
        addToShipmentConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const selectedName = Array.from(
            addToShipmentDropdown.selectedValues || [],
          )
            .map((x) => String(x || "").trim())
            .filter(Boolean)[0];
          if (!selectedName) {
            if (addToShipmentError) addToShipmentError.style.display = "block";
            return;
          }

          const shipment = getSpedizioneByName(selectedName);
          if (!shipment) {
            if (addToShipmentError) addToShipmentError.style.display = "block";
            return;
          }

          const current = new Set(
            Array.isArray(shipment.journalistIds)
              ? shipment.journalistIds.map((x) => String(x || "").trim())
              : [],
          );
          const targets =
            Array.isArray(addToShipmentTargetJids) &&
            addToShipmentTargetJids.length
              ? addToShipmentTargetJids
              : selectedJournalistOrder;
          for (const jid of targets) {
            current.add(String(jid || "").trim());
          }
          shipment.journalistIds = Array.from(current).filter(Boolean);

          saveAppState(appState);
          closeAddToShipmentModal();

          const usedSnapshot =
            Array.isArray(targets) && targets !== selectedJournalistOrder;
          if (!usedSnapshot) {
            selectedJournalistIds.clear();
            selectedJournalistOrder.length = 0;
            renderSelectedPanelList();
            closeSelectedPanel();
          }
          scheduleRender();
        });
      }

      if (addToNewShipmentConfirm) {
        addToNewShipmentConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const rawName = String(addToNewShipmentNameInput?.value || "").trim();
          if (!rawName) {
            if (addToNewShipmentError)
              addToNewShipmentError.style.display = "block";
            if (addToNewShipmentNameInput) addToNewShipmentNameInput.focus();
            return;
          }
          if (addToNewShipmentError)
            addToNewShipmentError.style.display = "none";

          const selectionSnapshot = selectedJournalistOrder.filter((jid) =>
            selectedJournalistIds.has(jid),
          );
          const uniqueName = computeUniqueSpedizioneName(rawName);

          const shipment = {
            name: uniqueName,
            journalistIds: Array.from(selectionSnapshot || []),
            createdAt: Date.now(),
          };
          if (!Array.isArray(appState.spedizioni)) {
            appState.spedizioni = [];
          }
          appState.spedizioni.unshift(shipment);
          saveAppState(appState);
          renderDashboardSpedizioni();
          closeAddToNewShipmentModal();

          selectedJournalistIds.clear();
          selectedJournalistOrder.length = 0;
          renderSelectedPanelList();
          closeSelectedPanel();
          scheduleRender();
        });
      }

      function confirmSaveList() {
        const rawName = String(saveListNameInput?.value || "").trim();
        if (!rawName) {
          if (saveListError) saveListError.style.display = "block";
          if (saveListNameInput) saveListNameInput.focus();
          return;
        }
        if (saveListError) saveListError.style.display = "none";

        if (saveListModalMode === "rename") {
          const targetId = String(saveListModalTargetId || "").trim();
          if (!targetId) return;
          if (!Array.isArray(appState.mailingLists)) return;

          const idx = appState.mailingLists.findIndex(
            (ml) => String(ml?.id || "") === targetId,
          );
          if (idx === -1) return;

          appState.mailingLists[idx] = {
            ...appState.mailingLists[idx],
            name: rawName,
          };
          saveAppState(appState);

          closeSaveListModal();
          scheduleRender();
          return;
        }

        if (saveListModalMode === "rename-comunicato") {
          const targetId = String(saveListModalTargetId || "").trim();
          if (!targetId) return;
          if (!renameComunicatoById(targetId, rawName)) return;

          closeSaveListModal();
          scheduleRender();
          return;
        }

        const selectionSnapshot = selectedJournalistOrder.filter((jid) =>
          selectedJournalistIds.has(jid),
        );

        const uniqueName = computeUniqueMailingListName(rawName);
        createMailingList(uniqueName, selectionSnapshot);

        selectedJournalistIds.clear();
        selectedJournalistOrder.splice(0, selectedJournalistOrder.length);
        renderSelectedPanelList();
        closeSelectedPanel();

        if (typeof clearAllFilters === "function") {
          clearAllFilters();
        }

        closeSaveListModal();

        window.location.hash = "#mailing-list";
        setActiveView("mailing-list", { save: true });
        scheduleRender();
      }

      if (saveListConfirm) {
        saveListConfirm.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          confirmSaveList();
        });
      }

      if (saveListNameInput) {
        saveListNameInput.addEventListener("input", () => {
          if (!saveListError) return;
          if (String(saveListNameInput.value || "").trim()) {
            saveListError.style.display = "none";
          }
        });

        saveListNameInput.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          e.preventDefault();
          e.stopPropagation();
          confirmSaveList();
        });
      }

      function updateTextFilterClearVisibility() {
        if (!textFilterClear || !textFilterInput) return;
        const isActive =
          (textFilterInput.value || "").trim().length > 0 ||
          committedTextTerms.length > 0;

        const container = textFilterInput.closest(".dropdown-container");
        if (container) {
          if (isActive) container.classList.add("has-active-filter");
          else container.classList.remove("has-active-filter");
        }

        if (isActive) {
          textFilterClear.classList.add("show");
        } else {
          textFilterClear.classList.remove("show");
        }
      }

      function closeAllFilterableDropdowns() {
        for (const inst of FilterableDropdown._instances || []) {
          if (inst?.isOpen) {
            inst.close();
          }
        }
      }

      if (textFilterInput) {
        textFilterInput.addEventListener("focus", () => {
          closeAllFilterableDropdowns();
        });

        textFilterInput.addEventListener("click", () => {
          closeAllFilterableDropdowns();
        });

        let _textFilterInputDebounce = null;
        textFilterInput.addEventListener("input", () => {
          updateTextFilterClearVisibility();
          if (_textFilterInputDebounce) {
            window.clearTimeout(_textFilterInputDebounce);
          }
          _textFilterInputDebounce = window.setTimeout(() => {
            _textFilterInputDebounce = null;
            scheduleRender();
          }, 120);
        });

        textFilterInput.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          const term = String(textFilterInput.value || "").trim();
          if (!term) return;

          e.preventDefault();
          e.stopPropagation();

          const k = term.toLowerCase();
          const exists = committedTextTerms.some(
            (t) =>
              String(t || "")
                .trim()
                .toLowerCase() === k,
          );
          if (!exists) {
            committedTextTerms.unshift(term);
          }

          textFilterInput.value = "";
          updateTextFilterClearVisibility();
          scheduleRender();
        });
      }

      if (textFilterClear) {
        textFilterClear.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!textFilterInput) return;
          textFilterInput.value = "";
          committedTextTerms.splice(0, committedTextTerms.length);
          updateTextFilterClearVisibility();
          scheduleRender();
        });
      }

      function openTestataPanel(testata) {
        if (testataPanelTitle) testataPanelTitle.textContent = "Testata";
        {
          const panelHeaderEl = testataPanelHeaderContent?.closest?.(
            ".testata-panel-header",
          );
          if (panelHeaderEl) {
            const existing = panelHeaderEl.querySelector(
              "[data-journalist-header-contacts]",
            );
            if (existing) existing.remove();
          }
        }

        if (testataPanelHeaderContent) {
          testataPanelHeaderContent.innerHTML = "";
          if (testataPanelTitle)
            testataPanelHeaderContent.appendChild(testataPanelTitle);
        }
        testataPanelBody.innerHTML = "";

        const raw = String(testata || "").trim();
        const key = normalizeTestataKey(raw);

        const t = (testate || []).find((x) => {
          if (!x) return false;
          const idOk =
            String(x?.id || "") === raw || String(x?.id || "") === key;
          if (idOk) return true;
          const nameOk =
            normalizeTestataKey(String(x?.nome || "")) === key ||
            String(x?.nome || "")
              .trim()
              .toLowerCase() === raw.toLowerCase();
          return nameOk;
        });

        if (!t) {
          testataPanelBody.textContent = `testata: ${testata}`;
        } else {
          if (testataPanelTitle)
            testataPanelTitle.textContent = String(t?.nome || "Testata");

          const normalizeTextHeader = (v) => String(v ?? "").trim();

          const header = document.createElement("div");
          header.className = "journalist-sheet__header";

          const titleRow = document.createElement("div");
          titleRow.className = "journalist-sheet__title-row";

          const title = document.createElement("div");
          title.className = "journalist-sheet__title";
          title.textContent = String(t?.nome || "Testata");

          titleRow.appendChild(title);
          header.appendChild(titleRow);

          const meta = document.createElement("div");
          meta.className = "journalist-sheet__meta";

          const metaDate = document.createElement("span");
          metaDate.className = "t-value";
          metaDate.textContent = "25/7/2025";

          const metaText = document.createElement("span");
          metaText.className = "t-label";
          metaText.textContent = "aggiornamento M_";

          meta.appendChild(metaDate);
          meta.appendChild(metaText);

          if (testataPanelHeaderContent) {
            testataPanelHeaderContent.innerHTML = "";
            testataPanelHeaderContent.appendChild(header);
            testataPanelHeaderContent.appendChild(meta);
          }

          const contactsSummary = document.createElement("table");
          contactsSummary.className = "journalist-contact-table";
          contactsSummary.setAttribute("data-journalist-header-contacts", "");
          {
            const colgroup = document.createElement("colgroup");
            const col1 = document.createElement("col");
            col1.style.width = "24ch";
            const col2 = document.createElement("col");
            col2.style.width = "16ch";
            colgroup.appendChild(col1);
            colgroup.appendChild(col2);
            contactsSummary.appendChild(colgroup);

            const tbody = document.createElement("tbody");
            contactsSummary.appendChild(tbody);

            const makeRow = (key, value, label) => {
              const tr = document.createElement("tr");

              const tdValue = document.createElement("td");
              const sValue = document.createElement("span");
              sValue.className = "journalist-contact-cell t-value";
              sValue.setAttribute("data-header-contact", `${key}-value`);
              sValue.textContent = normalizeTextHeader(value) || "n/d";
              tdValue.appendChild(sValue);

              const tdLabel = document.createElement("td");
              const sLabel = document.createElement("span");
              sLabel.className = "journalist-contact-cell t-label";
              sLabel.setAttribute("data-header-contact", `${key}-label`);
              sLabel.textContent = normalizeTextHeader(label) || "";
              tdLabel.appendChild(sLabel);

              tr.appendChild(tdValue);
              tr.appendChild(tdLabel);
              return tr;
            };

            tbody.appendChild(makeRow("phone", t?.telefono, "telefono"));
            tbody.appendChild(makeRow("email", t?.email, "mail"));
          }

          {
            const panelHeaderEl = testataPanelHeaderContent?.closest?.(
              ".testata-panel-header",
            );
            if (panelHeaderEl && testataPanelClose) {
              const existing = panelHeaderEl.querySelector(
                "[data-journalist-header-contacts]",
              );
              if (existing) existing.remove();
              panelHeaderEl.insertBefore(contactsSummary, testataPanelClose);
            }
          }

          const addRow = (labelText, valueNode) => {
            const row = document.createElement("div");
            row.className = "card-row";

            const label = document.createElement("div");
            label.className = "card-label";
            label.textContent = labelText;

            const value = document.createElement("div");
            value.className = "card-value";
            if (valueNode) {
              value.appendChild(valueNode);
            }

            row.appendChild(label);
            row.appendChild(value);
            testataPanelBody.appendChild(row);
          };

          {
            const notesSection = document.createElement("section");
            notesSection.className = "journalist-section";
            notesSection.setAttribute("data-testata-notes", "");
            notesSection.setAttribute(
              "data-testata-key",
              String(t?.id || key || raw).trim(),
            );

            const notesHeader = document.createElement("div");
            notesHeader.className =
              "journalist-section__header journalist-section__header--collapsible";
            notesHeader.setAttribute("data-section-toggle", "testata-notes");
            notesHeader.setAttribute("role", "button");
            notesHeader.setAttribute("tabindex", "0");

            const notesTitle = document.createElement("div");
            notesTitle.className = "journalist-section__title";

            const notesHeading = document.createElement("h3");
            notesHeading.className = "journalist-section__heading";
            notesHeading.textContent = "NOTE";
            notesTitle.appendChild(notesHeading);

            const addNote = document.createElement("a");
            addNote.href = "#";
            addNote.className = "c-link c-link--action";
            addNote.textContent = "aggiungi nota";
            addNote.setAttribute("data-note-action", "add");
            notesTitle.appendChild(addNote);

            notesHeader.appendChild(notesTitle);

            const notesOpen = getSectionOpen("testata-notes", false);
            notesHeader.setAttribute(
              "aria-expanded",
              notesOpen ? "true" : "false",
            );

            const notesToggle = document.createElement("span");
            notesToggle.className = "journalist-section__toggle";
            notesToggle.textContent = notesOpen ? "-" : "+";
            notesToggle.setAttribute("aria-hidden", "true");
            notesHeader.appendChild(notesToggle);

            const notesList = document.createElement("div");
            notesList.className = "journalist-notes";
            notesList.setAttribute("data-note-list", "");

            const notesEditor = document.createElement("div");
            notesEditor.className = "journalist-note-editor";
            notesEditor.setAttribute("data-note-editor", "");
            notesEditor.hidden = true;

            const notesTextarea = document.createElement("textarea");
            notesTextarea.className = "journalist-note-textarea";
            notesTextarea.setAttribute("data-note-textarea", "");

            const notesEditorActions = document.createElement("div");
            notesEditorActions.className = "journalist-note-editor-actions";

            const notesOk = document.createElement("a");
            notesOk.href = "#";
            notesOk.className = "c-link c-link--action";
            notesOk.textContent = "ok";
            notesOk.setAttribute("data-note-action", "ok");

            const notesCancel = document.createElement("a");
            notesCancel.href = "#";
            notesCancel.className = "c-link c-link--action";
            notesCancel.textContent = "annulla";
            notesCancel.setAttribute("data-note-action", "cancel");

            notesEditorActions.appendChild(notesOk);
            notesEditorActions.appendChild(notesCancel);
            notesEditor.appendChild(notesTextarea);
            notesEditor.appendChild(notesEditorActions);

            const renderNotesList = (arr) => {
              notesList.innerHTML = "";
              const items = normalizeNoteItems(arr);
              if (!items.length) {
                const empty = document.createElement("div");
                empty.className = "muted";
                empty.textContent = "nessuna nota";
                notesList.appendChild(empty);
                return;
              }

              for (let i = 0; i < items.length; i++) {
                const itemText = items[i]?.text;
                const itemDate = items[i]?.updatedAt;
                const item = document.createElement("div");
                item.className = "journalist-note-item";
                item.setAttribute("data-note-index", String(i));

                const text = document.createElement("div");
                text.className = "journalist-note-text t-value";
                text.textContent = itemText;

                const footer = document.createElement("div");
                footer.className = "journalist-note-footer";

                const date = document.createElement("span");
                date.className = "t-value";
                date.textContent = formatNoteDate(itemDate);

                const edit = document.createElement("a");
                edit.href = "#";
                edit.className = "c-link c-link--action";
                edit.textContent = "modifica";
                edit.setAttribute("data-note-action", "edit");

                const remove = document.createElement("a");
                remove.href = "#";
                remove.className = "c-link c-link--action";
                remove.textContent = "rimuovi";
                remove.setAttribute("data-note-action", "remove");

                footer.appendChild(date);
                footer.appendChild(edit);
                footer.appendChild(remove);

                item.appendChild(text);
                item.appendChild(footer);
                notesList.appendChild(item);
              }
            };

            renderNotesList(t?.note);

            const notesBody = document.createElement("div");
            notesBody.className = "journalist-section__body";
            notesBody.setAttribute("data-section-body", "");
            notesBody.hidden = !notesOpen;
            notesBody.appendChild(notesEditor);
            notesBody.appendChild(notesList);

            notesSection.appendChild(notesHeader);
            notesSection.appendChild(notesBody);
            testataPanelBody.appendChild(notesSection);
          }

          {
            const section = document.createElement("section");
            section.className = "journalist-section";
            section.setAttribute("data-testata-dati", "");

            const sectionHeader = document.createElement("div");
            sectionHeader.className =
              "journalist-section__header journalist-section__header--collapsible";
            sectionHeader.setAttribute("data-section-toggle", "testata-dati");
            sectionHeader.setAttribute("role", "button");
            sectionHeader.setAttribute("tabindex", "0");

            const titleWrap = document.createElement("div");
            titleWrap.className = "journalist-section__title";

            const heading = document.createElement("h3");
            heading.className = "journalist-section__heading";
            heading.textContent = "DATI TESTATA";
            titleWrap.appendChild(heading);

            sectionHeader.appendChild(titleWrap);

            const sectionOpen = getSectionOpen("testata-dati", false);
            sectionHeader.setAttribute(
              "aria-expanded",
              sectionOpen ? "true" : "false",
            );

            const toggle = document.createElement("span");
            toggle.className = "journalist-section__toggle";
            toggle.textContent = sectionOpen ? "-" : "+";
            toggle.setAttribute("aria-hidden", "true");
            sectionHeader.appendChild(toggle);

            const body = document.createElement("div");
            body.className = "journalist-section__body";
            body.setAttribute("data-section-body", "");
            body.hidden = !sectionOpen;

            const kv = document.createElement("div");
            kv.className = "c-kv c-kv--grid";

            const addRow = (labelText, valueText) => {
              const row = document.createElement("div");
              row.className = "c-kv__row";

              const label = document.createElement("div");
              label.className = "c-kv__label t-label";
              label.textContent = normalizeTextHeader(labelText) || "";

              const value = document.createElement("div");
              value.className = "c-kv__value t-value";
              value.textContent = normalizeTextHeader(valueText) || "n/d";

              row.appendChild(label);
              row.appendChild(value);
              kv.appendChild(row);
            };

            addRow("Editore", t?.editore);
            addRow(
              "Tipo di media",
              String(t?.tipoMedia?.child || t?.tipoMedia?.parent || "").trim(),
            );
            addRow("Frequenza", t?.frequenzaPubblicazione);
            addRow("Argomento", t?.argomento);
            addRow("Tiratura", t?.tiratura);
            addRow("Diffusione", t?.diffusione);
            addRow("Dati pubblicitari", t?.datiPubblicitari);

            body.appendChild(kv);
            section.appendChild(sectionHeader);
            section.appendChild(body);
            testataPanelBody.appendChild(section);
          }

          {
            const section = document.createElement("section");
            section.className = "journalist-section";
            section.setAttribute("data-testata-giornalisti", "");

            const header = document.createElement("div");
            header.className =
              "journalist-section__header journalist-section__header--collapsible";
            header.setAttribute("data-section-toggle", "testata-giornalisti");
            header.setAttribute("role", "button");
            header.setAttribute("tabindex", "0");

            const titleWrap = document.createElement("div");
            titleWrap.className = "journalist-section__title";
            {
              const heading = document.createElement("h3");
              heading.className = "journalist-section__heading";
              heading.textContent = "GIORNALISTI";
              titleWrap.appendChild(heading);
            }
            header.appendChild(titleWrap);

            const sectionOpen = getSectionOpen("testata-giornalisti", true);
            header.setAttribute(
              "aria-expanded",
              sectionOpen ? "true" : "false",
            );

            const toggle = document.createElement("span");
            toggle.className = "journalist-section__toggle";
            toggle.textContent = sectionOpen ? "-" : "+";
            toggle.setAttribute("aria-hidden", "true");
            header.appendChild(toggle);

            const body = document.createElement("div");
            body.className = "journalist-section__body";
            body.setAttribute("data-section-body", "");
            body.hidden = !sectionOpen;

            const layout = document.createElement("div");
            layout.className = "testata-journalists-layout";

            const treeCol = document.createElement("div");
            treeCol.className = "testata-journalists-tree";

            const detailCol = document.createElement("div");
            detailCol.className = "testata-journalists-detail";

            const contacts = document.createElement("div");
            contacts.className = "testata-journalists-contacts";
            contacts.setAttribute("data-testata-journalists-contacts", "");
            detailCol.appendChild(contacts);

            const grid = document.createElement("div");
            grid.className = "testata-journalists-cards-grid";
            grid.setAttribute("data-testata-journalists-grid", "");
            detailCol.appendChild(grid);

            layout.appendChild(treeCol);
            layout.appendChild(detailCol);
            body.appendChild(layout);

            const rcId = String(t?.redazioneCentraleId || "").trim();
            const rc = rcId ? redazioniCentraliById.get(rcId) : null;

            const makeTreeLink = (label, filterKey, level = 0) => {
              const wrap = document.createElement("div");
              wrap.className = "testata-journalists-tree-item";
              wrap.setAttribute("data-level", String(level));

              const a = document.createElement("a");
              a.href = "#";
              a.className = "testata-journalists-tree-link";
              a.textContent = label;
              a.setAttribute("data-redazione-filter", filterKey);
              wrap.appendChild(a);
              return wrap;
            };

            const makeTreeLabel = (label, level = 0) => {
              const el = document.createElement("div");
              el.className = "testata-journalists-tree-label";
              el.setAttribute("data-level", String(level));
              el.textContent = label;
              return el;
            };

            const emptyTree = document.createElement("div");
            emptyTree.className = "muted";
            emptyTree.textContent = "n/d";

            const allJids = [...(t?.redazione?.giornalisti || [])]
              .map((x) => String(x || "").trim())
              .filter(Boolean);

            const journalistObjs = allJids
              .map((jid) =>
                (journalists || []).find((x) => getJournalistId(x) === jid),
              )
              .filter(Boolean);

            const redazioneByJid = new Map();
            const availableLeafKeys = [];

            const makeCompactCard = (j) => {
              const card = createCard(j);
              const firstName = card.querySelector(
                ".card-name.card-name--person .card-first-name",
              );
              if (firstName) firstName.remove();

              const testateRow = card
                .querySelector(".card-testate")
                ?.closest?.(".card-row");
              if (testateRow) testateRow.remove();

              const notesRow = card
                .querySelector(".card-note")
                ?.closest?.(".card-row");
              if (notesRow) notesRow.remove();

              return card;
            };

            const active = { key: "all" };

            const renderContacts = () => {
              const norm = (v) => String(v ?? "").trim();

              const setContactsRow = ({ name, tel, email }) => {
                const safeName = norm(name) || "n/d";
                const safeTel = norm(tel) || "n/d";
                const safeEmail = norm(email) || "n/d";

                const span = (className, text) => {
                  const el = document.createElement("span");
                  el.className = className;
                  el.textContent = String(text ?? "");
                  return el;
                };

                contacts.replaceChildren(
                  span("t-text", `redazione ${safeName}: `),
                  span("t-label", "tel"),
                  document.createTextNode(" "),
                  span("t-value", safeTel),
                  document.createTextNode(" • "),
                  span("t-label", "email"),
                  document.createTextNode(" "),
                  span("t-value t-no-transform", safeEmail),
                );
              };

              const fallbackTel =
                norm(t?.redazione?.telRedazione) || norm(t?.telefono) || "n/d";
              const fallbackEmail = norm(t?.email) || "n/d";

              if (!rc) {
                const label = norm(t?.nome) || "";
                setContactsRow({
                  name: label,
                  tel: fallbackTel,
                  email: fallbackEmail,
                });
                return;
              }

              const key = String(active.key || "all").trim() || "all";

              let name = "centrale";
              let tel = norm(rc?.telefono) || fallbackTel;
              let email = norm(rc?.email) || fallbackEmail;

              if (key === "all") {
                name = "centrale";
              } else if (key.startsWith("centrale:")) {
                name = "centrale";
              } else if (key.startsWith("argomento:")) {
                const id = key.slice("argomento:".length);
                const item = (rc.argomenti || []).find(
                  (x) => String(x?.id || "").trim() === id,
                );
                if (item) {
                  name = norm(item?.nome) || name;
                  tel = norm(item?.telefono) || tel;
                  email = norm(item?.email) || email;
                }
              } else if (key.startsWith("locale:")) {
                const id = key.slice("locale:".length);
                const item = (rc.locali || []).find(
                  (x) => String(x?.id || "").trim() === id,
                );
                if (item) {
                  name = norm(item?.citta) || name;
                  tel = norm(item?.telefono) || tel;
                  email = norm(item?.email) || email;
                }
              } else if (key.startsWith("estera:")) {
                const id = key.slice("estera:".length);
                const item = (rc.estere || []).find(
                  (x) => String(x?.id || "").trim() === id,
                );
                if (item) {
                  name = norm(item?.citta) || name;
                  tel = norm(item?.telefono) || tel;
                  email = norm(item?.email) || email;
                }
              }

              setContactsRow({ name, tel, email });
            };

            const renderGrid = () => {
              grid.innerHTML = "";
              const filtered = journalistObjs.filter((j) => {
                if (active.key === "all") return true;
                const jid = getJournalistId(j);
                return redazioneByJid.get(jid) === active.key;
              });

              if (!filtered.length) {
                const empty = document.createElement("div");
                empty.className = "muted";
                empty.textContent = "nessun giornalista";
                grid.appendChild(empty);
                return;
              }

              filtered.sort((a, b) => {
                const la = String(a?.cognome || "").trim();
                const lb = String(b?.cognome || "").trim();
                const ca = la.localeCompare(lb, "it", { sensitivity: "base" });
                if (ca !== 0) return ca;
                const na = String(a?.nome || "").trim();
                const nb = String(b?.nome || "").trim();
                return na.localeCompare(nb, "it", { sensitivity: "base" });
              });

              for (const j of filtered) {
                grid.appendChild(makeCompactCard(j));
              }
            };

            const setActiveFilter = (key) => {
              active.key = key || "all";
              for (const link of treeCol.querySelectorAll(
                ".testata-journalists-tree-link[data-redazione-filter]",
              )) {
                link.classList.toggle(
                  "is-active",
                  link.getAttribute("data-redazione-filter") === active.key,
                );
              }
              renderContacts();
              renderGrid();
            };

            if (!rc) {
              treeCol.appendChild(makeTreeLink("tutti", "all", 0));
              treeCol.appendChild(emptyTree);
            } else {
              treeCol.appendChild(makeTreeLink("tutti", "all", 0));

              const centraleKey = `centrale:${String(rc.id || "").trim()}`;
              availableLeafKeys.push(centraleKey);
              treeCol.appendChild(makeTreeLabel("redazione centrale", 0));
              treeCol.appendChild(makeTreeLink("centrale", centraleKey, 1));

              if (Array.isArray(rc.argomenti) && rc.argomenti.length) {
                for (const a of rc.argomenti || []) {
                  const id = String(a?.id || "").trim();
                  const nome = String(a?.nome || "").trim();
                  if (!id || !nome) continue;
                  const k = `argomento:${id}`;
                  availableLeafKeys.push(k);
                  treeCol.appendChild(makeTreeLink(nome, k, 1));
                }
              }

              if (Array.isArray(rc.locali) && rc.locali.length) {
                treeCol.appendChild(makeTreeLabel("redazioni locali", 0));
                for (const l of rc.locali || []) {
                  const id = String(l?.id || "").trim();
                  const nome = String(l?.citta || "").trim();
                  if (!id || !nome) continue;
                  const k = `locale:${id}`;
                  availableLeafKeys.push(k);
                  treeCol.appendChild(makeTreeLink(nome, k, 1));
                }
              }

              if (Array.isArray(rc.estere) && rc.estere.length) {
                treeCol.appendChild(makeTreeLabel("redazioni estere", 0));
                for (const x of rc.estere || []) {
                  const id = String(x?.id || "").trim();
                  const nome = String(x?.citta || "").trim();
                  if (!id || !nome) continue;
                  const k = `estera:${id}`;
                  availableLeafKeys.push(k);
                  treeCol.appendChild(makeTreeLink(nome, k, 1));
                }
              }

              const topicsByNameKey = new Map(
                (rc.argomenti || [])
                  .map((a) => [normalizeTestataKey(a?.nome), a])
                  .filter((x) => x[0]),
              );

              const nonCentralLeafKeys = availableLeafKeys.filter(
                (k) => k !== centraleKey,
              );

              for (const j of journalistObjs) {
                const jid = getJournalistId(j);
                const serviceKey = normalizeTestataKey(j?.servizio);
                const maybeTopic = serviceKey
                  ? topicsByNameKey.get(serviceKey)
                  : null;
                if (maybeTopic && maybeTopic.id) {
                  redazioneByJid.set(
                    `` + jid,
                    `argomento:${String(maybeTopic.id).trim()}`,
                  );
                  continue;
                }

                const h = hashStringToUint(`testata-redazioni:${rc.id}:${jid}`);
                const prefersCentral = h % 5 === 0;
                if (prefersCentral || nonCentralLeafKeys.length === 0) {
                  redazioneByJid.set(jid, centraleKey);
                  continue;
                }

                const idx = h % nonCentralLeafKeys.length;
                redazioneByJid.set(jid, nonCentralLeafKeys[idx]);
              }
            }

            treeCol.addEventListener("click", (e) => {
              const link = e.target?.closest?.(
                ".testata-journalists-tree-link[data-redazione-filter]",
              );
              if (!link) return;
              e.preventDefault();
              e.stopPropagation();
              const key = link.getAttribute("data-redazione-filter") || "all";
              setActiveFilter(key);
            });

            grid.addEventListener("click", (e) => {
              const checkbox = e.target?.closest?.(".card-select");
              if (checkbox) return;

              const testataLink = e.target?.closest?.(".testata-link");
              const journalistLink = e.target?.closest?.(".journalist-link");
              if (testataLink || journalistLink) return;

              const card = e.target?.closest?.(".card");
              if (!card) return;
              const cb = card.querySelector(".card-select[data-jid]");
              if (!cb) return;
              cb.checked = !cb.checked;
              cb.dispatchEvent(new Event("change", { bubbles: true }));
            });

            grid.addEventListener("change", (e) => {
              const checkbox = e.target?.closest?.(".card-select[data-jid]");
              if (!checkbox) return;
              const jid = checkbox.getAttribute("data-jid");
              if (!jid) return;
              const card = checkbox.closest(".card");
              if (checkbox.checked) {
                selectedJournalistIds.add(jid);
                ensureSelectedOrder(jid);
                card?.classList?.add("is-selected");
                openSelectedPanel();
              } else {
                selectedJournalistIds.delete(jid);
                removeFromSelectedOrder(jid);
                card?.classList?.remove("is-selected");
                if (selectedJournalistIds.size === 0) {
                  closeSelectedPanel();
                } else {
                  renderSelectedPanelList();
                }
              }
              updateCheckboxUI(jid);
              updateCardSelectionUI(jid);
            });

            setActiveFilter("all");

            section.appendChild(header);
            section.appendChild(body);
            testataPanelBody.appendChild(section);
          }
        }

        testataOverlay.classList.add("show");
        testataPanel.classList.add("show");
        testataOverlay.setAttribute("aria-hidden", "false");
        testataPanel.setAttribute("aria-hidden", "false");
      }

      function openBancaDatiPanel() {
        if (testataPanelTitle) testataPanelTitle.textContent = "Banca dati";
        {
          const panelHeaderEl = testataPanelHeaderContent?.closest?.(
            ".testata-panel-header",
          );
          if (panelHeaderEl) {
            const existing = panelHeaderEl.querySelector(
              "[data-journalist-header-contacts]",
            );
            if (existing) existing.remove();
          }
        }
        if (testataPanelHeaderContent) {
          testataPanelHeaderContent.innerHTML = "";
          if (testataPanelTitle)
            testataPanelHeaderContent.appendChild(testataPanelTitle);
        }
        testataPanelBody.innerHTML = "";

        const empty = document.createElement("em");
        empty.className = "muted";
        empty.textContent = "elenco banche dati";
        testataPanelBody.appendChild(empty);

        testataOverlay.classList.add("show");
        testataPanel.classList.add("show");
        testataOverlay.setAttribute("aria-hidden", "false");
        testataPanel.setAttribute("aria-hidden", "false");
      }

      function openJournalistPanel(journalistName) {
        if (testataPanelTitle) testataPanelTitle.textContent = "Giornalista";
        testataPanelBody.innerHTML = "";

        const fullNameKey = String(journalistName || "")
          .trim()
          .toLowerCase();

        const j = (journalists || []).find((x) => {
          const k = `${String(x?.nome || "").trim()} ${String(
            x?.cognome || "",
          ).trim()}`
            .trim()
            .toLowerCase();
          return k === fullNameKey;
        });

        if (!j) {
          testataPanelBody.textContent = `giornalista: ${journalistName}`;
        } else {
          const jid = getJournalistId(j);
          const checkboxId = `journalist-panel-select-${jid.replace(
            /[^a-zA-Z0-9_-]/g,
            "_",
          )}`;

          const sheet = document.createElement("div");
          sheet.className = "journalist-sheet";

          const header = document.createElement("div");
          header.className = "journalist-sheet__header";

          const titleRow = document.createElement("div");
          titleRow.className = "journalist-sheet__title-row";

          const select = document.createElement("input");
          select.type = "checkbox";
          select.className = "card-select";
          select.id = checkboxId;
          select.checked = selectedJournalistIds.has(jid);
          select.addEventListener("change", (e) => {
            e.stopPropagation();

            if (select.checked) {
              selectedJournalistIds.add(jid);
              ensureSelectedOrder(jid);
              openSelectedPanel();
            } else {
              selectedJournalistIds.delete(jid);
              removeFromSelectedOrder(jid);
              if (selectedJournalistIds.size === 0) {
                closeSelectedPanel();
              } else {
                renderSelectedPanelList();
              }
            }

            updateCheckboxUI(jid);
            updateCardSelectionUI(jid);
          });

          const title = document.createElement("label");
          title.className = "journalist-sheet__title";
          title.setAttribute("for", checkboxId);
          title.textContent = `${j.nome} ${j.cognome}`;

          titleRow.appendChild(select);
          titleRow.appendChild(title);

          const titleActions = document.createElement("span");
          titleActions.className = "journalist-sheet__title-actions";

          const split = document.createElement("span");
          split.className = "c-split-button c-split-button--menu-left";
          split.setAttribute("data-split-button", "");

          const splitMain = document.createElement("button");
          splitMain.type = "button";
          splitMain.className = "c-split-button__main c-link c-link--nav";
          splitMain.textContent = "aggiungi a lista";
          splitMain.setAttribute("data-split-action", "add-to-list");

          const splitToggle = document.createElement("button");
          splitToggle.type = "button";
          splitToggle.className = "c-split-button__toggle";
          splitToggle.setAttribute("data-split-toggle", "");
          splitToggle.setAttribute("aria-haspopup", "listbox");
          splitToggle.setAttribute("aria-expanded", "false");
          splitToggle.innerHTML =
            '<span class="c-split-button__arrow" aria-hidden="true"></span>';

          const splitMenu = document.createElement("div");
          splitMenu.className = "dropdown-list c-split-button__menu";
          splitMenu.setAttribute("data-split-menu", "");
          splitMenu.setAttribute("role", "listbox");
          splitMenu.setAttribute("aria-hidden", "true");

          const results = document.createElement("div");
          results.className = "dropdown-results";

          const item = document.createElement("div");
          item.className = "dropdown-item";
          item.setAttribute("role", "option");

          const opt = document.createElement("a");
          opt.href = "#";
          opt.className = "c-link c-link--nav";
          opt.textContent = "aggiungi a spedizione";
          opt.setAttribute("data-split-action", "add-to-shipment");

          item.appendChild(opt);
          results.appendChild(item);
          splitMenu.appendChild(results);

          split.appendChild(splitMain);
          split.appendChild(splitToggle);
          split.appendChild(splitMenu);

          titleActions.appendChild(split);

          const normalizeArrHeader = (v) => (Array.isArray(v) ? v : []);
          const normalizeTextHeader = (v) => String(v ?? "").trim();

          const getJournalistRoleForTestata = (j, testataName) => {
            return String(j?.ruolo || "").trim();
          };

          const getJournalistServiceForTestata = (j, testataName) => {
            return String(j?.servizio || "").trim();
          };

          const getWordCloudTermsForService = (service) => {
            const s = String(service || "")
              .trim()
              .toLowerCase();

            if (s.includes("agric")) {
              return [
                { text: "PAC", size: 24 },
                { text: "filiera", size: 22 },
                { text: "sostenibilità", size: 20 },
                { text: "zootecnia", size: 18 },
                { text: "irrigazione", size: 18 },
                { text: "prezzi", size: 16 },
                { text: "consorzi", size: 16 },
                { text: "produzione", size: 15 },
                { text: "fitofarmaci", size: 14 },
                { text: "export", size: 14 },
                { text: "raccolto", size: 13 },
                { text: "dati", size: 12 },
              ];
            }

            if (
              s.includes("software") ||
              s.includes("it") ||
              s.includes("digit")
            ) {
              return [
                { text: "cloud", size: 24 },
                { text: "cybersecurity", size: 22 },
                { text: "AI", size: 20 },
                { text: "startup", size: 18 },
                { text: "open source", size: 18 },
                { text: "infrastrutture", size: 16 },
                { text: "privacy", size: 16 },
                { text: "API", size: 15 },
                { text: "SaaS", size: 14 },
                { text: "performance", size: 14 },
                { text: "prodotti", size: 13 },
                { text: "trend", size: 12 },
              ];
            }

            if (
              s.includes("cultura") ||
              s.includes("libri") ||
              s.includes("editoria")
            ) {
              return [
                { text: "recensioni", size: 24 },
                { text: "interviste", size: 22 },
                { text: "autori", size: 20 },
                { text: "festival", size: 18 },
                { text: "novità", size: 18 },
                { text: "librerie", size: 16 },
                { text: "premi", size: 16 },
                { text: "saggi", size: 15 },
                { text: "narrativa", size: 14 },
                { text: "rubriche", size: 14 },
                { text: "agenda", size: 13 },
                { text: "lettori", size: 12 },
              ];
            }

            return [
              { text: "attualità", size: 24 },
              { text: "approfondimento", size: 22 },
              { text: "intervista", size: 20 },
              { text: "analisi", size: 18 },
              { text: "mercato", size: 18 },
              { text: "report", size: 16 },
              { text: "dati", size: 16 },
              { text: "trend", size: 14 },
              { text: "aziende", size: 14 },
              { text: "eventi", size: 13 },
              { text: "territorio", size: 13 },
              { text: "inchiesta", size: 12 },
            ];
          };

          const getMockArticlesForService = (service) => {
            const s = String(service || "")
              .trim()
              .toLowerCase();

            if (s.includes("agric")) {
              return [
                {
                  title:
                    "PAC 2025: nuove misure e impatto su aziende agricole italiane",
                  date: "12/01/2025",
                },
                {
                  title:
                    "Filiera corta e prezzi: cosa cambia tra GDO e mercati locali",
                  date: "28/11/2024",
                },
                {
                  title:
                    "Siccità e irrigazione: strategie e investimenti nelle regioni del Centro",
                  date: "04/10/2024",
                },
              ];
            }

            if (
              s.includes("software") ||
              s.includes("it") ||
              s.includes("digit")
            ) {
              return [
                {
                  title: "Cloud sovrano: opportunità e rischi per le PMI",
                  date: "19/12/2024",
                },
                {
                  title:
                    "Cybersecurity: attacchi in crescita e nuove best practice",
                  date: "03/11/2024",
                },
                {
                  title: "AI generativa in azienda: casi d'uso e governance",
                  date: "22/09/2024",
                },
              ];
            }

            if (
              s.includes("cultura") ||
              s.includes("libri") ||
              s.includes("editoria")
            ) {
              return [
                {
                  title: "Editoria 2025: trend di lettura e nuove collane",
                  date: "07/01/2025",
                },
                {
                  title:
                    "Intervista all'autore: scrittura, ricerca e immaginario",
                  date: "16/11/2024",
                },
                {
                  title: "Festival letterari: calendario, temi e pubblico",
                  date: "01/10/2024",
                },
              ];
            }

            return [
              {
                title: "Attualità: i temi che stanno ridisegnando il mercato",
                date: "14/01/2025",
              },
              {
                title: "Dati e trend: come leggere numeri e segnali deboli",
                date: "20/11/2024",
              },
              {
                title: "Intervista: voci dal territorio e casi emblematici",
                date: "08/10/2024",
              },
            ];
          };

          const getPreferredContact = ({
            customItems,
            programItems,
            preferred,
            fallbackItem,
          }) => {
            const custom = customItems.filter(
              (x) => normalizeTextHeader(x.value).length > 0,
            );
            const program = programItems.filter(
              (x) => normalizeTextHeader(x.value).length > 0,
            );

            if (program.length === 0 && fallbackItem) {
              const v = normalizeTextHeader(fallbackItem.value);
              if (v) program.push({ value: v, label: fallbackItem.label });
            }

            if (preferred && typeof preferred === "object") {
              const origin = normalizeTextHeader(
                preferred.origin,
              ).toLowerCase();
              const idx = preferred.index;
              if (origin === "custom" && Number.isFinite(idx) && custom[idx]) {
                return { ...custom[idx] };
              }
              if (
                origin === "program" &&
                Number.isFinite(idx) &&
                program[idx]
              ) {
                return { ...program[idx] };
              }
            }

            if (custom[0]) return { ...custom[0] };
            if (program[0]) return { ...program[0] };
            return null;
          };

          const preferredPhone = getPreferredContact({
            customItems: normalizeArrHeader(j.customPhones).map((x) => ({
              value: normalizeTextHeader(x?.number ?? x?.tel ?? x?.value ?? x),
              label:
                normalizeTextHeader(x?.type ?? x?.kind ?? "") || "cellulare",
            })),
            programItems: normalizeArrHeader(j?.programPhones).map((x) => ({
              value: normalizeTextHeader(x?.number ?? x?.tel ?? x?.value ?? x),
              label:
                normalizeTextHeader(x?.type ?? x?.kind ?? "") || "cellulare",
            })),
            preferred: j?.preferredPhone,
            fallbackItem: { value: j?.tel, label: "cellulare" },
          });

          const preferredEmail = getPreferredContact({
            customItems: normalizeArrHeader(j.customEmails).map((x) => ({
              value: normalizeTextHeader(x?.email ?? x?.value ?? x),
              label: normalizeTextHeader(x?.type ?? "") || "mail diretta",
            })),
            programItems: normalizeArrHeader(j?.programEmails).map((x) => ({
              value: normalizeTextHeader(x?.email ?? x?.value ?? x),
              label: normalizeTextHeader(x?.type ?? "") || "mail diretta",
            })),
            preferred: j?.preferredEmail,
            fallbackItem: { value: j?.email, label: "mail diretta" },
          });

          const contactsSummary = document.createElement("table");
          contactsSummary.className = "journalist-contact-table";
          contactsSummary.setAttribute("data-journalist-header-contacts", "");
          {
            const colgroup = document.createElement("colgroup");
            const col1 = document.createElement("col");
            col1.style.width = "24ch";
            const col2 = document.createElement("col");
            col2.style.width = "16ch";
            colgroup.appendChild(col1);
            colgroup.appendChild(col2);
            contactsSummary.appendChild(colgroup);

            const tbody = document.createElement("tbody");
            contactsSummary.appendChild(tbody);

            const makeRow = (key, value, label) => {
              const tr = document.createElement("tr");

              const tdValue = document.createElement("td");
              const sValue = document.createElement("span");
              sValue.className = "journalist-contact-cell t-value";
              sValue.setAttribute("data-header-contact", `${key}-value`);
              sValue.textContent = normalizeTextHeader(value) || "n/d";
              tdValue.appendChild(sValue);

              const tdLabel = document.createElement("td");
              const sLabel = document.createElement("span");
              sLabel.className = "journalist-contact-cell t-label";
              sLabel.setAttribute("data-header-contact", `${key}-label`);
              sLabel.textContent = normalizeTextHeader(label) || "";
              tdLabel.appendChild(sLabel);

              tr.appendChild(tdValue);
              tr.appendChild(tdLabel);
              return tr;
            };

            tbody.appendChild(
              makeRow("phone", preferredPhone?.value, preferredPhone?.label),
            );
            tbody.appendChild(
              makeRow("email", preferredEmail?.value, preferredEmail?.label),
            );
          }
          titleRow.appendChild(titleActions);

          header.appendChild(titleRow);

          const meta = document.createElement("div");
          meta.className = "journalist-sheet__meta";

          const metaDate = document.createElement("span");
          metaDate.className = "t-value";
          metaDate.textContent = "25/7/2025";

          const metaText = document.createElement("span");
          metaText.className = "t-label";
          metaText.textContent = "aggiornamento M_";

          meta.appendChild(metaDate);
          meta.appendChild(metaText);

          if (testataPanelHeaderContent) {
            testataPanelHeaderContent.innerHTML = "";
            testataPanelHeaderContent.appendChild(header);
            testataPanelHeaderContent.appendChild(meta);
          }

          {
            const panelHeaderEl = testataPanelHeaderContent?.closest?.(
              ".testata-panel-header",
            );
            if (panelHeaderEl && testataPanelClose) {
              const existing = panelHeaderEl.querySelector(
                "[data-journalist-header-contacts]",
              );
              if (existing) existing.remove();
              panelHeaderEl.insertBefore(contactsSummary, testataPanelClose);
            }
          }

          const grid = document.createElement("div");
          grid.className = "journalist-sheet__grid";

          const mainCol = document.createElement("div");
          mainCol.className = "journalist-section";

          const getSectionOpen = (key, defaultOpen) => {
            const v = appState?.ui?.sectionOpen?.[key];
            return typeof v === "boolean" ? v : !!defaultOpen;
          };

          const setSectionOpen = (key, open) => {
            if (!appState.ui || typeof appState.ui !== "object") {
              appState.ui = {};
            }
            if (
              !appState.ui.sectionOpen ||
              typeof appState.ui.sectionOpen !== "object"
            ) {
              appState.ui.sectionOpen = {};
            }
            appState.ui.sectionOpen[key] = !!open;
            saveAppState(appState);
          };

          const topicsSection = document.createElement("section");
          topicsSection.className = "journalist-section";

          topicsSection.setAttribute("data-journalist-topics", "");
          topicsSection.setAttribute("data-jid", jid);

          const topicsHeader = document.createElement("div");
          topicsHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          topicsHeader.setAttribute("data-section-toggle", "topics");
          topicsHeader.setAttribute("role", "button");
          topicsHeader.setAttribute("tabindex", "0");

          const topicsTitle = document.createElement("div");
          topicsTitle.className = "journalist-section__title";

          const topicsHeading = document.createElement("h3");
          topicsHeading.className = "journalist-section__heading";
          topicsHeading.textContent = "SERVIZI";

          topicsTitle.appendChild(topicsHeading);

          const addTopic = document.createElement("a");
          addTopic.href = "#";
          addTopic.className = "c-link c-link--action";
          addTopic.textContent = "aggiungi servizio";
          addTopic.setAttribute("data-topic-action", "add");

          topicsTitle.appendChild(addTopic);
          topicsHeader.appendChild(topicsTitle);

          const topicsOpen = getSectionOpen("topics", true);
          topicsHeader.setAttribute(
            "aria-expanded",
            topicsOpen ? "true" : "false",
          );

          const topicsToggle = document.createElement("span");
          topicsToggle.className = "journalist-section__toggle";
          topicsToggle.textContent = topicsOpen ? "-" : "+";
          topicsToggle.setAttribute("aria-hidden", "true");
          topicsHeader.appendChild(topicsToggle);

          const topicsEditor = document.createElement("div");
          topicsEditor.className = "journalist-topic-editor";
          topicsEditor.setAttribute("data-topic-editor", "");
          topicsEditor.hidden = true;

          const topicsInput = document.createElement("input");
          topicsInput.type = "text";
          topicsInput.className = "journalist-topic-input";
          topicsInput.placeholder = "servizio";
          topicsInput.setAttribute("data-topic-input", "");
          topicsInput.autocomplete = "off";

          const topicsEditorActions = document.createElement("div");
          topicsEditorActions.className = "journalist-topic-editor-actions";

          const topicsOk = document.createElement("a");
          topicsOk.href = "#";
          topicsOk.className = "c-link c-link--action";
          topicsOk.textContent = "ok";
          topicsOk.setAttribute("data-topic-action", "ok");

          const topicsCancel = document.createElement("a");
          topicsCancel.href = "#";
          topicsCancel.className = "c-link c-link--action";
          topicsCancel.textContent = "annulla";
          topicsCancel.setAttribute("data-topic-action", "cancel");

          topicsEditorActions.appendChild(topicsOk);
          topicsEditorActions.appendChild(topicsCancel);

          topicsEditor.appendChild(topicsInput);
          topicsEditor.appendChild(topicsEditorActions);

          const topicsList = document.createElement("ul");
          topicsList.className = "journalist-topic-list";
          topicsList.setAttribute("data-topic-list", "");

          const normalizeCustomServices = (v) => {
            if (Array.isArray(v)) {
              return v
                .map((x) => {
                  if (typeof x === "object" && x) {
                    return {
                      name: String(
                        x.name ?? x.servizio ?? x.value ?? "",
                      ).trim(),
                    };
                  }
                  return { name: String(x ?? "").trim() };
                })
                .filter((x) => x.name.length > 0);
            }
            return [];
          };

          const renderTopics = () => {
            topicsList.innerHTML = "";

            const baseService = String(j?.servizio || "").trim();
            const custom = normalizeCustomServices(j?.customServices);
            for (let i = 0; i < custom.length; i++) {
              const item = custom[i];
              const li = document.createElement("li");
              li.className = "journalist-topic-item";
              li.setAttribute("data-topic-index", String(i));

              const row = document.createElement("div");
              row.className = "journalist-topic-row";

              const name = document.createElement("span");
              name.textContent = item.name;

              const actions = document.createElement("span");
              actions.className = "journalist-topic-actions";

              const edit = document.createElement("a");
              edit.href = "#";
              edit.className = "c-link c-link--action";
              edit.textContent = "modifica";
              edit.setAttribute("data-topic-action", "edit");

              const remove = document.createElement("a");
              remove.href = "#";
              remove.className = "c-link c-link--action";
              remove.textContent = "rimuovi";
              remove.setAttribute("data-topic-action", "remove");

              actions.appendChild(edit);
              actions.appendChild(remove);

              row.appendChild(name);
              row.appendChild(actions);

              li.appendChild(row);
              topicsList.appendChild(li);
            }

            if (baseService) {
              const li = document.createElement("li");
              li.className = "journalist-topic-item";

              const row = document.createElement("div");
              row.className = "journalist-topic-row";

              const name = document.createElement("span");
              name.textContent = baseService;

              const inText = document.createElement("span");
              inText.textContent = "in";

              const testataName = String(j?.testata || "").trim();
              if (testataName) {
                const link = document.createElement("a");
                link.href = "#";
                link.className = "c-link c-link--nav testata-link";
                link.textContent = testataName;
                link.setAttribute("data-testata", testataName);

                row.appendChild(name);
                row.appendChild(inText);
                row.appendChild(link);
              } else {
                row.appendChild(name);
              }

              li.appendChild(row);
              topicsList.appendChild(li);
            }

            if (!baseService && custom.length === 0) {
              const li = document.createElement("li");
              li.className = "journalist-topic-item";
              li.innerHTML = '<span class="muted">n/d</span>';
              topicsList.appendChild(li);
            }
          };

          renderTopics();

          const topicsBody = document.createElement("div");
          topicsBody.className = "journalist-section__body";
          topicsBody.setAttribute("data-section-body", "");
          topicsBody.hidden = !topicsOpen;
          topicsBody.appendChild(topicsEditor);
          topicsBody.appendChild(topicsList);

          topicsSection.appendChild(topicsHeader);
          topicsSection.appendChild(topicsBody);

          const contactsSection = document.createElement("section");
          contactsSection.className = "journalist-section";

          contactsSection.setAttribute("data-journalist-contacts", "");
          contactsSection.setAttribute("data-jid", jid);

          const contactsHeader = document.createElement("div");
          contactsHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          contactsHeader.setAttribute("data-section-toggle", "contacts");
          contactsHeader.setAttribute("role", "button");
          contactsHeader.setAttribute("tabindex", "0");

          const contactsHeading = document.createElement("h3");
          contactsHeading.className = "journalist-section__heading";
          contactsHeading.textContent = "CONTATTI DIRETTI";

          contactsHeader.appendChild(contactsHeading);

          const contactsOpen = getSectionOpen("contacts", true);
          contactsHeader.setAttribute(
            "aria-expanded",
            contactsOpen ? "true" : "false",
          );

          const contactsToggle = document.createElement("span");
          contactsToggle.className = "journalist-section__toggle";
          contactsToggle.textContent = contactsOpen ? "-" : "+";
          contactsToggle.setAttribute("aria-hidden", "true");
          contactsHeader.appendChild(contactsToggle);

          const contactsGroups = document.createElement("div");
          contactsGroups.className = "journalist-contacts";

          const makeGroupHeader = (labelText, actionText, kind) => {
            const h = document.createElement("div");
            h.className = "journalist-contact-group__header";

            const label = document.createElement("span");
            label.className = "journalist-contact-group__label";
            label.textContent = labelText;

            const add = document.createElement("a");
            add.href = "#";
            add.className = "c-link c-link--action";
            add.textContent = actionText;
            add.setAttribute("data-contact-action", "add");
            add.setAttribute("data-contact-kind", kind);

            h.appendChild(label);
            h.appendChild(add);
            return h;
          };

          const makeEditorActions = (kind) => {
            const actions = document.createElement("div");
            actions.className = "journalist-contact-editor-actions";

            const ok = document.createElement("a");
            ok.href = "#";
            ok.className = "c-link c-link--action";
            ok.textContent = "ok";
            ok.setAttribute("data-contact-action", "ok");
            ok.setAttribute("data-contact-kind", kind);

            const cancel = document.createElement("a");
            cancel.href = "#";
            cancel.className = "c-link c-link--action";
            cancel.textContent = "annulla";
            cancel.setAttribute("data-contact-action", "cancel");
            cancel.setAttribute("data-contact-kind", kind);

            actions.appendChild(ok);
            actions.appendChild(cancel);
            return actions;
          };

          const normalizeArr = (v) => (Array.isArray(v) ? v : []);
          const normalizeText = (v) => String(v ?? "").trim();

          const isPreferred = (kind, origin, index) => {
            const pref =
              kind === "phone" ? j?.preferredPhone : j?.preferredEmail;
            return (
              pref &&
              pref.origin === origin &&
              Number.isFinite(pref.index) &&
              pref.index === index
            );
          };

          const makeTestataLink = () => {
            const testataName = normalizeText(j?.testata);
            if (!testataName) return null;
            const link = document.createElement("a");
            link.href = "#";
            link.className = "c-link c-link--nav testata-link";
            link.textContent = testataName;
            link.setAttribute("data-testata", testataName);
            return link;
          };

          const telGroup = document.createElement("div");
          telGroup.className = "journalist-contact-group";
          telGroup.setAttribute("data-contact-group-kind", "phone");

          const telEditor = document.createElement("div");
          telEditor.className = "journalist-contact-editor";
          telEditor.hidden = true;
          telEditor.setAttribute("data-contact-editor", "");
          telEditor.setAttribute("data-contact-kind", "phone");

          const telType = document.createElement("select");
          telType.className = "journalist-contact-select";
          telType.setAttribute("data-contact-select", "");
          telType.setAttribute("data-contact-kind", "phone");
          for (const opt of [
            "cellulare",
            "cellulare ufficio",
            "fisso",
            "fisso ufficio",
          ]) {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            telType.appendChild(o);
          }

          const telInput = document.createElement("input");
          telInput.type = "text";
          telInput.className = "journalist-contact-input";
          telInput.placeholder = "telefono";
          telInput.autocomplete = "off";
          telInput.setAttribute("data-contact-input", "");
          telInput.setAttribute("data-contact-kind", "phone");

          telEditor.appendChild(telType);
          telEditor.appendChild(telInput);
          telEditor.appendChild(makeEditorActions("phone"));

          const telList = document.createElement("table");
          telList.className = "journalist-contact-table";
          telList.setAttribute("data-contact-list", "");
          telList.setAttribute("data-contact-kind", "phone");

          const renderTel = () => {
            telList.innerHTML = "";
            const colgroup = document.createElement("colgroup");
            const col1 = document.createElement("col");
            col1.style.width = "16ch";
            const col2 = document.createElement("col");
            col2.style.width = "16ch";
            const col3 = document.createElement("col");
            col3.style.width = "16ch";
            const col4 = document.createElement("col");
            col4.style.width = "12ch";
            colgroup.appendChild(col1);
            colgroup.appendChild(col2);
            colgroup.appendChild(col3);
            colgroup.appendChild(col4);
            telList.appendChild(colgroup);
            const tbody = document.createElement("tbody");
            telList.appendChild(tbody);
            const custom = normalizeArr(j.customPhones)
              .map((x) => ({
                number: normalizeText(x?.number ?? x?.tel ?? x?.value ?? x),
                type: normalizeText(x?.type ?? x?.kind ?? ""),
                isPrimary: Boolean(x?.isPrimary),
              }))
              .filter((x) => x.number.length > 0);

            for (let i = 0; i < custom.length; i++) {
              const it = custom[i];
              const tr = document.createElement("tr");
              tr.setAttribute("data-contact-kind", "phone");
              tr.setAttribute("data-contact-index", String(i));

              const tdNumber = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = it.number;
                tdNumber.appendChild(s);
              }

              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = it.type || "cellulare";
                tdType.appendChild(s);
              }

              const tdTestata = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.textContent = "";
                tdTestata.appendChild(s);
              }

              const preferred = document.createElement("a");
              preferred.href = "#";
              preferred.className = `journalist-contact-preferred c-link c-link--action${
                isPreferred("phone", "custom", i) ? " is-active" : ""
              }`;
              preferred.textContent = "predefinito";
              preferred.setAttribute("data-contact-action", "set-primary");
              preferred.setAttribute("data-contact-kind", "phone");
              preferred.setAttribute("data-contact-origin", "custom");

              const edit = document.createElement("a");
              edit.href = "#";
              edit.className = "c-link c-link--action";
              edit.textContent = "modifica";
              edit.setAttribute("data-contact-action", "edit");
              edit.setAttribute("data-contact-kind", "phone");

              const remove = document.createElement("a");
              remove.href = "#";
              remove.className = "c-link c-link--action";
              remove.textContent = "rimuovi";
              remove.setAttribute("data-contact-action", "remove");
              remove.setAttribute("data-contact-kind", "phone");

              const tdPreferred = document.createElement("td");
              tdPreferred.appendChild(preferred);

              const actions = document.createElement("span");
              actions.className = "journalist-contact-row-actions";
              actions.appendChild(edit);
              actions.appendChild(remove);
              tdPreferred.appendChild(actions);

              tr.appendChild(tdNumber);
              tr.appendChild(tdType);
              tr.appendChild(tdTestata);
              tr.appendChild(tdPreferred);
              tbody.appendChild(tr);
            }

            const programItemsRaw = normalizeArr(j?.programPhones);
            const programItems = programItemsRaw
              .map((x) => ({
                number: normalizeText(x?.number ?? x?.tel ?? x?.value ?? x),
                type: normalizeText(x?.type ?? x?.kind ?? ""),
              }))
              .filter((x) => x.number.length > 0);
            if (programItems.length === 0) {
              const v = normalizeText(j?.telefono);
              if (v) programItems.push({ number: v, type: "cellulare" });
            }
            for (let pi = 0; pi < programItems.length; pi++) {
              const it = programItems[pi];
              const tr = document.createElement("tr");

              const tdNumber = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = it.number;
                tdNumber.appendChild(s);
              }

              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = it.type || "cellulare";
                tdType.appendChild(s);
              }

              const preferred = document.createElement("a");
              preferred.href = "#";
              preferred.className = `journalist-contact-preferred c-link c-link--action${
                isPreferred("phone", "program", pi) ? " is-active" : ""
              }`;
              preferred.textContent = "predefinito";
              preferred.setAttribute("data-contact-action", "set-primary");
              preferred.setAttribute("data-contact-kind", "phone");
              preferred.setAttribute("data-contact-origin", "program");
              preferred.setAttribute("data-contact-program-index", String(pi));

              const tdTestata = document.createElement("td");
              const link = makeTestataLink();
              if (link) {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.appendChild(link);
                tdTestata.appendChild(s);
              } else {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.textContent = "";
                tdTestata.appendChild(s);
              }
              const tdPreferred = document.createElement("td");
              tdPreferred.appendChild(preferred);

              tr.appendChild(tdNumber);
              tr.appendChild(tdType);
              tr.appendChild(tdTestata);
              tr.appendChild(tdPreferred);
              tbody.appendChild(tr);
            }

            if (programItems.length === 0 && custom.length === 0) {
              const tr = document.createElement("tr");
              const td = document.createElement("td");
              td.colSpan = 4;
              td.innerHTML = '<span class="muted">n/d</span>';
              tr.appendChild(td);
              tbody.appendChild(tr);
            }

            j.customPhones = custom;
          };

          renderTel();

          telGroup.appendChild(makeGroupHeader("Tel", "aggiungi tel", "phone"));
          telGroup.appendChild(telEditor);
          telGroup.appendChild(telList);

          const emailGroup = document.createElement("div");
          emailGroup.className = "journalist-contact-group";
          emailGroup.setAttribute("data-contact-group-kind", "email");

          const emailEditor = document.createElement("div");
          emailEditor.className = "journalist-contact-editor";
          emailEditor.hidden = true;
          emailEditor.setAttribute("data-contact-editor", "");
          emailEditor.setAttribute("data-contact-kind", "email");

          const emailInput = document.createElement("input");
          emailInput.type = "text";
          emailInput.className = "journalist-contact-input";
          emailInput.placeholder = "email";
          emailInput.autocomplete = "off";
          emailInput.setAttribute("data-contact-input", "");
          emailInput.setAttribute("data-contact-kind", "email");

          emailEditor.appendChild(emailInput);
          emailEditor.appendChild(makeEditorActions("email"));

          const emailList = document.createElement("table");
          emailList.className = "journalist-contact-table";
          emailList.setAttribute("data-contact-list", "");
          emailList.setAttribute("data-contact-kind", "email");

          const renderEmail = () => {
            emailList.innerHTML = "";
            const colgroup = document.createElement("colgroup");
            const col1 = document.createElement("col");
            col1.style.width = "18ch";
            const col2 = document.createElement("col");
            col2.style.width = "16ch";
            const col3 = document.createElement("col");
            col3.style.width = "16ch";
            const col4 = document.createElement("col");
            col4.style.width = "12ch";
            colgroup.appendChild(col1);
            colgroup.appendChild(col2);
            colgroup.appendChild(col3);
            colgroup.appendChild(col4);
            emailList.appendChild(colgroup);
            const tbody = document.createElement("tbody");
            emailList.appendChild(tbody);
            const custom = normalizeArr(j.customEmails)
              .map((x) => ({
                email: normalizeText(x?.email ?? x?.value ?? x),
                type: normalizeText(x?.type ?? ""),
                isDefault: Boolean(x?.isDefault),
              }))
              .filter((x) => x.email.length > 0);

            for (let i = 0; i < custom.length; i++) {
              const it = custom[i];
              const tr = document.createElement("tr");
              tr.setAttribute("data-contact-kind", "email");
              tr.setAttribute("data-contact-index", String(i));

              const tdEmail = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = it.email;
                tdEmail.appendChild(s);
              }

              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = it.type || "mail diretta";
                tdType.appendChild(s);
              }

              const tdTestata = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.textContent = "";
                tdTestata.appendChild(s);
              }

              const preferred = document.createElement("a");
              preferred.href = "#";
              preferred.className = `journalist-contact-preferred c-link c-link--action${
                isPreferred("email", "custom", i) ? " is-active" : ""
              }`;
              preferred.textContent = "predefinito";
              preferred.setAttribute("data-contact-action", "set-default");
              preferred.setAttribute("data-contact-kind", "email");
              preferred.setAttribute("data-contact-origin", "custom");

              const edit = document.createElement("a");
              edit.href = "#";
              edit.className = "c-link c-link--action";
              edit.textContent = "modifica";
              edit.setAttribute("data-contact-action", "edit");
              edit.setAttribute("data-contact-kind", "email");

              const remove = document.createElement("a");
              remove.href = "#";
              remove.className = "c-link c-link--action";
              remove.textContent = "rimuovi";
              remove.setAttribute("data-contact-action", "remove");
              remove.setAttribute("data-contact-kind", "email");

              const tdPreferred = document.createElement("td");
              tdPreferred.appendChild(preferred);

              const actions = document.createElement("span");
              actions.className = "journalist-contact-row-actions";
              actions.appendChild(edit);
              actions.appendChild(remove);
              tdPreferred.appendChild(actions);

              tr.appendChild(tdEmail);
              tr.appendChild(tdType);
              tr.appendChild(tdTestata);
              tr.appendChild(tdPreferred);
              tbody.appendChild(tr);
            }

            const programItemsRaw = normalizeArr(j?.programEmails);
            const programItems = programItemsRaw
              .map((x) => ({
                email: normalizeText(x?.email ?? x?.value ?? x),
                type: normalizeText(x?.type ?? ""),
              }))
              .filter((x) => x.email.length > 0);
            if (programItems.length === 0) {
              const v = normalizeText(j?.email);
              if (v) programItems.push({ email: v, type: "mail diretta" });
            }
            for (let pi = 0; pi < programItems.length; pi++) {
              const it = programItems[pi];
              const tr = document.createElement("tr");

              const tdEmail = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = it.email;
                tdEmail.appendChild(s);
              }

              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = it.type || "mail diretta";
                tdType.appendChild(s);
              }

              const preferred = document.createElement("a");
              preferred.href = "#";
              preferred.className = `journalist-contact-preferred c-link c-link--action${
                isPreferred("email", "program", pi) ? " is-active" : ""
              }`;
              preferred.textContent = "predefinito";
              preferred.setAttribute("data-contact-action", "set-default");
              preferred.setAttribute("data-contact-kind", "email");
              preferred.setAttribute("data-contact-origin", "program");
              preferred.setAttribute("data-contact-program-index", String(pi));

              const tdTestata = document.createElement("td");
              const link = makeTestataLink();
              if (link) {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.appendChild(link);
                tdTestata.appendChild(s);
              } else {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-text";
                s.textContent = "";
                tdTestata.appendChild(s);
              }
              const tdPreferred = document.createElement("td");
              tdPreferred.appendChild(preferred);

              tr.appendChild(tdEmail);
              tr.appendChild(tdType);
              tr.appendChild(tdTestata);
              tr.appendChild(tdPreferred);
              tbody.appendChild(tr);
            }

            if (programItems.length === 0 && custom.length === 0) {
              const tr = document.createElement("tr");
              const td = document.createElement("td");
              td.colSpan = 4;
              td.innerHTML = '<span class="muted">n/d</span>';
              tr.appendChild(td);
              tbody.appendChild(tr);
            }

            j.customEmails = custom;
          };

          renderEmail();

          emailGroup.appendChild(
            makeGroupHeader("Email", "aggiungi email", "email"),
          );
          emailGroup.appendChild(emailEditor);
          emailGroup.appendChild(emailList);

          const socialGroup = document.createElement("div");
          socialGroup.className = "journalist-contact-group";
          socialGroup.setAttribute("data-contact-group-kind", "social");

          const socialEditor = document.createElement("div");
          socialEditor.className = "journalist-contact-editor";
          socialEditor.hidden = true;
          socialEditor.setAttribute("data-contact-editor", "");
          socialEditor.setAttribute("data-contact-kind", "social");

          const socialType = document.createElement("select");
          socialType.className = "journalist-contact-select";
          socialType.setAttribute("data-contact-select", "");
          socialType.setAttribute("data-contact-kind", "social");
          for (const opt of ["facebook", "x", "instagram"]) {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            socialType.appendChild(o);
          }

          const socialInput = document.createElement("input");
          socialInput.type = "text";
          socialInput.className = "journalist-contact-input";
          socialInput.placeholder = "social";
          socialInput.autocomplete = "off";
          socialInput.setAttribute("data-contact-input", "");
          socialInput.setAttribute("data-contact-kind", "social");

          socialEditor.appendChild(socialType);
          socialEditor.appendChild(socialInput);
          socialEditor.appendChild(makeEditorActions("social"));

          const socialList = document.createElement("table");
          socialList.className = "journalist-contact-table";
          socialList.setAttribute("data-contact-list", "");
          socialList.setAttribute("data-contact-kind", "social");

          const renderSocial = () => {
            socialList.innerHTML = "";
            const tbody = document.createElement("tbody");
            socialList.appendChild(tbody);
            const custom = normalizeArr(j.customSocials)
              .map((x) => ({
                url: normalizeText(x?.url ?? x?.value ?? x),
                type: normalizeText(x?.type ?? ""),
              }))
              .filter((x) => x.url.length > 0);

            for (let i = 0; i < custom.length; i++) {
              const it = custom[i];
              const tr = document.createElement("tr");
              tr.setAttribute("data-contact-kind", "social");
              tr.setAttribute("data-contact-index", String(i));

              const tdUrl = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = it.url;
                tdUrl.appendChild(s);
              }
              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = it.type || "x";
                tdType.appendChild(s);
              }

              const edit = document.createElement("a");
              edit.href = "#";
              edit.className = "c-link c-link--action";
              edit.textContent = "modifica";
              edit.setAttribute("data-contact-action", "edit");
              edit.setAttribute("data-contact-kind", "social");

              const remove = document.createElement("a");
              remove.href = "#";
              remove.className = "c-link c-link--action";
              remove.textContent = "rimuovi";
              remove.setAttribute("data-contact-action", "remove");
              remove.setAttribute("data-contact-kind", "social");

              const actions = document.createElement("span");
              actions.className = "journalist-contact-row-actions";
              actions.appendChild(edit);
              actions.appendChild(remove);
              tdUrl.appendChild(actions);

              tr.appendChild(tdUrl);
              tr.appendChild(tdType);
              tbody.appendChild(tr);
            }

            const program = normalizeText(j?.social);
            if (program) {
              const tr = document.createElement("tr");
              const tdUrl = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-value";
                s.textContent = program;
                tdUrl.appendChild(s);
              }
              const tdType = document.createElement("td");
              {
                const s = document.createElement("span");
                s.className = "journalist-contact-cell t-label";
                s.textContent = "x";
                tdType.appendChild(s);
              }
              tr.appendChild(tdUrl);
              tr.appendChild(tdType);
              tbody.appendChild(tr);
            }

            if (!program && custom.length === 0) {
              const tr = document.createElement("tr");
              const td = document.createElement("td");
              td.colSpan = 2;
              td.innerHTML = '<span class="muted">n/d</span>';
              tr.appendChild(td);
              tbody.appendChild(tr);
            }

            j.customSocials = custom;
          };

          renderSocial();

          socialGroup.appendChild(
            makeGroupHeader("Social", "aggiungi social", "social"),
          );
          socialGroup.appendChild(socialEditor);
          socialGroup.appendChild(socialList);

          contactsGroups.appendChild(telGroup);
          contactsGroups.appendChild(emailGroup);
          contactsGroups.appendChild(socialGroup);

          const contactsBody = document.createElement("div");
          contactsBody.className = "journalist-section__body";
          contactsBody.setAttribute("data-section-body", "");
          contactsBody.hidden = !contactsOpen;
          contactsBody.appendChild(contactsGroups);

          contactsSection.appendChild(contactsHeader);
          contactsSection.appendChild(contactsBody);

          const redazioniSection = document.createElement("section");
          redazioniSection.className = "journalist-section";

          const redazioniOpen = getSectionOpen("redazioni", true);

          const redazioniHeader = document.createElement("div");
          redazioniHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          redazioniHeader.setAttribute("data-section-toggle", "redazioni");
          redazioniHeader.setAttribute("role", "button");
          redazioniHeader.setAttribute("tabindex", "0");
          redazioniHeader.setAttribute(
            "aria-expanded",
            redazioniOpen ? "true" : "false",
          );

          const redazioniTitle = document.createElement("div");
          redazioniTitle.className = "journalist-section__title";

          const redazioniHeading = document.createElement("h3");
          redazioniHeading.className = "journalist-section__heading";
          redazioniHeading.textContent = "REDAZIONI";

          const redazioniMeta = document.createElement("span");
          redazioniMeta.className = "muted";
          redazioniMeta.textContent = "con cui collabora";

          const redazioniAdd = document.createElement("a");
          redazioniAdd.href = "#";
          redazioniAdd.className = "c-link c-link--action";
          redazioniAdd.textContent = "aggiungi redazione";

          redazioniTitle.appendChild(redazioniHeading);
          redazioniTitle.appendChild(redazioniMeta);
          redazioniTitle.appendChild(redazioniAdd);
          redazioniHeader.appendChild(redazioniTitle);

          const redazioniToggle = document.createElement("span");
          redazioniToggle.className = "journalist-section__toggle";
          redazioniToggle.textContent = redazioniOpen ? "-" : "+";
          redazioniToggle.setAttribute("aria-hidden", "true");
          redazioniHeader.appendChild(redazioniToggle);

          const redazioniList = document.createElement("ul");
          redazioniList.className = "journalist-list";

          const makeRedazioneTable = (servizio, ruolo, telRedazione) => {
            const wrap = document.createElement("div");
            wrap.className = "journalist-list__table";

            const table = document.createElement("table");
            table.className = "journalist-contact-table";

            const colgroup = document.createElement("colgroup");
            const col1 = document.createElement("col");
            col1.style.width = "24ch";
            const col2 = document.createElement("col");
            col2.style.width = "16ch";
            colgroup.appendChild(col1);
            colgroup.appendChild(col2);
            table.appendChild(colgroup);

            const tbody = document.createElement("tbody");
            table.appendChild(tbody);

            const makeRow = (value, label) => {
              const tr = document.createElement("tr");

              const tdValue = document.createElement("td");
              const sValue = document.createElement("span");
              sValue.className = "journalist-contact-cell t-value";
              sValue.textContent = String(value || "").trim() || "n/d";
              tdValue.appendChild(sValue);

              const tdLabel = document.createElement("td");
              const sLabel = document.createElement("span");
              sLabel.className = "journalist-contact-cell t-label";
              sLabel.textContent = String(label || "").trim();
              tdLabel.appendChild(sLabel);

              tr.appendChild(tdValue);
              tr.appendChild(tdLabel);
              return tr;
            };

            tbody.appendChild(makeRow(servizio, "servizio"));
            tbody.appendChild(makeRow(ruolo, "ruolo"));
            tbody.appendChild(makeRow(telRedazione, "tel redazione"));

            wrap.appendChild(table);
            return wrap;
          };

          {
            const journalistTestate = getJournalistTestate(j);
            if (!journalistTestate.length) {
              const li = document.createElement("li");
              li.innerHTML = '<span class="muted">n/d</span>';
              redazioniList.appendChild(li);
            } else {
              const journalistOutletIds = Array.isArray(j?.outletIds)
                ? j.outletIds.map((x) => String(x ?? "").trim()).filter(Boolean)
                : [];

              for (const tname of journalistTestate) {
                const li = document.createElement("li");

                const link = document.createElement("a");
                link.href = "#";
                link.className = "testata-link journalist-list__title";
                link.textContent = tname;
                link.setAttribute("data-testata", tname);

                {
                  const tKey = normalizeTestataKey(tname);
                  const t = testateByKey?.get?.(tKey) || null;
                  if (t && t.id) {
                    link.setAttribute("data-testata-key", String(t.id));
                  } else if (journalistOutletIds.length) {
                    const matched = journalistOutletIds
                      .map((oid) => testateByKey?.get?.(String(oid)))
                      .find(
                        (tx) =>
                          tx &&
                          normalizeTestataKey(String(tx?.nome || "")) === tKey,
                      );
                    if (matched && matched.id) {
                      link.setAttribute("data-testata-key", String(matched.id));
                    }
                  }
                }
                li.appendChild(link);

                const role = getJournalistRoleForTestata(j, tname);
                const servizio = getJournalistServiceForTestata(j, tname);
                const tKey = normalizeTestataKey(tname);
                const t = testateByKey.get(tKey);
                const telRedazione = String(
                  t?.redazione?.telRedazione || "",
                ).trim();

                li.appendChild(
                  makeRedazioneTable(servizio, role, telRedazione),
                );
                redazioniList.appendChild(li);
              }
            }
          }

          const redazioniBody = document.createElement("div");
          redazioniBody.className = "journalist-section__body";
          redazioniBody.setAttribute("data-section-body", "");
          redazioniBody.hidden = !redazioniOpen;
          redazioniBody.appendChild(redazioniList);

          redazioniSection.appendChild(redazioniHeader);
          redazioniSection.appendChild(redazioniBody);

          const articlesSection = document.createElement("section");
          articlesSection.className = "journalist-section";

          const articlesOpen = getSectionOpen("articles", true);

          const articlesHeader = document.createElement("div");
          articlesHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          articlesHeader.setAttribute("data-section-toggle", "articles");
          articlesHeader.setAttribute("role", "button");
          articlesHeader.setAttribute("tabindex", "0");
          articlesHeader.setAttribute(
            "aria-expanded",
            articlesOpen ? "true" : "false",
          );

          const articlesHeading = document.createElement("h3");
          articlesHeading.className = "journalist-section__heading";
          articlesHeading.textContent = "ARTICOLI";

          const articlesTitle = document.createElement("div");
          articlesTitle.className = "journalist-section__title";

          const articlesMeta = document.createElement("span");
          articlesMeta.className = "c-text";
          articlesMeta.textContent = "che ha scritto";

          const articlesLink = document.createElement("a");
          articlesLink.href = "#";
          articlesLink.className = "c-link c-link--action";
          articlesLink.textContent = "termini ricorrenti";

          articlesTitle.appendChild(articlesHeading);
          articlesTitle.appendChild(articlesMeta);
          articlesHeader.appendChild(articlesTitle);

          const articlesToggle = document.createElement("span");
          articlesToggle.className = "journalist-section__toggle";
          articlesToggle.textContent = articlesOpen ? "-" : "+";
          articlesToggle.setAttribute("aria-hidden", "true");
          articlesHeader.appendChild(articlesToggle);

          const articlesList = document.createElement("ul");
          articlesList.className = "journalist-list";
          {
            const items = getMockArticlesForService(j?.servizio);
            for (const it of items) {
              const li = document.createElement("li");

              const a = document.createElement("a");
              a.href = "#";
              a.className = "c-link c-link--nav journalist-list__title";
              a.textContent = String(it?.title || "");

              const date = document.createElement("div");
              date.className = "muted";
              date.textContent = String(it?.date || "");

              li.appendChild(a);
              li.appendChild(date);
              articlesList.appendChild(li);
            }
          }

          const wordCloud = document.createElement("div");
          wordCloud.className = "journalist-wordcloud";
          wordCloud.setAttribute("data-wordcloud", "");
          {
            const terms = getWordCloudTermsForService(j?.servizio);
            for (const t of terms) {
              const w = document.createElement("span");
              w.className = "journalist-wordcloud__word";
              w.textContent = String(t?.text || "");
              const fs = Number(t?.size || 0);
              if (Number.isFinite(fs) && fs > 0) {
                w.style.fontSize = `${fs}px`;
              }
              wordCloud.appendChild(w);
            }
          }

          const articlesBody = document.createElement("div");
          articlesBody.className = "journalist-section__body";
          articlesBody.setAttribute("data-section-body", "");
          articlesBody.hidden = !articlesOpen;
          articlesBody.appendChild(wordCloud);
          articlesBody.appendChild(articlesList);

          articlesSection.appendChild(articlesHeader);
          articlesSection.appendChild(articlesBody);

          const mailingSection = document.createElement("section");
          mailingSection.className = "journalist-section";

          const mailingOpen = getSectionOpen("mailing", true);

          const mailingHeader = document.createElement("div");
          mailingHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          mailingHeader.setAttribute("data-section-toggle", "mailing");
          mailingHeader.setAttribute("role", "button");
          mailingHeader.setAttribute("tabindex", "0");
          mailingHeader.setAttribute(
            "aria-expanded",
            mailingOpen ? "true" : "false",
          );

          const mailingTitle = document.createElement("div");
          mailingTitle.className = "journalist-section__title";

          const mailingHeading = document.createElement("h3");
          mailingHeading.className = "journalist-section__heading";
          mailingHeading.textContent = "MAILING LISTS";

          const mailingMeta = document.createElement("span");
          mailingMeta.className = "muted";
          mailingMeta.textContent = "a cui appartiene";

          mailingTitle.appendChild(mailingHeading);
          mailingTitle.appendChild(mailingMeta);
          mailingHeader.appendChild(mailingTitle);

          const mailingToggle = document.createElement("span");
          mailingToggle.className = "journalist-section__toggle";
          mailingToggle.textContent = mailingOpen ? "-" : "+";
          mailingToggle.setAttribute("aria-hidden", "true");
          mailingHeader.appendChild(mailingToggle);

          const mailingList = document.createElement("ul");
          mailingList.className = "journalist-list";
          mailingList.classList.add("journalist-mailing-list");

          const getTestateCountForJournalistIds = (journalistIds) => {
            const ids = Array.isArray(journalistIds) ? journalistIds : [];
            const keys = new Set();
            for (const jid of ids) {
              const id = String(jid || "").trim();
              if (!id) continue;
              const jx = (journalists || []).find(
                (x) => getJournalistId(x) === id,
              );
              if (!jx) continue;
              const testate = getJournalistTestate(jx);
              for (const tname of testate) {
                const k = normalizeTestataKey(tname);
                if (k) keys.add(k);
              }
            }
            return keys.size;
          };

          {
            const jid = getJournalistId(j);
            const allLists = Array.isArray(appState.mailingLists)
              ? appState.mailingLists
              : [];
            const lists = allLists.filter((ml) => {
              if (!ml || typeof ml !== "object") return false;
              const ids = Array.isArray(ml.journalistIds)
                ? ml.journalistIds
                : [];
              return ids.includes(jid);
            });

            if (!lists.length) {
              const li = document.createElement("li");
              li.innerHTML = '<span class="muted">n/d</span>';
              mailingList.appendChild(li);
            } else {
              for (const ml of lists) {
                const li = document.createElement("li");

                const titleRow = document.createElement("div");
                titleRow.className = "journalist-list__title-row";

                const link = document.createElement("a");
                link.href = "#";
                link.className = "testata-link journalist-list__title";
                link.textContent = String(ml?.name || "");
                link.addEventListener("click", (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  openMailingListById(String(ml?.id || ""));
                });

                const nJournalists = Array.isArray(ml?.journalistIds)
                  ? ml.journalistIds.length
                  : 0;
                const nTestate = getTestateCountForJournalistIds(
                  ml?.journalistIds,
                );
                const pill = document.createElement("span");
                pill.className = "pill";
                pill.textContent = `${nJournalists} giornalisti / ${nTestate} testate`;

                titleRow.appendChild(link);
                titleRow.appendChild(pill);

                const metaRow = document.createElement("div");
                metaRow.className = "journalist-list__meta-row";
                const metaLeft = document.createElement("span");
                metaLeft.className = "muted";
                const createdAt = Number(ml?.createdAt || 0);
                if (Number.isFinite(createdAt) && createdAt > 0) {
                  metaLeft.textContent = `modificata il ${new Date(createdAt).toLocaleDateString("it-IT")}`;
                } else {
                  metaLeft.textContent = "";
                }
                metaRow.appendChild(metaLeft);

                li.appendChild(titleRow);
                if (metaLeft.textContent) li.appendChild(metaRow);
                mailingList.appendChild(li);
              }
            }
          }

          const mailingBody = document.createElement("div");
          mailingBody.className = "journalist-section__body";
          mailingBody.setAttribute("data-section-body", "");
          mailingBody.hidden = !mailingOpen;
          mailingBody.appendChild(mailingList);

          mailingSection.appendChild(mailingHeader);
          mailingSection.appendChild(mailingBody);

          const shipmentsSection = document.createElement("section");
          shipmentsSection.className = "journalist-section";

          const shipmentsOpen = getSectionOpen("shipments", true);

          const shipmentsHeader = document.createElement("div");
          shipmentsHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          shipmentsHeader.setAttribute("data-section-toggle", "shipments");
          shipmentsHeader.setAttribute("role", "button");
          shipmentsHeader.setAttribute("tabindex", "0");
          shipmentsHeader.setAttribute(
            "aria-expanded",
            shipmentsOpen ? "true" : "false",
          );

          const shipmentsHeading = document.createElement("h3");
          shipmentsHeading.className = "journalist-section__heading";

          const shipmentsTitle = document.createElement("div");
          shipmentsTitle.className = "journalist-section__title";

          const shipmentsMeta = document.createElement("span");
          shipmentsMeta.className = "c-text";
          shipmentsMeta.textContent = "ricevute";

          shipmentsHeading.textContent = "SPEDIZIONI";

          shipmentsTitle.appendChild(shipmentsHeading);
          shipmentsTitle.appendChild(shipmentsMeta);
          shipmentsHeader.appendChild(shipmentsTitle);

          const shipmentsToggle = document.createElement("span");
          shipmentsToggle.className = "journalist-section__toggle";
          shipmentsToggle.textContent = shipmentsOpen ? "-" : "+";
          shipmentsToggle.setAttribute("aria-hidden", "true");
          shipmentsHeader.appendChild(shipmentsToggle);

          const shipmentsList = document.createElement("ul");
          shipmentsList.className = "journalist-list";
          shipmentsList.innerHTML = `
              <li>
                <div class="journalist-list__title-row">
                  <a href="#" class="c-link c-link--nav journalist-list__title">CS - Lancio nuova gamma SUV elettrici premium</a>
                  <span class="c-pill">aperta</span>
                </div>
                <div class="journalist-list__meta-row">
                  <span class="muted">Spedita il 8-5-2025</span>
                </div>
              </li>
              <li>
                <div class="journalist-list__title-row">
                  <a href="#" class="c-link c-link--nav journalist-list__title">CS - Record vendite auto ibride nel primo trimestre 2025</a>
                  <span class="c-pill">chiusa</span>
                </div>
                <div class="journalist-list__meta-row">
                  <span class="muted">Spedita il 15-3-2025</span>
                </div>
              </li>
          `;

          const shipmentsBody = document.createElement("div");
          shipmentsBody.className = "journalist-section__body";
          shipmentsBody.setAttribute("data-section-body", "");
          shipmentsBody.hidden = !shipmentsOpen;
          shipmentsBody.appendChild(shipmentsList);

          shipmentsSection.appendChild(shipmentsHeader);
          shipmentsSection.appendChild(shipmentsBody);

          const notesSection = document.createElement("section");
          notesSection.className = "journalist-section";

          notesSection.setAttribute("data-journalist-notes", "");
          notesSection.setAttribute("data-jid", jid);

          const notesHeader = document.createElement("div");
          notesHeader.className =
            "journalist-section__header journalist-section__header--collapsible";
          notesHeader.setAttribute("data-section-toggle", "notes");
          notesHeader.setAttribute("role", "button");
          notesHeader.setAttribute("tabindex", "0");

          const notesTitle = document.createElement("div");
          notesTitle.className = "journalist-section__title";

          const notesHeading = document.createElement("h3");
          notesHeading.className = "journalist-section__heading";
          notesHeading.textContent = "NOTE";

          notesTitle.appendChild(notesHeading);

          const addNote = document.createElement("a");
          addNote.href = "#";
          addNote.className = "c-link c-link--action";
          addNote.textContent = "aggiungi nota";
          addNote.setAttribute("data-note-action", "add");

          notesTitle.appendChild(addNote);
          notesHeader.appendChild(notesTitle);

          const notesOpen = getSectionOpen("notes", false);

          notesHeader.setAttribute(
            "aria-expanded",
            notesOpen ? "true" : "false",
          );

          const notesToggle = document.createElement("span");
          notesToggle.className = "journalist-section__toggle";
          notesToggle.textContent = notesOpen ? "-" : "+";
          notesToggle.setAttribute("aria-hidden", "true");
          notesHeader.appendChild(notesToggle);

          const notesList = document.createElement("div");
          notesList.className = "journalist-notes";
          notesList.setAttribute("data-note-list", "");

          const notesEditor = document.createElement("div");
          notesEditor.className = "journalist-note-editor";
          notesEditor.setAttribute("data-note-editor", "");
          notesEditor.hidden = true;

          const notesTextarea = document.createElement("textarea");
          notesTextarea.className = "journalist-note-textarea";
          notesTextarea.setAttribute("data-note-textarea", "");

          const notesEditorActions = document.createElement("div");
          notesEditorActions.className = "journalist-note-editor-actions";

          const notesOk = document.createElement("a");
          notesOk.href = "#";
          notesOk.className = "c-link c-link--action";
          notesOk.textContent = "ok";
          notesOk.setAttribute("data-note-action", "ok");

          const notesCancel = document.createElement("a");
          notesCancel.href = "#";
          notesCancel.className = "c-link c-link--action";
          notesCancel.textContent = "annulla";
          notesCancel.setAttribute("data-note-action", "cancel");

          notesEditorActions.appendChild(notesOk);
          notesEditorActions.appendChild(notesCancel);

          notesEditor.appendChild(notesTextarea);
          notesEditor.appendChild(notesEditorActions);

          const renderNotesList = (arr) => {
            notesList.innerHTML = "";
            const items = normalizeNoteItems(arr);
            if (!items.length) {
              const empty = document.createElement("div");
              empty.className = "muted";
              empty.textContent = "nessuna nota";
              notesList.appendChild(empty);
              return;
            }

            for (let i = 0; i < items.length; i++) {
              const itemText = items[i]?.text;
              const itemDate = items[i]?.updatedAt;
              const item = document.createElement("div");
              item.className = "journalist-note-item";
              item.setAttribute("data-note-index", String(i));

              const text = document.createElement("div");
              text.className = "journalist-note-text t-value";
              text.textContent = itemText;

              const footer = document.createElement("div");
              footer.className = "journalist-note-footer";

              const date = document.createElement("span");
              date.className = "t-value";
              date.textContent = formatNoteDate(itemDate);

              const edit = document.createElement("a");
              edit.href = "#";
              edit.className = "c-link c-link--action";
              edit.textContent = "modifica";
              edit.setAttribute("data-note-action", "edit");

              const remove = document.createElement("a");
              remove.href = "#";
              remove.className = "c-link c-link--action";
              remove.textContent = "rimuovi";
              remove.setAttribute("data-note-action", "remove");

              footer.appendChild(date);
              footer.appendChild(edit);
              footer.appendChild(remove);

              item.appendChild(text);
              item.appendChild(footer);

              notesList.appendChild(item);
            }
          };

          renderNotesList(j?.note);

          const notesBody = document.createElement("div");
          notesBody.className = "journalist-section__body";
          notesBody.setAttribute("data-section-body", "");
          notesBody.hidden = !notesOpen;
          notesBody.appendChild(notesEditor);
          notesBody.appendChild(notesList);

          notesSection.appendChild(notesHeader);
          notesSection.appendChild(notesBody);

          mainCol.appendChild(notesSection);
          mainCol.appendChild(topicsSection);
          mainCol.appendChild(contactsSection);
          mainCol.appendChild(redazioniSection);
          mainCol.appendChild(articlesSection);
          mainCol.appendChild(mailingSection);
          mainCol.appendChild(shipmentsSection);

          grid.appendChild(mainCol);

          sheet.appendChild(grid);

          testataPanelBody.appendChild(sheet);

          initSplitButtons();
          split.addEventListener(
            "split-button-action",
            (e) => {
              const action = e?.detail?.action;
              if (!action) return;
              if (action === "add-to-list") {
                openAddToListModal({
                  anchorEl: testataPanel,
                  journalistIds: [jid],
                });
                return;
              }
              if (action === "add-to-shipment") {
                openAddToShipmentModal({
                  anchorEl: testataPanel,
                  journalistIds: [jid],
                });
                return;
              }
            },
            true,
          );
        }

        testataOverlay.classList.add("show");
        testataPanel.classList.add("show");
        testataOverlay.setAttribute("aria-hidden", "false");
        testataPanel.setAttribute("aria-hidden", "false");
      }

      function closeTestataPanel() {
        testataOverlay.classList.remove("show");
        testataPanel.classList.remove("show");
        testataOverlay.setAttribute("aria-hidden", "true");
        testataPanel.setAttribute("aria-hidden", "true");
      }

      function openNotesModal(jid) {
        if (
          !notesModal ||
          !notesModalOverlay ||
          !notesModalTitle ||
          !notesModalBody
        )
          return;

        const j = (journalists || []).find((x) => getJournalistId(x) === jid);
        const titleName = j ? `${j.nome} ${j.cognome}` : jid;

        notesModalTitle.textContent = `Note — ${titleName}`;
        notesModalBody.innerHTML = "";

        const notesArr = normalizeNoteItems(j?.note);
        const list = document.createElement("ul");
        list.className = "notes-modal-list";

        if (!notesArr.length) {
          const li = document.createElement("li");
          li.textContent = "nessuna nota";
          list.appendChild(li);
        } else {
          for (const n of notesArr) {
            const li = document.createElement("li");
            li.textContent = n.text;
            list.appendChild(li);
          }
        }

        notesModalBody.appendChild(list);

        notesModalOverlay.classList.add("show");
        notesModal.classList.add("show");
        notesModalOverlay.setAttribute("aria-hidden", "false");
        notesModal.setAttribute("aria-hidden", "false");
      }

      function openTestataJournalistsModal(testataKey) {
        if (
          !notesModal ||
          !notesModalOverlay ||
          !notesModalTitle ||
          !notesModalBody
        )
          return;

        const k = String(testataKey || "").trim();
        const t = testateByKey.get(k);
        const titleName = t ? String(t?.nome || "") : k;

        notesModalTitle.textContent = `Giornalisti — ${titleName}`;
        notesModalBody.innerHTML = "";

        const jids = Array.isArray(t?.redazione?.giornalisti)
          ? t.redazione.giornalisti
          : [];
        const cleanJids = [...jids].filter(Boolean);
        if (!cleanJids.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "nessun giornalista";
          notesModalBody.appendChild(empty);
        } else {
          const table = document.createElement("table");
          table.className = "testata-panel-journalists-table";

          const thead = document.createElement("thead");
          const headRow = document.createElement("tr");
          const headers = ["", "Nome", "Servizio", "Ruolo", "Tel", "Email"];
          for (const h of headers) {
            const th = document.createElement("th");
            th.textContent = h;
            headRow.appendChild(th);
          }
          thead.appendChild(headRow);

          const tbody = document.createElement("tbody");
          const rows = cleanJids
            .map((jid) => {
              const j = (journalists || []).find(
                (x) => getJournalistId(x) === jid,
              );
              const name = j
                ? `${String(j?.nome || "").trim()} ${String(
                    j?.cognome || "",
                  ).trim()}`.trim()
                : getJournalistNameById(jid);
              return {
                jid,
                name,
                servizio: j ? String(j?.servizio || "") : "",
                ruolo: j ? String(j?.ruolo || "") : "",
                tel: j ? String(j?.telefono || "") : "",
                email: j ? String(j?.email || "") : "",
              };
            })
            .sort((a, b) =>
              String(a.name || "").localeCompare(String(b.name || ""), "it", {
                sensitivity: "base",
              }),
            );

          for (const item of rows) {
            const jid = item.jid;
            const tr = document.createElement("tr");

            const checkboxId = `testata-modal-select-${jid.replace(
              /[^a-zA-Z0-9_-]/g,
              "_",
            )}`;

            const tdCb = document.createElement("td");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.className = "testata-panel-select";
            cb.id = checkboxId;
            cb.setAttribute("data-jid", jid);
            cb.checked = selectedJournalistIds.has(jid);
            cb.addEventListener("change", (e) => {
              e.stopPropagation();
              if (cb.checked) {
                selectedJournalistIds.add(jid);
                ensureSelectedOrder(jid);
                openSelectedPanel();
              } else {
                selectedJournalistIds.delete(jid);
                removeFromSelectedOrder(jid);
                if (selectedJournalistIds.size === 0) {
                  closeSelectedPanel();
                } else {
                  renderSelectedPanelList();
                }
              }
              updateCheckboxUI(jid);
              updateCardSelectionUI(jid);
            });
            tdCb.appendChild(cb);

            const tdName = document.createElement("td");
            const nameLink = document.createElement("a");
            nameLink.href = "#";
            nameLink.className = "testata-link journalist-link";
            nameLink.textContent = item.name;
            nameLink.setAttribute("data-journalist", item.name);
            tdName.appendChild(nameLink);

            const tdServizio = document.createElement("td");
            tdServizio.textContent = item.servizio;

            const tdRuolo = document.createElement("td");
            tdRuolo.textContent = item.ruolo;

            const tdTel = document.createElement("td");
            tdTel.textContent = item.tel;

            const tdEmail = document.createElement("td");
            tdEmail.textContent = item.email;

            tr.appendChild(tdCb);
            tr.appendChild(tdName);
            tr.appendChild(tdServizio);
            tr.appendChild(tdRuolo);
            tr.appendChild(tdTel);
            tr.appendChild(tdEmail);
            tbody.appendChild(tr);
          }

          table.appendChild(thead);
          table.appendChild(tbody);
          notesModalBody.appendChild(table);
        }

        notesModalOverlay.classList.add("show");
        notesModal.classList.add("show");
        notesModalOverlay.setAttribute("aria-hidden", "false");
        notesModal.setAttribute("aria-hidden", "false");
      }

      function openTestataNotesModal(testataKey) {
        if (
          !notesModal ||
          !notesModalOverlay ||
          !notesModalTitle ||
          !notesModalBody
        )
          return;

        const k = String(testataKey || "").trim();
        const t = testateByKey.get(k);
        const titleName = t ? String(t?.nome || "") : k;

        notesModalTitle.textContent = `Note — ${titleName}`;
        notesModalBody.innerHTML = "";

        const notesArr = normalizeNoteItems(t?.note);
        const list = document.createElement("ul");
        list.className = "notes-modal-list";

        if (!notesArr.length) {
          const li = document.createElement("li");
          li.textContent = "nessuna nota";
          list.appendChild(li);
        } else {
          for (const n of notesArr) {
            const li = document.createElement("li");
            li.textContent = n.text;
            list.appendChild(li);
          }
        }

        notesModalBody.appendChild(list);

        notesModalOverlay.classList.add("show");
        notesModal.classList.add("show");
        notesModalOverlay.setAttribute("aria-hidden", "false");
        notesModal.setAttribute("aria-hidden", "false");
      }

      function closeNotesModal() {
        if (!notesModal || !notesModalOverlay) return;
        notesModalOverlay.classList.remove("show");
        notesModal.classList.remove("show");
        notesModalOverlay.setAttribute("aria-hidden", "true");
        notesModal.setAttribute("aria-hidden", "true");
      }

      function openJournalistTestateModal(jid) {
        if (
          !notesModal ||
          !notesModalOverlay ||
          !notesModalTitle ||
          !notesModalBody
        )
          return;

        const j = (journalists || []).find((x) => getJournalistId(x) === jid);
        const titleName = j ? `${j.nome} ${j.cognome}` : jid;

        notesModalTitle.textContent = `Testate — ${titleName}`;
        notesModalBody.innerHTML = "";

        const testate = j ? getJournalistTestate(j) : [];
        const list = document.createElement("ul");
        list.className = "notes-modal-list";

        if (!testate.length) {
          const li = document.createElement("li");
          li.textContent = "n/d";
          list.appendChild(li);
        } else {
          for (const tname of testate) {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.href = "#";
            a.className = "testata-link";
            a.textContent = tname;
            a.setAttribute("data-testata", tname);
            li.appendChild(a);
            list.appendChild(li);
          }
        }

        notesModalBody.appendChild(list);

        notesModalOverlay.classList.add("show");
        notesModal.classList.add("show");
        notesModalOverlay.setAttribute("aria-hidden", "false");
        notesModal.setAttribute("aria-hidden", "false");
      }

      function updateJournalistTestateLabelLinks(root) {
        const container = root || document;
        const cards = container.querySelectorAll(".card[data-jid]");
        for (const card of cards) {
          const valueEl = card.querySelector(".card-testate");
          const labelHost = card.querySelector(
            ".card-journalist-testate-open, .card-journalist-testate-label",
          );
          if (!valueEl || !labelHost) continue;

          const jid = String(labelHost.getAttribute("data-jid") || "").trim();
          if (!jid) continue;

          const j = (journalists || []).find((x) => getJournalistId(x) === jid);
          const hasData = (j ? getJournalistTestate(j) : []).length > 0;
          if (!hasData) {
            const span = document.createElement("span");
            span.className = "card-journalist-testate-label";
            span.setAttribute("data-jid", jid);
            span.textContent = "Testate";
            labelHost.replaceWith(span);
            continue;
          }

          const isTruncated = (() => {
            const clampedRect = valueEl.getBoundingClientRect();
            if (!clampedRect.width || !clampedRect.height) return false;

            const measureHost =
              valueEl.closest(".card-row") || valueEl.parentElement || card;

            const clone = valueEl.cloneNode(true);
            clone.style.position = "absolute";
            clone.style.visibility = "hidden";
            clone.style.pointerEvents = "none";
            clone.style.left = "-99999px";
            clone.style.top = "-99999px";
            clone.style.width = `${clampedRect.width}px`;
            clone.style.maxHeight = "none";
            clone.style.minHeight = "0";
            clone.style.height = "auto";
            clone.style.overflow = "visible";
            clone.style.textOverflow = "clip";

            clone.style.display = "block";
            clone.style.webkitBoxOrient = "unset";
            clone.style.webkitLineClamp = "unset";
            clone.style.lineClamp = "unset";

            measureHost.appendChild(clone);
            const fullH = clone.getBoundingClientRect().height;
            clone.remove();

            return fullH > clampedRect.height + 2;
          })();

          if (isTruncated) {
            const a = document.createElement("a");
            a.href = "#";
            a.className = "card-label-link card-journalist-testate-open";
            a.setAttribute("data-jid", jid);
            a.textContent = "Testate";
            labelHost.replaceWith(a);
          } else {
            const span = document.createElement("span");
            span.className = "card-journalist-testate-label";
            span.setAttribute("data-jid", jid);
            span.textContent = "Testate";
            labelHost.replaceWith(span);
          }
        }
      }

      if (notesModalBody) {
        notesModalBody.addEventListener("click", (e) => {
          const journalistLink = e.target?.closest?.(".journalist-link");
          if (journalistLink) {
            e.preventDefault();
            e.stopPropagation();
            const name =
              journalistLink.getAttribute("data-journalist") ||
              journalistLink.textContent;
            closeNotesModal();
            openJournalistPanel(name);
            return;
          }

          const testataLink = e.target?.closest?.(".testata-link");
          if (testataLink) {
            e.preventDefault();
            e.stopPropagation();
            const key = testataLink.getAttribute("data-testata-key");
            const testata =
              testataLink.getAttribute("data-testata") ||
              testataLink.textContent;
            closeNotesModal();
            openTestataPanel(key || testata);
          }
        });
      }

      if (notesModalClose) {
        notesModalClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeNotesModal();
        });
      }

      if (notesModalOverlay) {
        notesModalOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeNotesModal();
        });
      }

      if (testataPanelClose) {
        testataPanelClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeTestataPanel();
        });
      }

      if (testataOverlay) {
        testataOverlay.addEventListener("click", (e) => {
          e.preventDefault();
          closeTestataPanel();
        });
      }

      if (chooseDatabaseLink) {
        chooseDatabaseLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openBancaDatiPanel();
        });
      }

      if (mailingListRenameLink) {
        mailingListRenameLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openRenameListModal();
        });
      }

      if (mailingListDuplicateLink) {
        mailingListDuplicateLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          duplicateActiveMailingList();
        });
      }

      if (mailingListExportLink) {
        mailingListExportLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      }

      if (mailingListDeleteLink) {
        mailingListDeleteLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const activeList = getMailingListById(appState.activeMailingListId);
          if (!activeList) return;

          const id = String(activeList.id || "").trim();
          const name = String(activeList.name || "").trim();
          if (!id) return;

          const ok = window.confirm(`Eliminare la mailing list "${name}"?`);
          if (!ok) return;

          appState.mailingLists = (appState.mailingLists || []).filter(
            (x) => String(x?.id || "") !== id,
          );
          if (String(appState.activeMailingListId || "") === id) {
            appState.activeMailingListId = "";
          }
          saveAppState(appState);
          renderDashboardMailingLists();
          renderDashboardSpedizioni();
          renderDashboardComunicati();

          window.location.hash = "#dashboard";
        });
      }

      if (mailingListSendLink) {
        mailingListSendLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openSpedisciListaView();
        });
      }

      if (shipmentAiSuggestionsLink) {
        shipmentAiSuggestionsLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      }

      if (sortByNameAscLink) {
        sortByNameAscLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setSortMode("name-asc");
        });
      }

      if (sortByNameDescLink) {
        sortByNameDescLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setSortMode("name-desc");
        });
      }

      if (sortByRoleLink) {
        sortByRoleLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setSortMode("role");
        });
      }

      if (sortByMediaTypeLink) {
        sortByMediaTypeLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setSortMode("media-type");
        });
      }

      if (sortByFrequencyLink) {
        sortByFrequencyLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setSortMode("frequency");
        });
      }

      function closeSortByNameMenu() {
        if (!sortByNameSelectMenu || !sortByNameSelectTrigger) return;
        sortByNameSelectMenu.classList.remove("show");
        sortByNameSelectMenu.setAttribute("aria-hidden", "true");
        sortByNameSelectTrigger.setAttribute("aria-expanded", "false");
      }

      function toggleSortByNameMenu() {
        if (!sortByNameSelectMenu || !sortByNameSelectTrigger) return;
        const isOpen = sortByNameSelectMenu.classList.contains("show");
        if (isOpen) {
          closeSortByNameMenu();
        } else {
          sortByNameSelectMenu.classList.add("show");
          sortByNameSelectMenu.setAttribute("aria-hidden", "false");
          sortByNameSelectTrigger.setAttribute("aria-expanded", "true");
        }
      }

      if (sortByNameSelectTrigger) {
        sortByNameSelectTrigger.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleSortByNameMenu();
        });
      }

      if (sortByNameSelectMenu) {
        sortByNameSelectMenu.addEventListener("click", (e) => {
          const item = e.target?.closest?.(".dropdown-item[data-sort]");
          if (!item) return;
          e.preventDefault();
          e.stopPropagation();
          let mode = String(item.getAttribute("data-sort") || "")
            .trim()
            .toLowerCase();
          if (!mode) return;
          const mainMode = getMainMode();
          const isTestateMode = mainMode === "testate";
          if (isTestateMode && mode === "role") mode = "frequency";
          setSortMode(mode);
          closeSortByNameMenu();
        });
      }

      document.addEventListener(
        "click",
        (e) => {
          if (!sortByNameSelectMenu || !sortByNameSelectTrigger) return;
          if (!sortByNameSelectMenu.classList.contains("show")) return;
          const t = e.target;
          if (sortByNameSelect && sortByNameSelect.contains(t)) return;
          closeSortByNameMenu();
        },
        true,
      );

      document.addEventListener(
        "keydown",
        (e) => {
          if (e.key !== "Escape") return;
          if (!sortByNameSelectMenu || !sortByNameSelectTrigger) return;
          if (!sortByNameSelectMenu.classList.contains("show")) return;
          e.preventDefault();
          e.stopPropagation();
          closeSortByNameMenu();
        },
        true,
      );

      function selectAllFilteredCards() {
        const grid = document.getElementById("cardsGrid");
        const ids = Array.isArray(lastRenderedVisibleJournalistIds)
          ? lastRenderedVisibleJournalistIds
              .map((x) => String(x || "").trim())
              .filter(Boolean)
          : [];

        if (!ids.length && grid) {
          const idsSet = new Set();
          for (const el of grid.querySelectorAll(".card-select[data-jid]")) {
            const jid = String(el.getAttribute("data-jid") || "").trim();
            if (jid) idsSet.add(jid);
          }
          for (const el of grid.querySelectorAll(".card[data-jid]")) {
            const jid = String(el.getAttribute("data-jid") || "").trim();
            if (jid) idsSet.add(jid);
          }
          ids.push(...Array.from(idsSet));
        }
        if (!ids.length) return;

        for (let i = ids.length - 1; i >= 0; i--) {
          const jid = String(ids[i] || "").trim();
          if (!jid) continue;
          selectedJournalistIds.add(jid);
          ensureSelectedOrder(jid);
        }

        if (grid) {
          for (const card of grid.querySelectorAll(".card[data-jid]")) {
            const jid = String(card.getAttribute("data-jid") || "").trim();
            if (!jid) continue;
            updateCheckboxUI(jid);
            updateCardSelectionUI(jid);
          }
        }

        openSelectedPanel();
        scheduleRender();
      }

      function deselectAllCards() {
        selectedJournalistIds.clear();
        selectedJournalistOrder.length = 0;

        document
          .querySelectorAll(".card-select, .testata-panel-select")
          .forEach((el) => {
            el.checked = false;
          });
        document.querySelectorAll(".card.is-selected").forEach((el) => {
          el.classList.remove("is-selected");
        });

        renderSelectedPanelList();
        closeSelectedPanel();
      }

      if (selectAllLink) {
        selectAllLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          selectAllFilteredCards();
        });
      }

      if (testataPanelBody) {
        testataPanelBody.addEventListener("click", (e) => {
          const sectionToggleEl = e.target?.closest?.("[data-section-toggle]");
          if (sectionToggleEl) {
            const key = String(
              sectionToggleEl.getAttribute("data-section-toggle") || "",
            )
              .trim()
              .toLowerCase();
            if (!key) return;

            const section = sectionToggleEl.closest("section");
            if (!section) return;

            const body = section.querySelector("[data-section-body]");
            const indicator = section.querySelector(
              ".journalist-section__toggle",
            );
            if (!body || !indicator) return;

            if (e.target?.closest?.("a")) {
              if (body.hidden) {
                body.hidden = false;
                indicator.textContent = "-";
                sectionToggleEl.setAttribute("aria-expanded", "true");
                setSectionOpen(key, true);
              }
            } else {
              e.preventDefault();
              e.stopPropagation();

              const nextOpen = !!body.hidden;
              body.hidden = !nextOpen;
              indicator.textContent = nextOpen ? "-" : "+";
              sectionToggleEl.setAttribute(
                "aria-expanded",
                nextOpen ? "true" : "false",
              );
              setSectionOpen(key, nextOpen);
              return;
            }
          }

          const redazioniToggleEl = e.target?.closest?.(
            "[data-redazioni-toggle]",
          );
          if (redazioniToggleEl) {
            e.preventDefault();
            e.stopPropagation();

            const toggleKey = String(
              redazioniToggleEl.getAttribute("data-redazioni-toggle") || "",
            ).trim();
            if (!toggleKey) return;

            const node = redazioniToggleEl.closest("[data-redazioni-node]");
            const body = node?.querySelector?.("[data-redazioni-body]");
            if (!body) return;

            const nextOpen = !!body.hidden;
            body.hidden = !nextOpen;
            redazioniToggleEl.setAttribute(
              "aria-expanded",
              nextOpen ? "true" : "false",
            );
            setSectionOpen(toggleKey, nextOpen);
            return;
          }

          const noteActionEl = e.target?.closest?.("[data-note-action]");
          if (noteActionEl) {
            const notesSection = noteActionEl.closest(
              "[data-journalist-notes]",
            );
            if (notesSection) {
              e.preventDefault();
              e.stopPropagation();

              const notesBody = notesSection.querySelector(
                "[data-section-body]",
              );
              const notesHeader = notesSection.querySelector(
                '[data-section-toggle="notes"]',
              );
              const notesIndicator = notesSection.querySelector(
                ".journalist-section__toggle",
              );

              const setNotesOpen = (open) => {
                if (notesBody) notesBody.hidden = !open;
                if (notesHeader) {
                  notesHeader.setAttribute(
                    "aria-expanded",
                    open ? "true" : "false",
                  );
                }
                if (notesIndicator) {
                  notesIndicator.textContent = open ? "-" : "+";
                }
                setSectionOpen("notes", !!open);
              };

              const action = String(
                noteActionEl.getAttribute("data-note-action") || "",
              )
                .trim()
                .toLowerCase();

              if (notesBody && notesBody.hidden) {
                setNotesOpen(true);
              }
              const jid = String(
                notesSection.getAttribute("data-jid") || "",
              ).trim();
              if (!jid) return;

              const j = (journalists || []).find(
                (x) => getJournalistId(x) === jid,
              );
              if (!j) return;

              const editor = notesSection.querySelector("[data-note-editor]");
              const textarea = notesSection.querySelector(
                "[data-note-textarea]",
              );
              const list = notesSection.querySelector("[data-note-list]");
              if (!editor || !textarea || !list) return;

              const getNoteItems = () => normalizeNoteItems(j.note);
              const setNoteItems = (arr) => {
                const clean = (arr || [])
                  .map((x) => ({
                    text: String(x?.text ?? "").trim(),
                    updatedAt: x?.updatedAt ? String(x.updatedAt) : "",
                  }))
                  .filter((x) => x.text.length > 0);
                j.note = clean;
              };

              const renderList = () => {
                const items = getNoteItems();
                list.innerHTML = "";
                if (!items.length) {
                  const empty = document.createElement("div");
                  empty.className = "muted";
                  empty.textContent = "nessuna nota";
                  list.appendChild(empty);
                  return;
                }

                for (let i = 0; i < items.length; i++) {
                  const itemText = items[i]?.text;
                  const itemDate = items[i]?.updatedAt;
                  const item = document.createElement("div");
                  item.className = "journalist-note-item";
                  item.setAttribute("data-note-index", String(i));

                  const text = document.createElement("div");
                  text.className = "journalist-note-text t-value";
                  text.textContent = itemText;

                  const footer = document.createElement("div");
                  footer.className = "journalist-note-footer";

                  const date = document.createElement("span");
                  date.className = "t-value";
                  date.textContent = formatNoteDate(itemDate);

                  const edit = document.createElement("a");
                  edit.href = "#";
                  edit.className = "c-link c-link--action";
                  edit.textContent = "modifica";
                  edit.setAttribute("data-note-action", "edit");

                  const remove = document.createElement("a");
                  remove.href = "#";
                  remove.className = "c-link c-link--action";
                  remove.textContent = "rimuovi";
                  remove.setAttribute("data-note-action", "remove");

                  footer.appendChild(date);
                  footer.appendChild(edit);
                  footer.appendChild(remove);

                  item.appendChild(text);
                  item.appendChild(footer);

                  list.appendChild(item);
                }
              };

              const showEditor = (mode, index, value) => {
                editor.hidden = false;
                editor.setAttribute("data-note-mode", mode);
                if (typeof index === "number") {
                  editor.setAttribute("data-note-edit-index", String(index));
                } else {
                  editor.removeAttribute("data-note-edit-index");
                }
                textarea.value = String(value ?? "");
                textarea.focus();
              };

              const hideEditor = () => {
                editor.hidden = true;
                editor.removeAttribute("data-note-mode");
                editor.removeAttribute("data-note-edit-index");
                textarea.value = "";
              };

              if (action === "add") {
                showEditor("add", null, "");
                return;
              }

              const noteItem = noteActionEl.closest("[data-note-index]");
              const indexRaw = noteItem?.getAttribute?.("data-note-index");
              const index = indexRaw != null ? Number(indexRaw) : NaN;

              if (action === "edit") {
                if (!Number.isFinite(index)) return;
                const items = getNoteItems();
                showEditor("edit", index, items[index]?.text ?? "");
                return;
              }

              if (action === "remove") {
                if (!Number.isFinite(index)) return;
                const items = getNoteItems();
                items.splice(index, 1);
                setNoteItems(items);
                hideEditor();
                renderList();
                return;
              }

              if (action === "cancel") {
                hideEditor();
                return;
              }

              if (action === "ok") {
                const value = String(textarea.value ?? "").trim();
                if (!value) {
                  hideEditor();
                  return;
                }

                const mode = String(editor.getAttribute("data-note-mode") || "")
                  .trim()
                  .toLowerCase();
                const items = getNoteItems();
                const nowIso = new Date().toISOString();

                if (mode === "edit") {
                  const editIndex = Number(
                    editor.getAttribute("data-note-edit-index"),
                  );
                  if (Number.isFinite(editIndex) && editIndex >= 0) {
                    const prev = items[editIndex] || {
                      text: "",
                      updatedAt: "",
                    };
                    items[editIndex] = {
                      text: value,
                      updatedAt: nowIso || prev.updatedAt,
                    };
                  }
                } else {
                  items.unshift({ text: value, updatedAt: nowIso });
                }

                setNoteItems(items);
                hideEditor();
                renderList();
                return;
              }
            }

            const testataNotesSection = noteActionEl.closest(
              "[data-testata-notes]",
            );
            if (testataNotesSection) {
              e.preventDefault();
              e.stopPropagation();

              const notesBody = testataNotesSection.querySelector(
                "[data-section-body]",
              );
              const notesHeader = testataNotesSection.querySelector(
                '[data-section-toggle="testata-notes"]',
              );
              const notesIndicator = testataNotesSection.querySelector(
                ".journalist-section__toggle",
              );

              const setNotesOpen = (open) => {
                if (notesBody) notesBody.hidden = !open;
                if (notesHeader) {
                  notesHeader.setAttribute(
                    "aria-expanded",
                    open ? "true" : "false",
                  );
                }
                if (notesIndicator) {
                  notesIndicator.textContent = open ? "-" : "+";
                }
                setSectionOpen("testata-notes", !!open);
              };

              const action = String(
                noteActionEl.getAttribute("data-note-action") || "",
              )
                .trim()
                .toLowerCase();

              if (notesBody && notesBody.hidden) {
                setNotesOpen(true);
              }

              const testataKey = String(
                testataNotesSection.getAttribute("data-testata-key") || "",
              ).trim();
              if (!testataKey) return;

              const t = testateByKey.get(testataKey);
              if (!t) return;

              const editor =
                testataNotesSection.querySelector("[data-note-editor]");
              const textarea = testataNotesSection.querySelector(
                "[data-note-textarea]",
              );
              const list =
                testataNotesSection.querySelector("[data-note-list]");
              if (!editor || !textarea || !list) return;

              const getNoteItems = () => normalizeNoteItems(t.note);
              const setNoteItems = (arr) => {
                const clean = (arr || [])
                  .map((x) => ({
                    text: String(x?.text ?? "").trim(),
                    updatedAt: x?.updatedAt ? String(x.updatedAt) : "",
                  }))
                  .filter((x) => x.text.length > 0);
                t.note = clean;
              };

              const renderList = () => {
                const items = getNoteItems();
                list.innerHTML = "";
                if (!items.length) {
                  const empty = document.createElement("div");
                  empty.className = "muted";
                  empty.textContent = "nessuna nota";
                  list.appendChild(empty);
                  return;
                }

                for (let i = 0; i < items.length; i++) {
                  const itemText = items[i]?.text;
                  const itemDate = items[i]?.updatedAt;
                  const item = document.createElement("div");
                  item.className = "journalist-note-item";
                  item.setAttribute("data-note-index", String(i));

                  const text = document.createElement("div");
                  text.className = "journalist-note-text t-value";
                  text.textContent = itemText;

                  const footer = document.createElement("div");
                  footer.className = "journalist-note-footer";

                  const date = document.createElement("span");
                  date.className = "t-value";
                  date.textContent = formatNoteDate(itemDate);

                  const edit = document.createElement("a");
                  edit.href = "#";
                  edit.className = "c-link c-link--action";
                  edit.textContent = "modifica";
                  edit.setAttribute("data-note-action", "edit");

                  const remove = document.createElement("a");
                  remove.href = "#";
                  remove.className = "c-link c-link--action";
                  remove.textContent = "rimuovi";
                  remove.setAttribute("data-note-action", "remove");

                  footer.appendChild(date);
                  footer.appendChild(edit);
                  footer.appendChild(remove);

                  item.appendChild(text);
                  item.appendChild(footer);
                  list.appendChild(item);
                }
              };

              const showEditor = (mode, index, value) => {
                editor.hidden = false;
                editor.setAttribute("data-note-mode", mode);
                if (typeof index === "number") {
                  editor.setAttribute("data-note-edit-index", String(index));
                } else {
                  editor.removeAttribute("data-note-edit-index");
                }
                textarea.value = String(value ?? "");
                textarea.focus();
              };

              const hideEditor = () => {
                editor.hidden = true;
                editor.removeAttribute("data-note-mode");
                editor.removeAttribute("data-note-edit-index");
                textarea.value = "";
              };

              if (action === "add") {
                showEditor("add", null, "");
                return;
              }

              const noteItem = noteActionEl.closest("[data-note-index]");
              const indexRaw = noteItem?.getAttribute?.("data-note-index");
              const index = indexRaw != null ? Number(indexRaw) : NaN;

              if (action === "edit") {
                if (!Number.isFinite(index)) return;
                const items = getNoteItems();
                showEditor("edit", index, items[index]?.text ?? "");
                return;
              }

              if (action === "remove") {
                if (!Number.isFinite(index)) return;
                const items = getNoteItems();
                items.splice(index, 1);
                setNoteItems(items);
                hideEditor();
                renderList();
                return;
              }

              if (action === "cancel") {
                hideEditor();
                return;
              }

              if (action === "ok") {
                const value = String(textarea.value ?? "").trim();
                if (!value) {
                  hideEditor();
                  return;
                }

                const mode = String(editor.getAttribute("data-note-mode") || "")
                  .trim()
                  .toLowerCase();
                const items = getNoteItems();
                const nowIso = new Date().toISOString();

                if (mode === "edit") {
                  const editIndex = Number(
                    editor.getAttribute("data-note-edit-index"),
                  );
                  if (Number.isFinite(editIndex) && editIndex >= 0) {
                    const prev = items[editIndex] || {
                      text: "",
                      updatedAt: "",
                    };
                    items[editIndex] = {
                      text: value,
                      updatedAt: nowIso || prev.updatedAt,
                    };
                  }
                } else {
                  items.unshift({ text: value, updatedAt: nowIso });
                }

                setNoteItems(items);
                hideEditor();
                renderList();
                return;
              }
            }
          }

          const topicActionEl = e.target?.closest?.("[data-topic-action]");
          if (topicActionEl) {
            const topicsSection = topicActionEl.closest(
              "[data-journalist-topics]",
            );
            if (topicsSection) {
              e.preventDefault();
              e.stopPropagation();

              const topicsBody = topicsSection.querySelector(
                "[data-section-body]",
              );
              const topicsHeader = topicsSection.querySelector(
                '[data-section-toggle="topics"]',
              );
              const topicsIndicator = topicsSection.querySelector(
                ".journalist-section__toggle",
              );

              const setTopicsOpen = (open) => {
                if (topicsBody) topicsBody.hidden = !open;
                if (topicsHeader) {
                  topicsHeader.setAttribute(
                    "aria-expanded",
                    open ? "true" : "false",
                  );
                }
                if (topicsIndicator) {
                  topicsIndicator.textContent = open ? "-" : "+";
                }
                setSectionOpen("topics", !!open);
              };

              if (topicsBody && topicsBody.hidden) {
                setTopicsOpen(true);
              }

              const action = String(
                topicActionEl.getAttribute("data-topic-action") || "",
              )
                .trim()
                .toLowerCase();
              const jid = String(
                topicsSection.getAttribute("data-jid") || "",
              ).trim();
              if (!jid) return;

              const j = (journalists || []).find(
                (x) => getJournalistId(x) === jid,
              );
              if (!j) return;

              const editor = topicsSection.querySelector("[data-topic-editor]");
              const input = topicsSection.querySelector("[data-topic-input]");
              const list = topicsSection.querySelector("[data-topic-list]");
              if (!editor || !input || !list) return;

              const normalizeCustom = (v) => {
                if (!Array.isArray(v)) return [];
                return v
                  .map((x) => {
                    if (typeof x === "object" && x) {
                      return {
                        name: String(
                          x.name ?? x.servizio ?? x.value ?? "",
                        ).trim(),
                      };
                    }
                    return { name: String(x ?? "").trim() };
                  })
                  .filter((x) => x.name.length > 0);
              };

              const setCustom = (arr) => {
                const clean = (arr || [])
                  .map((x) => ({ name: String(x?.name ?? "").trim() }))
                  .filter((x) => x.name.length > 0);
                j.customServices = clean;
              };

              const renderList = () => {
                const baseService = String(j?.servizio || "").trim();
                const custom = normalizeCustom(j?.customServices);
                list.innerHTML = "";

                for (let i = 0; i < custom.length; i++) {
                  const item = custom[i];
                  const li = document.createElement("li");
                  li.className = "journalist-topic-item";
                  li.setAttribute("data-topic-index", String(i));

                  const row = document.createElement("div");
                  row.className = "journalist-topic-row";

                  const name = document.createElement("span");
                  name.textContent = item.name;

                  const actions = document.createElement("span");
                  actions.className = "journalist-topic-actions";

                  const edit = document.createElement("a");
                  edit.href = "#";
                  edit.className = "c-link c-link--action";
                  edit.textContent = "modifica";
                  edit.setAttribute("data-topic-action", "edit");

                  const remove = document.createElement("a");
                  remove.href = "#";
                  remove.className = "c-link c-link--action";
                  remove.textContent = "rimuovi";
                  remove.setAttribute("data-topic-action", "remove");

                  actions.appendChild(edit);
                  actions.appendChild(remove);

                  row.appendChild(name);
                  row.appendChild(actions);

                  li.appendChild(row);
                  list.appendChild(li);
                }

                if (baseService) {
                  const li = document.createElement("li");
                  li.className = "journalist-topic-item";

                  const row = document.createElement("div");
                  row.className = "journalist-topic-row";

                  const name = document.createElement("span");
                  name.textContent = baseService;

                  const inText = document.createElement("span");
                  inText.textContent = "in";

                  const testataName = String(j?.testata || "").trim();
                  if (testataName) {
                    const link = document.createElement("a");
                    link.href = "#";
                    link.className = "c-link c-link--nav testata-link";
                    link.textContent = testataName;
                    link.setAttribute("data-testata", testataName);

                    row.appendChild(name);
                    row.appendChild(inText);
                    row.appendChild(link);
                  } else {
                    row.appendChild(name);
                  }

                  li.appendChild(row);
                  list.appendChild(li);
                }

                if (!baseService && custom.length === 0) {
                  const li = document.createElement("li");
                  li.className = "journalist-topic-item";
                  li.innerHTML = '<span class="muted">n/d</span>';
                  list.appendChild(li);
                }
              };

              const showEditor = (mode, index, value) => {
                editor.hidden = false;
                editor.setAttribute("data-topic-mode", mode);
                if (typeof index === "number") {
                  editor.setAttribute("data-topic-edit-index", String(index));
                } else {
                  editor.removeAttribute("data-topic-edit-index");
                }
                input.value = String(value ?? "");
                input.focus();
              };

              const hideEditor = () => {
                editor.hidden = true;
                editor.removeAttribute("data-topic-mode");
                editor.removeAttribute("data-topic-edit-index");
                input.value = "";
              };

              if (action === "add") {
                showEditor("add", null, "");
                return;
              }

              const topicItem = topicActionEl.closest("[data-topic-index]");
              const indexRaw = topicItem?.getAttribute?.("data-topic-index");
              const index = indexRaw != null ? Number(indexRaw) : NaN;

              if (action === "edit") {
                if (!Number.isFinite(index)) return;
                const custom = normalizeCustom(j?.customServices);
                showEditor("edit", index, custom[index]?.name ?? "");
                return;
              }

              if (action === "remove") {
                if (!Number.isFinite(index)) return;
                const custom = normalizeCustom(j?.customServices);
                custom.splice(index, 1);
                setCustom(custom);
                hideEditor();
                renderList();
                return;
              }

              if (action === "cancel") {
                hideEditor();
                return;
              }

              if (action === "ok") {
                const value = String(input.value ?? "").trim();
                if (!value) {
                  hideEditor();
                  return;
                }

                const mode = String(
                  editor.getAttribute("data-topic-mode") || "",
                )
                  .trim()
                  .toLowerCase();
                const custom = normalizeCustom(j?.customServices);

                if (mode === "edit") {
                  const editIndex = Number(
                    editor.getAttribute("data-topic-edit-index"),
                  );
                  if (Number.isFinite(editIndex) && editIndex >= 0) {
                    custom[editIndex] = { name: value };
                  }
                } else {
                  custom.unshift({ name: value });
                }

                setCustom(custom);
                hideEditor();
                renderList();
                return;
              }
            }
          }

          const contactActionEl = e.target?.closest?.("[data-contact-action]");
          if (contactActionEl) {
            const contactsSection = contactActionEl.closest(
              "[data-journalist-contacts]",
            );
            if (contactsSection) {
              e.preventDefault();
              e.stopPropagation();

              const action = String(
                contactActionEl.getAttribute("data-contact-action") || "",
              )
                .trim()
                .toLowerCase();
              const kind = String(
                contactActionEl.getAttribute("data-contact-kind") || "",
              )
                .trim()
                .toLowerCase();
              const jid = String(
                contactsSection.getAttribute("data-jid") || "",
              ).trim();
              if (!jid || !kind) return;

              const j = (journalists || []).find(
                (x) => getJournalistId(x) === jid,
              );
              if (!j) return;

              const group = contactsSection.querySelector(
                `[data-contact-group-kind="${kind}"]`,
              );
              if (!group) return;

              const editor = group.querySelector(
                `[data-contact-editor][data-contact-kind="${kind}"]`,
              );
              const list = group.querySelector(
                `[data-contact-list][data-contact-kind="${kind}"]`,
              );
              if (!editor || !list) return;

              const input = editor.querySelector(
                `[data-contact-input][data-contact-kind="${kind}"]`,
              );
              const select = editor.querySelector(
                `[data-contact-select][data-contact-kind="${kind}"]`,
              );
              const testataName = String(j?.testata || "").trim();

              const normalizeText = (v) => String(v ?? "").trim();

              const updateJournalistHeaderContacts = () => {
                const table = document.querySelector(
                  "[data-journalist-header-contacts]",
                );
                if (!table) return;

                const getPreferredContact = ({
                  customItems,
                  programItems,
                  preferred,
                  fallbackItem,
                }) => {
                  const custom = customItems.filter(
                    (x) => normalizeText(x.value).length > 0,
                  );
                  const program = programItems.filter(
                    (x) => normalizeText(x.value).length > 0,
                  );

                  if (program.length === 0 && fallbackItem) {
                    const v = normalizeText(fallbackItem.value);
                    if (v)
                      program.push({ value: v, label: fallbackItem.label });
                  }

                  if (preferred && typeof preferred === "object") {
                    const origin = normalizeText(
                      preferred.origin,
                    ).toLowerCase();
                    const idx = preferred.index;
                    if (
                      origin === "custom" &&
                      Number.isFinite(idx) &&
                      custom[idx]
                    ) {
                      return { ...custom[idx] };
                    }
                    if (
                      origin === "program" &&
                      Number.isFinite(idx) &&
                      program[idx]
                    ) {
                      return { ...program[idx] };
                    }
                  }

                  if (custom[0]) return { ...custom[0] };
                  if (program[0]) return { ...program[0] };
                  return null;
                };

                const phone = getPreferredContact({
                  customItems: (Array.isArray(j.customPhones)
                    ? j.customPhones
                    : []
                  ).map((x) => ({
                    value: normalizeText(x?.number ?? x?.tel ?? x?.value ?? x),
                    label:
                      normalizeText(x?.type ?? x?.kind ?? "") || "cellulare",
                  })),
                  programItems: (Array.isArray(j?.programPhones)
                    ? j.programPhones
                    : []
                  ).map((x) => ({
                    value: normalizeText(x?.number ?? x?.tel ?? x?.value ?? x),
                    label:
                      normalizeText(x?.type ?? x?.kind ?? "") || "cellulare",
                  })),
                  preferred: j?.preferredPhone,
                  fallbackItem: { value: j?.tel, label: "cellulare" },
                });

                const email = getPreferredContact({
                  customItems: (Array.isArray(j.customEmails)
                    ? j.customEmails
                    : []
                  ).map((x) => ({
                    value: normalizeText(x?.email ?? x?.value ?? x),
                    label: normalizeText(x?.type ?? "") || "mail diretta",
                  })),
                  programItems: (Array.isArray(j?.programEmails)
                    ? j.programEmails
                    : []
                  ).map((x) => ({
                    value: normalizeText(x?.email ?? x?.value ?? x),
                    label: normalizeText(x?.type ?? "") || "mail diretta",
                  })),
                  preferred: j?.preferredEmail,
                  fallbackItem: { value: j?.email, label: "mail diretta" },
                });

                const setCell = (key, text) => {
                  const el = table.querySelector(
                    `[data-header-contact="${key}"]`,
                  );
                  if (el) el.textContent = text;
                };

                setCell("phone-value", normalizeText(phone?.value) || "n/d");
                setCell("phone-label", normalizeText(phone?.label) || "");
                setCell("email-value", normalizeText(email?.value) || "n/d");
                setCell("email-label", normalizeText(email?.label) || "");
              };

              const setPreferred = (origin, index) => {
                if (kind === "phone") {
                  const items = Array.isArray(j.customPhones)
                    ? j.customPhones
                    : [];
                  for (let i = 0; i < items.length; i++) {
                    const it = items[i];
                    if (it && typeof it === "object") it.isPrimary = false;
                  }
                  if (origin === "custom" && Number.isFinite(index)) {
                    if (items[index] && typeof items[index] === "object") {
                      items[index].isPrimary = true;
                    }
                  }
                  j.customPhones = items;
                  j.preferredPhone = { origin, index };
                  return;
                }
                if (kind === "email") {
                  const items = Array.isArray(j.customEmails)
                    ? j.customEmails
                    : [];
                  for (let i = 0; i < items.length; i++) {
                    const it = items[i];
                    if (it && typeof it === "object") it.isDefault = false;
                  }
                  if (origin === "custom" && Number.isFinite(index)) {
                    if (items[index] && typeof items[index] === "object") {
                      items[index].isDefault = true;
                    }
                  }
                  j.customEmails = items;
                  j.preferredEmail = { origin, index };
                }
              };

              const render = () => {
                list.innerHTML = "";

                const makeColGroup = () => {
                  const colgroup = document.createElement("colgroup");
                  const c1 = document.createElement("col");
                  const c2 = document.createElement("col");
                  const c3 = document.createElement("col");
                  const c4 = document.createElement("col");
                  if (kind === "phone") {
                    c1.style.width = "16ch";
                    c2.style.width = "16ch";
                    c3.style.width = "16ch";
                    c4.style.width = "12ch";
                  } else if (kind === "email") {
                    c1.style.width = "18ch";
                    c2.style.width = "16ch";
                    c3.style.width = "16ch";
                    c4.style.width = "12ch";
                  }
                  colgroup.appendChild(c1);
                  colgroup.appendChild(c2);
                  colgroup.appendChild(c3);
                  colgroup.appendChild(c4);
                  return colgroup;
                };

                if (kind === "phone" || kind === "email") {
                  list.appendChild(makeColGroup());
                }

                const makeTestataLink = () => {
                  if (!testataName) return null;
                  const link = document.createElement("a");
                  link.href = "#";
                  link.className = "c-link c-link--nav testata-link";
                  link.textContent = testataName;
                  link.setAttribute("data-testata", testataName);
                  return link;
                };

                if (kind === "phone") {
                  const custom = (
                    Array.isArray(j.customPhones) ? j.customPhones : []
                  )
                    .map((x) => ({
                      number: normalizeText(
                        x?.number ?? x?.tel ?? x?.value ?? x,
                      ),
                      type: normalizeText(x?.type ?? x?.kind ?? ""),
                      isPrimary: Boolean(x?.isPrimary),
                    }))
                    .filter((x) => x.number.length > 0);
                  j.customPhones = custom;

                  const tbody = document.createElement("tbody");
                  list.appendChild(tbody);

                  for (let i = 0; i < custom.length; i++) {
                    const it = custom[i];
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-contact-kind", "phone");
                    tr.setAttribute("data-contact-index", String(i));

                    const tdNumber = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = it.number;
                      tdNumber.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = it.type || "cellulare";
                      tdType.appendChild(s);
                    }
                    const tdTestata = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.textContent = "";
                      tdTestata.appendChild(s);
                    }

                    const preferred = document.createElement("a");
                    preferred.href = "#";
                    preferred.className = `journalist-contact-preferred c-link c-link--action${
                      j?.preferredPhone?.origin === "custom" &&
                      j?.preferredPhone?.index === i
                        ? " is-active"
                        : ""
                    }`;
                    preferred.textContent = "predefinito";
                    preferred.setAttribute(
                      "data-contact-action",
                      "set-primary",
                    );
                    preferred.setAttribute("data-contact-kind", "phone");
                    preferred.setAttribute("data-contact-origin", "custom");

                    const edit = document.createElement("a");
                    edit.href = "#";
                    edit.className = "c-link c-link--action";
                    edit.textContent = "modifica";
                    edit.setAttribute("data-contact-action", "edit");
                    edit.setAttribute("data-contact-kind", "phone");

                    const remove = document.createElement("a");
                    remove.href = "#";
                    remove.className = "c-link c-link--action";
                    remove.textContent = "rimuovi";
                    remove.setAttribute("data-contact-action", "remove");
                    remove.setAttribute("data-contact-kind", "phone");

                    const tdPreferred = document.createElement("td");
                    tdPreferred.appendChild(preferred);

                    const actions = document.createElement("span");
                    actions.className = "journalist-contact-row-actions";
                    actions.appendChild(edit);
                    actions.appendChild(remove);
                    tdPreferred.appendChild(actions);

                    tr.appendChild(tdNumber);
                    tr.appendChild(tdType);
                    tr.appendChild(tdTestata);
                    tr.appendChild(tdPreferred);
                    tbody.appendChild(tr);
                  }

                  const programItemsRaw = Array.isArray(j?.programPhones)
                    ? j.programPhones
                    : [];
                  const programItems = programItemsRaw
                    .map((x) => ({
                      number: normalizeText(
                        x?.number ?? x?.tel ?? x?.value ?? x,
                      ),
                      type: normalizeText(x?.type ?? x?.kind ?? ""),
                    }))
                    .filter((x) => x.number.length > 0);
                  if (programItems.length === 0) {
                    const v = normalizeText(j?.telefono);
                    if (v) programItems.push({ number: v, type: "cellulare" });
                  }
                  for (let pi = 0; pi < programItems.length; pi++) {
                    const it = programItems[pi];
                    const tr = document.createElement("tr");

                    const tdNumber = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = it.number;
                      tdNumber.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = it.type || "cellulare";
                      tdType.appendChild(s);
                    }
                    const tdTestata = document.createElement("td");

                    const preferred = document.createElement("a");
                    preferred.href = "#";
                    preferred.className = `journalist-contact-preferred c-link c-link--action${
                      j?.preferredPhone?.origin === "program" &&
                      j?.preferredPhone?.index === pi
                        ? " is-active"
                        : ""
                    }`;
                    preferred.textContent = "predefinito";
                    preferred.setAttribute(
                      "data-contact-action",
                      "set-primary",
                    );
                    preferred.setAttribute("data-contact-kind", "phone");
                    preferred.setAttribute("data-contact-origin", "program");
                    preferred.setAttribute(
                      "data-contact-program-index",
                      String(pi),
                    );
                    const link = makeTestataLink();
                    if (link) {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.appendChild(link);
                      tdTestata.appendChild(s);
                    } else {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.textContent = "";
                      tdTestata.appendChild(s);
                    }
                    const tdPreferred = document.createElement("td");
                    tdPreferred.appendChild(preferred);

                    tr.appendChild(tdNumber);
                    tr.appendChild(tdType);
                    tr.appendChild(tdTestata);
                    tr.appendChild(tdPreferred);
                    tbody.appendChild(tr);
                  }

                  if (programItems.length === 0 && custom.length === 0) {
                    const tr = document.createElement("tr");
                    const td = document.createElement("td");
                    td.colSpan = 4;
                    td.innerHTML = '<span class="muted">n/d</span>';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                  }
                  return;
                }

                if (kind === "email") {
                  const custom = (
                    Array.isArray(j.customEmails) ? j.customEmails : []
                  )
                    .map((x) => ({
                      email: normalizeText(x?.email ?? x?.value ?? x),
                      type: normalizeText(x?.type ?? ""),
                      isDefault: Boolean(x?.isDefault),
                    }))
                    .filter((x) => x.email.length > 0);
                  j.customEmails = custom;

                  const tbody = document.createElement("tbody");
                  list.appendChild(tbody);

                  for (let i = 0; i < custom.length; i++) {
                    const it = custom[i];
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-contact-kind", "email");
                    tr.setAttribute("data-contact-index", String(i));

                    const tdEmail = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = it.email;
                      tdEmail.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = it.type || "mail diretta";
                      tdType.appendChild(s);
                    }
                    const tdTestata = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.textContent = "";
                      tdTestata.appendChild(s);
                    }

                    const preferred = document.createElement("a");
                    preferred.href = "#";
                    preferred.className = `journalist-contact-preferred c-link c-link--action${
                      j?.preferredEmail?.origin === "custom" &&
                      j?.preferredEmail?.index === i
                        ? " is-active"
                        : ""
                    }`;
                    preferred.textContent = "predefinito";
                    preferred.setAttribute(
                      "data-contact-action",
                      "set-default",
                    );
                    preferred.setAttribute("data-contact-kind", "email");
                    preferred.setAttribute("data-contact-origin", "custom");

                    const edit = document.createElement("a");
                    edit.href = "#";
                    edit.className = "c-link c-link--action";
                    edit.textContent = "modifica";
                    edit.setAttribute("data-contact-action", "edit");
                    edit.setAttribute("data-contact-kind", "email");

                    const remove = document.createElement("a");
                    remove.href = "#";
                    remove.className = "c-link c-link--action";
                    remove.textContent = "rimuovi";
                    remove.setAttribute("data-contact-action", "remove");
                    remove.setAttribute("data-contact-kind", "email");

                    const tdPreferred = document.createElement("td");
                    tdPreferred.appendChild(preferred);

                    const actions = document.createElement("span");
                    actions.className = "journalist-contact-row-actions";
                    actions.appendChild(edit);
                    actions.appendChild(remove);
                    tdPreferred.appendChild(actions);

                    tr.appendChild(tdEmail);
                    tr.appendChild(tdType);
                    tr.appendChild(tdTestata);
                    tr.appendChild(tdPreferred);
                    tbody.appendChild(tr);
                  }

                  const programItemsRaw = Array.isArray(j?.programEmails)
                    ? j.programEmails
                    : [];
                  const programItems = programItemsRaw
                    .map((x) => ({
                      email: normalizeText(x?.email ?? x?.value ?? x),
                      type: normalizeText(x?.type ?? ""),
                    }))
                    .filter((x) => x.email.length > 0);
                  if (programItems.length === 0) {
                    const v = normalizeText(j?.email);
                    if (v)
                      programItems.push({ email: v, type: "mail diretta" });
                  }
                  for (let pi = 0; pi < programItems.length; pi++) {
                    const it = programItems[pi];
                    const tr = document.createElement("tr");

                    const tdEmail = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = it.email;
                      tdEmail.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = it.type || "mail diretta";
                      tdType.appendChild(s);
                    }
                    const tdTestata = document.createElement("td");

                    const preferred = document.createElement("a");
                    preferred.href = "#";
                    preferred.className = `journalist-contact-preferred c-link c-link--action${
                      j?.preferredEmail?.origin === "program" &&
                      j?.preferredEmail?.index === pi
                        ? " is-active"
                        : ""
                    }`;
                    preferred.textContent = "predefinito";
                    preferred.setAttribute(
                      "data-contact-action",
                      "set-default",
                    );
                    preferred.setAttribute("data-contact-kind", "email");
                    preferred.setAttribute("data-contact-origin", "program");
                    preferred.setAttribute(
                      "data-contact-program-index",
                      String(pi),
                    );
                    const link = makeTestataLink();
                    if (link) {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.appendChild(link);
                      tdTestata.appendChild(s);
                    } else {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-text";
                      s.textContent = "";
                      tdTestata.appendChild(s);
                    }
                    const tdPreferred = document.createElement("td");
                    tdPreferred.appendChild(preferred);

                    tr.appendChild(tdEmail);
                    tr.appendChild(tdType);
                    tr.appendChild(tdTestata);
                    tr.appendChild(tdPreferred);
                    tbody.appendChild(tr);
                  }

                  if (programItems.length === 0 && custom.length === 0) {
                    const tr = document.createElement("tr");
                    const td = document.createElement("td");
                    td.colSpan = 4;
                    td.innerHTML = '<span class="muted">n/d</span>';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                  }
                  return;
                }

                if (kind === "social") {
                  const custom = (
                    Array.isArray(j.customSocials) ? j.customSocials : []
                  )
                    .map((x) => ({
                      url: normalizeText(x?.url ?? x?.value ?? x),
                      type: normalizeText(x?.type ?? ""),
                    }))
                    .filter((x) => x.url.length > 0);
                  j.customSocials = custom;

                  list.innerHTML = "";
                  const tbody = document.createElement("tbody");
                  list.appendChild(tbody);

                  for (let i = 0; i < custom.length; i++) {
                    const it = custom[i];
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-contact-kind", "social");
                    tr.setAttribute("data-contact-index", String(i));

                    const tdUrl = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = it.url;
                      tdUrl.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = it.type || "x";
                      tdType.appendChild(s);
                    }

                    const edit = document.createElement("a");
                    edit.href = "#";
                    edit.className = "c-link c-link--action";
                    edit.textContent = "modifica";
                    edit.setAttribute("data-contact-action", "edit");
                    edit.setAttribute("data-contact-kind", "social");

                    const remove = document.createElement("a");
                    remove.href = "#";
                    remove.className = "c-link c-link--action";
                    remove.textContent = "rimuovi";
                    remove.setAttribute("data-contact-action", "remove");
                    remove.setAttribute("data-contact-kind", "social");

                    const actions = document.createElement("span");
                    actions.className = "journalist-contact-row-actions";
                    actions.appendChild(edit);
                    actions.appendChild(remove);
                    tdUrl.appendChild(actions);

                    tr.appendChild(tdUrl);
                    tr.appendChild(tdType);
                    tbody.appendChild(tr);
                  }

                  const program = normalizeText(j?.social);
                  if (program) {
                    const tr = document.createElement("tr");
                    const tdUrl = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-value";
                      s.textContent = program;
                      tdUrl.appendChild(s);
                    }
                    const tdType = document.createElement("td");
                    {
                      const s = document.createElement("span");
                      s.className = "journalist-contact-cell t-label";
                      s.textContent = "x";
                      tdType.appendChild(s);
                    }
                    tr.appendChild(tdUrl);
                    tr.appendChild(tdType);
                    tbody.appendChild(tr);
                  }

                  if (!program && custom.length === 0) {
                    const tr = document.createElement("tr");
                    const td = document.createElement("td");
                    td.colSpan = 2;
                    td.innerHTML = '<span class="muted">n/d</span>';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                  }
                }
              };

              const showEditor = (mode, index, value, type) => {
                editor.hidden = false;
                editor.setAttribute("data-contact-mode", mode);
                if (typeof index === "number") {
                  editor.setAttribute("data-contact-edit-index", String(index));
                } else {
                  editor.removeAttribute("data-contact-edit-index");
                }
                if (input) input.value = String(value ?? "");
                if (select) select.value = String(type ?? select.value ?? "");
                input?.focus?.();
              };

              const hideEditor = () => {
                editor.hidden = true;
                editor.removeAttribute("data-contact-mode");
                editor.removeAttribute("data-contact-edit-index");
                if (input) input.value = "";
              };

              if (action === "add") {
                showEditor(
                  "add",
                  null,
                  "",
                  kind === "social" ? "x" : "cellulare",
                );
                return;
              }

              if (action === "set-primary" || action === "set-default") {
                const origin = String(
                  contactActionEl.getAttribute("data-contact-origin") ||
                    "custom",
                )
                  .trim()
                  .toLowerCase();
                const programIndex = Number(
                  contactActionEl.getAttribute("data-contact-program-index"),
                );
                const itemEl = contactActionEl.closest("[data-contact-index]");
                const idxRaw = itemEl?.getAttribute?.("data-contact-index");
                const idx = idxRaw != null ? Number(idxRaw) : NaN;
                if (origin === "program") {
                  setPreferred("program", programIndex);
                } else {
                  setPreferred("custom", idx);
                }
                updateJournalistHeaderContacts();
                render();
                scheduleRender();
                return;
              }

              const itemEl = contactActionEl.closest("[data-contact-index]");
              const idxRaw = itemEl?.getAttribute?.("data-contact-index");
              const idx = idxRaw != null ? Number(idxRaw) : NaN;

              if (action === "edit") {
                if (!Number.isFinite(idx)) return;
                if (kind === "phone") {
                  const items = Array.isArray(j.customPhones)
                    ? j.customPhones
                    : [];
                  showEditor(
                    "edit",
                    idx,
                    items[idx]?.number ??
                      items[idx]?.tel ??
                      items[idx]?.value ??
                      "",
                    items[idx]?.type ?? items[idx]?.kind ?? "cellulare",
                  );
                  return;
                }
                if (kind === "email") {
                  const items = Array.isArray(j.customEmails)
                    ? j.customEmails
                    : [];
                  showEditor(
                    "edit",
                    idx,
                    items[idx]?.email ?? items[idx]?.value ?? "",
                    null,
                  );
                  return;
                }
                if (kind === "social") {
                  const items = Array.isArray(j.customSocials)
                    ? j.customSocials
                    : [];
                  showEditor(
                    "edit",
                    idx,
                    items[idx]?.url ?? items[idx]?.value ?? "",
                    items[idx]?.type ?? "x",
                  );
                  return;
                }
              }

              if (action === "remove") {
                if (!Number.isFinite(idx)) return;
                if (kind === "phone") {
                  const items = Array.isArray(j.customPhones)
                    ? j.customPhones
                    : [];
                  if (
                    j?.preferredPhone?.origin === "custom" &&
                    Number.isFinite(j?.preferredPhone?.index)
                  ) {
                    if (j.preferredPhone.index === idx) {
                      j.preferredPhone = { origin: "program", index: 0 };
                    } else if (j.preferredPhone.index > idx) {
                      j.preferredPhone.index -= 1;
                    }
                  }
                  items.splice(idx, 1);
                  j.customPhones = items;
                  hideEditor();
                  render();
                  scheduleRender();
                  return;
                }
                if (kind === "email") {
                  const items = Array.isArray(j.customEmails)
                    ? j.customEmails
                    : [];
                  if (
                    j?.preferredEmail?.origin === "custom" &&
                    Number.isFinite(j?.preferredEmail?.index)
                  ) {
                    if (j.preferredEmail.index === idx) {
                      j.preferredEmail = { origin: "program", index: 0 };
                    } else if (j.preferredEmail.index > idx) {
                      j.preferredEmail.index -= 1;
                    }
                  }
                  items.splice(idx, 1);
                  j.customEmails = items;
                  hideEditor();
                  render();
                  scheduleRender();
                  return;
                }
                if (kind === "social") {
                  const items = Array.isArray(j.customSocials)
                    ? j.customSocials
                    : [];
                  items.splice(idx, 1);
                  j.customSocials = items;
                  hideEditor();
                  render();
                  return;
                }
              }

              if (action === "cancel") {
                hideEditor();
                return;
              }

              if (action === "ok") {
                const value = String(input?.value ?? "").trim();
                if (!value) {
                  hideEditor();
                  return;
                }

                const mode = String(
                  editor.getAttribute("data-contact-mode") || "",
                )
                  .trim()
                  .toLowerCase();
                const editIndex = Number(
                  editor.getAttribute("data-contact-edit-index"),
                );

                if (kind === "phone") {
                  const items = Array.isArray(j.customPhones)
                    ? [...j.customPhones]
                    : [];
                  const obj = {
                    number: value,
                    type: String(select?.value ?? "cellulare").trim(),
                    isPrimary:
                      mode === "edit" &&
                      Number.isFinite(editIndex) &&
                      items[editIndex] &&
                      typeof items[editIndex] === "object"
                        ? Boolean(items[editIndex]?.isPrimary)
                        : false,
                  };
                  if (mode === "edit" && Number.isFinite(editIndex)) {
                    items[editIndex] = obj;
                  } else {
                    items.unshift(obj);
                  }
                  j.customPhones = items;
                  hideEditor();
                  render();
                  scheduleRender();
                  return;
                }

                if (kind === "email") {
                  const items = Array.isArray(j.customEmails)
                    ? [...j.customEmails]
                    : [];
                  const obj = {
                    email: value,
                    isDefault:
                      mode === "edit" &&
                      Number.isFinite(editIndex) &&
                      items[editIndex] &&
                      typeof items[editIndex] === "object"
                        ? Boolean(items[editIndex]?.isDefault)
                        : false,
                  };
                  if (mode === "edit" && Number.isFinite(editIndex)) {
                    items[editIndex] = obj;
                  } else {
                    items.unshift(obj);
                  }
                  j.customEmails = items;
                  hideEditor();
                  render();
                  scheduleRender();
                  return;
                }

                if (kind === "social") {
                  const items = Array.isArray(j.customSocials)
                    ? [...j.customSocials]
                    : [];
                  const obj = {
                    url: value,
                    type: String(select?.value ?? "x").trim(),
                  };
                  if (mode === "edit" && Number.isFinite(editIndex)) {
                    items[editIndex] = obj;
                  } else {
                    items.unshift(obj);
                  }
                  j.customSocials = items;
                  hideEditor();
                  render();
                  return;
                }
              }
            }
          }

          const journalistLink = e.target?.closest?.(".journalist-link");
          if (journalistLink) {
            e.preventDefault();
            e.stopPropagation();
            const name =
              journalistLink.getAttribute("data-journalist") ||
              journalistLink.textContent;
            openJournalistPanel(name);
            return;
          }

          const testataLink = e.target?.closest?.(".testata-link");
          if (!testataLink) return;
          e.preventDefault();
          e.stopPropagation();
          const key = testataLink.getAttribute("data-testata-key");
          const testata =
            testataLink.getAttribute("data-testata") || testataLink.textContent;
          openTestataPanel(key || testata);
        });
      }

      document.addEventListener(
        "keydown",
        (e) => {
          const testataOpen = testataPanel?.classList?.contains("show");

          if (testataOpen && e.key === "Escape") {
            const cancel = testataPanelBody?.querySelector(
              '[data-note-editor]:not([hidden]) [data-note-action="cancel"]',
            );
            if (cancel) {
              e.preventDefault();
              e.stopPropagation();
              cancel.click();
              return;
            }

            const topicCancel = testataPanelBody?.querySelector(
              '[data-topic-editor]:not([hidden]) [data-topic-action="cancel"]',
            );
            if (topicCancel) {
              e.preventDefault();
              e.stopPropagation();
              topicCancel.click();
              return;
            }

            const contactCancel = testataPanelBody?.querySelector(
              '[data-contact-editor]:not([hidden]) [data-contact-action="cancel"]',
            );
            if (contactCancel) {
              e.preventDefault();
              e.stopPropagation();
              contactCancel.click();
              return;
            }
          }

          if (testataOpen && e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
            const active = document.activeElement;
            if (active?.matches?.("[data-note-textarea]")) {
              const ok = testataPanelBody?.querySelector(
                '[data-note-editor]:not([hidden]) [data-note-action="ok"]',
              );
              if (ok) {
                e.preventDefault();
                e.stopPropagation();
                ok.click();
                return;
              }
            }

            if (active?.matches?.("[data-topic-input]")) {
              const ok = testataPanelBody?.querySelector(
                '[data-topic-editor]:not([hidden]) [data-topic-action="ok"]',
              );
              if (ok) {
                e.preventDefault();
                e.stopPropagation();
                ok.click();
                return;
              }
            }

            if (
              active?.matches?.("[data-contact-input]") ||
              active?.matches?.("[data-contact-select]")
            ) {
              const editor = active?.closest?.("[data-contact-editor]");
              const ok = editor?.querySelector?.('[data-contact-action="ok"]');
              if (ok) {
                e.preventDefault();
                e.stopPropagation();
                ok.click();
                return;
              }
            }
          }

          if (e.key !== "Escape") return;
          if (addToShipmentModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeAddToShipmentModal();
            return;
          }
          if (addToNewShipmentModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeAddToNewShipmentModal();
            return;
          }
          if (addToListModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeAddToListModal();
            return;
          }
          if (shipmentPressEmailModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeShipmentPressEmailModal();
            return;
          }
          if (newPressPanel?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeNewPressPanel();
            return;
          }
          if (saveListModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeSaveListModal();
            return;
          }
          if (notesModal?.classList?.contains("show")) {
            e.preventDefault();
            e.stopPropagation();
            closeNotesModal();
            return;
          }

          if (!testataPanel?.classList?.contains("show")) return;
          e.preventDefault();
          e.stopPropagation();
          closeTestataPanel();
        },
        true,
      );

      let _renderRaf = null;
      function scheduleRender() {
        if (_renderRaf) return;
        _renderRaf = requestAnimationFrame(() => {
          _renderRaf = null;
          renderCards();
        });
      }

      function getSidebarMode() {
        const el = document.querySelector('input[name="sidebarMode"]:checked');
        const v = String(el?.value || "giornalisti")
          .trim()
          .toLowerCase();
        return v === "testate" ? "testate" : "giornalisti";
      }

      function getMainMode() {
        const el = document.querySelector('input[name="mainMode"]:checked');
        const v = String(el?.value || "giornalisti")
          .trim()
          .toLowerCase();
        return v === "testate" ? "testate" : "giornalisti";
      }

      function getTextFilterLabel() {
        return "Cerca";
      }

      function getTextFilterHelpText() {
        const mode = getSidebarMode();
        return mode === "testate"
          ? "in nome, note (testate)"
          : "in nome, email, note (giornalisti)";
      }

      function setFilterDropdownEnabled(inst, enabled) {
        if (!inst) return;
        if (inst?.isOpen && !enabled) {
          inst.close();
        }
        if (inst?.input) {
          inst.input.disabled = !enabled;
        }
        if (inst?.clear) {
          inst.clear.classList.toggle("is-disabled", !enabled);
          inst.clear.setAttribute("aria-disabled", enabled ? "false" : "true");
        }
        const container = inst?.container;
        if (container) {
          container.classList.toggle("is-disabled", !enabled);
          container.setAttribute("aria-disabled", enabled ? "false" : "true");
        }
      }

      function applySidebarModeUI() {
        const effectiveMode = getSidebarMode();
        const enableJournalistFilters = effectiveMode === "giornalisti";

        {
          const label = document.querySelector(
            'label.field-label[for="textFilterInput"]',
          );
          if (label) {
            label.textContent = getTextFilterLabel();
          }

          const help = document.getElementById("textFilterHelpText");
          if (help) {
            help.textContent = getTextFilterHelpText();
          }
        }

        const journalistFiltersSlot = document.getElementById(
          "journalistFiltersSlot",
        );
        const journalistFiltersContent = document.getElementById(
          "journalistFiltersContent",
        );
        const journalistFiltersPlaceholder = document.getElementById(
          "journalistFiltersPlaceholder",
        );

        if (journalistFiltersSlot && journalistFiltersContent) {
          if (!journalistFiltersSlot.dataset.baseHeight) {
            const h = journalistFiltersContent.offsetHeight || 0;
            journalistFiltersSlot.dataset.baseHeight = String(h);
            if (h) {
              journalistFiltersSlot.style.minHeight = `${h}px`;
            }
          }
        }

        if (journalistFiltersContent) {
          journalistFiltersContent.style.display = enableJournalistFilters
            ? ""
            : "none";
        }
        if (journalistFiltersPlaceholder) {
          journalistFiltersPlaceholder.style.display = enableJournalistFilters
            ? "none"
            : "flex";
        }

        setFilterDropdownEnabled(dropdown, enableJournalistFilters);
        setFilterDropdownEnabled(roleDropdown, enableJournalistFilters);

        const testataFiltersWrap = document.getElementById(
          "testataFiltersSection",
        );
        if (testataFiltersWrap) {
          testataFiltersWrap.classList.remove("is-disabled");
          testataFiltersWrap.setAttribute("aria-disabled", "false");
        }
        setFilterDropdownEnabled(testataArgomentoDropdown, true);
        setFilterDropdownEnabled(testataTipoMediaDropdown, true);
        setFilterDropdownEnabled(testataFrequenzaDropdown, true);
        setFilterDropdownEnabled(testataDiffusioneDropdown, true);

        if (textFilterInput) {
          textFilterInput.disabled = false;
          const wrap = textFilterInput.closest?.(".dropdown-container");
          if (wrap) {
            wrap.classList.remove("is-disabled");
            wrap.setAttribute("aria-disabled", "false");
          }
        }
      }

      function setSidebarMode(mode) {
        const m = String(mode || "")
          .trim()
          .toLowerCase();
        const next = m === "testate" ? "testate" : "giornalisti";
        const inputs = document.querySelectorAll('input[name="sidebarMode"]');
        inputs.forEach((el) => {
          const v = String(el?.value || "")
            .trim()
            .toLowerCase();
          el.checked = v === next;
        });
      }

      function setMainMode(mode) {
        const m = String(mode || "")
          .trim()
          .toLowerCase();
        const next = m === "testate" ? "testate" : "giornalisti";
        const inputs = document.querySelectorAll('input[name="mainMode"]');
        inputs.forEach((el) => {
          const v = String(el?.value || "")
            .trim()
            .toLowerCase();
          el.checked = v === next;
        });
      }

      let isBulkFilterReset = false;

      function snapshotFilterState(mode) {
        const m = String(mode || currentMode || "")
          .trim()
          .toLowerCase();
        const isTestateMode = m === "testate";
        return {
          selectedServices: isTestateMode
            ? []
            : Array.from(dropdown.selectedValues || []),
          selectedRoles: isTestateMode
            ? []
            : Array.from(roleDropdown.selectedValues || []),
          selectedTestataArgomenti: Array.from(
            testataArgomentoDropdown.selectedValues || [],
          ),
          selectedTestataTipoMedia: Array.from(
            testataTipoMediaDropdown.selectedValues || [],
          ),
          selectedTestataFrequenze: Array.from(
            testataFrequenzaDropdown.selectedValues || [],
          ),
          selectedTestataDiffusioni: Array.from(
            testataDiffusioneDropdown.selectedValues || [],
          ),
          committedTextTerms: [...committedTextTerms],
          currentTextQuery: (textFilterInput?.value || "").trim(),
        };
      }

      function restoreFilterState(state) {
        const s = state || {};
        isBulkFilterReset = true;

        dropdown.resetSelection();
        roleDropdown.resetSelection();
        testataArgomentoDropdown.resetSelection();
        testataTipoMediaDropdown.resetSelection();
        testataFrequenzaDropdown.resetSelection();
        testataDiffusioneDropdown.resetSelection();

        const safeToggle = (inst, value) => {
          if (!inst) return;
          const v = String(value ?? "").trim();
          if (!v) return;
          if (
            Array.isArray(inst.originalOptions) &&
            inst.originalOptions.length
          ) {
            if (!inst.originalOptions.includes(v)) return;
          }
          inst.toggleOption(v);
        };

        for (const v of s.selectedServices || []) safeToggle(dropdown, v);
        for (const v of s.selectedRoles || []) safeToggle(roleDropdown, v);
        for (const v of s.selectedTestataArgomenti || []) {
          safeToggle(testataArgomentoDropdown, v);
        }
        for (const v of s.selectedTestataTipoMedia || []) {
          safeToggle(testataTipoMediaDropdown, v);
        }
        for (const v of s.selectedTestataFrequenze || []) {
          safeToggle(testataFrequenzaDropdown, v);
        }
        for (const v of s.selectedTestataDiffusioni || []) {
          safeToggle(testataDiffusioneDropdown, v);
        }

        committedTextTerms.splice(0, committedTextTerms.length);
        for (const term of s.committedTextTerms || []) {
          const t = String(term || "").trim();
          if (t) committedTextTerms.push(t);
        }

        if (textFilterInput) {
          textFilterInput.value = String(s.currentTextQuery || "");
          updateTextFilterClearVisibility();
        }

        isBulkFilterReset = false;
      }

      const filterStateByMode = {
        giornalisti: null,
        testate: null,
      };
      let currentMode = getSidebarMode();

      setMainMode(currentMode);
      setSidebarMode(currentMode);
      applySidebarModeUI();

      function handleModeSwitch(nextMode) {
        const current = currentMode;
        const next =
          String(nextMode || "")
            .trim()
            .toLowerCase() === "testate"
            ? "testate"
            : "giornalisti";
        if (current === next) {
          setMainMode(next);
          setSidebarMode(next);
          applySidebarModeUI();
          scheduleRender();
          return;
        }

        filterStateByMode[current] = snapshotFilterState(current);
        currentMode = next;

        setSidebarMode(next);
        setMainMode(next);

        restoreFilterState(filterStateByMode[next]);
        applySidebarModeUI();
        scheduleRender();
      }

      function getFilterState() {
        const selectedServices = Array.from(dropdown.selectedValues || []);
        const selectedRoles = Array.from(roleDropdown.selectedValues || []);
        const selectedTestataArgomenti = Array.from(
          testataArgomentoDropdown.selectedValues || [],
        );
        const selectedTestataTipoMedia = Array.from(
          testataTipoMediaDropdown.selectedValues || [],
        );
        const selectedTestataFrequenze = Array.from(
          testataFrequenzaDropdown.selectedValues || [],
        );
        const selectedTestataDiffusioni = Array.from(
          testataDiffusioneDropdown.selectedValues || [],
        );
        const activeTextTerms = getActiveTextTerms();
        const currentTextQuery = (textFilterInput?.value || "").trim();

        const servicesActive = selectedServices.length > 0;
        const rolesActive = selectedRoles.length > 0;
        const testataArgomentoActive = selectedTestataArgomenti.length > 0;
        const testataTipoMediaActive = selectedTestataTipoMedia.length > 0;
        const testataFrequenzaActive = selectedTestataFrequenze.length > 0;
        const testataDiffusioneActive = selectedTestataDiffusioni.length > 0;
        const textActive = activeTextTerms.length > 0;
        const active =
          servicesActive ||
          rolesActive ||
          testataArgomentoActive ||
          testataTipoMediaActive ||
          testataFrequenzaActive ||
          testataDiffusioneActive ||
          textActive;

        return {
          selectedServices,
          selectedRoles,
          selectedTestataArgomenti,
          selectedTestataTipoMedia,
          selectedTestataFrequenze,
          selectedTestataDiffusioni,
          activeTextTerms,
          currentTextQuery,
          servicesActive,
          rolesActive,
          testataArgomentoActive,
          testataTipoMediaActive,
          testataFrequenzaActive,
          testataDiffusioneActive,
          textActive,
          active,
        };
      }

      const CARD_PAGE_SIZE = 50;
      let visibleJournalistLimit = CARD_PAGE_SIZE;
      let visibleTestateLimit = CARD_PAGE_SIZE;
      let lastCardsQueryKey = "";
      let lastLoaderYieldKey = "";
      let journalistByIdCache = null;
      let lastRenderedMode = "";
      let lastRenderedJournalistCount = 0;
      let lastRenderedTestateCount = 0;
      let renderCardsJobId = 0;

      function renderCards() {
        const grid = document.getElementById("cardsGrid");
        const cardsLoader = document.getElementById("cardsLoader");
        const loadMoreWrap = document.getElementById("cardsLoadMoreWrap");
        const loadMoreLink = document.getElementById("cardsLoadMore");
        const mainCountJournalistsEl = document.getElementById(
          "mainCountJournalists",
        );
        const mainCountTestateEl = document.getElementById("mainCountTestate");
        const subtitleEl = document.getElementById("cardsSubtitle");
        const clearFiltersLink = document.getElementById("clearFiltersLink");

        const sortByNameAscLink = document.getElementById("sortByNameAscLink");
        const sortByNameDescLink =
          document.getElementById("sortByNameDescLink");
        const sortByRoleLink = document.getElementById("sortByRoleLink");
        const sortByMediaTypeLink = document.getElementById(
          "sortByMediaTypeLink",
        );
        const sortByFrequencyLink = document.getElementById(
          "sortByFrequencyLink",
        );
        const sortSepAfterName = document.getElementById("sortSepAfterName");
        const sortSepAfterRole = document.getElementById("sortSepAfterRole");
        const sortSepAfterMediaType = document.getElementById(
          "sortSepAfterMediaType",
        );

        if (!journalistByIdCache || journalistByIdCache.size === 0) {
          journalistByIdCache = new Map(
            (journalists || []).map((j) => [getJournalistId(j), j]),
          );
        } else if (journalistByIdCache.size !== (journalists || []).length) {
          journalistByIdCache = new Map(
            (journalists || []).map((j) => [getJournalistId(j), j]),
          );
        }
        const journalistById = journalistByIdCache;

        const {
          selectedServices,
          selectedRoles,
          selectedTestataArgomenti,
          selectedTestataTipoMedia,
          selectedTestataFrequenze,
          selectedTestataDiffusioni,
          activeTextTerms,
          currentTextQuery,
          servicesActive,
          rolesActive,
          testataArgomentoActive,
          testataTipoMediaActive,
          testataFrequenzaActive,
          testataDiffusioneActive,
          textActive,
          active,
        } = getFilterState();

        const isMailingListView = appState.view === "mailing-list";
        const isSpedisciListaView = appState.view === "spedisci-lista";
        const cardsHost =
          isSpedisciListaView && shipmentCardsColumn
            ? shipmentCardsColumn
            : grid;
        const shipmentCardsFilterTerm = isSpedisciListaView
          ? String(shipmentCardsFilterInput?.value || "")
              .trim()
              .toLowerCase()
          : "";

        renderShipmentPressOptions();
        updateShipmentPressModeUI();

        const activeList =
          isMailingListView || isSpedisciListaView
            ? getMailingListById(appState.activeMailingListId)
            : null;
        const spedizioneSourceList = isSpedisciListaView
          ? getSpedizioneSourceList()
          : null;
        if (
          isSpedisciListaView &&
          !wasSpedisciListaView &&
          shipmentSelectedRecipientJournalistIds.size === 0
        ) {
          const seedId = String(
            appState.activeSpedizioneSourceListId || "",
          ).trim();
          applyShipmentSelectedRecipientListIds(seedId ? [seedId] : [], {
            save: false,
            syncDropdown: true,
          });
        }

        const selectedShipmentLists = isSpedisciListaView
          ? getShipmentActiveRecipientLists()
          : [];
        const selectedShipmentJournalistIds = new Set();
        selectedShipmentLists.forEach((list) => {
          (list?.journalistIds || []).forEach((jid) => {
            const safeId = String(jid || "").trim();
            if (safeId) selectedShipmentJournalistIds.add(safeId);
          });
        });
        Array.from(shipmentSelectedRecipientJournalistIds).forEach((jid) => {
          const safeId = String(jid || "").trim();
          if (safeId) selectedShipmentJournalistIds.add(safeId);
        });

        const listForView = isSpedisciListaView
          ? { journalistIds: Array.from(selectedShipmentJournalistIds) }
          : activeList;

        applySidebarModeUI();

        const sidebarMode = getSidebarMode();
        const mainMode = getMainMode();
        const isSidebarTestateMode =
          !isSpedisciListaView && sidebarMode === "testate";
        const isMainTestateMode =
          !isSpedisciListaView && mainMode === "testate";

        if (bulkSelectControls) {
          bulkSelectControls.style.display =
            isMainTestateMode && !isSpedisciListaView ? "none" : "";
        }

        let sortMode = getSortMode();
        const isTestateSortManuallyOverridden =
          !!appState.testateSortManuallyOverridden;
        const isJournalistsSortManuallyOverridden =
          !!appState.journalistsSortManuallyOverridden;

        if (!textActive) {
          let didMutate = false;
          if (sortMode === "relevance") {
            appState.sortMode = "name-asc";
            sortMode = "name-asc";
            didMutate = true;
          }
          if (isMainTestateMode) {
            if (isTestateSortManuallyOverridden) {
              appState.testateSortManuallyOverridden = false;
              didMutate = true;
            }
          } else {
            if (isJournalistsSortManuallyOverridden) {
              appState.journalistsSortManuallyOverridden = false;
              didMutate = true;
            }
          }
          if (didMutate) saveAppState(appState);
        }

        let effectiveSortMode = isMainTestateMode
          ? textActive && !isTestateSortManuallyOverridden
            ? "relevance"
            : sortMode === "role"
              ? "frequency"
              : sortMode
          : textActive && !isJournalistsSortManuallyOverridden
            ? "relevance"
            : sortMode;

        const isJournalistRelevanceAllowed = !isSidebarTestateMode;
        if (!isMainTestateMode && !isJournalistRelevanceAllowed) {
          if (effectiveSortMode === "relevance") {
            effectiveSortMode = "name-asc";
          }
        }

        let cardsQueryKeyChanged = false;
        {
          const safeJoin = (arr) =>
            Array.isArray(arr) ? arr.map((x) => String(x || "")).join(",") : "";
          const mailingListKey = isMailingListView
            ? safeJoin(activeList?.journalistIds)
            : isSpedisciListaView
              ? [
                  safeJoin(Array.from(shipmentSelectedRecipientListIds)),
                  safeJoin(Array.from(shipmentActiveRecipientListIds)),
                  safeJoin(Array.from(shipmentSelectedRecipientJournalistIds)),
                ].join("|")
              : "";
          const qk = [
            isMainTestateMode ? "testate" : "giornalisti",
            String(appState.view || ""),
            String(appState.activeMailingListId || ""),
            mailingListKey,
            String(effectiveSortMode || ""),
            String(currentTextQuery || ""),
            safeJoin(selectedServices),
            safeJoin(selectedRoles),
            safeJoin(selectedTestataArgomenti),
            safeJoin(selectedTestataTipoMedia),
            safeJoin(selectedTestataFrequenze),
            safeJoin(selectedTestataDiffusioni),
            shipmentCardsFilterTerm,
          ].join("||");

          if (qk !== lastCardsQueryKey) {
            cardsQueryKeyChanged = true;
            lastCardsQueryKey = qk;
            if (isMainTestateMode) {
              visibleTestateLimit = CARD_PAGE_SIZE;
            } else {
              visibleJournalistLimit = CARD_PAGE_SIZE;
            }
          }
        }

        const cardsModeKey = isMainTestateMode ? "testate" : "giornalisti";
        const cardsModeChanged = cardsModeKey !== lastRenderedMode;
        const shouldClearGrid = cardsModeChanged || cardsQueryKeyChanged;
        if (shouldClearGrid) {
          lastRenderedMode = cardsModeKey;
          lastRenderedJournalistCount = 0;
          lastRenderedTestateCount = 0;
        }

        const resetCardsGridScaffold = () => {
          if (!grid) return;
          if (isSpedisciListaView && shipmentCardsColumn) {
            const shouldRestoreShipmentFilterFocus =
              !!shipmentCardsFilterInput &&
              document.activeElement === shipmentCardsFilterInput;
            const shipmentFilterSelectionStart =
              shouldRestoreShipmentFilterFocus
                ? shipmentCardsFilterInput.selectionStart
                : null;
            const shipmentFilterSelectionEnd = shouldRestoreShipmentFilterFocus
              ? shipmentCardsFilterInput.selectionEnd
              : null;

            const outerScaffold = [shipmentCardsColumn];
            if (shipmentEmailHeaderColumn) {
              outerScaffold.push(shipmentEmailHeaderColumn);
            }
            grid.replaceChildren(...outerScaffold);

            const shipmentScaffold = [];
            if (shipmentSelectedListsChips) {
              shipmentScaffold.push(shipmentSelectedListsChips);
            }
            if (shipmentCardsFilterInput) {
              shipmentScaffold.push(shipmentCardsFilterInput);
            }
            if (cardsLoader) shipmentScaffold.push(cardsLoader);
            if (loadMoreWrap) shipmentScaffold.push(loadMoreWrap);
            if (shipmentScaffold.length > 0) {
              shipmentCardsColumn.replaceChildren(...shipmentScaffold);
            } else {
              shipmentCardsColumn.innerHTML = "";
            }

            if (shouldRestoreShipmentFilterFocus && shipmentCardsFilterInput) {
              shipmentCardsFilterInput.focus({ preventScroll: true });
              if (
                typeof shipmentFilterSelectionStart === "number" &&
                typeof shipmentFilterSelectionEnd === "number"
              ) {
                shipmentCardsFilterInput.setSelectionRange(
                  shipmentFilterSelectionStart,
                  shipmentFilterSelectionEnd,
                );
              }
            }
            return;
          }

          const scaffold = [];
          if (cardsLoader) scaffold.push(cardsLoader);
          if (loadMoreWrap) scaffold.push(loadMoreWrap);
          if (scaffold.length > 0) {
            grid.replaceChildren(...scaffold);
          } else {
            grid.innerHTML = "";
          }
        };

        if (shouldClearGrid && grid && cardsLoader) {
          const qkNow = String(lastCardsQueryKey || "");
          if (qkNow && lastLoaderYieldKey !== qkNow) {
            lastLoaderYieldKey = qkNow;
            cardsLoader.style.display = "block";
            resetCardsGridScaffold();
            scheduleRender();
            return;
          }
        }

        if (
          isSpedisciListaView &&
          cardsHost &&
          shipmentSelectedListsChips &&
          shipmentSelectedListsChips.parentElement !== cardsHost
        ) {
          cardsHost.appendChild(shipmentSelectedListsChips);
        }
        if (
          isSpedisciListaView &&
          cardsHost &&
          shipmentCardsFilterInput &&
          shipmentCardsFilterInput.parentElement !== cardsHost
        ) {
          cardsHost.appendChild(shipmentCardsFilterInput);
        }
        if (
          cardsHost &&
          cardsLoader &&
          cardsLoader.parentElement !== cardsHost
        ) {
          cardsHost.appendChild(cardsLoader);
        }
        if (
          cardsHost &&
          loadMoreWrap &&
          loadMoreWrap.parentElement !== cardsHost
        ) {
          cardsHost.appendChild(loadMoreWrap);
        }
        if (
          isSpedisciListaView &&
          grid &&
          shipmentCardsColumn &&
          shipmentCardsColumn.parentElement !== grid
        ) {
          grid.appendChild(shipmentCardsColumn);
        }
        if (
          isSpedisciListaView &&
          grid &&
          shipmentEmailHeaderColumn &&
          shipmentEmailHeaderColumn.parentElement !== grid
        ) {
          grid.appendChild(shipmentEmailHeaderColumn);
        }

        const myJobId = ++renderCardsJobId;

        const renderIncremental = ({
          items,
          startIndex,
          endIndex,
          createElement,
          onDone,
        }) => {
          const safeStart = Math.max(0, Number(startIndex || 0));
          const safeEnd = Math.max(safeStart, Number(endIndex || 0));
          if (!cardsHost) return;

          const firstBatchSize = 15;
          const batchSize = 20;

          const appendRange = (from, to) => {
            for (let i = from; i < to; i++) {
              const item = items[i];
              if (!item) continue;
              const el = createElement(item);
              if (loadMoreWrap && loadMoreWrap.parentElement === cardsHost) {
                cardsHost.insertBefore(el, loadMoreWrap);
              } else {
                cardsHost.appendChild(el);
              }
            }
          };

          const runBatch = (from) => {
            if (myJobId !== renderCardsJobId) return;
            const nextTo = Math.min(safeEnd, from + batchSize);
            appendRange(from, nextTo);
            if (nextTo >= safeEnd) {
              if (typeof onDone === "function") onDone();
              return;
            }
            requestAnimationFrame(() => runBatch(nextTo));
          };

          const firstTo = Math.min(safeEnd, safeStart + firstBatchSize);
          appendRange(safeStart, firstTo);
          if (cardsLoader) {
            cardsLoader.style.display = "none";
          }
          if (firstTo >= safeEnd) {
            if (typeof onDone === "function") onDone();
            return;
          }
          requestAnimationFrame(() => runBatch(firstTo));
        };

        const keyLower = (x) =>
          String(x || "")
            .trim()
            .toLowerCase();
        const getFreqSort = (freqLabel) => {
          const k = keyLower(freqLabel);
          if (k === "aperiodico" || k === "plurisettimanale") {
            return { indefinite: true, days: Number.POSITIVE_INFINITY };
          }
          const days =
            k === "quotidiano"
              ? 1
              : k === "trisettimanale"
                ? 7 / 3
                : k === "bisettimanale"
                  ? 7 / 2
                  : k === "settimanale"
                    ? 7
                    : k === "quattordicinale"
                      ? 14
                      : k === "quindicinale"
                        ? 15
                        : k === "mensile"
                          ? 30
                          : k === "bimestrale"
                            ? 60
                            : k === "trimestrale"
                              ? 90
                              : k === "quadrimestrale"
                                ? 120
                                : k === "semestrale"
                                  ? 182
                                  : k === "annuale"
                                    ? 365
                                    : k === "quadriennale"
                                      ? 365 * 4
                                      : Number.POSITIVE_INFINITY;
          return { indefinite: false, days };
        };

        const mediaParentOrder = ["Radio", "TV", "Carta Stampata", "Web"];
        const mediaParentRank = new Map(
          mediaParentOrder.map((p, idx) => [p, idx]),
        );
        const mediaChildRankByParent = new Map();
        for (const p of mediaParentOrder) {
          const list = (TESTATA_MEDIA_BY_PARENT || {})[p] || [];
          const map = new Map();
          list.forEach((c, idx) => map.set(String(c || ""), idx));
          mediaChildRankByParent.set(p, map);
        }
        const getTestataMediaRank = (t) => {
          const p = String(t?.tipoMedia?.parent || "").trim();
          const c = String(t?.tipoMedia?.child || "").trim();
          const pr = mediaParentRank.has(p) ? mediaParentRank.get(p) : 999;
          const cr = mediaChildRankByParent.get(p)?.has(c)
            ? mediaChildRankByParent.get(p).get(c)
            : 999;
          return pr * 1000 + cr;
        };
        if (sortByNameAscLink) {
          sortByNameAscLink.classList.toggle(
            "is-active",
            effectiveSortMode === "name-asc",
          );
          sortByNameAscLink.setAttribute(
            "aria-current",
            effectiveSortMode === "name-asc" ? "true" : "false",
          );
        }
        if (sortByNameDescLink) {
          sortByNameDescLink.classList.toggle(
            "is-active",
            effectiveSortMode === "name-desc",
          );
          sortByNameDescLink.setAttribute(
            "aria-current",
            effectiveSortMode === "name-desc" ? "true" : "false",
          );
        }

        {
          const labelBySortMode = {
            relevance: "rilevanza",
            "name-asc": "nome a-z",
            "name-desc": "nome z-a",
            role: "ruolo",
            "media-type": "tipo di media",
            frequency: "frequenza",
          };

          const label = labelBySortMode[effectiveSortMode] || "nome a-z";
          if (sortByNameSelectValue) sortByNameSelectValue.textContent = label;

          const isAsc = effectiveSortMode === "name-asc";
          const isDesc = effectiveSortMode === "name-desc";
          const isRelevance = effectiveSortMode === "relevance";
          const isRole = effectiveSortMode === "role";
          const isMediaType = effectiveSortMode === "media-type";
          const isFrequency = effectiveSortMode === "frequency";

          const setOptionState = (el, active) => {
            if (!el) return;
            el.setAttribute("aria-selected", active ? "true" : "false");
            const a = el.querySelector(".sort-link");
            if (a) a.classList.toggle("is-active", active);
          };

          setOptionState(sortByNameOptionAsc, isAsc);
          setOptionState(sortByNameOptionDesc, isDesc);
          setOptionState(sortByNameOptionRelevance, isRelevance);
          setOptionState(sortByNameOptionRole, isRole);
          setOptionState(sortByNameOptionMediaType, isMediaType);
          setOptionState(sortByNameOptionFrequency, isFrequency);

          if (sortByNameOptionRelevance) {
            const allow = isMainTestateMode
              ? textActive
              : textActive && isJournalistRelevanceAllowed;
            sortByNameOptionRelevance.style.display = allow ? "" : "none";
          }
          if (sortByNameOptionRole) {
            sortByNameOptionRole.style.display = isMainTestateMode
              ? "none"
              : "";
          }
        }
        if (sortByRoleLink) {
          sortByRoleLink.style.display = isMainTestateMode ? "none" : "";
          sortByRoleLink.classList.toggle(
            "is-active",
            effectiveSortMode === "role",
          );
          sortByRoleLink.setAttribute(
            "aria-current",
            effectiveSortMode === "role" ? "true" : "false",
          );
        }

        if (sortByMediaTypeLink) {
          sortByMediaTypeLink.classList.toggle(
            "is-active",
            effectiveSortMode === "media-type",
          );
          sortByMediaTypeLink.setAttribute(
            "aria-current",
            effectiveSortMode === "media-type" ? "true" : "false",
          );
        }

        if (sortByFrequencyLink) {
          sortByFrequencyLink.classList.toggle(
            "is-active",
            effectiveSortMode === "frequency",
          );
          sortByFrequencyLink.setAttribute(
            "aria-current",
            effectiveSortMode === "frequency" ? "true" : "false",
          );
        }

        if (sortSepAfterRole) {
          sortSepAfterRole.style.display = isMainTestateMode ? "none" : "";
        }

        if (mainTitleEl) {
          if (isSpedisciListaView) {
            mainTitleEl.textContent =
              getShipmentHeaderTitle(spedizioneSourceList);
          } else if (isMailingListView && activeList) {
            mainTitleEl.textContent = activeList.name;
          } else {
            mainTitleEl.textContent = "Banca Dati";
          }
        }

        if (shipmentTitleInput) {
          if (isSpedisciListaView) {
            if (!isShipmentTitleEditing) {
              shipmentTitleInput.value =
                getShipmentNameRaw(spedizioneSourceList);
            }
          } else {
            closeShipmentTitleInlineEditor({ commit: false });
          }
        }

        if (mainTitleIconEl) {
          mainTitleIconEl.style.display =
            (isMailingListView || isSpedisciListaView) && listForView
              ? "inline-block"
              : "none";
        }

        document.body.classList.toggle(
          "is-mailing-list-view",
          !!(isMailingListView && activeList),
        );
        document.body.classList.toggle(
          "is-spedisci-lista-view",
          !!isSpedisciListaView,
        );

        if ((isMailingListView && activeList) || isSpedisciListaView) {
          const currentList = isSpedisciListaView
            ? { journalistIds: Array.from(selectedShipmentJournalistIds) }
            : activeList;
          if (chooseDatabaseLink) chooseDatabaseLink.style.display = "none";
          if (mailingListActions) mailingListActions.style.display = "flex";

          if (mailingListRenameLink) {
            mailingListRenameLink.style.display = isSpedisciListaView
              ? "none"
              : "";
          }

          if (mailingListExportLink) {
            mailingListExportLink.style.display = isSpedisciListaView
              ? "none"
              : "";
          }
          if (mailingListDuplicateLink) {
            mailingListDuplicateLink.style.display = isSpedisciListaView
              ? "none"
              : "";
          }
          if (mailingListDeleteLink) {
            mailingListDeleteLink.style.display = isSpedisciListaView
              ? "none"
              : "";
          }
          if (mailingListSendLink) {
            mailingListSendLink.style.display = isSpedisciListaView
              ? "none"
              : "";
          }

          const count = isSpedisciListaView
            ? selectedShipmentJournalistIds.size
            : Array.isArray(currentList?.journalistIds)
              ? currentList.journalistIds.length
              : 0;
          if (mailingListCountPill) {
            mailingListCountPill.textContent = String(count);
            mailingListCountPill.style.display = isSpedisciListaView
              ? "none"
              : "inline-block";
          }
          if (shipmentRecipientsCountPill) {
            shipmentRecipientsCountPill.textContent = String(count);
            shipmentRecipientsCountPill.style.display = isSpedisciListaView
              ? "inline-block"
              : "none";
          }

          if (mailingListCreatedAtSubtitle) {
            if (isSpedisciListaView) {
              mailingListCreatedAtSubtitle.textContent =
                "creata il 17/02/2026 da @ugo";
              mailingListCreatedAtSubtitle.style.display = "block";
            } else {
              const createdAt = Number(currentList?.createdAt || 0);
              if (Number.isFinite(createdAt) && createdAt > 0) {
                const stamp = new Date(createdAt).toLocaleDateString("it-IT");
                const sharedWith = Array.isArray(currentList?.sharedWith)
                  ? currentList.sharedWith
                  : [];
                const n = sharedWith.filter(Boolean).length;
                const status =
                  n > 0 ? `lista condivisa (${n})` : "lista privata";
                mailingListCreatedAtSubtitle.innerHTML = `creata il ${stamp} da @ugo <span class="sidebar-mode-separator" aria-hidden="true">&nbsp;•&nbsp;</span> ${status} &nbsp;<a href="#" class="c-link c-link--nav" id="mailingListShareLink">condividi</a>`;
                mailingListCreatedAtSubtitle.style.display = "block";
              } else {
                mailingListCreatedAtSubtitle.textContent = "";
                mailingListCreatedAtSubtitle.style.display = "none";
              }
            }
          }
        } else {
          if (chooseDatabaseLink) chooseDatabaseLink.style.display = "";
          if (mailingListActions) mailingListActions.style.display = "none";
          if (mailingListRenameLink) mailingListRenameLink.style.display = "";
          if (mailingListExportLink) mailingListExportLink.style.display = "";
          if (mailingListDuplicateLink)
            mailingListDuplicateLink.style.display = "";
          if (mailingListDeleteLink) mailingListDeleteLink.style.display = "";
          if (mailingListSendLink) mailingListSendLink.style.display = "";
          if (mailingListCountPill) {
            mailingListCountPill.textContent = "";
            mailingListCountPill.style.display = "none";
          }
          if (shipmentRecipientsCountPill) {
            shipmentRecipientsCountPill.textContent = "0";
            shipmentRecipientsCountPill.style.display = "none";
          }
          if (mailingListCreatedAtSubtitle) {
            mailingListCreatedAtSubtitle.textContent = "";
            mailingListCreatedAtSubtitle.style.display = "none";
          }
        }

        if (mailingListCreatedAtSubtitle) {
          const shareLink = mailingListCreatedAtSubtitle.querySelector(
            "#mailingListShareLink",
          );
          if (shareLink && !isSpedisciListaView) {
            shareLink.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              openShareListModal();
            });
          }
        }

        if (isSpedisciListaView) {
          refreshShipmentRecipientsJournalistsDropdownOptions();
          applyShipmentSelectedRecipientJournalistIds(
            Array.from(shipmentSelectedRecipientJournalistIds),
            {
              syncDropdown: true,
            },
          );

          if (
            shipmentRecipientsJournalistsInput &&
            document.activeElement !== shipmentRecipientsJournalistsInput
          ) {
            shipmentRecipientsJournalistsInput.value = "";
          }

          const recentLists = getRecentMailingLists();
          const listOptions = recentLists
            .map((x) => String(x?.name || "").trim())
            .filter(Boolean);
          shipmentListOrder.clear();
          listOptions.forEach((name, idx) => {
            shipmentListOrder.set(name, idx);
          });
          const nextOptionsKey = listOptions.join("||");
          if (nextOptionsKey !== lastShipmentListOptionsKey) {
            shipmentListsDropdownSyncing = true;
            shipmentRecipientsListsDropdown.setOptions(listOptions);
            shipmentListsDropdownSyncing = false;
            lastShipmentListOptionsKey = nextOptionsKey;
          }
          applyShipmentSelectedRecipientListIds(
            Array.from(shipmentSelectedRecipientListIds),
            {
              save: false,
              syncDropdown: true,
            },
          );

          if (
            shipmentRecipientsListsInput &&
            document.activeElement !== shipmentRecipientsListsInput
          ) {
            shipmentRecipientsListsInput.value = "";
          }

          renderShipmentSelectedListsChips();
        } else {
          if (shipmentRecipientsListsDropdown?.isOpen) {
            shipmentRecipientsListsDropdown.close();
          }
          if (shipmentRecipientsJournalistsDropdown?.isOpen) {
            shipmentRecipientsJournalistsDropdown.close();
          }
        }

        const baseJournalists = (() => {
          if (isSpedisciListaView && !listForView) {
            return [];
          }
          if (!(isMailingListView || isSpedisciListaView) || !listForView) {
            return journalists;
          }
          const allowed = new Set(listForView.journalistIds || []);
          return journalists.filter((j) => allowed.has(getJournalistId(j)));
        })();

        const mailingAllowedJids =
          (isMailingListView || isSpedisciListaView) && listForView
            ? new Set(listForView.journalistIds || [])
            : null;

        const matchesTextTerm = (haystack, term) => {
          const h = String(haystack ?? "").toLowerCase();
          const q = String(term ?? "")
            .trim()
            .toLowerCase();
          if (!q) return true;
          return h.includes(q);
        };

        const matchesJournalist = (j) => {
          const serviceOk =
            !servicesActive || selectedServices.includes(j.servizio);
          const roleOk = !rolesActive || selectedRoles.includes(j.ruolo);

          const journalistTestate = getJournalistTestate(j);
          const tKeys = journalistTestate
            .map((x) => normalizeTestataKey(x))
            .filter(Boolean);
          const testateObjs = tKeys
            .map((k) => testateByKey.get(k))
            .filter(Boolean);
          const testataArgomentoOk =
            !testataArgomentoActive ||
            testateObjs.some((t) =>
              selectedTestataArgomenti.includes(String(t?.argomento || "")),
            );
          const testataTipoMediaOk =
            !testataTipoMediaActive ||
            testateObjs.some((t) =>
              selectedTestataTipoMedia.includes(
                String(t?.tipoMedia?.child || ""),
              ),
            );
          const testataFrequenzaOk =
            !testataFrequenzaActive ||
            testateObjs.some((t) =>
              selectedTestataFrequenze.includes(
                String(t?.frequenzaPubblicazione || ""),
              ),
            );
          const testataDiffusioneOk =
            !testataDiffusioneActive ||
            testateObjs.some((t) =>
              selectedTestataDiffusioni.includes(String(t?.diffusione || "")),
            );

          const fullName = `${j.nome} ${j.cognome}`.toLowerCase();
          const email = String(j?.email || "").toLowerCase();
          const noteCombined = combineNotes(
            normalizeNotes(j.note),
          ).toLowerCase();

          const textOk =
            !textActive ||
            activeTextTerms.every((term) => {
              const q = String(term || "")
                .trim()
                .toLowerCase();
              if (!q) return true;
              return (
                fullName.includes(q) ||
                email.includes(q) ||
                noteCombined.includes(q)
              );
            });

          return (
            serviceOk &&
            roleOk &&
            testataArgomentoOk &&
            testataTipoMediaOk &&
            testataFrequenzaOk &&
            testataDiffusioneOk &&
            textOk
          );
        };

        const matchesTestata = (t) => {
          const jids = Array.isArray(t?.redazione?.giornalisti)
            ? t.redazione.giornalisti
            : [];

          const relevantJids = mailingAllowedJids
            ? jids.filter((jid) => mailingAllowedJids.has(jid))
            : jids;

          if (mailingAllowedJids && relevantJids.length === 0) {
            return false;
          }

          const servizioOk =
            !servicesActive ||
            relevantJids.some((jid) => {
              const j = journalistById.get(jid);
              if (!j) return false;
              return selectedServices.includes(String(j?.servizio || ""));
            });

          const ruoloOk =
            !rolesActive ||
            relevantJids.some((jid) => {
              const j = journalistById.get(jid);
              if (!j) return false;
              return selectedRoles.includes(String(j?.ruolo || ""));
            });

          const argomentoOk =
            !testataArgomentoActive ||
            selectedTestataArgomenti.includes(String(t?.argomento || ""));

          const tipoMediaOk =
            !testataTipoMediaActive ||
            selectedTestataTipoMedia.includes(
              String(t?.tipoMedia?.child || ""),
            );

          const frequenzaOk =
            !testataFrequenzaActive ||
            selectedTestataFrequenze.includes(
              String(t?.frequenzaPubblicazione || ""),
            );

          const diffusioneOk =
            !testataDiffusioneActive ||
            selectedTestataDiffusioni.includes(String(t?.diffusione || ""));

          const textOk =
            !textActive ||
            (() => {
              const nome = String(t?.nome || "").toLowerCase();
              const note = combineNotes(normalizeNotes(t?.note)).toLowerCase();

              return activeTextTerms.every((term) => {
                const q = String(term || "")
                  .trim()
                  .toLowerCase();
                if (!q) return true;
                return matchesTextTerm(nome, q) || matchesTextTerm(note, q);
              });
            })();

          return (
            servizioOk &&
            ruoloOk &&
            argomentoOk &&
            tipoMediaOk &&
            frequenzaOk &&
            diffusioneOk &&
            textOk
          );
        };

        const filteredTestateForCount = isSidebarTestateMode
          ? (testate || []).filter(matchesTestata)
          : null;

        const deriveJournalistsFromTestate = (ts) => {
          const ids = new Set();
          for (const t of ts || []) {
            const jids = Array.isArray(t?.redazione?.giornalisti)
              ? t.redazione.giornalisti
              : [];
            for (const raw of jids) {
              const id = String(raw || "").trim();
              if (!id) continue;
              if (mailingAllowedJids && !mailingAllowedJids.has(id)) continue;
              ids.add(id);
            }
          }

          const out = [];
          for (const id of ids) {
            const j = journalistById.get(id);
            if (j) out.push(j);
          }
          return out;
        };

        const filteredJournalistsForCount = isSidebarTestateMode
          ? deriveJournalistsFromTestate(filteredTestateForCount || [])
          : (baseJournalists || []).filter(matchesJournalist);

        const deriveTestateFromJournalists = (js) => {
          const keys = new Set();
          for (const j of js || []) {
            if (Array.isArray(j?.outletIds) && j.outletIds.length) {
              for (const oid of j.outletIds) {
                const k = String(oid ?? "").trim();
                if (k) keys.add(k);
              }
            }

            const names = getJournalistTestate(j);
            for (const n of names) {
              const k = normalizeTestataKey(n);
              if (k) keys.add(k);
            }
          }

          const out = [];
          const seenId = new Set();
          for (const k of keys) {
            const t = testateByKey?.get?.(k) || null;
            if (!t) continue;
            const id = String(t?.id || "").trim();
            const uniq = id || String(k || "");
            if (!uniq) continue;
            if (seenId.has(uniq)) continue;
            seenId.add(uniq);
            out.push(t);
          }
          return out;
        };

        const mainViewTestateItems = isMainTestateMode
          ? isSidebarTestateMode
            ? filteredTestateForCount || []
            : deriveTestateFromJournalists(filteredJournalistsForCount)
          : null;

        if (mainCountJournalistsEl) {
          mainCountJournalistsEl.textContent = String(
            filteredJournalistsForCount.length,
          );
        }

        if (mainCountTestateEl) {
          const n = isSidebarTestateMode
            ? String((filteredTestateForCount || []).length)
            : String(
                deriveTestateFromJournalists(filteredJournalistsForCount)
                  .length,
              );
          mainCountTestateEl.textContent = n;
        }

        const effectiveActive = isSidebarTestateMode
          ? textActive ||
            testataArgomentoActive ||
            testataTipoMediaActive ||
            testataFrequenzaActive ||
            testataDiffusioneActive ||
            servicesActive ||
            rolesActive
          : active;
        if (clearFiltersLink) {
          clearFiltersLink.style.display = effectiveActive
            ? "inline-block"
            : "none";
        }

        if (isMainTestateMode) {
          const items = mainViewTestateItems || [];
          const sortedTestate = [...items].sort((a, b) => {
            if (effectiveSortMode === "relevance") {
              const score = (t) => {
                const name = String(t?.nome || "").toLowerCase();
                const note = combineNotes(
                  normalizeNotes(t?.note),
                ).toLowerCase();
                let s = 0;
                for (const term of activeTextTerms || []) {
                  const q = String(term || "")
                    .trim()
                    .toLowerCase();
                  if (!q) continue;
                  const inName = matchesTextTerm(name, q);
                  const inNote = matchesTextTerm(note, q);
                  if (inName && inNote) s += 3;
                  else if (inName) s += 2;
                  else if (inNote) s += 1;
                  if (inName && name.startsWith(q)) s += 1;
                }
                return s;
              };

              const ra = score(a);
              const rb = score(b);
              return rb - ra || compareTestateByName(a, b);
            }
            if (effectiveSortMode === "frequency") {
              const fa = getFreqSort(a?.frequenzaPubblicazione);
              const fb = getFreqSort(b?.frequenzaPubblicazione);
              if (fa.indefinite !== fb.indefinite) {
                return fa.indefinite ? 1 : -1;
              }
              if (fa.days !== fb.days) {
                return fa.days - fb.days;
              }
              return compareTestateByName(a, b);
            }
            if (effectiveSortMode === "media-type") {
              const ra = getTestataMediaRank(a);
              const rb = getTestataMediaRank(b);
              return ra - rb || compareTestateByName(a, b);
            }
            if (sortMode === "name-desc") {
              return compareTestateByName(b, a);
            }
            return compareTestateByName(a, b);
          });

          const endIndex = Math.min(
            sortedTestate.length,
            Math.max(0, visibleTestateLimit),
          );
          const startIndex = shouldClearGrid
            ? 0
            : Math.min(lastRenderedTestateCount, endIndex);

          if (shouldClearGrid) {
            if (cardsLoader) {
              cardsLoader.style.display = "block";
            }
            resetCardsGridScaffold();
          }

          renderIncremental({
            items: sortedTestate,
            startIndex,
            endIndex,
            createElement: (t) => createTestataCard(t, getHighlightTextTerms()),
            onDone: () => {
              lastRenderedTestateCount = endIndex;
              scheduleUpdateCardNameLayouts();
            },
          });

          if (loadMoreWrap && loadMoreLink) {
            const hasMore = sortedTestate.length > endIndex;
            loadMoreWrap.style.display = hasMore ? "block" : "none";
            if (hasMore) {
              const remaining = sortedTestate.length - endIndex;
              const step = Math.min(CARD_PAGE_SIZE, remaining);
              loadMoreLink.textContent = `mostra altri (${step})`;
            }
          }

          {
            const set = new Set();
            for (const t of sortedTestate) {
              const jids = Array.isArray(t?.redazione?.giornalisti)
                ? t.redazione.giornalisti
                : [];
              for (const jid of jids) {
                const id = String(jid || "").trim();
                if (!id) continue;
                if (mailingAllowedJids && !mailingAllowedJids.has(id)) continue;
                set.add(id);
              }
            }
            lastRenderedVisibleJournalistIds = Array.from(set);
          }

          if (!effectiveActive) {
            subtitleEl.textContent = "";
          } else {
            subtitleEl.innerHTML = "";
            const bar = document.createElement("div");
            bar.className = "filters-bar";

            const createChip = (value, onRemove) => {
              const chip = document.createElement("span");
              chip.className = "chip";

              const text = document.createElement("span");
              text.textContent = value;

              const remove = document.createElement("button");
              remove.type = "button";
              remove.className = "chip-remove";
              remove.textContent = "×";
              remove.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                onRemove();
              });

              chip.appendChild(text);
              chip.appendChild(remove);
              return chip;
            };

            const makeRow = (labelText) => {
              const row = document.createElement("div");
              row.className = "filters-row";

              const label = document.createElement("span");
              label.className = "filters-section-label";
              label.textContent = labelText;
              row.appendChild(label);
              return row;
            };

            if (textActive) {
              const row = makeRow(getTextFilterLabel());
              for (const term of committedTextTerms) {
                row.appendChild(
                  createChip(term, () => {
                    const idx = committedTextTerms.indexOf(term);
                    if (idx !== -1) committedTextTerms.splice(idx, 1);
                    updateTextFilterClearVisibility();
                    scheduleRender();
                  }),
                );
              }

              if (currentTextQuery) {
                row.appendChild(
                  createChip(currentTextQuery, () => {
                    if (!textFilterInput) return;
                    textFilterInput.value = "";
                    updateTextFilterClearVisibility();
                    scheduleRender();
                  }),
                );
              }

              bar.appendChild(row);
            }

            if (servicesActive) {
              const row = makeRow("Servizio:");
              for (const s of selectedServices) {
                row.appendChild(
                  createChip(s, () => {
                    dropdown.removeOption(s);
                  }),
                );
              }
              bar.appendChild(row);
            }

            if (rolesActive) {
              const row = makeRow("Ruolo:");
              for (const r of selectedRoles) {
                row.appendChild(
                  createChip(r, () => {
                    roleDropdown.removeOption(r);
                  }),
                );
              }
              bar.appendChild(row);
            }

            if (testataArgomentoActive) {
              const row = makeRow("Argomento testata:");
              for (const a of selectedTestataArgomenti) {
                row.appendChild(
                  createChip(a, () => {
                    testataArgomentoDropdown.removeOption(a);
                  }),
                );
              }
              bar.appendChild(row);
            }

            if (testataTipoMediaActive) {
              const row = makeRow("Tipo media:");
              for (const tm of selectedTestataTipoMedia) {
                row.appendChild(
                  createChip(tm, () => {
                    testataTipoMediaDropdown.removeOption(tm);
                  }),
                );
              }
              bar.appendChild(row);
            }

            if (testataFrequenzaActive) {
              const row = makeRow("Frequenza di pubblicazione:");
              for (const f of selectedTestataFrequenze) {
                row.appendChild(
                  createChip(f, () => {
                    testataFrequenzaDropdown.removeOption(f);
                  }),
                );
              }
              bar.appendChild(row);
            }

            if (testataDiffusioneActive) {
              const row = makeRow("Diffusione:");
              for (const d of selectedTestataDiffusioni) {
                row.appendChild(
                  createChip(d, () => {
                    testataDiffusioneDropdown.removeOption(d);
                  }),
                );
              }
              bar.appendChild(row);
            }

            subtitleEl.appendChild(bar);
          }
          return;
        }

        const filtered = (filteredJournalistsForCount || []).filter((j) => {
          if (!isSpedisciListaView || !shipmentCardsFilterTerm) return true;
          const fullName = `${j?.nome || ""} ${j?.cognome || ""}`
            .trim()
            .toLowerCase();
          return fullName.includes(shipmentCardsFilterTerm);
        });
        const sorted = [...filtered].sort((a, b) => {
          if (effectiveSortMode === "relevance") {
            const score = (j) => {
              const fullName = `${j?.nome || ""} ${j?.cognome || ""}`
                .trim()
                .toLowerCase();
              const email = String(j?.email || "")
                .trim()
                .toLowerCase();
              const note = combineNotes(normalizeNotes(j?.note)).toLowerCase();
              let s = 0;
              for (const term of activeTextTerms || []) {
                const q = String(term || "")
                  .trim()
                  .toLowerCase();
                if (!q) continue;
                const inName = fullName.includes(q);
                const inEmail = email.includes(q);
                const inNote = note.includes(q);
                if (inName && inEmail && inNote) s += 4;
                else if (inName && inEmail) s += 4;
                else if (inName && inNote) s += 3;
                else if (inEmail && inNote) s += 2;
                else if (inName) s += 3;
                else if (inEmail) s += 2;
                else if (inNote) s += 1;
                if (inName && fullName.startsWith(q)) s += 1;
              }
              return s;
            };

            const ra = score(a);
            const rb = score(b);
            return rb - ra || compareJournalistsByName(a, b);
          }
          if (effectiveSortMode === "role") {
            const ra = getRoleRank(a?.ruolo);
            const rb = getRoleRank(b?.ruolo);
            return ra - rb || compareJournalistsByName(a, b);
          }
          if (effectiveSortMode === "media-type") {
            const getMediaKey = (j) => {
              const t = getJournalistTestate(j);
              const first = String(t?.[0] || "").trim();
              if (!first) return "";
              const key = normalizeTestataKey(first);
              const testata = testateByKey.get(key);
              const p = String(testata?.tipoMedia?.parent || "").trim();
              const c = String(testata?.tipoMedia?.child || "").trim();
              return p && c ? `${p} / ${c}` : p || c;
            };
            const ka = getMediaKey(a);
            const kb = getMediaKey(b);
            if (!!ka !== !!kb) return ka ? -1 : 1;
            const cmp = String(ka || "").localeCompare(String(kb || ""), "it", {
              sensitivity: "base",
            });
            return cmp || compareJournalistsByName(a, b);
          }
          if (effectiveSortMode === "frequency") {
            const getJournalistFreq = (j) => {
              const t = getJournalistTestate(j);
              const first = String(t?.[0] || "").trim();
              if (!first) return "";
              const k = normalizeTestataKey(first);
              const testata = testateByKey.get(k);
              return String(testata?.frequenzaPubblicazione || "").trim();
            };

            const fa = getFreqSort(getJournalistFreq(a));
            const fb = getFreqSort(getJournalistFreq(b));
            if (fa.indefinite !== fb.indefinite) {
              return fa.indefinite ? 1 : -1;
            }
            if (fa.days !== fb.days) {
              return fa.days - fb.days;
            }
            return compareJournalistsByName(a, b);
          }
          if (effectiveSortMode === "name-desc") {
            return compareJournalistsByName(b, a);
          }
          return compareJournalistsByName(a, b);
        });

        const endIndex = Math.min(
          sorted.length,
          Math.max(0, visibleJournalistLimit),
        );
        const startIndex = shouldClearGrid
          ? 0
          : Math.min(lastRenderedJournalistCount, endIndex);

        if (shouldClearGrid) {
          if (cardsLoader) {
            cardsLoader.style.display = "block";
          }
          resetCardsGridScaffold();
        }

        const shipmentHighlightTerms =
          isSpedisciListaView && shipmentCardsFilterTerm
            ? [shipmentCardsFilterTerm]
            : [];

        renderIncremental({
          items: sorted,
          startIndex,
          endIndex,
          createElement: (j) => createCard(j, shipmentHighlightTerms),
          onDone: () => {
            lastRenderedJournalistCount = endIndex;
            requestAnimationFrame(() => {
              updateJournalistTestateLabelLinks(grid);
              scheduleUpdateCardNameLayouts();
            });
          },
        });

        if (loadMoreWrap && loadMoreLink) {
          const hasMore = sorted.length > endIndex;
          loadMoreWrap.style.display = hasMore ? "block" : "none";
          if (hasMore) {
            const remaining = sorted.length - endIndex;
            const step = Math.min(CARD_PAGE_SIZE, remaining);
            loadMoreLink.textContent = `mostra altri (${step})`;
          }
        }

        lastRenderedVisibleJournalistIds = sorted
          .map((j) => String(getJournalistId(j) || "").trim())
          .filter(Boolean);

        if (isMainTestateMode) {
          subtitleEl.textContent = `${filteredAndSorted.length} testate`;
        } else {
          subtitleEl.innerHTML = "";

          const bar = document.createElement("div");
          bar.className = "filters-bar";

          const createChip = (value, onRemove) => {
            const chip = document.createElement("span");
            chip.className = "chip";

            const text = document.createElement("span");
            text.textContent = value;

            const remove = document.createElement("button");
            remove.type = "button";
            remove.className = "chip-remove";
            remove.textContent = "×";
            remove.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              onRemove();
            });

            chip.appendChild(text);
            chip.appendChild(remove);
            return chip;
          };

          const makeRow = (labelText) => {
            const row = document.createElement("div");
            row.className = "filters-row";

            const label = document.createElement("span");
            label.className = "filters-section-label";
            label.textContent = labelText;
            row.appendChild(label);
            return row;
          };

          if (textActive) {
            const row = makeRow(getTextFilterLabel());

            for (const t of committedTextTerms) {
              row.appendChild(
                createChip(t, () => {
                  activeTextTerms.delete(t);
                  for (let i = committedTextTerms.length - 1; i >= 0; i--) {
                    if (committedTextTerms[i] === t) {
                      committedTextTerms.splice(i, 1);
                    }
                  }
                  updateTextFilterClearVisibility();
                  scheduleRender();
                }),
              );
            }

            if (currentTextQuery) {
              row.appendChild(
                createChip(currentTextQuery, () => {
                  if (!textFilterInput) return;
                  textFilterInput.value = "";
                  updateTextFilterClearVisibility();
                  scheduleRender();
                }),
              );
            }
            bar.appendChild(row);
          }

          if (servicesActive) {
            const row = makeRow("Servizio:");
            for (const s of selectedServices) {
              row.appendChild(
                createChip(s, () => {
                  dropdown.removeOption(s);
                }),
              );
            }
            bar.appendChild(row);
          }

          if (rolesActive) {
            const row = makeRow("Ruolo:");
            for (const r of selectedRoles) {
              row.appendChild(
                createChip(r, () => {
                  roleDropdown.removeOption(r);
                }),
              );
            }
            bar.appendChild(row);
          }

          if (testataArgomentoActive) {
            const row = makeRow("Argomento testata:");
            for (const a of selectedTestataArgomenti) {
              row.appendChild(
                createChip(a, () => {
                  testataArgomentoDropdown.removeOption(a);
                }),
              );
            }
            bar.appendChild(row);
          }

          if (testataTipoMediaActive) {
            const row = makeRow("Tipo media:");
            for (const tm of selectedTestataTipoMedia) {
              row.appendChild(
                createChip(tm, () => {
                  testataTipoMediaDropdown.removeOption(tm);
                }),
              );
            }
            bar.appendChild(row);
          }

          if (testataFrequenzaActive) {
            const row = makeRow("Frequenza di pubblicazione:");
            for (const f of selectedTestataFrequenze) {
              row.appendChild(
                createChip(f, () => {
                  testataFrequenzaDropdown.removeOption(f);
                }),
              );
            }
            bar.appendChild(row);
          }

          if (testataDiffusioneActive) {
            const row = makeRow("Diffusione:");
            for (const d of selectedTestataDiffusioni) {
              row.appendChild(
                createChip(d, () => {
                  testataDiffusioneDropdown.removeOption(d);
                }),
              );
            }
            bar.appendChild(row);
          }

          subtitleEl.appendChild(bar);
        }

        wasSpedisciListaView = isSpedisciListaView;
      }

      const clearAllFilters = () => {
        const mode = getSidebarMode();
        isBulkFilterReset = true;
        testataArgomentoDropdown.resetSelection();
        testataTipoMediaDropdown.resetSelection();
        testataFrequenzaDropdown.resetSelection();
        testataDiffusioneDropdown.resetSelection();
        if (mode !== "testate") {
          dropdown.resetSelection();
          roleDropdown.resetSelection();
        }
        committedTextTerms.splice(0, committedTextTerms.length);
        if (textFilterInput) {
          textFilterInput.value = "";
          updateTextFilterClearVisibility();
        }
        isBulkFilterReset = false;
        filterStateByMode[mode] = snapshotFilterState(mode);
        scheduleRender();
      };

      dropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      roleDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      testataArgomentoDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      testataTipoMediaDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      testataFrequenzaDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      testataDiffusioneDropdown.onSelectionChange = () => {
        if (isBulkFilterReset) return;
        scheduleRender();
      };

      const clearFiltersLink = document.getElementById("clearFiltersLink");
      if (clearFiltersLink) {
        clearFiltersLink.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          clearAllFilters();
        });
      }

      document.querySelectorAll('input[name="sidebarMode"]').forEach((el) => {
        el.addEventListener("change", () => {
          const mode = getSidebarMode();
          handleModeSwitch(mode);
        });
      });

      document.querySelectorAll('input[name="mainMode"]').forEach((el) => {
        el.addEventListener("change", () => {
          scheduleRender();
        });
      });

      const cardsGrid = document.getElementById("cardsGrid");
      if (cardsGrid) {
        scheduleUpdateCardNameLayouts();

        cardsGridResizeObserver = new ResizeObserver(() => {
          scheduleUpdateCardNameLayouts();
        });
        cardsGridResizeObserver.observe(cardsGrid);

        window.addEventListener("resize", () => {
          scheduleUpdateCardNameLayouts();
        });

        window.addEventListener("load", () => {
          scheduleUpdateCardNameLayouts();
        });

        if (document.fonts && document.fonts.ready) {
          document.fonts.ready.then(() => {
            scheduleUpdateCardNameLayouts();
          });
        }

        cardsGrid.addEventListener("click", (e) => {
          const checkbox = e.target?.closest?.(".card-select");
          if (checkbox) return;

          const emailSelect = e.target?.closest?.(".card-email-select");
          if (emailSelect) return;

          const removeFromListBtn = e.target?.closest?.(
            ".card-remove-from-list[data-remove-from-list-jid]",
          );
          const notesLink = e.target?.closest?.(".card-notes-open");
          const customizePressLink = e.target?.closest?.(
            ".card-customize-press-link",
          );
          const journalistsLink = e.target?.closest?.(
            ".card-testata-journalists-open",
          );
          const testateLabelLink = e.target?.closest?.(
            ".card-journalist-testate-open",
          );
          const testataLink = e.target?.closest?.(".testata-link");
          const journalistLink = e.target?.closest?.(".journalist-link");
          if (
            !removeFromListBtn &&
            !notesLink &&
            !customizePressLink &&
            !journalistsLink &&
            !testateLabelLink &&
            !testataLink &&
            !journalistLink
          ) {
            const card = e.target?.closest?.(".card");
            if (!card) return;
            if (appState.view === "spedisci-lista") {
              const journalistId = String(card?.dataset?.jid || "").trim();
              if (!journalistId) return;
              openShipmentEmailHeaderSpotlight(journalistId);
              return;
            }
            const checkbox = card.querySelector(".card-select");
            if (!checkbox) return;
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event("change", { bubbles: true }));
            return;
          }

          e.preventDefault();
          e.stopPropagation();

          if (removeFromListBtn) {
            if (appState.view !== "mailing-list") return;

            const jid = removeFromListBtn.getAttribute(
              "data-remove-from-list-jid",
            );
            if (!jid) return;

            const activeList = getMailingListById(appState.activeMailingListId);
            if (!activeList || !Array.isArray(activeList.journalistIds)) return;

            activeList.journalistIds = (activeList.journalistIds || []).filter(
              (x) => String(x || "").trim() !== String(jid || "").trim(),
            );
            saveAppState(appState);

            if (selectedJournalistIds.has(jid)) {
              selectedJournalistIds.delete(jid);
              removeFromSelectedOrder(jid);
              updateCheckboxUI(jid);
              updateCardSelectionUI(jid);

              if (selectedJournalistIds.size === 0) {
                closeSelectedPanel();
              } else {
                renderSelectedPanelList();
              }
            }

            showToast(formatRemovedFromListToast(1));
            scheduleRender();
            return;
          }

          if (customizePressLink) {
            if (customizePressLink.classList.contains("is-link-disabled")) {
              return;
            }
            const card = customizePressLink.closest(".card");
            const journalistId = String(card?.dataset?.jid || "").trim();
            if (!journalistId) return;
            openShipmentEmailHeaderSpotlight(journalistId);
            return;
          }

          if (notesLink) {
            const jid = notesLink.getAttribute("data-jid");
            const testataKey = notesLink.getAttribute("data-testata-key");
            if (jid) {
              openNotesModal(jid);
              return;
            }
            if (testataKey) {
              openTestataNotesModal(testataKey);
              return;
            }
            return;
          }

          if (journalistsLink) {
            const testataKey = journalistsLink.getAttribute("data-testata-key");
            if (!testataKey) return;
            openTestataJournalistsModal(testataKey);
            return;
          }

          if (testateLabelLink) {
            const jid = testateLabelLink.getAttribute("data-jid");
            if (!jid) return;
            openJournalistTestateModal(jid);
            return;
          }

          if (journalistLink) {
            const name =
              journalistLink.getAttribute("data-journalist") ||
              journalistLink.textContent;
            openJournalistPanel(name);
            return;
          }

          const key = testataLink.getAttribute("data-testata-key");
          const testata =
            testataLink.getAttribute("data-testata") || testataLink.textContent;
          openTestataPanel(key || testata);
        });

        cardsGrid.addEventListener("change", (e) => {
          const checkbox = e.target?.closest?.(".card-select[data-jid]");
          if (!checkbox) return;
          const jid = checkbox.getAttribute("data-jid");
          if (!jid) return;

          const card = checkbox.closest(".card");
          if (checkbox.checked) {
            selectedJournalistIds.add(jid);
            ensureSelectedOrder(jid);
            card?.classList?.add("is-selected");
            openSelectedPanel();
          } else {
            selectedJournalistIds.delete(jid);
            removeFromSelectedOrder(jid);
            card?.classList?.remove("is-selected");
            if (selectedJournalistIds.size === 0) {
              closeSelectedPanel();
            } else {
              renderSelectedPanelList();
            }
          }
        });

        testataPanelBody.addEventListener("keydown", (e) => {
          if (e.key !== "Enter" && e.key !== " ") return;
          const toggleEl = e.target?.closest?.("[data-section-toggle]");
          if (!toggleEl) return;
          e.preventDefault();
          toggleEl.click();
        });
      }

      if (selectedPanelBody) {
        selectedPanelBody.addEventListener("click", (e) => {
          const journalistLink = e.target?.closest?.(".journalist-link");
          if (journalistLink) {
            e.preventDefault();
            e.stopPropagation();
            const name =
              journalistLink.getAttribute("data-journalist") ||
              journalistLink.textContent;
            openJournalistPanel(name);
            return;
          }

          const btn = e.target?.closest?.(".selected-item-remove");
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();

          const jid = btn.getAttribute("data-jid");
          if (!jid) return;

          selectedJournalistIds.delete(jid);
          removeFromSelectedOrder(jid);

          updateCheckboxUI(jid);
          updateCardSelectionUI(jid);

          if (selectedJournalistIds.size === 0) {
            closeSelectedPanel();
          } else {
            renderSelectedPanelList();
          }
        });

        window.addEventListener("resize", () => {
          scheduleUpdateSelectedNameLayouts();
        });

        const selectedPanel = document.getElementById("selectedPanel");
        if (selectedPanel && typeof ResizeObserver !== "undefined") {
          selectedPanelResizeObserver = new ResizeObserver(() => {
            scheduleUpdateSelectedNameLayouts();
          });
          selectedPanelResizeObserver.observe(selectedPanel);
        }

        window.addEventListener("load", () => {
          scheduleUpdateSelectedNameLayouts();
        });

        if (document.fonts && document.fonts.ready) {
          document.fonts.ready.then(() => {
            scheduleUpdateSelectedNameLayouts();
          });
        }
      }

      const navSidebar = document.querySelector(".nav-sidebar");
      if (navSidebar) {
        navSidebar.addEventListener("click", (e) => {
          const link = e.target?.closest?.("a[data-view]");
          if (!link) return;

          e.preventDefault();
          e.stopPropagation();

          const viewId = link.getAttribute("data-view");
          const v = normalizeViewId(viewId);
          if (!v) return;

          window.location.hash = `#${v}`;
        });
      }

      window.addEventListener("hashchange", () => {
        const requested = getViewFromHash();
        if (requested && !ENABLED_VIEWS.has(requested)) {
          window.location.hash = "#filtra";
          return;
        }

        setActiveView(requested, { save: true });
      });

      const initialFromHash = getViewFromHash();
      if (initialFromHash && !ENABLED_VIEWS.has(initialFromHash)) {
        window.location.hash = "#filtra";
      }
      const initialView = initialFromHash || appState.view || "filtra";
      setActiveView(initialView, { save: true });

      updateHelpLinkVisibility();

      scheduleRender();
    </script>
  </body>
</html>
