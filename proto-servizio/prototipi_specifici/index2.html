<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dropdown Filtrabile</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #ffffff 0%, #eeeeee 100%);
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }

      .container {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        max-width: 400px;
        width: 100%;
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
        font-size: 24px;
      }

      .dropdown-container {
        position: relative;
        margin-bottom: 20px;
      }

      .dropdown-input {
        width: 100%;
        padding: 12px 40px 12px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        outline: none;
        transition: all 0.3s ease;
        box-sizing: border-box;
        cursor: pointer;
      }

      .dropdown-input:focus {
        border-color: #888;
        box-shadow: 0 0 0 3px rgba(136, 136, 136, 0.1);
      }

      .dropdown-arrow {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 8px solid #666;
        transition: transform 0.3s ease;
        pointer-events: none;
      }

      .dropdown-arrow.rotated {
        transform: translateY(-50%) rotate(180deg);
      }

      .dropdown-clear {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        background-color: #ccc;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: 12px;
        font-weight: bold;
        color: white;
      }

      .dropdown-clear:hover {
        background-color: #999;
      }

      .dropdown-clear.show {
        display: flex;
      }

      .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #e0e0e0;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 300px;
        z-index: 1000;
        opacity: 0;
        transform: translateY(-10px);
        visibility: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
      }

      .dropdown-results {
        flex: 1;
        overflow-y: auto;
        max-height: calc(
          300px - 50px
        ); /* Altezza totale meno altezza del pulsante create */
      }

      .dropdown-create-project {
        flex-shrink: 0;
        border-top: 2px solid #e0e0e0;
        background: white;
        position: sticky;
        bottom: 0;
      }

      .dropdown-list.show {
        opacity: 1;
        transform: translateY(0);
        visibility: visible;
      }

      .dropdown-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
      }

      .dropdown-item:hover {
        background-color: #f0f0f0;
      }

      .dropdown-item.selected {
        background-color: #888;
        color: black;
      }

      .dropdown-item:last-child {
        border-bottom: none;
      }

      .no-results {
        padding: 15px;
        text-align: center;
        color: #999;
        font-style: italic;
      }

      /* Scrollbar personalizzata */
      .dropdown-list::-webkit-scrollbar {
        width: 8px;
      }

      .dropdown-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .dropdown-list::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      .dropdown-list::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      /* Evidenziazione del testo cercato */
      .highlight {
        background-color: yellow;
        padding: 1px 2px;
        border-radius: 2px;
        font-weight: normal;
      }

      /* Dialog per creare nuovo progetto */
      .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .dialog-overlay.show {
        display: flex;
      }

      .dialog {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        position: relative;
        animation: dialogSlideIn 0.3s ease;
      }

      @keyframes dialogSlideIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .dialog-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        text-align: center;
      }

      .dialog-close {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        padding: 5px;
        line-height: 1;
      }

      .dialog-close:hover {
        color: #666;
      }

      .dialog-input-container {
        margin-bottom: 20px;
      }

      .dialog-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .dialog-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      .dialog-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .dialog-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
      }

      .dialog-btn-primary {
        background-color: #007bff;
        color: white;
      }

      .dialog-btn-primary:hover {
        background-color: #0056b3;
      }

      .dialog-btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .dialog-btn-secondary:hover {
        background-color: #545b62;
      }

      /* Responsive */
      @media (max-width: 480px) {
        .container {
          margin: 10px;
          padding: 20px;
        }

        h1 {
          font-size: 20px;
        }

        .dialog {
          margin: 20px;
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Dropdown Filtrabile</h1>

      <div class="dropdown-container">
        <input
          type="text"
          class="dropdown-input"
          id="dropdownInput"
          placeholder="Seleziona un progetto o creane uno nuovo..."
          autocomplete="off"
        />
        <div class="dropdown-arrow" id="dropdownArrow"></div>
        <div class="dropdown-clear" id="dropdownClear">×</div>
        <div class="dropdown-list" id="dropdownList">
          <div class="dropdown-results" id="dropdownResults"></div>
          <div class="dropdown-create-project" id="dropdownCreateProject"></div>
        </div>
      </div>
    </div>

    <!-- Dialog per creare nuovo progetto -->
    <div class="dialog-overlay" id="dialogOverlay">
      <div class="dialog">
        <button class="dialog-close" id="dialogClose">×</button>
        <div class="dialog-title">Crea Nuovo Progetto</div>
        <div class="dialog-input-container">
          <input
            type="text"
            class="dialog-input"
            id="dialogInput"
            placeholder="Inserisci il nome del progetto..."
          />
        </div>
        <div class="dialog-buttons">
          <button class="dialog-btn dialog-btn-secondary" id="dialogCancel">
            Annulla
          </button>
          <button class="dialog-btn dialog-btn-primary" id="dialogOk">
            OK
          </button>
        </div>
      </div>
    </div>

    <script>
      class FilterableDropdown {
        constructor(inputId, options = []) {
          this.input = document.getElementById(inputId);
          this.arrow = document.getElementById("dropdownArrow");
          this.clear = document.getElementById("dropdownClear");
          this.list = document.getElementById("dropdownList");
          this.results = document.getElementById("dropdownResults");
          this.createProject = document.getElementById("dropdownCreateProject");

          // Dialog elements
          this.dialogOverlay = document.getElementById("dialogOverlay");
          this.dialogInput = document.getElementById("dialogInput");
          this.dialogClose = document.getElementById("dialogClose");
          this.dialogCancel = document.getElementById("dialogCancel");
          this.dialogOk = document.getElementById("dialogOk");

          this.originalOptions = options;
          this.filteredOptions = [...options];
          this.selectedValue = null;
          this.isOpen = false;
          this.selectedIndex = -1;

          this.init();
        }

        init() {
          this.renderList();
          this.bindEvents();
          this.updateClearVisibility();
        }

        bindEvents() {
          // Click sull'input per aprire/chiudere
          this.input.addEventListener("click", () => {
            // Se c'è un valore selezionato, seleziona tutto il testo
            if (this.selectedValue && this.input.value) {
              this.input.select();
            }
            this.toggle();
          });

          // Input per filtrare
          this.input.addEventListener("input", (e) => {
            this.filterOptions(e.target.value);
            if (!this.isOpen) {
              this.open();
            }
            this.selectedIndex = -1;
          });

          // Navigazione con tastiera
          this.input.addEventListener("keydown", (e) => {
            this.handleKeyboard(e);
          });

          // Click sulla X per reset
          this.clear.addEventListener("click", (e) => {
            e.stopPropagation();
            this.resetSelection();
          });

          // Chiudi quando si clicca fuori
          document.addEventListener("click", (e) => {
            if (
              !this.input.contains(e.target) &&
              !this.list.contains(e.target) &&
              !this.clear.contains(e.target) &&
              !this.dialogOverlay.contains(e.target)
            ) {
              this.close();
            }
          });

          // Dialog events
          this.dialogClose.addEventListener("click", () => {
            this.closeDialog();
          });

          this.dialogCancel.addEventListener("click", () => {
            this.closeDialog();
          });

          this.dialogOk.addEventListener("click", () => {
            this.handleDialogOk();
          });

          this.dialogInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              this.handleDialogOk();
            } else if (e.key === "Escape") {
              this.closeDialog();
            }
          });

          // Chiudi dialog cliccando sull'overlay
          this.dialogOverlay.addEventListener("click", (e) => {
            if (e.target === this.dialogOverlay) {
              this.closeDialog();
            }
          });
        }

        filterOptions(query) {
          const searchTerm = query.toLowerCase();
          this.filteredOptions = this.originalOptions.filter((option) =>
            option.toLowerCase().includes(searchTerm)
          );
          this.renderList();
        }

        // Funzione per evidenziare il testo cercato
        highlightSearchText(text, searchTerm) {
          if (!searchTerm || searchTerm.trim() === "") {
            return text;
          }

          const regex = new RegExp(
            `(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
            "gi"
          );
          return text.replace(regex, '<span class="highlight">$1</span>');
        }

        renderList() {
          // Pulisci i contenitori
          this.results.innerHTML = "";
          this.createProject.innerHTML = "";

          // Mostra i risultati filtrati nell'area scrollabile
          this.filteredOptions.forEach((option, index) => {
            const item = document.createElement("div");
            item.className = "dropdown-item";

            // Evidenzia il testo cercato solo se c'è una ricerca attiva
            const searchTerm = this.input.value.trim();
            if (searchTerm && searchTerm !== option) {
              item.innerHTML = this.highlightSearchText(option, searchTerm);
            } else {
              item.textContent = option;
            }

            item.dataset.index = index;

            if (option === this.selectedValue) {
              item.classList.add("selected");
            }

            item.addEventListener("click", () => {
              this.selectOption(option);
            });

            this.results.appendChild(item);
          });

          // Mostra sempre l'opzione per creare un nuovo progetto nell'area fissa in fondo
          const createNewProject = document.createElement("div");
          createNewProject.className = "dropdown-item save-new-project";
          createNewProject.innerHTML = "Crea nuovo progetto";
          createNewProject.style.color = "#007bff";
          createNewProject.style.cursor = "pointer";
          createNewProject.style.fontWeight = "bold";
          createNewProject.style.padding = "12px 15px";

          createNewProject.addEventListener("click", () => {
            this.openDialog();
          });

          this.createProject.appendChild(createNewProject);
        }

        selectOption(option) {
          this.selectedValue = option;
          this.input.value = option;
          // Resetta il filtro per mostrare tutte le opzioni alla prossima apertura
          this.filteredOptions = [...this.originalOptions];
          this.close();
          this.renderList(); // Ricarica per mostrare la selezione
          this.updateClearVisibility();
        }

        resetSelection() {
          this.selectedValue = null;
          this.input.value = "";
          this.filteredOptions = [...this.originalOptions];
          this.close();
          this.renderList();
          this.updateClearVisibility();
        }

        updateClearVisibility() {
          if (this.selectedValue) {
            this.clear.classList.add("show");
            this.arrow.style.display = "none";
          } else {
            this.clear.classList.remove("show");
            this.arrow.style.display = "block";
          }
        }

        handleKeyboard(e) {
          if (!this.isOpen && (e.key === "ArrowDown" || e.key === "ArrowUp")) {
            e.preventDefault();
            this.open();
            return;
          }

          if (!this.isOpen) return;

          // Ora abbiamo sempre l'opzione "Crea nuovo progetto" come ultimo elemento
          const totalItems = this.filteredOptions.length + 1;

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              this.selectedIndex = Math.min(
                this.selectedIndex + 1,
                totalItems - 1
              );
              this.highlightItem();
              break;

            case "ArrowUp":
              e.preventDefault();
              this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
              this.highlightItem();
              break;

            case "Enter":
              e.preventDefault();
              if (this.selectedIndex >= 0) {
                // Se ha selezionato l'opzione "Crea nuovo progetto" (ultimo elemento)
                if (this.selectedIndex === this.filteredOptions.length) {
                  this.openDialog();
                } else {
                  // Seleziona una delle opzioni filtrate
                  if (this.filteredOptions[this.selectedIndex]) {
                    this.selectOption(this.filteredOptions[this.selectedIndex]);
                  }
                }
              }
              break;

            case "Escape":
              this.close();
              break;
          }
        }

        highlightItem() {
          const resultsItems = this.results.querySelectorAll(".dropdown-item");
          const createItem = this.createProject.querySelector(".dropdown-item");

          // Resetta tutti gli stili
          resultsItems.forEach((item, index) => {
            item.style.backgroundColor = "";
          });
          if (createItem) {
            createItem.style.backgroundColor = "";
          }

          // Evidenzia l'elemento selezionato
          if (
            this.selectedIndex >= 0 &&
            this.selectedIndex < resultsItems.length
          ) {
            // Elemento nei risultati
            resultsItems[this.selectedIndex].style.backgroundColor = "#f0f0f0";
            resultsItems[this.selectedIndex].scrollIntoView({
              block: "nearest",
            });
          } else if (
            this.selectedIndex === this.filteredOptions.length &&
            createItem
          ) {
            // Elemento "Crea nuovo progetto"
            createItem.style.backgroundColor = "#f0f0f0";
          }
        }

        open() {
          this.isOpen = true;
          // Resetta il filtro per mostrare tutte le opzioni
          this.filteredOptions = [...this.originalOptions];
          this.renderList();

          // Se c'è un valore selezionato, posiziona la tendina su quello
          if (this.selectedValue) {
            this.selectedIndex = this.filteredOptions.indexOf(
              this.selectedValue
            );
            this.highlightItem();
          } else {
            this.selectedIndex = -1;
          }

          this.list.classList.add("show");
          this.arrow.classList.add("rotated");
          this.input.style.borderRadius = "8px 8px 0 0";
        }

        close() {
          this.isOpen = false;
          this.list.classList.remove("show");
          this.arrow.classList.remove("rotated");
          this.input.style.borderRadius = "8px";
          this.selectedIndex = -1;
        }

        toggle() {
          if (this.isOpen) {
            this.close();
          } else {
            this.open();
          }
        }

        // Dialog methods
        openDialog() {
          this.dialogOverlay.classList.add("show");
          this.dialogInput.value = "";
          // Focus sull'input della dialog dopo un piccolo delay per l'animazione
          setTimeout(() => {
            this.dialogInput.focus();
          }, 100);
        }

        closeDialog() {
          this.dialogOverlay.classList.remove("show");
          this.dialogInput.value = "";
        }

        handleDialogOk() {
          const projectName = this.dialogInput.value.trim();
          if (projectName) {
            this.saveNewProject(projectName);
            this.closeDialog();
          }
        }

        // Metodo per salvare un nuovo progetto
        saveNewProject(projectName) {
          if (projectName && !this.originalOptions.includes(projectName)) {
            // Trova la posizione corretta per inserire il nuovo elemento in ordine alfabetico
            let insertIndex = 0;
            for (let i = 0; i < this.originalOptions.length; i++) {
              if (
                this.originalOptions[i].toLowerCase() >
                projectName.toLowerCase()
              ) {
                insertIndex = i;
                break;
              }
              insertIndex = i + 1;
            }

            // Inserisci il nuovo elemento nella posizione corretta
            this.originalOptions.splice(insertIndex, 0, projectName);
            this.filteredOptions = [...this.originalOptions];

            // Seleziona automaticamente il nuovo progetto
            this.selectOption(projectName);
          }
        }

        // Metodi pubblici per gestire le opzioni
        addOption(option) {
          if (!this.originalOptions.includes(option)) {
            this.originalOptions.push(option);
            this.filteredOptions = [...this.originalOptions];
            this.renderList();
          }
        }

        removeOption(option) {
          this.originalOptions = this.originalOptions.filter(
            (opt) => opt !== option
          );
          this.filteredOptions = [...this.originalOptions];
          this.renderList();
        }

        setOptions(options) {
          this.originalOptions = options;
          this.filteredOptions = [...options];
          this.renderList();
        }
      }

      // Dati di esempio - qui puoi inserire i tuoi 80 elementi
      const sampleOptions = [
        "Adobe Photoshop",
        "Adobe Illustrator",
        "Adobe InDesign",
        "Adobe Premiere Pro",
        "Adobe After Effects",
        "Adobe XD",
        "Adobe Lightroom",
        "Adobe Acrobat",
        "Microsoft Word",
        "Microsoft Excel",
        "Microsoft PowerPoint",
        "Microsoft Outlook",
        "Microsoft Teams",
        "Microsoft OneNote",
        "Microsoft Access",
        "Microsoft Publisher",
        "Google Chrome",
        "Google Drive",
        "Google Docs",
        "Google Sheets",
        "Google Slides",
        "Google Photos",
        "Google Maps",
        "Google Calendar",
        "Mozilla Firefox",
        "Mozilla Thunderbird",
        "Safari",
        "Opera",
        "Visual Studio Code",
        "Visual Studio",
        "IntelliJ IDEA",
        "Eclipse",
        "Sublime Text",
        "Atom",
        "Notepad++",
        "Brackets",
        "Figma",
        "Sketch",
        "Canva",
        "GIMP",
        "Blender",
        "AutoCAD",
        "SketchUp",
        "Solidworks",
        "Zoom",
        "Skype",
        "Discord",
        "Slack",
        "Trello",
        "Asana",
        "Monday.com",
        "Jira",
        "Spotify",
        "iTunes",
        "VLC Media Player",
        "Windows Media Player",
        "WinRAR",
        "7-Zip",
        "CCleaner",
        "Malwarebytes",
        "Antivirus Avast",
        "Antivirus Norton",
        "Antivirus McAfee",
        "Antivirus Kaspersky",
        "Steam",
        "Epic Games",
        "Origin",
        "Uplay",
        "OBS Studio",
        "Streamlabs",
        "Audacity",
        "FL Studio",
        "Unity",
        "Unreal Engine",
        "GameMaker Studio",
        "Construct 3",
        "Node.js",
        "Python",
        "Java",
        "C++",
        "React",
        "Angular",
        "Vue.js",
        "jQuery",
        "WordPress",
        "Drupal",
        "Joomla",
        "Magento",
        "Shopify",
        "WooCommerce",
        "PrestaShop",
        "OpenCart",
      ];

      // Ordina le opzioni in ordine alfabetico prima di inizializzare
      sampleOptions.sort((a, b) =>
        a.toLowerCase().localeCompare(b.toLowerCase())
      );

      // Inizializza la dropdown
      const dropdown = new FilterableDropdown("dropdownInput", sampleOptions);

      // Esempio di come aggiungere opzioni dinamicamente
      // dropdown.addOption('Nuova Opzione');

      // Esempio di come cambiare tutte le opzioni
      // dropdown.setOptions(['Opzione 1', 'Opzione 2', 'Opzione 3']);
    </script>
  </body>
</html>
